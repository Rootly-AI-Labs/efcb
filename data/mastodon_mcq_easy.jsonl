{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nFixes regression from #34396\n\n---\n\nChoice A:\napp/controllers/api/v1/suggestions_controller.rb\n@@ -4,7 +4,7 @@ class Api::V1::SuggestionsController < Api::BaseController\n   include Authorization\n   include DeprecationConcern\n \n-  deprecate_api '2021-05-16'\n+  deprecate_api '2021-05-16', only: [:index]\n \n   before_action -> { doorkeeper_authorize! :read, :'read:accounts' }, only: :index\n   before_action -> { doorkeeper_authorize! :write, :'write:accounts' }, except: :index\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -4365,12 +4365,20 @@ a.status-card {\n     outline: $ui-button-focus-outline;\n   }\n \n+  .no-reduce-motion .icon {\n+    transition: transform 0.15s ease-in-out;\n+  }\n+\n   &.active {\n     color: $primary-text-color;\n \n     &:hover {\n       color: $primary-text-color;\n     }\n+\n+    .icon {\n+      transform: rotate(60deg);\n+    }\n   }\n \n   &:disabled {\n---\n\n\n---\n\nChoice C:\napp/assets/javascripts/components/components/status_content.jsx\n@@ -92,7 +92,7 @@ const StatusContent = React.createClass({\n \n       return (\n         <div className='status__content' style={{ cursor: 'pointer' }} onMouseDown={this.handleMouseDown} onMouseUp={this.handleMouseUp}>\n-          <p>\n+          <p style={{ marginBottom: hidden ? '0px' : '' }} >\n             <span dangerouslySetInnerHTML={spoilerContent} /> <a onClick={this.handleSpoilerClick}>{toggleText}</a>\n           </p>\n \n---\napp/assets/stylesheets/components.scss\n@@ -679,42 +679,8 @@\n   }\n }\n \n-.spoiler-helper {\n-  margin-bottom: -20px !important;\n-}\n-\n-.spoiler {\n-  &::before {\n-    margin-top: 20px;\n-    display: block;\n-    content: '';\n-  }\n-\n-  display: inline;\n-  cursor: pointer;\n-  border-bottom: 1px dashed white;\n-  .light & {\n-    border-bottom: 1px dashed black;\n-  }\n-\n-  &.spoiler-on {\n-    &, & * {\n-      color: transparent !important;\n-    }\n-    background: white;\n-    .light & {\n-      background: black;\n-    }\n-\n-    .emojione {\n-      opacity: 0;\n-    }\n-  }\n-}\n-\n @import 'boost';\n \n-\n button i.fa-retweet {\n   height: 19px;\n   width: 22px;\n---\napp/services/follow_service.rb\n@@ -71,7 +71,7 @@ def request_follow!\n     if @target_account.local?\n       LocalNotificationWorker.perform_async(@target_account.id, follow_request.id, follow_request.class.name, 'follow_request')\n     elsif @target_account.activitypub?\n-      ActivityPub::DeliveryWorker.perform_async(build_json(follow_request), @source_account.id, @target_account.inbox_url)\n+      ActivityPub::DeliveryWorker.perform_async(build_json(follow_request), @source_account.id, @target_account.inbox_url, { 'bypass_availability' => true })\n     end\n \n     follow_request\n---\napp/workers/activitypub/delivery_worker.rb\n@@ -23,9 +23,10 @@ class ActivityPub::DeliveryWorker\n   HEADERS = { 'Content-Type' => 'application/activity+json' }.freeze\n \n   def perform(json, source_account_id, inbox_url, options = {})\n-    return unless DeliveryFailureTracker.available?(inbox_url)\n-\n     @options        = options.with_indifferent_access\n+\n+    return unless @options[:bypass_availability] || DeliveryFailureTracker.available?(inbox_url)\n+\n     @json           = json\n     @source_account = Account.find(source_account_id)\n     @inbox_url      = inbox_url\n---\n\n\n---\n\nChoice D:\nDockerfile\n@@ -103,6 +103,7 @@ RUN \\\n     procps \\\n     tini \\\n     tzdata \\\n+    wget \\\n   ; \\\n # Patch Ruby to use jemalloc\n   patchelf --add-needed libjemalloc.so.2 /usr/local/bin/ruby; \\\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nAlso refactor `<AccountGallery>`  into TypeScript.\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -9288,6 +9288,7 @@ noscript {\n   border: 1px solid $highlight-text-color;\n   background: rgba($highlight-text-color, 0.15);\n   overflow: hidden;\n+  flex-shrink: 0;\n \n   &__background-image {\n     width: 125%;\n---\n\n\n---\n\nChoice B:\nconfig/webpack/shared.js\n@@ -2,6 +2,7 @@\n \n const { basename, dirname, join, relative, resolve } = require('path');\n \n+const CircularDependencyPlugin = require('circular-dependency-plugin');\n const { sync } = require('glob');\n const MiniCssExtractPlugin = require('mini-css-extract-plugin');\n const extname = require('path-complete-extname');\n@@ -84,6 +85,9 @@ module.exports = {\n       writeToDisk: true,\n       publicPath: true,\n     }),\n+    new CircularDependencyPlugin({\n+      failOnError: true,\n+    })\n   ],\n \n   resolve: {\n---\npackage.json\n@@ -59,6 +59,7 @@\n     \"babel-plugin-preval\": \"^5.1.0\",\n     \"babel-plugin-transform-react-remove-prop-types\": \"^0.4.24\",\n     \"blurhash\": \"^2.0.5\",\n+    \"circular-dependency-plugin\": \"^5.2.2\",\n     \"classnames\": \"^2.3.2\",\n     \"cocoon-js-vanilla\": \"^1.3.0\",\n     \"color-blend\": \"^4.0.0\",\n---\nyarn.lock\n@@ -3998,6 +3998,11 @@ cipher-base@^1.0.0, cipher-base@^1.0.1, cipher-base@^1.0.3:\n     inherits \"^2.0.1\"\n     safe-buffer \"^5.0.1\"\n \n+circular-dependency-plugin@^5.2.2:\n+  version \"5.2.2\"\n+  resolved \"https://registry.yarnpkg.com/circular-dependency-plugin/-/circular-dependency-plugin-5.2.2.tgz#39e836079db1d3cf2f988dc48c5188a44058b600\"\n+  integrity sha512-g38K9Cm5WRwlaH6g03B9OEz/0qRizI+2I7n+Gz+L5DxXJAPAiWQvwlYNm1V1jkdpUv95bOe/ASm2vfi/G560jQ==\n+\n cjs-module-lexer@^1.0.0:\n   version \"1.2.3\"\n   resolved \"https://registry.yarnpkg.com/cjs-module-lexer/-/cjs-module-lexer-1.2.3.tgz#6c370ab19f8a3394e318fe682686ec0ac684d107\"\n@@ -11281,6 +11286,7 @@ stringz@^2.1.0:\n     char-regex \"^1.0.2\"\n \n \"strip-ansi-cjs@npm:strip-ansi@^6.0.1\", strip-ansi@^6.0.0, strip-ansi@^6.0.1:\n+  name strip-ansi-cjs\n   version \"6.0.1\"\n   resolved \"https://registry.yarnpkg.com/strip-ansi/-/strip-ansi-6.0.1.tgz#9e26c63d30f53443e9489495b2105d37b67a85d9\"\n   integrity sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/reducers/relationships.js\n@@ -73,6 +73,7 @@ export default function relationships(state = initialState, action) {\n   case ACCOUNT_UNMUTE_SUCCESS:\n   case ACCOUNT_PIN_SUCCESS:\n   case ACCOUNT_UNPIN_SUCCESS:\n+    return normalizeRelationship(state, action.relationship);\n   case RELATIONSHIPS_FETCH_SUCCESS:\n     return normalizeRelationships(state, action.relationships);\n   case submitAccountNote.fulfilled:\n---\n\n\n---\n\nChoice D:\nCHANGELOG.md\n@@ -2,6 +2,29 @@\n \n All notable changes to this project will be documented in this file.\n \n+## [4.3.7] - 2025-04-02\n+\n+### Add\n+\n+- Add delay to profile updates to debounce them (#34137 by @ClearlyClaire)\n+- Add support for paginating partial collections in `SynchronizeFollowersService` (#34272 and #34277 by @ClearlyClaire)\n+\n+### Changed\n+\n+- Change account suspensions to be federated to recently-followed accounts as well (#34294 by @ClearlyClaire)\n+- Change `AccountReachFinder` to consider statuses based on suspension date (#32805 and #34291 by @ClearlyClaire and @mjankowski)\n+- Change user archive signed URL TTL from 10 seconds to 1 hour (#34254 by @ClearlyClaire)\n+\n+### Fixed\n+\n+- Fix static version of animated PNG emojis not being properly extracted (#34337 by @ClearlyClaire)\n+- Fix filters not applying in detailed view, favourites and bookmarks (#34259 and #34260 by @ClearlyClaire)\n+- Fix handling of malformed/unusual HTML (#34201 by @ClearlyClaire)\n+- Fix `CacheBuster` being queued for missing media attachments (#34253 by @ClearlyClaire)\n+- Fix incorrect URL being used when cache busting (#34189 by @ClearlyClaire)\n+- Fix streaming server refusing unix socket path in `DATABASE_URL` (#34091 by @ClearlyClaire)\n+- Fix \u201cx\u201d hotkey not working on boosted filtered posts (#33758 by @ClearlyClaire)\n+\n ## [4.3.6] - 2025-03-13\n \n ### Security\n---\ndocker-compose.yml\n@@ -59,7 +59,7 @@ services:\n   web:\n     # You can uncomment the following line if you want to not use the prebuilt image, for example if you have local code changes\n     # build: .\n-    image: ghcr.io/mastodon/mastodon:v4.3.6\n+    image: ghcr.io/mastodon/mastodon:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -83,7 +83,7 @@ services:\n     # build:\n     #   dockerfile: ./streaming/Dockerfile\n     #   context: .\n-    image: ghcr.io/mastodon/mastodon-streaming:v4.3.6\n+    image: ghcr.io/mastodon/mastodon-streaming:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: node ./streaming/index.js\n@@ -102,7 +102,7 @@ services:\n   sidekiq:\n     # You can uncomment the following line if you want to not use the prebuilt image, for example if you have local code changes\n     # build: .\n-    image: ghcr.io/mastodon/mastodon:v4.3.6\n+    image: ghcr.io/mastodon/mastodon:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\nlib/mastodon/version.rb\n@@ -13,7 +13,7 @@ def minor\n     end\n \n     def patch\n-      6\n+      7\n     end\n \n     def default_prerelease\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nFixes #33741\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -2249,6 +2249,10 @@ a.account__display-name {\n   }\n }\n \n+.notification-follow {\n+  border-bottom: 1px solid var(--background-border-color);\n+}\n+\n .notification-group--link {\n   color: $secondary-text-color;\n   text-decoration: none;\n---\napp/javascript/styles/mastodon/admin.scss\n@@ -872,6 +872,7 @@ a.name-tag,\n \n     .account {\n       padding: 0;\n+      border: none;\n \n       &__avatar-wrapper {\n         margin-inline-start: 0;\n---\napp/javascript/styles/mastodon/components.scss\n@@ -1808,6 +1808,7 @@ body > [data-popper-placement] {\n \n .account {\n   padding: 16px;\n+  border-bottom: 1px solid var(--background-border-color);\n \n   .account__display-name {\n     flex: 1 1 auto;\n---\n\n\n---\n\nChoice B:\nCHANGELOG.md\n@@ -2,6 +2,29 @@\n \n All notable changes to this project will be documented in this file.\n \n+## [4.3.7] - 2025-04-02\n+\n+### Add\n+\n+- Add delay to profile updates to debounce them (#34137 by @ClearlyClaire)\n+- Add support for paginating partial collections in `SynchronizeFollowersService` (#34272 and #34277 by @ClearlyClaire)\n+\n+### Changed\n+\n+- Change account suspensions to be federated to recently-followed accounts as well (#34294 by @ClearlyClaire)\n+- Change `AccountReachFinder` to consider statuses based on suspension date (#32805 and #34291 by @ClearlyClaire and @mjankowski)\n+- Change user archive signed URL TTL from 10 seconds to 1 hour (#34254 by @ClearlyClaire)\n+\n+### Fixed\n+\n+- Fix static version of animated PNG emojis not being properly extracted (#34337 by @ClearlyClaire)\n+- Fix filters not applying in detailed view, favourites and bookmarks (#34259 and #34260 by @ClearlyClaire)\n+- Fix handling of malformed/unusual HTML (#34201 by @ClearlyClaire)\n+- Fix `CacheBuster` being queued for missing media attachments (#34253 by @ClearlyClaire)\n+- Fix incorrect URL being used when cache busting (#34189 by @ClearlyClaire)\n+- Fix streaming server refusing unix socket path in `DATABASE_URL` (#34091 by @ClearlyClaire)\n+- Fix \u201cx\u201d hotkey not working on boosted filtered posts (#33758 by @ClearlyClaire)\n+\n ## [4.3.6] - 2025-03-13\n \n ### Security\n---\ndocker-compose.yml\n@@ -59,7 +59,7 @@ services:\n   web:\n     # You can uncomment the following line if you want to not use the prebuilt image, for example if you have local code changes\n     # build: .\n-    image: ghcr.io/mastodon/mastodon:v4.3.6\n+    image: ghcr.io/mastodon/mastodon:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -83,7 +83,7 @@ services:\n     # build:\n     #   dockerfile: ./streaming/Dockerfile\n     #   context: .\n-    image: ghcr.io/mastodon/mastodon-streaming:v4.3.6\n+    image: ghcr.io/mastodon/mastodon-streaming:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: node ./streaming/index.js\n@@ -102,7 +102,7 @@ services:\n   sidekiq:\n     # You can uncomment the following line if you want to not use the prebuilt image, for example if you have local code changes\n     # build: .\n-    image: ghcr.io/mastodon/mastodon:v4.3.6\n+    image: ghcr.io/mastodon/mastodon:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\nlib/mastodon/version.rb\n@@ -13,7 +13,7 @@ def minor\n     end\n \n     def patch\n-      6\n+      7\n     end\n \n     def default_prerelease\n---\n\n\n---\n\nChoice C:\napp/services/fetch_link_card_service.rb\n@@ -106,12 +106,11 @@ def skip_link?(anchor)\n   end\n \n   def attempt_oembed\n-    service         = FetchOEmbedService.new\n-    url_domain      = Addressable::URI.parse(@url).normalized_host\n-    cached_endpoint = Rails.cache.read(\"oembed_endpoint:#{url_domain}\")\n+    service = FetchOEmbedService.new\n \n-    embed   = service.call(@url, cached_endpoint: cached_endpoint) unless cached_endpoint.nil?\n+    embed   = service.call(@url, use_cached_endpoint: true)\n     embed ||= service.call(@url, html: html) unless html.nil?\n+    embed ||= service.call(@url, use_cached_endpoint: true) if @url != @original_url.to_s\n \n     return false if embed.nil?\n \n---\napp/services/fetch_oembed_service.rb\n@@ -10,7 +10,7 @@ def call(url, options = {})\n     @url     = url\n     @options = options\n \n-    if @options[:cached_endpoint]\n+    if @options[:use_cached_endpoint]\n       parse_cached_endpoint!\n     else\n       discover_endpoint!\n@@ -57,9 +57,9 @@ def discover_endpoint!\n   end\n \n   def parse_cached_endpoint!\n-    cached = @options[:cached_endpoint]\n+    cached = Rails.cache.read(cache_key)\n \n-    return if cached[:endpoint].nil? || cached[:format].nil?\n+    return if cached.nil? || cached[:endpoint].nil? || cached[:format].nil?\n \n     @endpoint_url = Addressable::Template.new(cached[:endpoint]).expand(url: @url).to_s\n     @format       = cached[:format]\n@@ -68,14 +68,16 @@ def parse_cached_endpoint!\n   def cache_endpoint!\n     return unless URL_REGEX.match?(@endpoint_url)\n \n-    url_domain = Addressable::URI.parse(@url).normalized_host\n-\n     endpoint_hash = {\n       endpoint: @endpoint_url.gsub(URL_REGEX, '={url}'),\n       format: @format,\n     }\n \n-    Rails.cache.write(\"oembed_endpoint:#{url_domain}\", endpoint_hash, expires_in: ENDPOINT_CACHE_EXPIRES_IN)\n+    Rails.cache.write(cache_key, endpoint_hash, expires_in: ENDPOINT_CACHE_EXPIRES_IN)\n+  end\n+\n+  def cache_key\n+    \"oembed_endpoint:#{Addressable::URI.parse(@url).normalized_host}\"\n   end\n \n   def fetch!\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -13,6 +13,7 @@\n     stub_request(:get, 'http://example.com/not-found').to_return(status: 404, headers: { 'Content-Type' => 'text/html' }, body: html)\n     stub_request(:get, 'http://example.com/text').to_return(status: 404, headers: { 'Content-Type' => 'text/plain' }, body: 'Hello')\n     stub_request(:get, 'http://example.com/redirect').to_return(status: 302, headers: { 'Location' => 'http://example.com/html' })\n+    stub_request(:get, 'http://example.net/redirect-to-other-domain').to_return(status: 302, headers: { 'Location' => 'http://example.com/html' })\n     stub_request(:get, 'http://example.com/redirect-to-404').to_return(status: 302, headers: { 'Location' => 'http://example.com/not-found' })\n     stub_request(:get, 'http://example.com/oembed?url=http://example.com/html').to_return(headers: { 'Content-Type' => 'application/json' }, body: '{ \"version\": \"1.0\", \"type\": \"link\", \"title\": \"oEmbed title\" }')\n     stub_request(:get, 'http://example.com/oembed?format=json&url=http://example.com/html').to_return(headers: { 'Content-Type' => 'application/json' }, body: '{ \"version\": \"1.0\", \"type\": \"link\", \"title\": \"oEmbed title\" }')\n@@ -264,6 +265,39 @@\n         end\n       end\n \n+      context 'when oEmbed endpoint cache populated with redirect target' do\n+        let(:status) { Fabricate(:status, text: 'http://example.net/redirect-to-other-domain') }\n+        let(:oembed_cache) { { endpoint: 'http://example.com/oembed?format=json&url={url}', format: :json } }\n+\n+        it 'uses the cached oEmbed response' do\n+          expect(a_request(:get, 'http://example.net/redirect-to-other-domain')).to have_been_made\n+          expect(a_request(:get, 'http://example.com/oembed?url=http://example.com/html')).to have_been_made\n+        end\n+\n+        it 'creates preview card' do\n+          expect(status.preview_card).to_not be_nil\n+          expect(status.preview_card.url).to eq 'http://example.com/html'\n+          expect(status.preview_card.title).to eq 'oEmbed title'\n+        end\n+      end\n+\n+      context 'when oEmbed endpoint cache populated with redirect target but page contains no oEmbed tags' do\n+        let(:status) { Fabricate(:status, text: 'http://example.net/redirect-to-other-domain') }\n+        let(:html) { 'Please fill out CAPTCHA' }\n+        let(:oembed_cache) { { endpoint: 'http://example.com/oembed?format=json&url={url}', format: :json } }\n+\n+        it 'uses the cached oEmbed response' do\n+          expect(a_request(:get, 'http://example.net/redirect-to-other-domain')).to have_been_made\n+          expect(a_request(:get, 'http://example.com/oembed?format=json&url=http://example.com/html')).to have_been_made\n+        end\n+\n+        it 'creates preview card' do\n+          expect(status.preview_card).to_not be_nil\n+          expect(status.preview_card.url).to eq 'http://example.com/html'\n+          expect(status.preview_card.title).to eq 'oEmbed title'\n+        end\n+      end\n+\n       # If the original HTML URL for whatever reason (e.g. DOS protection) redirects to\n       # an error page, we can still use the cached oEmbed but should not use the\n       # redirect URL on the card.\n---\nspec/services/fetch_oembed_service_spec.rb\n@@ -160,10 +160,12 @@\n           headers: { 'Content-Type': 'text/html' },\n           body: request_fixture('oembed_json_empty.html')\n         )\n+\n+        Rails.cache.write('oembed_endpoint:www.youtube.com', { endpoint: 'http://www.youtube.com/oembed?format=json&url={url}', format: :json })\n       end\n \n       it 'returns new provider without fetching original URL first' do\n-        subject.call('https://www.youtube.com/watch?v=dqwpQarrDwk', cached_endpoint: { endpoint: 'http://www.youtube.com/oembed?format=json&url={url}', format: :json })\n+        subject.call('https://www.youtube.com/watch?v=dqwpQarrDwk', use_cached_endpoint: true)\n         expect(a_request(:get, 'https://www.youtube.com/watch?v=dqwpQarrDwk')).to_not have_been_made\n         expect(subject.endpoint_url).to eq 'http://www.youtube.com/oembed?format=json&url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DdqwpQarrDwk'\n         expect(subject.format).to eq :json\n---\napp/lib/link_details_extractor.rb\n@@ -225,7 +225,7 @@ def host_to_url(str)\n   end\n \n   def valid_url_or_nil(str, same_origin_only: false)\n-    return if str.blank? || str == 'null'\n+    return if str.blank? || str == 'null' || str == 'undefined'\n \n     url = @original_url + Addressable::URI.parse(str)\n \n---\nspec/lib/link_details_extractor_spec.rb\n@@ -33,6 +33,14 @@\n         expect(subject.canonical_url).to eq original_url\n       end\n     end\n+\n+    context 'when canonical URL is set to \"undefined\"' do\n+      let(:url) { 'undefined' }\n+\n+      it 'ignores the canonical URLs' do\n+        expect(subject.canonical_url).to eq original_url\n+      end\n+    end\n   end\n \n   context 'when only basic metadata is present' do\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -424,6 +424,10 @@ html {\n   border-bottom: 0;\n }\n \n+.column-settings__hashtags .column-select__option {\n+  color: $white;\n+}\n+\n .dashboard__quick-access,\n .focal-point__preview strong,\n .admin-wrapper .content__heading__tabs a.selected {\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nReformulation of https://github.com/mastodon/mastodon/pull/32779 which appears abandoned. Incorporates the suggested changes. Fixes both the popup box wrap, and the lack of ability to even see the domain in initial view.\r\n\r\nBefore:\r\n\r\n<img width=\"622\" alt=\"Screenshot 2024-12-12 at 13 00 01\" src=\"https://github.com/user-attachments/assets/60042fb3-2fc5-491f-a670-d9dd0b678085\" />\r\n\r\nAfter:\r\n\r\n<img width=\"628\" alt=\"Screenshot 2024-12-12 at 12 55 35\" src=\"https://github.com/user-attachments/assets/b704ea5a-cca8-4838-a65b-eca7d05a56da\" />\r\n\r\nBefore:\r\n\r\n<img width=\"769\" alt=\"Screenshot 2024-12-12 at 13 00 32\" src=\"https://github.com/user-attachments/assets/d2acbee2-fee7-4c48-af1c-d0b8a0a2b2f4\" />\r\n\r\nAfter:\r\n\r\n<img width=\"383\" alt=\"Screenshot 2024-12-12 at 12 55 43\" src=\"https://github.com/user-attachments/assets/72a45e3f-78dd-422f-a83c-b8f3bb969f65\" />\r\n\r\n\r\nGood followup here might be to put the username and domain portions in the popup into separate spans so that we could truncate (or other responsive approach) that so you always see the domain? For now just doing broken-ness fix.\n\n---\n\nChoice A:\napp/services/fan_out_on_write_service.rb\n@@ -74,6 +74,15 @@ def notify_mentioned_accounts!\n       LocalNotificationWorker.push_bulk(mentions) do |mention|\n         [mention.account_id, mention.id, 'Mention', 'mention']\n       end\n+\n+      next unless update?\n+\n+      # This may result in duplicate update payloads, but this ensures clients\n+      # are aware of edits to posts only appearing in mention notifications\n+      # (e.g. private mentions or mentions by people they do not follow)\n+      PushUpdateWorker.push_bulk(mentions.filter { |mention| subscribed_to_streaming_api?(mention.account_id) }) do |mention|\n+        [mention.account_id, @status.id, \"timeline:#{mention.account_id}:notifications\", { 'update' => true }]\n+      end\n     end\n   end\n \n@@ -162,4 +171,8 @@ def update?\n   def broadcastable?\n     @status.public_visibility? && !@status.reblog? && !@account.silenced?\n   end\n+\n+  def subscribed_to_streaming_api?(account_id)\n+    redis.exists?(\"subscribed:timeline:#{account_id}\") || redis.exists?(\"subscribed:timeline:#{account_id}:notifications\")\n+  end\n end\n---\nspec/services/fan_out_on_write_service_spec.rb\n@@ -6,11 +6,12 @@\n   subject { described_class.new }\n \n   let(:last_active_at) { Time.now.utc }\n-  let(:status) { Fabricate(:status, account: alice, visibility: visibility, text: 'Hello @bob #hoge') }\n+  let(:status) { Fabricate(:status, account: alice, visibility: visibility, text: 'Hello @bob @eve #hoge') }\n \n   let!(:alice) { Fabricate(:user, current_sign_in_at: last_active_at).account }\n   let!(:bob)   { Fabricate(:user, current_sign_in_at: last_active_at, account_attributes: { username: 'bob' }).account }\n   let!(:tom)   { Fabricate(:user, current_sign_in_at: last_active_at).account }\n+  let!(:eve)   { Fabricate(:user, current_sign_in_at: last_active_at, account_attributes: { username: 'eve' }).account }\n \n   before do\n     bob.follow!(alice)\n@@ -109,5 +110,24 @@ def home_feed_of(account)\n       expect(redis).to_not have_received(:publish).with('timeline:hashtag:hoge', anything)\n       expect(redis).to_not have_received(:publish).with('timeline:public', anything)\n     end\n+\n+    context 'when handling status updates', :sidekiq_fake do\n+      before do\n+        subject.call(status)\n+\n+        status.snapshot!(at_time: status.created_at, rate_limit: false)\n+        status.update!(text: 'Hello @bob @eve #hoge (edited)')\n+        status.snapshot!(account_id: status.account_id)\n+\n+        redis.set(\"subscribed:timeline:#{eve.id}:notifications\", '1')\n+\n+        Sidekiq::Worker.clear_all\n+      end\n+\n+      it 'pushes the update to mentioned users through the notifications streaming channel' do\n+        subject.call(status, update: true)\n+        expect(PushUpdateWorker).to have_enqueued_sidekiq_job(anything, status.id, \"timeline:#{eve.id}:notifications\", { 'update' => true })\n+      end\n+    end\n   end\n end\n---\n\n\n---\n\nChoice B:\napp/controllers/api/v1/admin/accounts_controller.rb\n@@ -46,8 +46,10 @@ def show\n \n   def enable\n     authorize @account.user, :enable?\n-    @account.user.enable!\n-    log_action :enable, @account.user\n+    if @account.user.disabled\n+      @account.user.enable!\n+      log_action :enable, @account.user\n+    end\n     render json: @account, serializer: REST::Admin::AccountSerializer\n   end\n \n@@ -71,15 +73,19 @@ def destroy\n \n   def unsensitive\n     authorize @account, :unsensitive?\n-    @account.unsensitize!\n-    log_action :unsensitive, @account\n+    if @account.sensitized?\n+      @account.unsensitize!\n+      log_action :unsensitive, @account\n+    end\n     render json: @account, serializer: REST::Admin::AccountSerializer\n   end\n \n   def unsilence\n     authorize @account, :unsilence?\n-    @account.unsilence!\n-    log_action :unsilence, @account\n+    if @account.silenced?\n+      @account.unsilence!\n+      log_action :unsilence, @account\n+    end\n     render json: @account, serializer: REST::Admin::AccountSerializer\n   end\n \n---\napp/controllers/api/v1/admin/reports_controller.rb\n@@ -40,29 +40,37 @@ def update\n \n   def assign_to_self\n     authorize @report, :update?\n-    @report.update!(assigned_account_id: current_account.id)\n-    log_action :assigned_to_self, @report\n+    unless @report.assigned_account_id == current_account.id\n+      @report.update!(assigned_account_id: current_account.id)\n+      log_action :assigned_to_self, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n   def unassign\n     authorize @report, :update?\n-    @report.update!(assigned_account_id: nil)\n-    log_action :unassigned, @report\n+    if @report.assigned_account_id\n+      @report.update!(assigned_account_id: nil)\n+      log_action :unassigned, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n   def reopen\n     authorize @report, :update?\n-    @report.unresolve!\n-    log_action :reopen, @report\n+    unless @report.unresolved?\n+      @report.unresolve!\n+      log_action :reopen, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n   def resolve\n     authorize @report, :update?\n-    @report.resolve!(current_account)\n-    log_action :resolve, @report\n+    unless @report.action_taken?\n+      @report.resolve!(current_account)\n+      log_action :resolve, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n---\nspec/controllers/admin/reports_controller_spec.rb\n@@ -64,7 +64,7 @@\n \n   describe 'POST #reopen' do\n     it 'reopens the report' do\n-      report = Fabricate(:report)\n+      report = Fabricate(:report, action_taken_at: 3.days.ago)\n \n       put :reopen, params: { id: report }\n       expect(response).to redirect_to(admin_report_path(report))\n@@ -89,7 +89,7 @@\n \n   describe 'POST #unassign' do\n     it 'reopens the report' do\n-      report = Fabricate(:report)\n+      report = Fabricate(:report, assigned_account_id: Account.last.id)\n \n       put :unassign, params: { id: report }\n       expect(response).to redirect_to(admin_report_path(report))\n---\napp/models/admin/account_action.rb\n@@ -132,26 +132,26 @@ def process_reports!\n \n   def handle_disable!\n     authorize(target_account.user, :disable?)\n-    log_action(:disable, target_account.user)\n     target_account.user&.disable!\n+    log_action(:disable, target_account.user)\n   end\n \n   def handle_sensitive!\n     authorize(target_account, :sensitive?)\n-    log_action(:sensitive, target_account)\n     target_account.sensitize!\n+    log_action(:sensitive, target_account)\n   end\n \n   def handle_silence!\n     authorize(target_account, :silence?)\n-    log_action(:silence, target_account)\n     target_account.silence!\n+    log_action(:silence, target_account)\n   end\n \n   def handle_suspend!\n     authorize(target_account, :suspend?)\n-    log_action(:suspend, target_account)\n     target_account.suspend!(origin: :local)\n+    log_action(:suspend, target_account)\n   end\n \n   def text_for_warning\n---\n\n\n---\n\nChoice C:\napp/models/web/push_subscription.rb\n@@ -21,7 +21,7 @@ class Web::PushSubscription < ApplicationRecord\n \n   has_one :session_activation, foreign_key: 'web_push_subscription_id', inverse_of: :web_push_subscription, dependent: nil\n \n-  validates :endpoint, presence: true\n+  validates :endpoint, presence: true, url: true\n   validates :key_p256dh, presence: true\n   validates :key_auth, presence: true\n \n---\nspec/requests/api/v1/push/subscriptions_spec.rb\n@@ -4,10 +4,11 @@\n \n describe 'API V1 Push Subscriptions' do\n   let(:user) { Fabricate(:user) }\n+  let(:endpoint) { 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX' }\n   let(:create_payload) do\n     {\n       subscription: {\n-        endpoint: 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX',\n+        endpoint: endpoint,\n         keys: {\n           p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n           auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n@@ -63,6 +64,18 @@\n       expect(endpoint_push_subscriptions.count)\n         .to eq(1)\n     end\n+\n+    context 'with invalid endpoint URL' do\n+      let(:endpoint) { 'app://example.foo' }\n+\n+      it 'returns a validation error' do\n+        subject\n+\n+        expect(response).to have_http_status(422)\n+        expect(endpoint_push_subscriptions.count).to eq(0)\n+        expect(endpoint_push_subscription).to be_nil\n+      end\n+    end\n   end\n \n   describe 'PUT /api/v1/push/subscription' do\n---\napp/models/web/push_subscription.rb\n@@ -25,6 +25,8 @@ class Web::PushSubscription < ApplicationRecord\n   validates :key_p256dh, presence: true\n   validates :key_auth, presence: true\n \n+  validates_with WebPushKeyValidator\n+\n   delegate :locale, to: :associated_user\n \n   def encrypt(payload)\n---\napp/validators/web_push_key_validator.rb\n@@ -0,0 +1,11 @@\n+# frozen_string_literal: true\n+\n+class WebPushKeyValidator < ActiveModel::Validator\n+  def validate(subscription)\n+    begin\n+      Webpush::Encryption.encrypt('validation_test', subscription.key_p256dh, subscription.key_auth)\n+    rescue ArgumentError, OpenSSL::PKey::EC::Point::Error\n+      subscription.errors.add(:base, I18n.t('crypto.errors.invalid_key'))\n+    end\n+  end\n+end\n---\nspec/fabricators/web_push_subscription_fabricator.rb\n@@ -2,6 +2,10 @@\n \n Fabricator(:web_push_subscription, from: Web::PushSubscription) do\n   endpoint   Faker::Internet.url\n-  key_p256dh Faker::Internet.password\n-  key_auth   Faker::Internet.password\n+  key_p256dh do\n+    curve = OpenSSL::PKey::EC.generate('prime256v1')\n+    ecdh_key = curve.public_key.to_bn.to_s(2)\n+    Base64.urlsafe_encode64(ecdh_key)\n+  end\n+  key_auth { Base64.urlsafe_encode64(Random.new.bytes(16)) }\n end\n---\nspec/requests/api/v1/push/subscriptions_spec.rb\n@@ -5,14 +5,17 @@\n describe 'API V1 Push Subscriptions' do\n   let(:user) { Fabricate(:user) }\n   let(:endpoint) { 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX' }\n+  let(:keys) do\n+    {\n+      p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n+      auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+    }\n+  end\n   let(:create_payload) do\n     {\n       subscription: {\n         endpoint: endpoint,\n-        keys: {\n-          p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n-          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n-        },\n+        keys: keys,\n       },\n     }.with_indifferent_access\n   end\n@@ -37,6 +40,16 @@\n   let(:token) { Fabricate(:accessible_access_token, resource_owner_id: user.id, scopes: scopes) }\n   let(:headers) { { 'Authorization' => \"Bearer #{token.token}\" } }\n \n+  shared_examples 'validation error' do\n+    it 'returns a validation error' do\n+      subject\n+\n+      expect(response).to have_http_status(422)\n+      expect(endpoint_push_subscriptions.count).to eq(0)\n+      expect(endpoint_push_subscription).to be_nil\n+    end\n+  end\n+\n   describe 'POST /api/v1/push/subscription' do\n     subject { post '/api/v1/push/subscription', params: create_payload, headers: headers }\n \n@@ -68,13 +81,29 @@\n     context 'with invalid endpoint URL' do\n       let(:endpoint) { 'app://example.foo' }\n \n-      it 'returns a validation error' do\n-        subject\n+      it_behaves_like 'validation error'\n+    end\n+\n+    context 'with invalid p256dh key' do\n+      let(:keys) do\n+        {\n+          p256dh: 'BEm_invalidf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n+          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+        }\n+      end\n \n-        expect(response).to have_http_status(422)\n-        expect(endpoint_push_subscriptions.count).to eq(0)\n-        expect(endpoint_push_subscription).to be_nil\n+      it_behaves_like 'validation error'\n+    end\n+\n+    context 'with invalid base64 p256dh key' do\n+      let(:keys) do\n+        {\n+          p256dh: 'not base64',\n+          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+        }\n       end\n+\n+      it_behaves_like 'validation error'\n     end\n   end\n \n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -1996,6 +1996,7 @@ body > [data-popper-placement] {\n \n         &__handle {\n           user-select: all;\n+          overflow-wrap: anywhere;\n         }\n       }\n \n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nExtracted from a previous now-closed PR which was also doing more things. Simpler version here I hope.\r\n\r\nThe spec changes are adding coverage for the one validation method in the class re: the follow status of the connected accounts.\r\n\r\nThe change in the model is needed to make spec pass, and I think is probably a bugfix (the line in the validation method will error when an account is not present -- so it needs either a change like this, or safe navigation added, to run correctly). When the account is missed the record will be invalid (from the association declaration).\n\n---\n\nChoice A:\napp/lib/activitypub/activity/flag.rb\n@@ -9,7 +9,7 @@ def perform\n \n     target_accounts.each do |target_account|\n       target_statuses     = target_statuses_by_account[target_account.id]\n-      replied_to_accounts = Account.local.where(id: target_statuses.filter_map(&:in_reply_to_account_id))\n+      replied_to_accounts = target_statuses.nil? ? [] : Account.local.where(id: target_statuses.filter_map(&:in_reply_to_account_id))\n \n       next if target_account.suspended? || (!target_account.local? && replied_to_accounts.none?)\n \n---\nspec/lib/activitypub/activity/flag_spec.rb\n@@ -139,6 +139,35 @@\n         expect(report.status_ids).to eq []\n       end\n     end\n+\n+    context 'when an account is passed but no status' do\n+      let(:mentioned) { Fabricate(:account) }\n+\n+      let(:json) do\n+        {\n+          '@context': 'https://www.w3.org/ns/activitystreams',\n+          id: flag_id,\n+          type: 'Flag',\n+          content: 'Boo!!',\n+          actor: ActivityPub::TagManager.instance.uri_for(sender),\n+          object: [\n+            ActivityPub::TagManager.instance.uri_for(flagged),\n+          ],\n+        }.with_indifferent_access\n+      end\n+\n+      before do\n+        subject.perform\n+      end\n+\n+      it 'creates a report with no attached status' do\n+        report = Report.find_by(account: sender, target_account: flagged)\n+\n+        expect(report).to_not be_nil\n+        expect(report.comment).to eq 'Boo!!'\n+        expect(report.status_ids).to eq []\n+      end\n+    end\n   end\n \n   describe '#perform with a defined uri' do\n---\n\n\n---\n\nChoice B:\napp/models/admin/import.rb\n@@ -30,12 +30,14 @@ def csv_data\n \n     csv_converter = lambda do |field, field_info|\n       case field_info.header\n-      when '#domain', '#public_comment'\n+      when '#domain'\n+        field&.downcase&.strip\n+      when '#public_comment'\n         field&.strip\n       when '#severity'\n-        field&.strip&.to_sym\n+        field&.downcase&.strip&.to_sym\n       when '#reject_media', '#reject_reports', '#obfuscate'\n-        ActiveModel::Type::Boolean.new.cast(field)\n+        ActiveModel::Type::Boolean.new.cast(field&.downcase)\n       else\n         field\n       end\n---\n\n\n---\n\nChoice C:\napp/helpers/email_helper.rb\n@@ -6,13 +6,17 @@ def self.included(base)\n   end\n \n   def email_to_canonical_email(str)\n+    return nil if str.nil?\n+\n     username, domain = str.downcase.split('@', 2)\n     username, = username.delete('.').split('+', 2)\n \n     \"#{username}@#{domain}\"\n   end\n \n   def email_to_canonical_email_hash(str)\n+    return nil if str.nil?\n+\n     Digest::SHA2.new(256).hexdigest(email_to_canonical_email(str))\n   end\n end\n---\n\n\n---\n\nChoice D:\napp/models/account_pin.rb\n@@ -5,10 +5,10 @@\n # Table name: account_pins\n #\n #  id                :bigint(8)        not null, primary key\n-#  account_id        :bigint(8)\n-#  target_account_id :bigint(8)\n #  created_at        :datetime         not null\n #  updated_at        :datetime         not null\n+#  account_id        :bigint(8)        not null\n+#  target_account_id :bigint(8)        not null\n #\n \n class AccountPin < ApplicationRecord\n---\ndb/migrate/20241210140838_add_not_null_to_account_pin_account_columns.rb\n@@ -0,0 +1,23 @@\n+# frozen_string_literal: true\n+\n+class AddNotNullToAccountPinAccountColumns < ActiveRecord::Migration[7.2]\n+  def up\n+    connection.execute(<<~SQL.squish)\n+      DELETE FROM account_pins\n+      WHERE account_id IS NULL\n+      OR target_account_id IS NULL\n+    SQL\n+\n+    safety_assured do\n+      change_column_null :account_pins, :account_id, false\n+      change_column_null :account_pins, :target_account_id, false\n+    end\n+  end\n+\n+  def down\n+    safety_assured do\n+      change_column_null :account_pins, :account_id, true\n+      change_column_null :account_pins, :target_account_id, true\n+    end\n+  end\n+end\n---\ndb/schema.rb\n@@ -10,7 +10,7 @@\n #\n # It's strongly recommended that you check this file into your version control system.\n \n-ActiveRecord::Schema[7.2].define(version: 2024_12_05_163118) do\n+ActiveRecord::Schema[7.2].define(version: 2024_12_10_140838) do\n   # These are extensions that must be enabled in order to support this database\n   enable_extension \"plpgsql\"\n \n@@ -82,8 +82,8 @@\n   end\n \n   create_table \"account_pins\", force: :cascade do |t|\n-    t.bigint \"account_id\"\n-    t.bigint \"target_account_id\"\n+    t.bigint \"account_id\", null: false\n+    t.bigint \"target_account_id\", null: false\n     t.datetime \"created_at\", precision: nil, null: false\n     t.datetime \"updated_at\", precision: nil, null: false\n     t.index [\"account_id\", \"target_account_id\"], name: \"index_account_pins_on_account_id_and_target_account_id\", unique: true\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nResolves https://github.com/mastodon/mastodon/issues/26256\r\n\r\nSimilar to existing https://github.com/mastodon/mastodon/blob/v4.3.2/app/models/webauthn_credential.rb#L18\r\n\r\nWhat is currently an app error becomes an utterly absurd validation error instead:\r\n\r\n<img width=\"353\" alt=\"Screenshot 2024-12-03 at 21 28 40\" src=\"https://github.com/user-attachments/assets/4971bbe6-fa94-46b4-a0a7-d71eb755ffec\">\r\n\r\nPossible followup...\r\n\r\n- I bet there are more of these where user-supplied values could exceed a column limit, could do audit on that\r\n- I could have sworn there was either a more framework-native way to do this, or a way to introspect into PG/Rails to get these values, but I can't find it\n\n---\n\nChoice A:\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -4,8 +4,6 @@ import { Children, cloneElement, useCallback } from 'react';\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import ImmutablePureComponent from 'react-immutable-pure-component';\n \n-import { supportsPassiveEvents } from 'detect-passive-events';\n-\n import { scrollRight } from '../../../scroll';\n import BundleContainer from '../containers/bundle_container';\n import {\n@@ -71,10 +69,6 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   };\n \n   componentDidMount() {\n-    if (!this.props.singleColumn) {\n-      this.node.addEventListener('wheel', this.handleWheel, supportsPassiveEvents ? { passive: true } : false);\n-    }\n-\n     if (this.mediaQuery) {\n       if (this.mediaQuery.addEventListener) {\n         this.mediaQuery.addEventListener('change', this.handleLayoutChange);\n@@ -87,23 +81,7 @@ export default class ColumnsArea extends ImmutablePureComponent {\n     this.isRtlLayout = document.getElementsByTagName('body')[0].classList.contains('rtl');\n   }\n \n-  UNSAFE_componentWillUpdate(nextProps) {\n-    if (this.props.singleColumn !== nextProps.singleColumn && nextProps.singleColumn) {\n-      this.node.removeEventListener('wheel', this.handleWheel);\n-    }\n-  }\n-\n-  componentDidUpdate(prevProps) {\n-    if (this.props.singleColumn !== prevProps.singleColumn && !this.props.singleColumn) {\n-      this.node.addEventListener('wheel', this.handleWheel, supportsPassiveEvents ? { passive: true } : false);\n-    }\n-  }\n-\n   componentWillUnmount () {\n-    if (!this.props.singleColumn) {\n-      this.node.removeEventListener('wheel', this.handleWheel);\n-    }\n-\n     if (this.mediaQuery) {\n       if (this.mediaQuery.removeEventListener) {\n         this.mediaQuery.removeEventListener('change', this.handleLayoutChange);\n@@ -116,22 +94,14 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   handleChildrenContentChange() {\n     if (!this.props.singleColumn) {\n       const modifier = this.isRtlLayout ? -1 : 1;\n-      this._interruptScrollAnimation = scrollRight(this.node, (this.node.scrollWidth - window.innerWidth) * modifier);\n+      scrollRight(this.node, (this.node.scrollWidth - window.innerWidth) * modifier);\n     }\n   }\n \n   handleLayoutChange = (e) => {\n     this.setState({ renderComposePanel: !e.matches });\n   };\n \n-  handleWheel = () => {\n-    if (typeof this._interruptScrollAnimation !== 'function') {\n-      return;\n-    }\n-\n-    this._interruptScrollAnimation();\n-  };\n-\n   setRef = (node) => {\n     this.node = node;\n   };\n---\napp/javascript/mastodon/scroll.ts\n@@ -38,13 +38,20 @@ const scroll = (\n const isScrollBehaviorSupported =\n   'scrollBehavior' in document.documentElement.style;\n \n-export const scrollRight = (node: Element, position: number) => {\n-  if (isScrollBehaviorSupported)\n-    node.scrollTo({ left: position, behavior: 'smooth' });\n-  else scroll(node, 'scrollLeft', position);\n-};\n-\n-export const scrollTop = (node: Element) => {\n-  if (isScrollBehaviorSupported) node.scrollTo({ top: 0, behavior: 'smooth' });\n-  else scroll(node, 'scrollTop', 0);\n-};\n+export const scrollRight = (node: Element, position: number) =>\n+  requestIdleCallback(() => {\n+    if (isScrollBehaviorSupported) {\n+      node.scrollTo({ left: position, behavior: 'smooth' });\n+    } else {\n+      scroll(node, 'scrollLeft', position);\n+    }\n+  });\n+\n+export const scrollTop = (node: Element) =>\n+  requestIdleCallback(() => {\n+    if (isScrollBehaviorSupported) {\n+      node.scrollTo({ top: 0, behavior: 'smooth' });\n+    } else {\n+      scroll(node, 'scrollTop', 0);\n+    }\n+  });\n---\napp/javascript/mastodon/test_helpers.tsx\n@@ -8,6 +8,14 @@ import { render as rtlRender } from '@testing-library/react';\n \n import { IdentityContext } from './identity_context';\n \n+beforeEach(() => {\n+  global.requestIdleCallback = jest\n+    .fn()\n+    .mockImplementation((fn: () => void) => {\n+      fn();\n+    });\n+});\n+\n function render(\n   ui: React.ReactElement,\n   {\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/home_timeline/components/inline_follow_suggestions.jsx\n@@ -59,7 +59,7 @@ Source.propTypes = {\n   id: PropTypes.oneOf(['friends_of_friends', 'similar_to_recently_followed', 'featured', 'most_followed', 'most_interactions']),\n };\n \n-const Card = ({ id, source }) => {\n+const Card = ({ id, sources }) => {\n   const intl = useIntl();\n   const account = useSelector(state => state.getIn(['accounts', id]));\n   const relationship = useSelector(state => state.getIn(['relationships', id]));\n@@ -89,7 +89,7 @@ const Card = ({ id, source }) => {\n \n       <div className='inline-follow-suggestions__body__scrollable__card__text-stack'>\n         <Link to={`/@${account.get('acct')}`}><DisplayName account={account} /></Link>\n-        {firstVerifiedField ? <VerifiedBadge link={firstVerifiedField.get('value')} /> : <Source id={source.get(0)} />}\n+        {firstVerifiedField ? <VerifiedBadge link={firstVerifiedField.get('value')} /> : <Source id={sources.get(0)} />}\n       </div>\n \n       <Button text={intl.formatMessage(following ? messages.unfollow : messages.follow)} onClick={handleFollow} />\n@@ -99,7 +99,7 @@ const Card = ({ id, source }) => {\n \n Card.propTypes = {\n   id: PropTypes.string.isRequired,\n-  source: ImmutablePropTypes.list,\n+  sources: ImmutablePropTypes.list,\n };\n \n const DISMISSIBLE_ID = 'home/follow-suggestions';\n@@ -175,7 +175,7 @@ export const InlineFollowSuggestions = ({ hidden }) => {\n             <Card\n               key={suggestion.get('account')}\n               id={suggestion.get('account')}\n-              source={suggestion.get('source')}\n+              sources={suggestion.get('sources')}\n             />\n           ))}\n         </div>\n---\napp/models/account_suggestions.rb\n@@ -31,12 +31,12 @@ def get(limit, offset = 0)\n       account_ids  = account_ids_with_sources[offset, limit]\n       accounts_map = Account.where(id: account_ids.map(&:first)).includes(:account_stat, :user).index_by(&:id)\n \n-      account_ids.filter_map do |(account_id, source)|\n+      account_ids.filter_map do |(account_id, sources)|\n         next unless accounts_map.key?(account_id)\n \n         AccountSuggestions::Suggestion.new(\n           account: accounts_map[account_id],\n-          source: source\n+          sources: sources\n         )\n       end\n     end\n---\napp/models/account_suggestions/suggestion.rb\n@@ -1,7 +1,7 @@\n # frozen_string_literal: true\n \n class AccountSuggestions::Suggestion < ActiveModelSerializers::Model\n-  attributes :account, :source\n+  attributes :account, :sources\n \n   delegate :id, to: :account, prefix: true\n end\n---\napp/serializers/rest/suggestion_serializer.rb\n@@ -1,7 +1,20 @@\n # frozen_string_literal: true\n \n class REST::SuggestionSerializer < ActiveModel::Serializer\n-  attributes :source\n+  attributes :source, :sources\n \n   has_one :account, serializer: REST::AccountSerializer\n+\n+  LEGACY_SOURCE_TYPE_MAP = {\n+    featured: 'staff',\n+    most_followed: 'global',\n+    most_interactions: 'global',\n+    # NOTE: Those are not completely accurate, but those are personalized interactions\n+    similar_to_recently_followed: 'past_interactions',\n+    friends_of_friends: 'past_interactions',\n+  }.freeze\n+\n+  def source\n+    LEGACY_SOURCE_TYPE_MAP[object.sources.first]\n+  end\n end\n---\nspec/requests/api/v2/suggestions_spec.rb\n@@ -9,10 +9,28 @@\n   let(:headers) { { 'Authorization' => \"Bearer #{token.token}\" } }\n \n   describe 'GET /api/v2/suggestions' do\n-    it 'returns http success' do\n+    let(:bob) { Fabricate(:account) }\n+    let(:jeff) { Fabricate(:account) }\n+    let(:params) { {} }\n+\n+    before do\n+      Setting.bootstrap_timeline_accounts = [bob, jeff].map(&:acct).join(',')\n+    end\n+\n+    it 'returns the expected suggestions' do\n       get '/api/v2/suggestions', headers: headers\n \n       expect(response).to have_http_status(200)\n+\n+      expect(body_as_json).to match_array(\n+        [bob, jeff].map do |account|\n+          hash_including({\n+            source: 'staff',\n+            sources: ['featured'],\n+            account: hash_including({ id: account.id.to_s }),\n+          })\n+        end\n+      )\n     end\n   end\n end\n---\nspec/serializers/rest/suggestion_serializer_spec.rb\n@@ -7,7 +7,7 @@\n   let(:record) do\n     AccountSuggestions::Suggestion.new(\n       account: account,\n-      source: 'SuggestionSource'\n+      sources: ['SuggestionSource']\n     )\n   end\n   let(:account) { Fabricate(:account) }\n---\n\n\n---\n\nChoice C:\napp/models/user_role.rb\n@@ -41,7 +41,7 @@ class UserRole < ApplicationRecord\n   EVERYONE_ROLE_ID = -99\n   NOBODY_POSITION = -1\n \n-  POSITION_LIMIT = 2**31\n+  POSITION_LIMIT = (2**31) - 1\n \n   module Flags\n     NONE = 0\n@@ -91,7 +91,7 @@ module Flags\n \n   validates :name, presence: true, unless: :everyone?\n   validates :color, format: { with: /\\A#?(?:[A-F0-9]{3}){1,2}\\z/i }, unless: -> { color.blank? }\n-  validates :position, numericality: { greater_than_or_equal_to: -POSITION_LIMIT, less_than_or_equal_to: POSITION_LIMIT }\n+  validates :position, numericality: { in: (-POSITION_LIMIT..POSITION_LIMIT) }\n \n   validate :validate_permissions_elevation\n   validate :validate_position_elevation\n---\nspec/models/user_role_spec.rb\n@@ -21,11 +21,9 @@\n     describe 'position' do\n       subject { Fabricate.build :user_role }\n \n-      let(:excess) { 2**32 }\n-      let(:limit) { 2**31 }\n+      let(:limit) { described_class::POSITION_LIMIT }\n \n-      it { is_expected.to_not allow_values(-excess, excess).for(:position) }\n-      it { is_expected.to allow_values(-limit, limit).for(:position) }\n+      it { is_expected.to validate_numericality_of(:position).is_in(-limit..limit) }\n     end\n \n     describe 'color' do\n---\n\n\n---\n\nChoice D:\napp/models/status.rb\n@@ -162,7 +162,7 @@ class Status < ApplicationRecord\n   REAL_TIME_WINDOW = 6.hours\n \n   def cache_key\n-    \"v2:#{super}\"\n+    \"v3:#{super}\"\n   end\n \n   def searchable_by(preloaded = nil)\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nFixes MAS-335\n\n---\n\nChoice A:\nlib/mastodon/cli/feeds.rb\n@@ -5,6 +5,7 @@\n module Mastodon::CLI\n   class Feeds < Base\n     include Redisable\n+    include DatabaseHelper\n \n     option :all, type: :boolean, default: false\n     option :concurrency, type: :numeric, default: 5, aliases: [:c]\n@@ -44,6 +45,38 @@ def clear\n       say('OK', :green)\n     end\n \n+    desc 'vacuum', 'Remove home feeds of inactive users from Redis'\n+    long_desc <<-LONG_DESC\n+      Running this task should not be needed in most cases, as Mastodon will\n+      automatically clean up feeds from inactive accounts every day.\n+\n+      However, this task is more aggressive in order to clean up feeds that\n+      may have been missed because of bugs or database mishaps.\n+    LONG_DESC\n+    def vacuum\n+      with_read_replica do\n+        say('Deleting orphaned home feeds\u2026')\n+        redis.scan_each(match: 'feed:home:*').each_slice(1000) do |keys|\n+          ids = keys.map { |key| key.split(':')[2] }.compact_blank\n+\n+          known_ids = User.confirmed.signed_in_recently.where(account_id: ids).pluck(:account_id)\n+\n+          keys_to_delete = keys.filter { |key| known_ids.exclude?(key.split(':')[2]&.to_i) }\n+          redis.del(keys_to_delete)\n+        end\n+\n+        say('Deleting orphaned list feeds\u2026')\n+        redis.scan_each(match: 'feed:list:*').each_slice(1000) do |keys|\n+          ids = keys.map { |key| key.split(':')[2] }.compact_blank\n+\n+          known_ids = List.where(account_id: User.confirmed.signed_in_recently.select(:account_id)).where(id: ids).pluck(:id)\n+\n+          keys_to_delete = keys.filter { |key| known_ids.exclude?(key.split(':')[2]&.to_i) }\n+          redis.del(keys_to_delete)\n+        end\n+      end\n+    end\n+\n     private\n \n     def active_user_accounts\n---\n\n\n---\n\nChoice B:\napp/services/resolve_account_service.rb\n@@ -100,7 +100,9 @@ def process_webfinger!(uri)\n   end\n \n   def split_acct(acct)\n-    acct.delete_prefix('acct:').split('@')\n+    acct.delete_prefix('acct:').split('@').tap do |parts|\n+      raise Webfinger::Error, 'Webfinger response is missing user or host value' unless parts.size == 2\n+    end\n   end\n \n   def fetch_account!\n---\nspec/services/resolve_account_service_spec.rb\n@@ -144,6 +144,19 @@\n     end\n   end\n \n+  context 'with webfinger response subject missing a host value' do\n+    let(:body) { Oj.dump({ subject: 'user@' }) }\n+    let(:url) { 'https://host.example/.well-known/webfinger?resource=acct:user@host.example' }\n+\n+    before do\n+      stub_request(:get, url).to_return(status: 200, body: body)\n+    end\n+\n+    it 'returns nil with incomplete subject in response' do\n+      expect(subject.call('user@host.example')).to be_nil\n+    end\n+  end\n+\n   context 'with an ActivityPub account' do\n     it 'returns new remote account' do\n       account = subject.call('foo@ap.example.com')\n---\n\n\n---\n\nChoice C:\nconfig/webpack/shared.js\n@@ -2,6 +2,7 @@\n \n const { basename, dirname, join, relative, resolve } = require('path');\n \n+const CircularDependencyPlugin = require('circular-dependency-plugin');\n const { sync } = require('glob');\n const MiniCssExtractPlugin = require('mini-css-extract-plugin');\n const extname = require('path-complete-extname');\n@@ -84,6 +85,9 @@ module.exports = {\n       writeToDisk: true,\n       publicPath: true,\n     }),\n+    new CircularDependencyPlugin({\n+      failOnError: true,\n+    })\n   ],\n \n   resolve: {\n---\npackage.json\n@@ -59,6 +59,7 @@\n     \"babel-plugin-preval\": \"^5.1.0\",\n     \"babel-plugin-transform-react-remove-prop-types\": \"^0.4.24\",\n     \"blurhash\": \"^2.0.5\",\n+    \"circular-dependency-plugin\": \"^5.2.2\",\n     \"classnames\": \"^2.3.2\",\n     \"cocoon-js-vanilla\": \"^1.3.0\",\n     \"color-blend\": \"^4.0.0\",\n---\nyarn.lock\n@@ -3998,6 +3998,11 @@ cipher-base@^1.0.0, cipher-base@^1.0.1, cipher-base@^1.0.3:\n     inherits \"^2.0.1\"\n     safe-buffer \"^5.0.1\"\n \n+circular-dependency-plugin@^5.2.2:\n+  version \"5.2.2\"\n+  resolved \"https://registry.yarnpkg.com/circular-dependency-plugin/-/circular-dependency-plugin-5.2.2.tgz#39e836079db1d3cf2f988dc48c5188a44058b600\"\n+  integrity sha512-g38K9Cm5WRwlaH6g03B9OEz/0qRizI+2I7n+Gz+L5DxXJAPAiWQvwlYNm1V1jkdpUv95bOe/ASm2vfi/G560jQ==\n+\n cjs-module-lexer@^1.0.0:\n   version \"1.2.3\"\n   resolved \"https://registry.yarnpkg.com/cjs-module-lexer/-/cjs-module-lexer-1.2.3.tgz#6c370ab19f8a3394e318fe682686ec0ac684d107\"\n@@ -11281,6 +11286,7 @@ stringz@^2.1.0:\n     char-regex \"^1.0.2\"\n \n \"strip-ansi-cjs@npm:strip-ansi@^6.0.1\", strip-ansi@^6.0.0, strip-ansi@^6.0.1:\n+  name strip-ansi-cjs\n   version \"6.0.1\"\n   resolved \"https://registry.yarnpkg.com/strip-ansi/-/strip-ansi-6.0.1.tgz#9e26c63d30f53443e9489495b2105d37b67a85d9\"\n   integrity sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -300,10 +300,15 @@ html {\n   }\n \n   &__item {\n+    color: $darker-text-color;\n+\n+    &--dangerous {\n+      color: $error-value-color;\n+    }\n+\n     a,\n     button {\n       background: $white;\n-      color: $darker-text-color;\n     }\n   }\n }\n@@ -315,9 +320,9 @@ html {\n .privacy-dropdown__option.active .privacy-dropdown__option__content strong,\n .privacy-dropdown__option:hover .privacy-dropdown__option__content,\n .privacy-dropdown__option:hover .privacy-dropdown__option__content strong,\n-.dropdown-menu__item a:active,\n-.dropdown-menu__item a:focus,\n-.dropdown-menu__item a:hover,\n+.dropdown-menu__item:not(.dropdown-menu__item--dangerous) a:active,\n+.dropdown-menu__item:not(.dropdown-menu__item--dangerous) a:focus,\n+.dropdown-menu__item:not(.dropdown-menu__item--dangerous) a:hover,\n .actions-modal ul li:not(:empty) a.active,\n .actions-modal ul li:not(:empty) a.active button,\n .actions-modal ul li:not(:empty) a:active,\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nThese run fine despite being deprecated now, but will error in Rails 8.\r\n\r\nExtracted from https://github.com/mastodon/mastodon/pull/32357\n\n---\n\nChoice A:\napp/models/tag.rb\n@@ -37,7 +37,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?<![=/)\\w])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}i\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]\\u0E47-\\u0E4E#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/tag_spec.rb\n@@ -36,6 +36,10 @@\n       expect(subject.match('https://gcc.gnu.org/bugzilla/show_bug.cgi?id=111895#c4')).to be_nil\n     end\n \n+    it 'does not match URLs with hashtag-like anchors after a non-ascii character' do\n+      expect(subject.match('https://example.org/test\u00e9#foo')).to be_nil\n+    end\n+\n     it 'does not match URLs with hashtag-like anchors after an empty query parameter' do\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)?foo=#Lawsuit')).to be_nil\n     end\n---\n\n\n---\n\nChoice B:\nGemfile\n@@ -6,7 +6,7 @@ ruby '>= 3.2.0'\n gem 'propshaft'\n gem 'puma', '~> 6.3'\n gem 'rack', '~> 2.2.7'\n-gem 'rails', '~> 7.2.0'\n+gem 'rails', '~> 8.0'\n gem 'thor', '~> 1.2'\n \n gem 'dotenv'\n@@ -73,7 +73,7 @@ gem 'public_suffix', '~> 6.0'\n gem 'pundit', '~> 2.3'\n gem 'rack-attack', '~> 6.6'\n gem 'rack-cors', '~> 2.0', require: 'rack/cors'\n-gem 'rails-i18n', '~> 7.0'\n+gem 'rails-i18n', '~> 8.0'\n gem 'redcarpet', '~> 3.6'\n gem 'redis', '~> 4.5', require: ['redis', 'redis/connection/hiredis']\n gem 'redis-namespace', '~> 1.10'\n---\nGemfile.lock\n@@ -10,46 +10,45 @@ GIT\n GEM\n   remote: https://rubygems.org/\n   specs:\n-    actioncable (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actioncable (8.0.1)\n+      actionpack (= 8.0.1)\n+      activesupport (= 8.0.1)\n       nio4r (~> 2.0)\n       websocket-driver (>= 0.6.1)\n       zeitwerk (~> 2.6)\n-    actionmailbox (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activestorage (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionmailbox (8.0.1)\n+      actionpack (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activestorage (= 8.0.1)\n+      activesupport (= 8.0.1)\n       mail (>= 2.8.0)\n-    actionmailer (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      actionview (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionmailer (8.0.1)\n+      actionpack (= 8.0.1)\n+      actionview (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activesupport (= 8.0.1)\n       mail (>= 2.8.0)\n       rails-dom-testing (~> 2.2)\n-    actionpack (7.2.2.1)\n-      actionview (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionpack (8.0.1)\n+      actionview (= 8.0.1)\n+      activesupport (= 8.0.1)\n       nokogiri (>= 1.8.5)\n-      racc\n-      rack (>= 2.2.4, < 3.2)\n+      rack (>= 2.2.4)\n       rack-session (>= 1.0.1)\n       rack-test (>= 0.6.3)\n       rails-dom-testing (~> 2.2)\n       rails-html-sanitizer (~> 1.6)\n       useragent (~> 0.16)\n-    actiontext (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activestorage (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actiontext (8.0.1)\n+      actionpack (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activestorage (= 8.0.1)\n+      activesupport (= 8.0.1)\n       globalid (>= 0.6.0)\n       nokogiri (>= 1.8.5)\n-    actionview (7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionview (8.0.1)\n+      activesupport (= 8.0.1)\n       builder (~> 3.1)\n       erubi (~> 1.11)\n       rails-dom-testing (~> 2.2)\n@@ -59,22 +58,22 @@ GEM\n       activemodel (>= 4.1)\n       case_transform (>= 0.2)\n       jsonapi-renderer (>= 0.1.1.beta1, < 0.3)\n-    activejob (7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    activejob (8.0.1)\n+      activesupport (= 8.0.1)\n       globalid (>= 0.3.6)\n-    activemodel (7.2.2.1)\n-      activesupport (= 7.2.2.1)\n-    activerecord (7.2.2.1)\n-      activemodel (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    activemodel (8.0.1)\n+      activesupport (= 8.0.1)\n+    activerecord (8.0.1)\n+      activemodel (= 8.0.1)\n+      activesupport (= 8.0.1)\n       timeout (>= 0.4.0)\n-    activestorage (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    activestorage (8.0.1)\n+      actionpack (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activesupport (= 8.0.1)\n       marcel (~> 1.0)\n-    activesupport (7.2.2.1)\n+    activesupport (8.0.1)\n       base64\n       benchmark (>= 0.3)\n       bigdecimal\n@@ -86,6 +85,7 @@ GEM\n       minitest (>= 5.1)\n       securerandom (>= 0.3)\n       tzinfo (~> 2.0, >= 2.0.5)\n+      uri (>= 0.13.1)\n     addressable (2.8.7)\n       public_suffix (>= 2.0.2, < 7.0)\n     aes_key_wrap (1.1.0)\n@@ -613,20 +613,20 @@ GEM\n     rackup (1.0.1)\n       rack (< 3)\n       webrick\n-    rails (7.2.2.1)\n-      actioncable (= 7.2.2.1)\n-      actionmailbox (= 7.2.2.1)\n-      actionmailer (= 7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      actiontext (= 7.2.2.1)\n-      actionview (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activemodel (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activestorage (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    rails (8.0.1)\n+      actioncable (= 8.0.1)\n+      actionmailbox (= 8.0.1)\n+      actionmailer (= 8.0.1)\n+      actionpack (= 8.0.1)\n+      actiontext (= 8.0.1)\n+      actionview (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activemodel (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activestorage (= 8.0.1)\n+      activesupport (= 8.0.1)\n       bundler (>= 1.15.0)\n-      railties (= 7.2.2.1)\n+      railties (= 8.0.1)\n     rails-controller-testing (1.0.5)\n       actionpack (>= 5.0.1.rc1)\n       actionview (>= 5.0.1.rc1)\n@@ -638,12 +638,12 @@ GEM\n     rails-html-sanitizer (1.6.2)\n       loofah (~> 2.21)\n       nokogiri (>= 1.15.7, != 1.16.7, != 1.16.6, != 1.16.5, != 1.16.4, != 1.16.3, != 1.16.2, != 1.16.1, != 1.16.0.rc1, != 1.16.0)\n-    rails-i18n (7.0.10)\n+    rails-i18n (8.0.1)\n       i18n (>= 0.7, < 2)\n-      railties (>= 6.0.0, < 8)\n-    railties (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+      railties (>= 8.0.0, < 9)\n+    railties (8.0.1)\n+      actionpack (= 8.0.1)\n+      activesupport (= 8.0.1)\n       irb (~> 1.13)\n       rackup (>= 1.0.0)\n       rake (>= 12.2)\n@@ -986,9 +986,9 @@ DEPENDENCIES\n   rack-attack (~> 6.6)\n   rack-cors (~> 2.0)\n   rack-test (~> 2.1)\n-  rails (~> 7.2.0)\n+  rails (~> 8.0)\n   rails-controller-testing (~> 1.0)\n-  rails-i18n (~> 7.0)\n+  rails-i18n (~> 8.0)\n   rdf-normalize (~> 0.5)\n   redcarpet (~> 3.6)\n   redis (~> 4.5)\n---\nconfig/application.rb\n@@ -59,7 +59,7 @@\n module Mastodon\n   class Application < Rails::Application\n     # Initialize configuration defaults for originally generated Rails version.\n-    config.load_defaults 7.2\n+    config.load_defaults 8.0\n \n     # Please, add to the `ignore` list any other `lib` subdirectories that do\n     # not contain `.rb` files, or that should not be reloaded or eager loaded.\n---\nconfig/initializers/filter_parameter_logging.rb\n@@ -6,5 +6,5 @@\n # Use this to limit dissemination of sensitive information.\n # See the ActiveSupport::ParameterFilter documentation for supported notations and behaviors.\n Rails.application.config.filter_parameters += [\n-  :passw, :email, :secret, :token, :_key, :crypt, :salt, :certificate, :otp, :ssn\n+  :passw, :email, :secret, :token, :_key, :crypt, :salt, :certificate, :otp, :ssn, :cvv, :cvc\n ]\n---\nlib/active_record/batches.rb\n@@ -13,7 +13,9 @@ def pluck_each(*column_names)\n \n       column_names.unshift(primary_key)\n \n-      relation = relation.reorder(build_batch_orders(order).to_h).limit(batch_limit)\n+      cursor = Array(primary_key)\n+\n+      relation = relation.reorder(build_batch_orders(cursor, order).to_h).limit(batch_limit)\n       relation.skip_query_cache!\n \n       batch_relation = relation\n---\nspec/rails_helper.rb\n@@ -119,6 +119,11 @@ def sign_in(resource, _deprecated = nil, scope: nil)\n   config.include CommandLineHelpers, type: :cli\n   config.include SystemHelpers, type: :system\n \n+  # TODO: Remove when Devise fixes https://github.com/heartcombo/devise/issues/5705\n+  config.before do\n+    Rails.application.reload_routes_unless_loaded\n+  end\n+\n   config.around(:each, use_transactional_tests: false) do |example|\n     self.use_transactional_tests = false\n     example.run\n---\n\n\n---\n\nChoice C:\nlib/mastodon/cli/media.rb\n@@ -128,7 +128,7 @@ def remove_orphans\n \n             model_name      = path_segments.first.classify\n             attachment_name = path_segments[1].singularize\n-            record_id       = path_segments[2..-2].join.to_i\n+            record_id       = path_segments[2...-2].join.to_i\n             file_name       = path_segments.last\n             record          = record_map.dig(model_name, record_id)\n             attachment      = record&.public_send(attachment_name)\n@@ -172,7 +172,7 @@ def remove_orphans\n           end\n \n           model_name      = path_segments.first.classify\n-          record_id       = path_segments[2..-2].join.to_i\n+          record_id       = path_segments[2...-2].join.to_i\n           attachment_name = path_segments[1].singularize\n           file_name       = path_segments.last\n \n@@ -297,7 +297,7 @@ def lookup(url)\n       fail_with_message 'Not a media URL' unless VALID_PATH_SEGMENTS_SIZE.include?(path_segments.size)\n \n       model_name = path_segments.first.classify\n-      record_id  = path_segments[2..-2].join.to_i\n+      record_id  = path_segments[2...-2].join.to_i\n \n       fail_with_message \"Cannot find corresponding model: #{model_name}\" unless PRELOAD_MODEL_WHITELIST.include?(model_name)\n \n@@ -353,7 +353,7 @@ def preload_records_from_mixed_objects(objects)\n         next unless VALID_PATH_SEGMENTS_SIZE.include?(segments.size)\n \n         model_name = segments.first.classify\n-        record_id  = segments[2..-2].join.to_i\n+        record_id  = segments[2...-2].join.to_i\n \n         next unless PRELOAD_MODEL_WHITELIST.include?(model_name)\n \n---\n\n\n---\n\nChoice D:\napp/models/account.rb\n@@ -127,7 +127,7 @@ class Account < ApplicationRecord\n   scope :searchable, -> { without_unapproved.without_suspended.where(moved_to_account_id: nil) }\n   scope :discoverable, -> { searchable.without_silenced.where(discoverable: true).joins(:account_stat) }\n   scope :followable_by, ->(account) { joins(arel_table.join(Follow.arel_table, Arel::Nodes::OuterJoin).on(arel_table[:id].eq(Follow.arel_table[:target_account_id]).and(Follow.arel_table[:account_id].eq(account.id))).join_sources).where(Follow.arel_table[:id].eq(nil)).joins(arel_table.join(FollowRequest.arel_table, Arel::Nodes::OuterJoin).on(arel_table[:id].eq(FollowRequest.arel_table[:target_account_id]).and(FollowRequest.arel_table[:account_id].eq(account.id))).join_sources).where(FollowRequest.arel_table[:id].eq(nil)) }\n-  scope :by_recent_status, -> { order(Arel.sql('account_stats.last_status_at DESC NULLS LAST')) }\n+  scope :by_recent_status, -> { includes(:account_stat).merge(AccountStat.order('last_status_at DESC NULLS LAST')).references(:account_stat) }\n   scope :by_recent_sign_in, -> { order(Arel.sql('users.current_sign_in_at DESC NULLS LAST')) }\n   scope :popular, -> { order('account_stats.followers_count desc') }\n   scope :by_domain_and_subdomains, ->(domain) { where(domain: Instance.by_domain_and_subdomains(domain).select(:domain)) }\n---\napp/models/relationship_filter.rb\n@@ -114,7 +114,7 @@ def order_scope(value)\n   def activity_scope(value)\n     case value\n     when 'dormant'\n-      AccountStat.where(last_status_at: nil).or(AccountStat.where(AccountStat.arel_table[:last_status_at].lt(1.month.ago)))\n+      Account.joins(:account_stat).where(account_stat: { last_status_at: [nil, ...1.month.ago] })\n     else\n       raise Mastodon::InvalidParameterError, \"Unknown activity: #{value}\"\n     end\n---\nspec/models/relationship_filter_spec.rb\n@@ -6,32 +6,60 @@\n   let(:account) { Fabricate(:account) }\n \n   describe '#results' do\n-    context 'when default params are used' do\n-      subject do\n-        described_class.new(account, 'order' => 'active').results\n-      end\n+    let(:account_of_7_months) { Fabricate(:account_stat, statuses_count: 1, last_status_at: 7.months.ago).account }\n+    let(:account_of_1_day)    { Fabricate(:account_stat, statuses_count: 1, last_status_at: 1.day.ago).account }\n+    let(:account_of_3_days)   { Fabricate(:account_stat, statuses_count: 1, last_status_at: 3.days.ago).account }\n+    let(:silent_account)      { Fabricate(:account_stat, statuses_count: 0, last_status_at: nil).account }\n+\n+    before do\n+      account.follow!(account_of_7_months)\n+      account.follow!(account_of_1_day)\n+      account.follow!(account_of_3_days)\n+      account.follow!(silent_account)\n+    end\n \n-      before do\n-        add_following_account_with(last_status_at: 7.days.ago)\n-        add_following_account_with(last_status_at: 1.day.ago)\n-        add_following_account_with(last_status_at: 3.days.ago)\n+    context 'when ordering by last activity' do\n+      context 'when not filtering' do\n+        subject do\n+          described_class.new(account, 'order' => 'active').results\n+        end\n+\n+        it 'returns followings ordered by last activity' do\n+          expect(subject).to eq [account_of_1_day, account_of_3_days, account_of_7_months, silent_account]\n+        end\n       end\n \n-      it 'returns followings ordered by last activity' do\n-        expected_result = account.following.eager_load(:account_stat).reorder(nil).by_recent_status\n+      context 'when filtering for dormant accounts' do\n+        subject do\n+          described_class.new(account, 'order' => 'active', 'activity' => 'dormant').results\n+        end\n \n-        expect(subject).to eq expected_result\n+        it 'returns dormant followings ordered by last activity' do\n+          expect(subject).to eq [account_of_7_months, silent_account]\n+        end\n       end\n     end\n-  end\n \n-  def add_following_account_with(last_status_at:)\n-    following_account = Fabricate(:account)\n-    Fabricate(:account_stat, account: following_account,\n-                             last_status_at: last_status_at,\n-                             statuses_count: 1,\n-                             following_count: 0,\n-                             followers_count: 0)\n-    Fabricate(:follow, account: account, target_account: following_account).account\n+    context 'when ordering by account creation' do\n+      context 'when not filtering' do\n+        subject do\n+          described_class.new(account, 'order' => 'recent').results\n+        end\n+\n+        it 'returns followings ordered by last account creation' do\n+          expect(subject).to eq [silent_account, account_of_3_days, account_of_1_day, account_of_7_months]\n+        end\n+      end\n+\n+      context 'when filtering for dormant accounts' do\n+        subject do\n+          described_class.new(account, 'order' => 'recent', 'activity' => 'dormant').results\n+        end\n+\n+        it 'returns dormant followings ordered by last activity' do\n+          expect(subject).to eq [silent_account, account_of_7_months]\n+        end\n+      end\n+    end\n   end\n end\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nFixes #32870\r\n\r\nFixes a significant regression from #32778\n\n---\n\nChoice A:\napp/lib/search_query_parser.rb\n@@ -8,7 +8,7 @@ class SearchQueryParser < Parslet::Parser\n   rule(:operator)  { (str('+') | str('-')).as(:operator) }\n   rule(:prefix)    { term >> colon }\n   rule(:shortcode) { (colon >> term >> colon.maybe).as(:shortcode) }\n-  rule(:phrase)    { (quote >> (term >> space.maybe).repeat >> quote).as(:phrase) }\n+  rule(:phrase)    { (quote >> (match('[^\\s\"]').repeat(1).as(:term) >> space.maybe).repeat >> quote).as(:phrase) }\n   rule(:clause)    { (operator.maybe >> prefix.maybe.as(:prefix) >> (phrase | term | shortcode)).as(:clause) | prefix.as(:clause) | quote.as(:junk) }\n   rule(:query)     { (clause >> space.maybe).repeat.as(:query) }\n   root(:query)\n---\napp/lib/search_query_transformer.rb\n@@ -225,17 +225,16 @@ def language_code_from_term(term)\n   rule(clause: subtree(:clause)) do\n     prefix   = clause[:prefix][:term].to_s if clause[:prefix]\n     operator = clause[:operator]&.to_s\n+    term     = clause[:phrase] ? clause[:phrase].map { |term| term[:term].to_s }.join(' ') : clause[:term].to_s\n \n     if clause[:prefix] && SUPPORTED_PREFIXES.include?(prefix)\n-      PrefixClause.new(prefix, operator, clause[:term].to_s, current_account: current_account)\n+      PrefixClause.new(prefix, operator, term, current_account: current_account)\n     elsif clause[:prefix]\n-      TermClause.new(operator, \"#{prefix} #{clause[:term]}\")\n+      TermClause.new(operator, \"#{prefix} #{term}\")\n     elsif clause[:term]\n-      TermClause.new(operator, clause[:term].to_s)\n-    elsif clause[:shortcode]\n-      TermClause.new(operator, \":#{clause[:term]}:\")\n+      TermClause.new(operator, term)\n     elsif clause[:phrase]\n-      PhraseClause.new(operator, clause[:phrase].is_a?(Array) ? clause[:phrase].map { |p| p[:term].to_s }.join(' ') : clause[:phrase].to_s)\n+      PhraseClause.new(operator, term)\n     else\n       raise \"Unexpected clause type: #{clause}\"\n     end\n---\napp/services/statuses_search_service.rb\n@@ -8,6 +8,7 @@ def call(query, account = nil, options = {})\n     @limit   = options[:limit].to_i\n     @offset  = options[:offset].to_i\n \n+    convert_deprecated_options!\n     status_search_results\n   end\n \n@@ -28,4 +29,25 @@ def status_search_results\n   def parsed_query\n     SearchQueryTransformer.new.apply(SearchQueryParser.new.parse(@query), current_account: @account)\n   end\n+\n+  def convert_deprecated_options!\n+    syntax_options = []\n+\n+    if @options[:account_id]\n+      username = Account.select(:username, :domain).find(@options[:account_id]).acct\n+      syntax_options << \"from:@#{username}\"\n+    end\n+\n+    if @options[:min_id]\n+      timestamp = Mastodon::Snowflake.to_time(@options[:min_id])\n+      syntax_options << \"after:\\\"#{timestamp.iso8601}\\\"\"\n+    end\n+\n+    if @options[:max_id]\n+      timestamp = Mastodon::Snowflake.to_time(@options[:max_id])\n+      syntax_options << \"before:\\\"#{timestamp.iso8601}\\\"\"\n+    end\n+\n+    @query = \"#{@query} #{syntax_options.join(' ')}\".strip if syntax_options.any?\n+  end\n end\n---\nlib/mastodon/snowflake.rb\n@@ -104,6 +104,10 @@ def id_at(timestamp, with_random: true)\n       id\n     end\n \n+    def to_time(id)\n+      Time.at((id >> 16) / 1000).utc\n+    end\n+\n     private\n \n     def already_defined?\n---\nspec/lib/search_query_transformer_spec.rb\n@@ -57,4 +57,24 @@\n       expect(subject.send(:filter_clauses)).to be_empty\n     end\n   end\n+\n+  context 'with \\'\"hello world\"\\'' do\n+    let(:query) { '\"hello world\"' }\n+\n+    it 'transforms clauses' do\n+      expect(subject.send(:must_clauses).map(&:phrase)).to contain_exactly('hello world')\n+      expect(subject.send(:must_not_clauses)).to be_empty\n+      expect(subject.send(:filter_clauses)).to be_empty\n+    end\n+  end\n+\n+  context 'with \\'before:\"2022-01-01 23:00\"\\'' do\n+    let(:query) { 'before:\"2022-01-01 23:00\"' }\n+\n+    it 'transforms clauses' do\n+      expect(subject.send(:must_clauses)).to be_empty\n+      expect(subject.send(:must_not_clauses)).to be_empty\n+      expect(subject.send(:filter_clauses).map(&:term)).to contain_exactly(lt: '2022-01-01 23:00', time_zone: 'UTC')\n+    end\n+  end\n end\n---\n\n\n---\n\nChoice B:\napp/views/application/mailer/_hashtag.html.haml\n@@ -17,4 +17,4 @@\n                           %span.email-mini-hashtag-img-span\n                             = image_tag full_asset_url(account.avatar.url), alt: '', width: 16, height: 16\n                       %td\n-                        %p= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(hashtag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts), days: 2)\n+                        %p= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(hashtag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts))\n---\napp/views/user_mailer/welcome.text.erb\n@@ -53,7 +53,7 @@\n <%= t('user_mailer.welcome.hashtags_subtitle') %>\n \n <%- @tags.each do |tag| %>\n-* #<%= tag.display_name %> \u00b7 <%= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(tag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts), days: 2) %>\n+* #<%= tag.display_name %> \u00b7 <%= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(tag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts)) %>\n   <%= tag_url(tag) %>\n <%- end %>\n \n---\nconfig/locales/en.yml\n@@ -1868,7 +1868,9 @@ en:\n       follows_subtitle: Follow well-known accounts\n       follows_title: Who to follow\n       follows_view_more: View more people to follow\n-      hashtags_recent_count: \"%{people} people in the past %{days} days\"\n+      hashtags_recent_count:\n+        one: \"%{people} person in the past 2 days\"\n+        other: \"%{people} people in the past 2 days\"\n       hashtags_subtitle: Explore what\u2019s trending since past 2 days\n       hashtags_title: Trending hashtags\n       hashtags_view_more: View more trending hashtags\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/components/status.jsx\n@@ -397,6 +397,7 @@ class Status extends ImmutablePureComponent {\n     const connectUp = previousId && previousId === status.get('in_reply_to_id');\n     const connectToRoot = rootId && rootId === status.get('in_reply_to_id');\n     const connectReply = nextInReplyToId && nextInReplyToId === status.get('id');\n+    const matchedFilters = status.get('matched_filters');\n \n     if (featured) {\n       prepend = (\n@@ -432,7 +433,6 @@ class Status extends ImmutablePureComponent {\n       );\n     }\n \n-    const matchedFilters = status.get('matched_filters');\n     const expanded = (!matchedFilters || this.state.showDespiteFilter) && (!status.get('hidden') || status.get('spoiler_text').length === 0);\n \n     if (hidden) {\n---\n\n\n---\n\nChoice D:\nDockerfile\n@@ -247,7 +247,9 @@ RUN \\\n RUN \\\n # Pre-create and chown system volume to Mastodon user\n   mkdir -p /opt/mastodon/public/system; \\\n-  chown mastodon:mastodon /opt/mastodon/public/system;\n+  chown mastodon:mastodon /opt/mastodon/public/system; \\\n+# Set Mastodon user as owner of tmp folder\n+  chown -R mastodon:mastodon /opt/mastodon/tmp;\n \n # Set the running user for resulting container\n USER mastodon\n---\ndocker-compose.yml\n@@ -59,7 +59,7 @@ services:\n     image: ghcr.io/mastodon/mastodon:v4.2.0\n     restart: always\n     env_file: .env.production\n-    command: bash -c \"rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000\"\n+    command: bundle exec puma -C config/puma.rb\n     networks:\n       - external_network\n       - internal_network\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nFix #32731\n\n---\n\nChoice A:\napp/lib/link_details_extractor.rb\n@@ -156,11 +156,11 @@ def height\n   end\n \n   def title\n-    html_entities.decode(structured_data&.headline || opengraph_tag('og:title') || document.xpath('//title').map(&:content).first).strip\n+    html_entities_decode(structured_data&.headline || opengraph_tag('og:title') || document.xpath('//title').map(&:content).first).strip\n   end\n \n   def description\n-    html_entities.decode(structured_data&.description || opengraph_tag('og:description') || meta_tag('description'))\n+    html_entities_decode(structured_data&.description || opengraph_tag('og:description') || meta_tag('description'))\n   end\n \n   def published_at\n@@ -180,15 +180,15 @@ def canonical_url\n   end\n \n   def provider_name\n-    html_entities.decode(structured_data&.publisher_name || opengraph_tag('og:site_name'))\n+    html_entities_decode(structured_data&.publisher_name || opengraph_tag('og:site_name'))\n   end\n \n   def provider_url\n     valid_url_or_nil(host_to_url(opengraph_tag('og:site')))\n   end\n \n   def author_name\n-    html_entities.decode(structured_data&.author_name || opengraph_tag('og:author') || opengraph_tag('og:author:username'))\n+    html_entities_decode(structured_data&.author_name || opengraph_tag('og:author') || opengraph_tag('og:author:username'))\n   end\n \n   def author_url\n@@ -257,7 +257,7 @@ def structured_data\n \n       next if json_ld.blank?\n \n-      structured_data = StructuredData.new(html_entities.decode(json_ld))\n+      structured_data = StructuredData.new(html_entities_decode(json_ld))\n \n       next unless structured_data.valid?\n \n@@ -273,10 +273,11 @@ def document\n   end\n \n   def detect_encoding_and_parse_document\n-    [detect_encoding, nil, @html_charset, 'UTF-8'].uniq.each do |encoding|\n+    [detect_encoding, nil, @html_charset].uniq.each do |encoding|\n       document = Nokogiri::HTML(@html, nil, encoding)\n       return document if document.to_s.valid_encoding?\n     end\n+    Nokogiri::HTML(@html, nil, 'UTF-8')\n   end\n \n   def detect_encoding\n@@ -290,6 +291,15 @@ def detector\n     end\n   end\n \n+  def html_entities_decode(string)\n+    return if string.nil?\n+\n+    unicode_string = string.encode('UTF-8')\n+    raise EncodingError, 'cannot convert string to valid UTF-8' unless unicode_string.valid_encoding?\n+\n+    html_entities.decode(unicode_string)\n+  end\n+\n   def html_entities\n     @html_entities ||= HTMLEntities.new(:expanded)\n   end\n---\napp/services/fetch_link_card_service.rb\n@@ -32,7 +32,7 @@ def call(status)\n     end\n \n     attach_card if @card&.persisted?\n-  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError, Encoding::UndefinedConversionError => e\n+  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError, EncodingError => e\n     Rails.logger.debug { \"Error fetching link #{@original_url}: #{e}\" }\n     nil\n   end\n---\nspec/fixtures/requests/latin1_posing_as_utf8_broken.txt\n@@ -0,0 +1,17 @@\n+HTTP/1.1 200 OK\n+server: nginx\n+date: Thu, 13 Jun 2024 14:33:13 GMT\n+content-type: text/html; charset=utf-8\n+content-length: 158\n+accept-ranges: bytes\n+\n+<!doctype html>\n+<html lang=\"en\">\n+<head>\n+  <meta charset=\"UTF-8\">\n+  <title>Tofu \ufffd l'orange</title>\n+</head>\n+<body>\n+  <h2>Tofu \ufffd l'orange</h2>\n+</body>\n+</html>\n---\nspec/fixtures/requests/latin1_posing_as_utf8_recoverable.txt\n@@ -0,0 +1,17 @@\n+HTTP/1.1 200 OK\n+server: nginx\n+date: Thu, 13 Jun 2024 14:33:13 GMT\n+content-type: text/html; charset=utf-8\n+content-length: 158\n+accept-ranges: bytes\n+\n+<!doctype html>\n+<html lang=\"en\">\n+<head>\n+  <meta charset=\"UTF-8\">\n+  <title>Tofu with orange sauce</title>\n+</head>\n+<body>\n+  <h2>Tofu \ufffd l'orange</h2>\n+</body>\n+</html>\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -27,6 +27,8 @@\n     stub_request(:get, 'http://example.com/koi8-r').to_return(request_fixture('koi8-r.txt'))\n     stub_request(:get, 'http://example.com/windows-1251').to_return(request_fixture('windows-1251.txt'))\n     stub_request(:get, 'http://example.com/low_confidence_latin1').to_return(request_fixture('low_confidence_latin1.txt'))\n+    stub_request(:get, 'http://example.com/latin1_posing_as_utf8_broken').to_return(request_fixture('latin1_posing_as_utf8_broken.txt'))\n+    stub_request(:get, 'http://example.com/latin1_posing_as_utf8_recoverable').to_return(request_fixture('latin1_posing_as_utf8_recoverable.txt'))\n     stub_request(:get, 'http://example.com/aergerliche-umlaute').to_return(request_fixture('redirect_with_utf8_url.txt'))\n \n     Rails.cache.write('oembed_endpoint:example.com', oembed_cache) if oembed_cache\n@@ -159,10 +161,30 @@\n     end\n \n     context 'with a URL of a page in ISO-8859-1 encoding, that charlock_holmes cannot detect' do\n-      let(:status) { Fabricate(:status, text: 'Check out http://example.com/low_confidence_latin1') }\n+      context 'when encoding in http header is correct' do\n+        let(:status) { Fabricate(:status, text: 'Check out http://example.com/low_confidence_latin1') }\n \n-      it 'decodes the HTML' do\n-        expect(status.preview_card.title).to eq(\"Tofu \u00e1 l'orange\")\n+        it 'decodes the HTML' do\n+          expect(status.preview_card.title).to eq(\"Tofu \u00e1 l'orange\")\n+        end\n+      end\n+\n+      context 'when encoding in http header is incorrect' do\n+        context 'when encoding problems appear in unrelated tags' do\n+          let(:status) { Fabricate(:status, text: 'Check out http://example.com/latin1_posing_as_utf8_recoverable') }\n+\n+          it 'decodes the HTML' do\n+            expect(status.preview_card.title).to eq('Tofu with orange sauce')\n+          end\n+        end\n+\n+        context 'when encoding problems appear in title tag' do\n+          let(:status) { Fabricate(:status, text: 'Check out http://example.com/latin1_posing_as_utf8_broken') }\n+\n+          it 'does not create a preview card' do\n+            expect(status.preview_card).to be_nil\n+          end\n+        end\n       end\n     end\n \n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -4,8 +4,6 @@ import { Children, cloneElement, useCallback } from 'react';\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import ImmutablePureComponent from 'react-immutable-pure-component';\n \n-import { supportsPassiveEvents } from 'detect-passive-events';\n-\n import { scrollRight } from '../../../scroll';\n import BundleContainer from '../containers/bundle_container';\n import {\n@@ -71,10 +69,6 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   };\n \n   componentDidMount() {\n-    if (!this.props.singleColumn) {\n-      this.node.addEventListener('wheel', this.handleWheel, supportsPassiveEvents ? { passive: true } : false);\n-    }\n-\n     if (this.mediaQuery) {\n       if (this.mediaQuery.addEventListener) {\n         this.mediaQuery.addEventListener('change', this.handleLayoutChange);\n@@ -87,23 +81,7 @@ export default class ColumnsArea extends ImmutablePureComponent {\n     this.isRtlLayout = document.getElementsByTagName('body')[0].classList.contains('rtl');\n   }\n \n-  UNSAFE_componentWillUpdate(nextProps) {\n-    if (this.props.singleColumn !== nextProps.singleColumn && nextProps.singleColumn) {\n-      this.node.removeEventListener('wheel', this.handleWheel);\n-    }\n-  }\n-\n-  componentDidUpdate(prevProps) {\n-    if (this.props.singleColumn !== prevProps.singleColumn && !this.props.singleColumn) {\n-      this.node.addEventListener('wheel', this.handleWheel, supportsPassiveEvents ? { passive: true } : false);\n-    }\n-  }\n-\n   componentWillUnmount () {\n-    if (!this.props.singleColumn) {\n-      this.node.removeEventListener('wheel', this.handleWheel);\n-    }\n-\n     if (this.mediaQuery) {\n       if (this.mediaQuery.removeEventListener) {\n         this.mediaQuery.removeEventListener('change', this.handleLayoutChange);\n@@ -116,22 +94,14 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   handleChildrenContentChange() {\n     if (!this.props.singleColumn) {\n       const modifier = this.isRtlLayout ? -1 : 1;\n-      this._interruptScrollAnimation = scrollRight(this.node, (this.node.scrollWidth - window.innerWidth) * modifier);\n+      scrollRight(this.node, (this.node.scrollWidth - window.innerWidth) * modifier);\n     }\n   }\n \n   handleLayoutChange = (e) => {\n     this.setState({ renderComposePanel: !e.matches });\n   };\n \n-  handleWheel = () => {\n-    if (typeof this._interruptScrollAnimation !== 'function') {\n-      return;\n-    }\n-\n-    this._interruptScrollAnimation();\n-  };\n-\n   setRef = (node) => {\n     this.node = node;\n   };\n---\napp/javascript/mastodon/scroll.ts\n@@ -38,13 +38,20 @@ const scroll = (\n const isScrollBehaviorSupported =\n   'scrollBehavior' in document.documentElement.style;\n \n-export const scrollRight = (node: Element, position: number) => {\n-  if (isScrollBehaviorSupported)\n-    node.scrollTo({ left: position, behavior: 'smooth' });\n-  else scroll(node, 'scrollLeft', position);\n-};\n-\n-export const scrollTop = (node: Element) => {\n-  if (isScrollBehaviorSupported) node.scrollTo({ top: 0, behavior: 'smooth' });\n-  else scroll(node, 'scrollTop', 0);\n-};\n+export const scrollRight = (node: Element, position: number) =>\n+  requestIdleCallback(() => {\n+    if (isScrollBehaviorSupported) {\n+      node.scrollTo({ left: position, behavior: 'smooth' });\n+    } else {\n+      scroll(node, 'scrollLeft', position);\n+    }\n+  });\n+\n+export const scrollTop = (node: Element) =>\n+  requestIdleCallback(() => {\n+    if (isScrollBehaviorSupported) {\n+      node.scrollTo({ top: 0, behavior: 'smooth' });\n+    } else {\n+      scroll(node, 'scrollTop', 0);\n+    }\n+  });\n---\napp/javascript/mastodon/test_helpers.tsx\n@@ -8,6 +8,14 @@ import { render as rtlRender } from '@testing-library/react';\n \n import { IdentityContext } from './identity_context';\n \n+beforeEach(() => {\n+  global.requestIdleCallback = jest\n+    .fn()\n+    .mockImplementation((fn: () => void) => {\n+      fn();\n+    });\n+});\n+\n function render(\n   ui: React.ReactElement,\n   {\n---\n\n\n---\n\nChoice C:\ndocs/Using-Mastodon/List-of-Mastodon-instances.md\n@@ -65,7 +65,7 @@ There is also a list at [instances.mastodon.xyz](https://instances.mastodon.xyz)\n | [off-the-clock.us](https://off-the-clock.us/)|The work day is over.|Yes|No|\n | [infinimatix.net](https://infinimatix.net)|Informatics|Yes|Yes|\n | [social.0day.agency](https://social.0day.agency)|Infosec, Hacking, Fun (only protonmail)|Yes|Yes|\n-| [kagrumez.lerk.io](https://kagrumez.lerk.io)|Open registration. German end english.|Yes|No|\n+| [social.k40s.net](https://social.k40s.net)|Open registration. German end english.|Yes|No|\n | [meow.social](https://meow.social)|A furry fandom focused instance|Yes|No|\n | [neumastodon.com](https://neumastodon.com/)|Northeastern University Mastodon |Yes|No|\n | [dancingbanana.party](https://dancingbanana.party)|La banane qui danse.|Yes|No|\n---\napp/lib/status_finder.rb\n@@ -10,6 +10,8 @@ def initialize(url)\n   def status\n     verify_action!\n \n+    raise ActiveRecord::RecordNotFound unless TagManager.instance.local_url?(url)\n+\n     case recognized_params[:controller]\n     when 'stream_entries'\n       StreamEntry.find(recognized_params[:id]).status\n---\nspec/controllers/api/oembed_controller_spec.rb\n@@ -8,6 +8,7 @@\n \n   describe 'GET #show' do\n     before do\n+      request.host = Rails.configuration.x.local_domain\n       get :show, params: { url: account_stream_entry_url(alice, status.stream_entry) }, format: :json\n     end\n \n---\nspec/lib/status_finder_spec.rb\n@@ -34,6 +34,16 @@\n       end\n     end\n \n+    context 'with a remote url even if id exists on local' do\n+      let(:status) { Fabricate(:status) }\n+      let(:url) { \"https://example.com/users/test/statuses/#{status.id}\" }\n+      subject { described_class.new(url) }\n+\n+      it 'raises an error' do\n+        expect { subject.status }.to raise_error(ActiveRecord::RecordNotFound)\n+      end\n+    end\n+\n     context 'with a plausible url' do\n       let(:url) { 'https://example.com/users/test/updates/123/embed' }\n       subject { described_class.new(url) }\n---\n\n\n---\n\nChoice D:\nspec/lib/search_query_transformer_spec.rb\n@@ -16,6 +16,7 @@\n       ['\"2022-01-01\"', '2022-01-01'],\n       ['12345678', '12345678'],\n       ['\"12345678\"', '12345678'],\n+      ['\"2024-10-31T23:47:20Z\"', '2024-10-31T23:47:20Z'],\n     ].each do |value, parsed|\n       context \"with #{operator}:#{value}\" do\n         let(:query) { \"#{operator}:#{value}\" }\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nFix #32815\n\n---\n\nChoice A:\napp/javascript/mastodon/features/compose/components/compose_form.jsx\n@@ -216,7 +216,7 @@ class ComposeForm extends ImmutablePureComponent {\n \n   handleEmojiPick = (data) => {\n     const { text }     = this.props;\n-    const position     = this.textarea.selectionStart;\n+    const position     = this.textareaRef.current.selectionStart;\n     const needsSpace   = data.custom && position > 0 && !allowedAroundShortCode.includes(text[position - 1]);\n \n     this.props.onPickEmoji(position, data, needsSpace);\n---\n\n\n---\n\nChoice B:\napp/models/trends/statuses.rb\n@@ -106,7 +106,7 @@ def klass\n   private\n \n   def eligible?(status)\n-    status.public_visibility? && status.account.discoverable? && !status.account.silenced? && !status.account.sensitized? && status.spoiler_text.blank? && !status.sensitive? && !status.reply? && valid_locale?(status.language)\n+    status.created_at.past? && status.public_visibility? && status.account.discoverable? && !status.account.silenced? && !status.account.sensitized? && status.spoiler_text.blank? && !status.sensitive? && !status.reply? && valid_locale?(status.language)\n   end\n \n   def calculate_scores(statuses, at_time)\n---\n\n\n---\n\nChoice C:\napp/lib/link_details_extractor.rb\n@@ -36,7 +36,8 @@ def description\n     end\n \n     def language\n-      json['inLanguage']\n+      lang = json['inLanguage']\n+      lang.is_a?(Hash) ? (lang['alternateName'] || lang['name']) : lang\n     end\n \n     def type\n---\nspec/lib/link_details_extractor_spec.rb\n@@ -82,6 +82,10 @@\n           'name' => 'Pet News',\n           'url' => 'https://example.com',\n         },\n+        'inLanguage' => {\n+          name: 'English',\n+          alternateName: 'en',\n+        },\n       }.to_json\n     end\n \n@@ -115,6 +119,12 @@\n           expect(subject.provider_name).to eq 'Pet News'\n         end\n       end\n+\n+      describe '#language' do\n+        it 'returns the language from structured data' do\n+          expect(subject.language).to eq 'en'\n+        end\n+      end\n     end\n \n     context 'when is wrapped in CDATA tags' do\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/actions/settings.js\n@@ -20,7 +20,7 @@ export function changeSetting(path, value) {\n }\n \n const debouncedSave = debounce((dispatch, getState) => {\n-  if (getState().getIn(['settings', 'saved'])) {\n+  if (getState().getIn(['settings', 'saved']) || !getState().getIn(['meta', 'me'])) {\n     return;\n   }\n \n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nContext: https://github.com/mastodon/mastodon/pull/24443#issuecomment-2341283865\r\n\r\nIn linked PR, this attribute was added to the presenter, but not the serializer. This assumes it was intended to be in the response. If that's not the case (question did not receive a reply), I can update this to be a removal from the presenter instead (this is the only place it would be used, pretty sure).\r\n\r\nAdded coverage for already-present `name` value as well.\r\n\r\nNot sure if this is technically a bug fix or an addition.\n\n---\n\nChoice A:\napp/helpers/languages_helper.rb\n@@ -254,6 +254,7 @@ def standard_locale_name(locale)\n \n   def valid_locale_or_nil(str)\n     return if str.blank?\n+    return str if valid_locale?(str)\n \n     code, = str.to_s.split(/[_-]/) # Strip out the region from e.g. en_US or ja-JP\n \n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -2732,22 +2732,16 @@ $ui-header-height: 55px;\n     &__description {\n       flex: 1 1 auto;\n       line-height: 20px;\n-      white-space: nowrap;\n-      text-overflow: ellipsis;\n-      overflow: hidden;\n \n       h6 {\n         color: $highlight-text-color;\n         font-weight: 500;\n         font-size: 14px;\n-        overflow: hidden;\n-        text-overflow: ellipsis;\n       }\n \n       p {\n         color: $darker-text-color;\n         overflow: hidden;\n-        text-overflow: ellipsis;\n       }\n     }\n   }\n---\n\n\n---\n\nChoice C:\napp/presenters/language_presenter.rb\n@@ -1,7 +1,7 @@\n # frozen_string_literal: true\n \n class LanguagePresenter < ActiveModelSerializers::Model\n-  attributes :code, :name, :native_name\n+  attributes :code, :name\n \n   def initialize(code)\n     super()\n@@ -13,8 +13,4 @@ def initialize(code)\n   def name\n     @item[0]\n   end\n-\n-  def native_name\n-    @item[1]\n-  end\n end\n---\nspec/requests/api/v1/instances/languages_spec.rb\n@@ -9,10 +9,21 @@\n     end\n \n     it 'returns http success and includes supported languages' do\n-      expect(response).to have_http_status(200)\n+      expect(response)\n+        .to have_http_status(200)\n       expect(response.content_type)\n         .to start_with('application/json')\n-      expect(response.parsed_body.pluck(:code)).to match_array LanguagesHelper::SUPPORTED_LOCALES.keys.map(&:to_s)\n+      expect(response.parsed_body)\n+        .to match_array(supported_locale_expectations)\n+    end\n+\n+    def supported_locale_expectations\n+      LanguagesHelper::SUPPORTED_LOCALES.map do |key, values|\n+        include(\n+          code: key.to_s,\n+          name: values.first\n+        )\n+      end\n     end\n   end\n end\n---\n\n\n---\n\nChoice D:\nconfig/initializers/twitter_regex.rb\n@@ -9,7 +9,7 @@ def emoji_parsing_enabled\n \n   class Regex\n     REGEXEN[:valid_general_url_path_chars] = /[^\\p{White_Space}<>()?]/iou\n-    REGEXEN[:valid_url_path_ending_chars] = /[^\\p{White_Space}()?!*\"'\u300c\u300d<>;:=,.$%\\[\\]~&|@]|(?:#{REGEXEN[:valid_url_balanced_parens]})/iou\n+    REGEXEN[:valid_url_path_ending_chars] = /[^\\p{White_Space}()?!*\"'\u300c\u300d<>;:=,.$%\\[\\]~&|]|(?:#{REGEXEN[:valid_url_balanced_parens]})/iou\n     REGEXEN[:valid_url_balanced_parens] = /\n       \\(\n         (?:\n---\nspec/lib/text_formatter_spec.rb\n@@ -224,6 +224,14 @@\n       end\n     end\n \n+    context 'when given a URL with trailing @ symbol' do\n+      let(:text) { 'https://gta.fandom.com/wiki/TW@ Content' }\n+\n+      it 'matches the full URL' do\n+        expect(subject).to include 'href=\"https://gta.fandom.com/wiki/TW@\"'\n+      end\n+    end\n+\n     context 'when given a URL containing unsafe code (XSS attack, visible part)' do\n       let(:text) { 'http://example.com/b<del>b</del>' }\n \n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. setup a test rig for mastodony\n2. configure `/etc/redis/users.acl` for redisy with the default user off, in `.env.production` set `REDIS_USER` and `REDIS_PASSWORD`\n3. restart all mastodony processes then the streaming api fails to connect to redis while sidekiqy succeeds\n4. switch to `REDIS_URL`, restart the processes, everything works ok\n\n### Expected behaviour\n\nno error\n\n### Actual behaviour\n\nthe streaming service fails to connect to redis while sidekiqy succeeds\n\n### Detailed description\n\nthe error spit by the streaming service:\n\n```\nOct 14 19:07:49 mastt node[1400]: {\"level\":\"error\",\"time\":1728900469085,\"pid\":1400,\"hostname\":\"mastt\",\"name\":\"streaming\",\"err\":{\"type\":\"ReplyError\",\"message\":\"WRONGPASS invalid username-password pair or user is disabled.\",\"stack\":\"ReplyError: WRONGPASS invalid username-password pair or user is disabled.\\n    at parseError (/home/mastodon/live/node_modules/redis-parser/lib/parser.js:179:12)\\n    at parseType (/home/mastodon/live/node_modules/redis-parser/lib/parser.js:302:14)\",\"command\":{\"name\":\"auth\",\"args\":[\"mastodon\"]}},\"msg\":\"Redis Client Error!\"}\n```\n\n`/etc/redis/users.acl`\n\n```\nuser default off\nuser mastodon on ~* &* +@all >mastodon\n```\n\n`.env.production`\n\n```\n# this doesn't work for streaming but works for sidekiq\n#REDIS_HOST=localhost\n#REDIS_PORT=6379\n#REDIS_USER=mastodon\n#REDIS_PASSWORD=mastodon\n# this works for everyone\nREDIS_URL=redis://mastodon:mastodon@localhost:6379/0\n```\n\nI suspect this is related to #32265 ... at least in part.\n\nAlso, if I turn on the redis default user, the streaming service will say `[WARN] This Redis server's `default` user does not require a password, but a password was supplied`, but it will work fine.\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\nv4.3.0\n\n### Technical details\n\nIf this is happening on your own Mastodon server, please fill out those:\n- Ruby version: 3.3.5 (2024-09-03 revision ef084cc8f4) [x86_64-linux]\n- Node.js version: v20.17.0\n\n\n---\n\nChoice A:\napp/javascript/mastodon/api_types/accounts.ts\n@@ -13,7 +13,7 @@ export interface ApiAccountRoleJSON {\n }\n \n // See app/serializers/rest/account_serializer.rb\n-export interface ApiAccountJSON {\n+export interface BaseApiAccountJSON {\n   acct: string;\n   avatar: string;\n   avatar_static: string;\n@@ -45,3 +45,12 @@ export interface ApiAccountJSON {\n   memorial?: boolean;\n   hide_collections: boolean;\n }\n+\n+// See app/serializers/rest/muted_account_serializer.rb\n+export interface ApiMutedAccountJSON extends BaseApiAccountJSON {\n+  mute_expires_at?: string | null;\n+}\n+\n+// For now, we have the same type representing both `Account` and `MutedAccount`\n+// objects, but we should refactor this in the future.\n+export type ApiAccountJSON = ApiMutedAccountJSON;\n---\napp/javascript/mastodon/models/account.ts\n@@ -95,6 +95,9 @@ export const accountDefaultValues: AccountShape = {\n   limited: false,\n   moved: null,\n   hide_collections: false,\n+  // This comes from `ApiMutedAccountJSON`, but we should eventually\n+  // store that in a different object.\n+  mute_expires_at: null,\n };\n \n const AccountFactory = ImmutableRecord<AccountShape>(accountDefaultValues);\n---\n\n\n---\n\nChoice B:\nlib/mastodon/cli/media.rb\n@@ -128,7 +128,7 @@ def remove_orphans\n \n             model_name      = path_segments.first.classify\n             attachment_name = path_segments[1].singularize\n-            record_id       = path_segments[2..-2].join.to_i\n+            record_id       = path_segments[2...-2].join.to_i\n             file_name       = path_segments.last\n             record          = record_map.dig(model_name, record_id)\n             attachment      = record&.public_send(attachment_name)\n@@ -172,7 +172,7 @@ def remove_orphans\n           end\n \n           model_name      = path_segments.first.classify\n-          record_id       = path_segments[2..-2].join.to_i\n+          record_id       = path_segments[2...-2].join.to_i\n           attachment_name = path_segments[1].singularize\n           file_name       = path_segments.last\n \n@@ -297,7 +297,7 @@ def lookup(url)\n       fail_with_message 'Not a media URL' unless VALID_PATH_SEGMENTS_SIZE.include?(path_segments.size)\n \n       model_name = path_segments.first.classify\n-      record_id  = path_segments[2..-2].join.to_i\n+      record_id  = path_segments[2...-2].join.to_i\n \n       fail_with_message \"Cannot find corresponding model: #{model_name}\" unless PRELOAD_MODEL_WHITELIST.include?(model_name)\n \n@@ -353,7 +353,7 @@ def preload_records_from_mixed_objects(objects)\n         next unless VALID_PATH_SEGMENTS_SIZE.include?(segments.size)\n \n         model_name = segments.first.classify\n-        record_id  = segments[2..-2].join.to_i\n+        record_id  = segments[2...-2].join.to_i\n \n         next unless PRELOAD_MODEL_WHITELIST.include?(model_name)\n \n---\n\n\n---\n\nChoice C:\napp/models/web/push_subscription.rb\n@@ -21,7 +21,7 @@ class Web::PushSubscription < ApplicationRecord\n \n   has_one :session_activation, foreign_key: 'web_push_subscription_id', inverse_of: :web_push_subscription, dependent: nil\n \n-  validates :endpoint, presence: true\n+  validates :endpoint, presence: true, url: true\n   validates :key_p256dh, presence: true\n   validates :key_auth, presence: true\n \n---\nspec/requests/api/v1/push/subscriptions_spec.rb\n@@ -4,10 +4,11 @@\n \n describe 'API V1 Push Subscriptions' do\n   let(:user) { Fabricate(:user) }\n+  let(:endpoint) { 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX' }\n   let(:create_payload) do\n     {\n       subscription: {\n-        endpoint: 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX',\n+        endpoint: endpoint,\n         keys: {\n           p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n           auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n@@ -63,6 +64,18 @@\n       expect(endpoint_push_subscriptions.count)\n         .to eq(1)\n     end\n+\n+    context 'with invalid endpoint URL' do\n+      let(:endpoint) { 'app://example.foo' }\n+\n+      it 'returns a validation error' do\n+        subject\n+\n+        expect(response).to have_http_status(422)\n+        expect(endpoint_push_subscriptions.count).to eq(0)\n+        expect(endpoint_push_subscription).to be_nil\n+      end\n+    end\n   end\n \n   describe 'PUT /api/v1/push/subscription' do\n---\napp/models/web/push_subscription.rb\n@@ -25,6 +25,8 @@ class Web::PushSubscription < ApplicationRecord\n   validates :key_p256dh, presence: true\n   validates :key_auth, presence: true\n \n+  validates_with WebPushKeyValidator\n+\n   delegate :locale, to: :associated_user\n \n   def encrypt(payload)\n---\napp/validators/web_push_key_validator.rb\n@@ -0,0 +1,11 @@\n+# frozen_string_literal: true\n+\n+class WebPushKeyValidator < ActiveModel::Validator\n+  def validate(subscription)\n+    begin\n+      Webpush::Encryption.encrypt('validation_test', subscription.key_p256dh, subscription.key_auth)\n+    rescue ArgumentError, OpenSSL::PKey::EC::Point::Error\n+      subscription.errors.add(:base, I18n.t('crypto.errors.invalid_key'))\n+    end\n+  end\n+end\n---\nspec/fabricators/web_push_subscription_fabricator.rb\n@@ -2,6 +2,10 @@\n \n Fabricator(:web_push_subscription, from: Web::PushSubscription) do\n   endpoint   Faker::Internet.url\n-  key_p256dh Faker::Internet.password\n-  key_auth   Faker::Internet.password\n+  key_p256dh do\n+    curve = OpenSSL::PKey::EC.generate('prime256v1')\n+    ecdh_key = curve.public_key.to_bn.to_s(2)\n+    Base64.urlsafe_encode64(ecdh_key)\n+  end\n+  key_auth { Base64.urlsafe_encode64(Random.new.bytes(16)) }\n end\n---\nspec/requests/api/v1/push/subscriptions_spec.rb\n@@ -5,14 +5,17 @@\n describe 'API V1 Push Subscriptions' do\n   let(:user) { Fabricate(:user) }\n   let(:endpoint) { 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX' }\n+  let(:keys) do\n+    {\n+      p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n+      auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+    }\n+  end\n   let(:create_payload) do\n     {\n       subscription: {\n         endpoint: endpoint,\n-        keys: {\n-          p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n-          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n-        },\n+        keys: keys,\n       },\n     }.with_indifferent_access\n   end\n@@ -37,6 +40,16 @@\n   let(:token) { Fabricate(:accessible_access_token, resource_owner_id: user.id, scopes: scopes) }\n   let(:headers) { { 'Authorization' => \"Bearer #{token.token}\" } }\n \n+  shared_examples 'validation error' do\n+    it 'returns a validation error' do\n+      subject\n+\n+      expect(response).to have_http_status(422)\n+      expect(endpoint_push_subscriptions.count).to eq(0)\n+      expect(endpoint_push_subscription).to be_nil\n+    end\n+  end\n+\n   describe 'POST /api/v1/push/subscription' do\n     subject { post '/api/v1/push/subscription', params: create_payload, headers: headers }\n \n@@ -68,13 +81,29 @@\n     context 'with invalid endpoint URL' do\n       let(:endpoint) { 'app://example.foo' }\n \n-      it 'returns a validation error' do\n-        subject\n+      it_behaves_like 'validation error'\n+    end\n+\n+    context 'with invalid p256dh key' do\n+      let(:keys) do\n+        {\n+          p256dh: 'BEm_invalidf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n+          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+        }\n+      end\n \n-        expect(response).to have_http_status(422)\n-        expect(endpoint_push_subscriptions.count).to eq(0)\n-        expect(endpoint_push_subscription).to be_nil\n+      it_behaves_like 'validation error'\n+    end\n+\n+    context 'with invalid base64 p256dh key' do\n+      let(:keys) do\n+        {\n+          p256dh: 'not base64',\n+          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+        }\n       end\n+\n+      it_behaves_like 'validation error'\n     end\n   end\n \n---\n\n\n---\n\nChoice D:\nstreaming/redis.js\n@@ -50,9 +50,9 @@ function getSentinelConfiguration(env, commonOptions) {\n   return {\n     db: redisDatabase,\n     name: env.REDIS_SENTINEL_MASTER,\n-    username: env.REDIS_USERNAME,\n+    username: env.REDIS_USER,\n     password: env.REDIS_PASSWORD,\n-    sentinelUsername: env.REDIS_SENTINEL_USERNAME ?? env.REDIS_USERNAME,\n+    sentinelUsername: env.REDIS_SENTINEL_USERNAME ?? env.REDIS_USER,\n     sentinelPassword: env.REDIS_SENTINEL_PASSWORD ?? env.REDIS_PASSWORD,\n     sentinels,\n     ...commonOptions,\n@@ -104,7 +104,7 @@ export function configFromEnv(env) {\n     host: env.REDIS_HOST ?? '127.0.0.1',\n     port: redisPort,\n     db: redisDatabase,\n-    username: env.REDIS_USERNAME,\n+    username: env.REDIS_USER,\n     password: env.REDIS_PASSWORD,\n     ...commonOptions,\n   };\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nFixes #32458\n\n---\n\nChoice A:\nconfig/initializers/cors.rb\n@@ -22,6 +22,7 @@\n                expose: %w(Link X-RateLimit-Reset X-RateLimit-Limit X-RateLimit-Remaining X-Request-Id),\n                methods: %i(post put delete get patch options)\n       resource '/oauth/token', methods: [:post]\n+      resource '/oauth/revoke', methods: [:post]\n     end\n   end\n end\n---\n\n\n---\n\nChoice B:\napp/models/tag.rb\n@@ -35,7 +35,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?:^|[^/)\\w])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)[:word]])#(#{HASHTAG_NAME_PAT})}i\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/tag_spec.rb\n@@ -32,52 +32,56 @@\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)#Lawsuit')).to be_nil\n     end\n \n+    it 'does not match URLs with hashtag-like anchors after an empty query parameter' do\n+      expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)?foo=#Lawsuit')).to be_nil\n+    end\n+\n     it 'matches \ufeff#\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43' do\n-      expect(subject.match('\ufeffthis is #\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43').to_s).to eq ' #\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43'\n+      expect(subject.match('\ufeffthis is #\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43').to_s).to eq '#\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43'\n     end\n \n     it 'matches digits at the start' do\n-      expect(subject.match('hello #3d').to_s).to eq ' #3d'\n+      expect(subject.match('hello #3d').to_s).to eq '#3d'\n     end\n \n     it 'matches digits in the middle' do\n-      expect(subject.match('hello #l33ts35k').to_s).to eq ' #l33ts35k'\n+      expect(subject.match('hello #l33ts35k').to_s).to eq '#l33ts35k'\n     end\n \n     it 'matches digits at the end' do\n-      expect(subject.match('hello #world2016').to_s).to eq ' #world2016'\n+      expect(subject.match('hello #world2016').to_s).to eq '#world2016'\n     end\n \n     it 'matches underscores at the beginning' do\n-      expect(subject.match('hello #_test').to_s).to eq ' #_test'\n+      expect(subject.match('hello #_test').to_s).to eq '#_test'\n     end\n \n     it 'matches underscores at the end' do\n-      expect(subject.match('hello #test_').to_s).to eq ' #test_'\n+      expect(subject.match('hello #test_').to_s).to eq '#test_'\n     end\n \n     it 'matches underscores in the middle' do\n-      expect(subject.match('hello #one_two_three').to_s).to eq ' #one_two_three'\n+      expect(subject.match('hello #one_two_three').to_s).to eq '#one_two_three'\n     end\n \n     it 'matches middle dots' do\n-      expect(subject.match('hello #one\u00b7two\u00b7three').to_s).to eq ' #one\u00b7two\u00b7three'\n+      expect(subject.match('hello #one\u00b7two\u00b7three').to_s).to eq '#one\u00b7two\u00b7three'\n     end\n \n     it 'matches \u30fbunicode in \u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f correctly' do\n-      expect(subject.match('testing #\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f').to_s).to eq ' #\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f'\n+      expect(subject.match('testing #\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f').to_s).to eq '#\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f'\n     end\n \n     it 'matches ZWNJ' do\n-      expect(subject.match('just add #\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631 and').to_s).to eq ' #\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631'\n+      expect(subject.match('just add #\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631 and').to_s).to eq '#\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631'\n     end\n \n     it 'does not match middle dots at the start' do\n       expect(subject.match('hello #\u00b7one\u00b7two\u00b7three')).to be_nil\n     end\n \n     it 'does not match middle dots at the end' do\n-      expect(subject.match('hello #one\u00b7two\u00b7three\u00b7').to_s).to eq ' #one\u00b7two\u00b7three'\n+      expect(subject.match('hello #one\u00b7two\u00b7three\u00b7').to_s).to eq '#one\u00b7two\u00b7three'\n     end\n \n     it 'does not match purely-numeric hashtags' do\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/home_timeline/components/inline_follow_suggestions.jsx\n@@ -151,8 +151,13 @@ export const InlineFollowSuggestions = ({ hidden }) => {\n       return;\n     }\n \n-    setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n-    setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    if (getComputedStyle(bodyRef.current).direction === 'rtl') {\n+      setCanScrollLeft((bodyRef.current.clientWidth - bodyRef.current.scrollLeft) < bodyRef.current.scrollWidth);\n+      setCanScrollRight(bodyRef.current.scrollLeft < 0);\n+    } else {\n+      setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n+      setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    }\n   }, [setCanScrollRight, setCanScrollLeft, bodyRef]);\n \n   const handleDismiss = useCallback(() => {\n---\n\n\n---\n\nChoice D:\napp/models/user_role.rb\n@@ -41,7 +41,7 @@ class UserRole < ApplicationRecord\n   EVERYONE_ROLE_ID = -99\n   NOBODY_POSITION = -1\n \n-  POSITION_LIMIT = 2**31\n+  POSITION_LIMIT = (2**31) - 1\n \n   module Flags\n     NONE = 0\n@@ -91,7 +91,7 @@ module Flags\n \n   validates :name, presence: true, unless: :everyone?\n   validates :color, format: { with: /\\A#?(?:[A-F0-9]{3}){1,2}\\z/i }, unless: -> { color.blank? }\n-  validates :position, numericality: { greater_than_or_equal_to: -POSITION_LIMIT, less_than_or_equal_to: POSITION_LIMIT }\n+  validates :position, numericality: { in: (-POSITION_LIMIT..POSITION_LIMIT) }\n \n   validate :validate_permissions_elevation\n   validate :validate_position_elevation\n---\nspec/models/user_role_spec.rb\n@@ -21,11 +21,9 @@\n     describe 'position' do\n       subject { Fabricate.build :user_role }\n \n-      let(:excess) { 2**32 }\n-      let(:limit) { 2**31 }\n+      let(:limit) { described_class::POSITION_LIMIT }\n \n-      it { is_expected.to_not allow_values(-excess, excess).for(:position) }\n-      it { is_expected.to allow_values(-limit, limit).for(:position) }\n+      it { is_expected.to validate_numericality_of(:position).is_in(-limit..limit) }\n     end\n \n     describe 'color' do\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Make the web interface (4.3.0) RTL.\r\n2. Open any profile.\r\n3. Look at the `back` arrow.\r\n\r\n![image](https://github.com/user-attachments/assets/165458a7-58d3-432e-8fce-6a71169bfb6f)\r\n\n\n### Expected behaviour\n\nThe arrow should point to right (back)\n\n### Actual behaviour\n\nThe arrow is pointing to left (forward)\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\npersadon.com\n\n### Mastodon version\n\n4.3.0\n\n### Browser name and version\n\nFirefox-ESR 128.3.1\n\n### Operating system\n\nDebian GNU/Linux 12\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\nstreaming/redis.js\n@@ -50,9 +50,9 @@ function getSentinelConfiguration(env, commonOptions) {\n   return {\n     db: redisDatabase,\n     name: env.REDIS_SENTINEL_MASTER,\n-    username: env.REDIS_USERNAME,\n+    username: env.REDIS_USER,\n     password: env.REDIS_PASSWORD,\n-    sentinelUsername: env.REDIS_SENTINEL_USERNAME ?? env.REDIS_USERNAME,\n+    sentinelUsername: env.REDIS_SENTINEL_USERNAME ?? env.REDIS_USER,\n     sentinelPassword: env.REDIS_SENTINEL_PASSWORD ?? env.REDIS_PASSWORD,\n     sentinels,\n     ...commonOptions,\n@@ -104,7 +104,7 @@ export function configFromEnv(env) {\n     host: env.REDIS_HOST ?? '127.0.0.1',\n     port: redisPort,\n     db: redisDatabase,\n-    username: env.REDIS_USERNAME,\n+    username: env.REDIS_USER,\n     password: env.REDIS_PASSWORD,\n     ...commonOptions,\n   };\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/components/hashtag_bar.jsx\n@@ -0,0 +1,50 @@\n+import PropTypes from 'prop-types';\n+import { useMemo, useState, useCallback } from 'react';\n+\n+import { FormattedMessage } from 'react-intl';\n+\n+import { Link } from 'react-router-dom';\n+\n+import ImmutablePropTypes from 'react-immutable-proptypes';\n+\n+const domParser = new DOMParser();\n+\n+// About two lines on desktop\n+const VISIBLE_HASHTAGS = 7;\n+\n+export const HashtagBar = ({ hashtags, text }) => {\n+  const renderedHashtags = useMemo(() => {\n+    const body = domParser.parseFromString(text, 'text/html').documentElement;\n+    return [].map.call(body.querySelectorAll('[rel=tag]'), node => node.textContent.toLowerCase());\n+  }, [text]);\n+\n+  const invisibleHashtags = useMemo(() => (\n+    hashtags.filter(hashtag => !renderedHashtags.some(textContent => textContent === `#${hashtag.get('name')}` || textContent === hashtag.get('name')))\n+  ), [hashtags, renderedHashtags]);\n+\n+  const [expanded, setExpanded] = useState(false);\n+  const handleClick = useCallback(() => setExpanded(true), []);\n+\n+  if (invisibleHashtags.isEmpty()) {\n+    return null;\n+  }\n+\n+  const revealedHashtags = expanded ? invisibleHashtags : invisibleHashtags.take(VISIBLE_HASHTAGS);\n+\n+  return (\n+    <div className='hashtag-bar'>\n+      {revealedHashtags.map(hashtag => (\n+        <Link key={hashtag.get('name')} to={`/tags/${hashtag.get('name')}`}>\n+          #{hashtag.get('name')}\n+        </Link>\n+      ))}\n+\n+      {!expanded && invisibleHashtags.size > VISIBLE_HASHTAGS && <button className='link-button' onClick={handleClick}><FormattedMessage id='hashtags.and_other' defaultMessage='\u2026and {count, plural, other {# more}}' values={{ count: invisibleHashtags.size - VISIBLE_HASHTAGS }} /></button>}\n+    </div>\n+  );\n+};\n+\n+HashtagBar.propTypes = {\n+  hashtags: ImmutablePropTypes.list,\n+  text: PropTypes.string,\n+};\n\\ No newline at end of file\n---\napp/javascript/mastodon/components/status.jsx\n@@ -22,6 +22,7 @@ import { displayMedia } from '../initial_state';\n import { Avatar } from './avatar';\n import { AvatarOverlay } from './avatar_overlay';\n import { DisplayName } from './display_name';\n+import { HashtagBar } from './hashtag_bar';\n import { RelativeTimestamp } from './relative_timestamp';\n import StatusActionBar from './status_action_bar';\n import StatusContent from './status_content';\n@@ -580,6 +581,8 @@ class Status extends ImmutablePureComponent {\n \n             {media}\n \n+            <HashtagBar hashtags={status.get('tags')} text={status.get('content')} />\n+\n             <StatusActionBar scrollKey={scrollKey} status={status} account={account} onFilter={matchedFilters ? this.handleFilterClick : null} {...other} />\n           </div>\n         </div>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -10,6 +10,7 @@ import ImmutablePureComponent from 'react-immutable-pure-component';\n \n import { AnimatedNumber } from 'mastodon/components/animated_number';\n import EditedTimestamp from 'mastodon/components/edited_timestamp';\n+import { HashtagBar } from 'mastodon/components/hashtag_bar';\n import { Icon }  from 'mastodon/components/icon';\n import PictureInPicturePlaceholder from 'mastodon/components/picture_in_picture_placeholder';\n \n@@ -314,6 +315,8 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           {media}\n \n+          <HashtagBar hashtags={status.get('tags')} text={status.get('content')} />\n+\n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n               <FormattedDate value={new Date(status.get('created_at'))} hour12={false} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n---\napp/javascript/mastodon/locales/en.json\n@@ -300,6 +300,7 @@\n   \"hashtag.counter_by_uses_today\": \"{count, plural, one {{counter} post} other {{counter} posts}} today\",\n   \"hashtag.follow\": \"Follow hashtag\",\n   \"hashtag.unfollow\": \"Unfollow hashtag\",\n+  \"hashtags.and_other\": \"\u2026and {count, plural, other {# more}}\",\n   \"home.actions.go_to_explore\": \"See what's trending\",\n   \"home.actions.go_to_suggestions\": \"Find people to follow\",\n   \"home.column_settings.basic\": \"Basic\",\n---\napp/javascript/styles/mastodon/components.scss\n@@ -9256,3 +9256,26 @@ noscript {\n     }\n   }\n }\n+\n+.hashtag-bar {\n+  margin-top: 16px;\n+  display: flex;\n+  flex-wrap: wrap;\n+  font-size: 14px;\n+  gap: 4px;\n+\n+  a {\n+    display: inline-flex;\n+    border-radius: 4px;\n+    background: rgba($highlight-text-color, 0.2);\n+    color: $highlight-text-color;\n+    padding: 0.4em 0.6em;\n+    text-decoration: none;\n+\n+    &:hover,\n+    &:focus,\n+    &:active {\n+      background: rgba($highlight-text-color, 0.3);\n+    }\n+  }\n+}\n---\napp/javascript/mastodon/components/status.jsx\n@@ -546,6 +546,7 @@ class Status extends ImmutablePureComponent {\n     const visibilityIcon = visibilityIconInfo[status.get('visibility')];\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n+    const expanded = !status.get('hidden')\n \n     return (\n       <HotKeys handlers={handlers}>\n@@ -574,7 +575,7 @@ class Status extends ImmutablePureComponent {\n             <StatusContent\n               status={status}\n               onClick={this.handleClick}\n-              expanded={!status.get('hidden')}\n+              expanded={expanded}\n               onExpandedToggle={this.handleExpandedToggle}\n               onTranslate={this.handleTranslate}\n               collapsible\n@@ -584,7 +585,7 @@ class Status extends ImmutablePureComponent {\n \n             {media}\n \n-            {hashtagBar}\n+            {expanded && hashtagBar}\n \n             <StatusActionBar scrollKey={scrollKey} status={status} account={account} onFilter={matchedFilters ? this.handleFilterClick : null} {...other} />\n           </div>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -293,6 +293,7 @@ class DetailedStatus extends ImmutablePureComponent {\n     }\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n+    const expanded = !status.get('hidden')\n \n     return (\n       <div style={outerStyle}>\n@@ -318,7 +319,7 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           {media}\n \n-          {hashtagBar}\n+          {expanded && hashtagBar}\n \n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/rtl.scss\n@@ -35,6 +35,10 @@ body.rtl {\n     direction: rtl;\n   }\n \n+  .column-back-button__icon {\n+    transform: scale(-1, 1);\n+  }\n+\n   .simple_form select {\n     background: $ui-base-color\n       url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 14.933 18.467' height='19.698' width='15.929'><path d='M3.467 14.967l-3.393-3.5H14.86l-3.392 3.5c-1.866 1.925-3.666 3.5-4 3.5-.335 0-2.135-1.575-4-3.5zm.266-11.234L7.467 0 11.2 3.733l3.733 3.734H0l3.733-3.734z' fill='#{hex-color(lighten($ui-base-color, 12%))}'/></svg>\")\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -2249,6 +2249,10 @@ a.account__display-name {\n   }\n }\n \n+.notification-follow {\n+  border-bottom: 1px solid var(--background-border-color);\n+}\n+\n .notification-group--link {\n   color: $secondary-text-color;\n   text-decoration: none;\n---\napp/javascript/styles/mastodon/admin.scss\n@@ -872,6 +872,7 @@ a.name-tag,\n \n     .account {\n       padding: 0;\n+      border: none;\n \n       &__avatar-wrapper {\n         margin-inline-start: 0;\n---\napp/javascript/styles/mastodon/components.scss\n@@ -1808,6 +1808,7 @@ body > [data-popper-placement] {\n \n .account {\n   padding: 16px;\n+  border-bottom: 1px solid var(--background-border-color);\n \n   .account__display-name {\n     flex: 1 1 auto;\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Make the web interface (4.3.0) RTL.\r\n2. Look at the `people top follow` section\r\n\r\n![image](https://github.com/user-attachments/assets/0933a91e-445a-46a6-96d2-a0d41439b79d)\r\n\n\n### Expected behaviour\n\na button with an arrow to left should be on the left side of the section\n\n### Actual behaviour\n\na button with an arrow to right is on the right side of the section doing nothing\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nbotsin.space\n\n### Mastodon version\n\n4.3.0\n\n### Browser name and version\n\nFirefox-ESR 128.3.1\n\n### Operating system\n\nDebian GNU/Linux 12\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/components/admin/Retention.jsx\n@@ -9,11 +9,12 @@ import api from 'mastodon/api';\n import { roundTo10 } from 'mastodon/utils/numbers';\n \n const dateForCohort = cohort => {\n+  const timeZone = 'UTC';\n   switch(cohort.frequency) {\n   case 'day':\n-    return <FormattedDate value={cohort.period} month='long' day='2-digit' />;\n+    return <FormattedDate value={cohort.period} month='long' day='2-digit' timeZone={timeZone} />;\n   default:\n-    return <FormattedDate value={cohort.period} month='long' year='numeric' />;\n+    return <FormattedDate value={cohort.period} month='long' year='numeric' timeZone={timeZone} />;\n   }\n };\n \n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/home_timeline/components/inline_follow_suggestions.jsx\n@@ -129,8 +129,13 @@ export const InlineFollowSuggestions = ({ hidden }) => {\n       return;\n     }\n \n-    setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n-    setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    if (getComputedStyle(bodyRef.current).direction === 'rtl') {\n+      setCanScrollLeft((bodyRef.current.clientWidth - bodyRef.current.scrollLeft) < bodyRef.current.scrollWidth);\n+      setCanScrollRight(bodyRef.current.scrollLeft < 0);\n+    } else {\n+      setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n+      setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    }\n   }, [setCanScrollRight, setCanScrollLeft, bodyRef, suggestions]);\n \n   const handleLeftNav = useCallback(() => {\n---\n\n\n---\n\nChoice C:\napp/services/fetch_link_card_service.rb\n@@ -29,7 +29,7 @@ def call(status)\n     end\n \n     attach_card if @card&.persisted?\n-  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError => e\n+  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError, Encoding::UndefinedConversionError => e\n     Rails.logger.debug { \"Error fetching link #{@original_url}: #{e}\" }\n     nil\n   end\n---\nspec/fixtures/requests/redirect_with_utf8_url.txt\n@@ -0,0 +1,5 @@\n+HTTP/1.1 301 Moved Permanently\n+server: nginx\n+date: Thu, 27 Jun 2024 11:04:53 GMT\n+content-type: text/html; charset=UTF-8\n+location: http://example.com/\u00e4rgerliche-umlaute.html\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -27,6 +27,7 @@\n     stub_request(:get, 'http://example.com/koi8-r').to_return(request_fixture('koi8-r.txt'))\n     stub_request(:get, 'http://example.com/windows-1251').to_return(request_fixture('windows-1251.txt'))\n     stub_request(:get, 'http://example.com/low_confidence_latin1').to_return(request_fixture('low_confidence_latin1.txt'))\n+    stub_request(:get, 'http://example.com/aergerliche-umlaute').to_return(request_fixture('redirect_with_utf8_url.txt'))\n \n     Rails.cache.write('oembed_endpoint:example.com', oembed_cache) if oembed_cache\n \n@@ -101,6 +102,14 @@\n       end\n     end\n \n+    context 'with a redirect URL with faulty encoding' do\n+      let(:status) { Fabricate(:status, text: 'http://example.com/aergerliche-umlaute') }\n+\n+      it 'does not create a preview card' do\n+        expect(status.preview_card).to be_nil\n+      end\n+    end\n+\n     context 'with a 404 URL' do\n       let(:status) { Fabricate(:status, text: 'http://example.com/not-found') }\n \n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -1996,6 +1996,7 @@ body > [data-popper-placement] {\n \n         &__handle {\n           user-select: all;\n+          overflow-wrap: anywhere;\n         }\n       }\n \n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Navigate to \"Follow recommendations\" moderation page.\r\n2. Suppress a recommended user\r\n3. Select the \"Suppressed\" filter to see the user is listed\r\n4. Select the \"Active\" filter to see the user is also still listed there\r\n5. Suppress the same user again\r\n\n\n### Expected behaviour\n\nWhen suppressing a user, the user is listed in both Active and Suppressed lists.  Supressing the user a second time displays an error page.\n\n### Actual behaviour\n\nSuppressed user is no longer listed on the Active page. Supressing a user a second time (eg. if two tabs are open) behaves the same as suppressing it once.\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nsunny.garden\n\n### Mastodon version\n\nv4.3.0\n\n### Browser name and version\n\nFirefox 131.0.2\n\n### Operating system\n\nMicrosoft Windows [Version 10.0.19045.4894]\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/components/hashtag_bar.jsx\n@@ -0,0 +1,50 @@\n+import PropTypes from 'prop-types';\n+import { useMemo, useState, useCallback } from 'react';\n+\n+import { FormattedMessage } from 'react-intl';\n+\n+import { Link } from 'react-router-dom';\n+\n+import ImmutablePropTypes from 'react-immutable-proptypes';\n+\n+const domParser = new DOMParser();\n+\n+// About two lines on desktop\n+const VISIBLE_HASHTAGS = 7;\n+\n+export const HashtagBar = ({ hashtags, text }) => {\n+  const renderedHashtags = useMemo(() => {\n+    const body = domParser.parseFromString(text, 'text/html').documentElement;\n+    return [].map.call(body.querySelectorAll('[rel=tag]'), node => node.textContent.toLowerCase());\n+  }, [text]);\n+\n+  const invisibleHashtags = useMemo(() => (\n+    hashtags.filter(hashtag => !renderedHashtags.some(textContent => textContent === `#${hashtag.get('name')}` || textContent === hashtag.get('name')))\n+  ), [hashtags, renderedHashtags]);\n+\n+  const [expanded, setExpanded] = useState(false);\n+  const handleClick = useCallback(() => setExpanded(true), []);\n+\n+  if (invisibleHashtags.isEmpty()) {\n+    return null;\n+  }\n+\n+  const revealedHashtags = expanded ? invisibleHashtags : invisibleHashtags.take(VISIBLE_HASHTAGS);\n+\n+  return (\n+    <div className='hashtag-bar'>\n+      {revealedHashtags.map(hashtag => (\n+        <Link key={hashtag.get('name')} to={`/tags/${hashtag.get('name')}`}>\n+          #{hashtag.get('name')}\n+        </Link>\n+      ))}\n+\n+      {!expanded && invisibleHashtags.size > VISIBLE_HASHTAGS && <button className='link-button' onClick={handleClick}><FormattedMessage id='hashtags.and_other' defaultMessage='\u2026and {count, plural, other {# more}}' values={{ count: invisibleHashtags.size - VISIBLE_HASHTAGS }} /></button>}\n+    </div>\n+  );\n+};\n+\n+HashtagBar.propTypes = {\n+  hashtags: ImmutablePropTypes.list,\n+  text: PropTypes.string,\n+};\n\\ No newline at end of file\n---\napp/javascript/mastodon/components/status.jsx\n@@ -22,6 +22,7 @@ import { displayMedia } from '../initial_state';\n import { Avatar } from './avatar';\n import { AvatarOverlay } from './avatar_overlay';\n import { DisplayName } from './display_name';\n+import { HashtagBar } from './hashtag_bar';\n import { RelativeTimestamp } from './relative_timestamp';\n import StatusActionBar from './status_action_bar';\n import StatusContent from './status_content';\n@@ -580,6 +581,8 @@ class Status extends ImmutablePureComponent {\n \n             {media}\n \n+            <HashtagBar hashtags={status.get('tags')} text={status.get('content')} />\n+\n             <StatusActionBar scrollKey={scrollKey} status={status} account={account} onFilter={matchedFilters ? this.handleFilterClick : null} {...other} />\n           </div>\n         </div>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -10,6 +10,7 @@ import ImmutablePureComponent from 'react-immutable-pure-component';\n \n import { AnimatedNumber } from 'mastodon/components/animated_number';\n import EditedTimestamp from 'mastodon/components/edited_timestamp';\n+import { HashtagBar } from 'mastodon/components/hashtag_bar';\n import { Icon }  from 'mastodon/components/icon';\n import PictureInPicturePlaceholder from 'mastodon/components/picture_in_picture_placeholder';\n \n@@ -314,6 +315,8 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           {media}\n \n+          <HashtagBar hashtags={status.get('tags')} text={status.get('content')} />\n+\n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n               <FormattedDate value={new Date(status.get('created_at'))} hour12={false} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n---\napp/javascript/mastodon/locales/en.json\n@@ -300,6 +300,7 @@\n   \"hashtag.counter_by_uses_today\": \"{count, plural, one {{counter} post} other {{counter} posts}} today\",\n   \"hashtag.follow\": \"Follow hashtag\",\n   \"hashtag.unfollow\": \"Unfollow hashtag\",\n+  \"hashtags.and_other\": \"\u2026and {count, plural, other {# more}}\",\n   \"home.actions.go_to_explore\": \"See what's trending\",\n   \"home.actions.go_to_suggestions\": \"Find people to follow\",\n   \"home.column_settings.basic\": \"Basic\",\n---\napp/javascript/styles/mastodon/components.scss\n@@ -9256,3 +9256,26 @@ noscript {\n     }\n   }\n }\n+\n+.hashtag-bar {\n+  margin-top: 16px;\n+  display: flex;\n+  flex-wrap: wrap;\n+  font-size: 14px;\n+  gap: 4px;\n+\n+  a {\n+    display: inline-flex;\n+    border-radius: 4px;\n+    background: rgba($highlight-text-color, 0.2);\n+    color: $highlight-text-color;\n+    padding: 0.4em 0.6em;\n+    text-decoration: none;\n+\n+    &:hover,\n+    &:focus,\n+    &:active {\n+      background: rgba($highlight-text-color, 0.3);\n+    }\n+  }\n+}\n---\napp/javascript/mastodon/components/status.jsx\n@@ -546,6 +546,7 @@ class Status extends ImmutablePureComponent {\n     const visibilityIcon = visibilityIconInfo[status.get('visibility')];\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n+    const expanded = !status.get('hidden')\n \n     return (\n       <HotKeys handlers={handlers}>\n@@ -574,7 +575,7 @@ class Status extends ImmutablePureComponent {\n             <StatusContent\n               status={status}\n               onClick={this.handleClick}\n-              expanded={!status.get('hidden')}\n+              expanded={expanded}\n               onExpandedToggle={this.handleExpandedToggle}\n               onTranslate={this.handleTranslate}\n               collapsible\n@@ -584,7 +585,7 @@ class Status extends ImmutablePureComponent {\n \n             {media}\n \n-            {hashtagBar}\n+            {expanded && hashtagBar}\n \n             <StatusActionBar scrollKey={scrollKey} status={status} account={account} onFilter={matchedFilters ? this.handleFilterClick : null} {...other} />\n           </div>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -293,6 +293,7 @@ class DetailedStatus extends ImmutablePureComponent {\n     }\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n+    const expanded = !status.get('hidden')\n \n     return (\n       <div style={outerStyle}>\n@@ -318,7 +319,7 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           {media}\n \n-          {hashtagBar}\n+          {expanded && hashtagBar}\n \n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/home_timeline/components/inline_follow_suggestions.jsx\n@@ -129,8 +129,13 @@ export const InlineFollowSuggestions = ({ hidden }) => {\n       return;\n     }\n \n-    setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n-    setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    if (getComputedStyle(bodyRef.current).direction === 'rtl') {\n+      setCanScrollLeft((bodyRef.current.clientWidth - bodyRef.current.scrollLeft) < bodyRef.current.scrollWidth);\n+      setCanScrollRight(bodyRef.current.scrollLeft < 0);\n+    } else {\n+      setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n+      setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    }\n   }, [setCanScrollRight, setCanScrollLeft, bodyRef, suggestions]);\n \n   const handleLeftNav = useCallback(() => {\n---\n\n\n---\n\nChoice C:\nlib/mastodon/cli/search.rb\n@@ -100,6 +100,14 @@ def deploy\n       progress.finish\n \n       say(\"Indexed #{added} records, de-indexed #{removed}\", :green, true)\n+    rescue Elasticsearch::Transport::Transport::ServerError => e\n+      fail_with_message <<~ERROR\n+        There was an issue connecting to the search server. Make sure the\n+        server is configured and running correctly, and that the environment\n+        variable settings match what the server is expecting.\n+\n+        #{e.message}\n+      ERROR\n     end\n \n     private\n---\nspec/lib/mastodon/cli/search_spec.rb\n@@ -33,6 +33,17 @@\n       end\n     end\n \n+    context 'when server communication raises an error' do\n+      let(:options) { { reset_chewy: true } }\n+\n+      before { allow(Chewy::Stash::Specification).to receive(:reset!).and_raise(Elasticsearch::Transport::Transport::Errors::InternalServerError) }\n+\n+      it 'Exits with error message' do\n+        expect { subject }\n+          .to raise_error(Thor::Error, /issue connecting to the search/)\n+      end\n+    end\n+\n     context 'without options' do\n       before { stub_search_indexes }\n \n---\n\n\n---\n\nChoice D:\napp/models/follow_recommendation.rb\n@@ -18,5 +18,6 @@ class FollowRecommendation < ApplicationRecord\n   belongs_to :account_summary, foreign_key: :account_id, inverse_of: false\n   belongs_to :account\n \n-  scope :localized, ->(locale) { joins(:account_summary).merge(AccountSummary.localized(locale)) }\n+  scope :unsupressed, -> { where.not(FollowRecommendationSuppression.where(FollowRecommendationSuppression.arel_table[:account_id].eq(arel_table[:account_id])).select(1).arel.exists) }\n+  scope :localized, ->(locale) { unsupressed.joins(:account_summary).merge(AccountSummary.localized(locale)) }\n end\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. navigate to `<yourinstance>/deck/getting-started`\r\n2. get a notification\r\n3. scroll down in notifications\r\n4. click the double check mark button on top to mark every notification as read\r\n\n\n### Expected behaviour\n\n\"Mark every notification as read\" button should mark notifications read even when scrolled down\n\n### Actual behaviour\n\n\"Mark every notification as read\" button does not mark notifications read even when scrolled down\n\n### Detailed description\n\nThe \"Mark every notification as read\" button on top of the notifications column in the deck view does not work when scrolled down in the notifications view. It only works when scrolled all the way to the top.\n\n### Mastodon instance\n\nvis.social\n\n### Mastodon version\n\nv4.3.0\n\n### Browser name and version\n\nFirefox 131.0 (aarch64)\n\n### Operating system\n\nmacOS 14.6.1\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/views/user_mailer/confirmation_instructions.html.haml\n@@ -8,9 +8,7 @@\n           %td.email-inner-card-td.email-prose\n             %p= t @resource.approved? ? 'devise.mailer.confirmation_instructions.explanation' : 'devise.mailer.confirmation_instructions.explanation_when_pending', host: site_hostname\n             - if @resource.created_by_application\n-              = render 'application/mailer/button', text: t('settings.account_settings'), url: edit_user_registration_url\n-              = link_to confirmation_url(@resource, confirmation_token: @token, redirect_to_app: 'true') do\n-                %span= t 'devise.mailer.confirmation_instructions.action_with_app', app: @resource.created_by_application.name\n+              = render 'application/mailer/button', text: t('devise.mailer.confirmation_instructions.action_with_app', app: @resource.created_by_application.name), url: confirmation_url(@resource, confirmation_token: @token, redirect_to_app: 'true')\n             - else\n               = render 'application/mailer/button', text: t('devise.mailer.confirmation_instructions.action'), url: confirmation_url(@resource, confirmation_token: @token)\n             %p= t 'devise.mailer.confirmation_instructions.extra_html', terms_path: about_more_url, policy_path: privacy_policy_url\n---\n\n\n---\n\nChoice B:\nconfig/routes.rb\n@@ -142,7 +142,11 @@ def redirect_with_vary(path)\n \n   resource :inbox, only: [:create], module: :activitypub\n \n-  get '/:encoded_at(*path)', to: redirect('/@%{path}'), constraints: { encoded_at: /%40/ }\n+  constraints(encoded_path: /%40.*/) do\n+    get '/:encoded_path', to: redirect { |params|\n+      \"/#{params[:encoded_path].gsub('%40', '@')}\"\n+    }\n+  end\n \n   constraints(username: %r{[^@/.]+}) do\n     with_options to: 'accounts#show' do\n---\nspec/routing/accounts_routing_spec.rb\n@@ -47,6 +47,61 @@\n     end\n   end\n \n+  context 'with local username encoded at' do\n+    include RSpec::Rails::RequestExampleGroup\n+    let(:username) { 'alice' }\n+\n+    it 'routes /%40:username' do\n+      get \"/%40#{username}\"\n+      expect(response).to redirect_to(\"/@#{username}\")\n+    end\n+\n+    it 'routes /%40:username.json' do\n+      get(\"/%40#{username}.json\")\n+      expect(response).to redirect_to(\"/@#{username}.json\")\n+    end\n+\n+    it 'routes /%40:username.rss' do\n+      get(\"/%40#{username}.rss\")\n+      expect(response).to redirect_to(\"/@#{username}.rss\")\n+    end\n+\n+    it 'routes /%40:username/:id' do\n+      get(\"/%40#{username}/123\")\n+      expect(response).to redirect_to(\"/@#{username}/123\")\n+    end\n+\n+    it 'routes /%40:username/:id/embed' do\n+      get(\"/%40#{username}/123/embed\")\n+      expect(response).to redirect_to(\"/@#{username}/123/embed\")\n+    end\n+\n+    it 'routes /%40:username/following' do\n+      get(\"/%40#{username}/following\")\n+      expect(response).to redirect_to(\"/@#{username}/following\")\n+    end\n+\n+    it 'routes /%40:username/followers' do\n+      get(\"/%40#{username}/followers\")\n+      expect(response).to redirect_to(\"/@#{username}/followers\")\n+    end\n+\n+    it 'routes /%40:username/with_replies' do\n+      get(\"/%40#{username}/with_replies\")\n+      expect(response).to redirect_to(\"/@#{username}/with_replies\")\n+    end\n+\n+    it 'routes /%40:username/media' do\n+      get(\"/%40#{username}/media\")\n+      expect(response).to redirect_to(\"/@#{username}/media\")\n+    end\n+\n+    it 'routes /%40:username/tagged/:tag' do\n+      get(\"/%40#{username}/tagged/foo\")\n+      expect(response).to redirect_to(\"/@#{username}/tagged/foo\")\n+    end\n+  end\n+\n   context 'with remote username' do\n     let(:username) { 'alice@example.com' }\n \n@@ -82,4 +137,50 @@\n       expect(get(\"/@#{username}/tagged/foo\")).to route_to('home#index', username_with_domain: username, any: 'tagged/foo')\n     end\n   end\n+\n+  context 'with remote username encoded at' do\n+    include RSpec::Rails::RequestExampleGroup\n+    let(:username) { 'alice%40example.com' }\n+    let(:username_decoded) { 'alice@example.com' }\n+\n+    it 'routes /%40:username' do\n+      get(\"/%40#{username}\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}\")\n+    end\n+\n+    it 'routes /%40:username/:id' do\n+      get(\"/%40#{username}/123\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/123\")\n+    end\n+\n+    it 'routes /%40:username/:id/embed' do\n+      get(\"/%40#{username}/123/embed\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/123/embed\")\n+    end\n+\n+    it 'routes /%40:username/following' do\n+      get(\"/%40#{username}/following\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/following\")\n+    end\n+\n+    it 'routes /%40:username/followers' do\n+      get(\"/%40#{username}/followers\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/followers\")\n+    end\n+\n+    it 'routes /%40:username/with_replies' do\n+      get(\"/%40#{username}/with_replies\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/with_replies\")\n+    end\n+\n+    it 'routes /%40:username/media' do\n+      get(\"/%40#{username}/media\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/media\")\n+    end\n+\n+    it 'routes /%40:username/tagged/:tag' do\n+      get(\"/%40#{username}/tagged/foo\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/tagged/foo\")\n+    end\n+  end\n end\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/reducers/notification_groups.ts\n@@ -559,7 +559,10 @@ export const notificationGroupsReducer = createReducer<NotificationGroupsState>(\n           compareId(state.lastReadId, mostRecentGroup.page_max_id) < 0\n         )\n           state.lastReadId = mostRecentGroup.page_max_id;\n-        commitLastReadId(state);\n+\n+        // We don't call `commitLastReadId`, because that is conditional\n+        // and we want to unconditionally update the state instead.\n+        state.readMarkerId = state.lastReadId;\n       })\n       .addCase(fetchMarkers.fulfilled, (state, action) => {\n         if (\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/about.scss\n@@ -547,6 +547,7 @@\n   }\n \n   #mastodon-timeline {\n+    display: flex;\n     -webkit-overflow-scrolling: touch;\n     -ms-overflow-style: -ms-autohiding-scrollbar;\n     font-family: 'mastodon-font-sans-serif', sans-serif;\n@@ -565,7 +566,6 @@\n       padding: 0;\n       border-radius: 4px;\n       overflow: hidden;\n-      height: 100%;\n     }\n \n     .scrollable {\n---\napp/services/post_status_service.rb\n@@ -160,7 +160,7 @@ def idempotency_given?\n \n   def idempotency_duplicate\n     if scheduled?\n-      @account.schedule_statuses.find(@idempotency_duplicate)\n+      @account.scheduled_statuses.find(@idempotency_duplicate)\n     else\n       @account.statuses.find(@idempotency_duplicate)\n     end\n@@ -211,7 +211,7 @@ def poll_attributes\n   end\n \n   def scheduled_options\n-    @options.tap do |options_hash|\n+    @options.dup.tap do |options_hash|\n       options_hash[:in_reply_to_id]  = options_hash.delete(:thread)&.id\n       options_hash[:application_id]  = options_hash.delete(:application)&.id\n       options_hash[:scheduled_at]    = nil\n---\nspec/services/post_status_service_spec.rb\n@@ -54,6 +54,13 @@\n         .to not_change { account.statuses_count }\n         .and(not_change { previous_status.replies_count })\n     end\n+\n+    it 'returns existing status when used twice with idempotency key' do\n+      account = Fabricate(:account)\n+      status1 = subject.call(account, text: 'test', idempotency: 'meepmeep', scheduled_at: future)\n+      status2 = subject.call(account, text: 'test', idempotency: 'meepmeep', scheduled_at: future)\n+      expect(status2.id).to eq status1.id\n+    end\n   end\n \n   it 'creates response to the original status of boost' do\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Give someone a timed mute\r\n2. Navigate to list of muted users via \"\u2026\" \"muted users\"\r\n\n\n### Expected behaviour\n\nA list of muted users complete with remaining mute duration should appear\n\n### Actual behaviour\n\nNo distinction is made between the users muted for a limited time and those muted indefinitely. \n\n### Detailed description\n\nIIRC in the previous version the \"plain\" interface used to show remaining mute duration as well as presenting the option to unmute. The \"deck\" view didn't show duration due to space constraints. \r\n\r\nNow neither show them nor are the durations or end date shown on the individual profiles so you have to have a really good memory or a third party app. \n\n### Mastodon instance\n\nen.osm.towm\n\n### Mastodon version\n\n v4.3.0\n\n### Browser name and version\n\n131.0 (64-bit)\n\n### Operating system\n\nWindows 11\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\ndb/migrate/20240304090449_migrate_interaction_settings_to_policy.rb\n@@ -20,6 +20,9 @@ class NotificationPolicy < ApplicationRecord\n   def up\n     User.includes(account: :notification_policy).find_each do |user|\n       deserialized_settings = Oj.load(user.attributes_before_type_cast['settings'])\n+\n+      next if deserialized_settings.nil?\n+\n       policy = user.account.notification_policy || user.account.build_notification_policy\n       requires_new_policy = false\n \n---\n\n\n---\n\nChoice B:\napp/models/admin/action_log_filter.rb\n@@ -38,7 +38,7 @@ class Admin::ActionLogFilter\n     destroy_status: { target_type: 'Status', action: 'destroy' }.freeze,\n     destroy_user_role: { target_type: 'UserRole', action: 'destroy' }.freeze,\n     destroy_canonical_email_block: { target_type: 'CanonicalEmailBlock', action: 'destroy' }.freeze,\n-    disable_2fa_user: { target_type: 'User', action: 'disable' }.freeze,\n+    disable_2fa_user: { target_type: 'User', action: 'disable_2fa' }.freeze,\n     disable_custom_emoji: { target_type: 'CustomEmoji', action: 'disable' }.freeze,\n     disable_user: { target_type: 'User', action: 'disable' }.freeze,\n     enable_custom_emoji: { target_type: 'CustomEmoji', action: 'enable' }.freeze,\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/api_types/accounts.ts\n@@ -13,7 +13,7 @@ export interface ApiAccountRoleJSON {\n }\n \n // See app/serializers/rest/account_serializer.rb\n-export interface ApiAccountJSON {\n+export interface BaseApiAccountJSON {\n   acct: string;\n   avatar: string;\n   avatar_static: string;\n@@ -45,3 +45,12 @@ export interface ApiAccountJSON {\n   memorial?: boolean;\n   hide_collections: boolean;\n }\n+\n+// See app/serializers/rest/muted_account_serializer.rb\n+export interface ApiMutedAccountJSON extends BaseApiAccountJSON {\n+  mute_expires_at?: string | null;\n+}\n+\n+// For now, we have the same type representing both `Account` and `MutedAccount`\n+// objects, but we should refactor this in the future.\n+export type ApiAccountJSON = ApiMutedAccountJSON;\n---\napp/javascript/mastodon/models/account.ts\n@@ -95,6 +95,9 @@ export const accountDefaultValues: AccountShape = {\n   limited: false,\n   moved: null,\n   hide_collections: false,\n+  // This comes from `ApiMutedAccountJSON`, but we should eventually\n+  // store that in a different object.\n+  mute_expires_at: null,\n };\n \n const AccountFactory = ImmutableRecord<AccountShape>(accountDefaultValues);\n---\n\n\n---\n\nChoice D:\napp/lib/activitypub/activity/create.rb\n@@ -336,13 +336,15 @@ def resolve_thread(status)\n \n   def fetch_replies(status)\n     collection = @object['replies']\n-    return if collection.nil?\n+    return if collection.blank?\n \n     replies = ActivityPub::FetchRepliesService.new.call(status, collection, allow_synchronous_requests: false, request_id: @options[:request_id])\n     return unless replies.nil?\n \n     uri = value_or_id(collection)\n     ActivityPub::FetchRepliesWorker.perform_async(status.id, uri, { 'request_id' => @options[:request_id] }) unless uri.nil?\n+  rescue => e\n+    Rails.logger.warn \"Error fetching replies: #{e}\"\n   end\n \n   def conversation_from_uri(uri)\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Get notified by a filtered notification\r\n2. Instance-wide suspend user in question (removing the post)\r\n\n\n### Expected behaviour\n\nFilter notification disappears when user is suspended\n\n### Actual behaviour\n\nFiltered notification is still there, even if clicking on it returns nothing\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nmasto.donte.com.br\n\n### Mastodon version\n\nv4.3.0+donte\n\n### Browser name and version\n\nVersion 129.0.6668.58 (Official Build, ungoogled-chromium) Arch Linux (64-bit)\n\n### Operating system\n\nLinux\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/models/web/push_subscription.rb\n@@ -21,7 +21,7 @@ class Web::PushSubscription < ApplicationRecord\n \n   has_one :session_activation, foreign_key: 'web_push_subscription_id', inverse_of: :web_push_subscription, dependent: nil\n \n-  validates :endpoint, presence: true\n+  validates :endpoint, presence: true, url: true\n   validates :key_p256dh, presence: true\n   validates :key_auth, presence: true\n \n---\nspec/requests/api/v1/push/subscriptions_spec.rb\n@@ -4,10 +4,11 @@\n \n describe 'API V1 Push Subscriptions' do\n   let(:user) { Fabricate(:user) }\n+  let(:endpoint) { 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX' }\n   let(:create_payload) do\n     {\n       subscription: {\n-        endpoint: 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX',\n+        endpoint: endpoint,\n         keys: {\n           p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n           auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n@@ -63,6 +64,18 @@\n       expect(endpoint_push_subscriptions.count)\n         .to eq(1)\n     end\n+\n+    context 'with invalid endpoint URL' do\n+      let(:endpoint) { 'app://example.foo' }\n+\n+      it 'returns a validation error' do\n+        subject\n+\n+        expect(response).to have_http_status(422)\n+        expect(endpoint_push_subscriptions.count).to eq(0)\n+        expect(endpoint_push_subscription).to be_nil\n+      end\n+    end\n   end\n \n   describe 'PUT /api/v1/push/subscription' do\n---\napp/models/web/push_subscription.rb\n@@ -25,6 +25,8 @@ class Web::PushSubscription < ApplicationRecord\n   validates :key_p256dh, presence: true\n   validates :key_auth, presence: true\n \n+  validates_with WebPushKeyValidator\n+\n   delegate :locale, to: :associated_user\n \n   def encrypt(payload)\n---\napp/validators/web_push_key_validator.rb\n@@ -0,0 +1,11 @@\n+# frozen_string_literal: true\n+\n+class WebPushKeyValidator < ActiveModel::Validator\n+  def validate(subscription)\n+    begin\n+      Webpush::Encryption.encrypt('validation_test', subscription.key_p256dh, subscription.key_auth)\n+    rescue ArgumentError, OpenSSL::PKey::EC::Point::Error\n+      subscription.errors.add(:base, I18n.t('crypto.errors.invalid_key'))\n+    end\n+  end\n+end\n---\nspec/fabricators/web_push_subscription_fabricator.rb\n@@ -2,6 +2,10 @@\n \n Fabricator(:web_push_subscription, from: Web::PushSubscription) do\n   endpoint   Faker::Internet.url\n-  key_p256dh Faker::Internet.password\n-  key_auth   Faker::Internet.password\n+  key_p256dh do\n+    curve = OpenSSL::PKey::EC.generate('prime256v1')\n+    ecdh_key = curve.public_key.to_bn.to_s(2)\n+    Base64.urlsafe_encode64(ecdh_key)\n+  end\n+  key_auth { Base64.urlsafe_encode64(Random.new.bytes(16)) }\n end\n---\nspec/requests/api/v1/push/subscriptions_spec.rb\n@@ -5,14 +5,17 @@\n describe 'API V1 Push Subscriptions' do\n   let(:user) { Fabricate(:user) }\n   let(:endpoint) { 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX' }\n+  let(:keys) do\n+    {\n+      p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n+      auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+    }\n+  end\n   let(:create_payload) do\n     {\n       subscription: {\n         endpoint: endpoint,\n-        keys: {\n-          p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n-          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n-        },\n+        keys: keys,\n       },\n     }.with_indifferent_access\n   end\n@@ -37,6 +40,16 @@\n   let(:token) { Fabricate(:accessible_access_token, resource_owner_id: user.id, scopes: scopes) }\n   let(:headers) { { 'Authorization' => \"Bearer #{token.token}\" } }\n \n+  shared_examples 'validation error' do\n+    it 'returns a validation error' do\n+      subject\n+\n+      expect(response).to have_http_status(422)\n+      expect(endpoint_push_subscriptions.count).to eq(0)\n+      expect(endpoint_push_subscription).to be_nil\n+    end\n+  end\n+\n   describe 'POST /api/v1/push/subscription' do\n     subject { post '/api/v1/push/subscription', params: create_payload, headers: headers }\n \n@@ -68,13 +81,29 @@\n     context 'with invalid endpoint URL' do\n       let(:endpoint) { 'app://example.foo' }\n \n-      it 'returns a validation error' do\n-        subject\n+      it_behaves_like 'validation error'\n+    end\n+\n+    context 'with invalid p256dh key' do\n+      let(:keys) do\n+        {\n+          p256dh: 'BEm_invalidf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n+          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+        }\n+      end\n \n-        expect(response).to have_http_status(422)\n-        expect(endpoint_push_subscriptions.count).to eq(0)\n-        expect(endpoint_push_subscription).to be_nil\n+      it_behaves_like 'validation error'\n+    end\n+\n+    context 'with invalid base64 p256dh key' do\n+      let(:keys) do\n+        {\n+          p256dh: 'not base64',\n+          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+        }\n       end\n+\n+      it_behaves_like 'validation error'\n     end\n   end\n \n---\n\n\n---\n\nChoice B:\nlib/paperclip/response_with_limit_adapter.rb\n@@ -16,7 +16,7 @@ def initialize(target, options = {})\n     private\n \n     def cache_current_values\n-      @original_filename = filename_from_content_disposition.presence || filename_from_path.presence || 'data'\n+      @original_filename = truncated_filename\n       @tempfile = copy_to_tempfile(@target)\n       @content_type = ContentTypeDetector.new(@tempfile.path).detect\n       @size = File.size(@tempfile)\n@@ -43,6 +43,13 @@ def copy_to_tempfile(source)\n       source.response.connection.close\n     end\n \n+    def truncated_filename\n+      filename = filename_from_content_disposition.presence || filename_from_path.presence || 'data'\n+      extension = File.extname(filename)\n+      basename = File.basename(filename, extension)\n+      [basename[...20], extension[..4]].compact_blank.join\n+    end\n+\n     def filename_from_content_disposition\n       disposition = @target.response.headers['content-disposition']\n       disposition&.match(/filename=\"([^\"]*)\"/)&.captures&.first\n---\n\n\n---\n\nChoice C:\napp/controllers/api/v1/notifications/requests_controller.rb\n@@ -52,7 +52,7 @@ def dismiss_bulk\n   private\n \n   def load_requests\n-    requests = NotificationRequest.where(account: current_account).includes(:last_status, from_account: [:account_stat, :user]).to_a_paginated_by_id(\n+    requests = NotificationRequest.where(account: current_account).without_suspended.includes(:last_status, from_account: [:account_stat, :user]).to_a_paginated_by_id(\n       limit_param(DEFAULT_ACCOUNTS_LIMIT),\n       params_slice(:max_id, :since_id, :min_id)\n     )\n---\napp/models/notification_policy.rb\n@@ -62,6 +62,6 @@ def filter_private_mentions=(value)\n   private\n \n   def pending_notification_requests\n-    @pending_notification_requests ||= notification_requests.limit(MAX_MEANINGFUL_COUNT).pick(Arel.sql('count(*), coalesce(sum(notifications_count), 0)::bigint'))\n+    @pending_notification_requests ||= notification_requests.without_suspended.limit(MAX_MEANINGFUL_COUNT).pick(Arel.sql('count(*), coalesce(sum(notifications_count), 0)::bigint'))\n   end\n end\n---\napp/models/notification_request.rb\n@@ -26,6 +26,8 @@ class NotificationRequest < ApplicationRecord\n \n   before_save :prepare_notifications_count\n \n+  scope :without_suspended, -> { joins(:from_account).merge(Account.without_suspended) }\n+\n   def self.preload_cache_collection(requests)\n     cached_statuses_by_id = yield(requests.filter_map(&:last_status)).index_by(&:id) # Call cache_collection in block\n \n---\nspec/models/notification_policy_spec.rb\n@@ -7,19 +7,25 @@\n     subject { Fabricate(:notification_policy) }\n \n     let(:sender) { Fabricate(:account) }\n+    let(:suspended_sender) { Fabricate(:account) }\n \n     before do\n       Fabricate.times(2, :notification, account: subject.account, activity: Fabricate(:status, account: sender), filtered: true, type: :mention)\n       Fabricate(:notification_request, account: subject.account, from_account: sender)\n-      subject.summarize!\n-    end\n \n-    it 'sets pending_requests_count' do\n-      expect(subject.pending_requests_count).to eq 1\n+      Fabricate(:notification, account: subject.account, activity: Fabricate(:status, account: suspended_sender), filtered: true, type: :mention)\n+      Fabricate(:notification_request, account: subject.account, from_account: suspended_sender)\n+\n+      suspended_sender.suspend!\n+\n+      subject.summarize!\n     end\n \n-    it 'sets pending_notifications_count' do\n-      expect(subject.pending_notifications_count).to eq 2\n+    it 'sets pending_requests_count and pending_notifications_count' do\n+      expect(subject).to have_attributes(\n+        pending_requests_count: 1,\n+        pending_notifications_count: 2\n+      )\n     end\n   end\n end\n---\n\n\n---\n\nChoice D:\napp/helpers/email_helper.rb\n@@ -6,13 +6,17 @@ def self.included(base)\n   end\n \n   def email_to_canonical_email(str)\n+    return nil if str.nil?\n+\n     username, domain = str.downcase.split('@', 2)\n     username, = username.delete('.').split('+', 2)\n \n     \"#{username}@#{domain}\"\n   end\n \n   def email_to_canonical_email_hash(str)\n+    return nil if str.nil?\n+\n     Digest::SHA2.new(256).hexdigest(email_to_canonical_email(str))\n   end\n end\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Make a filter, check hide completely.\r\n2. Check your Notifications\r\n\r\n![Screenshot 2024-10-09 160133](https://github.com/user-attachments/assets/b349ceed-09cc-4946-adc8-666db41b98c3)\r\n\r\n\n\n### Expected behaviour\n\nThey should be hidden completely\n\n### Actual behaviour\n\nA container with @ Mention shows up\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nmasto.byrd.ws\n\n### Mastodon version\n\nv4.3\n\n### Browser name and version\n\nFirefox 132\n\n### Operating system\n\nWindows 11\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -5616,7 +5616,7 @@ a.status-card {\n   user-select: text;\n   display: flex;\n \n-  @media screen and (max-width: $no-gap-breakpoint) {\n+  @media screen and (width <= 630px) {\n     margin-top: auto;\n   }\n }\n---\n\n\n---\n\nChoice B:\napp/lib/search_query_parser.rb\n@@ -8,7 +8,7 @@ class SearchQueryParser < Parslet::Parser\n   rule(:operator)  { (str('+') | str('-')).as(:operator) }\n   rule(:prefix)    { term >> colon }\n   rule(:shortcode) { (colon >> term >> colon.maybe).as(:shortcode) }\n-  rule(:phrase)    { (quote >> (term >> space.maybe).repeat >> quote).as(:phrase) }\n+  rule(:phrase)    { (quote >> (match('[^\\s\"]').repeat(1).as(:term) >> space.maybe).repeat >> quote).as(:phrase) }\n   rule(:clause)    { (operator.maybe >> prefix.maybe.as(:prefix) >> (phrase | term | shortcode)).as(:clause) | prefix.as(:clause) | quote.as(:junk) }\n   rule(:query)     { (clause >> space.maybe).repeat.as(:query) }\n   root(:query)\n---\napp/lib/search_query_transformer.rb\n@@ -225,17 +225,16 @@ def language_code_from_term(term)\n   rule(clause: subtree(:clause)) do\n     prefix   = clause[:prefix][:term].to_s if clause[:prefix]\n     operator = clause[:operator]&.to_s\n+    term     = clause[:phrase] ? clause[:phrase].map { |term| term[:term].to_s }.join(' ') : clause[:term].to_s\n \n     if clause[:prefix] && SUPPORTED_PREFIXES.include?(prefix)\n-      PrefixClause.new(prefix, operator, clause[:term].to_s, current_account: current_account)\n+      PrefixClause.new(prefix, operator, term, current_account: current_account)\n     elsif clause[:prefix]\n-      TermClause.new(operator, \"#{prefix} #{clause[:term]}\")\n+      TermClause.new(operator, \"#{prefix} #{term}\")\n     elsif clause[:term]\n-      TermClause.new(operator, clause[:term].to_s)\n-    elsif clause[:shortcode]\n-      TermClause.new(operator, \":#{clause[:term]}:\")\n+      TermClause.new(operator, term)\n     elsif clause[:phrase]\n-      PhraseClause.new(operator, clause[:phrase].is_a?(Array) ? clause[:phrase].map { |p| p[:term].to_s }.join(' ') : clause[:phrase].to_s)\n+      PhraseClause.new(operator, term)\n     else\n       raise \"Unexpected clause type: #{clause}\"\n     end\n---\napp/services/statuses_search_service.rb\n@@ -8,6 +8,7 @@ def call(query, account = nil, options = {})\n     @limit   = options[:limit].to_i\n     @offset  = options[:offset].to_i\n \n+    convert_deprecated_options!\n     status_search_results\n   end\n \n@@ -28,4 +29,25 @@ def status_search_results\n   def parsed_query\n     SearchQueryTransformer.new.apply(SearchQueryParser.new.parse(@query), current_account: @account)\n   end\n+\n+  def convert_deprecated_options!\n+    syntax_options = []\n+\n+    if @options[:account_id]\n+      username = Account.select(:username, :domain).find(@options[:account_id]).acct\n+      syntax_options << \"from:@#{username}\"\n+    end\n+\n+    if @options[:min_id]\n+      timestamp = Mastodon::Snowflake.to_time(@options[:min_id])\n+      syntax_options << \"after:\\\"#{timestamp.iso8601}\\\"\"\n+    end\n+\n+    if @options[:max_id]\n+      timestamp = Mastodon::Snowflake.to_time(@options[:max_id])\n+      syntax_options << \"before:\\\"#{timestamp.iso8601}\\\"\"\n+    end\n+\n+    @query = \"#{@query} #{syntax_options.join(' ')}\".strip if syntax_options.any?\n+  end\n end\n---\nlib/mastodon/snowflake.rb\n@@ -104,6 +104,10 @@ def id_at(timestamp, with_random: true)\n       id\n     end\n \n+    def to_time(id)\n+      Time.at((id >> 16) / 1000).utc\n+    end\n+\n     private\n \n     def already_defined?\n---\nspec/lib/search_query_transformer_spec.rb\n@@ -57,4 +57,24 @@\n       expect(subject.send(:filter_clauses)).to be_empty\n     end\n   end\n+\n+  context 'with \\'\"hello world\"\\'' do\n+    let(:query) { '\"hello world\"' }\n+\n+    it 'transforms clauses' do\n+      expect(subject.send(:must_clauses).map(&:phrase)).to contain_exactly('hello world')\n+      expect(subject.send(:must_not_clauses)).to be_empty\n+      expect(subject.send(:filter_clauses)).to be_empty\n+    end\n+  end\n+\n+  context 'with \\'before:\"2022-01-01 23:00\"\\'' do\n+    let(:query) { 'before:\"2022-01-01 23:00\"' }\n+\n+    it 'transforms clauses' do\n+      expect(subject.send(:must_clauses)).to be_empty\n+      expect(subject.send(:must_not_clauses)).to be_empty\n+      expect(subject.send(:filter_clauses).map(&:term)).to contain_exactly(lt: '2022-01-01 23:00', time_zone: 'UTC')\n+    end\n+  end\n end\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -284,6 +284,7 @@\n   font-size: 11px;\n   padding: 0 3px;\n   line-height: 27px;\n+  white-space: nowrap;\n \n   &:hover,\n   &:active,\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/notifications_v2/components/notification_with_status.tsx\n@@ -13,6 +13,7 @@ import {\n import type { IconProp } from 'mastodon/components/icon';\n import { Icon } from 'mastodon/components/icon';\n import Status from 'mastodon/containers/status_container';\n+import { getStatusHidden } from 'mastodon/selectors/filters';\n import { useAppSelector, useAppDispatch } from 'mastodon/store';\n \n import { DisplayedName } from './displayed_name';\n@@ -48,6 +49,12 @@ export const NotificationWithStatus: React.FC<{\n     (state) => state.statuses.getIn([statusId, 'visibility']) === 'direct',\n   );\n \n+  const isFiltered = useAppSelector(\n+    (state) =>\n+      statusId &&\n+      getStatusHidden(state, { id: statusId, contextType: 'notifications' }),\n+  );\n+\n   const handlers = useMemo(\n     () => ({\n       open: () => {\n@@ -73,7 +80,7 @@ export const NotificationWithStatus: React.FC<{\n     [dispatch, statusId],\n   );\n \n-  if (!statusId) return null;\n+  if (!statusId || isFiltered) return null;\n \n   return (\n     <HotKeys handlers={handlers}>\n---\napp/javascript/mastodon/selectors/filters.ts\n@@ -0,0 +1,50 @@\n+import { createSelector } from '@reduxjs/toolkit';\n+\n+import type { RootState } from 'mastodon/store';\n+import { toServerSideType } from 'mastodon/utils/filters';\n+\n+// TODO: move to `app/javascript/mastodon/models` and use more globally\n+type Filter = Immutable.Map<string, unknown>;\n+\n+// TODO: move to `app/javascript/mastodon/models` and use more globally\n+type FilterResult = Immutable.Map<string, unknown>;\n+\n+export const getFilters = createSelector(\n+  [\n+    (state: RootState) => state.filters as Immutable.Map<string, Filter>,\n+    (_, { contextType }: { contextType: string }) => contextType,\n+  ],\n+  (filters, contextType) => {\n+    if (!contextType) {\n+      return null;\n+    }\n+\n+    const now = new Date();\n+    const serverSideType = toServerSideType(contextType);\n+\n+    return filters.filter((filter) => {\n+      const context = filter.get('context') as Immutable.List<string>;\n+      const expiration = filter.get('expires_at') as Date | null;\n+      return (\n+        context.includes(serverSideType) &&\n+        (expiration === null || expiration > now)\n+      );\n+    });\n+  },\n+);\n+\n+export const getStatusHidden = (\n+  state: RootState,\n+  { id, contextType }: { id: string; contextType: string },\n+) => {\n+  const filters = getFilters(state, { contextType });\n+  if (filters === null) return false;\n+\n+  const filtered = state.statuses.getIn([id, 'filtered']) as\n+    | Immutable.List<FilterResult>\n+    | undefined;\n+  return filtered?.some(\n+    (result) =>\n+      filters.getIn([result.get('filter'), 'filter_action']) === 'hide',\n+  );\n+};\n---\napp/javascript/mastodon/selectors/index.js\n@@ -1,22 +1,11 @@\n import { createSelector } from '@reduxjs/toolkit';\n import { List as ImmutableList, Map as ImmutableMap } from 'immutable';\n \n-import { toServerSideType } from 'mastodon/utils/filters';\n-\n import { me } from '../initial_state';\n \n-export { makeGetAccount } from \"./accounts\";\n-\n-const getFilters = createSelector([state => state.get('filters'), (_, { contextType }) => contextType], (filters, contextType) => {\n-  if (!contextType) {\n-    return null;\n-  }\n+import { getFilters } from './filters';\n \n-  const now = new Date();\n-  const serverSideType = toServerSideType(contextType);\n-\n-  return filters.filter(filter => filter.get('context').includes(serverSideType) && (filter.get('expires_at') === null || filter.get('expires_at') > now));\n-});\n+export { makeGetAccount } from \"./accounts\";\n \n export const makeGetStatus = () => {\n   return createSelector(\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Using Mastodon Social instance.\r\n2. Device and Instance both set in Spanish \r\n3. The official app has been sending all push notifications in English and not Spanish as usual (since five days).\r\n...\r\n\n\n### Expected behaviour\n\nAll push notifications (phone notifications) should be in Spanish as usual \n\n### Actual behaviour\n\nAll push notifications (phone notifications) are being all received in English since five days.\n\n### Detailed description\n\nAbout five days ago push notifications (phone notifications) (using Mastodon official app) are all being received in English. If instance and device are both set in Spanish, and if it has never been any issue, that means that something weird should be happening on someone's side.\r\n\r\nIt's good to say that this is an issue with mastodon.social . It's not that way to other instances.\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nThe latest version \n\n### Browser name and version\n\nChrome for Android last Playstore versi\u00f3n.\n\n### Operating system\n\nAndroid 11\n\n### Technical details\n\nIt's been happening using Mastodon Official app for Android.\r\nHave no log.\r\n\n\n---\n\nChoice A:\napp/workers/web/push_notification_worker.rb\n@@ -55,12 +55,8 @@ def web_push_request\n   end\n \n   def push_notification_json\n-    Oj.dump(serialized_notification_in_subscription_locale.as_json)\n-  end\n-\n-  def serialized_notification_in_subscription_locale\n     I18n.with_locale(@subscription.locale.presence || I18n.default_locale) do\n-      serialized_notification\n+      Oj.dump(serialized_notification.as_json)\n     end\n   end\n \n---\n\n\n---\n\nChoice B:\napp/lib/activitypub/activity/create.rb\n@@ -336,13 +336,15 @@ def resolve_thread(status)\n \n   def fetch_replies(status)\n     collection = @object['replies']\n-    return if collection.nil?\n+    return if collection.blank?\n \n     replies = ActivityPub::FetchRepliesService.new.call(status, collection, allow_synchronous_requests: false, request_id: @options[:request_id])\n     return unless replies.nil?\n \n     uri = value_or_id(collection)\n     ActivityPub::FetchRepliesWorker.perform_async(status.id, uri, { 'request_id' => @options[:request_id] }) unless uri.nil?\n+  rescue => e\n+    Rails.logger.warn \"Error fetching replies: #{e}\"\n   end\n \n   def conversation_from_uri(uri)\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/emoji/unicode_to_filename.js\n@@ -1,29 +0,0 @@\n-/* eslint-disable import/no-commonjs --\n-   We need to use CommonJS here as its imported into a preval file (`emoji_compressed.js`) */\n-\n-// taken from:\n-// https://github.com/twitter/twemoji/blob/47732c7/twemoji-generator.js#L848-L866\n-exports.unicodeToFilename = (str) => {\n-  let result = '';\n-  let charCode = 0;\n-  let p = 0;\n-  let i = 0;\n-  while (i < str.length) {\n-    charCode = str.charCodeAt(i++);\n-    if (p) {\n-      if (result.length > 0) {\n-        result += '-';\n-      }\n-      result += (0x10000 + ((p - 0xD800) << 10) + (charCode - 0xDC00)).toString(16);\n-      p = 0;\n-    } else if (0xD800 <= charCode && charCode <= 0xDBFF) {\n-      p = charCode;\n-    } else {\n-      if (result.length > 0) {\n-        result += '-';\n-      }\n-      result += charCode.toString(16);\n-    }\n-  }\n-  return result;\n-};\n---\napp/javascript/mastodon/features/emoji/unicode_to_unified_name.js\n@@ -1,24 +0,0 @@\n-/* eslint-disable import/no-commonjs --\n-   We need to use CommonJS here as its imported into a preval file (`emoji_compressed.js`) */\n-\n-function padLeft(str, num) {\n-  while (str.length < num) {\n-    str = '0' + str;\n-  }\n-\n-  return str;\n-}\n-\n-exports.unicodeToUnifiedName = (str) => {\n-  let output = '';\n-\n-  for (let i = 0; i < str.length; i += 2) {\n-    if (i > 0) {\n-      output += '-';\n-    }\n-\n-    output += padLeft(str.codePointAt(i).toString(16).toUpperCase(), 4);\n-  }\n-\n-  return output;\n-};\n---\napp/javascript/styles/mailer.scss\n@@ -253,7 +253,7 @@ h5 {\n \n .input {\n   td {\n-    background: darken($ui-base-color, 8%);\n+    background: #ffffff;\n     border-radius: 4px;\n     padding: 16px;\n     line-height: 20px;\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/api_types/accounts.ts\n@@ -13,7 +13,7 @@ export interface ApiAccountRoleJSON {\n }\n \n // See app/serializers/rest/account_serializer.rb\n-export interface ApiAccountJSON {\n+export interface BaseApiAccountJSON {\n   acct: string;\n   avatar: string;\n   avatar_static: string;\n@@ -45,3 +45,12 @@ export interface ApiAccountJSON {\n   memorial?: boolean;\n   hide_collections: boolean;\n }\n+\n+// See app/serializers/rest/muted_account_serializer.rb\n+export interface ApiMutedAccountJSON extends BaseApiAccountJSON {\n+  mute_expires_at?: string | null;\n+}\n+\n+// For now, we have the same type representing both `Account` and `MutedAccount`\n+// objects, but we should refactor this in the future.\n+export type ApiAccountJSON = ApiMutedAccountJSON;\n---\napp/javascript/mastodon/models/account.ts\n@@ -95,6 +95,9 @@ export const accountDefaultValues: AccountShape = {\n   limited: false,\n   moved: null,\n   hide_collections: false,\n+  // This comes from `ApiMutedAccountJSON`, but we should eventually\n+  // store that in a different object.\n+  mute_expires_at: null,\n };\n \n const AccountFactory = ImmutableRecord<AccountShape>(accountDefaultValues);\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nI saw this today on v4.3.0-nightly.2024-10-01 on firefox 130.0.1 snap version on Ubuntu 24.04. Reproduces across many refreshes. I think this is a regression, I feel like I've done this series of steps before but not seen the problem.\r\n\r\nBelow is a video (due to some sort of bug on my computer, the mouse cursor appears fixed in this video, although it is in fact moving).\r\n\r\nSteps in video:\r\n- Start from a new mastodon.social window.\r\n- Do a search (in this search from:mcc, so I get my own posts)\r\n- Select a post with an image. It will appear in the rightmost column.\r\n- Click \u22ef on the post in the rightmost column and choose \"Edit\".\r\n- The image from the edited post ONLY appears floating atop the search column. \r\n\r\n[Screencast from 2024-10-01 17-36-31.webm](https://github.com/user-attachments/assets/8f5eb1b4-ad24-46b7-b002-54939cbce228)\r\n\n\n### Expected behaviour\n\nChoosing \"edit\" should dismiss the search column. If choosing edit does not dismiss the search column, the edit pane appearing \"behind\" the search column and not reappearing until the search column is closed would also be entirely acceptable.\n\n### Actual behaviour\n\nEdit UI appears both behind and in front of the search column.\n\n### Detailed description\n\nIn this video, uBlock Origin is ON and Stylus is OFF.\n\n### Mastodon instance\n\n-\n\n### Mastodon version\n\n-\n\n### Browser name and version\n\n-\n\n### Operating system\n\n-\n\n### Technical details\n\n-\n\n---\n\nChoice A:\napp/controllers/api/v1/notifications/requests_controller.rb\n@@ -52,7 +52,7 @@ def dismiss_bulk\n   private\n \n   def load_requests\n-    requests = NotificationRequest.where(account: current_account).includes(:last_status, from_account: [:account_stat, :user]).to_a_paginated_by_id(\n+    requests = NotificationRequest.where(account: current_account).without_suspended.includes(:last_status, from_account: [:account_stat, :user]).to_a_paginated_by_id(\n       limit_param(DEFAULT_ACCOUNTS_LIMIT),\n       params_slice(:max_id, :since_id, :min_id)\n     )\n---\napp/models/notification_policy.rb\n@@ -62,6 +62,6 @@ def filter_private_mentions=(value)\n   private\n \n   def pending_notification_requests\n-    @pending_notification_requests ||= notification_requests.limit(MAX_MEANINGFUL_COUNT).pick(Arel.sql('count(*), coalesce(sum(notifications_count), 0)::bigint'))\n+    @pending_notification_requests ||= notification_requests.without_suspended.limit(MAX_MEANINGFUL_COUNT).pick(Arel.sql('count(*), coalesce(sum(notifications_count), 0)::bigint'))\n   end\n end\n---\napp/models/notification_request.rb\n@@ -26,6 +26,8 @@ class NotificationRequest < ApplicationRecord\n \n   before_save :prepare_notifications_count\n \n+  scope :without_suspended, -> { joins(:from_account).merge(Account.without_suspended) }\n+\n   def self.preload_cache_collection(requests)\n     cached_statuses_by_id = yield(requests.filter_map(&:last_status)).index_by(&:id) # Call cache_collection in block\n \n---\nspec/models/notification_policy_spec.rb\n@@ -7,19 +7,25 @@\n     subject { Fabricate(:notification_policy) }\n \n     let(:sender) { Fabricate(:account) }\n+    let(:suspended_sender) { Fabricate(:account) }\n \n     before do\n       Fabricate.times(2, :notification, account: subject.account, activity: Fabricate(:status, account: sender), filtered: true, type: :mention)\n       Fabricate(:notification_request, account: subject.account, from_account: sender)\n-      subject.summarize!\n-    end\n \n-    it 'sets pending_requests_count' do\n-      expect(subject.pending_requests_count).to eq 1\n+      Fabricate(:notification, account: subject.account, activity: Fabricate(:status, account: suspended_sender), filtered: true, type: :mention)\n+      Fabricate(:notification_request, account: subject.account, from_account: suspended_sender)\n+\n+      suspended_sender.suspend!\n+\n+      subject.summarize!\n     end\n \n-    it 'sets pending_notifications_count' do\n-      expect(subject.pending_notifications_count).to eq 2\n+    it 'sets pending_requests_count and pending_notifications_count' do\n+      expect(subject).to have_attributes(\n+        pending_requests_count: 1,\n+        pending_notifications_count: 2\n+      )\n     end\n   end\n end\n---\n\n\n---\n\nChoice B:\napp/helpers/languages_helper.rb\n@@ -254,6 +254,7 @@ def standard_locale_name(locale)\n \n   def valid_locale_or_nil(str)\n     return if str.blank?\n+    return str if valid_locale?(str)\n \n     code, = str.to_s.split(/[_-]/) # Strip out the region from e.g. en_US or ja-JP\n \n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -10453,7 +10453,7 @@ noscript {\n       gap: 4px;\n \n       dt {\n-        flex: 0 0 auto;\n+        flex: 0 1 auto;\n         color: $dark-text-color;\n         min-width: 0;\n         overflow: hidden;\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -3611,6 +3611,7 @@ $ui-header-logo-wordmark-width: 99px;\n   overflow-y: auto;\n   width: 100%;\n   height: 100%;\n+  z-index: 0;\n }\n \n .drawer__inner__mastodon {\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Setup a server with OMNIAUTH_ONLY configured\r\n2. Try clicking the login button on the main webpage\r\n\r\n\r\n### Expected behaviour\r\n\r\ncan get redirected to provider\r\n\r\n### Actual behaviour\r\n\r\nget csp error in console\r\n\r\n### Detailed description\r\n\r\ni suspect that https://github.com/mastodon/mastodon/pull/26897 broke omniauth_only.\r\nthe login button on the main page would redirect to https://INSTANCE/auth/auth/openid_connect which then takes you to the oidc provider. this is blocked by the new form-action policy. turning off omniauth_only makes it work as does logging in via /auth/sign_in.\r\nI was able to fix this by hardcoding p.form_action in the web app controller concern to be https://INSTANCE/auth/auth/openid_connect . i've reverted the change for now to showcase current behaviour.\r\n\r\n### Mastodon instance\r\n\r\nm.fa.gl\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-beta.2\r\n\r\n### Browser name and version\r\n\r\nFirefox 130, Edge 129\r\n\r\n### Operating system\r\n\r\nWindows 11\r\n\r\n### Technical details\r\n\r\nCSP error in console:\r\n>  Refused to send form data to 'https://m.fa.gl/auth/auth/openid_connect' because it violates the following Content Security Policy directive: \"form-action https://auth.home.fa.gl/api/oidc/authorization\".\r\n\n\n---\n\nChoice A:\npublic/embed.js\n@@ -81,7 +81,7 @@ const allowedPrefixes = (document.currentScript && document.currentScript.tagNam\n       embeds.set(id, iframe);\n \n       iframe.allow = 'fullscreen';\n-      iframe.sandbox = 'allow-scripts allow-same-origin';\n+      iframe.sandbox = 'allow-scripts allow-same-origin allow-popups';\n       iframe.style.border = 0;\n       iframe.style.overflow = 'hidden';\n       iframe.style.display = 'block';\n@@ -112,7 +112,7 @@ const allowedPrefixes = (document.currentScript && document.currentScript.tagNam\n       iframe.width = container.clientWidth;\n       iframe.height = 0;\n       iframe.allow = 'fullscreen';\n-      iframe.sandbox = 'allow-scripts allow-same-origin';\n+      iframe.sandbox = 'allow-scripts allow-same-origin allow-popups';\n       iframe.style.border = 0;\n       iframe.style.overflow = 'hidden';\n       iframe.style.display = 'block';\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/compose/components/compose_form.jsx\n@@ -216,7 +216,7 @@ class ComposeForm extends ImmutablePureComponent {\n \n   handleEmojiPick = (data) => {\n     const { text }     = this.props;\n-    const position     = this.textarea.selectionStart;\n+    const position     = this.textareaRef.current.selectionStart;\n     const needsSpace   = data.custom && position > 0 && !allowedAroundShortCode.includes(text[position - 1]);\n \n     this.props.onPickEmoji(position, data, needsSpace);\n---\n\n\n---\n\nChoice C:\napp/controllers/concerns/web_app_controller_concern.rb\n@@ -11,7 +11,7 @@ module WebAppControllerConcern\n   end\n \n   def skip_csrf_meta_tags?\n-    !(ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1) && current_user.nil?\n+    !(ENV['ONE_CLICK_SSO_LOGIN'] == 'true' && ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1) && current_user.nil?\n   end\n \n   def set_app_body_class\n---\napp/serializers/initial_state_serializer.rb\n@@ -113,6 +113,6 @@ def instance_presenter\n   end\n \n   def sso_redirect\n-    \"/auth/auth/#{Devise.omniauth_providers[0]}\" if ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1\n+    \"/auth/auth/#{Devise.omniauth_providers[0]}\" if ENV['ONE_CLICK_SSO_LOGIN'] == 'true' && ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1\n   end\n end\n---\nconfig/initializers/content_security_policy.rb\n@@ -19,6 +19,22 @@ def host_to_url(str)\n media_host ||= host_to_url(ENV['S3_HOSTNAME']) if ENV['S3_ENABLED'] == 'true'\n media_host ||= assets_host\n \n+def sso_host\n+  return unless ENV['ONE_CLICK_SSO_LOGIN'] == 'true'\n+  return unless ENV['OMNIAUTH_ONLY'] == 'true'\n+  return unless Devise.omniauth_providers.length == 1\n+\n+  provider = Devise.omniauth_configs[Devise.omniauth_providers[0]]\n+  @sso_host ||= begin\n+    # using CAS\n+    provider.cas_url if ENV['CAS_ENABLED'] == 'true'\n+    # using SAML\n+    provider.options[:idp_sso_target_url] if ENV['SAML_ENABLED'] == 'true'\n+    # or using OIDC\n+    ENV['OIDC_AUTH_ENDPOINT'] || (OpenIDConnect::Discovery::Provider::Config.discover!(ENV['OIDC_ISSUER']).authorization_endpoint if ENV['OIDC_ENABLED'] == 'true')\n+  end\n+end\n+\n Rails.application.config.content_security_policy do |p|\n   p.base_uri        :none\n   p.default_src     :none\n@@ -29,7 +45,13 @@ def host_to_url(str)\n   p.media_src       :self, :https, :data, assets_host\n   p.frame_src       :self, :https\n   p.manifest_src    :self, assets_host\n-  p.form_action     :self\n+\n+  if sso_host.present?\n+    p.form_action     :self, sso_host\n+  else\n+    p.form_action     :self\n+  end\n+\n   p.child_src       :self, :blob, assets_host\n   p.worker_src      :self, :blob, assets_host\n \n---\n\n\n---\n\nChoice D:\napp/controllers/concerns/web_app_controller_concern.rb\n@@ -13,7 +13,7 @@ module WebAppControllerConcern\n       policy = ContentSecurityPolicy.new\n \n       if policy.sso_host.present?\n-        p.form_action policy.sso_host\n+        p.form_action policy.sso_host, -> { \"https://#{request.host}/auth/auth/\" }\n       else\n         p.form_action :none\n       end\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Click \"Get embed code\" on any Mastodon post\r\n2. Publish the generated embed code on any website\r\n3. Go to the website and click on any link within the embed iframe\r\n4. Links do not open and browser shows console message `Blocked opening '[...]' in a new window because the request was made in a sandboxed frame whose 'allow-popups' permission is not set.`\n\n### Expected behaviour\n\nUser should be able to click on links within IFrame and they should open the corresponding Mastodon post, user profile, etc.\n\n### Actual behaviour\n\nBrowser blocks opening of links\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.3.0-nightly.2024-09-26\n\n### Browser name and version\n\nGoogle Chrome Version 129.0.6668.70 (Official Build) (64-bit)\n\n### Operating system\n\nUbuntu 24.04.01\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/services/fetch_link_card_service.rb\n@@ -106,12 +106,11 @@ def skip_link?(anchor)\n   end\n \n   def attempt_oembed\n-    service         = FetchOEmbedService.new\n-    url_domain      = Addressable::URI.parse(@url).normalized_host\n-    cached_endpoint = Rails.cache.read(\"oembed_endpoint:#{url_domain}\")\n+    service = FetchOEmbedService.new\n \n-    embed   = service.call(@url, cached_endpoint: cached_endpoint) unless cached_endpoint.nil?\n+    embed   = service.call(@url, use_cached_endpoint: true)\n     embed ||= service.call(@url, html: html) unless html.nil?\n+    embed ||= service.call(@url, use_cached_endpoint: true) if @url != @original_url.to_s\n \n     return false if embed.nil?\n \n---\napp/services/fetch_oembed_service.rb\n@@ -10,7 +10,7 @@ def call(url, options = {})\n     @url     = url\n     @options = options\n \n-    if @options[:cached_endpoint]\n+    if @options[:use_cached_endpoint]\n       parse_cached_endpoint!\n     else\n       discover_endpoint!\n@@ -57,9 +57,9 @@ def discover_endpoint!\n   end\n \n   def parse_cached_endpoint!\n-    cached = @options[:cached_endpoint]\n+    cached = Rails.cache.read(cache_key)\n \n-    return if cached[:endpoint].nil? || cached[:format].nil?\n+    return if cached.nil? || cached[:endpoint].nil? || cached[:format].nil?\n \n     @endpoint_url = Addressable::Template.new(cached[:endpoint]).expand(url: @url).to_s\n     @format       = cached[:format]\n@@ -68,14 +68,16 @@ def parse_cached_endpoint!\n   def cache_endpoint!\n     return unless URL_REGEX.match?(@endpoint_url)\n \n-    url_domain = Addressable::URI.parse(@url).normalized_host\n-\n     endpoint_hash = {\n       endpoint: @endpoint_url.gsub(URL_REGEX, '={url}'),\n       format: @format,\n     }\n \n-    Rails.cache.write(\"oembed_endpoint:#{url_domain}\", endpoint_hash, expires_in: ENDPOINT_CACHE_EXPIRES_IN)\n+    Rails.cache.write(cache_key, endpoint_hash, expires_in: ENDPOINT_CACHE_EXPIRES_IN)\n+  end\n+\n+  def cache_key\n+    \"oembed_endpoint:#{Addressable::URI.parse(@url).normalized_host}\"\n   end\n \n   def fetch!\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -13,6 +13,7 @@\n     stub_request(:get, 'http://example.com/not-found').to_return(status: 404, headers: { 'Content-Type' => 'text/html' }, body: html)\n     stub_request(:get, 'http://example.com/text').to_return(status: 404, headers: { 'Content-Type' => 'text/plain' }, body: 'Hello')\n     stub_request(:get, 'http://example.com/redirect').to_return(status: 302, headers: { 'Location' => 'http://example.com/html' })\n+    stub_request(:get, 'http://example.net/redirect-to-other-domain').to_return(status: 302, headers: { 'Location' => 'http://example.com/html' })\n     stub_request(:get, 'http://example.com/redirect-to-404').to_return(status: 302, headers: { 'Location' => 'http://example.com/not-found' })\n     stub_request(:get, 'http://example.com/oembed?url=http://example.com/html').to_return(headers: { 'Content-Type' => 'application/json' }, body: '{ \"version\": \"1.0\", \"type\": \"link\", \"title\": \"oEmbed title\" }')\n     stub_request(:get, 'http://example.com/oembed?format=json&url=http://example.com/html').to_return(headers: { 'Content-Type' => 'application/json' }, body: '{ \"version\": \"1.0\", \"type\": \"link\", \"title\": \"oEmbed title\" }')\n@@ -264,6 +265,39 @@\n         end\n       end\n \n+      context 'when oEmbed endpoint cache populated with redirect target' do\n+        let(:status) { Fabricate(:status, text: 'http://example.net/redirect-to-other-domain') }\n+        let(:oembed_cache) { { endpoint: 'http://example.com/oembed?format=json&url={url}', format: :json } }\n+\n+        it 'uses the cached oEmbed response' do\n+          expect(a_request(:get, 'http://example.net/redirect-to-other-domain')).to have_been_made\n+          expect(a_request(:get, 'http://example.com/oembed?url=http://example.com/html')).to have_been_made\n+        end\n+\n+        it 'creates preview card' do\n+          expect(status.preview_card).to_not be_nil\n+          expect(status.preview_card.url).to eq 'http://example.com/html'\n+          expect(status.preview_card.title).to eq 'oEmbed title'\n+        end\n+      end\n+\n+      context 'when oEmbed endpoint cache populated with redirect target but page contains no oEmbed tags' do\n+        let(:status) { Fabricate(:status, text: 'http://example.net/redirect-to-other-domain') }\n+        let(:html) { 'Please fill out CAPTCHA' }\n+        let(:oembed_cache) { { endpoint: 'http://example.com/oembed?format=json&url={url}', format: :json } }\n+\n+        it 'uses the cached oEmbed response' do\n+          expect(a_request(:get, 'http://example.net/redirect-to-other-domain')).to have_been_made\n+          expect(a_request(:get, 'http://example.com/oembed?format=json&url=http://example.com/html')).to have_been_made\n+        end\n+\n+        it 'creates preview card' do\n+          expect(status.preview_card).to_not be_nil\n+          expect(status.preview_card.url).to eq 'http://example.com/html'\n+          expect(status.preview_card.title).to eq 'oEmbed title'\n+        end\n+      end\n+\n       # If the original HTML URL for whatever reason (e.g. DOS protection) redirects to\n       # an error page, we can still use the cached oEmbed but should not use the\n       # redirect URL on the card.\n---\nspec/services/fetch_oembed_service_spec.rb\n@@ -160,10 +160,12 @@\n           headers: { 'Content-Type': 'text/html' },\n           body: request_fixture('oembed_json_empty.html')\n         )\n+\n+        Rails.cache.write('oembed_endpoint:www.youtube.com', { endpoint: 'http://www.youtube.com/oembed?format=json&url={url}', format: :json })\n       end\n \n       it 'returns new provider without fetching original URL first' do\n-        subject.call('https://www.youtube.com/watch?v=dqwpQarrDwk', cached_endpoint: { endpoint: 'http://www.youtube.com/oembed?format=json&url={url}', format: :json })\n+        subject.call('https://www.youtube.com/watch?v=dqwpQarrDwk', use_cached_endpoint: true)\n         expect(a_request(:get, 'https://www.youtube.com/watch?v=dqwpQarrDwk')).to_not have_been_made\n         expect(subject.endpoint_url).to eq 'http://www.youtube.com/oembed?format=json&url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DdqwpQarrDwk'\n         expect(subject.format).to eq :json\n---\napp/lib/link_details_extractor.rb\n@@ -225,7 +225,7 @@ def host_to_url(str)\n   end\n \n   def valid_url_or_nil(str, same_origin_only: false)\n-    return if str.blank? || str == 'null'\n+    return if str.blank? || str == 'null' || str == 'undefined'\n \n     url = @original_url + Addressable::URI.parse(str)\n \n---\nspec/lib/link_details_extractor_spec.rb\n@@ -33,6 +33,14 @@\n         expect(subject.canonical_url).to eq original_url\n       end\n     end\n+\n+    context 'when canonical URL is set to \"undefined\"' do\n+      let(:url) { 'undefined' }\n+\n+      it 'ignores the canonical URLs' do\n+        expect(subject.canonical_url).to eq original_url\n+      end\n+    end\n   end\n \n   context 'when only basic metadata is present' do\n---\n\n\n---\n\nChoice B:\napp/controllers/concerns/web_app_controller_concern.rb\n@@ -13,7 +13,7 @@ module WebAppControllerConcern\n       policy = ContentSecurityPolicy.new\n \n       if policy.sso_host.present?\n-        p.form_action policy.sso_host\n+        p.form_action policy.sso_host, -> { \"https://#{request.host}/auth/auth/\" }\n       else\n         p.form_action :none\n       end\n---\n\n\n---\n\nChoice C:\npublic/embed.js\n@@ -81,7 +81,7 @@ const allowedPrefixes = (document.currentScript && document.currentScript.tagNam\n       embeds.set(id, iframe);\n \n       iframe.allow = 'fullscreen';\n-      iframe.sandbox = 'allow-scripts allow-same-origin';\n+      iframe.sandbox = 'allow-scripts allow-same-origin allow-popups';\n       iframe.style.border = 0;\n       iframe.style.overflow = 'hidden';\n       iframe.style.display = 'block';\n@@ -112,7 +112,7 @@ const allowedPrefixes = (document.currentScript && document.currentScript.tagNam\n       iframe.width = container.clientWidth;\n       iframe.height = 0;\n       iframe.allow = 'fullscreen';\n-      iframe.sandbox = 'allow-scripts allow-same-origin';\n+      iframe.sandbox = 'allow-scripts allow-same-origin allow-popups';\n       iframe.style.border = 0;\n       iframe.style.overflow = 'hidden';\n       iframe.style.display = 'block';\n---\n\n\n---\n\nChoice D:\napp/models/tag.rb\n@@ -35,7 +35,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?<![=/)[:word]])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)\\w])#(#{HASHTAG_NAME_PAT})}i\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/tag_spec.rb\n@@ -32,6 +32,10 @@\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)#Lawsuit')).to be_nil\n     end\n \n+    it 'does not match URLs with hashtag-like anchors after a numeral' do\n+      expect(subject.match('https://gcc.gnu.org/bugzilla/show_bug.cgi?id=111895#c4')).to be_nil\n+    end\n+\n     it 'does not match URLs with hashtag-like anchors after an empty query parameter' do\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)?foo=#Lawsuit')).to be_nil\n     end\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Receive status\r\n2. Check sidekiq morgue for failed jobs\r\n3. See failed `activitypub::ProcessingWorker` jobs with the error `Regexp::TimeoutError: regexp match timeout`\r\n4. Attempting to view the status manually results in an http 500\n\n### Expected behaviour\n\nFor the status to be processed and delivered locally\n\n### Actual behaviour\n\nThe status cannot be processed and is never delivered locally\n\n### Detailed description\n\nAn example status received:\r\n```\r\n109498147060647699, \"{\\\"@context\\\":[\\\"https://www.w3.org/ns/activitystreams\\\",{\\\"ostatus\\\":\\\"http://ostatus.org#\\\",\\\"atomUri\\\":\\\"ostatus:atomUri\\\",\\\"inReplyToAtomUri\\\":\\\"ostatus:inReplyToAtomUri\\\",\\\"conversation\\\":\\\"ostatus:conversation\\\",\\\"sensitive\\\":\\\"as:sensitive\\\",\\\"toot\\\":\\\"http://joinmastodon.org/ns#\\\",\\\"votersCount\\\":\\\"toot:votersCount\\\",\\\"blurhash\\\":\\\"toot:blurhash\\\",\\\"focalPoint\\\":{\\\"@container\\\":\\\"@list\\\",\\\"@id\\\":\\\"toot:focalPoint\\\"},\\\"Hashtag\\\":\\\"as:Hashtag\\\"},\\\"https://w3id.org/security/v1\\\"],\\\"id\\\":\\\"https://mastodon.social/users/gwaldby/statuses/113187318090872531/activity\\\",\\\"type\\\":\\\"Create\\\",\\\"actor\\\":\\\"https://mastodon.social/users/gwaldby\\\",\\\"published\\\":\\\"2024-09-23T14:23:31Z\\\",\\\"to\\\":[\\\"https://www.w3.org/ns/activitystreams#Public\\\"],\\\"cc\\\":[\\\"https://mastodon.social/users/gwaldby/followers\\\"],\\\"object\\\":{\\\"id\\\":\\\"https://mastodon.social/users/gwaldby/statuses/113187318090872531\\\",\\\"type\\\":\\\"Note\\\",\\\"summary\\\":null,\\\"inReplyTo\\\":null,\\\"published\\\":\\\"2024-09-23T14:23:31Z\\\",\\\"url\\\":\\\"https://mastodon.social/@gwaldby/113187318090872531\\\",\\\"attributedTo\\\":\\\"https://mastodon.social/users/gwaldby\\\",\\\"to\\\":[\\\"https://www.w3.org/ns/activitystreams#Public\\\"],\\\"cc\\\":[\\\"https://mastodon.social/users/gwaldby/followers\\\"],\\\"sensitive\\\":false,\\\"atomUri\\\":\\\"https://mastodon.social/users/gwaldby/statuses/113187318090872531\\\",\\\"inReplyToAtomUri\\\":null,\\\"conversation\\\":\\\"tag:mastodon.social,2024-09-23:objectId=805965626:objectType=Conversation\\\",\\\"content\\\":\\\"\\\\u003cp\\\\u003eJosh Riley is running for Congress with a promise: he will never take a penny from corporate PACs because he\\\\u0026#39;s fighting for neighborhoods like the one that raised \u2013-not the special interests. \\\\u003ca href=\\\\\\\"https://mastodon.social/tags/BlueWaveRising\\\\\\\" class=\\\\\\\"mention hashtag\\\\\\\" rel=\\\\\\\"tag\\\\\\\"\\\\u003e#\\\\u003cspan\\\\u003eBlueWaveRising\\\\u003c/span\\\\u003e\\\\u003c/a\\\\u003e \\\\u003ca href=\\\\\\\"https://mastodon.social/tags/NY19\\\\\\\" class=\\\\\\\"mention hashtag\\\\\\\" rel=\\\\\\\"tag\\\\\\\"\\\\u003e#\\\\u003cspan\\\\u003eNY19\\\\u003c/span\\\\u003e\\\\u003c/a\\\\u003e\\\\u003c/p\\\\u003e\\\",\\\"contentMap\\\":{\\\"en\\\":\\\"\\\\u003cp\\\\u003eJosh Riley is running for Congress with a promise: he will never take a penny from corporate PACs because he\\\\u0026#39;s fighting for neighborhoods like the one that raised \u2013-not the special interests. \\\\u003ca href=\\\\\\\"https://mastodon.social/tags/BlueWaveRising\\\\\\\" class=\\\\\\\"mention hashtag\\\\\\\" rel=\\\\\\\"tag\\\\\\\"\\\\u003e#\\\\u003cspan\\\\u003eBlueWaveRising\\\\u003c/span\\\\u003e\\\\u003c/a\\\\u003e \\\\u003ca href=\\\\\\\"https://mastodon.social/tags/NY19\\\\\\\" class=\\\\\\\"mention hashtag\\\\\\\" rel=\\\\\\\"tag\\\\\\\"\\\\u003e#\\\\u003cspan\\\\u003eNY19\\\\u003c/span\\\\u003e\\\\u003c/a\\\\u003e\\\\u003c/p\\\\u003e\\\"},\\\"attachment\\\":[{\\\"type\\\":\\\"Document\\\",\\\"mediaType\\\":\\\"video/mp4\\\",\\\"url\\\":\\\"https://files.mastodon.social/media_attachments/files/113/187/316/991/092/664/original/900a9dfa0b6a85d1.mp4\\\",\\\"name\\\":null,\\\"blurhash\\\":\\\"UKH{ZsMc4TMwJE8^t7j^MbV?IU%gt7Rjoex]\\\",\\\"width\\\":1920,\\\"height\\\":1080}],\\\"tag\\\":[{\\\"type\\\":\\\"Hashtag\\\",\\\"href\\\":\\\"https://mastodon.social/tags/bluewaverising\\\",\\\"name\\\":\\\"#bluewaverising\\\"},{\\\"type\\\":\\\"Hashtag\\\",\\\"href\\\":\\\"https://mastodon.social/tags/ny19\\\",\\\"name\\\":\\\"#ny19\\\"}],\\\"replies\\\":{\\\"id\\\":\\\"https://mastodon.social/users/gwaldby/statuses/113187318090872531/replies\\\",\\\"type\\\":\\\"Collection\\\",\\\"first\\\":{\\\"type\\\":\\\"CollectionPage\\\",\\\"next\\\":\\\"https://mastodon.social/users/gwaldby/statuses/113187318090872531/replies?only_other_accounts=true\\\\u0026page=true\\\",\\\"partOf\\\":\\\"https://mastodon.social/users/gwaldby/statuses/113187318090872531/replies\\\",\\\"items\\\":[]}}},\\\"signature\\\":{\\\"type\\\":\\\"RsaSignature2017\\\",\\\"creator\\\":\\\"https://mastodon.social/users/gwaldby#main-key\\\",\\\"created\\\":\\\"2024-09-23T14:23:31Z\\\",\\\"signatureValue\\\":\\\"niqGozMzferTAQSLIHwDAl/vIbPbIKFB/C7aXnxHxjS8wnFsMFyOoI+F2Jsy/ckn181fYVYCswYO2M2VYm6xAd0QS854CK96Loq6Mc1LnnXCDlLWGrLEe4Szx6PSRss1aISlGpEHH9yFXyGFpqphZL0Z+bwve9pSj+ahjKjRCRQ/fh0VPfnxZzmXjiFGMbO68TXZfq2WGOSZLKuT0tf5dCVaWechl8NkH8Nc6XF1vXt2jM7rrHqsSZFg7Kk9J9VujhfCOypHRD6O4+Lqvp7Bkl5OYbm31LTn3JkCCCFXyNtGFOizcFTAUhVl9T3Kzz07h734c8YRFr8qIGwk+K54/A==\\\"}}\", nil, \"Account\"\r\n```\r\n\r\nThe backtrace:\r\n```\r\n/home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/httplog-1.7.0/lib/httplog/http_log.rb:271:in `gsub'\r\n/home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/httplog-1.7.0/lib/httplog/http_log.rb:271:in `block in masked'\r\n/home/mastodon/live/vendor/bundle/ruby/3.3.0/gems/httplog-1.7.0/lib/httplog/http_log.rb:269:in `each'\r\n```\n\n### Mastodon instance\n\nraphus.social\n\n### Mastodon version\n\nv4.3.0-beta2\n\n### Technical details\n\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: ruby 3.3.5 (2024-09-03 revision ef084cc8f4) [x86_64-linux]\r\n- Node.js version: v20.5.1\r\n\n\n---\n\nChoice A:\napp/services/fetch_link_card_service.rb\n@@ -106,12 +106,11 @@ def skip_link?(anchor)\n   end\n \n   def attempt_oembed\n-    service         = FetchOEmbedService.new\n-    url_domain      = Addressable::URI.parse(@url).normalized_host\n-    cached_endpoint = Rails.cache.read(\"oembed_endpoint:#{url_domain}\")\n+    service = FetchOEmbedService.new\n \n-    embed   = service.call(@url, cached_endpoint: cached_endpoint) unless cached_endpoint.nil?\n+    embed   = service.call(@url, use_cached_endpoint: true)\n     embed ||= service.call(@url, html: html) unless html.nil?\n+    embed ||= service.call(@url, use_cached_endpoint: true) if @url != @original_url.to_s\n \n     return false if embed.nil?\n \n---\napp/services/fetch_oembed_service.rb\n@@ -10,7 +10,7 @@ def call(url, options = {})\n     @url     = url\n     @options = options\n \n-    if @options[:cached_endpoint]\n+    if @options[:use_cached_endpoint]\n       parse_cached_endpoint!\n     else\n       discover_endpoint!\n@@ -57,9 +57,9 @@ def discover_endpoint!\n   end\n \n   def parse_cached_endpoint!\n-    cached = @options[:cached_endpoint]\n+    cached = Rails.cache.read(cache_key)\n \n-    return if cached[:endpoint].nil? || cached[:format].nil?\n+    return if cached.nil? || cached[:endpoint].nil? || cached[:format].nil?\n \n     @endpoint_url = Addressable::Template.new(cached[:endpoint]).expand(url: @url).to_s\n     @format       = cached[:format]\n@@ -68,14 +68,16 @@ def parse_cached_endpoint!\n   def cache_endpoint!\n     return unless URL_REGEX.match?(@endpoint_url)\n \n-    url_domain = Addressable::URI.parse(@url).normalized_host\n-\n     endpoint_hash = {\n       endpoint: @endpoint_url.gsub(URL_REGEX, '={url}'),\n       format: @format,\n     }\n \n-    Rails.cache.write(\"oembed_endpoint:#{url_domain}\", endpoint_hash, expires_in: ENDPOINT_CACHE_EXPIRES_IN)\n+    Rails.cache.write(cache_key, endpoint_hash, expires_in: ENDPOINT_CACHE_EXPIRES_IN)\n+  end\n+\n+  def cache_key\n+    \"oembed_endpoint:#{Addressable::URI.parse(@url).normalized_host}\"\n   end\n \n   def fetch!\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -13,6 +13,7 @@\n     stub_request(:get, 'http://example.com/not-found').to_return(status: 404, headers: { 'Content-Type' => 'text/html' }, body: html)\n     stub_request(:get, 'http://example.com/text').to_return(status: 404, headers: { 'Content-Type' => 'text/plain' }, body: 'Hello')\n     stub_request(:get, 'http://example.com/redirect').to_return(status: 302, headers: { 'Location' => 'http://example.com/html' })\n+    stub_request(:get, 'http://example.net/redirect-to-other-domain').to_return(status: 302, headers: { 'Location' => 'http://example.com/html' })\n     stub_request(:get, 'http://example.com/redirect-to-404').to_return(status: 302, headers: { 'Location' => 'http://example.com/not-found' })\n     stub_request(:get, 'http://example.com/oembed?url=http://example.com/html').to_return(headers: { 'Content-Type' => 'application/json' }, body: '{ \"version\": \"1.0\", \"type\": \"link\", \"title\": \"oEmbed title\" }')\n     stub_request(:get, 'http://example.com/oembed?format=json&url=http://example.com/html').to_return(headers: { 'Content-Type' => 'application/json' }, body: '{ \"version\": \"1.0\", \"type\": \"link\", \"title\": \"oEmbed title\" }')\n@@ -264,6 +265,39 @@\n         end\n       end\n \n+      context 'when oEmbed endpoint cache populated with redirect target' do\n+        let(:status) { Fabricate(:status, text: 'http://example.net/redirect-to-other-domain') }\n+        let(:oembed_cache) { { endpoint: 'http://example.com/oembed?format=json&url={url}', format: :json } }\n+\n+        it 'uses the cached oEmbed response' do\n+          expect(a_request(:get, 'http://example.net/redirect-to-other-domain')).to have_been_made\n+          expect(a_request(:get, 'http://example.com/oembed?url=http://example.com/html')).to have_been_made\n+        end\n+\n+        it 'creates preview card' do\n+          expect(status.preview_card).to_not be_nil\n+          expect(status.preview_card.url).to eq 'http://example.com/html'\n+          expect(status.preview_card.title).to eq 'oEmbed title'\n+        end\n+      end\n+\n+      context 'when oEmbed endpoint cache populated with redirect target but page contains no oEmbed tags' do\n+        let(:status) { Fabricate(:status, text: 'http://example.net/redirect-to-other-domain') }\n+        let(:html) { 'Please fill out CAPTCHA' }\n+        let(:oembed_cache) { { endpoint: 'http://example.com/oembed?format=json&url={url}', format: :json } }\n+\n+        it 'uses the cached oEmbed response' do\n+          expect(a_request(:get, 'http://example.net/redirect-to-other-domain')).to have_been_made\n+          expect(a_request(:get, 'http://example.com/oembed?format=json&url=http://example.com/html')).to have_been_made\n+        end\n+\n+        it 'creates preview card' do\n+          expect(status.preview_card).to_not be_nil\n+          expect(status.preview_card.url).to eq 'http://example.com/html'\n+          expect(status.preview_card.title).to eq 'oEmbed title'\n+        end\n+      end\n+\n       # If the original HTML URL for whatever reason (e.g. DOS protection) redirects to\n       # an error page, we can still use the cached oEmbed but should not use the\n       # redirect URL on the card.\n---\nspec/services/fetch_oembed_service_spec.rb\n@@ -160,10 +160,12 @@\n           headers: { 'Content-Type': 'text/html' },\n           body: request_fixture('oembed_json_empty.html')\n         )\n+\n+        Rails.cache.write('oembed_endpoint:www.youtube.com', { endpoint: 'http://www.youtube.com/oembed?format=json&url={url}', format: :json })\n       end\n \n       it 'returns new provider without fetching original URL first' do\n-        subject.call('https://www.youtube.com/watch?v=dqwpQarrDwk', cached_endpoint: { endpoint: 'http://www.youtube.com/oembed?format=json&url={url}', format: :json })\n+        subject.call('https://www.youtube.com/watch?v=dqwpQarrDwk', use_cached_endpoint: true)\n         expect(a_request(:get, 'https://www.youtube.com/watch?v=dqwpQarrDwk')).to_not have_been_made\n         expect(subject.endpoint_url).to eq 'http://www.youtube.com/oembed?format=json&url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DdqwpQarrDwk'\n         expect(subject.format).to eq :json\n---\napp/lib/link_details_extractor.rb\n@@ -225,7 +225,7 @@ def host_to_url(str)\n   end\n \n   def valid_url_or_nil(str, same_origin_only: false)\n-    return if str.blank? || str == 'null'\n+    return if str.blank? || str == 'null' || str == 'undefined'\n \n     url = @original_url + Addressable::URI.parse(str)\n \n---\nspec/lib/link_details_extractor_spec.rb\n@@ -33,6 +33,14 @@\n         expect(subject.canonical_url).to eq original_url\n       end\n     end\n+\n+    context 'when canonical URL is set to \"undefined\"' do\n+      let(:url) { 'undefined' }\n+\n+      it 'ignores the canonical URLs' do\n+        expect(subject.canonical_url).to eq original_url\n+      end\n+    end\n   end\n \n   context 'when only basic metadata is present' do\n---\n\n\n---\n\nChoice B:\napp/models/account.rb\n@@ -68,7 +68,7 @@ class Account < ApplicationRecord\n   INSTANCE_ACTOR_ID = -99\n \n   USERNAME_RE   = /[a-z0-9_]+([a-z0-9_.-]+[a-z0-9_]+)?/i\n-  MENTION_RE    = %r{(?<![=/[:word:]])@((#{USERNAME_RE})(?:@[[:word:].-]+[[:word:]]+)?)}i\n+  MENTION_RE    = %r{(?<![=/[:word:]])@((#{USERNAME_RE})(?:@[[:word:].-]+[[:word:]]+)?)}\n   URL_PREFIX_RE = %r{\\Ahttp(s?)://[^/]+}\n   USERNAME_ONLY_RE = /\\A#{USERNAME_RE}\\z/i\n   USERNAME_LENGTH_LIMIT = 30\n---\napp/models/tag.rb\n@@ -37,7 +37,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]\\u0E47-\\u0E4E#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/account_spec.rb\n@@ -711,6 +711,14 @@\n     it 'does not match URL query string' do\n       expect(subject.match('https://example.com/?x=@alice')).to be_nil\n     end\n+\n+    it 'matches usernames immediately following the letter \u00df' do\n+      expect(subject.match('Hello to\u00df @alice from me')[1]).to eq 'alice'\n+    end\n+\n+    it 'matches usernames containing uppercase characters' do\n+      expect(subject.match('Hello to @aLice@Example.com from me')[1]).to eq 'aLice@Example.com'\n+    end\n   end\n \n   describe 'validations' do\n---\nspec/models/tag_spec.rb\n@@ -95,6 +95,14 @@\n     it 'does not match purely-numeric hashtags' do\n       expect(subject.match('hello #0123456')).to be_nil\n     end\n+\n+    it 'matches hashtags immediately following the letter \u00df' do\n+      expect(subject.match('Hello to\u00df #ruby').to_s).to eq '#ruby'\n+    end\n+\n+    it 'matches hashtags containing uppercase characters' do\n+      expect(subject.match('Hello #rubyOnRails').to_s).to eq '#rubyOnRails'\n+    end\n   end\n \n   describe '#to_param' do\n---\n\n\n---\n\nChoice C:\nconfig/initializers/regexp.rb\n@@ -1,4 +1,4 @@\n # frozen_string_literal: true\n \n-# 0.5s is a fairly high timeout, but that should account for slow servers under load\n-Regexp.timeout = 0.5 if Regexp.respond_to?(:timeout=)\n+# 2s is a fairly high default, but that should account for slow servers under load\n+Regexp.timeout = ENV.fetch('REGEXP_TIMEOUT', 2).to_f if Regexp.respond_to?(:timeout=)\n---\nconfig/initializers/regexp.rb\n@@ -1,4 +0,0 @@\n-# frozen_string_literal: true\n-\n-# 2s is a fairly high default, but that should account for slow servers under load\n-Regexp.timeout = ENV.fetch('REGEXP_TIMEOUT', 2).to_f if Regexp.respond_to?(:timeout=)\n---\nconfig/initializers/regexp.rb\n@@ -1,4 +1,3 @@\n # frozen_string_literal: true\n \n-# 2s is a fairly high default, but that should account for slow servers under load\n-Regexp.timeout = ENV.fetch('REGEXP_TIMEOUT', 2).to_f if Regexp.respond_to?(:timeout=)\n+Regexp.timeout = ENV['REGEXP_TIMEOUT'].to_f if Regexp.respond_to?(:timeout=) && ENV['REGEXP_TIMEOUT']\n---\nGemfile\n@@ -53,7 +53,7 @@ gem 'hiredis', '~> 0.6'\n gem 'htmlentities', '~> 4.3'\n gem 'http', '~> 5.2.0'\n gem 'http_accept_language', '~> 2.1'\n-gem 'httplog', '~> 1.7.0'\n+gem 'httplog', '~> 1.7.0', require: false\n gem 'i18n'\n gem 'idn-ruby', require: 'idn'\n gem 'inline_svg'\n---\nconfig/initializers/httplog.rb\n@@ -1,7 +1,12 @@\n # frozen_string_literal: true\n \n-HttpLog.configure do |config|\n-  config.logger = Rails.logger\n-  config.color = { color: :yellow }\n-  config.compact_log = true\n+# Disable httplog in production unless log_level is `debug`\n+if !Rails.env.production? || Rails.configuration.log_level == :debug\n+  require 'httplog'\n+\n+  HttpLog.configure do |config|\n+    config.logger = Rails.logger\n+    config.color = { color: :yellow }\n+    config.compact_log = true\n+  end\n end\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/notifications/requests.jsx\n@@ -217,7 +217,9 @@ export const NotificationRequests = ({ multiColumn }) => {\n         multiColumn={multiColumn}\n         showBackButton\n         appendContent={\n-          <SelectRow selectionMode={selectionMode} setSelectionMode={setSelectionMode} selectAllChecked={selectAllChecked} toggleSelectAll={toggleSelectAll} selectedItems={checkedRequestIds} />}\n+          notificationRequests.size > 0 && (\n+            <SelectRow selectionMode={selectionMode} setSelectionMode={setSelectionMode} selectAllChecked={selectAllChecked} toggleSelectAll={toggleSelectAll} selectedItems={checkedRequestIds} />\n+          )}\n       >\n         <ColumnSettings />\n       </ColumnHeader>\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n![Mastodon web interface. One action-bar with a 0-comments thread-icon, and one action bar with a 1 comment, single-thread icon. The remaining icons (share, fav, save, menu) are offset by a couple of pixels.](https://github.com/user-attachments/assets/4e6148d7-5641-415c-86a4-90c7884d0cac)\r\n\r\nSame, but on 4.3 mastodon.social (as of creating the ticket)\r\n![image](https://github.com/user-attachments/assets/19059e6a-e408-46ee-8b52-bf26d825c8bc)\r\n\r\n\r\n### Expected behaviour\r\n\r\nThe action-bar is a static grid with space allocated for each button. Changing the width of one element, shouldn't affect the other elements (within reasonable limits).\r\n\r\n### Actual behaviour\r\n\r\nAs the reply-all button is wider than the reply button the action bar icons realign.\r\n\r\n### Detailed description\r\n\r\n_No response_\r\n\r\n### Mastodon instance\r\n\r\nmastodon.social\r\n\r\n### Mastodon version\r\n\r\nv4.2.12 & v4.3.0-nightly.2024-09-23\r\n\r\n### Browser name and version\r\n\r\nEdge 129\r\n\r\n### Operating system\r\n\r\nWindows 11, 23h2\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/models/account.rb\n@@ -144,6 +144,7 @@ class Account < ApplicationRecord\n   scope :dormant, -> { joins(:account_stat).merge(AccountStat.without_recent_activity) }\n   scope :with_username, ->(value) { where arel_table[:username].lower.eq(value.to_s.downcase) }\n   scope :with_domain, ->(value) { where arel_table[:domain].lower.eq(value&.to_s&.downcase) }\n+  scope :without_memorial, -> { where(memorial: false) }\n \n   after_update_commit :trigger_update_webhooks\n \n---\napp/models/account_suggestions/friends_of_friends_source.rb\n@@ -31,6 +31,7 @@ def source_query(account, limit: DEFAULT_LIMIT)\n         AND accounts.suspended_at IS NULL\n         AND accounts.silenced_at IS NULL\n         AND accounts.moved_to_account_id IS NULL\n+        AND accounts.memorial = FALSE\n         AND follow_recommendation_mutes.target_account_id IS NULL\n       GROUP BY accounts.id, account_stats.id\n       ORDER BY frequency DESC, account_stats.followers_count ASC\n---\napp/models/account_suggestions/source.rb\n@@ -14,6 +14,7 @@ def base_account_scope(account)\n       .searchable\n       .where(discoverable: true)\n       .without_silenced\n+      .without_memorial\n       .where.not(follows_sql, id: account.id)\n       .where.not(follow_requests_sql, id: account.id)\n       .not_excluded_by_account(account)\n---\nspec/models/account_suggestions/friends_of_friends_source_spec.rb\n@@ -15,6 +15,7 @@\n     let!(:john) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:jerk) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:larry) { Fabricate(:account, discoverable: true, hide_collections: false) }\n+    let!(:morty) { Fabricate(:account, discoverable: true, hide_collections: false, memorial: true) }\n \n     context 'with follows and blocks' do\n       before do\n@@ -27,8 +28,8 @@\n         # alice follows eve and mallory\n         [john, mallory].each { |account| alice.follow!(account) }\n \n-        # eugen follows eve, john, jerk, larry and neil\n-        [eve, mallory, jerk, larry, neil].each { |account| eugen.follow!(account) }\n+        # eugen follows eve, john, jerk, larry, neil and morty\n+        [eve, mallory, jerk, larry, neil, morty].each { |account| eugen.follow!(account) }\n       end\n \n       it 'returns eligible accounts', :aggregate_failures do\n@@ -51,6 +52,9 @@\n \n         # the suggestion for neil has already been rejected\n         expect(results).to_not include([neil.id, :friends_of_friends])\n+\n+        # morty is not included because his account is in memoriam\n+        expect(results).to_not include([morty.id, :friends_of_friends])\n       end\n     end\n \n---\nspec/models/account_suggestions/source_spec.rb\n@@ -21,6 +21,7 @@\n       let!(:moved_account) { Fabricate(:account, moved_to_account: Fabricate(:account), discoverable: true) }\n       let!(:silenced_account) { Fabricate(:account, silenced: true, discoverable: true) }\n       let!(:undiscoverable_account) { Fabricate(:account, discoverable: false) }\n+      let!(:memorial_account) { Fabricate(:account, memorial: true, discoverable: true) }\n \n       before do\n         Fabricate :account_domain_block, account: account, domain: account_domain_blocked_account.domain\n@@ -44,6 +45,7 @@\n           .and not_include(moved_account)\n           .and not_include(silenced_account)\n           .and not_include(undiscoverable_account)\n+          .and not_include(memorial_account)\n       end\n     end\n   end\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/components/status_action_bar.jsx\n@@ -375,20 +375,29 @@ class StatusActionBar extends ImmutablePureComponent {\n \n     return (\n       <div className='status__action-bar'>\n-        <IconButton className='status__action-bar__button' title={replyTitle} icon={isReply ? 'reply' : replyIcon} iconComponent={isReply ? ReplyIcon : replyIconComponent} onClick={this.handleReplyClick} counter={status.get('replies_count')} />\n-        <IconButton className={classNames('status__action-bar__button', { reblogPrivate })} disabled={!publicStatus && !reblogPrivate} active={status.get('reblogged')} title={reblogTitle} icon='retweet' iconComponent={reblogIconComponent} onClick={this.handleReblogClick} counter={withCounters ? status.get('reblogs_count') : undefined} />\n-        <IconButton className='status__action-bar__button star-icon' animate active={status.get('favourited')} title={intl.formatMessage(messages.favourite)} icon='star' iconComponent={status.get('favourited') ? StarIcon : StarBorderIcon} onClick={this.handleFavouriteClick} counter={withCounters ? status.get('favourites_count') : undefined} />\n-        <IconButton className='status__action-bar__button bookmark-icon' disabled={!signedIn} active={status.get('bookmarked')} title={intl.formatMessage(messages.bookmark)} icon='bookmark' iconComponent={status.get('bookmarked') ? BookmarkIcon : BookmarkBorderIcon} onClick={this.handleBookmarkClick} />\n-\n-        <DropdownMenuContainer\n-          scrollKey={scrollKey}\n-          status={status}\n-          items={menu}\n-          icon='ellipsis-h'\n-          iconComponent={MoreHorizIcon}\n-          direction='right'\n-          title={intl.formatMessage(messages.more)}\n-        />\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className='status__action-bar__button' title={replyTitle} icon={isReply ? 'reply' : replyIcon} iconComponent={isReply ? ReplyIcon : replyIconComponent} onClick={this.handleReplyClick} counter={status.get('replies_count')} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className={classNames('status__action-bar__button', { reblogPrivate })} disabled={!publicStatus && !reblogPrivate} active={status.get('reblogged')} title={reblogTitle} icon='retweet' iconComponent={reblogIconComponent} onClick={this.handleReblogClick} counter={withCounters ? status.get('reblogs_count') : undefined} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className='status__action-bar__button star-icon' animate active={status.get('favourited')} title={intl.formatMessage(messages.favourite)} icon='star' iconComponent={status.get('favourited') ? StarIcon : StarBorderIcon} onClick={this.handleFavouriteClick} counter={withCounters ? status.get('favourites_count') : undefined} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className='status__action-bar__button bookmark-icon' disabled={!signedIn} active={status.get('bookmarked')} title={intl.formatMessage(messages.bookmark)} icon='bookmark' iconComponent={status.get('bookmarked') ? BookmarkIcon : BookmarkBorderIcon} onClick={this.handleBookmarkClick} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <DropdownMenuContainer\n+            scrollKey={scrollKey}\n+            status={status}\n+            items={menu}\n+            icon='ellipsis-h'\n+            iconComponent={MoreHorizIcon}\n+            direction='right'\n+            title={intl.formatMessage(messages.more)}\n+          />\n+        </div>\n       </div>\n     );\n   }\n---\napp/javascript/styles/mastodon/components.scss\n@@ -299,6 +299,10 @@\n     }\n   }\n \n+  &--with-counter {\n+    padding-inline-end: 4px;\n+  }\n+\n   &__counter {\n     display: block;\n     width: auto;\n@@ -1465,6 +1469,15 @@ body > [data-popper-placement] {\n     }\n   }\n \n+  &__action-bar__button-wrapper {\n+    flex-basis: 0;\n+    flex-grow: 1;\n+\n+    &:last-child {\n+      flex-grow: 0;\n+    }\n+  }\n+\n   &--first-in-thread {\n     border-top: 1px solid var(--background-border-color);\n   }\n---\n\n\n---\n\nChoice C:\napp/helpers/languages_helper.rb\n@@ -194,7 +194,10 @@ module LanguagesHelper\n     jbo: ['Lojban', 'la .lojban.'].freeze,\n     kab: ['Kabyle', 'Taqbaylit'].freeze,\n     ldn: ['L\u00e1adan', 'L\u00e1adan'].freeze,\n+    ltg: ['Latgalian', 'latgal\u012b\u0161u'].freeze,\n     lfn: ['Lingua Franca Nova', 'lingua franca nova'].freeze,\n+    prg: ['Prussian', 'pr\u016bsiskai'].freeze,\n+    sgs: ['Samogitian', '\u017eemaitiu'].freeze,\n     sco: ['Scots', 'Scots'].freeze,\n     sma: ['Southern Sami', '\u00c5arjelsaemien G\u00efele'].freeze,\n     smj: ['Lule Sami', 'Julevs\u00e1megiella'].freeze,\n---\n\n\n---\n\nChoice D:\napp/lib/video_metadata_extractor.rb\n@@ -22,7 +22,7 @@ def valid?\n   private\n \n   def ffmpeg_command_output\n-    command = Terrapin::CommandLine.new('ffprobe', '-i :path -print_format :format -show_format -show_streams -show_error -loglevel :loglevel')\n+    command = Terrapin::CommandLine.new(Rails.configuration.x.ffprobe_binary, '-i :path -print_format :format -show_format -show_streams -show_error -loglevel :loglevel')\n     command.run(path: @path, format: 'json', loglevel: 'fatal')\n   end\n \n---\nconfig/initializers/ffmpeg.rb\n@@ -1,5 +1,6 @@\n # frozen_string_literal: true\n \n-if ENV['FFMPEG_BINARY'].present?\n-  FFMPEG.ffmpeg_binary = ENV['FFMPEG_BINARY']\n+Rails.application.configure do\n+  config.x.ffmpeg_binary = ENV['FFMPEG_BINARY'] || 'ffmpeg'\n+  config.x.ffprobe_binary = ENV['FFPROBE_BINARY'] || 'ffprobe'\n end\n---\nlib/paperclip/image_extractor.rb\n@@ -35,7 +35,7 @@ def extract_image_from_file!\n       dst.binmode\n \n       begin\n-        command = Terrapin::CommandLine.new('ffmpeg', '-i :source -loglevel :loglevel -y :destination', logger: Paperclip.logger)\n+        command = Terrapin::CommandLine.new(Rails.configuration.x.ffmpeg_binary, '-i :source -loglevel :loglevel -y :destination', logger: Paperclip.logger)\n         command.run(source: @file.path, destination: dst.path, loglevel: 'fatal')\n       rescue Terrapin::ExitStatusError\n         dst.close(true)\n---\nlib/paperclip/transcoder.rb\n@@ -61,7 +61,7 @@ def make\n       command_arguments, interpolations = prepare_command(destination)\n \n       begin\n-        command = Terrapin::CommandLine.new('ffmpeg', command_arguments.join(' '), logger: Paperclip.logger)\n+        command = Terrapin::CommandLine.new(Rails.configuration.x.ffmpeg_binary, command_arguments.join(' '), logger: Paperclip.logger)\n         command.run(interpolations)\n       rescue Terrapin::ExitStatusError => e\n         raise Paperclip::Error, \"Error while transcoding #{@basename}: #{e}\"\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. use the instance normally.\r\n\r\n\n\n### Expected behaviour\n\nhome feed is not empty\n\n### Actual behaviour\n\nhome feed is empty and there are many failed sidekiq jobs\n\n### Detailed description\n\n1. My home feed is suddenly empty, and `RAILS_ENV=production ./bin/tootctl feeds build` does not solve it.\r\n2. the log of sidekiq seems to say it could not insert into feed.\n\n### Mastodon instance\n\njing.lgbt\n\n### Mastodon version\n\nv4.2.12\n\n### Technical details\n\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: ruby 3.2.3 (2024-01-18 revision 52bb2ac0a6) [x86_64-linux]\r\n- Node.js version: v20.17.0\r\n\r\njournald:\r\n```\r\nSep 20 01:38:48 mastodon1 bundle[1042215]: 2024-09-19T16:38:48.333Z pid=1042215 tid=ilnj class=FeedInsertWorker jid=537fcecfb09c55be7366b105 INFO: start\r\nSep 20 01:38:48 mastodon1 bundle[1042215]: 2024-09-19T16:38:48.344Z pid=1042215 tid=ilnj class=FeedInsertWorker jid=537fcecfb09c55be7366b105 elapsed=0.012 INFO: fail\r\nSep 20 01:38:48 mastodon1 bundle[1042215]: 2024-09-19T16:38:48.344Z pid=1042215 tid=ilnj WARN: {\"context\":\"Job raised exception\",\"job\":{\"retry\":true,\"queue\":\"default\",\"class\":\"FeedInsertWorker\",\"args\":[113159302227197083,111832116425341006,\"home\",{\"update\":null}],\"jid\":\"537fcecfb09c55be7366b105\",\"created_at\":1726673923.177217,\"enqueued_at\":1726763928.3325593,\"error_message\":\"undefined method `account_id' for nil:NilClass\",\"error_class\":\"NoMethodError\",\"failed_at\":1726673923.183306,\"retry_count\":13,\"retried_at\":1726735322.2056925}}\r\nSep 20 01:38:48 mastodon1 bundle[1042215]: 2024-09-19T16:38:48.344Z pid=1042215 tid=ilnj WARN: NoMethodError: undefined method `account_id' for nil:NilClass\r\nSep 20 01:38:48 mastodon1 bundle[1042215]: 2024-09-19T16:38:48.344Z pid=1042215 tid=ilnj WARN: /home/mastodon/live/app/lib/feed_manager.rb:561:in `block in build_crutches'\r\nSep 20 01:38:48 mastodon1 bundle[1042215]: /home/mastodon/live/app/lib/feed_manager.rb:556:in `each'\r\nSep 20 01:38:48 mastodon1 bundle[1042215]: /home/mastodon/live/app/lib/feed_manager.rb:556:in `flat_map'\r\n```\n\n---\n\nChoice A:\napp/models/status.rb\n@@ -162,7 +162,7 @@ class Status < ApplicationRecord\n   REAL_TIME_WINDOW = 6.hours\n \n   def cache_key\n-    \"v2:#{super}\"\n+    \"v3:#{super}\"\n   end\n \n   def searchable_by(preloaded = nil)\n---\n\n\n---\n\nChoice B:\napp/lib/feed_manager.rb\n@@ -558,7 +558,7 @@ def build_crutches(receiver_id, statuses)\n       arr = crutches[:active_mentions][s.id] || []\n       arr.push(s.account_id)\n \n-      if s.reblog?\n+      if s.reblog? && s.reblog.present?\n         arr.push(s.reblog.account_id)\n         arr.concat(crutches[:active_mentions][s.reblog_of_id] || [])\n       end\n---\n\n\n---\n\nChoice C:\napp/helpers/languages_helper.rb\n@@ -194,7 +194,10 @@ module LanguagesHelper\n     jbo: ['Lojban', 'la .lojban.'].freeze,\n     kab: ['Kabyle', 'Taqbaylit'].freeze,\n     ldn: ['L\u00e1adan', 'L\u00e1adan'].freeze,\n+    ltg: ['Latgalian', 'latgal\u012b\u0161u'].freeze,\n     lfn: ['Lingua Franca Nova', 'lingua franca nova'].freeze,\n+    prg: ['Prussian', 'pr\u016bsiskai'].freeze,\n+    sgs: ['Samogitian', '\u017eemaitiu'].freeze,\n     sco: ['Scots', 'Scots'].freeze,\n     sma: ['Southern Sami', '\u00c5arjelsaemien G\u00efele'].freeze,\n     smj: ['Lule Sami', 'Julevs\u00e1megiella'].freeze,\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/reducers/notification_groups.ts\n@@ -559,7 +559,10 @@ export const notificationGroupsReducer = createReducer<NotificationGroupsState>(\n           compareId(state.lastReadId, mostRecentGroup.page_max_id) < 0\n         )\n           state.lastReadId = mostRecentGroup.page_max_id;\n-        commitLastReadId(state);\n+\n+        // We don't call `commitLastReadId`, because that is conditional\n+        // and we want to unconditionally update the state instead.\n+        state.readMarkerId = state.lastReadId;\n       })\n       .addCase(fetchMarkers.fulfilled, (state, action) => {\n         if (\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Go to `admin/tags/`\r\n2. Select any tag\r\n\r\n![image](https://github.com/user-attachments/assets/685db191-2e96-4132-a667-a16abe47676e)\r\n\n\n### Expected behaviour\n\nText is displayed on 1 line\n\n### Actual behaviour\n\nText is displayed on 2 lines and overlapping next block\n\n### Detailed description\n\nText for status of hashtag moderation is overlapping the next line because it is displayed on 2 lines.\n\n### Mastodon instance\n\nsocial.coukaratcha.fr\n\n### Mastodon version\n\nv4.3.0-beta.2\n\n### Browser name and version\n\nFirefox 130.0.1 (64 bits)\n\n### Operating system\n\nWindows 11\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/dashboard.scss\n@@ -86,9 +86,7 @@\n     color: $primary-text-color;\n     transition: all 100ms ease-in;\n     font-size: 14px;\n-    padding: 0 16px;\n-    line-height: 36px;\n-    height: 36px;\n+    padding: 8px 16px;\n     text-decoration: none;\n     margin-bottom: 4px;\n \n---\napp/javascript/styles/mastodon/dashboard.scss\n@@ -91,6 +91,7 @@\n     height: 36px;\n     text-decoration: none;\n     margin-bottom: 4px;\n+    white-space: nowrap;\n \n     &:active,\n     &:focus,\n@@ -111,6 +112,8 @@\n \n     span {\n       flex: 1 1 auto;\n+      overflow: hidden;\n+      text-overflow: ellipsis;\n     }\n \n     strong {\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/account/components/header.jsx\n@@ -265,9 +265,9 @@ class Header extends ImmutablePureComponent {\n       if (signedIn && !account.get('relationship')) { // Wait until the relationship is loaded\n         actionBtn = '';\n       } else if (account.getIn(['relationship', 'requested'])) {\n-        actionBtn = <Button className={classNames({ 'button--with-bell': bellBtn !== '' })} text={intl.formatMessage(messages.cancel_follow_request)} title={intl.formatMessage(messages.requested)} onClick={this.props.onFollow} />;\n+        actionBtn = <Button text={intl.formatMessage(messages.cancel_follow_request)} title={intl.formatMessage(messages.requested)} onClick={this.props.onFollow} />;\n       } else if (!account.getIn(['relationship', 'blocking'])) {\n-        actionBtn = <Button disabled={account.getIn(['relationship', 'blocked_by'])} className={classNames({ 'button--destructive': account.getIn(['relationship', 'following']), 'button--with-bell': bellBtn !== '' })} text={intl.formatMessage(account.getIn(['relationship', 'following']) ? messages.unfollow : messages.follow)} onClick={signedIn ? this.props.onFollow : this.props.onInteractionModal} />;\n+        actionBtn = <Button disabled={account.getIn(['relationship', 'blocked_by'])} className={classNames({ 'button--destructive': account.getIn(['relationship', 'following']) })} text={intl.formatMessage(account.getIn(['relationship', 'following']) ? messages.unfollow : messages.follow)} onClick={signedIn ? this.props.onFollow : this.props.onInteractionModal} />;\n       } else if (account.getIn(['relationship', 'blocking'])) {\n         actionBtn = <Button text={intl.formatMessage(messages.unblock, { name: account.get('username') })} onClick={this.props.onBlock} />;\n       }\n---\napp/javascript/styles/mastodon/components.scss\n@@ -170,11 +170,6 @@\n     display: block;\n     width: 100%;\n   }\n-\n-  .layout-multiple-columns &.button--with-bell {\n-    font-size: 12px;\n-    padding: 0 8px;\n-  }\n }\n \n .column__wrapper {\n---\n\n\n---\n\nChoice C:\napp/lib/attachment_batch.rb\n@@ -75,7 +75,12 @@ def remove_files\n             end\n           when :fog\n             logger.debug { \"Deleting #{attachment.path(style)}\" }\n-            attachment.send(:directory).files.new(key: attachment.path(style)).destroy\n+\n+            begin\n+              attachment.send(:directory).files.new(key: attachment.path(style)).destroy\n+            rescue Fog::Storage::OpenStack::NotFound\n+              # Ignore failure to delete a file that has already been deleted\n+            end\n           when :azure\n             logger.debug { \"Deleting #{attachment.path(style)}\" }\n             attachment.destroy\n---\n\n\n---\n\nChoice D:\nconfig/initializers/paperclip.rb\n@@ -88,6 +88,19 @@\n \n   Paperclip::Attachment.default_options[:s3_headers]['X-Amz-Storage-Class'] = ENV['S3_STORAGE_CLASS'] if ENV.has_key?('S3_STORAGE_CLASS')\n \n+  # Some S3 providers are not compatible with the checksum mode\n+  # See https://github.com/mastodon/mastodon/issues/26394\n+  if ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n+    module Aws::S3::FileDownloaderExtensions\n+      def validate!\n+        @params.delete(:checksum_mode)\n+        super\n+      end\n+    end\n+\n+    Aws::S3::FileDownloader.prepend(Aws::S3::FileDownloaderExtensions)\n+  end\n+\n   # Some S3-compatible providers might not actually be compatible with some APIs\n   # used by kt-paperclip, see https://github.com/mastodon/mastodon/issues/16822\n   if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n---\nconfig/initializers/paperclip.rb\n@@ -90,13 +90,19 @@\n \n   # Some S3-compatible providers might not actually be compatible with some APIs\n   # used by kt-paperclip, see https://github.com/mastodon/mastodon/issues/16822\n-  if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n+  # and https://github.com/mastodon/mastodon/issues/26394\n+  if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true' || ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n     module Paperclip\n       module Storage\n         module S3Extensions\n           def copy_to_local_file(style, local_dest_path)\n             log(\"copying #{path(style)} to local file #{local_dest_path}\")\n-            s3_object(style).download_file(local_dest_path, { mode: 'single_request' })\n+\n+            options = {}\n+            options[:mode] = 'single_request' if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n+            options[:checksum_mode] = 'DISABLED' if ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n+\n+            s3_object(style).download_file(local_dest_path, options)\n           rescue Aws::Errors::ServiceError => e\n             warn(\"#{e} - cannot copy #{path(style)} to local file #{local_dest_path}\")\n             false\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Open the mastodon web interface on a large tablet in landscape mode\r\n\n\n### Expected behaviour\n\nNicely proportioned three-column layout\n\n### Actual behaviour\n\nStretched out version of a layout that\u2019s more appropriate for phones held in portrait orientation\n\n### Detailed description\n\nWith #31889, the breakpoint for the no-gap layout was increased to 1206px. This results in at least some iPads in landscape orientation (where we expect to see a full desktop-class layout on most websites) getting the no-gap layout, where it is strangely proportioned and less functional than the previous three-column layout. In particular, because the no-gap layout stretches everything to almost the full width of the display, portrait images end up being too tall to see the entire image, link preview cards are nearly full-screen (on a tablet, this is physically very large!), and text-only posts create large areas of whitespace.\r\n\r\nPrior to this change:\r\n![323378668-42f09faa-7f19-4b75-a3ef-1b9fcbd62033](https://github.com/user-attachments/assets/fee614a0-1b4a-49f9-ab6d-a4cf3e007fb4)\r\n\r\nAfter this change (on an 11\u201d iPad Pro), showing how you can\u2019t even see the entirety of one post that has a link preview card in it:\r\n![368347295-6f1fe061-a3ae-42df-905a-5b447349e4d3](https://github.com/user-attachments/assets/39b0e0f6-49df-4446-a7f5-cb544e39df55)\r\n\n\n### Mastodon instance\n\nmastodon.social, mastodon.online\n\n### Mastodon version\n\nv4.3.0-beta.2+pr-31960-9262aa2\n\n### Browser name and version\n\nSafari (iPadOS 18.0)\n\n### Operating system\n\niPadOS 18.0\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/models/account.rb\n@@ -144,6 +144,7 @@ class Account < ApplicationRecord\n   scope :dormant, -> { joins(:account_stat).merge(AccountStat.without_recent_activity) }\n   scope :with_username, ->(value) { where arel_table[:username].lower.eq(value.to_s.downcase) }\n   scope :with_domain, ->(value) { where arel_table[:domain].lower.eq(value&.to_s&.downcase) }\n+  scope :without_memorial, -> { where(memorial: false) }\n \n   after_update_commit :trigger_update_webhooks\n \n---\napp/models/account_suggestions/friends_of_friends_source.rb\n@@ -31,6 +31,7 @@ def source_query(account, limit: DEFAULT_LIMIT)\n         AND accounts.suspended_at IS NULL\n         AND accounts.silenced_at IS NULL\n         AND accounts.moved_to_account_id IS NULL\n+        AND accounts.memorial = FALSE\n         AND follow_recommendation_mutes.target_account_id IS NULL\n       GROUP BY accounts.id, account_stats.id\n       ORDER BY frequency DESC, account_stats.followers_count ASC\n---\napp/models/account_suggestions/source.rb\n@@ -14,6 +14,7 @@ def base_account_scope(account)\n       .searchable\n       .where(discoverable: true)\n       .without_silenced\n+      .without_memorial\n       .where.not(follows_sql, id: account.id)\n       .where.not(follow_requests_sql, id: account.id)\n       .not_excluded_by_account(account)\n---\nspec/models/account_suggestions/friends_of_friends_source_spec.rb\n@@ -15,6 +15,7 @@\n     let!(:john) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:jerk) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:larry) { Fabricate(:account, discoverable: true, hide_collections: false) }\n+    let!(:morty) { Fabricate(:account, discoverable: true, hide_collections: false, memorial: true) }\n \n     context 'with follows and blocks' do\n       before do\n@@ -27,8 +28,8 @@\n         # alice follows eve and mallory\n         [john, mallory].each { |account| alice.follow!(account) }\n \n-        # eugen follows eve, john, jerk, larry and neil\n-        [eve, mallory, jerk, larry, neil].each { |account| eugen.follow!(account) }\n+        # eugen follows eve, john, jerk, larry, neil and morty\n+        [eve, mallory, jerk, larry, neil, morty].each { |account| eugen.follow!(account) }\n       end\n \n       it 'returns eligible accounts', :aggregate_failures do\n@@ -51,6 +52,9 @@\n \n         # the suggestion for neil has already been rejected\n         expect(results).to_not include([neil.id, :friends_of_friends])\n+\n+        # morty is not included because his account is in memoriam\n+        expect(results).to_not include([morty.id, :friends_of_friends])\n       end\n     end\n \n---\nspec/models/account_suggestions/source_spec.rb\n@@ -21,6 +21,7 @@\n       let!(:moved_account) { Fabricate(:account, moved_to_account: Fabricate(:account), discoverable: true) }\n       let!(:silenced_account) { Fabricate(:account, silenced: true, discoverable: true) }\n       let!(:undiscoverable_account) { Fabricate(:account, discoverable: false) }\n+      let!(:memorial_account) { Fabricate(:account, memorial: true, discoverable: true) }\n \n       before do\n         Fabricate :account_domain_block, account: account, domain: account_domain_blocked_account.domain\n@@ -44,6 +45,7 @@\n           .and not_include(moved_account)\n           .and not_include(silenced_account)\n           .and not_include(undiscoverable_account)\n+          .and not_include(memorial_account)\n       end\n     end\n   end\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -63,8 +63,8 @@ export default class ColumnsArea extends ImmutablePureComponent {\n     children: PropTypes.node,\n   };\n \n-  // Corresponds to (max-width: $no-gap-breakpoint + 285px - 1px) in SCSS\n-  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1174px)');\n+  // Corresponds to (max-width: $no-gap-breakpoint - 1px) in SCSS\n+  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1206px)');\n \n   state = {\n     renderComposePanel: !(this.mediaQuery && this.mediaQuery.matches),\n---\napp/javascript/styles/mastodon/variables.scss\n@@ -87,7 +87,7 @@ $media-modal-media-max-width: 100%;\n // put margins on top and bottom of image to avoid the screen covered by image.\n $media-modal-media-max-height: 80%;\n \n-$no-gap-breakpoint: 1175px;\n+$no-gap-breakpoint: 1207px;\n $mobile-breakpoint: 630px;\n \n $font-sans-serif: 'mastodon-font-sans-serif' !default;\n---\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -62,7 +62,7 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   };\n \n   // Corresponds to (max-width: $no-gap-breakpoint - 1px) in SCSS\n-  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1206px)');\n+  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1174px)');\n \n   state = {\n     renderComposePanel: !(this.mediaQuery && this.mediaQuery.matches),\n---\napp/javascript/styles/mastodon/components.scss\n@@ -2708,7 +2708,7 @@ a.account__display-name {\n     &__main {\n       box-sizing: border-box;\n       width: 100%;\n-      flex: 0 0 auto;\n+      flex: 0 1 auto;\n       display: flex;\n       flex-direction: column;\n \n---\napp/javascript/styles/mastodon/variables.scss\n@@ -87,7 +87,7 @@ $media-modal-media-max-width: 100%;\n // put margins on top and bottom of image to avoid the screen covered by image.\n $media-modal-media-max-height: 80%;\n \n-$no-gap-breakpoint: 1207px;\n+$no-gap-breakpoint: 1175px;\n $mobile-breakpoint: 630px;\n \n $font-sans-serif: 'mastodon-font-sans-serif' !default;\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/polyfills/base_polyfills.ts\n@@ -1,4 +1,5 @@\n import 'core-js/features/object/assign';\n+import 'core-js/features/object/has-own';\n import 'core-js/features/object/values';\n import 'core-js/features/symbol';\n import 'core-js/features/promise/finally';\n---\n\n\n---\n\nChoice D:\napp/controllers/well_known/host_meta_controller.rb\n@@ -7,7 +7,23 @@ class HostMetaController < ActionController::Base # rubocop:disable Rails/Applic\n     def show\n       @webfinger_template = \"#{webfinger_url}?resource={uri}\"\n       expires_in 3.days, public: true\n-      render content_type: 'application/xrd+xml', formats: [:xml]\n+\n+      respond_to do |format|\n+        format.any do\n+          render content_type: 'application/xrd+xml', formats: [:xml]\n+        end\n+\n+        format.json do\n+          render json: {\n+            links: [\n+              {\n+                rel: 'lrdd',\n+                template: @webfinger_template,\n+              },\n+            ],\n+          }\n+        end\n+      end\n     end\n   end\n end\n---\nconfig/routes.rb\n@@ -67,7 +67,7 @@ def redirect_with_vary(path)\n   scope path: '.well-known' do\n     scope module: :well_known do\n       get 'oauth-authorization-server', to: 'oauth_metadata#show', as: :oauth_metadata, defaults: { format: 'json' }\n-      get 'host-meta', to: 'host_meta#show', as: :host_meta, defaults: { format: 'xml' }\n+      get 'host-meta', to: 'host_meta#show', as: :host_meta\n       get 'nodeinfo', to: 'node_info#index', as: :nodeinfo, defaults: { format: 'json' }\n       get 'webfinger', to: 'webfinger#show', as: :webfinger\n     end\n---\nspec/requests/well_known/host_meta_spec.rb\n@@ -9,19 +9,39 @@\n     expect(response)\n       .to have_http_status(200)\n       .and have_attributes(\n-        media_type: 'application/xrd+xml',\n-        body: host_meta_xml_template\n+        media_type: 'application/xrd+xml'\n+      )\n+\n+    doc = Nokogiri::XML(response.parsed_body)\n+    expect(doc.at_xpath('/xrd:XRD/xrd:Link[@rel=\"lrdd\"]/@template', 'xrd' => 'http://docs.oasis-open.org/ns/xri/xrd-1.0').value)\n+      .to eq 'https://cb6e6126.ngrok.io/.well-known/webfinger?resource={uri}'\n+  end\n+\n+  it 'returns http success with valid JSON response with .json extension' do\n+    get '/.well-known/host-meta.json'\n+\n+    expect(response)\n+      .to have_http_status(200)\n+      .and have_attributes(\n+        media_type: 'application/json'\n+      )\n+\n+    expect(response.parsed_body)\n+      .to include(\n+        links: [\n+          'rel' => 'lrdd',\n+          'template' => 'https://cb6e6126.ngrok.io/.well-known/webfinger?resource={uri}',\n+        ]\n       )\n   end\n \n-  private\n+  it 'returns http success with valid JSON response with Accept header' do\n+    get '/.well-known/host-meta', headers: { 'Accept' => 'application/json' }\n \n-  def host_meta_xml_template\n-    <<~XML\n-      <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-      <XRD xmlns=\"http://docs.oasis-open.org/ns/xri/xrd-1.0\">\n-        <Link rel=\"lrdd\" template=\"https://cb6e6126.ngrok.io/.well-known/webfinger?resource={uri}\"/>\n-      </XRD>\n-    XML\n+    expect(response)\n+      .to have_http_status(200)\n+      .and have_attributes(\n+        media_type: 'application/json'\n+      )\n   end\n end\n---\nspec/routing/well_known_routes_spec.rb\n@@ -4,9 +4,14 @@\n \n RSpec.describe 'Well Known routes' do\n   describe 'the host-meta route' do\n-    it 'routes to correct place with xml format' do\n+    it 'routes to correct place' do\n       expect(get('/.well-known/host-meta'))\n-        .to route_to('well_known/host_meta#show', format: 'xml')\n+        .to route_to('well_known/host_meta#show')\n+    end\n+\n+    it 'routes to correct place with json format' do\n+      expect(get('/.well-known/host-meta.json'))\n+        .to route_to('well_known/host_meta#show', format: 'json')\n     end\n   end\n \n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Go on Mastodon web interface on your desktop and look at the scrollbars sizes, mainly the main scrollbar totally on the right.\r\n2. Some people, including me, can't grab it with the mouse because it's too thin.\n\n### Expected behaviour\n\nI can grab the scrollbar with the mouse to scroll because it's normal size.\n\n### Actual behaviour\n\nI can't grab the scrollbar with the mouse to scroll because it's too thin.\n\n### Detailed description\n\nThe main scrollbar (on the `html` element) is too thin and it's very difficult to grab it to scroll with the mouse. On the screenshot below, this is the scrollbar on the right. The other for the navigation is normal size.\r\n\r\n![Screenshot of Mastodon interface with the thin main scrollbar and a normal size one for the navigation](https://github.com/user-attachments/assets/7f7f2f10-3297-4461-8e30-18932e88901f)\r\n\r\nI've found this code in the CSS which is the problem:\r\n\r\n```css\r\n@supports not selector(::-webkit-scrollbar) {\r\n  html {\r\n    scrollbar-color: #606085 var(--background-border-color);\r\n    scrollbar-width: thin;\r\n  }\r\n}\r\n```\r\n\r\nThere is an [\"Accessibility\" section on MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/scrollbar-width#accessibility) to explain why the CSS property `scrollbar-width` is a problem when you fix the `thin` value.\r\n\r\nIs it possible to remove this property from the CSS? Or to add an option so that users can choose if they want the normal size for scrollbar or a thin size?\r\n\r\nThanks\n\n### Mastodon instance\n\neldritch.cafe\n\n### Mastodon version\n\nv4.3.0\n\n### Browser name and version\n\nFirefox 130\n\n### Operating system\n\nWindows 11\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/reset.scss\n@@ -56,7 +56,6 @@ table {\n @supports not selector(::-webkit-scrollbar) {\n   html {\n     scrollbar-color: $action-button-color var(--background-border-color);\n-    scrollbar-width: thin;\n   }\n }\n \n---\napp/javascript/styles/mastodon-light/diff.scss\n@@ -524,14 +524,3 @@ a.sparkline {\n     color: $dark-text-color;\n   }\n }\n-\n-@supports not selector(::-webkit-scrollbar) {\n-  html {\n-    scrollbar-color: rgba($action-button-color, 0.25)\n-      var(--background-border-color);\n-  }\n-}\n-\n-::-webkit-scrollbar-thumb {\n-  opacity: 0.25;\n-}\n---\napp/javascript/styles/mastodon/reset.scss\n@@ -52,32 +52,3 @@ table {\n   border-collapse: collapse;\n   border-spacing: 0;\n }\n-\n-@supports not selector(::-webkit-scrollbar) {\n-  html {\n-    scrollbar-color: $action-button-color var(--background-border-color);\n-    scrollbar-width: thin;\n-  }\n-}\n-\n-::-webkit-scrollbar {\n-  width: 8px;\n-  height: 8px;\n-}\n-\n-::-webkit-scrollbar-thumb {\n-  background-color: $action-button-color;\n-  border: 2px var(--background-border-color);\n-  border-radius: 12px;\n-  width: 6px;\n-  box-shadow: inset 0 0 0 2px var(--background-border-color);\n-}\n-\n-::-webkit-scrollbar-track {\n-  background-color: var(--background-border-color);\n-  border-radius: 0px;\n-}\n-\n-::-webkit-scrollbar-corner {\n-  background: transparent;\n-}\n---\n\n\n---\n\nChoice B:\napp/lib/activitypub/activity/update.rb\n@@ -30,6 +30,6 @@ def update_status\n \n     return if @status.nil?\n \n-    ActivityPub::ProcessStatusUpdateService.new.call(@status, @object, request_id: @options[:request_id])\n+    ActivityPub::ProcessStatusUpdateService.new.call(@status, @json, @object, request_id: @options[:request_id])\n   end\n end\n---\napp/services/activitypub/fetch_remote_poll_service.rb\n@@ -8,6 +8,6 @@ def call(poll, on_behalf_of = nil)\n \n     return unless supported_context?(json)\n \n-    ActivityPub::ProcessStatusUpdateService.new.call(poll.status, json)\n+    ActivityPub::ProcessStatusUpdateService.new.call(poll.status, json, json)\n   end\n end\n---\napp/services/activitypub/process_status_update_service.rb\n@@ -5,10 +5,11 @@ class ActivityPub::ProcessStatusUpdateService < BaseService\n   include Redisable\n   include Lockable\n \n-  def call(status, json, request_id: nil)\n+  def call(status, activity_json, object_json, request_id: nil)\n     raise ArgumentError, 'Status has unsaved changes' if status.changed?\n \n-    @json                      = json\n+    @activity_json             = activity_json\n+    @json                      = object_json\n     @status_parser             = ActivityPub::Parser::StatusParser.new(@json)\n     @uri                       = @status_parser.uri\n     @status                    = status\n@@ -306,6 +307,6 @@ def forward_activity!\n   end\n \n   def forwarder\n-    @forwarder ||= ActivityPub::Forwarder.new(@account, @json, @status)\n+    @forwarder ||= ActivityPub::Forwarder.new(@account, @activity_json, @status)\n   end\n end\n---\nspec/services/activitypub/process_status_update_service_spec.rb\n@@ -41,12 +41,12 @@ def poll_option_json(name, votes)\n \n   describe '#call' do\n     it 'updates text' do\n-      subject.call(status, json)\n+      subject.call(status, json, json)\n       expect(status.reload.text).to eq 'Hello universe'\n     end\n \n     it 'updates content warning' do\n-      subject.call(status, json)\n+      subject.call(status, json, json)\n       expect(status.reload.spoiler_text).to eq 'Show more'\n     end\n \n@@ -64,7 +64,7 @@ def poll_option_json(name, votes)\n       end\n \n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'does not create any edits' do\n@@ -87,7 +87,7 @@ def poll_option_json(name, votes)\n       end\n \n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'does not create any edits' do\n@@ -134,7 +134,7 @@ def poll_option_json(name, votes)\n       end\n \n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'does not create any edits' do\n@@ -186,7 +186,7 @@ def poll_option_json(name, votes)\n       end\n \n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'does not create any edits' do\n@@ -214,11 +214,11 @@ def poll_option_json(name, votes)\n       end\n \n       it 'does not create any edits' do\n-        expect { subject.call(status, json) }.to_not(change { status.reload.edits.pluck(&:id) })\n+        expect { subject.call(status, json, json) }.to_not(change { status.reload.edits.pluck(&:id) })\n       end\n \n       it 'does not update the text, spoiler_text or edited_at' do\n-        expect { subject.call(status, json) }.to_not(change { s = status.reload; [s.text, s.spoiler_text, s.edited_at] })\n+        expect { subject.call(status, json, json) }.to_not(change { s = status.reload; [s.text, s.spoiler_text, s.edited_at] })\n       end\n     end\n \n@@ -233,7 +233,7 @@ def poll_option_json(name, votes)\n       end\n \n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'does not create any edits' do\n@@ -257,7 +257,7 @@ def poll_option_json(name, votes)\n \n       before do\n         status.update(ordered_media_attachment_ids: nil)\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'does not create any edits' do\n@@ -271,7 +271,7 @@ def poll_option_json(name, votes)\n \n     context 'when originally without tags' do\n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'updates tags' do\n@@ -297,7 +297,7 @@ def poll_option_json(name, votes)\n       end\n \n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'updates tags' do\n@@ -307,7 +307,7 @@ def poll_option_json(name, votes)\n \n     context 'when originally without mentions' do\n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'updates mentions' do\n@@ -319,7 +319,7 @@ def poll_option_json(name, votes)\n       let(:mentions) { [alice, bob] }\n \n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'updates mentions' do\n@@ -330,7 +330,7 @@ def poll_option_json(name, votes)\n     context 'when originally without media attachments' do\n       before do\n         stub_request(:get, 'https://example.com/foo.png').to_return(body: attachment_fixture('emojo.png'))\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       let(:payload) do\n@@ -380,7 +380,7 @@ def poll_option_json(name, votes)\n \n       before do\n         allow(RedownloadMediaWorker).to receive(:perform_async)\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'updates the existing media attachment in-place' do\n@@ -408,7 +408,7 @@ def poll_option_json(name, votes)\n       before do\n         poll = Fabricate(:poll, status: status)\n         status.update(preloadable_poll: poll)\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'removes poll' do\n@@ -438,7 +438,7 @@ def poll_option_json(name, votes)\n       end\n \n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'creates a poll' do\n@@ -454,12 +454,12 @@ def poll_option_json(name, votes)\n     end\n \n     it 'creates edit history' do\n-      subject.call(status, json)\n+      subject.call(status, json, json)\n       expect(status.edits.reload.map(&:text)).to eq ['Hello world', 'Hello universe']\n     end\n \n     it 'sets edited timestamp' do\n-      subject.call(status, json)\n+      subject.call(status, json, json)\n       expect(status.reload.edited_at.to_s).to eq '2021-09-08 22:39:25 UTC'\n     end\n   end\n---\n\n\n---\n\nChoice C:\napp/controllers/api/v1/notifications/requests_controller.rb\n@@ -52,7 +52,7 @@ def dismiss_bulk\n   private\n \n   def load_requests\n-    requests = NotificationRequest.where(account: current_account).includes(:last_status, from_account: [:account_stat, :user]).to_a_paginated_by_id(\n+    requests = NotificationRequest.where(account: current_account).without_suspended.includes(:last_status, from_account: [:account_stat, :user]).to_a_paginated_by_id(\n       limit_param(DEFAULT_ACCOUNTS_LIMIT),\n       params_slice(:max_id, :since_id, :min_id)\n     )\n---\napp/models/notification_policy.rb\n@@ -62,6 +62,6 @@ def filter_private_mentions=(value)\n   private\n \n   def pending_notification_requests\n-    @pending_notification_requests ||= notification_requests.limit(MAX_MEANINGFUL_COUNT).pick(Arel.sql('count(*), coalesce(sum(notifications_count), 0)::bigint'))\n+    @pending_notification_requests ||= notification_requests.without_suspended.limit(MAX_MEANINGFUL_COUNT).pick(Arel.sql('count(*), coalesce(sum(notifications_count), 0)::bigint'))\n   end\n end\n---\napp/models/notification_request.rb\n@@ -26,6 +26,8 @@ class NotificationRequest < ApplicationRecord\n \n   before_save :prepare_notifications_count\n \n+  scope :without_suspended, -> { joins(:from_account).merge(Account.without_suspended) }\n+\n   def self.preload_cache_collection(requests)\n     cached_statuses_by_id = yield(requests.filter_map(&:last_status)).index_by(&:id) # Call cache_collection in block\n \n---\nspec/models/notification_policy_spec.rb\n@@ -7,19 +7,25 @@\n     subject { Fabricate(:notification_policy) }\n \n     let(:sender) { Fabricate(:account) }\n+    let(:suspended_sender) { Fabricate(:account) }\n \n     before do\n       Fabricate.times(2, :notification, account: subject.account, activity: Fabricate(:status, account: sender), filtered: true, type: :mention)\n       Fabricate(:notification_request, account: subject.account, from_account: sender)\n-      subject.summarize!\n-    end\n \n-    it 'sets pending_requests_count' do\n-      expect(subject.pending_requests_count).to eq 1\n+      Fabricate(:notification, account: subject.account, activity: Fabricate(:status, account: suspended_sender), filtered: true, type: :mention)\n+      Fabricate(:notification_request, account: subject.account, from_account: suspended_sender)\n+\n+      suspended_sender.suspend!\n+\n+      subject.summarize!\n     end\n \n-    it 'sets pending_notifications_count' do\n-      expect(subject.pending_notifications_count).to eq 2\n+    it 'sets pending_requests_count and pending_notifications_count' do\n+      expect(subject).to have_attributes(\n+        pending_requests_count: 1,\n+        pending_notifications_count: 2\n+      )\n     end\n   end\n end\n---\n\n\n---\n\nChoice D:\napp/services/resolve_account_service.rb\n@@ -100,7 +100,9 @@ def process_webfinger!(uri)\n   end\n \n   def split_acct(acct)\n-    acct.delete_prefix('acct:').split('@')\n+    acct.delete_prefix('acct:').split('@').tap do |parts|\n+      raise Webfinger::Error, 'Webfinger response is missing user or host value' unless parts.size == 2\n+    end\n   end\n \n   def fetch_account!\n---\nspec/services/resolve_account_service_spec.rb\n@@ -144,6 +144,19 @@\n     end\n   end\n \n+  context 'with webfinger response subject missing a host value' do\n+    let(:body) { Oj.dump({ subject: 'user@' }) }\n+    let(:url) { 'https://host.example/.well-known/webfinger?resource=acct:user@host.example' }\n+\n+    before do\n+      stub_request(:get, url).to_return(status: 200, body: body)\n+    end\n+\n+    it 'returns nil with incomplete subject in response' do\n+      expect(subject.call('user@host.example')).to be_nil\n+    end\n+  end\n+\n   context 'with an ActivityPub account' do\n     it 'returns new remote account' do\n       account = subject.call('foo@ap.example.com')\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Turn on boost confirmation option\r\n2. Try to boost some post\r\n3. Press <kbd>Space</kbd> or <kbd>Enter</kbd> to confirm\r\n...\r\n\r\n\r\n### Expected behaviour\r\n\r\nPressing space or enter press confirmation button on dialog\r\n\r\n### Actual behaviour\r\n\r\nDefault focus is gone, Need to tab, shift+tab to focus on confirmation button to proceed\r\n\r\n### Detailed description\r\n\r\nOn Mastodon v4.2, Boost confirmation dialog has focused on confirmation button by default. So user can just press space or enter key to proceed (Shift+tab enter to press cancel button)\r\nAfter dialog rework, Default focus is gone. So user need to press shift+tab and tab to focus on confirmation button\r\n\r\nSame applied on post delete confirmation dialog\r\n\r\n### Mastodon instance\r\n\r\nmastodon.social\r\n\r\n### Mastodon version\r\n\r\nv4.3\r\n\r\n### Browser name and version\r\n\r\nFirefox 130.0\r\n\r\n### Operating system\r\n\r\nUbuntu 24.04.1 LTS\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/actions/settings.js\n@@ -20,7 +20,7 @@ export function changeSetting(path, value) {\n }\n \n const debouncedSave = debounce((dispatch, getState) => {\n-  if (getState().getIn(['settings', 'saved'])) {\n+  if (getState().getIn(['settings', 'saved']) || !getState().getIn(['meta', 'me'])) {\n     return;\n   }\n \n---\n\n\n---\n\nChoice B:\napp/lib/translation_service/deepl.rb\n@@ -46,7 +46,7 @@ def transform_response(str)\n \n     raise UnexpectedResponseError unless json.is_a?(Hash)\n \n-    Translation.new(text: json.dig('translations', 0, 'text'), detected_source_language: json.dig('translations', 0, 'detected_source_language')&.downcase, provider: 'DeepL.com')\n+    Translation.new(text: Sanitize.fragment(json.dig('translations', 0, 'text'), Sanitize::Config::MASTODON_STRICT), detected_source_language: json.dig('translations', 0, 'detected_source_language')&.downcase, provider: 'DeepL.com')\n   rescue Oj::ParseError\n     raise UnexpectedResponseError\n   end\n---\napp/lib/translation_service/libre_translate.rb\n@@ -37,7 +37,7 @@ def transform_response(str, source_language)\n \n     raise UnexpectedResponseError unless json.is_a?(Hash)\n \n-    Translation.new(text: json['translatedText'], detected_source_language: source_language, provider: 'LibreTranslate')\n+    Translation.new(text: Sanitize.fragment(json['translatedText'], Sanitize::Config::MASTODON_STRICT), detected_source_language: source_language, provider: 'LibreTranslate')\n   rescue Oj::ParseError\n     raise UnexpectedResponseError\n   end\n---\napp/services/translate_status_service.rb\n@@ -12,8 +12,8 @@ def call(status, target_language)\n     @content = status_content_format(@status)\n     @target_language = target_language\n \n-    Rails.cache.fetch(\"translations/#{@status.language}/#{@target_language}/#{content_hash}\", expires_in: CACHE_TTL) do\n-      Sanitize.fragment(translation_backend.translate(@content, @status.language, @target_language), Sanitize::Config::MASTODON_STRICT)\n+    Rails.cache.fetch(\"translations:v2/#{@status.language}/#{@target_language}/#{content_hash}\", expires_in: CACHE_TTL) do\n+      translation_backend.translate(@content, @status.language, @target_language)\n     end\n   end\n \n---\napp/lib/translation_service/deepl.rb\n@@ -46,7 +46,7 @@ def transform_response(str)\n \n     raise UnexpectedResponseError unless json.is_a?(Hash)\n \n-    Translation.new(text: json.dig('translations', 0, 'text'), detected_source_language: json.dig('translations', 0, 'detected_source_language')&.downcase, provider: 'DeepL.com')\n+    Translation.new(text: Sanitize.fragment(json.dig('translations', 0, 'text'), Sanitize::Config::MASTODON_STRICT), detected_source_language: json.dig('translations', 0, 'detected_source_language')&.downcase, provider: 'DeepL.com')\n   rescue Oj::ParseError\n     raise UnexpectedResponseError\n   end\n---\napp/lib/translation_service/libre_translate.rb\n@@ -37,7 +37,7 @@ def transform_response(str, source_language)\n \n     raise UnexpectedResponseError unless json.is_a?(Hash)\n \n-    Translation.new(text: json['translatedText'], detected_source_language: source_language, provider: 'LibreTranslate')\n+    Translation.new(text: Sanitize.fragment(json['translatedText'], Sanitize::Config::MASTODON_STRICT), detected_source_language: source_language, provider: 'LibreTranslate')\n   rescue Oj::ParseError\n     raise UnexpectedResponseError\n   end\n---\napp/services/translate_status_service.rb\n@@ -12,8 +12,8 @@ def call(status, target_language)\n     @content = status_content_format(@status)\n     @target_language = target_language\n \n-    Rails.cache.fetch(\"translations/#{@status.language}/#{@target_language}/#{content_hash}\", expires_in: CACHE_TTL) do\n-      Sanitize.fragment(translation_backend.translate(@content, @status.language, @target_language), Sanitize::Config::MASTODON_STRICT)\n+    Rails.cache.fetch(\"translations:v2/#{@status.language}/#{@target_language}/#{content_hash}\", expires_in: CACHE_TTL) do\n+      translation_backend.translate(@content, @status.language, @target_language)\n     end\n   end\n \n---\n\n\n---\n\nChoice C:\npublic/embed.js\n@@ -81,7 +81,7 @@ const allowedPrefixes = (document.currentScript && document.currentScript.tagNam\n       embeds.set(id, iframe);\n \n       iframe.allow = 'fullscreen';\n-      iframe.sandbox = 'allow-scripts allow-same-origin';\n+      iframe.sandbox = 'allow-scripts allow-same-origin allow-popups';\n       iframe.style.border = 0;\n       iframe.style.overflow = 'hidden';\n       iframe.style.display = 'block';\n@@ -112,7 +112,7 @@ const allowedPrefixes = (document.currentScript && document.currentScript.tagNam\n       iframe.width = container.clientWidth;\n       iframe.height = 0;\n       iframe.allow = 'fullscreen';\n-      iframe.sandbox = 'allow-scripts allow-same-origin';\n+      iframe.sandbox = 'allow-scripts allow-same-origin allow-popups';\n       iframe.style.border = 0;\n       iframe.style.overflow = 'hidden';\n       iframe.style.display = 'block';\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/ui/components/block_modal.jsx\n@@ -99,7 +99,7 @@ export const BlockModal = ({ accountId, acct }) => {\n             <FormattedMessage id='confirmation_modal.cancel' defaultMessage='Cancel' />\n           </button>\n \n-          <Button onClick={handleClick}>\n+          <Button onClick={handleClick} autoFocus>\n             <FormattedMessage id='confirmations.block.confirm' defaultMessage='Block' />\n           </Button>\n         </div>\n---\napp/javascript/mastodon/features/ui/components/confirmation_modals/confirmation_modal.tsx\n@@ -71,7 +71,10 @@ export const ConfirmationModal: React.FC<\n             />\n           </button>\n \n-          <Button onClick={handleClick}>{confirm}</Button>\n+          {/* eslint-disable-next-line jsx-a11y/no-autofocus -- we are in a modal and thus autofocusing is justified */}\n+          <Button onClick={handleClick} autoFocus>\n+            {confirm}\n+          </Button>\n         </div>\n       </div>\n     </div>\n---\napp/javascript/mastodon/features/ui/components/domain_block_modal.jsx\n@@ -88,7 +88,7 @@ export const DomainBlockModal = ({ domain, accountId, acct }) => {\n             <FormattedMessage id='confirmation_modal.cancel' defaultMessage='Cancel' />\n           </button>\n \n-          <Button onClick={handleClick}>\n+          <Button onClick={handleClick} autoFocus>\n             <FormattedMessage id='domain_block_modal.block' defaultMessage='Block server' />\n           </Button>\n         </div>\n---\napp/javascript/mastodon/features/ui/components/mute_modal.jsx\n@@ -137,7 +137,7 @@ export const MuteModal = ({ accountId, acct }) => {\n             <FormattedMessage id='confirmation_modal.cancel' defaultMessage='Cancel' />\n           </button>\n \n-          <Button onClick={handleClick}>\n+          <Button onClick={handleClick} autoFocus>\n             <FormattedMessage id='confirmations.mute.confirm' defaultMessage='Mute' />\n           </Button>\n         </div>\n---\napp/javascript/mastodon/features/ui/components/boost_modal.tsx\n@@ -128,6 +128,8 @@ export const BoostModal: React.FC<{\n                 ? messages.cancel_reblog\n                 : messages.reblog,\n             )}\n+            /* eslint-disable-next-line jsx-a11y/no-autofocus -- We are in the modal */\n+            autoFocus\n           />\n         </div>\n       </div>\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Report a post\r\n2. Advance through report screens until you are given the opportunity to select multiple posts to add to the report\r\n\n\n### Expected behaviour\n\nCheck boxes to select posts are easily visible\n\n### Actual behaviour\n\nCheck boxes to select posts are extremely difficult to see\n\n### Detailed description\n\nAt first I thought the bug was the the checkboxes were completely missing until I leaned in and squinted at my screen.\r\n\r\n![20240904-075004-firefox](https://github.com/user-attachments/assets/bbe0d1fb-d873-44f5-ba12-d5b5ba6d20ab)\r\n\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.3.0-nightly.2024-09-03\n\n### Browser name and version\n\nFirefox 129.0.2\n\n### Operating system\n\nMicrosoft Windows [Version 10.0.19045.4780]\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/about/index.jsx\n@@ -6,6 +6,7 @@ import { defineMessages, injectIntl, FormattedMessage } from 'react-intl';\n import classNames from 'classnames';\n import { Helmet } from 'react-helmet';\n \n+import { List as ImmutableList } from 'immutable';\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import { connect } from 'react-redux';\n \n@@ -161,7 +162,7 @@ class About extends PureComponent {\n           </Section>\n \n           <Section title={intl.formatMessage(messages.rules)}>\n-            {!isLoading && (server.get('rules', []).isEmpty() ? (\n+            {!isLoading && (server.get('rules', ImmutableList()).isEmpty() ? (\n               <p><FormattedMessage id='about.not_available' defaultMessage='This information has not been made available on this server.' /></p>\n             ) : (\n               <ol className='rules-list'>\n---\n\n\n---\n\nChoice B:\napp/controllers/admin/domain_blocks_controller.rb\n@@ -37,7 +37,7 @@ def create\n         @domain_block.errors.delete(:domain)\n         render :new\n       else\n-        if existing_domain_block.present?\n+        if existing_domain_block.present? && existing_domain_block.domain == resource_params[:domain]\n           @domain_block = existing_domain_block\n           @domain_block.update(resource_params)\n         end\n---\nspec/controllers/admin/domain_blocks_controller_spec.rb\n@@ -68,6 +68,26 @@\n       expect(flash[:notice]).to eq I18n.t('admin.domain_blocks.created_msg')\n       expect(response).to redirect_to(admin_instances_path(limited: '1'))\n     end\n+\n+    context 'when a block for a parent domain already exists' do\n+      subject { post :create, params: { domain_block: { domain: 'subdomain.example.com', severity: child_severity } } }\n+\n+      let(:parent_severity) { 'silence' }\n+      let(:child_severity)  { 'suspend' }\n+\n+      before do\n+        Fabricate(:domain_block, domain: 'example.com', severity: parent_severity)\n+      end\n+\n+      it 'does not change the existing block' do\n+        expect { subject }.to_not change { DomainBlock.find_by(domain: 'example.com') }\n+      end\n+\n+      it 'creates a domain block with expected severity' do\n+        subject\n+        expect(DomainBlock.where(domain: 'subdomain.example.com', severity: child_severity)).to exist\n+      end\n+    end\n   end\n \n   describe 'PUT #update' do\n---\napp/controllers/admin/domain_blocks_controller.rb\n@@ -40,7 +40,7 @@ def create\n       end\n \n       # Allow transparently upgrading a domain block\n-      if existing_domain_block.present?\n+      if existing_domain_block.present? && existing_domain_block.domain == TagManager.instance.normalize_domain(@domain_block.domain.strip)\n         @domain_block = existing_domain_block\n         @domain_block.assign_attributes(resource_params)\n       end\n---\nspec/features/admin/domain_blocks_spec.rb\n@@ -57,6 +57,30 @@\n     end\n   end\n \n+  context 'when suspending a subdomain of an already-silenced domain' do\n+    it 'presents a confirmation screen before suspending the domain' do\n+      domain_block = Fabricate(:domain_block, domain: 'example.com', severity: 'silence')\n+\n+      visit new_admin_domain_block_path\n+\n+      fill_in 'domain_block_domain', with: 'subdomain.example.com'\n+      select I18n.t('admin.domain_blocks.new.severity.suspend'), from: 'domain_block_severity'\n+      click_on I18n.t('admin.domain_blocks.new.create')\n+\n+      # It presents a confirmation screen\n+      expect(page).to have_title(I18n.t('admin.domain_blocks.confirm_suspension.title', domain: 'subdomain.example.com'))\n+\n+      # Confirming creates the block\n+      click_on I18n.t('admin.domain_blocks.confirm_suspension.confirm')\n+\n+      expect(DomainBlock.where(domain: 'subdomain.example.com', severity: 'suspend')).to exist\n+\n+      # And leaves the previous block alone\n+      expect(domain_block.reload.severity).to eq 'silence'\n+      expect(domain_block.reload.domain).to eq 'example.com'\n+    end\n+  end\n+\n   context 'when editing a domain block' do\n     it 'presents a confirmation screen before suspending the domain' do\n       domain_block = Fabricate(:domain_block, domain: 'example.com', severity: 'silence')\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -6437,7 +6437,7 @@ a.status-card {\n   }\n \n   .dialog-option .poll__input {\n-    border-color: $inverted-text-color;\n+    border-color: $darker-text-color;\n     color: $ui-secondary-color;\n     display: inline-flex;\n     align-items: center;\n@@ -6451,13 +6451,13 @@ a.status-card {\n     &:active,\n     &:focus,\n     &:hover {\n-      border-color: lighten($inverted-text-color, 15%);\n+      border-color: $valid-value-color;\n       border-width: 4px;\n     }\n \n     &.active {\n-      border-color: $inverted-text-color;\n-      background: $inverted-text-color;\n+      border-color: $valid-value-color;\n+      background: $valid-value-color;\n     }\n   }\n \n---\n\n\n---\n\nChoice D:\napp/controllers/api/v1/admin/accounts_controller.rb\n@@ -46,8 +46,10 @@ def show\n \n   def enable\n     authorize @account.user, :enable?\n-    @account.user.enable!\n-    log_action :enable, @account.user\n+    if @account.user.disabled\n+      @account.user.enable!\n+      log_action :enable, @account.user\n+    end\n     render json: @account, serializer: REST::Admin::AccountSerializer\n   end\n \n@@ -71,15 +73,19 @@ def destroy\n \n   def unsensitive\n     authorize @account, :unsensitive?\n-    @account.unsensitize!\n-    log_action :unsensitive, @account\n+    if @account.sensitized?\n+      @account.unsensitize!\n+      log_action :unsensitive, @account\n+    end\n     render json: @account, serializer: REST::Admin::AccountSerializer\n   end\n \n   def unsilence\n     authorize @account, :unsilence?\n-    @account.unsilence!\n-    log_action :unsilence, @account\n+    if @account.silenced?\n+      @account.unsilence!\n+      log_action :unsilence, @account\n+    end\n     render json: @account, serializer: REST::Admin::AccountSerializer\n   end\n \n---\napp/controllers/api/v1/admin/reports_controller.rb\n@@ -40,29 +40,37 @@ def update\n \n   def assign_to_self\n     authorize @report, :update?\n-    @report.update!(assigned_account_id: current_account.id)\n-    log_action :assigned_to_self, @report\n+    unless @report.assigned_account_id == current_account.id\n+      @report.update!(assigned_account_id: current_account.id)\n+      log_action :assigned_to_self, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n   def unassign\n     authorize @report, :update?\n-    @report.update!(assigned_account_id: nil)\n-    log_action :unassigned, @report\n+    if @report.assigned_account_id\n+      @report.update!(assigned_account_id: nil)\n+      log_action :unassigned, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n   def reopen\n     authorize @report, :update?\n-    @report.unresolve!\n-    log_action :reopen, @report\n+    unless @report.unresolved?\n+      @report.unresolve!\n+      log_action :reopen, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n   def resolve\n     authorize @report, :update?\n-    @report.resolve!(current_account)\n-    log_action :resolve, @report\n+    unless @report.action_taken?\n+      @report.resolve!(current_account)\n+      log_action :resolve, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n---\nspec/controllers/admin/reports_controller_spec.rb\n@@ -64,7 +64,7 @@\n \n   describe 'POST #reopen' do\n     it 'reopens the report' do\n-      report = Fabricate(:report)\n+      report = Fabricate(:report, action_taken_at: 3.days.ago)\n \n       put :reopen, params: { id: report }\n       expect(response).to redirect_to(admin_report_path(report))\n@@ -89,7 +89,7 @@\n \n   describe 'POST #unassign' do\n     it 'reopens the report' do\n-      report = Fabricate(:report)\n+      report = Fabricate(:report, assigned_account_id: Account.last.id)\n \n       put :unassign, params: { id: report }\n       expect(response).to redirect_to(admin_report_path(report))\n---\napp/models/admin/account_action.rb\n@@ -132,26 +132,26 @@ def process_reports!\n \n   def handle_disable!\n     authorize(target_account.user, :disable?)\n-    log_action(:disable, target_account.user)\n     target_account.user&.disable!\n+    log_action(:disable, target_account.user)\n   end\n \n   def handle_sensitive!\n     authorize(target_account, :sensitive?)\n-    log_action(:sensitive, target_account)\n     target_account.sensitize!\n+    log_action(:sensitive, target_account)\n   end\n \n   def handle_silence!\n     authorize(target_account, :silence?)\n-    log_action(:silence, target_account)\n     target_account.silence!\n+    log_action(:silence, target_account)\n   end\n \n   def handle_suspend!\n     authorize(target_account, :suspend?)\n-    log_action(:suspend, target_account)\n     target_account.suspend!(origin: :local)\n+    log_action(:suspend, target_account)\n   end\n \n   def text_for_warning\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nThe [Obtain a token](https://docs.joinmastodon.org/methods/oauth/#token) endpoint is available to browser clients via CORS requests\r\n\r\nbut the [Revoke a token](https://docs.joinmastodon.org/methods/oauth/#revoke) endpoint is not\r\n\r\nPlease add the CORS headers to revoke, as it is the flip side of obtain and needed for browser-only clients.\r\n\r\nThanks!\n\n### Expected behaviour\n\nThe revoke endpoint should have been available over CORS\n\n### Actual behaviour\n\nThe revoke endpoint was not available over CORS\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.3.0-nightly.2024-09-03\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/components/admin/Retention.jsx\n@@ -9,11 +9,12 @@ import api from 'mastodon/api';\n import { roundTo10 } from 'mastodon/utils/numbers';\n \n const dateForCohort = cohort => {\n+  const timeZone = 'UTC';\n   switch(cohort.frequency) {\n   case 'day':\n-    return <FormattedDate value={cohort.period} month='long' day='2-digit' />;\n+    return <FormattedDate value={cohort.period} month='long' day='2-digit' timeZone={timeZone} />;\n   default:\n-    return <FormattedDate value={cohort.period} month='long' year='numeric' />;\n+    return <FormattedDate value={cohort.period} month='long' year='numeric' timeZone={timeZone} />;\n   }\n };\n \n---\n\n\n---\n\nChoice B:\nconfig/initializers/paperclip.rb\n@@ -88,6 +88,19 @@\n \n   Paperclip::Attachment.default_options[:s3_headers]['X-Amz-Storage-Class'] = ENV['S3_STORAGE_CLASS'] if ENV.has_key?('S3_STORAGE_CLASS')\n \n+  # Some S3 providers are not compatible with the checksum mode\n+  # See https://github.com/mastodon/mastodon/issues/26394\n+  if ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n+    module Aws::S3::FileDownloaderExtensions\n+      def validate!\n+        @params.delete(:checksum_mode)\n+        super\n+      end\n+    end\n+\n+    Aws::S3::FileDownloader.prepend(Aws::S3::FileDownloaderExtensions)\n+  end\n+\n   # Some S3-compatible providers might not actually be compatible with some APIs\n   # used by kt-paperclip, see https://github.com/mastodon/mastodon/issues/16822\n   if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n---\nconfig/initializers/paperclip.rb\n@@ -90,13 +90,19 @@\n \n   # Some S3-compatible providers might not actually be compatible with some APIs\n   # used by kt-paperclip, see https://github.com/mastodon/mastodon/issues/16822\n-  if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n+  # and https://github.com/mastodon/mastodon/issues/26394\n+  if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true' || ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n     module Paperclip\n       module Storage\n         module S3Extensions\n           def copy_to_local_file(style, local_dest_path)\n             log(\"copying #{path(style)} to local file #{local_dest_path}\")\n-            s3_object(style).download_file(local_dest_path, { mode: 'single_request' })\n+\n+            options = {}\n+            options[:mode] = 'single_request' if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n+            options[:checksum_mode] = 'DISABLED' if ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n+\n+            s3_object(style).download_file(local_dest_path, options)\n           rescue Aws::Errors::ServiceError => e\n             warn(\"#{e} - cannot copy #{path(style)} to local file #{local_dest_path}\")\n             false\n---\n\n\n---\n\nChoice C:\nconfig/initializers/cors.rb\n@@ -22,6 +22,7 @@\n                expose: %w(Link X-RateLimit-Reset X-RateLimit-Limit X-RateLimit-Remaining X-Request-Id),\n                methods: %i(post put delete get patch options)\n       resource '/oauth/token', methods: [:post]\n+      resource '/oauth/revoke', methods: [:post]\n     end\n   end\n end\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -10453,7 +10453,7 @@ noscript {\n       gap: 4px;\n \n       dt {\n-        flex: 0 0 auto;\n+        flex: 0 1 auto;\n         color: $dark-text-color;\n         min-width: 0;\n         overflow: hidden;\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Be an admin of an instance\r\n2. Require verification for new accounts\r\n3. As another user: Make a new account with a non default localization\r\n4. As an admin: Receive email with wrong localization \r\n\n\n### Expected behaviour\n\nEmail to admin should be standard/default localization\n\n### Actual behaviour\n\nEmail to admin is sent in the user's localization\n\n### Detailed description\n\nIf a user sets their language to some other language the email that comes to the admin of the instance to verify them is of that localization rather than the instances default.\r\n\r\nUser has this selected:\r\n![image](https://github.com/user-attachments/assets/f2292a75-27ce-4ae8-abf5-0b54a3d00adf)\r\n\r\nEmail received **to the admin:**\r\n![image](https://github.com/user-attachments/assets/b97f9dfa-33e1-4e9d-8d92-14f89cf803bd)\r\n\r\nTranslation:\r\n```\r\nNew account up for review on fuzzies.wtf\r\nThe details of the new account are below. You can approve or reject this application.\r\n```\n\n### Mastodon instance\n\nfuzzies.wtf\n\n### Mastodon version\n\nv4.3.0-alpha.5+no-portals\n\n### Technical details\n\n- Ruby version: ruby 3.3.4 (2024-07-09 revision be1089c8ec) [x86_64-linux]\r\n- Node.js version: v20.17.0\r\n\n\n---\n\nChoice A:\napp/javascript/mastodon/features/video/index.jsx\n@@ -469,6 +469,10 @@ class Video extends PureComponent {\n   };\n \n   _syncVideoToVolumeState = (volume = null, muted = null) => {\n+    if (!this.video) {\n+      return;\n+    }\n+\n     this.video.volume = volume ?? this.state.volume;\n     this.video.muted = muted ?? this.state.muted;\n   };\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/components/status.jsx\n@@ -546,7 +546,7 @@ class Status extends ImmutablePureComponent {\n     const visibilityIcon = visibilityIconInfo[status.get('visibility')];\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n-    const expanded = !status.get('hidden')\n+    const expanded = !status.get('hidden') || status.get('spoiler_text').length === 0;\n \n     return (\n       <HotKeys handlers={handlers}>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -293,7 +293,7 @@ class DetailedStatus extends ImmutablePureComponent {\n     }\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n-    const expanded = !status.get('hidden')\n+    const expanded = !status.get('hidden') || status.get('spoiler_text').length === 0;\n \n     return (\n       <div style={outerStyle}>\n---\n\n\n---\n\nChoice C:\napp/mailers/application_mailer.rb\n@@ -12,7 +12,7 @@ class ApplicationMailer < ActionMailer::Base\n   protected\n \n   def locale_for_account(account, &block)\n-    I18n.with_locale(account.user_locale || I18n.locale || I18n.default_locale, &block)\n+    I18n.with_locale(account.user_locale || I18n.default_locale, &block)\n   end\n \n   def set_autoreply_headers!\n---\napp/mailers/user_mailer.rb\n@@ -33,7 +33,7 @@ def reset_password_instructions(user, token, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -43,7 +43,7 @@ def password_change(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -53,7 +53,7 @@ def email_changed(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -63,7 +63,7 @@ def two_factor_enabled(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -73,7 +73,7 @@ def two_factor_disabled(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -83,7 +83,7 @@ def two_factor_recovery_codes_changed(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -93,7 +93,7 @@ def webauthn_enabled(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -103,7 +103,7 @@ def webauthn_disabled(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -114,7 +114,7 @@ def webauthn_credential_added(user, webauthn_credential)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: I18n.t('devise.mailer.webauthn_credential.added.subject')\n     end\n   end\n@@ -125,7 +125,7 @@ def webauthn_credential_deleted(user, webauthn_credential)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: I18n.t('devise.mailer.webauthn_credential.deleted.subject')\n     end\n   end\n@@ -219,7 +219,7 @@ def set_instance\n     @instance = Rails.configuration.x.local_domain\n   end\n \n-  def locale\n-    @resource.locale.presence || I18n.locale || I18n.default_locale\n+  def locale(use_current_locale: false)\n+    @resource.locale.presence || (use_current_locale && I18n.locale) || I18n.default_locale\n   end\n end\n---\n\n\n---\n\nChoice D:\npublic/embed.js\n@@ -81,7 +81,7 @@ const allowedPrefixes = (document.currentScript && document.currentScript.tagNam\n       embeds.set(id, iframe);\n \n       iframe.allow = 'fullscreen';\n-      iframe.sandbox = 'allow-scripts allow-same-origin';\n+      iframe.sandbox = 'allow-scripts allow-same-origin allow-popups';\n       iframe.style.border = 0;\n       iframe.style.overflow = 'hidden';\n       iframe.style.display = 'block';\n@@ -112,7 +112,7 @@ const allowedPrefixes = (document.currentScript && document.currentScript.tagNam\n       iframe.width = container.clientWidth;\n       iframe.height = 0;\n       iframe.allow = 'fullscreen';\n-      iframe.sandbox = 'allow-scripts allow-same-origin';\n+      iframe.sandbox = 'allow-scripts allow-same-origin allow-popups';\n       iframe.style.border = 0;\n       iframe.style.overflow = 'hidden';\n       iframe.style.display = 'block';\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Open mastodon.online in sailfish-browser\n\n### Expected behaviour\n\nThe mastodon web client should load and show my home feed\n\n### Actual behaviour\n\nOnly the background is shown, no content or even UI elements load due to a Javascript error\n\n### Detailed description\n\nmastodon.online used to work fine on Sailfish OS until a few days ago. I don't know exactly when it upgraded and from which version, but this suggests to me that it is a recent regression.\n\n### Mastodon instance\n\nmastodon.online\n\n### Mastodon version\n\nv4.3.0-nightly.2024-08-30\n\n### Browser name and version\n\nsailfish-browser-2.2.61-1.12.1.jolla.armv7hl\n\n### Operating system\n\nSailfish OS 4.5\n\n### Technical details\n\nWhen running sailfish-browser with the environment variable `EMBED_CONSOLE=1` set, I get the following output:\r\n```\r\nJavaScript error: https://mastodon.online/packs/js/common-55ba23609956620b878d.js, line 2: TypeError: Object.hasOwn is not a function\r\nCONSOLE message:\r\n[JavaScript Error: \"TypeError: Object.hasOwn is not a function\" {file: \"https://mastodon.online/packs/js/common-55ba23609956620b878d.js\" line: 2}]\r\n_@https://mastodon.online/packs/js/common-55ba23609956620b878d.js:2:975717\r\nv@https://mastodon.online/packs/js/common-55ba23609956620b878d.js:2:975589\r\n@https://mastodon.online/packs/js/common-55ba23609956620b878d.js:2:976597\r\ns@https://mastodon.online/packs/js/common-55ba23609956620b878d.js:2:35831\r\n@https://mastodon.online/packs/js/common-55ba23609956620b878d.js:2:131275\r\ns@https://mastodon.online/packs/js/common-55ba23609956620b878d.js:2:35831\r\n@https://mastodon.online/packs/js/common-55ba23609956620b878d.js:2:465627\r\ns@https://mastodon.online/packs/js/common-55ba23609956620b878d.js:2:35831\r\n1345@https://mastodon.online/packs/js/application-109fb489d7dc47acd238.chunk.js:1:24937\r\ns@https://mastodon.online/packs/js/common-55ba23609956620b878d.js:2:35831\r\nn@https://mastodon.online/packs/js/common-55ba23609956620b878d.js:2:430\r\nt@https://mastodon.online/packs/js/common-55ba23609956620b878d.js:2:293\r\n@https://mastodon.online/packs/js/application-109fb489d7dc47acd238.chunk.js:1:47\r\n```\n\n---\n\nChoice A:\napp/mailers/application_mailer.rb\n@@ -12,7 +12,7 @@ class ApplicationMailer < ActionMailer::Base\n   protected\n \n   def locale_for_account(account, &block)\n-    I18n.with_locale(account.user_locale || I18n.locale || I18n.default_locale, &block)\n+    I18n.with_locale(account.user_locale || I18n.default_locale, &block)\n   end\n \n   def set_autoreply_headers!\n---\napp/mailers/user_mailer.rb\n@@ -33,7 +33,7 @@ def reset_password_instructions(user, token, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -43,7 +43,7 @@ def password_change(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -53,7 +53,7 @@ def email_changed(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -63,7 +63,7 @@ def two_factor_enabled(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -73,7 +73,7 @@ def two_factor_disabled(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -83,7 +83,7 @@ def two_factor_recovery_codes_changed(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -93,7 +93,7 @@ def webauthn_enabled(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -103,7 +103,7 @@ def webauthn_disabled(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -114,7 +114,7 @@ def webauthn_credential_added(user, webauthn_credential)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: I18n.t('devise.mailer.webauthn_credential.added.subject')\n     end\n   end\n@@ -125,7 +125,7 @@ def webauthn_credential_deleted(user, webauthn_credential)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: I18n.t('devise.mailer.webauthn_credential.deleted.subject')\n     end\n   end\n@@ -219,7 +219,7 @@ def set_instance\n     @instance = Rails.configuration.x.local_domain\n   end\n \n-  def locale\n-    @resource.locale.presence || I18n.locale || I18n.default_locale\n+  def locale(use_current_locale: false)\n+    @resource.locale.presence || (use_current_locale && I18n.locale) || I18n.default_locale\n   end\n end\n---\n\n\n---\n\nChoice B:\nCHANGELOG.md\n@@ -2,6 +2,29 @@\n \n All notable changes to this project will be documented in this file.\n \n+## [4.3.7] - 2025-04-02\n+\n+### Add\n+\n+- Add delay to profile updates to debounce them (#34137 by @ClearlyClaire)\n+- Add support for paginating partial collections in `SynchronizeFollowersService` (#34272 and #34277 by @ClearlyClaire)\n+\n+### Changed\n+\n+- Change account suspensions to be federated to recently-followed accounts as well (#34294 by @ClearlyClaire)\n+- Change `AccountReachFinder` to consider statuses based on suspension date (#32805 and #34291 by @ClearlyClaire and @mjankowski)\n+- Change user archive signed URL TTL from 10 seconds to 1 hour (#34254 by @ClearlyClaire)\n+\n+### Fixed\n+\n+- Fix static version of animated PNG emojis not being properly extracted (#34337 by @ClearlyClaire)\n+- Fix filters not applying in detailed view, favourites and bookmarks (#34259 and #34260 by @ClearlyClaire)\n+- Fix handling of malformed/unusual HTML (#34201 by @ClearlyClaire)\n+- Fix `CacheBuster` being queued for missing media attachments (#34253 by @ClearlyClaire)\n+- Fix incorrect URL being used when cache busting (#34189 by @ClearlyClaire)\n+- Fix streaming server refusing unix socket path in `DATABASE_URL` (#34091 by @ClearlyClaire)\n+- Fix \u201cx\u201d hotkey not working on boosted filtered posts (#33758 by @ClearlyClaire)\n+\n ## [4.3.6] - 2025-03-13\n \n ### Security\n---\ndocker-compose.yml\n@@ -59,7 +59,7 @@ services:\n   web:\n     # You can uncomment the following line if you want to not use the prebuilt image, for example if you have local code changes\n     # build: .\n-    image: ghcr.io/mastodon/mastodon:v4.3.6\n+    image: ghcr.io/mastodon/mastodon:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -83,7 +83,7 @@ services:\n     # build:\n     #   dockerfile: ./streaming/Dockerfile\n     #   context: .\n-    image: ghcr.io/mastodon/mastodon-streaming:v4.3.6\n+    image: ghcr.io/mastodon/mastodon-streaming:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: node ./streaming/index.js\n@@ -102,7 +102,7 @@ services:\n   sidekiq:\n     # You can uncomment the following line if you want to not use the prebuilt image, for example if you have local code changes\n     # build: .\n-    image: ghcr.io/mastodon/mastodon:v4.3.6\n+    image: ghcr.io/mastodon/mastodon:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\nlib/mastodon/version.rb\n@@ -13,7 +13,7 @@ def minor\n     end\n \n     def patch\n-      6\n+      7\n     end\n \n     def default_prerelease\n---\n\n\n---\n\nChoice C:\n.browserslistrc\n@@ -1,6 +1,7 @@\n [production]\n defaults\n > 0.2%\n+firefox >= 78\n ios >= 15.6\n not dead\n not OperaMini all\n---\n\n\n---\n\nChoice D:\napp/helpers/application_helper.rb\n@@ -240,11 +240,16 @@ def prerender_custom_emojis(html, custom_emojis, other_options = {})\n     EmojiFormatter.new(html, custom_emojis, other_options.merge(animate: prefers_autoplay?)).to_s\n   end\n \n-  def site_icon_path(type, size = '48')\n-    icon = SiteUpload.find_by(var: type)\n-    return nil unless icon\n+  def instance_presenter\n+    @instance_presenter ||= InstancePresenter.new\n+  end\n+\n+  def favicon_path(size = '48')\n+    instance_presenter.favicon&.file&.url(size)\n+  end\n \n-    icon.file.url(size)\n+  def app_icon_path(size = '48')\n+    instance_presenter.app_icon&.file&.url(size)\n   end\n \n   private\n---\napp/presenters/instance_presenter.rb\n@@ -81,4 +81,16 @@ def thumbnail\n   def mascot\n     @mascot ||= Rails.cache.fetch('site_uploads/mascot') { SiteUpload.find_by(var: 'mascot') }\n   end\n+\n+  def favicon\n+    return @favicon if defined?(@favicon)\n+\n+    @favicon ||= Rails.cache.fetch('site_uploads/favicon') { SiteUpload.find_by(var: 'favicon') }\n+  end\n+\n+  def app_icon\n+    return @app_icon if defined?(@app_icon)\n+\n+    @app_icon ||= Rails.cache.fetch('site_uploads/app_icon') { SiteUpload.find_by(var: 'app_icon') }\n+  end\n end\n---\napp/serializers/manifest_serializer.rb\n@@ -27,7 +27,7 @@ def short_name\n \n   def icons\n     SiteUpload::ANDROID_ICON_SIZES.map do |size|\n-      src = site_icon_path('app_icon', size.to_i)\n+      src = app_icon_path(size.to_i)\n       src = URI.join(root_url, src).to_s if src.present?\n \n       {\n---\napp/views/layouts/application.html.haml\n@@ -11,13 +11,13 @@\n     - if storage_host?\n       %link{ rel: 'dns-prefetch', href: storage_host }/\n \n-    %link{ rel: 'icon', href: site_icon_path('favicon', 'ico') || '/favicon.ico', type: 'image/x-icon' }/\n+    %link{ rel: 'icon', href: favicon_path('ico') || '/favicon.ico', type: 'image/x-icon' }/\n \n     - SiteUpload::FAVICON_SIZES.each do |size|\n-      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: site_icon_path('favicon', size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n+      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: favicon_path(size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n \n     - SiteUpload::APPLE_ICON_SIZES.each do |size|\n-      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: site_icon_path('app_icon', size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n+      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: app_icon_path(size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n \n     %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n     %link{ rel: 'manifest', href: manifest_path(format: :json) }/\n---\nspec/helpers/application_helper_spec.rb\n@@ -286,26 +286,31 @@ def current_theme = 'default'\n     end\n   end\n \n-  describe '#site_icon_path' do\n+  describe 'favicon' do\n     context 'when an icon exists' do\n       let!(:favicon) { Fabricate(:site_upload, var: 'favicon') }\n+      let!(:app_icon) { Fabricate(:site_upload, var: 'app_icon') }\n \n       it 'returns the URL of the icon' do\n-        expect(helper.site_icon_path('favicon')).to eq(favicon.file.url('48'))\n+        expect(helper.favicon_path).to eq(favicon.file.url('48'))\n+        expect(helper.app_icon_path).to eq(app_icon.file.url('48'))\n       end\n \n       it 'returns the URL of the icon with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to eq(favicon.file.url('16'))\n+        expect(helper.favicon_path(16)).to eq(favicon.file.url('16'))\n+        expect(helper.app_icon_path(16)).to eq(app_icon.file.url('16'))\n       end\n     end\n \n     context 'when an icon does not exist' do\n       it 'returns nil' do\n-        expect(helper.site_icon_path('favicon')).to be_nil\n+        expect(helper.favicon_path).to be_nil\n+        expect(helper.app_icon_path).to be_nil\n       end\n \n       it 'returns nil with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to be_nil\n+        expect(helper.favicon_path(16)).to be_nil\n+        expect(helper.app_icon_path(16)).to be_nil\n       end\n     end\n   end\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Go to the notifications page and see it doesn't load\r\n2. Check the notifications item in the menu and see that it doesn't show a number even though other devices do show that there are notifications\n\n### Expected behaviour\n\nThe notification page should load successfully\n\n### Actual behaviour\n\nThe notification page encounters a Javascript error and keeps showing a spinner\n\n### Detailed description\n\nOn one system, I'm still using Firefox ESR 102, and I found that the notifications page on mastodon.online doesn't load any more. Also, I knew that I had notifications, but the number didn't show in the menu. The browser console shows a Javascript error.\n\n### Mastodon instance\n\nmastodon.online\n\n### Mastodon version\n\nv4.3.0-nightly.2024-08-30\n\n### Browser name and version\n\nFirefox ESR 102\n\n### Operating system\n\nopenSUSE 15.3\n\n### Technical details\n\nThe Javascript error I see on the browser console is the following:\r\n```\r\nUncaught (in promise) TypeError: i.findLast is not a function\r\n    Ne notification_groups.ts:267\r\n    Pe notification_groups.ts:287\r\n    Re notification_groups.ts:413\r\n    s createReducer.ts:179\r\n    produce immer.legacy-esm.js:589\r\n    s createReducer.ts:178\r\n    s createReducer.ts:151\r\n    default inert.esm.js:76\r\n    default inert.esm.js:73\r\n    Lt Immutable\r\n    default inert.esm.js:73\r\n    b Redux\r\n    dispatch autoBatchEnhancer.ts:114\r\n    un sounds.ts:83\r\n    rn errors.ts:50\r\n    sn loading_bar.ts:84\r\n    a index.js:2139\r\n    dispatch Redux\r\n    h createAsyncThunk.ts:369\r\n```\r\nThis call seems to have been added recently in commit f587ff643f (#30440).\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -4398,11 +4398,6 @@ a.status-card {\n   align-items: center;\n   justify-content: center;\n \n-  @supports (display: grid) {\n-    // hack to fix Chrome <57\n-    contain: strict;\n-  }\n-\n   & > span {\n     max-width: 500px;\n   }\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -2677,7 +2677,7 @@ $ui-header-logo-wordmark-width: 99px;\n }\n \n .tabs-bar__wrapper {\n-  background: var(--background-color-tint);\n+  background: var(--background-color);\n   backdrop-filter: var(--background-filter);\n   position: sticky;\n   top: $ui-header-height;\n---\n\n\n---\n\nChoice C:\napp/controllers/admin/accounts_controller.rb\n@@ -128,7 +128,7 @@ def remove_header\n     def unblock_email\n       authorize @account, :unblock_email?\n \n-      CanonicalEmailBlock.matching_account(@account).delete_all\n+      CanonicalEmailBlock.where(reference_account: @account).delete_all\n \n       log_action :unblock_email, @account\n \n---\napp/models/canonical_email_block.rb\n@@ -20,7 +20,6 @@ class CanonicalEmailBlock < ApplicationRecord\n   validates :canonical_email_hash, presence: true, uniqueness: true\n \n   scope :matching_email, ->(email) { where(canonical_email_hash: email_to_canonical_email_hash(email)) }\n-  scope :matching_account, ->(account) { matching_email(account&.user_email).or(where(reference_account: account)) }\n \n   def to_log_human_identifier\n     canonical_email_hash\n---\napp/views/admin/accounts/show.html.haml\n@@ -30,7 +30,7 @@\n = render 'admin/accounts/counters', account: @account\n \n - if @account.local? && @account.user.nil?\n-  = link_to t('admin.accounts.unblock_email'), unblock_email_admin_account_path(@account.id), method: :post, class: 'button' if can?(:unblock_email, @account) && CanonicalEmailBlock.matching_account(@account).exists?\n+  = link_to t('admin.accounts.unblock_email'), unblock_email_admin_account_path(@account.id), method: :post, class: 'button' if can?(:unblock_email, @account) && CanonicalEmailBlock.exists?(reference_account_id: @account.id)\n - else\n   .table-wrapper\n     %table.table.inline-table\n---\nspec/fabricators/canonical_email_block_fabricator.rb\n@@ -1,6 +1,6 @@\n # frozen_string_literal: true\n \n Fabricator(:canonical_email_block) do\n-  email { |attrs| attrs[:reference_account] ? attrs[:reference_account].user_email : sequence(:email) { |i| \"#{i}#{Faker::Internet.email}\" } }\n+  email { sequence(:email) { |i| \"#{i}#{Faker::Internet.email}\" } }\n   reference_account { Fabricate.build(:account) }\n end\n---\nspec/controllers/admin/accounts_controller_spec.rb\n@@ -53,11 +53,32 @@\n \n   describe 'GET #show' do\n     let(:current_user) { Fabricate(:user, role: UserRole.find_by(name: 'Admin')) }\n-    let(:account) { Fabricate(:account) }\n \n-    it 'returns http success' do\n-      get :show, params: { id: account.id }\n-      expect(response).to have_http_status(200)\n+    context 'with a remote account' do\n+      let(:account) { Fabricate(:account, domain: 'example.com') }\n+\n+      it 'returns http success' do\n+        get :show, params: { id: account.id }\n+        expect(response).to have_http_status(200)\n+      end\n+    end\n+\n+    context 'with a local account' do\n+      let(:account) { Fabricate(:account, domain: nil) }\n+\n+      it 'returns http success' do\n+        get :show, params: { id: account.id }\n+        expect(response).to have_http_status(200)\n+      end\n+    end\n+\n+    context 'with a local deleted account' do\n+      let(:account) { Fabricate(:account, domain: nil, user: nil) }\n+\n+      it 'returns http success' do\n+        get :show, params: { id: account.id }\n+        expect(response).to have_http_status(200)\n+      end\n     end\n   end\n \n---\n\n\n---\n\nChoice D:\n.browserslistrc\n@@ -1,6 +1,7 @@\n [production]\n defaults\n > 0.2%\n+firefox >= 78\n ios >= 15.6\n not dead\n not OperaMini all\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Attach a picture to a new post\r\n2. Try to publish it (with or without text)\r\n3. Error: `422 Media {id} not found or already attached to another post`\r\n\r\n\r\n### Expected behaviour\r\n\r\nPost published with the media attached\r\n\r\n### Actual behaviour\r\n\r\nError 422\r\n\r\n### Detailed description\r\n\r\nAfter #31681, it's no longer possible to publish a new toot with media attached. It immediately throws an error `422 Media {id} not found or already attached to another post`. It doesn't matter if the post contains text or not. Broken via web and via apps.\r\n\r\n### Mastodon instance\r\n\r\nbolha.one, ursal.zone\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-beta.1-491033c\r\n\r\n### Technical details\r\n\r\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: `3.3.4`\r\n- Node.js version: `20.17.0`\r\n\n\n---\n\nChoice A:\napp/services/post_status_service.rb\n@@ -134,7 +134,7 @@ def validate_media!\n \n     @media = @account.media_attachments.where(status_id: nil).where(id: @options[:media_ids].take(Status::MEDIA_ATTACHMENTS_LIMIT).map(&:to_i))\n \n-    not_found_ids = @options[:media_ids] - @media.map(&:id)\n+    not_found_ids = @options[:media_ids].map(&:to_i) - @media.map(&:id)\n     raise Mastodon::ValidationError, I18n.t('media_attachments.validations.not_found', ids: not_found_ids.join(', ')) if not_found_ids.any?\n \n     raise Mastodon::ValidationError, I18n.t('media_attachments.validations.images_and_video') if @media.size > 1 && @media.find(&:audio_or_video?)\n---\napp/services/update_status_service.rb\n@@ -73,7 +73,7 @@ def validate_media!\n \n     media_attachments = @status.account.media_attachments.where(status_id: [nil, @status.id]).where(scheduled_status_id: nil).where(id: @options[:media_ids].take(Status::MEDIA_ATTACHMENTS_LIMIT).map(&:to_i)).to_a\n \n-    not_found_ids = @options[:media_ids] - media_attachments.map(&:id)\n+    not_found_ids = @options[:media_ids].map(&:to_i) - media_attachments.map(&:id)\n     raise Mastodon::ValidationError, I18n.t('media_attachments.validations.not_found', ids: not_found_ids.join(', ')) if not_found_ids.any?\n \n     raise Mastodon::ValidationError, I18n.t('media_attachments.validations.images_and_video') if media_attachments.size > 1 && media_attachments.find(&:audio_or_video?)\n---\nspec/services/post_status_service_spec.rb\n@@ -34,15 +34,15 @@\n \n     it 'schedules a status for future creation and does not create one immediately' do\n       media = Fabricate(:media_attachment, account: account)\n-      status = subject.call(account, text: 'Hi future!', media_ids: [media.id], scheduled_at: future)\n+      status = subject.call(account, text: 'Hi future!', media_ids: [media.id.to_s], scheduled_at: future)\n \n       expect(status)\n         .to be_a(ScheduledStatus)\n         .and have_attributes(\n           scheduled_at: eq(future),\n           params: include(\n             'text' => eq('Hi future!'),\n-            'media_ids' => contain_exactly(media.id)\n+            'media_ids' => contain_exactly(media.id.to_s)\n           )\n         )\n       expect(media.reload.status).to be_nil\n@@ -219,7 +219,7 @@\n     status = subject.call(\n       account,\n       text: 'test status update',\n-      media_ids: [media.id]\n+      media_ids: [media.id.to_s]\n     )\n \n     expect(media.reload.status).to eq status\n@@ -233,7 +233,7 @@\n       subject.call(\n         account,\n         text: 'test status update',\n-        media_ids: [media.id]\n+        media_ids: [media.id.to_s]\n       )\n     end.to raise_error(\n       Mastodon::ValidationError,\n@@ -249,7 +249,7 @@\n       subject.call(\n         account,\n         text: 'test status update',\n-        media_ids: Array.new(2) { Fabricate(:media_attachment, account: account) }.map(&:id)\n+        media_ids: Array.new(2) { Fabricate(:media_attachment, account: account) }.map { |m| m.id.to_s }\n       )\n     end.to raise_error(\n       Mastodon::ValidationError,\n@@ -271,7 +271,7 @@\n         media_ids: [\n           video,\n           image,\n-        ].map(&:id)\n+        ].map { |m| m.id.to_s }\n       )\n     end.to raise_error(\n       Mastodon::ValidationError,\n---\nspec/services/update_status_service_spec.rb\n@@ -69,7 +69,7 @@\n \n     before do\n       status.media_attachments << detached_media_attachment\n-      subject.call(status, status.account_id, text: 'Foo', media_ids: [attached_media_attachment.id])\n+      subject.call(status, status.account_id, text: 'Foo', media_ids: [attached_media_attachment.id.to_s])\n     end\n \n     it 'updates media attachments' do\n@@ -95,7 +95,7 @@\n \n     before do\n       status.media_attachments << media_attachment\n-      subject.call(status, status.account_id, text: 'Foo', media_ids: [media_attachment.id], media_attributes: [{ id: media_attachment.id, description: 'New description' }])\n+      subject.call(status, status.account_id, text: 'Foo', media_ids: [media_attachment.id.to_s], media_attributes: [{ id: media_attachment.id, description: 'New description' }])\n     end\n \n     it 'does not detach media attachment' do\n---\n\n\n---\n\nChoice B:\napp/models/account_suggestions/friends_of_friends_source.rb\n@@ -2,15 +2,19 @@\n \n class AccountSuggestions::FriendsOfFriendsSource < AccountSuggestions::Source\n   def get(account, limit: DEFAULT_LIMIT)\n+    source_query(account, limit: limit)\n+      .map { |id, _frequency, _followers_count| [id, key] }\n+  end\n+\n+  def source_query(account, limit: DEFAULT_LIMIT)\n     first_degree = account.following.where.not(hide_collections: true).select(:id).reorder(nil)\n     base_account_scope(account)\n       .joins(:account_stat)\n-      .where(id: Follow.where(account_id: first_degree).select(:target_account_id))\n+      .joins(:passive_relationships).where(passive_relationships: { account_id: first_degree })\n       .group('accounts.id, account_stats.id')\n-      .reorder('frequency DESC, followers_count DESC')\n+      .reorder(frequency: :desc, followers_count: :desc)\n       .limit(limit)\n-      .pluck(Arel.sql('accounts.id, COUNT(*) AS frequency'))\n-      .map { |id, _frequency| [id, key] }\n+      .pluck(Arel.sql('accounts.id, COUNT(*) AS frequency, followers_count'))\n   end\n \n   private\n---\nspec/models/account_suggestions/friends_of_friends_source_spec.rb\n@@ -11,9 +11,9 @@\n     let!(:eve) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:mallory) { Fabricate(:account, discoverable: false, hide_collections: false) }\n     let!(:eugen) { Fabricate(:account, discoverable: true, hide_collections: false) }\n+    let!(:neil) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:john) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:jerk) { Fabricate(:account, discoverable: true, hide_collections: false) }\n-    let!(:neil) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:larry) { Fabricate(:account, discoverable: true, hide_collections: false) }\n \n     context 'with follows and blocks' do\n@@ -70,13 +70,31 @@\n       end\n \n       it 'returns eligible accounts in the expected order' do\n-        expect(subject.get(bob)).to eq [\n-          [eugen.id, :friends_of_friends], # followed by 2 friends, 3 followers total\n-          [john.id, :friends_of_friends], # followed by 2 friends, 2 followers total\n-          [neil.id, :friends_of_friends], # followed by 1 friend, 2 followers total\n-          [jerk.id, :friends_of_friends], # followed by 1 friend, 1 follower total\n+        expect(subject.get(bob)).to eq expected_results\n+      end\n+\n+      it 'contains correct underlying source data' do\n+        expect(source_query_values)\n+          .to contain_exactly(\n+            [eugen.id, 2, 3], # Followed by 2 friends of bob (eve, mallory), 3 followers total (breaks tie)\n+            [john.id, 2, 2],  # Followed by 2 friends of bob (eve, mallory), 2 followers total\n+            [neil.id, 1, 2],  # Followed by 1 friends of bob (mallory), 2 followers total (breaks tie)\n+            [jerk.id, 1, 1]   # Followed by 1 friends of bob (eve), 1 followers total\n+          )\n+      end\n+\n+      def expected_results\n+        [\n+          [eugen.id, :friends_of_friends],\n+          [john.id, :friends_of_friends],\n+          [neil.id, :friends_of_friends],\n+          [jerk.id, :friends_of_friends],\n         ]\n       end\n+\n+      def source_query_values\n+        subject.source_query(bob).to_a\n+      end\n     end\n   end\n end\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/home_timeline/components/inline_follow_suggestions.jsx\n@@ -129,8 +129,13 @@ export const InlineFollowSuggestions = ({ hidden }) => {\n       return;\n     }\n \n-    setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n-    setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    if (getComputedStyle(bodyRef.current).direction === 'rtl') {\n+      setCanScrollLeft((bodyRef.current.clientWidth - bodyRef.current.scrollLeft) < bodyRef.current.scrollWidth);\n+      setCanScrollRight(bodyRef.current.scrollLeft < 0);\n+    } else {\n+      setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n+      setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    }\n   }, [setCanScrollRight, setCanScrollLeft, bodyRef, suggestions]);\n \n   const handleLeftNav = useCallback(() => {\n---\n\n\n---\n\nChoice D:\ndb/post_migrate/20230811103651_remove_index_preview_cards_statuses_on_status_id_and_preview_card_id.rb\n@@ -0,0 +1,9 @@\n+# frozen_string_literal: true\n+\n+class RemoveIndexPreviewCardsStatusesOnStatusIdAndPreviewCardId < ActiveRecord::Migration[7.0]\n+  disable_ddl_transaction!\n+\n+  def change\n+    remove_index :preview_cards_statuses, column: [:status_id, :preview_card_id], name: :index_preview_cards_statuses_on_status_id_and_preview_card_id\n+  end\n+end\n---\ndb/schema.rb\n@@ -10,7 +10,7 @@\n #\n # It's strongly recommended that you check this file into your version control system.\n \n-ActiveRecord::Schema[7.0].define(version: 2023_08_03_112520) do\n+ActiveRecord::Schema[7.0].define(version: 2023_08_11_103651) do\n   # These are extensions that must be enabled in order to support this database\n   enable_extension \"plpgsql\"\n \n@@ -809,7 +809,6 @@\n   create_table \"preview_cards_statuses\", primary_key: [\"status_id\", \"preview_card_id\"], force: :cascade do |t|\n     t.bigint \"preview_card_id\", null: false\n     t.bigint \"status_id\", null: false\n-    t.index [\"status_id\", \"preview_card_id\"], name: \"index_preview_cards_statuses_on_status_id_and_preview_card_id\"\n   end\n \n   create_table \"relays\", force: :cascade do |t|\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\nClick \"edit\" on uploaded image, And see this modal dialog\r\n![image](https://github.com/user-attachments/assets/92a49b13-eb49-46f4-8fe1-b7d72c74bf5e)\r\n\r\n### Expected behaviour\r\n\r\nMatched color theme with other modals\r\n\r\n### Actual behaviour\r\n\r\nModal's background is light while its textedit box and other modals are dark\r\n\r\n### Detailed description\r\n\r\nOther modals using dark theme\r\nBoost:\r\n![image](https://github.com/user-attachments/assets/4d60257d-f1f6-4455-bf93-95f4e24d41f5)\r\nMute user:\r\n![image](https://github.com/user-attachments/assets/e6c7e6d0-a3d1-40b7-86a9-998f86c0dc82)\r\n\r\n\r\n### Mastodon instance\r\n\r\ndevelopment version\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-beta.1\r\n\r\n### Browser name and version\r\n\r\nFirefox 129.0.2\r\n\r\n### Operating system\r\n\r\nUbuntu 22.04.4 LTS\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -159,8 +159,8 @@\n .error-modal,\n .onboarding-modal,\n .compare-history-modal,\n-.report-modal__comment .setting-text__wrapper,\n-.report-modal__comment .setting-text,\n+.report-modal__comment,\n+.report-modal__comment,\n .announcements,\n .picture-in-picture__header,\n .picture-in-picture__footer,\n@@ -169,6 +169,11 @@\n   border: 1px solid var(--background-border-color);\n }\n \n+.setting-text__wrapper,\n+.setting-text {\n+  border: 1px solid var(--background-border-color);\n+}\n+\n .reactions-bar__item:hover,\n .reactions-bar__item:focus,\n .reactions-bar__item:active {\n@@ -198,14 +203,6 @@\n   color: $white;\n }\n \n-.report-modal__comment {\n-  border-right-color: lighten($ui-base-color, 8%);\n-}\n-\n-.report-modal__container {\n-  border-top-color: lighten($ui-base-color, 8%);\n-}\n-\n .column-settings__hashtags .column-select__option {\n   color: $white;\n }\n---\napp/javascript/styles/mastodon/components.scss\n@@ -3911,7 +3911,7 @@ $ui-header-logo-wordmark-width: 99px;\n \n   &__wrapper {\n     background: $white;\n-    border: 1px solid $ui-secondary-color;\n+    border: 1px solid var(--background-border-color);\n     margin-bottom: 10px;\n     border-radius: 4px;\n \n@@ -6298,9 +6298,10 @@ a.status-card {\n .report-modal,\n .actions-modal,\n .compare-history-modal {\n-  background: lighten($ui-secondary-color, 8%);\n-  color: $inverted-text-color;\n-  border-radius: 8px;\n+  background: var(--background-color);\n+  color: $primary-text-color;\n+  border-radius: 4px;\n+  border: 1px solid var(--background-border-color);\n   overflow: hidden;\n   max-width: 90vw;\n   width: 480px;\n@@ -6344,6 +6345,7 @@ a.status-card {\n .report-modal {\n   width: 90vw;\n   max-width: 700px;\n+  border: 1px solid var(--background-border-color);\n }\n \n .report-dialog-modal {\n@@ -6567,7 +6569,7 @@ a.status-card {\n \n .report-modal__container {\n   display: flex;\n-  border-top: 1px solid $ui-secondary-color;\n+  border-top: 1px solid var(--background-border-color);\n \n   @media screen and (width <= 480px) {\n     flex-wrap: wrap;\n@@ -6625,7 +6627,7 @@ a.status-card {\n \n .report-modal__comment {\n   padding: 20px;\n-  border-inline-end: 1px solid $ui-secondary-color;\n+  border-inline-end: 1px solid var(--background-border-color);\n   max-width: 320px;\n \n   p {\n@@ -6636,7 +6638,7 @@ a.status-card {\n \n   .setting-text-label {\n     display: block;\n-    color: $inverted-text-color;\n+    color: $secondary-text-color;\n     font-size: 14px;\n     font-weight: 500;\n     margin-bottom: 10px;\n---\n\n\n---\n\nChoice B:\napp/models/account_pin.rb\n@@ -5,10 +5,10 @@\n # Table name: account_pins\n #\n #  id                :bigint(8)        not null, primary key\n-#  account_id        :bigint(8)\n-#  target_account_id :bigint(8)\n #  created_at        :datetime         not null\n #  updated_at        :datetime         not null\n+#  account_id        :bigint(8)        not null\n+#  target_account_id :bigint(8)        not null\n #\n \n class AccountPin < ApplicationRecord\n---\ndb/migrate/20241210140838_add_not_null_to_account_pin_account_columns.rb\n@@ -0,0 +1,23 @@\n+# frozen_string_literal: true\n+\n+class AddNotNullToAccountPinAccountColumns < ActiveRecord::Migration[7.2]\n+  def up\n+    connection.execute(<<~SQL.squish)\n+      DELETE FROM account_pins\n+      WHERE account_id IS NULL\n+      OR target_account_id IS NULL\n+    SQL\n+\n+    safety_assured do\n+      change_column_null :account_pins, :account_id, false\n+      change_column_null :account_pins, :target_account_id, false\n+    end\n+  end\n+\n+  def down\n+    safety_assured do\n+      change_column_null :account_pins, :account_id, true\n+      change_column_null :account_pins, :target_account_id, true\n+    end\n+  end\n+end\n---\ndb/schema.rb\n@@ -10,7 +10,7 @@\n #\n # It's strongly recommended that you check this file into your version control system.\n \n-ActiveRecord::Schema[7.2].define(version: 2024_12_05_163118) do\n+ActiveRecord::Schema[7.2].define(version: 2024_12_10_140838) do\n   # These are extensions that must be enabled in order to support this database\n   enable_extension \"plpgsql\"\n \n@@ -82,8 +82,8 @@\n   end\n \n   create_table \"account_pins\", force: :cascade do |t|\n-    t.bigint \"account_id\"\n-    t.bigint \"target_account_id\"\n+    t.bigint \"account_id\", null: false\n+    t.bigint \"target_account_id\", null: false\n     t.datetime \"created_at\", precision: nil, null: false\n     t.datetime \"updated_at\", precision: nil, null: false\n     t.index [\"account_id\", \"target_account_id\"], name: \"index_account_pins_on_account_id_and_target_account_id\", unique: true\n---\n\n\n---\n\nChoice C:\nlib/paperclip/transcoder.rb\n@@ -43,7 +43,8 @@ def make\n         unless eligible_to_passthrough?(metadata)\n           size_limit_in_bits = MediaAttachment::VIDEO_LIMIT * 8\n           desired_bitrate = (metadata.width * metadata.height * 30 * BITS_PER_PIXEL).floor\n-          maximum_bitrate = (size_limit_in_bits / metadata.duration).floor - 192_000 # Leave some space for the audio stream\n+          duration = [metadata.duration, 1].max\n+          maximum_bitrate = (size_limit_in_bits / duration).floor - 192_000 # Leave some space for the audio stream\n           bitrate = [desired_bitrate, maximum_bitrate].min\n \n           @output_options['b:v']     = bitrate\n---\n\n\n---\n\nChoice D:\ndb/post_migrate/20230811103651_remove_index_preview_cards_statuses_on_status_id_and_preview_card_id.rb\n@@ -0,0 +1,9 @@\n+# frozen_string_literal: true\n+\n+class RemoveIndexPreviewCardsStatusesOnStatusIdAndPreviewCardId < ActiveRecord::Migration[7.0]\n+  disable_ddl_transaction!\n+\n+  def change\n+    remove_index :preview_cards_statuses, column: [:status_id, :preview_card_id], name: :index_preview_cards_statuses_on_status_id_and_preview_card_id\n+  end\n+end\n---\ndb/schema.rb\n@@ -10,7 +10,7 @@\n #\n # It's strongly recommended that you check this file into your version control system.\n \n-ActiveRecord::Schema[7.0].define(version: 2023_08_03_112520) do\n+ActiveRecord::Schema[7.0].define(version: 2023_08_11_103651) do\n   # These are extensions that must be enabled in order to support this database\n   enable_extension \"plpgsql\"\n \n@@ -809,7 +809,6 @@\n   create_table \"preview_cards_statuses\", primary_key: [\"status_id\", \"preview_card_id\"], force: :cascade do |t|\n     t.bigint \"preview_card_id\", null: false\n     t.bigint \"status_id\", null: false\n-    t.index [\"status_id\", \"preview_card_id\"], name: \"index_preview_cards_statuses_on_status_id_and_preview_card_id\"\n   end\n \n   create_table \"relays\", force: :cascade do |t|\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Drag and drop a video in the new post area to upload it.\r\n2. Click on the edit pencil icon of the video to edit the Alt text.\r\n3. Enter Alt Text.\r\n4. Upload a custom thumbnail for the video and save the changes.\r\n5. If you now post your video post, the Alt text is missing.\r\n...\n\n### Expected behaviour\n\nThe Alt text should of course be kept alive and kicking ;-)\n\n### Actual behaviour\n\nThe Alt text is dropped.\n\n### Detailed description\n\nWhen using a custom thumbnail for videos, the Alt text vanishes when the toot is posted.\r\n\r\nThis only happens when adding a custom thumbnail.\r\nI can work around it if after posting I re-edit the post, enter the Alt text again and re-post.\r\nI have tested this on mastodon.art, zirk.us and Vivaldi.social.\r\nThe bug is around for as long as I can remember, several years I think.\n\n### Mastodon instance\n\nmastodon.art, zirk.us and Vivaldi.social\n\n### Mastodon version\n\nv4.2.12 and earlier\n\n### Browser name and version\n\nVivaldi for the last year or more, Firefox\n\n### Operating system\n\nWindows 10 and 11\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/components/alt_text_badge.tsx\n@@ -0,0 +1,67 @@\n+import { useState, useCallback, useRef } from 'react';\n+\n+import { FormattedMessage } from 'react-intl';\n+\n+import Overlay from 'react-overlays/Overlay';\n+import type {\n+  OffsetValue,\n+  UsePopperOptions,\n+} from 'react-overlays/esm/usePopper';\n+\n+const offset = [0, 4] as OffsetValue;\n+const popperConfig = { strategy: 'fixed' } as UsePopperOptions;\n+\n+export const AltTextBadge: React.FC<{\n+  description: string;\n+}> = ({ description }) => {\n+  const anchorRef = useRef<HTMLButtonElement>(null);\n+  const [open, setOpen] = useState(false);\n+\n+  const handleClick = useCallback(() => {\n+    setOpen((v) => !v);\n+  }, [setOpen]);\n+\n+  const handleClose = useCallback(() => {\n+    setOpen(false);\n+  }, [setOpen]);\n+\n+  return (\n+    <>\n+      <button\n+        ref={anchorRef}\n+        className='media-gallery__alt__label'\n+        onClick={handleClick}\n+      >\n+        ALT\n+      </button>\n+\n+      <Overlay\n+        rootClose\n+        onHide={handleClose}\n+        show={open}\n+        target={anchorRef.current}\n+        placement='top-end'\n+        flip\n+        offset={offset}\n+        popperConfig={popperConfig}\n+      >\n+        {({ props }) => (\n+          <div {...props} className='hover-card-controller'>\n+            <div\n+              className='media-gallery__alt__popover dropdown-animation'\n+              role='tooltip'\n+            >\n+              <h4>\n+                <FormattedMessage\n+                  id='alt_text_badge.title'\n+                  defaultMessage='Alt text'\n+                />\n+              </h4>\n+              <p>{description}</p>\n+            </div>\n+          </div>\n+        )}\n+      </Overlay>\n+    </>\n+  );\n+};\n---\napp/javascript/mastodon/components/media_gallery.jsx\n@@ -10,6 +10,7 @@ import ImmutablePropTypes from 'react-immutable-proptypes';\n \n import { debounce } from 'lodash';\n \n+import { AltTextBadge } from 'mastodon/components/alt_text_badge';\n import { Blurhash } from 'mastodon/components/blurhash';\n import { formatTime } from 'mastodon/features/video';\n \n@@ -97,7 +98,7 @@ class Item extends PureComponent {\n     }\n \n     if (attachment.get('description')?.length > 0) {\n-      badges.push(<span key='alt' className='media-gallery__alt__label'>ALT</span>);\n+      badges.push(<AltTextBadge key='alt' description={attachment.get('description')} />);\n     }\n \n     const description = attachment.getIn(['translation', 'description']) || attachment.get('description');\n@@ -156,9 +157,9 @@ class Item extends PureComponent {\n       const duration = attachment.getIn(['meta', 'original', 'duration']);\n \n       if (attachment.get('type') === 'gifv') {\n-        badges.push(<span key='gif' className='media-gallery__gifv__label'>GIF</span>);\n+        badges.push(<span key='gif' className='media-gallery__alt__label media-gallery__alt__label--non-interactive'>GIF</span>);\n       } else {\n-        badges.push(<span key='video' className='media-gallery__gifv__label'>{formatTime(Math.floor(duration))}</span>);\n+        badges.push(<span key='video' className='media-gallery__alt__label media-gallery__alt__label--non-interactive'>{formatTime(Math.floor(duration))}</span>);\n       }\n \n       thumbnail = (\n---\napp/javascript/mastodon/features/account_gallery/components/media_item.tsx\n@@ -5,6 +5,7 @@ import classNames from 'classnames';\n import HeadphonesIcon from '@/material-icons/400-24px/headphones-fill.svg?react';\n import MovieIcon from '@/material-icons/400-24px/movie-fill.svg?react';\n import VisibilityOffIcon from '@/material-icons/400-24px/visibility_off.svg?react';\n+import { AltTextBadge } from 'mastodon/components/alt_text_badge';\n import { Blurhash } from 'mastodon/components/blurhash';\n import { Icon } from 'mastodon/components/icon';\n import { formatTime } from 'mastodon/features/video';\n@@ -77,11 +78,7 @@ export const MediaItem: React.FC<{\n   const badges = [];\n \n   if (description && description.length > 0) {\n-    badges.push(\n-      <span key='alt' className='media-gallery__alt__label'>\n-        ALT\n-      </span>,\n-    );\n+    badges.push(<AltTextBadge key='alt' description={description} />);\n   }\n \n   if (!visible) {\n@@ -156,13 +153,19 @@ export const MediaItem: React.FC<{\n \n     if (type === 'gifv') {\n       badges.push(\n-        <span key='gif' className='media-gallery__gifv__label'>\n+        <span\n+          key='gif'\n+          className='media-gallery__alt__label media-gallery__alt__label--non-interactive'\n+        >\n           GIF\n         </span>,\n       );\n     } else {\n       badges.push(\n-        <span key='video' className='media-gallery__gifv__label'>\n+        <span\n+          key='video'\n+          className='media-gallery__alt__label media-gallery__alt__label--non-interactive'\n+        >\n           {formatTime(Math.floor(duration))}\n         </span>,\n       );\n---\napp/javascript/mastodon/locales/en.json\n@@ -85,6 +85,7 @@\n   \"alert.rate_limited.title\": \"Rate limited\",\n   \"alert.unexpected.message\": \"An unexpected error occurred.\",\n   \"alert.unexpected.title\": \"Oops!\",\n+  \"alt_text_badge.title\": \"Alt text\",\n   \"announcement.announcement\": \"Announcement\",\n   \"attachments_list.unprocessed\": \"(unprocessed)\",\n   \"audio.hide\": \"Hide audio\",\n---\napp/javascript/styles/mastodon/components.scss\n@@ -6971,23 +6971,56 @@ a.status-card {\n   inset-inline-end: 8px;\n   display: flex;\n   gap: 2px;\n+  pointer-events: none;\n }\n \n-.media-gallery__alt__label,\n-.media-gallery__gifv__label {\n-  display: flex;\n-  align-items: center;\n-  justify-content: center;\n+.media-gallery__alt__label {\n+  display: block;\n+  text-align: center;\n   color: $white;\n+  border: 0;\n   background: rgba($black, 0.65);\n   backdrop-filter: blur(10px) saturate(180%) contrast(75%) brightness(70%);\n   padding: 3px 8px;\n   border-radius: 4px;\n   font-size: 12px;\n   font-weight: 700;\n   z-index: 1;\n-  pointer-events: none;\n   line-height: 20px;\n+  cursor: pointer;\n+  pointer-events: auto;\n+\n+  &--non-interactive {\n+    pointer-events: none;\n+  }\n+}\n+\n+.media-gallery__alt__popover {\n+  background: rgba($black, 0.65);\n+  backdrop-filter: blur(10px) saturate(180%) contrast(75%) brightness(70%);\n+  border-radius: 4px;\n+  box-shadow: var(--dropdown-shadow);\n+  padding: 16px;\n+  min-width: 16em;\n+  min-height: 2em;\n+  max-width: 22em;\n+  max-height: 30em;\n+  overflow-y: auto;\n+\n+  h4 {\n+    font-size: 15px;\n+    line-height: 20px;\n+    font-weight: 500;\n+    color: $white;\n+    margin-bottom: 8px;\n+  }\n+\n+  p {\n+    font-size: 15px;\n+    line-height: 20px;\n+    color: rgba($white, 0.85);\n+    white-space: pre-line;\n+  }\n }\n \n .attachment-list {\n---\n\n\n---\n\nChoice B:\napp/views/application/mailer/_hashtag.html.haml\n@@ -17,4 +17,5 @@\n                           %span.email-mini-hashtag-img-span\n                             = image_tag full_asset_url(account.avatar.url), alt: '', width: 16, height: 16\n                       %td\n-                        %p= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(hashtag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts))\n+                        - people = hashtag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts\n+                        %p= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(people), count: people)\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/reducers/compose.js\n@@ -402,7 +402,7 @@ export default function compose(state = initialState, action) {\n       .set('isUploadingThumbnail', false)\n       .update('media_attachments', list => list.map(item => {\n         if (item.get('id') === action.media.id) {\n-          return fromJS(action.media);\n+          return fromJS(action.media).set('unattached', item.get('unattached'));\n         }\n \n         return item;\n---\n\n\n---\n\nChoice D:\napp/lib/link_details_extractor.rb\n@@ -156,7 +156,7 @@ def height\n   end\n \n   def title\n-    html_entities.decode(structured_data&.headline || opengraph_tag('og:title') || document.xpath('//title').map(&:content).first)\n+    html_entities.decode(structured_data&.headline || opengraph_tag('og:title') || document.xpath('//title').map(&:content).first).strip\n   end\n \n   def description\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. The message box is displayed incorrectly when the browser window width is small.\r\n2. Set the window size to a width of 1200 to 1167 pixels.\r\n![vivaldi_2024-09-01_17-48-27](https://github.com/user-attachments/assets/a5f98fab-ed7e-4a12-b6ec-35d381fd9e5c)\r\n\r\n\n\n### Expected behaviour\n\nThe message box is cropped to the left\n\n### Actual behaviour\n\nThe message window is displayed correctly\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nexample.com\n\n### Mastodon version\n\n4.3.0-beta.1\n\n### Browser name and version\n\nVivaldi 6.2.3105.58\n\n### Operating system\n\nWindows 10 22H2\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/controllers/api/v1/suggestions_controller.rb\n@@ -4,7 +4,7 @@ class Api::V1::SuggestionsController < Api::BaseController\n   include Authorization\n   include DeprecationConcern\n \n-  deprecate_api '2021-05-16'\n+  deprecate_api '2021-05-16', only: [:index]\n \n   before_action -> { doorkeeper_authorize! :read, :'read:accounts' }, only: :index\n   before_action -> { doorkeeper_authorize! :write, :'write:accounts' }, except: :index\n---\n\n\n---\n\nChoice B:\napp/services/statuses_search_service.rb\n@@ -39,12 +39,12 @@ def convert_deprecated_options!\n     end\n \n     if @options[:min_id]\n-      timestamp = Mastodon::Snowflake.to_time(@options[:min_id])\n+      timestamp = Mastodon::Snowflake.to_time(@options[:min_id].to_i)\n       syntax_options << \"after:\\\"#{timestamp.iso8601}\\\"\"\n     end\n \n     if @options[:max_id]\n-      timestamp = Mastodon::Snowflake.to_time(@options[:max_id])\n+      timestamp = Mastodon::Snowflake.to_time(@options[:max_id].to_i)\n       syntax_options << \"before:\\\"#{timestamp.iso8601}\\\"\"\n     end\n \n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -63,7 +63,7 @@ export default class ColumnsArea extends ImmutablePureComponent {\n     children: PropTypes.node,\n   };\n \n-  // Corresponds to (max-width: $no-gap-breakpoint + 285px - 1px) in SCSS\n+  // Corresponds to (max-width: $no-gap-breakpoint - 1px) in SCSS\n   mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1174px)');\n \n   state = {\n---\napp/javascript/styles/mastodon/components.scss\n@@ -2712,7 +2712,7 @@ a.account__display-name {\n       flex-direction: column;\n \n       @media screen and (min-width: $no-gap-breakpoint) {\n-        max-width: 600px;\n+        max-width: 568px;\n       }\n     }\n   }\n---\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -63,8 +63,8 @@ export default class ColumnsArea extends ImmutablePureComponent {\n     children: PropTypes.node,\n   };\n \n-  // Corresponds to (max-width: $no-gap-breakpoint + 285px - 1px) in SCSS\n-  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1174px)');\n+  // Corresponds to (max-width: $no-gap-breakpoint - 1px) in SCSS\n+  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1206px)');\n \n   state = {\n     renderComposePanel: !(this.mediaQuery && this.mediaQuery.matches),\n---\napp/javascript/styles/mastodon/variables.scss\n@@ -87,7 +87,7 @@ $media-modal-media-max-width: 100%;\n // put margins on top and bottom of image to avoid the screen covered by image.\n $media-modal-media-max-height: 80%;\n \n-$no-gap-breakpoint: 1175px;\n+$no-gap-breakpoint: 1207px;\n $mobile-breakpoint: 630px;\n \n $font-sans-serif: 'mastodon-font-sans-serif' !default;\n---\n\n\n---\n\nChoice D:\ndb/migrate/20180812173710_copy_status_stats.rb\n@@ -45,7 +45,7 @@ def up_slow\n     # We cannot use bulk INSERT or overarching transactions here because of possible\n     # uniqueness violations that we need to skip over\n     Status.unscoped.select('id, reblogs_count, favourites_count, created_at, updated_at').find_each do |status|\n-      params = [[nil, status.id], [nil, status.reblogs_count], [nil, status.favourites_count], [nil, status.created_at], [nil, status.updated_at]]\n+      params = [status.id, status.reblogs_count, status.favourites_count, status.created_at, status.updated_at]\n       exec_insert('INSERT INTO status_stats (status_id, reblogs_count, favourites_count, created_at, updated_at) VALUES ($1, $2, $3, $4, $5)', nil, params)\n     rescue ActiveRecord::RecordNotUnique\n       next\n---\ndb/migrate/20181116173541_copy_account_stats.rb\n@@ -45,7 +45,7 @@ def up_slow\n     # We cannot use bulk INSERT or overarching transactions here because of possible\n     # uniqueness violations that we need to skip over\n     Account.unscoped.select('id, statuses_count, following_count, followers_count, created_at, updated_at').find_each do |account|\n-      params = [[nil, account.id], [nil, account[:statuses_count]], [nil, account[:following_count]], [nil, account[:followers_count]], [nil, account.created_at], [nil, account.updated_at]]\n+      params = [account.id, account[:statuses_count], account[:following_count], account[:followers_count], account.created_at, account.updated_at]\n       exec_insert('INSERT INTO account_stats (account_id, statuses_count, following_count, followers_count, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6)', nil, params)\n     rescue ActiveRecord::RecordNotUnique\n       next\n---\nlib/mastodon/cli/statuses.rb\n@@ -61,7 +61,7 @@ def remove_statuses\n         # Skip accounts followed by local accounts\n         clean_followed_sql = 'AND NOT EXISTS (SELECT 1 FROM follows WHERE statuses.account_id = follows.target_account_id)' unless options[:clean_followed]\n \n-        ActiveRecord::Base.connection.exec_insert(<<-SQL.squish, 'SQL', [[nil, max_id]])\n+        ActiveRecord::Base.connection.exec_insert(<<-SQL.squish, 'SQL', [max_id])\n           INSERT INTO statuses_to_be_deleted (id)\n           SELECT statuses.id FROM statuses WHERE deleted_at IS NULL AND NOT local AND uri IS NOT NULL AND (id < $1)\n           AND NOT EXISTS (SELECT 1 FROM statuses AS statuses1 WHERE statuses.id = statuses1.in_reply_to_id)\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nMute a user and click \u201cShow Options\u201d. You now see multiple circles that only indicate they are selected by changing the color.\r\n\n\n### Expected behaviour\n\nFilled circles, point in circle. Something like a real radio button.\n\n### Actual behaviour\n\nEmpty circles, only other color.\n\n### Detailed description\n\nSee image.\r\n\r\n![image](https://github.com/user-attachments/assets/7bc3d1ca-89cb-4278-887b-c0cd8162608a)\r\n\r\nThe simulated radio buttons look differently from real radio buttons and make it hard for the user to see what they have selected.\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.3.0-nightly.2024-08-28\n\n### Browser name and version\n\nGoogle Chrome 128.0.6613.114\n\n### Operating system\n\nWindows 10\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -7580,7 +7580,7 @@ a.status-card {\n   }\n }\n \n-.radio-button.checked::before {\n+.radio-button__input.checked::before {\n   position: absolute;\n   left: 2px;\n   top: 2px;\n---\n\n\n---\n\nChoice B:\napp/controllers/api/v1/accounts/familiar_followers_controller.rb\n@@ -12,7 +12,7 @@ def index\n   private\n \n   def set_accounts\n-    @accounts = Account.without_suspended.where(id: account_ids).select('id, hide_collections').index_by(&:id).values_at(*account_ids).compact\n+    @accounts = Account.without_suspended.where(id: account_ids).select('id, hide_collections')\n   end\n \n   def familiar_followers\n---\napp/controllers/api/v1/accounts/relationships_controller.rb\n@@ -5,11 +5,8 @@ class Api::V1::Accounts::RelationshipsController < Api::BaseController\n   before_action :require_user!\n \n   def index\n-    scope = Account.where(id: account_ids).select('id')\n-    scope.merge!(Account.without_suspended) unless truthy_param?(:with_suspended)\n-    # .where doesn't guarantee that our results are in the same order\n-    # we requested them, so return the \"right\" order to the requestor.\n-    @accounts = scope.index_by(&:id).values_at(*account_ids).compact\n+    @accounts = Account.where(id: account_ids).select('id')\n+    @accounts.merge!(Account.without_suspended) unless truthy_param?(:with_suspended)\n     render json: @accounts, each_serializer: REST::RelationshipSerializer, relationships: relationships\n   end\n \n---\nspec/controllers/api/v1/accounts/familiar_followers_controller_spec.rb\n@@ -19,5 +19,17 @@\n \n       expect(response).to have_http_status(200)\n     end\n+\n+    context 'when there are duplicate account IDs in the params' do\n+      let(:account_a) { Fabricate(:account) }\n+      let(:account_b) { Fabricate(:account) }\n+\n+      it 'removes duplicate account IDs from params' do\n+        account_ids = [account_a, account_b, account_b, account_a, account_a].map { |a| a.id.to_s }\n+        get :index, params: { id: account_ids }\n+\n+        expect(body_as_json.pluck(:id)).to eq [account_a.id.to_s, account_b.id.to_s]\n+      end\n+    end\n   end\n end\n---\nspec/requests/api/v1/accounts/relationships_spec.rb\n@@ -79,6 +79,22 @@\n         end\n       end\n \n+      context 'when there are duplicate IDs in the params' do\n+        let(:params) { { id: [simon.id, lewis.id, lewis.id, lewis.id, simon.id] } }\n+\n+        it 'removes duplicate account IDs from params' do\n+          subject\n+\n+          expect(body_as_json)\n+            .to be_an(Enumerable)\n+            .and have_attributes(\n+              size: 2,\n+              first: include(simon_item),\n+              second: include(lewis_item)\n+            )\n+        end\n+      end\n+\n       def simon_item\n         {\n           id: simon.id.to_s,\n---\n\n\n---\n\nChoice C:\napp/views/application/mailer/_hashtag.html.haml\n@@ -17,4 +17,5 @@\n                           %span.email-mini-hashtag-img-span\n                             = image_tag full_asset_url(account.avatar.url), alt: '', width: 16, height: 16\n                       %td\n-                        %p= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(hashtag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts))\n+                        - people = hashtag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts\n+                        %p= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(people), count: people)\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -4389,7 +4389,7 @@ a.status-card.compact:hover {\n }\n \n .relationship-tag {\n-  color: $primary-text-color;\n+  color: $white;\n   margin-bottom: 4px;\n   display: block;\n   background-color: rgba($black, 0.45);\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\nmastodon:v4.3.0-beta.1\r\nThere is an issue with an additional symbol  \u2018\r\n![image](https://github.com/user-attachments/assets/2297308a-e3e5-4899-b3b8-3c905a234a28)\r\n\r\n\n\n---\n\nChoice A:\ndb/migrate/20180812173710_copy_status_stats.rb\n@@ -45,7 +45,7 @@ def up_slow\n     # We cannot use bulk INSERT or overarching transactions here because of possible\n     # uniqueness violations that we need to skip over\n     Status.unscoped.select('id, reblogs_count, favourites_count, created_at, updated_at').find_each do |status|\n-      params = [[nil, status.id], [nil, status.reblogs_count], [nil, status.favourites_count], [nil, status.created_at], [nil, status.updated_at]]\n+      params = [status.id, status.reblogs_count, status.favourites_count, status.created_at, status.updated_at]\n       exec_insert('INSERT INTO status_stats (status_id, reblogs_count, favourites_count, created_at, updated_at) VALUES ($1, $2, $3, $4, $5)', nil, params)\n     rescue ActiveRecord::RecordNotUnique\n       next\n---\ndb/migrate/20181116173541_copy_account_stats.rb\n@@ -45,7 +45,7 @@ def up_slow\n     # We cannot use bulk INSERT or overarching transactions here because of possible\n     # uniqueness violations that we need to skip over\n     Account.unscoped.select('id, statuses_count, following_count, followers_count, created_at, updated_at').find_each do |account|\n-      params = [[nil, account.id], [nil, account[:statuses_count]], [nil, account[:following_count]], [nil, account[:followers_count]], [nil, account.created_at], [nil, account.updated_at]]\n+      params = [account.id, account[:statuses_count], account[:following_count], account[:followers_count], account.created_at, account.updated_at]\n       exec_insert('INSERT INTO account_stats (account_id, statuses_count, following_count, followers_count, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6)', nil, params)\n     rescue ActiveRecord::RecordNotUnique\n       next\n---\nlib/mastodon/cli/statuses.rb\n@@ -61,7 +61,7 @@ def remove_statuses\n         # Skip accounts followed by local accounts\n         clean_followed_sql = 'AND NOT EXISTS (SELECT 1 FROM follows WHERE statuses.account_id = follows.target_account_id)' unless options[:clean_followed]\n \n-        ActiveRecord::Base.connection.exec_insert(<<-SQL.squish, 'SQL', [[nil, max_id]])\n+        ActiveRecord::Base.connection.exec_insert(<<-SQL.squish, 'SQL', [max_id])\n           INSERT INTO statuses_to_be_deleted (id)\n           SELECT statuses.id FROM statuses WHERE deleted_at IS NULL AND NOT local AND uri IS NOT NULL AND (id < $1)\n           AND NOT EXISTS (SELECT 1 FROM statuses AS statuses1 WHERE statuses.id = statuses1.in_reply_to_id)\n---\n\n\n---\n\nChoice B:\ndocker-compose.yml\n@@ -88,7 +88,7 @@ services:\n       - internal_network\n     healthcheck:\n       # prettier-ignore\n-      test: ['CMD-SHELL', \"curl -s --noproxy localhost localhost:4000/api/v1/streaming/health | grep -q 'OK' || exit 1'\"]\n+      test: ['CMD-SHELL', \"curl -s --noproxy localhost localhost:4000/api/v1/streaming/health | grep -q 'OK' || exit 1\"]\n     ports:\n       - '127.0.0.1:4000:4000'\n     depends_on:\n---\n\n\n---\n\nChoice C:\ndocker-compose.yml\n@@ -2,7 +2,7 @@ version: '3'\n services:\n   db:\n     restart: always\n-    image: postgres:14-alpine\n+    image: postgres:15-alpine\n     shm_size: 256mb\n     networks:\n       - internal_network\n@@ -25,7 +25,7 @@ services:\n \n   # es:\n   #   restart: always\n-  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.4\n+  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9\n   #   environment:\n   #     - \"ES_JAVA_OPTS=-Xms512m -Xmx512m -Des.enforce.bootstrap.checks=true\"\n   #     - \"xpack.license.self_generated.type=basic\"\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -80,6 +80,7 @@ html {\n }\n \n .search__input,\n+.search__popout,\n .setting-text,\n .report-dialog-modal__textarea,\n .audio-player {\n@@ -439,7 +440,8 @@ html {\n .directory__tag > div,\n .card > a,\n .page-header,\n-.compose-form .compose-form__warning {\n+.compose-form,\n+.compose-form__warning {\n   box-shadow: none;\n }\n \n@@ -475,12 +477,17 @@ html {\n   color: $white;\n }\n \n-.compose-form .spoiler-input__input {\n+.compose-form,\n+.spoiler-input__input,\n+.search__input,\n+.search__popout {\n   color: lighten($ui-highlight-color, 8%);\n }\n \n .compose-form .autosuggest-textarea__textarea,\n .compose-form__highlightable,\n+.search__input,\n+.search__popout,\n .poll__option input[type='text'] {\n   background: darken($ui-base-color, 10%);\n }\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Hover over the links along the right side for \u201cExplore\u201d, \u201cLive feeds\u201d, etc. Or hover over the links in the \u201cGetting started\u201d pane in the advanced web interface\r\n\n\n### Expected behaviour\n\nThe cursor changes to the usual \u201cpointer\u201d, otherwise nothing should happen\n\n### Actual behaviour\n\nA tooltip appears with text to tell you what the text says\n\n### Detailed description\n\nI don\u2019t need it explained to me that \u201cExplore\u201d says \u201cExplore\u201d, \u201cLive feeds\u201d says \u201cLive feeds\u201d, and so on.\r\n\r\n\r\nhttps://github.com/user-attachments/assets/da28ec31-5c54-4dd3-8e32-fba9724401f7\r\n\r\n\n\n### Mastodon instance\n\nmastodon.social and mastodon.online\n\n### Mastodon version\n\nv4.3.0-nightly.2024-08-23\n\n### Browser name and version\n\nSafari 17.6\n\n### Operating system\n\nmacOS 14.6.1\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/reset.scss\n@@ -56,7 +56,6 @@ table {\n @supports not selector(::-webkit-scrollbar) {\n   html {\n     scrollbar-color: $action-button-color var(--background-border-color);\n-    scrollbar-width: thin;\n   }\n }\n \n---\napp/javascript/styles/mastodon-light/diff.scss\n@@ -524,14 +524,3 @@ a.sparkline {\n     color: $dark-text-color;\n   }\n }\n-\n-@supports not selector(::-webkit-scrollbar) {\n-  html {\n-    scrollbar-color: rgba($action-button-color, 0.25)\n-      var(--background-border-color);\n-  }\n-}\n-\n-::-webkit-scrollbar-thumb {\n-  opacity: 0.25;\n-}\n---\napp/javascript/styles/mastodon/reset.scss\n@@ -52,32 +52,3 @@ table {\n   border-collapse: collapse;\n   border-spacing: 0;\n }\n-\n-@supports not selector(::-webkit-scrollbar) {\n-  html {\n-    scrollbar-color: $action-button-color var(--background-border-color);\n-    scrollbar-width: thin;\n-  }\n-}\n-\n-::-webkit-scrollbar {\n-  width: 8px;\n-  height: 8px;\n-}\n-\n-::-webkit-scrollbar-thumb {\n-  background-color: $action-button-color;\n-  border: 2px var(--background-border-color);\n-  border-radius: 12px;\n-  width: 6px;\n-  box-shadow: inset 0 0 0 2px var(--background-border-color);\n-}\n-\n-::-webkit-scrollbar-track {\n-  background-color: var(--background-border-color);\n-  border-radius: 0px;\n-}\n-\n-::-webkit-scrollbar-corner {\n-  background: transparent;\n-}\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/components/dismissable_banner.tsx\n@@ -1,11 +1,18 @@\n+/* eslint-disable @typescript-eslint/no-unsafe-call,\n+                  @typescript-eslint/no-unsafe-return,\n+                  @typescript-eslint/no-unsafe-assignment,\n+                  @typescript-eslint/no-unsafe-member-access\n+                  -- the settings store is not yet typed */\n import type { PropsWithChildren } from 'react';\n-import { useCallback, useState } from 'react';\n+import { useCallback, useState, useEffect } from 'react';\n \n import { defineMessages, useIntl } from 'react-intl';\n \n import { ReactComponent as CloseIcon } from '@material-symbols/svg-600/outlined/close.svg';\n \n+import { changeSetting } from 'mastodon/actions/settings';\n import { bannerSettings } from 'mastodon/settings';\n+import { useAppSelector, useAppDispatch } from 'mastodon/store';\n \n import { IconButton } from './icon_button';\n \n@@ -21,13 +28,25 @@ export const DismissableBanner: React.FC<PropsWithChildren<Props>> = ({\n   id,\n   children,\n }) => {\n-  const [visible, setVisible] = useState(!bannerSettings.get(id));\n+  const dismissed = useAppSelector((state) =>\n+    state.settings.getIn(['dismissed_banners', id], false),\n+  );\n+  const dispatch = useAppDispatch();\n+\n+  const [visible, setVisible] = useState(!bannerSettings.get(id) && !dismissed);\n   const intl = useIntl();\n \n   const handleDismiss = useCallback(() => {\n     setVisible(false);\n     bannerSettings.set(id, true);\n-  }, [id]);\n+    dispatch(changeSetting(['dismissed_banners', id], true));\n+  }, [id, dispatch]);\n+\n+  useEffect(() => {\n+    if (!visible && !dismissed) {\n+      dispatch(changeSetting(['dismissed_banners', id], true));\n+    }\n+  }, [id, dispatch, visible, dismissed]);\n \n   if (!visible) {\n     return null;\n---\napp/javascript/mastodon/reducers/settings.js\n@@ -100,6 +100,15 @@ const initialState = ImmutableMap({\n       body: '',\n     }),\n   }),\n+\n+  dismissed_banners: ImmutableMap({\n+    'public_timeline': false,\n+    'community_timeline': false,\n+    'home.explore_prompt': false,\n+    'explore/links': false,\n+    'explore/statuses': false,\n+    'explore/tags': false,\n+  }),\n });\n \n const defaultColumns = fromJS([\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/ui/components/column_link.jsx\n@@ -15,15 +15,15 @@ const ColumnLink = ({ icon, activeIcon, iconComponent, activeIconComponent, text\n \n   if (href) {\n     return (\n-      <a href={href} className={className} data-method={method} title={text} {...other}>\n+      <a href={href} className={className} data-method={method} {...other}>\n         {active ? activeIconElement : iconElement}\n         <span>{text}</span>\n         {badgeElement}\n       </a>\n     );\n   } else {\n     return (\n-      <NavLink to={to} className={className} title={text} exact {...other}>\n+      <NavLink to={to} className={className} exact {...other}>\n         {active ? activeIconElement : iconElement}\n         <span>{text}</span>\n         {badgeElement}\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/components/column.jsx\n@@ -16,7 +16,19 @@ export default class Column extends PureComponent {\n   };\n \n   scrollTop () {\n-    const scrollable = this.props.bindToDocument ? document.scrollingElement : this.node.querySelector('.scrollable');\n+    let scrollable = null;\n+\n+    if (this.props.bindToDocument) {\n+      scrollable = document.scrollingElement;\n+    } else {\n+      scrollable = this.node.querySelector('.scrollable');\n+\n+      // Some columns have nested `.scrollable` containers, with the outer one\n+      // being a wrapper while the actual scrollable content is deeper.\n+      if (scrollable.classList.contains('scrollable--flex')) {\n+        scrollable = scrollable?.querySelector('.scrollable') || scrollable;\n+      }\n+   }\n \n     if (!scrollable) {\n       return;\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Open Moderation > Federation page\r\n2. The CSS style of the list seems broken\r\n\r\n### Expected behaviour\r\n\r\nDomain list presented as cards\r\n\r\n### Actual behaviour\r\n\r\nDomain list presented as underlined links and misaligned\r\n\r\n### Detailed description\r\n\r\nThis is how the domains (blocked/limited or not) are presented now:\r\n\r\n![image](https://github.com/user-attachments/assets/90a29e40-526a-42dc-bec2-099fae33d822)\r\n\r\n### Mastodon instance\r\n\r\nbolha.one, ursal.zone\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-alpha.5-2da687a\r\n\r\n### Browser name and version\r\n\r\nLibreWolf 129, Chromium v127.0.6533.120\r\n\r\n### Operating system\r\n\r\nDebian 12\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/widgets.scss\n@@ -1,3 +1,85 @@\n+.directory {\n+  &__tag {\n+    box-sizing: border-box;\n+    margin-bottom: 10px;\n+\n+    & > a,\n+    & > div {\n+      display: flex;\n+      align-items: center;\n+      justify-content: space-between;\n+      border: 1px solid var(--background-border-color);\n+      border-radius: 4px;\n+      padding: 15px;\n+      text-decoration: none;\n+      color: inherit;\n+      box-shadow: 0 0 15px rgba($base-shadow-color, 0.2);\n+    }\n+\n+    & > a {\n+      &:hover,\n+      &:active,\n+      &:focus {\n+        background: $ui-base-color;\n+      }\n+    }\n+\n+    &.active > a {\n+      background: $ui-highlight-color;\n+      cursor: default;\n+    }\n+\n+    &.disabled > div {\n+      opacity: 0.5;\n+      cursor: default;\n+    }\n+\n+    h4 {\n+      flex: 1 1 auto;\n+      font-size: 18px;\n+      font-weight: 700;\n+      color: $primary-text-color;\n+      white-space: nowrap;\n+      overflow: hidden;\n+      text-overflow: ellipsis;\n+\n+      .fa {\n+        color: $darker-text-color;\n+      }\n+\n+      small {\n+        display: block;\n+        font-weight: 400;\n+        font-size: 15px;\n+        margin-top: 8px;\n+        color: $darker-text-color;\n+      }\n+    }\n+\n+    &.active h4 {\n+      &,\n+      .fa,\n+      small,\n+      .trends__item__current {\n+        color: $primary-text-color;\n+      }\n+    }\n+\n+    .avatar-stack {\n+      flex: 0 0 auto;\n+      width: (36px + 4px) * 3;\n+    }\n+\n+    &.active .avatar-stack .account__avatar {\n+      border-color: $ui-highlight-color;\n+    }\n+\n+    .trends__item__current {\n+      padding-inline-end: 0;\n+    }\n+  }\n+}\n+\n .accounts-table {\n   width: 100%;\n \n---\n\n\n---\n\nChoice B:\napp/models/tag.rb\n@@ -37,7 +37,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?<![=/)\\w])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}i\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]\\u0E47-\\u0E4E#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/tag_spec.rb\n@@ -36,6 +36,10 @@\n       expect(subject.match('https://gcc.gnu.org/bugzilla/show_bug.cgi?id=111895#c4')).to be_nil\n     end\n \n+    it 'does not match URLs with hashtag-like anchors after a non-ascii character' do\n+      expect(subject.match('https://example.org/test\u00e9#foo')).to be_nil\n+    end\n+\n     it 'does not match URLs with hashtag-like anchors after an empty query parameter' do\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)?foo=#Lawsuit')).to be_nil\n     end\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/actions/settings.js\n@@ -20,7 +20,7 @@ export function changeSetting(path, value) {\n }\n \n const debouncedSave = debounce((dispatch, getState) => {\n-  if (getState().getIn(['settings', 'saved'])) {\n+  if (getState().getIn(['settings', 'saved']) || !getState().getIn(['meta', 'me'])) {\n     return;\n   }\n \n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/about/index.jsx\n@@ -6,6 +6,7 @@ import { defineMessages, injectIntl, FormattedMessage } from 'react-intl';\n import classNames from 'classnames';\n import { Helmet } from 'react-helmet';\n \n+import { List as ImmutableList } from 'immutable';\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import { connect } from 'react-redux';\n \n@@ -161,7 +162,7 @@ class About extends PureComponent {\n           </Section>\n \n           <Section title={intl.formatMessage(messages.rules)}>\n-            {!isLoading && (server.get('rules', []).isEmpty() ? (\n+            {!isLoading && (server.get('rules', ImmutableList()).isEmpty() ? (\n               <p><FormattedMessage id='about.not_available' defaultMessage='This information has not been made available on this server.' /></p>\n             ) : (\n               <ol className='rules-list'>\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\nToday I got a filtered notification from a \"limited\" user. I don't have any notification filters on except for the \"limited by server\" filter.\r\n\r\nI went to look at the notification, and I saw that instead of [Trash] [Check] it's now [Trash] [\u22ef] and \u22ef is a menu. Oh! I like that! I like that a lot! I clicked the menu and clicked \"Accept\". The notification dismissed.\r\n\r\nAnd in its place I got this:\r\n\r\n![image](https://github.com/user-attachments/assets/29ed8105-a10a-4836-9835-dd7b89d12c17)\r\n\r\nWhat?\r\n\r\nExperimentally I clicked \"Edit\".\r\n\r\n![image](https://github.com/user-attachments/assets/e9f72b9a-c0c5-4efd-937f-856467f97a06)\r\n\r\nIt changed to \"Done\"?\r\n\r\nWhat?\r\n\r\nI clicked \"Done\" and it changed back to \"Edit\".\r\n\r\nThe box on the left checks and unchecks, but I don't know what it does.\r\n\r\n### Expected behaviour\r\n\r\nNothing\r\n\r\n### Actual behaviour\r\n\r\nThis\r\n\r\n### Detailed description\r\n\r\n_No response_\r\n\r\n### Mastodon instance\r\n\r\nmastodon.social\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-nightly.2024-08-21\r\n\r\n### Browser name and version\r\n\r\nchrome\r\n\r\n### Operating system\r\n\r\nwindows 10\r\n\r\n### Technical details\r\n\r\nI have \"Stylus\" hiding a couple of CSS elements but they aren't related to this pane, and turning off Stylus does not change this element.\n\n---\n\nChoice A:\napp/controllers/api/v1/suggestions_controller.rb\n@@ -4,7 +4,7 @@ class Api::V1::SuggestionsController < Api::BaseController\n   include Authorization\n   include DeprecationConcern\n \n-  deprecate_api '2021-05-16'\n+  deprecate_api '2021-05-16', only: [:index]\n \n   before_action -> { doorkeeper_authorize! :read, :'read:accounts' }, only: :index\n   before_action -> { doorkeeper_authorize! :write, :'write:accounts' }, except: :index\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/notifications/requests.jsx\n@@ -217,7 +217,9 @@ export const NotificationRequests = ({ multiColumn }) => {\n         multiColumn={multiColumn}\n         showBackButton\n         appendContent={\n-          <SelectRow selectionMode={selectionMode} setSelectionMode={setSelectionMode} selectAllChecked={selectAllChecked} toggleSelectAll={toggleSelectAll} selectedItems={checkedRequestIds} />}\n+          notificationRequests.size > 0 && (\n+            <SelectRow selectionMode={selectionMode} setSelectionMode={setSelectionMode} selectAllChecked={selectAllChecked} toggleSelectAll={toggleSelectAll} selectedItems={checkedRequestIds} />\n+          )}\n       >\n         <ColumnSettings />\n       </ColumnHeader>\n---\n\n\n---\n\nChoice C:\napp/models/trends/tag_filter.rb\n@@ -14,7 +14,7 @@ def initialize(params)\n \n   def results\n     scope = if params[:status] == 'pending_review'\n-              Tag.unscoped\n+              Tag.unscoped.order(id: :desc)\n             else\n               trending_scope\n             end\n---\n\n\n---\n\nChoice D:\napp/controllers/concerns/web_app_controller_concern.rb\n@@ -11,7 +11,7 @@ module WebAppControllerConcern\n   end\n \n   def skip_csrf_meta_tags?\n-    !(ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1) && current_user.nil?\n+    !(ENV['ONE_CLICK_SSO_LOGIN'] == 'true' && ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1) && current_user.nil?\n   end\n \n   def set_app_body_class\n---\napp/serializers/initial_state_serializer.rb\n@@ -113,6 +113,6 @@ def instance_presenter\n   end\n \n   def sso_redirect\n-    \"/auth/auth/#{Devise.omniauth_providers[0]}\" if ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1\n+    \"/auth/auth/#{Devise.omniauth_providers[0]}\" if ENV['ONE_CLICK_SSO_LOGIN'] == 'true' && ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1\n   end\n end\n---\nconfig/initializers/content_security_policy.rb\n@@ -19,6 +19,22 @@ def host_to_url(str)\n media_host ||= host_to_url(ENV['S3_HOSTNAME']) if ENV['S3_ENABLED'] == 'true'\n media_host ||= assets_host\n \n+def sso_host\n+  return unless ENV['ONE_CLICK_SSO_LOGIN'] == 'true'\n+  return unless ENV['OMNIAUTH_ONLY'] == 'true'\n+  return unless Devise.omniauth_providers.length == 1\n+\n+  provider = Devise.omniauth_configs[Devise.omniauth_providers[0]]\n+  @sso_host ||= begin\n+    # using CAS\n+    provider.cas_url if ENV['CAS_ENABLED'] == 'true'\n+    # using SAML\n+    provider.options[:idp_sso_target_url] if ENV['SAML_ENABLED'] == 'true'\n+    # or using OIDC\n+    ENV['OIDC_AUTH_ENDPOINT'] || (OpenIDConnect::Discovery::Provider::Config.discover!(ENV['OIDC_ISSUER']).authorization_endpoint if ENV['OIDC_ENABLED'] == 'true')\n+  end\n+end\n+\n Rails.application.config.content_security_policy do |p|\n   p.base_uri        :none\n   p.default_src     :none\n@@ -29,7 +45,13 @@ def host_to_url(str)\n   p.media_src       :self, :https, :data, assets_host\n   p.frame_src       :self, :https\n   p.manifest_src    :self, assets_host\n-  p.form_action     :self\n+\n+  if sso_host.present?\n+    p.form_action     :self, sso_host\n+  else\n+    p.form_action     :self\n+  end\n+\n   p.child_src       :self, :blob, assets_host\n   p.worker_src      :self, :blob, assets_host\n \n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n- Get followed\r\n- Enter \"all\" tab\r\n\r\n![image](https://github.com/user-attachments/assets/d99d0611-38a2-47e9-89e8-e0cab83127a0)\r\n\r\nEvery notification type has a line above it and below it\u2026 *except* a follow notification.\r\n\r\n### Expected behaviour\r\n\r\nLine should appear between follow notification and mention\r\n\r\n### Actual behaviour\r\n\r\nLine visible above follow notification but not below\r\n\r\n### Detailed description\r\n\r\nIt just looks weird is all. I don't think I've noticed this before so maybe it's new.\r\n\r\nI was messing with my notification filters right before I saw this for the first time, so if this isn't usual, maybe something I did triggered it.\r\n\r\nIf you are intentionally doing a thing where you draw no lines between follow notifications when two follow notifications are in a row, that sounds fine to me, but there should be lines between follow notifications and other notification types or it looks inconsistent.\r\n\r\nSaw on v4.3.0-nightly.2024-08-12, mastodon.social, BOTH advanced and non-advanced mode, BOTH Chrome and Firefox, uBlock Origin is ON, Stylus is OFF.\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -1411,10 +1411,15 @@ body > [data-popper-placement] {\n     .audio-player,\n     .attachment-list,\n     .picture-in-picture-placeholder,\n+    .more-from-author,\n     .status-card,\n     .hashtag-bar {\n       margin-inline-start: $thread-margin;\n-      width: calc(100% - ($thread-margin));\n+      width: calc(100% - $thread-margin);\n+    }\n+\n+    .more-from-author {\n+      width: calc(100% - $thread-margin + 2px);\n     }\n \n     .status__content__read-more-button {\n@@ -4129,6 +4134,13 @@ a.status-card {\n   border-end-start-radius: 0;\n }\n \n+.status-card.bottomless .status-card__image,\n+.status-card.bottomless .status-card__image-image,\n+.status-card.bottomless .status-card__image-preview {\n+  border-end-end-radius: 0;\n+  border-end-start-radius: 0;\n+}\n+\n .status-card.expanded > a {\n   width: 100%;\n }\n@@ -10229,6 +10241,7 @@ noscript {\n }\n \n .more-from-author {\n+  box-sizing: border-box;\n   font-size: 14px;\n   color: $darker-text-color;\n   background: var(--surface-background-color);\n---\n\n\n---\n\nChoice B:\ndocker-compose.yml\n@@ -2,7 +2,7 @@ version: '3'\n services:\n   db:\n     restart: always\n-    image: postgres:14-alpine\n+    image: postgres:15-alpine\n     shm_size: 256mb\n     networks:\n       - internal_network\n@@ -25,7 +25,7 @@ services:\n \n   # es:\n   #   restart: always\n-  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.4\n+  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9\n   #   environment:\n   #     - \"ES_JAVA_OPTS=-Xms512m -Xmx512m -Des.enforce.bootstrap.checks=true\"\n   #     - \"xpack.license.self_generated.type=basic\"\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\n\n\n---\n\nChoice C:\nconfig/initializers/paperclip.rb\n@@ -64,7 +64,7 @@\n       http_open_timeout: ENV.fetch('S3_OPEN_TIMEOUT') { '5' }.to_i,\n       http_read_timeout: ENV.fetch('S3_READ_TIMEOUT') { '5' }.to_i,\n       http_idle_timeout: 5,\n-      retry_limit: 0,\n+      retry_limit: ENV.fetch('S3_RETRY_LIMIT') { '0' }.to_i,\n     }\n   )\n \n---\nconfig/initializers/paperclip.rb\n@@ -64,7 +64,7 @@\n       http_open_timeout: ENV.fetch('S3_OPEN_TIMEOUT'){ '5' }.to_i,\n       http_read_timeout: ENV.fetch('S3_READ_TIMEOUT'){ '5' }.to_i,\n       http_idle_timeout: 5,\n-      retry_limit: 0,\n+      retry_limit: ENV.fetch('S3_RETRY_LIMIT'){ '0' }.to_i,\n     }\n   )\n   \n---\napp/lib/attachment_batch.rb\n@@ -4,7 +4,8 @@ class AttachmentBatch\n   # Maximum amount of objects you can delete in an S3 API call. It's\n   # important to remember that this does not correspond to the number\n   # of records in the batch, since records can have multiple attachments\n-  LIMIT = 1_000\n+  LIMIT = ENV.fetch('S3_BATCH_DELETE_LIMIT', 1000).to_i\n+  MAX_RETRY = ENV.fetch('S3_BATCH_DELETE_RETRY', 3).to_i\n \n   # Attributes generated and maintained by Paperclip (not all of them\n   # are always used on every class, however)\n@@ -95,13 +96,25 @@ def remove_files\n     # objects can be processed at once, so we have to potentially\n     # separate them into multiple calls.\n \n+    retries = 0\n     keys.each_slice(LIMIT) do |keys_slice|\n       logger.debug { \"Deleting #{keys_slice.size} objects\" }\n \n       bucket.delete_objects(delete: {\n         objects: keys_slice.map { |key| { key: key } },\n         quiet: true,\n       })\n+    rescue => e\n+      retries += 1\n+\n+      if retries < MAX_RETRY\n+        logger.debug \"Retry #{retries}/#{MAX_RETRY} after #{e.message}\"\n+        sleep 2**retries\n+        retry\n+      else\n+        logger.error \"Batch deletion from S3 failed after #{e.message}\"\n+        raise e\n+      end\n     end\n   end\n \n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -2249,6 +2249,10 @@ a.account__display-name {\n   }\n }\n \n+.notification-follow {\n+  border-bottom: 1px solid var(--background-border-color);\n+}\n+\n .notification-group--link {\n   color: $secondary-text-color;\n   text-decoration: none;\n---\napp/javascript/styles/mastodon/admin.scss\n@@ -872,6 +872,7 @@ a.name-tag,\n \n     .account {\n       padding: 0;\n+      border: none;\n \n       &__avatar-wrapper {\n         margin-inline-start: 0;\n---\napp/javascript/styles/mastodon/components.scss\n@@ -1808,6 +1808,7 @@ body > [data-popper-placement] {\n \n .account {\n   padding: 16px;\n+  border-bottom: 1px solid var(--background-border-color);\n \n   .account__display-name {\n     flex: 1 1 auto;\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nFixes #31392\r\n\r\nNote that this is a quick and pretty dirty fix. The underlying issue is that notifications can sometimes be orphaned, that is, their underlying activity has been deleted, which results in them having a `null` activity or activity ID.\r\n\r\nA correct client-side fix would be to update the API and model types accordingly. A correct server-side fix would be to ensure that can never happen in the first place.\n\n---\n\nChoice A:\napp/javascript/mastodon/actions/notification_groups.ts\n@@ -47,7 +47,7 @@ function dispatchAssociatedRecords(\n       fetchedAccounts.push(notification.moderation_warning.target_account);\n     }\n \n-    if ('status' in notification) {\n+    if ('status' in notification && notification.status) {\n       fetchedStatuses.push(notification.status);\n     }\n   });\n@@ -119,7 +119,7 @@ export const processNewNotificationForGroups = createAppAsyncThunk(\n \n     if (\n       (notification.type === 'mention' || notification.type === 'update') &&\n-      notification.status.filtered\n+      notification.status?.filtered\n     ) {\n       const filters = notification.status.filtered.filter((result) =>\n         result.filter.context.includes('notifications'),\n---\napp/javascript/mastodon/api_types/notifications.ts\n@@ -60,12 +60,12 @@ export interface BaseNotificationGroupJSON {\n \n interface NotificationGroupWithStatusJSON extends BaseNotificationGroupJSON {\n   type: NotificationWithStatusType;\n-  status_id: string;\n+  status_id: string | null;\n }\n \n interface NotificationWithStatusJSON extends BaseNotificationJSON {\n   type: NotificationWithStatusType;\n-  status: ApiStatusJSON;\n+  status: ApiStatusJSON | null;\n }\n \n interface ReportNotificationGroupJSON extends BaseNotificationGroupJSON {\n---\napp/javascript/mastodon/features/notifications_v2/components/notification_mention.tsx\n@@ -37,7 +37,11 @@ export const NotificationMention: React.FC<{\n   unread: boolean;\n }> = ({ notification, unread }) => {\n   const [isDirect, isReply] = useAppSelector((state) => {\n-    const status = state.statuses.get(notification.statusId) as Status;\n+    const status = state.statuses.get(notification.statusId) as\n+      | Status\n+      | undefined;\n+\n+    if (!status) return [false, false] as const;\n \n     return [\n       status.get('visibility') === 'direct',\n---\napp/javascript/mastodon/features/notifications_v2/components/notification_with_status.tsx\n@@ -23,7 +23,7 @@ export const NotificationWithStatus: React.FC<{\n   icon: IconProp;\n   iconId: string;\n   accountIds: string[];\n-  statusId: string;\n+  statusId: string | undefined;\n   count: number;\n   labelRenderer: LabelRenderer;\n   unread: boolean;\n@@ -76,6 +76,8 @@ export const NotificationWithStatus: React.FC<{\n     [dispatch, statusId],\n   );\n \n+  if (!statusId) return null;\n+\n   return (\n     <HotKeys handlers={handlers}>\n       <div\n---\napp/javascript/mastodon/models/notification_group.ts\n@@ -21,7 +21,7 @@ interface BaseNotificationGroup\n interface BaseNotificationWithStatus<Type extends NotificationWithStatusType>\n   extends BaseNotificationGroup {\n   type: Type;\n-  statusId: string;\n+  statusId: string | undefined;\n }\n \n interface BaseNotification<Type extends NotificationType>\n@@ -126,7 +126,7 @@ export function createNotificationGroupFromJSON(\n     case 'update': {\n       const { status_id: statusId, ...groupWithoutStatus } = group;\n       return {\n-        statusId,\n+        statusId: statusId ?? undefined,\n         sampleAccountIds,\n         ...groupWithoutStatus,\n       };\n@@ -183,7 +183,7 @@ export function createNotificationGroupFromNotificationJSON(\n     case 'mention':\n     case 'poll':\n     case 'update':\n-      return { ...group, statusId: notification.status.id };\n+      return { ...group, statusId: notification.status?.id };\n     case 'admin.report':\n       return { ...group, report: createReportFromJSON(notification.report) };\n     case 'severed_relationships':\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -63,8 +63,8 @@ export default class ColumnsArea extends ImmutablePureComponent {\n     children: PropTypes.node,\n   };\n \n-  // Corresponds to (max-width: $no-gap-breakpoint + 285px - 1px) in SCSS\n-  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1174px)');\n+  // Corresponds to (max-width: $no-gap-breakpoint - 1px) in SCSS\n+  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1206px)');\n \n   state = {\n     renderComposePanel: !(this.mediaQuery && this.mediaQuery.matches),\n---\napp/javascript/styles/mastodon/variables.scss\n@@ -87,7 +87,7 @@ $media-modal-media-max-width: 100%;\n // put margins on top and bottom of image to avoid the screen covered by image.\n $media-modal-media-max-height: 80%;\n \n-$no-gap-breakpoint: 1175px;\n+$no-gap-breakpoint: 1207px;\n $mobile-breakpoint: 630px;\n \n $font-sans-serif: 'mastodon-font-sans-serif' !default;\n---\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -62,7 +62,7 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   };\n \n   // Corresponds to (max-width: $no-gap-breakpoint - 1px) in SCSS\n-  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1206px)');\n+  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1174px)');\n \n   state = {\n     renderComposePanel: !(this.mediaQuery && this.mediaQuery.matches),\n---\napp/javascript/styles/mastodon/components.scss\n@@ -2708,7 +2708,7 @@ a.account__display-name {\n     &__main {\n       box-sizing: border-box;\n       width: 100%;\n-      flex: 0 0 auto;\n+      flex: 0 1 auto;\n       display: flex;\n       flex-direction: column;\n \n---\napp/javascript/styles/mastodon/variables.scss\n@@ -87,7 +87,7 @@ $media-modal-media-max-width: 100%;\n // put margins on top and bottom of image to avoid the screen covered by image.\n $media-modal-media-max-height: 80%;\n \n-$no-gap-breakpoint: 1207px;\n+$no-gap-breakpoint: 1175px;\n $mobile-breakpoint: 630px;\n \n $font-sans-serif: 'mastodon-font-sans-serif' !default;\n---\n\n\n---\n\nChoice C:\napp/lib/admin/system_check/elasticsearch_check.rb\n@@ -41,7 +41,7 @@ def message\n       Admin::SystemCheck::Message.new(:elasticsearch_health_red)\n     elsif cluster_health['number_of_nodes'] < 2 && es_preset != 'single_node_cluster'\n       Admin::SystemCheck::Message.new(:elasticsearch_preset_single_node, nil, 'https://docs.joinmastodon.org/admin/optional/elasticsearch/#scaling')\n-    elsif Chewy.client.indices.get_settings['chewy_specifications'].dig('settings', 'index', 'number_of_replicas')&.to_i&.positive? && es_preset == 'single_node_cluster'\n+    elsif Chewy.client.indices.get_settings[Chewy::Stash::Specification.index_name]&.dig('settings', 'index', 'number_of_replicas')&.to_i&.positive? && es_preset == 'single_node_cluster'\n       Admin::SystemCheck::Message.new(:elasticsearch_reset_chewy)\n     elsif cluster_health['status'] == 'yellow'\n       Admin::SystemCheck::Message.new(:elasticsearch_health_yellow)\n---\napp/lib/admin/system_check/elasticsearch_check.rb\n@@ -41,7 +41,7 @@ def message\n       Admin::SystemCheck::Message.new(:elasticsearch_health_red)\n     elsif cluster_health['number_of_nodes'] < 2 && es_preset != 'single_node_cluster'\n       Admin::SystemCheck::Message.new(:elasticsearch_preset_single_node, nil, 'https://docs.joinmastodon.org/admin/optional/elasticsearch/#scaling')\n-    elsif Chewy.client.indices.get_settings['chewy_specifications'].dig('settings', 'index', 'number_of_replicas')&.to_i&.positive? && es_preset == 'single_node_cluster'\n+    elsif Chewy.client.indices.get_settings[Chewy::Stash::Specification.index_name]&.dig('settings', 'index', 'number_of_replicas')&.to_i&.positive? && es_preset == 'single_node_cluster'\n       Admin::SystemCheck::Message.new(:elasticsearch_reset_chewy)\n     elsif cluster_health['status'] == 'yellow'\n       Admin::SystemCheck::Message.new(:elasticsearch_health_yellow)\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -80,6 +80,7 @@ html {\n }\n \n .search__input,\n+.search__popout,\n .setting-text,\n .report-dialog-modal__textarea,\n .audio-player {\n@@ -439,7 +440,8 @@ html {\n .directory__tag > div,\n .card > a,\n .page-header,\n-.compose-form .compose-form__warning {\n+.compose-form,\n+.compose-form__warning {\n   box-shadow: none;\n }\n \n@@ -475,12 +477,17 @@ html {\n   color: $white;\n }\n \n-.compose-form .spoiler-input__input {\n+.compose-form,\n+.spoiler-input__input,\n+.search__input,\n+.search__popout {\n   color: lighten($ui-highlight-color, 8%);\n }\n \n .compose-form .autosuggest-textarea__textarea,\n .compose-form__highlightable,\n+.search__input,\n+.search__popout,\n .poll__option input[type='text'] {\n   background: darken($ui-base-color, 10%);\n }\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Open a browser on a iOS device\r\n2. Navigate to a mastodon server\r\n3. Click on the \"Follow\" button or favourite/boost button while not logged in\r\n4. See the modal with no padding\r\n\n\n### Expected behaviour\n\nThere should be padding\n\n### Actual behaviour\n\nThere was no padding\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.3.0-nightly.2024-08-12\n\n### Browser name and version\n\nChrome 127.0.6533.100\n\n### Operating system\n\nmacOS 14.4.1\n\n### Technical details\n\n![IMG_6349](https://github.com/user-attachments/assets/ae0107c2-8468-4d22-997f-cd899bbdffc7)\r\n\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -5616,7 +5616,7 @@ a.status-card {\n   user-select: text;\n   display: flex;\n \n-  @media screen and (max-width: $no-gap-breakpoint) {\n+  @media screen and (width <= 630px) {\n     margin-top: auto;\n   }\n }\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/components/alt_text_badge.tsx\n@@ -0,0 +1,67 @@\n+import { useState, useCallback, useRef } from 'react';\n+\n+import { FormattedMessage } from 'react-intl';\n+\n+import Overlay from 'react-overlays/Overlay';\n+import type {\n+  OffsetValue,\n+  UsePopperOptions,\n+} from 'react-overlays/esm/usePopper';\n+\n+const offset = [0, 4] as OffsetValue;\n+const popperConfig = { strategy: 'fixed' } as UsePopperOptions;\n+\n+export const AltTextBadge: React.FC<{\n+  description: string;\n+}> = ({ description }) => {\n+  const anchorRef = useRef<HTMLButtonElement>(null);\n+  const [open, setOpen] = useState(false);\n+\n+  const handleClick = useCallback(() => {\n+    setOpen((v) => !v);\n+  }, [setOpen]);\n+\n+  const handleClose = useCallback(() => {\n+    setOpen(false);\n+  }, [setOpen]);\n+\n+  return (\n+    <>\n+      <button\n+        ref={anchorRef}\n+        className='media-gallery__alt__label'\n+        onClick={handleClick}\n+      >\n+        ALT\n+      </button>\n+\n+      <Overlay\n+        rootClose\n+        onHide={handleClose}\n+        show={open}\n+        target={anchorRef.current}\n+        placement='top-end'\n+        flip\n+        offset={offset}\n+        popperConfig={popperConfig}\n+      >\n+        {({ props }) => (\n+          <div {...props} className='hover-card-controller'>\n+            <div\n+              className='media-gallery__alt__popover dropdown-animation'\n+              role='tooltip'\n+            >\n+              <h4>\n+                <FormattedMessage\n+                  id='alt_text_badge.title'\n+                  defaultMessage='Alt text'\n+                />\n+              </h4>\n+              <p>{description}</p>\n+            </div>\n+          </div>\n+        )}\n+      </Overlay>\n+    </>\n+  );\n+};\n---\napp/javascript/mastodon/components/media_gallery.jsx\n@@ -10,6 +10,7 @@ import ImmutablePropTypes from 'react-immutable-proptypes';\n \n import { debounce } from 'lodash';\n \n+import { AltTextBadge } from 'mastodon/components/alt_text_badge';\n import { Blurhash } from 'mastodon/components/blurhash';\n import { formatTime } from 'mastodon/features/video';\n \n@@ -97,7 +98,7 @@ class Item extends PureComponent {\n     }\n \n     if (attachment.get('description')?.length > 0) {\n-      badges.push(<span key='alt' className='media-gallery__alt__label'>ALT</span>);\n+      badges.push(<AltTextBadge key='alt' description={attachment.get('description')} />);\n     }\n \n     const description = attachment.getIn(['translation', 'description']) || attachment.get('description');\n@@ -156,9 +157,9 @@ class Item extends PureComponent {\n       const duration = attachment.getIn(['meta', 'original', 'duration']);\n \n       if (attachment.get('type') === 'gifv') {\n-        badges.push(<span key='gif' className='media-gallery__gifv__label'>GIF</span>);\n+        badges.push(<span key='gif' className='media-gallery__alt__label media-gallery__alt__label--non-interactive'>GIF</span>);\n       } else {\n-        badges.push(<span key='video' className='media-gallery__gifv__label'>{formatTime(Math.floor(duration))}</span>);\n+        badges.push(<span key='video' className='media-gallery__alt__label media-gallery__alt__label--non-interactive'>{formatTime(Math.floor(duration))}</span>);\n       }\n \n       thumbnail = (\n---\napp/javascript/mastodon/features/account_gallery/components/media_item.tsx\n@@ -5,6 +5,7 @@ import classNames from 'classnames';\n import HeadphonesIcon from '@/material-icons/400-24px/headphones-fill.svg?react';\n import MovieIcon from '@/material-icons/400-24px/movie-fill.svg?react';\n import VisibilityOffIcon from '@/material-icons/400-24px/visibility_off.svg?react';\n+import { AltTextBadge } from 'mastodon/components/alt_text_badge';\n import { Blurhash } from 'mastodon/components/blurhash';\n import { Icon } from 'mastodon/components/icon';\n import { formatTime } from 'mastodon/features/video';\n@@ -77,11 +78,7 @@ export const MediaItem: React.FC<{\n   const badges = [];\n \n   if (description && description.length > 0) {\n-    badges.push(\n-      <span key='alt' className='media-gallery__alt__label'>\n-        ALT\n-      </span>,\n-    );\n+    badges.push(<AltTextBadge key='alt' description={description} />);\n   }\n \n   if (!visible) {\n@@ -156,13 +153,19 @@ export const MediaItem: React.FC<{\n \n     if (type === 'gifv') {\n       badges.push(\n-        <span key='gif' className='media-gallery__gifv__label'>\n+        <span\n+          key='gif'\n+          className='media-gallery__alt__label media-gallery__alt__label--non-interactive'\n+        >\n           GIF\n         </span>,\n       );\n     } else {\n       badges.push(\n-        <span key='video' className='media-gallery__gifv__label'>\n+        <span\n+          key='video'\n+          className='media-gallery__alt__label media-gallery__alt__label--non-interactive'\n+        >\n           {formatTime(Math.floor(duration))}\n         </span>,\n       );\n---\napp/javascript/mastodon/locales/en.json\n@@ -85,6 +85,7 @@\n   \"alert.rate_limited.title\": \"Rate limited\",\n   \"alert.unexpected.message\": \"An unexpected error occurred.\",\n   \"alert.unexpected.title\": \"Oops!\",\n+  \"alt_text_badge.title\": \"Alt text\",\n   \"announcement.announcement\": \"Announcement\",\n   \"attachments_list.unprocessed\": \"(unprocessed)\",\n   \"audio.hide\": \"Hide audio\",\n---\napp/javascript/styles/mastodon/components.scss\n@@ -6971,23 +6971,56 @@ a.status-card {\n   inset-inline-end: 8px;\n   display: flex;\n   gap: 2px;\n+  pointer-events: none;\n }\n \n-.media-gallery__alt__label,\n-.media-gallery__gifv__label {\n-  display: flex;\n-  align-items: center;\n-  justify-content: center;\n+.media-gallery__alt__label {\n+  display: block;\n+  text-align: center;\n   color: $white;\n+  border: 0;\n   background: rgba($black, 0.65);\n   backdrop-filter: blur(10px) saturate(180%) contrast(75%) brightness(70%);\n   padding: 3px 8px;\n   border-radius: 4px;\n   font-size: 12px;\n   font-weight: 700;\n   z-index: 1;\n-  pointer-events: none;\n   line-height: 20px;\n+  cursor: pointer;\n+  pointer-events: auto;\n+\n+  &--non-interactive {\n+    pointer-events: none;\n+  }\n+}\n+\n+.media-gallery__alt__popover {\n+  background: rgba($black, 0.65);\n+  backdrop-filter: blur(10px) saturate(180%) contrast(75%) brightness(70%);\n+  border-radius: 4px;\n+  box-shadow: var(--dropdown-shadow);\n+  padding: 16px;\n+  min-width: 16em;\n+  min-height: 2em;\n+  max-width: 22em;\n+  max-height: 30em;\n+  overflow-y: auto;\n+\n+  h4 {\n+    font-size: 15px;\n+    line-height: 20px;\n+    font-weight: 500;\n+    color: $white;\n+    margin-bottom: 8px;\n+  }\n+\n+  p {\n+    font-size: 15px;\n+    line-height: 20px;\n+    color: rgba($white, 0.85);\n+    white-space: pre-line;\n+  }\n }\n \n .attachment-list {\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -2836,7 +2836,7 @@ $ui-header-logo-wordmark-width: 99px;\n   overflow: hidden;\n }\n \n-@media screen and (width >= 631px) {\n+@media screen and (width > $mobile-breakpoint) {\n   .columns-area {\n     padding: 0;\n   }\n@@ -5731,7 +5731,7 @@ a.status-card {\n   user-select: text;\n   display: flex;\n \n-  @media screen and (width <= 630px) {\n+  @media screen and (width <= $mobile-breakpoint) {\n     margin-top: auto;\n   }\n }\n@@ -6090,7 +6090,7 @@ a.status-card {\n     border-radius: 0 0 16px 16px;\n     border-top: 0;\n \n-    @media screen and (max-width: $no-gap-breakpoint) {\n+    @media screen and (max-width: $mobile-breakpoint) {\n       border-radius: 0;\n       border-bottom: 0;\n       padding-bottom: 32px;\n@@ -9092,8 +9092,9 @@ noscript {\n   backdrop-filter: var(--background-filter);\n   border: 1px solid var(--modal-border-color);\n   padding: 24px;\n+  box-sizing: border-box;\n \n-  @media screen and (max-width: $no-gap-breakpoint) {\n+  @media screen and (max-width: $mobile-breakpoint) {\n     border-radius: 16px 16px 0 0;\n     border-bottom: 0;\n     padding-bottom: 32px;\n---\napp/javascript/styles/mastodon/variables.scss\n@@ -88,6 +88,7 @@ $media-modal-media-max-width: 100%;\n $media-modal-media-max-height: 80%;\n \n $no-gap-breakpoint: 1175px;\n+$mobile-breakpoint: 630px;\n \n $font-sans-serif: 'mastodon-font-sans-serif' !default;\n $font-display: 'mastodon-font-display' !default;\n---\n\n\n---\n\nChoice D:\napp/lib/activitypub/parser/status_parser.rb\n@@ -53,7 +53,8 @@ def title\n   end\n \n   def created_at\n-    @object['published']&.to_datetime\n+    datetime = @object['published']&.to_datetime\n+    datetime if datetime.present? && (0..9999).cover?(datetime.year)\n   rescue ArgumentError\n     nil\n   end\n---\nspec/lib/activitypub/activity/create_spec.rb\n@@ -134,29 +134,67 @@ def activity_for_object(json)\n         subject.perform\n       end\n \n-      context 'when object has been edited' do\n+      context 'when object publication date is below ISO8601 range' do\n         let(:object_json) do\n           {\n             id: [ActivityPub::TagManager.instance.uri_for(sender), '#bar'].join,\n             type: 'Note',\n             content: 'Lorem ipsum',\n-            published: '2022-01-22T15:00:00Z',\n-            updated: '2022-01-22T16:00:00Z',\n+            published: '-0977-11-03T08:31:22Z',\n           }\n         end\n \n-        it 'creates status' do\n+        it 'creates status with a valid creation date', :aggregate_failures do\n+          status = sender.statuses.first\n+\n+          expect(status).to_not be_nil\n+          expect(status.text).to eq 'Lorem ipsum'\n+\n+          expect(status.created_at).to be_within(30).of(Time.now.utc)\n+        end\n+      end\n+\n+      context 'when object publication date is above ISO8601 range' do\n+        let(:object_json) do\n+          {\n+            id: [ActivityPub::TagManager.instance.uri_for(sender), '#bar'].join,\n+            type: 'Note',\n+            content: 'Lorem ipsum',\n+            published: '10000-11-03T08:31:22Z',\n+          }\n+        end\n+\n+        it 'creates status with a valid creation date', :aggregate_failures do\n           status = sender.statuses.first\n \n           expect(status).to_not be_nil\n           expect(status.text).to eq 'Lorem ipsum'\n+\n+          expect(status.created_at).to be_within(30).of(Time.now.utc)\n+        end\n+      end\n+\n+      context 'when object has been edited' do\n+        let(:object_json) do\n+          {\n+            id: [ActivityPub::TagManager.instance.uri_for(sender), '#bar'].join,\n+            type: 'Note',\n+            content: 'Lorem ipsum',\n+            published: '2022-01-22T15:00:00Z',\n+            updated: '2022-01-22T16:00:00Z',\n+          }\n         end\n \n-        it 'marks status as edited' do\n+        it 'creates status with appropriate creation and edition dates', :aggregate_failures do\n           status = sender.statuses.first\n \n           expect(status).to_not be_nil\n+          expect(status.text).to eq 'Lorem ipsum'\n+\n+          expect(status.created_at).to eq '2022-01-22T15:00:00Z'.to_datetime\n+\n           expect(status.edited?).to be true\n+          expect(status.edited_at).to eq '2022-01-22T16:00:00Z'.to_datetime\n         end\n       end\n \n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nThe **IPv6 only** installation of Mastodon (Docker) seems to have several problems.\n\n### Expected behaviour\n\nrun a single stack IPv6 server\n\n### Actual behaviour\n\nhave to run a dual stack server or an IPv4 server\n\n### Detailed description\n\nIt would be nice to test all new versions of Mastodon on an **IPv6 only** environment.\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\nv4.x\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/compose/components/emoji_picker_dropdown.jsx\n@@ -164,6 +164,7 @@ class EmojiPickerMenuImpl extends PureComponent {\n     intl: PropTypes.object.isRequired,\n     skinTone: PropTypes.number.isRequired,\n     onSkinTone: PropTypes.func.isRequired,\n+    pickerButtonRef: PropTypes.func.isRequired\n   };\n \n   static defaultProps = {\n@@ -178,7 +179,7 @@ class EmojiPickerMenuImpl extends PureComponent {\n   };\n \n   handleDocumentClick = e => {\n-    if (this.node && !this.node.contains(e.target)) {\n+    if (this.node && !this.node.contains(e.target) && !this.props.pickerButtonRef.contains(e.target)) {\n       this.props.onClose();\n     }\n   };\n@@ -233,6 +234,7 @@ class EmojiPickerMenuImpl extends PureComponent {\n       emoji.native = emoji.colons;\n     }\n     if (!(event.ctrlKey || event.metaKey)) {\n+\n       this.props.onClose();\n     }\n     this.props.onPick(emoji);\n@@ -407,6 +409,7 @@ class EmojiPickerDropdown extends PureComponent {\n                   onSkinTone={onSkinTone}\n                   skinTone={skinTone}\n                   frequentlyUsedEmojis={frequentlyUsedEmojis}\n+                  pickerButtonRef={this.target}\n                 />\n               </div>\n             </div>\n---\n\n\n---\n\nChoice B:\napp/helpers/languages_helper.rb\n@@ -254,6 +254,7 @@ def standard_locale_name(locale)\n \n   def valid_locale_or_nil(str)\n     return if str.blank?\n+    return str if valid_locale?(str)\n \n     code, = str.to_s.split(/[_-]/) # Strip out the region from e.g. en_US or ja-JP\n \n---\n\n\n---\n\nChoice C:\nstreaming/index.js\n@@ -1351,15 +1351,23 @@ const startServer = async () => {\n  * @param {function(string): void} [onSuccess]\n  */\n const attachServerWithConfig = (server, onSuccess) => {\n-  if (process.env.SOCKET || process.env.PORT && isNaN(+process.env.PORT)) {\n-    server.listen(process.env.SOCKET || process.env.PORT, () => {\n+  if (process.env.SOCKET) {\n+    server.listen(process.env.SOCKET, () => {\n       if (onSuccess) {\n         fs.chmodSync(server.address(), 0o666);\n         onSuccess(server.address());\n       }\n     });\n   } else {\n-    server.listen(+(process.env.PORT || 4000), process.env.BIND || '127.0.0.1', () => {\n+    const port = +(process.env.PORT || 4000);\n+    let bind = process.env.BIND ?? '127.0.0.1';\n+    // Web uses the URI syntax for BIND, which means IPv6 addresses may\n+    // be wrapped in square brackets:\n+    if (bind.startsWith('[') && bind.endsWith(']')) {\n+      bind = bind.slice(1, -1);\n+    }\n+\n+    server.listen(port, bind, () => {\n       if (onSuccess) {\n         onSuccess(`${server.address().address}:${server.address().port}`);\n       }\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/reducers/notification_groups.ts\n@@ -559,7 +559,10 @@ export const notificationGroupsReducer = createReducer<NotificationGroupsState>(\n           compareId(state.lastReadId, mostRecentGroup.page_max_id) < 0\n         )\n           state.lastReadId = mostRecentGroup.page_max_id;\n-        commitLastReadId(state);\n+\n+        // We don't call `commitLastReadId`, because that is conditional\n+        // and we want to unconditionally update the state instead.\n+        state.readMarkerId = state.lastReadId;\n       })\n       .addCase(fetchMarkers.fulfilled, (state, action) => {\n         if (\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Browse to mastodon.social\r\n2. Log in\n\n### Expected behaviour\n\nLog in and use Mastodon\n\n### Actual behaviour\n\nMy home page flashed, then I got a crash.\n\n### Detailed description\n\n![image](https://github.com/user-attachments/assets/67d2a3d9-3cba-4955-980a-26e9dc4df927)\r\n\r\nHere's the traceback:\r\n\r\n```\r\nTypeError: n is undefined\r\n\r\n\r\n@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:1357289\r\n@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:112298\r\ne@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:1543509\r\nt.useSyncExternalStoreWithSelector/d</<@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:1543714\r\nuseSyncExternalStore@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:1448121\r\nt.useSyncExternalStore@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:1515745\r\nt.useSyncExternalStoreWithSelector@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:1543785\r\nn@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:112339\r\nEe@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:1357230\r\nmi@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:1441138\r\njc@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:1500107\r\nyl@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:1489357\r\nbl@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:1489285\r\nml@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:1489146\r\nol@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:1485981\r\ncl@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:1486363\r\nBa@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:1427512\r\nrl/<@https://mastodon.social/packs/js/common-81e30f7b38745cf6b34f.js:2:1483936\r\n\r\n\r\n\r\nLabelRenderer (webpack:///app/javascript/mastodon/features/notifications_v2/components/notification_mention.tsx:43:6)\r\nselector.name] (webpack:///node_modules/react-redux/dist/react-redux.legacy-esm.js:123:36)\r\nuseSyncExternalStoreWithSelector (webpack:///node_modules/use-sync-external-store/cjs/use-sync-external-store-with-selector.production.min.js:11:203)\r\nuseSyncExternalStoreWithSelector (webpack:///node_modules/use-sync-external-store/cjs/use-sync-external-store-with-selector.production.min.js:11:419)\r\nuseDeferredValue (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:178:367)\r\nuseMemo (webpack:///node_modules/react/cjs/react.production.min.js:26:308)\r\nuseSyncExternalStoreWithSelector (webpack:///node_modules/use-sync-external-store/cjs/use-sync-external-store-with-selector.production.min.js:11:490)\r\nsubscription (webpack:///node_modules/react-redux/dist/react-redux.legacy-esm.js:177:6)\r\nLabelRenderer (webpack:///app/javascript/mastodon/features/notifications_v2/components/notification_mention.tsx:39:30)\r\nNh (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:160:136)\r\nVk (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:289:336)\r\ntj (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:279:391)\r\ntj (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:279:322)\r\ntj (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:279:179)\r\nNk (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:270:87)\r\nCk (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:272:299)\r\njg (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:127:104)\r\nDk (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:266:272)\r\n```\r\n\n\n### Mastodon instance\n\nhttps://mastodon.social\n\n### Mastodon version\n\nMastodon v4.3.0-nightly.2024-08-12\n\n### Browser name and version\n\nFirefox 129.0 (64-bit). It also crashes on Edge, Chrome and Vivaldi. It's probably not a browser problem!\n\n### Operating system\n\nWindows 11\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/notifications_v2/components/notification_group.tsx\n@@ -20,6 +20,21 @@ import { NotificationSeveredRelationships } from './notification_severed_relatio\n import { NotificationStatus } from './notification_status';\n import { NotificationUpdate } from './notification_update';\n \n+function missingActivity(notificationGroup: NotificationGroupModel) {\n+  switch (notificationGroup.type) {\n+    case 'reblog':\n+    case 'favourite':\n+    case 'mention':\n+    case 'update':\n+    case 'status':\n+    case 'poll':\n+      // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition -- our type is actually not correct as the server can occasionally have orphaned notifications\n+      return notificationGroup.statusId === null;\n+    default:\n+      return false;\n+  }\n+}\n+\n export const NotificationGroup: React.FC<{\n   notificationGroupId: NotificationGroupModel['group_key'];\n   unread: boolean;\n@@ -60,7 +75,12 @@ export const NotificationGroup: React.FC<{\n     [dispatch, notificationGroupId, accountId, onMoveUp, onMoveDown],\n   );\n \n-  if (!notificationGroup || notificationGroup.type === 'gap') return null;\n+  if (\n+    !notificationGroup ||\n+    notificationGroup.type === 'gap' ||\n+    missingActivity(notificationGroup)\n+  )\n+    return null;\n \n   let content;\n \n---\napp/javascript/mastodon/actions/notification_groups.ts\n@@ -47,7 +47,7 @@ function dispatchAssociatedRecords(\n       fetchedAccounts.push(notification.moderation_warning.target_account);\n     }\n \n-    if ('status' in notification) {\n+    if ('status' in notification && notification.status) {\n       fetchedStatuses.push(notification.status);\n     }\n   });\n@@ -119,7 +119,7 @@ export const processNewNotificationForGroups = createAppAsyncThunk(\n \n     if (\n       (notification.type === 'mention' || notification.type === 'update') &&\n-      notification.status.filtered\n+      notification.status?.filtered\n     ) {\n       const filters = notification.status.filtered.filter((result) =>\n         result.filter.context.includes('notifications'),\n---\napp/javascript/mastodon/api_types/notifications.ts\n@@ -60,12 +60,12 @@ export interface BaseNotificationGroupJSON {\n \n interface NotificationGroupWithStatusJSON extends BaseNotificationGroupJSON {\n   type: NotificationWithStatusType;\n-  status_id: string;\n+  status_id: string | null;\n }\n \n interface NotificationWithStatusJSON extends BaseNotificationJSON {\n   type: NotificationWithStatusType;\n-  status: ApiStatusJSON;\n+  status: ApiStatusJSON | null;\n }\n \n interface ReportNotificationGroupJSON extends BaseNotificationGroupJSON {\n---\napp/javascript/mastodon/features/notifications_v2/components/notification_mention.tsx\n@@ -37,7 +37,11 @@ export const NotificationMention: React.FC<{\n   unread: boolean;\n }> = ({ notification, unread }) => {\n   const [isDirect, isReply] = useAppSelector((state) => {\n-    const status = state.statuses.get(notification.statusId) as Status;\n+    const status = state.statuses.get(notification.statusId) as\n+      | Status\n+      | undefined;\n+\n+    if (!status) return [false, false] as const;\n \n     return [\n       status.get('visibility') === 'direct',\n---\napp/javascript/mastodon/features/notifications_v2/components/notification_with_status.tsx\n@@ -23,7 +23,7 @@ export const NotificationWithStatus: React.FC<{\n   icon: IconProp;\n   iconId: string;\n   accountIds: string[];\n-  statusId: string;\n+  statusId: string | undefined;\n   count: number;\n   labelRenderer: LabelRenderer;\n   unread: boolean;\n@@ -76,6 +76,8 @@ export const NotificationWithStatus: React.FC<{\n     [dispatch, statusId],\n   );\n \n+  if (!statusId) return null;\n+\n   return (\n     <HotKeys handlers={handlers}>\n       <div\n---\napp/javascript/mastodon/models/notification_group.ts\n@@ -21,7 +21,7 @@ interface BaseNotificationGroup\n interface BaseNotificationWithStatus<Type extends NotificationWithStatusType>\n   extends BaseNotificationGroup {\n   type: Type;\n-  statusId: string;\n+  statusId: string | undefined;\n }\n \n interface BaseNotification<Type extends NotificationType>\n@@ -126,7 +126,7 @@ export function createNotificationGroupFromJSON(\n     case 'update': {\n       const { status_id: statusId, ...groupWithoutStatus } = group;\n       return {\n-        statusId,\n+        statusId: statusId ?? undefined,\n         sampleAccountIds,\n         ...groupWithoutStatus,\n       };\n@@ -183,7 +183,7 @@ export function createNotificationGroupFromNotificationJSON(\n     case 'mention':\n     case 'poll':\n     case 'update':\n-      return { ...group, statusId: notification.status.id };\n+      return { ...group, statusId: notification.status?.id };\n     case 'admin.report':\n       return { ...group, report: createReportFromJSON(notification.report) };\n     case 'severed_relationships':\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/home_timeline/components/inline_follow_suggestions.jsx\n@@ -129,8 +129,13 @@ export const InlineFollowSuggestions = ({ hidden }) => {\n       return;\n     }\n \n-    setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n-    setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    if (getComputedStyle(bodyRef.current).direction === 'rtl') {\n+      setCanScrollLeft((bodyRef.current.clientWidth - bodyRef.current.scrollLeft) < bodyRef.current.scrollWidth);\n+      setCanScrollRight(bodyRef.current.scrollLeft < 0);\n+    } else {\n+      setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n+      setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    }\n   }, [setCanScrollRight, setCanScrollLeft, bodyRef, suggestions]);\n \n   const handleLeftNav = useCallback(() => {\n---\n\n\n---\n\nChoice C:\napp/models/account.rb\n@@ -144,6 +144,7 @@ class Account < ApplicationRecord\n   scope :dormant, -> { joins(:account_stat).merge(AccountStat.without_recent_activity) }\n   scope :with_username, ->(value) { where arel_table[:username].lower.eq(value.to_s.downcase) }\n   scope :with_domain, ->(value) { where arel_table[:domain].lower.eq(value&.to_s&.downcase) }\n+  scope :without_memorial, -> { where(memorial: false) }\n \n   after_update_commit :trigger_update_webhooks\n \n---\napp/models/account_suggestions/friends_of_friends_source.rb\n@@ -31,6 +31,7 @@ def source_query(account, limit: DEFAULT_LIMIT)\n         AND accounts.suspended_at IS NULL\n         AND accounts.silenced_at IS NULL\n         AND accounts.moved_to_account_id IS NULL\n+        AND accounts.memorial = FALSE\n         AND follow_recommendation_mutes.target_account_id IS NULL\n       GROUP BY accounts.id, account_stats.id\n       ORDER BY frequency DESC, account_stats.followers_count ASC\n---\napp/models/account_suggestions/source.rb\n@@ -14,6 +14,7 @@ def base_account_scope(account)\n       .searchable\n       .where(discoverable: true)\n       .without_silenced\n+      .without_memorial\n       .where.not(follows_sql, id: account.id)\n       .where.not(follow_requests_sql, id: account.id)\n       .not_excluded_by_account(account)\n---\nspec/models/account_suggestions/friends_of_friends_source_spec.rb\n@@ -15,6 +15,7 @@\n     let!(:john) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:jerk) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:larry) { Fabricate(:account, discoverable: true, hide_collections: false) }\n+    let!(:morty) { Fabricate(:account, discoverable: true, hide_collections: false, memorial: true) }\n \n     context 'with follows and blocks' do\n       before do\n@@ -27,8 +28,8 @@\n         # alice follows eve and mallory\n         [john, mallory].each { |account| alice.follow!(account) }\n \n-        # eugen follows eve, john, jerk, larry and neil\n-        [eve, mallory, jerk, larry, neil].each { |account| eugen.follow!(account) }\n+        # eugen follows eve, john, jerk, larry, neil and morty\n+        [eve, mallory, jerk, larry, neil, morty].each { |account| eugen.follow!(account) }\n       end\n \n       it 'returns eligible accounts', :aggregate_failures do\n@@ -51,6 +52,9 @@\n \n         # the suggestion for neil has already been rejected\n         expect(results).to_not include([neil.id, :friends_of_friends])\n+\n+        # morty is not included because his account is in memoriam\n+        expect(results).to_not include([morty.id, :friends_of_friends])\n       end\n     end\n \n---\nspec/models/account_suggestions/source_spec.rb\n@@ -21,6 +21,7 @@\n       let!(:moved_account) { Fabricate(:account, moved_to_account: Fabricate(:account), discoverable: true) }\n       let!(:silenced_account) { Fabricate(:account, silenced: true, discoverable: true) }\n       let!(:undiscoverable_account) { Fabricate(:account, discoverable: false) }\n+      let!(:memorial_account) { Fabricate(:account, memorial: true, discoverable: true) }\n \n       before do\n         Fabricate :account_domain_block, account: account, domain: account_domain_blocked_account.domain\n@@ -44,6 +45,7 @@\n           .and not_include(moved_account)\n           .and not_include(silenced_account)\n           .and not_include(undiscoverable_account)\n+          .and not_include(memorial_account)\n       end\n     end\n   end\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/components/edited_timestamp/index.jsx\n@@ -67,7 +67,7 @@ class EditedTimestamp extends PureComponent {\n     return (\n       <DropdownMenu statusId={statusId} renderItem={this.renderItem} scrollable renderHeader={this.renderHeader} onItemClick={this.handleItemClick}>\n         <button className='dropdown-menu__text-button'>\n-          <FormattedMessage id='status.edited' defaultMessage='Edited {date}' values={{ date: intl.formatDate(timestamp, { hour12: false, month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) }} /> <Icon id='caret-down' icon={ArrowDropDownIcon} />\n+          <FormattedMessage id='status.edited' defaultMessage='Edited {date}' values={{ date: intl.formatDate(timestamp, { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) }} /> <Icon id='caret-down' icon={ArrowDropDownIcon} />\n         </button>\n       </DropdownMenu>\n     );\n---\napp/javascript/mastodon/components/relative_timestamp.tsx\n@@ -53,7 +53,6 @@ const messages = defineMessages({\n });\n \n const dateFormatOptions = {\n-  hour12: false,\n   year: 'numeric',\n   month: 'short',\n   day: '2-digit',\n---\napp/javascript/mastodon/components/status.jsx\n@@ -554,7 +554,7 @@ class Status extends ImmutablePureComponent {\n             <div onClick={this.handleClick} className='status__info'>\n               <a href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} className='status__relative-time' target='_blank' rel='noopener noreferrer'>\n                 <span className='status__visibility-icon'><VisibilityIcon visibility={status.get('visibility')} /></span>\n-                <RelativeTimestamp timestamp={status.get('created_at')} />{status.get('edited_at') && <abbr title={intl.formatMessage(messages.edited, { date: intl.formatDate(status.get('edited_at'), { hour12: false, year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) })}> *</abbr>}\n+                <RelativeTimestamp timestamp={status.get('created_at')} />{status.get('edited_at') && <abbr title={intl.formatMessage(messages.edited, { date: intl.formatDate(status.get('edited_at'), { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) })}> *</abbr>}\n               </a>\n \n               <a onClick={this.handleAccountClick} href={`/@${status.getIn(['account', 'acct'])}`} title={status.getIn(['account', 'acct'])} className='status__display-name' target='_blank' rel='noopener noreferrer'>\n---\napp/javascript/mastodon/features/account/components/header.jsx\n@@ -101,7 +101,6 @@ const dateFormatOptions = {\n   month: 'short',\n   day: 'numeric',\n   year: 'numeric',\n-  hour12: false,\n   hour: '2-digit',\n   minute: '2-digit',\n };\n---\napp/javascript/mastodon/features/getting_started/components/announcements.jsx\n@@ -343,7 +343,7 @@ class Announcement extends ImmutablePureComponent {\n       <div className='announcements__item'>\n         <strong className='announcements__item__range'>\n           <FormattedMessage id='announcement.announcement' defaultMessage='Announcement' />\n-          {hasTimeRange && <span> \u00b7 <FormattedDate value={startsAt} hour12={false} year={(skipYear || startsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month='short' day='2-digit' hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /> - <FormattedDate value={endsAt} hour12={false} year={(skipYear || endsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month={skipEndDate ? undefined : 'short'} day={skipEndDate ? undefined : '2-digit'} hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /></span>}\n+          {hasTimeRange && <span> \u00b7 <FormattedDate value={startsAt} year={(skipYear || startsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month='short' day='2-digit' hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /> - <FormattedDate value={endsAt} year={(skipYear || endsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month={skipEndDate ? undefined : 'short'} day={skipEndDate ? undefined : '2-digit'} hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /></span>}\n         </strong>\n \n         <Content announcement={announcement} />\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -311,7 +311,7 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n-              <FormattedDate value={new Date(status.get('created_at'))} hour12={false} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n+              <FormattedDate value={new Date(status.get('created_at'))} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n             </a>{edited}{visibilityLink}{applicationLink}{reblogLink} \u00b7 {favouriteLink}\n           </div>\n         </div>\n---\napp/javascript/packs/public.jsx\n@@ -65,7 +65,6 @@ function loaded() {\n \n   const timeFormat = new Intl.DateTimeFormat(locale, {\n     timeStyle: 'short',\n-    hour12: false,\n   });\n \n   const formatMessage = ({ id, defaultMessage }, values) => {\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Log in your account on mastodon.social\r\n2. Select logout option in menu section beside profile.\r\n3. Click on \"Log out\" in Confirm Log out modal.\n\n### Expected behaviour\n\nShould be able to logout\n\n### Actual behaviour\n\nUnable to logout from my account\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.3.0-nightly.2024-08-09\n\n### Browser name and version\n\nSafari Version 17.5\n\n### Operating system\n\nmacOS 14.5\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/models/concerns/attachmentable.rb\n@@ -52,9 +52,13 @@ def check_image_dimension(attachment)\n     return if attachment.blank? || !/image.*/.match?(attachment.content_type) || attachment.queued_for_write[:original].blank?\n \n     width, height = FastImage.size(attachment.queued_for_write[:original].path)\n-    matrix_limit  = attachment.content_type == 'image/gif' ? GIF_MATRIX_LIMIT : MAX_MATRIX_LIMIT\n+    return unless width.present? && height.present?\n \n-    raise Mastodon::DimensionsValidationError, \"#{width}x#{height} images are not supported\" if width.present? && height.present? && (width * height > matrix_limit)\n+    if attachment.content_type == 'image/gif' && width * height > GIF_MATRIX_LIMIT\n+      raise Mastodon::DimensionsValidationError, \"#{width}x#{height} GIF files are not supported\"\n+    elsif width * height > MAX_MATRIX_LIMIT\n+      raise Mastodon::DimensionsValidationError, \"#{width}x#{height} images are not supported\"\n+    end\n   end\n \n   def appropriate_extension(attachment)\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/actions/notifications_typed.ts\n@@ -18,6 +18,6 @@ export const notificationsUpdate = createAction(\n     playSound: boolean;\n   }) => ({\n     payload: args,\n-    meta: { playSound: playSound ? { sound: 'boop' } : undefined },\n+    meta: { sound: playSound ? 'boop' : undefined },\n   }),\n );\n---\n\n\n---\n\nChoice C:\napp/helpers/application_helper.rb\n@@ -256,6 +256,10 @@ def app_icon_path(size = '48')\n     instance_presenter.app_icon&.file&.url(size)\n   end\n \n+  def use_mask_icon?\n+    instance_presenter.app_icon.blank?\n+  end\n+\n   private\n \n   def storage_host_var\n---\napp/views/layouts/application.html.haml\n@@ -19,7 +19,8 @@\n     - SiteUpload::APPLE_ICON_SIZES.each do |size|\n       %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: app_icon_path(size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n \n-    %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n+    - if use_mask_icon?\n+      %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n     %link{ rel: 'manifest', href: manifest_path(format: :json) }/\n     = theme_color_tags current_theme\n     %meta{ name: 'apple-mobile-web-app-capable', content: 'yes' }/\n---\n\n\n---\n\nChoice D:\napp/controllers/auth/sessions_controller.rb\n@@ -187,4 +187,15 @@ def on_authentication_failure(user, security_measure, failure_reason)\n   def second_factor_attempts_key(user)\n     \"2fa_auth_attempts:#{user.id}:#{Time.now.utc.hour}\"\n   end\n+\n+  def respond_to_on_destroy\n+    respond_to do |format|\n+      format.json do\n+        render json: {\n+          redirect_to: after_sign_out_path_for(resource_name),\n+        }, status: 200\n+      end\n+      format.all { super }\n+    end\n+  end\n end\n---\napp/javascript/mastodon/features/ui/components/confirmation_modals/log_out.tsx\n@@ -25,7 +25,7 @@ export const ConfirmLogOutModal: React.FC<BaseConfirmationModalProps> = ({\n   const intl = useIntl();\n \n   const onConfirm = useCallback(() => {\n-    logOut();\n+    void logOut();\n   }, []);\n \n   return (\n---\napp/javascript/mastodon/utils/log_out.ts\n@@ -1,36 +1,20 @@\n-export const logOut = () => {\n-  const form = document.createElement('form');\n+import api from 'mastodon/api';\n \n-  const methodInput = document.createElement('input');\n-  methodInput.setAttribute('name', '_method');\n-  methodInput.setAttribute('value', 'delete');\n-  methodInput.setAttribute('type', 'hidden');\n-  form.appendChild(methodInput);\n+export async function logOut() {\n+  try {\n+    const response = await api(false).delete<{ redirect_to?: string }>(\n+      '/auth/sign_out',\n+      { headers: { Accept: 'application/json' }, withCredentials: true },\n+    );\n \n-  const csrfToken = document.querySelector<HTMLMetaElement>(\n-    'meta[name=csrf-token]',\n-  );\n-\n-  const csrfParam = document.querySelector<HTMLMetaElement>(\n-    'meta[name=csrf-param]',\n-  );\n-\n-  if (csrfParam && csrfToken) {\n-    const csrfInput = document.createElement('input');\n-    csrfInput.setAttribute('name', csrfParam.content);\n-    csrfInput.setAttribute('value', csrfToken.content);\n-    csrfInput.setAttribute('type', 'hidden');\n-    form.appendChild(csrfInput);\n+    if (response.status === 200 && response.data.redirect_to)\n+      window.location.href = response.data.redirect_to;\n+    else\n+      console.error(\n+        'Failed to log out, got an unexpected non-redirect response from the server',\n+        response,\n+      );\n+  } catch (error) {\n+    console.error('Failed to log out, response was an error', error);\n   }\n-\n-  const submitButton = document.createElement('input');\n-  submitButton.setAttribute('type', 'submit');\n-  form.appendChild(submitButton);\n-\n-  form.method = 'post';\n-  form.action = '/auth/sign_out';\n-  form.style.display = 'none';\n-\n-  document.body.appendChild(form);\n-  submitButton.click();\n-};\n+}\n---\nspec/requests/log_out_spec.rb\n@@ -0,0 +1,30 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+describe 'Log Out' do\n+  include RoutingHelper\n+\n+  describe 'DELETE /auth/sign_out' do\n+    let(:user) { Fabricate(:user) }\n+\n+    before do\n+      sign_in user\n+    end\n+\n+    it 'Logs out the user and redirect' do\n+      delete '/auth/sign_out'\n+\n+      expect(response).to redirect_to('/auth/sign_in')\n+    end\n+\n+    it 'Logs out the user and return a page to redirect to with a JSON request' do\n+      delete '/auth/sign_out', headers: { 'HTTP_ACCEPT' => 'application/json' }\n+\n+      expect(response).to have_http_status(200)\n+      expect(response.media_type).to eq 'application/json'\n+\n+      expect(body_as_json[:redirect_to]).to eq '/auth/sign_in'\n+    end\n+  end\n+end\n---\nspec/system/log_out_spec.rb\n@@ -0,0 +1,43 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+describe 'Log out' do\n+  include ProfileStories\n+\n+  before do\n+    as_a_logged_in_user\n+  end\n+\n+  describe 'Logging out from the preferences' do\n+    it 'logs the user out' do\n+      visit settings_path\n+\n+      within '.sidebar' do\n+        click_on 'Logout'\n+      end\n+\n+      expect(page).to have_title(I18n.t('auth.login'))\n+      expect(page).to have_current_path('/auth/sign_in')\n+    end\n+  end\n+\n+  describe 'Logging out from the JS app', :js, :streaming do\n+    it 'logs the user out' do\n+      visit root_path\n+\n+      within '.navigation-bar' do\n+        click_on 'Menu'\n+      end\n+\n+      within '.dropdown-menu' do\n+        click_on 'Logout'\n+      end\n+\n+      click_on 'Log out'\n+\n+      expect(page).to have_title(I18n.t('auth.login'))\n+      expect(page).to have_current_path('/auth/sign_in')\n+    end\n+  end\n+end\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Post a YouTube short URL like https://youtu.be/C_b6bptI844\r\n2. Open the link in the post, video shows fine\r\n3. Open the link via the preview card, YouTube loads the page of an \"undefined\" YouTube channel or showing a blank page: https://www.youtube.com/undefined\r\n\r\nHappens on Mastodon 4.2.10\r\n\r\n![Screenshot_20240811-102045](https://github.com/user-attachments/assets/c4acf1df-6cbb-4d07-8cff-215e9d1fbe72)\r\n\r\n\r\n\r\n### Expected behaviour\r\n\r\nthe preview card should keep the original name the same.\r\n\r\n### Actual behaviour\r\n\r\na wrong video page is shown\r\n\r\n### Detailed description\r\n\r\n_No response_\r\n\r\n### Mastodon instance\r\n\r\nruhr.social\r\n\r\n### Mastodon version\r\n\r\n4.2.10\r\n\r\n### Browser name and version\r\n\r\nchrome Android Version 127.0.6533.103 and Firefox Android 129.0b9 (Build #2016034799),\r\n\r\n### Operating system\r\n\r\nAndroid 14\r\n\r\n### Technical details\r\n\r\nI tested it with short urls for YouTube shorts and for regular videos, it happens with both of them \n\n---\n\nChoice A:\napp/models/web/push_subscription.rb\n@@ -21,7 +21,7 @@ class Web::PushSubscription < ApplicationRecord\n \n   has_one :session_activation, foreign_key: 'web_push_subscription_id', inverse_of: :web_push_subscription, dependent: nil\n \n-  validates :endpoint, presence: true\n+  validates :endpoint, presence: true, url: true\n   validates :key_p256dh, presence: true\n   validates :key_auth, presence: true\n \n---\nspec/requests/api/v1/push/subscriptions_spec.rb\n@@ -4,10 +4,11 @@\n \n describe 'API V1 Push Subscriptions' do\n   let(:user) { Fabricate(:user) }\n+  let(:endpoint) { 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX' }\n   let(:create_payload) do\n     {\n       subscription: {\n-        endpoint: 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX',\n+        endpoint: endpoint,\n         keys: {\n           p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n           auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n@@ -63,6 +64,18 @@\n       expect(endpoint_push_subscriptions.count)\n         .to eq(1)\n     end\n+\n+    context 'with invalid endpoint URL' do\n+      let(:endpoint) { 'app://example.foo' }\n+\n+      it 'returns a validation error' do\n+        subject\n+\n+        expect(response).to have_http_status(422)\n+        expect(endpoint_push_subscriptions.count).to eq(0)\n+        expect(endpoint_push_subscription).to be_nil\n+      end\n+    end\n   end\n \n   describe 'PUT /api/v1/push/subscription' do\n---\napp/models/web/push_subscription.rb\n@@ -25,6 +25,8 @@ class Web::PushSubscription < ApplicationRecord\n   validates :key_p256dh, presence: true\n   validates :key_auth, presence: true\n \n+  validates_with WebPushKeyValidator\n+\n   delegate :locale, to: :associated_user\n \n   def encrypt(payload)\n---\napp/validators/web_push_key_validator.rb\n@@ -0,0 +1,11 @@\n+# frozen_string_literal: true\n+\n+class WebPushKeyValidator < ActiveModel::Validator\n+  def validate(subscription)\n+    begin\n+      Webpush::Encryption.encrypt('validation_test', subscription.key_p256dh, subscription.key_auth)\n+    rescue ArgumentError, OpenSSL::PKey::EC::Point::Error\n+      subscription.errors.add(:base, I18n.t('crypto.errors.invalid_key'))\n+    end\n+  end\n+end\n---\nspec/fabricators/web_push_subscription_fabricator.rb\n@@ -2,6 +2,10 @@\n \n Fabricator(:web_push_subscription, from: Web::PushSubscription) do\n   endpoint   Faker::Internet.url\n-  key_p256dh Faker::Internet.password\n-  key_auth   Faker::Internet.password\n+  key_p256dh do\n+    curve = OpenSSL::PKey::EC.generate('prime256v1')\n+    ecdh_key = curve.public_key.to_bn.to_s(2)\n+    Base64.urlsafe_encode64(ecdh_key)\n+  end\n+  key_auth { Base64.urlsafe_encode64(Random.new.bytes(16)) }\n end\n---\nspec/requests/api/v1/push/subscriptions_spec.rb\n@@ -5,14 +5,17 @@\n describe 'API V1 Push Subscriptions' do\n   let(:user) { Fabricate(:user) }\n   let(:endpoint) { 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX' }\n+  let(:keys) do\n+    {\n+      p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n+      auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+    }\n+  end\n   let(:create_payload) do\n     {\n       subscription: {\n         endpoint: endpoint,\n-        keys: {\n-          p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n-          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n-        },\n+        keys: keys,\n       },\n     }.with_indifferent_access\n   end\n@@ -37,6 +40,16 @@\n   let(:token) { Fabricate(:accessible_access_token, resource_owner_id: user.id, scopes: scopes) }\n   let(:headers) { { 'Authorization' => \"Bearer #{token.token}\" } }\n \n+  shared_examples 'validation error' do\n+    it 'returns a validation error' do\n+      subject\n+\n+      expect(response).to have_http_status(422)\n+      expect(endpoint_push_subscriptions.count).to eq(0)\n+      expect(endpoint_push_subscription).to be_nil\n+    end\n+  end\n+\n   describe 'POST /api/v1/push/subscription' do\n     subject { post '/api/v1/push/subscription', params: create_payload, headers: headers }\n \n@@ -68,13 +81,29 @@\n     context 'with invalid endpoint URL' do\n       let(:endpoint) { 'app://example.foo' }\n \n-      it 'returns a validation error' do\n-        subject\n+      it_behaves_like 'validation error'\n+    end\n+\n+    context 'with invalid p256dh key' do\n+      let(:keys) do\n+        {\n+          p256dh: 'BEm_invalidf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n+          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+        }\n+      end\n \n-        expect(response).to have_http_status(422)\n-        expect(endpoint_push_subscriptions.count).to eq(0)\n-        expect(endpoint_push_subscription).to be_nil\n+      it_behaves_like 'validation error'\n+    end\n+\n+    context 'with invalid base64 p256dh key' do\n+      let(:keys) do\n+        {\n+          p256dh: 'not base64',\n+          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+        }\n       end\n+\n+      it_behaves_like 'validation error'\n     end\n   end\n \n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -284,6 +284,7 @@\n   font-size: 11px;\n   padding: 0 3px;\n   line-height: 27px;\n+  white-space: nowrap;\n \n   &:hover,\n   &:active,\n---\n\n\n---\n\nChoice C:\napp/services/fetch_link_card_service.rb\n@@ -106,12 +106,11 @@ def skip_link?(anchor)\n   end\n \n   def attempt_oembed\n-    service         = FetchOEmbedService.new\n-    url_domain      = Addressable::URI.parse(@url).normalized_host\n-    cached_endpoint = Rails.cache.read(\"oembed_endpoint:#{url_domain}\")\n+    service = FetchOEmbedService.new\n \n-    embed   = service.call(@url, cached_endpoint: cached_endpoint) unless cached_endpoint.nil?\n+    embed   = service.call(@url, use_cached_endpoint: true)\n     embed ||= service.call(@url, html: html) unless html.nil?\n+    embed ||= service.call(@url, use_cached_endpoint: true) if @url != @original_url.to_s\n \n     return false if embed.nil?\n \n---\napp/services/fetch_oembed_service.rb\n@@ -10,7 +10,7 @@ def call(url, options = {})\n     @url     = url\n     @options = options\n \n-    if @options[:cached_endpoint]\n+    if @options[:use_cached_endpoint]\n       parse_cached_endpoint!\n     else\n       discover_endpoint!\n@@ -57,9 +57,9 @@ def discover_endpoint!\n   end\n \n   def parse_cached_endpoint!\n-    cached = @options[:cached_endpoint]\n+    cached = Rails.cache.read(cache_key)\n \n-    return if cached[:endpoint].nil? || cached[:format].nil?\n+    return if cached.nil? || cached[:endpoint].nil? || cached[:format].nil?\n \n     @endpoint_url = Addressable::Template.new(cached[:endpoint]).expand(url: @url).to_s\n     @format       = cached[:format]\n@@ -68,14 +68,16 @@ def parse_cached_endpoint!\n   def cache_endpoint!\n     return unless URL_REGEX.match?(@endpoint_url)\n \n-    url_domain = Addressable::URI.parse(@url).normalized_host\n-\n     endpoint_hash = {\n       endpoint: @endpoint_url.gsub(URL_REGEX, '={url}'),\n       format: @format,\n     }\n \n-    Rails.cache.write(\"oembed_endpoint:#{url_domain}\", endpoint_hash, expires_in: ENDPOINT_CACHE_EXPIRES_IN)\n+    Rails.cache.write(cache_key, endpoint_hash, expires_in: ENDPOINT_CACHE_EXPIRES_IN)\n+  end\n+\n+  def cache_key\n+    \"oembed_endpoint:#{Addressable::URI.parse(@url).normalized_host}\"\n   end\n \n   def fetch!\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -13,6 +13,7 @@\n     stub_request(:get, 'http://example.com/not-found').to_return(status: 404, headers: { 'Content-Type' => 'text/html' }, body: html)\n     stub_request(:get, 'http://example.com/text').to_return(status: 404, headers: { 'Content-Type' => 'text/plain' }, body: 'Hello')\n     stub_request(:get, 'http://example.com/redirect').to_return(status: 302, headers: { 'Location' => 'http://example.com/html' })\n+    stub_request(:get, 'http://example.net/redirect-to-other-domain').to_return(status: 302, headers: { 'Location' => 'http://example.com/html' })\n     stub_request(:get, 'http://example.com/redirect-to-404').to_return(status: 302, headers: { 'Location' => 'http://example.com/not-found' })\n     stub_request(:get, 'http://example.com/oembed?url=http://example.com/html').to_return(headers: { 'Content-Type' => 'application/json' }, body: '{ \"version\": \"1.0\", \"type\": \"link\", \"title\": \"oEmbed title\" }')\n     stub_request(:get, 'http://example.com/oembed?format=json&url=http://example.com/html').to_return(headers: { 'Content-Type' => 'application/json' }, body: '{ \"version\": \"1.0\", \"type\": \"link\", \"title\": \"oEmbed title\" }')\n@@ -264,6 +265,39 @@\n         end\n       end\n \n+      context 'when oEmbed endpoint cache populated with redirect target' do\n+        let(:status) { Fabricate(:status, text: 'http://example.net/redirect-to-other-domain') }\n+        let(:oembed_cache) { { endpoint: 'http://example.com/oembed?format=json&url={url}', format: :json } }\n+\n+        it 'uses the cached oEmbed response' do\n+          expect(a_request(:get, 'http://example.net/redirect-to-other-domain')).to have_been_made\n+          expect(a_request(:get, 'http://example.com/oembed?url=http://example.com/html')).to have_been_made\n+        end\n+\n+        it 'creates preview card' do\n+          expect(status.preview_card).to_not be_nil\n+          expect(status.preview_card.url).to eq 'http://example.com/html'\n+          expect(status.preview_card.title).to eq 'oEmbed title'\n+        end\n+      end\n+\n+      context 'when oEmbed endpoint cache populated with redirect target but page contains no oEmbed tags' do\n+        let(:status) { Fabricate(:status, text: 'http://example.net/redirect-to-other-domain') }\n+        let(:html) { 'Please fill out CAPTCHA' }\n+        let(:oembed_cache) { { endpoint: 'http://example.com/oembed?format=json&url={url}', format: :json } }\n+\n+        it 'uses the cached oEmbed response' do\n+          expect(a_request(:get, 'http://example.net/redirect-to-other-domain')).to have_been_made\n+          expect(a_request(:get, 'http://example.com/oembed?format=json&url=http://example.com/html')).to have_been_made\n+        end\n+\n+        it 'creates preview card' do\n+          expect(status.preview_card).to_not be_nil\n+          expect(status.preview_card.url).to eq 'http://example.com/html'\n+          expect(status.preview_card.title).to eq 'oEmbed title'\n+        end\n+      end\n+\n       # If the original HTML URL for whatever reason (e.g. DOS protection) redirects to\n       # an error page, we can still use the cached oEmbed but should not use the\n       # redirect URL on the card.\n---\nspec/services/fetch_oembed_service_spec.rb\n@@ -160,10 +160,12 @@\n           headers: { 'Content-Type': 'text/html' },\n           body: request_fixture('oembed_json_empty.html')\n         )\n+\n+        Rails.cache.write('oembed_endpoint:www.youtube.com', { endpoint: 'http://www.youtube.com/oembed?format=json&url={url}', format: :json })\n       end\n \n       it 'returns new provider without fetching original URL first' do\n-        subject.call('https://www.youtube.com/watch?v=dqwpQarrDwk', cached_endpoint: { endpoint: 'http://www.youtube.com/oembed?format=json&url={url}', format: :json })\n+        subject.call('https://www.youtube.com/watch?v=dqwpQarrDwk', use_cached_endpoint: true)\n         expect(a_request(:get, 'https://www.youtube.com/watch?v=dqwpQarrDwk')).to_not have_been_made\n         expect(subject.endpoint_url).to eq 'http://www.youtube.com/oembed?format=json&url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DdqwpQarrDwk'\n         expect(subject.format).to eq :json\n---\napp/lib/link_details_extractor.rb\n@@ -225,7 +225,7 @@ def host_to_url(str)\n   end\n \n   def valid_url_or_nil(str, same_origin_only: false)\n-    return if str.blank? || str == 'null'\n+    return if str.blank? || str == 'null' || str == 'undefined'\n \n     url = @original_url + Addressable::URI.parse(str)\n \n---\nspec/lib/link_details_extractor_spec.rb\n@@ -33,6 +33,14 @@\n         expect(subject.canonical_url).to eq original_url\n       end\n     end\n+\n+    context 'when canonical URL is set to \"undefined\"' do\n+      let(:url) { 'undefined' }\n+\n+      it 'ignores the canonical URLs' do\n+        expect(subject.canonical_url).to eq original_url\n+      end\n+    end\n   end\n \n   context 'when only basic metadata is present' do\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/actions/settings.js\n@@ -20,7 +20,7 @@ export function changeSetting(path, value) {\n }\n \n const debouncedSave = debounce((dispatch, getState) => {\n-  if (getState().getIn(['settings', 'saved'])) {\n+  if (getState().getIn(['settings', 'saved']) || !getState().getIn(['meta', 'me'])) {\n     return;\n   }\n \n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Use a server which supports marking up a status\r\n2. Add `<s>some no longer relevant text</s>`\r\n3. See status from mastodon\r\n...\r\n\n\n### Expected behaviour\n\nThe tagged text should appear with a strikethrough\n\n### Actual behaviour\n\nThe text appeared normally, as if tag was stripped\n\n### Detailed description\n\nThe original text within the `s` tag appears normally, the server seems to have stripped the tags.\r\n\r\n1. Original status: https://mediaformat.org/notes/922/\r\n2. How it should appear \r\n![IMG_2100](https://github.com/user-attachments/assets/112b22fd-19cd-4cdf-8acb-d7d52d5f32a2)\r\n\r\n3. How it actually appears on Mastodon\r\n![IMG_2099](https://github.com/user-attachments/assets/39020518-5e44-4b24-b5f4-71d8bceed610)\r\n\n\n### Mastodon instance\n\nsocial.coop\n\n### Mastodon version\n\nv4.2.10\n\n### Technical details\n\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: (from `ruby --version`, eg. v3.1.2)\r\n- Node.js version: (from `node --version`, eg. v18.16.0)\r\n\n\n---\n\nChoice A:\nlib/paperclip/response_with_limit_adapter.rb\n@@ -16,7 +16,7 @@ def initialize(target, options = {})\n     private\n \n     def cache_current_values\n-      @original_filename = filename_from_content_disposition.presence || filename_from_path.presence || 'data'\n+      @original_filename = truncated_filename\n       @tempfile = copy_to_tempfile(@target)\n       @content_type = ContentTypeDetector.new(@tempfile.path).detect\n       @size = File.size(@tempfile)\n@@ -43,6 +43,13 @@ def copy_to_tempfile(source)\n       source.response.connection.close\n     end\n \n+    def truncated_filename\n+      filename = filename_from_content_disposition.presence || filename_from_path.presence || 'data'\n+      extension = File.extname(filename)\n+      basename = File.basename(filename, extension)\n+      [basename[...20], extension[..4]].compact_blank.join\n+    end\n+\n     def filename_from_content_disposition\n       disposition = @target.response.headers['content-disposition']\n       disposition&.match(/filename=\"([^\"]*)\"/)&.captures&.first\n---\n\n\n---\n\nChoice B:\nlib/sanitize_ext/sanitize_config.rb\n@@ -65,7 +65,7 @@ module Config\n     end\n \n     MASTODON_STRICT = freeze_config(\n-      elements: %w(p br span a del pre blockquote code b strong u i em ul ol li ruby rt rp),\n+      elements: %w(p br span a del s pre blockquote code b strong u i em ul ol li ruby rt rp),\n \n       attributes: {\n         'a' => %w(href rel class translate),\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/actions/settings.js\n@@ -20,7 +20,7 @@ export function changeSetting(path, value) {\n }\n \n const debouncedSave = debounce((dispatch, getState) => {\n-  if (getState().getIn(['settings', 'saved'])) {\n+  if (getState().getIn(['settings', 'saved']) || !getState().getIn(['meta', 'me'])) {\n     return;\n   }\n \n---\n\n\n---\n\nChoice D:\napp/services/statuses_search_service.rb\n@@ -39,12 +39,12 @@ def convert_deprecated_options!\n     end\n \n     if @options[:min_id]\n-      timestamp = Mastodon::Snowflake.to_time(@options[:min_id])\n+      timestamp = Mastodon::Snowflake.to_time(@options[:min_id].to_i)\n       syntax_options << \"after:\\\"#{timestamp.iso8601}\\\"\"\n     end\n \n     if @options[:max_id]\n-      timestamp = Mastodon::Snowflake.to_time(@options[:max_id])\n+      timestamp = Mastodon::Snowflake.to_time(@options[:max_id].to_i)\n       syntax_options << \"before:\\\"#{timestamp.iso8601}\\\"\"\n     end\n \n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. [NodeBB] Create a new post and tag a user on a mastodon instance (in this case, it was @julian@bb.devnull.land to @devnull@crag.social)\r\n2. [Mastodon] Navigate to the sender's profile (https://crag.social/@julian@bb.devnull.land)\r\n3. [Mastodon] Note that the post has been correctly received, and contains a mention, but that your notification inbox remains empty\r\n\r\n### Expected behaviour\r\n\r\nI should have been notified due to the mention\r\n\r\n### Actual behaviour\r\n\r\nI was not notified\r\n\r\n### Detailed description\r\n\r\nAdditional details here: https://community.nodebb.org/topic/18210/mentions-and-notifications-over-the-fediverse\r\n\r\nHere is the full Note object containing two mentions, when queried via S2S API:\r\n\r\n```\r\n{\r\n\t\"@context\":\"https://www.w3.org/ns/activitystreams\",\r\n\t\"id\":\"https://bb.devnull.land/post/72\",\r\n\t\"type\":\"Note\",\r\n\t\"to\":[\r\n\t\t\"https://www.w3.org/ns/activitystreams#Public\",\r\n\t\t\"https://bb.devnull.land/uid/1\"\r\n\t],\r\n\t\"cc\":[\r\n\t\t\"https://bb.devnull.land/uid/1/followers\",\r\n\t\t\"https://crag.social/users/devnull\",\r\n\t\t\"https://activitypub.academy/users/babeta_zondaist\"\r\n\t],\r\n\t\"inReplyTo\":\"https://bb.devnull.land/post/71\",\r\n\t\"published\":\"2024-07-30T02:49:42.616Z\",\r\n\t\"url\":\"https://bb.devnull.land/post/72\",\r\n\t\"attributedTo\":\"https://bb.devnull.land/uid/1\",\r\n\t\"context\":\"https://bb.devnull.land/topic/38\",\r\n\t\"audience\":\"https://bb.devnull.land/category/-1\",\r\n\t\"sensitive\":false,\r\n\t\"summary\":null,\r\n\t\"name\":\"Re: Testing a notification\",\r\n\t\"content\":\"<p>no context or audience <a href=\\\"https://crag.social/@devnull\\\">@devnull@crag.social</a> <a href=\\\"https://activitypub.academy/@babeta_zondaist\\\">@babeta_zondaist@activitypub.academy</a></p> \",\r\n\t\"source\":{\r\n\t\t\"content\":\"no context or audience @devnull@crag.social @babeta_zondaist@activitypub.academy\",\r\n\t\t\"mediaType\":\"text/markdown\"\r\n\t},\r\n\t\"tag\":[\r\n\t\t{\r\n\t\t\t\"type\":\"Mention\",\r\n\t\t\t\"href\":\"https://crag.social/users/devnull\",\r\n\t\t\t\"name\":\"@devnull@crag.social\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"type\":\"Mention\",\r\n\t\t\t\"href\":\"https://activitypub.academy/users/babeta_zondaist\",\r\n\t\t\t\"name\":\"@babeta_zondaist@activitypub.academy\"\r\n\t\t}\r\n\t],\r\n\t\"attachment\":[\r\n\t],\r\n\t\"replies\":[\r\n\t]\r\n}\r\n```\r\n\r\n### Mastodon instance\r\n\r\ncrag.social, mastodon.social\r\n\r\n### Mastodon version\r\n\r\nv4.2.10\r\n\r\n### Technical details\r\n\r\n`crag.social` is hosted via masto.host, but @trwnh, who originally notified me of this issue, has an account on `mastodon.social`.\r\n\r\nI was directed to post an issue here by @renchap \n\n---\n\nChoice A:\ndb/post_migrate/20230811103651_remove_index_preview_cards_statuses_on_status_id_and_preview_card_id.rb\n@@ -0,0 +1,9 @@\n+# frozen_string_literal: true\n+\n+class RemoveIndexPreviewCardsStatusesOnStatusIdAndPreviewCardId < ActiveRecord::Migration[7.0]\n+  disable_ddl_transaction!\n+\n+  def change\n+    remove_index :preview_cards_statuses, column: [:status_id, :preview_card_id], name: :index_preview_cards_statuses_on_status_id_and_preview_card_id\n+  end\n+end\n---\ndb/schema.rb\n@@ -10,7 +10,7 @@\n #\n # It's strongly recommended that you check this file into your version control system.\n \n-ActiveRecord::Schema[7.0].define(version: 2023_08_03_112520) do\n+ActiveRecord::Schema[7.0].define(version: 2023_08_11_103651) do\n   # These are extensions that must be enabled in order to support this database\n   enable_extension \"plpgsql\"\n \n@@ -809,7 +809,6 @@\n   create_table \"preview_cards_statuses\", primary_key: [\"status_id\", \"preview_card_id\"], force: :cascade do |t|\n     t.bigint \"preview_card_id\", null: false\n     t.bigint \"status_id\", null: false\n-    t.index [\"status_id\", \"preview_card_id\"], name: \"index_preview_cards_statuses_on_status_id_and_preview_card_id\"\n   end\n \n   create_table \"relays\", force: :cascade do |t|\n---\n\n\n---\n\nChoice B:\napp/lib/activitypub/activity/create.rb\n@@ -336,13 +336,15 @@ def resolve_thread(status)\n \n   def fetch_replies(status)\n     collection = @object['replies']\n-    return if collection.nil?\n+    return if collection.blank?\n \n     replies = ActivityPub::FetchRepliesService.new.call(status, collection, allow_synchronous_requests: false, request_id: @options[:request_id])\n     return unless replies.nil?\n \n     uri = value_or_id(collection)\n     ActivityPub::FetchRepliesWorker.perform_async(status.id, uri, { 'request_id' => @options[:request_id] }) unless uri.nil?\n+  rescue => e\n+    Rails.logger.warn \"Error fetching replies: #{e}\"\n   end\n \n   def conversation_from_uri(uri)\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/explore/results.jsx\n@@ -156,45 +156,43 @@ class Results extends PureComponent {\n \n     let filteredResults;\n \n-    if (!isLoading) {\n-      const accounts = results.get('accounts', ImmutableList());\n-      const hashtags = results.get('hashtags', ImmutableList());\n-      const statuses = results.get('statuses', ImmutableList());\n-\n-      switch(type) {\n-      case 'all':\n-        filteredResults = (accounts.size + hashtags.size + statuses.size) > 0 ? (\n-          <>\n-            {accounts.size > 0 && (\n-              <SearchSection key='accounts' title={<><Icon id='users' fixedWidth /><FormattedMessage id='search_results.accounts' defaultMessage='Profiles' /></>} onClickMore={this.handleLoadMoreAccounts}>\n-                {accounts.take(INITIAL_DISPLAY).map(id => <Account key={id} id={id} />)}\n-              </SearchSection>\n-            )}\n-\n-            {hashtags.size > 0 && (\n-              <SearchSection key='hashtags' title={<><Icon id='hashtag' fixedWidth /><FormattedMessage id='search_results.hashtags' defaultMessage='Hashtags' /></>} onClickMore={this.handleLoadMoreHashtags}>\n-                {hashtags.take(INITIAL_DISPLAY).map(hashtag => <Hashtag key={hashtag.get('name')} hashtag={hashtag} />)}\n-              </SearchSection>\n-            )}\n-\n-            {statuses.size > 0 && (\n-              <SearchSection key='statuses' title={<><Icon id='quote-right' fixedWidth /><FormattedMessage id='search_results.statuses' defaultMessage='Posts' /></>} onClickMore={this.handleLoadMoreStatuses}>\n-                {statuses.take(INITIAL_DISPLAY).map(id => <Status key={id} id={id} />)}\n-              </SearchSection>\n-            )}\n-          </>\n-        ) : [];\n-        break;\n-      case 'accounts':\n-        filteredResults = renderAccounts(accounts);\n-        break;\n-      case 'hashtags':\n-        filteredResults = renderHashtags(hashtags);\n-        break;\n-      case 'statuses':\n-        filteredResults = renderStatuses(statuses);\n-        break;\n-      }\n+    const accounts = results.get('accounts', ImmutableList());\n+    const hashtags = results.get('hashtags', ImmutableList());\n+    const statuses = results.get('statuses', ImmutableList());\n+\n+    switch(type) {\n+    case 'all':\n+      filteredResults = (accounts.size + hashtags.size + statuses.size) > 0 ? (\n+        <>\n+          {accounts.size > 0 && (\n+            <SearchSection key='accounts' title={<><Icon id='users' fixedWidth /><FormattedMessage id='search_results.accounts' defaultMessage='Profiles' /></>} onClickMore={this.handleLoadMoreAccounts}>\n+              {accounts.take(INITIAL_DISPLAY).map(id => <Account key={id} id={id} />)}\n+            </SearchSection>\n+          )}\n+\n+          {hashtags.size > 0 && (\n+            <SearchSection key='hashtags' title={<><Icon id='hashtag' fixedWidth /><FormattedMessage id='search_results.hashtags' defaultMessage='Hashtags' /></>} onClickMore={this.handleLoadMoreHashtags}>\n+              {hashtags.take(INITIAL_DISPLAY).map(hashtag => <Hashtag key={hashtag.get('name')} hashtag={hashtag} />)}\n+            </SearchSection>\n+          )}\n+\n+          {statuses.size > 0 && (\n+            <SearchSection key='statuses' title={<><Icon id='quote-right' fixedWidth /><FormattedMessage id='search_results.statuses' defaultMessage='Posts' /></>} onClickMore={this.handleLoadMoreStatuses}>\n+              {statuses.take(INITIAL_DISPLAY).map(id => <Status key={id} id={id} />)}\n+            </SearchSection>\n+          )}\n+        </>\n+      ) : [];\n+      break;\n+    case 'accounts':\n+      filteredResults = renderAccounts(accounts);\n+      break;\n+    case 'hashtags':\n+      filteredResults = renderHashtags(hashtags);\n+      break;\n+    case 'statuses':\n+      filteredResults = renderStatuses(statuses);\n+      break;\n     }\n \n     return (\n---\n\n\n---\n\nChoice D:\napp/lib/link_details_extractor.rb\n@@ -156,7 +156,7 @@ def height\n   end\n \n   def title\n-    html_entities.decode(structured_data&.headline || opengraph_tag('og:title') || document.xpath('//title').map(&:content).first)\n+    html_entities.decode(structured_data&.headline || opengraph_tag('og:title') || document.xpath('//title').map(&:content).first).strip\n   end\n \n   def description\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Create a dev environment using Vagrant, per [Setting up a dev environment](https://docs.joinmastodon.org/dev/setup/)\r\n2. Execute the `rspec` tests (`vagrant ssh -c \"cd /vagrant && rspec\"`)\r\n3. Observe errors in output\n\n### Expected behaviour\n\nRspec tests run without runtime errors from the test framework itself\n\n### Actual behaviour\n\nRspec fails with an error bubbled up from the email_spec dependency\n\n### Detailed description\n\nI have provided an output example below executing a single test for brevity, but the error occurs when running the full test suite as well. I have not reproduced in a non-Vagrant dev environment but nothing about this scenario seems specific to Vagrant.\r\n\r\n```\r\nmastodon>vagrant ssh -c \"cd /vagrant && rspec ./spec/routing/accounts_routing_spec.rb:9\"\r\nResolving dependencies...\r\n[dotenv] Set ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY, ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT, and ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY\r\n[dotenv] Loaded .env.development\r\n\r\nAn error occurred while loading ./spec/routing/accounts_routing_spec.rb.\r\nFailure/Error: require 'email_spec/rspec'\r\n\r\nNameError:\r\n  uninitialized constant EmailSpec\r\n# /usr/share/rvm/gems/ruby-3.3.4@mastodon/gems/email_spec-2.3.0/lib/email_spec/rspec.rb:2:in `block in <top (required)>'\r\n# /usr/share/rvm/gems/ruby-3.3.4@mastodon/gems/email_spec-2.3.0/lib/email_spec/rspec.rb:1:in `<top (required)>'\r\n# /usr/share/rvm/gems/ruby-3.3.4@mastodon/gems/bootsnap-1.18.3/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\n# /usr/share/rvm/gems/ruby-3.3.4@mastodon/gems/zeitwerk-2.6.16/lib/zeitwerk/kernel.rb:34:in `require'\r\n# ./spec/rails_helper.rb:44:in `<top (required)>'\r\n# ./spec/routing/accounts_routing_spec.rb:3:in `<top (required)>'\r\nRun options: include {:locations=>{\"./spec/routing/accounts_routing_spec.rb\"=>[9]}}\r\n\r\nAll examples were filtered out\r\n 0/0 |============================================ 100 ============================================>| Time: 00:00:00\r\n\r\nFinished in 0.00042 seconds (files took 6.25 seconds to load)\r\n0 examples, 0 failures, 1 error occurred outside of examples\r\nCoverage report generated for RSpec to /vagrant/coverage. 1156 / 41014 LOC (2.82%) covered.\r\nStopped processing SimpleCov as a previous error not related to SimpleCov has been detected\r\n```\n\n### Mastodon instance\n\nlocal\n\n### Mastodon version\n\nmain\n\n### Technical details\n\nHappening in local development environment (Vagrant)\n\n---\n\nChoice A:\napp/javascript/mastodon/features/getting_started/index.jsx\n@@ -11,6 +11,7 @@ import { connect } from 'react-redux';\n \n import AlternateEmailIcon from '@/material-icons/400-24px/alternate_email.svg?react';\n import BookmarksIcon from '@/material-icons/400-24px/bookmarks-fill.svg?react';\n+import ExploreIcon from '@/material-icons/400-24px/explore.svg?react';\n import PeopleIcon from '@/material-icons/400-24px/group.svg?react';\n import HomeIcon from '@/material-icons/400-24px/home-fill.svg?react';\n import ListAltIcon from '@/material-icons/400-24px/list_alt.svg?react';\n@@ -19,7 +20,6 @@ import PersonAddIcon from '@/material-icons/400-24px/person_add.svg?react';\n import PublicIcon from '@/material-icons/400-24px/public.svg?react';\n import SettingsIcon from '@/material-icons/400-24px/settings-fill.svg?react';\n import StarIcon from '@/material-icons/400-24px/star.svg?react';\n-import TagIcon from '@/material-icons/400-24px/tag.svg?react';\n import { fetchFollowRequests } from 'mastodon/actions/accounts';\n import Column from 'mastodon/components/column';\n import ColumnHeader from 'mastodon/components/column_header';\n@@ -112,7 +112,7 @@ class GettingStarted extends ImmutablePureComponent {\n \n     if (showTrends) {\n       navItems.push(\n-        <ColumnLink key='explore' icon='explore' iconComponent={TagIcon} text={intl.formatMessage(messages.explore)} to='/explore' />,\n+        <ColumnLink key='explore' icon='explore' iconComponent={ExploreIcon} text={intl.formatMessage(messages.explore)} to='/explore' />,\n       );\n     }\n \n---\n\n\n---\n\nChoice B:\napp/models/account_pin.rb\n@@ -5,10 +5,10 @@\n # Table name: account_pins\n #\n #  id                :bigint(8)        not null, primary key\n-#  account_id        :bigint(8)\n-#  target_account_id :bigint(8)\n #  created_at        :datetime         not null\n #  updated_at        :datetime         not null\n+#  account_id        :bigint(8)        not null\n+#  target_account_id :bigint(8)        not null\n #\n \n class AccountPin < ApplicationRecord\n---\ndb/migrate/20241210140838_add_not_null_to_account_pin_account_columns.rb\n@@ -0,0 +1,23 @@\n+# frozen_string_literal: true\n+\n+class AddNotNullToAccountPinAccountColumns < ActiveRecord::Migration[7.2]\n+  def up\n+    connection.execute(<<~SQL.squish)\n+      DELETE FROM account_pins\n+      WHERE account_id IS NULL\n+      OR target_account_id IS NULL\n+    SQL\n+\n+    safety_assured do\n+      change_column_null :account_pins, :account_id, false\n+      change_column_null :account_pins, :target_account_id, false\n+    end\n+  end\n+\n+  def down\n+    safety_assured do\n+      change_column_null :account_pins, :account_id, true\n+      change_column_null :account_pins, :target_account_id, true\n+    end\n+  end\n+end\n---\ndb/schema.rb\n@@ -10,7 +10,7 @@\n #\n # It's strongly recommended that you check this file into your version control system.\n \n-ActiveRecord::Schema[7.2].define(version: 2024_12_05_163118) do\n+ActiveRecord::Schema[7.2].define(version: 2024_12_10_140838) do\n   # These are extensions that must be enabled in order to support this database\n   enable_extension \"plpgsql\"\n \n@@ -82,8 +82,8 @@\n   end\n \n   create_table \"account_pins\", force: :cascade do |t|\n-    t.bigint \"account_id\"\n-    t.bigint \"target_account_id\"\n+    t.bigint \"account_id\", null: false\n+    t.bigint \"target_account_id\", null: false\n     t.datetime \"created_at\", precision: nil, null: false\n     t.datetime \"updated_at\", precision: nil, null: false\n     t.index [\"account_id\", \"target_account_id\"], name: \"index_account_pins_on_account_id_and_target_account_id\", unique: true\n---\n\n\n---\n\nChoice C:\napp/models/custom_emoji.rb\n@@ -39,7 +39,7 @@ class CustomEmoji < ApplicationRecord\n \n   has_one :local_counterpart, -> { where(domain: nil) }, class_name: 'CustomEmoji', primary_key: :shortcode, foreign_key: :shortcode, inverse_of: false, dependent: nil\n \n-  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' } }, validate_media_type: false\n+  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp', file_geometry_parser: FastGeometryParser } }, validate_media_type: false, processors: [:lazy_thumbnail]\n \n   normalizes :domain, with: ->(domain) { domain.downcase }\n \n---\nspec/models/custom_emoji_spec.rb\n@@ -2,7 +2,7 @@\n \n require 'rails_helper'\n \n-RSpec.describe CustomEmoji do\n+RSpec.describe CustomEmoji, :paperclip_processing do\n   describe '#search' do\n     subject { described_class.search(search_term) }\n \n---\n\n\n---\n\nChoice D:\nspec/rails_helper.rb\n@@ -37,11 +37,14 @@\n \n require 'spec_helper'\n require 'rspec/rails'\n+require 'rspec-sidekiq'\n require 'webmock/rspec'\n require 'paperclip/matchers'\n require 'capybara/rspec'\n require 'chewy/rspec'\n+require 'email_spec'\n require 'email_spec/rspec'\n+require 'database_cleaner/active_record'\n require 'test_prof/recipes/rspec/before_all'\n \n Dir[Rails.root.join('spec', 'support', '**', '*.rb')].each { |f| require f }\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Export a user's archive\r\n2. Download & extract the archive\r\n3. Look at outbox.json\r\n4. There's two \"orderedItems\" keys!\r\n![image](https://github.com/user-attachments/assets/eb69d63e-eb76-462e-a0f1-69b4600337ca)\r\n\r\n(originally [reported on glitch-soc](https://github.com/glitch-soc/mastodon/issues/2787) but was told that it's also happening upstream)\n\n### Expected behaviour\n\nThere should only be one \"orderedItems\" key\n\n### Actual behaviour\n\nThere were two \"orderedItems\" keys, one of which was a blank array\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\nv4.3.0-alpha.5+glitch\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/services/statuses_search_service.rb\n@@ -39,12 +39,12 @@ def convert_deprecated_options!\n     end\n \n     if @options[:min_id]\n-      timestamp = Mastodon::Snowflake.to_time(@options[:min_id])\n+      timestamp = Mastodon::Snowflake.to_time(@options[:min_id].to_i)\n       syntax_options << \"after:\\\"#{timestamp.iso8601}\\\"\"\n     end\n \n     if @options[:max_id]\n-      timestamp = Mastodon::Snowflake.to_time(@options[:max_id])\n+      timestamp = Mastodon::Snowflake.to_time(@options[:max_id].to_i)\n       syntax_options << \"before:\\\"#{timestamp.iso8601}\\\"\"\n     end\n \n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -2732,22 +2732,16 @@ $ui-header-height: 55px;\n     &__description {\n       flex: 1 1 auto;\n       line-height: 20px;\n-      white-space: nowrap;\n-      text-overflow: ellipsis;\n-      overflow: hidden;\n \n       h6 {\n         color: $highlight-text-color;\n         font-weight: 500;\n         font-size: 14px;\n-        overflow: hidden;\n-        text-overflow: ellipsis;\n       }\n \n       p {\n         color: $darker-text-color;\n         overflow: hidden;\n-        text-overflow: ellipsis;\n       }\n     }\n   }\n---\n\n\n---\n\nChoice C:\napp/lib/activitypub/adapter.rb\n@@ -20,6 +20,6 @@ def serializable_hash(options = nil)\n     serialized_hash = serialized_hash.select { |k, _| options[:fields].include?(k) } if options[:fields]\n     serialized_hash = self.class.transform_key_casing!(serialized_hash, instance_options)\n \n-    { '@context' => serialized_context(named_contexts, context_extensions) }.merge(serialized_hash)\n+    { '@context': serialized_context(named_contexts, context_extensions) }.merge(serialized_hash)\n   end\n end\n---\napp/services/backup_service.rb\n@@ -19,8 +19,8 @@ def call(backup)\n \n   def build_outbox_json!(file)\n     skeleton = serialize(collection_presenter, ActivityPub::CollectionSerializer)\n-    skeleton['@context'] = full_context\n-    skeleton['orderedItems'] = ['!PLACEHOLDER!']\n+    skeleton[:@context] = full_context\n+    skeleton[:orderedItems] = ['!PLACEHOLDER!']\n     skeleton = Oj.dump(skeleton)\n     prepend, append = skeleton.split('\"!PLACEHOLDER!\"')\n     add_comma = false\n@@ -33,7 +33,7 @@ def build_outbox_json!(file)\n \n       file.write(statuses.map do |status|\n         item = serialize_payload(ActivityPub::ActivityPresenter.from_status(status), ActivityPub::ActivitySerializer)\n-        item.delete('@context')\n+        item.delete(:@context)\n \n         unless item[:type] == 'Announce' || item[:object][:attachment].blank?\n           item[:object][:attachment].each do |attachment|\n---\nspec/lib/activitypub/adapter_spec.rb\n@@ -59,39 +59,39 @@ def virtual_object\n       let(:serializer_class) { TestWithBasicContextSerializer }\n \n       it 'renders a basic @context' do\n-        expect(subject).to include({ '@context' => 'https://www.w3.org/ns/activitystreams' })\n+        expect(subject).to include({ '@context': 'https://www.w3.org/ns/activitystreams' })\n       end\n     end\n \n     context 'when serializer defines a named context' do\n       let(:serializer_class) { TestWithNamedContextSerializer }\n \n       it 'renders a @context with both items' do\n-        expect(subject).to include({ '@context' => ['https://www.w3.org/ns/activitystreams', 'https://w3id.org/security/v1'] })\n+        expect(subject).to include({ '@context': ['https://www.w3.org/ns/activitystreams', 'https://w3id.org/security/v1'] })\n       end\n     end\n \n     context 'when serializer has children that define a named context' do\n       let(:serializer_class) { TestWithNestedNamedContextSerializer }\n \n       it 'renders a @context with both items' do\n-        expect(subject).to include({ '@context' => ['https://www.w3.org/ns/activitystreams', 'https://w3id.org/security/v1'] })\n+        expect(subject).to include({ '@context': ['https://www.w3.org/ns/activitystreams', 'https://w3id.org/security/v1'] })\n       end\n     end\n \n     context 'when serializer defines context extensions' do\n       let(:serializer_class) { TestWithContextExtensionSerializer }\n \n       it 'renders a @context with the extension' do\n-        expect(subject).to include({ '@context' => ['https://www.w3.org/ns/activitystreams', { 'sensitive' => 'as:sensitive' }] })\n+        expect(subject).to include({ '@context': ['https://www.w3.org/ns/activitystreams', { 'sensitive' => 'as:sensitive' }] })\n       end\n     end\n \n     context 'when serializer has children that define context extensions' do\n       let(:serializer_class) { TestWithNestedContextExtensionSerializer }\n \n       it 'renders a @context with both extensions' do\n-        expect(subject).to include({ '@context' => ['https://www.w3.org/ns/activitystreams', { 'manuallyApprovesFollowers' => 'as:manuallyApprovesFollowers', 'sensitive' => 'as:sensitive' }] })\n+        expect(subject).to include({ '@context': ['https://www.w3.org/ns/activitystreams', { 'manuallyApprovesFollowers' => 'as:manuallyApprovesFollowers', 'sensitive' => 'as:sensitive' }] })\n       end\n     end\n   end\n---\nspec/services/backup_service_spec.rb\n@@ -60,6 +60,7 @@ def expect_outbox_export\n \n     aggregate_failures do\n       expect(body.scan('@context').count).to eq 1\n+      expect(body.scan('orderedItems').count).to eq 1\n       expect(json['@context']).to_not be_nil\n       expect(json['type']).to eq 'OrderedCollection'\n       expect(json['totalItems']).to eq 2\n---\n\n\n---\n\nChoice D:\nlib/paperclip/response_with_limit_adapter.rb\n@@ -16,7 +16,7 @@ def initialize(target, options = {})\n     private\n \n     def cache_current_values\n-      @original_filename = filename_from_content_disposition.presence || filename_from_path.presence || 'data'\n+      @original_filename = truncated_filename\n       @tempfile = copy_to_tempfile(@target)\n       @content_type = ContentTypeDetector.new(@tempfile.path).detect\n       @size = File.size(@tempfile)\n@@ -43,6 +43,13 @@ def copy_to_tempfile(source)\n       source.response.connection.close\n     end\n \n+    def truncated_filename\n+      filename = filename_from_content_disposition.presence || filename_from_path.presence || 'data'\n+      extension = File.extname(filename)\n+      basename = File.basename(filename, extension)\n+      [basename[...20], extension[..4]].compact_blank.join\n+    end\n+\n     def filename_from_content_disposition\n       disposition = @target.response.headers['content-disposition']\n       disposition&.match(/filename=\"([^\"]*)\"/)&.captures&.first\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Write a post with the following content and send it\r\n\r\n`Gem\u00e4\u00df @Gargron@mastodon.social`\n\n### Expected behaviour\n\nThe handle is rendered with a link to the profile: Gem\u00e4\u00df @Gargron\n\n### Actual behaviour\n\nThe handle is rendered as plaintext: Gem\u00e4\u00df @Gargron@mastodon.social\n\n### Detailed description\n\nApparently when a handle is mentioned after a \"\u00df\" (sharp s) character it is always rendered as plaintext.\r\n\r\nPlease find the following post where it was first observed:\r\nhttps://nrw.social/@melsdung/112784007422571926\r\n\r\nThe issue could also be reproduced with the 3rd party app \"Tusky\" using mastodon.online.\n\n### Mastodon instance\n\nmastodon.online and nrw.social\n\n### Mastodon version\n\nv4.2.10 (nrw.social) and v4.3.0-nightly.2024-07-11 (mastodon.online)\n\n### Technical details\n\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: (from `ruby --version`, eg. v3.1.2)\r\n- Node.js version: (from `node --version`, eg. v18.16.0)\r\n\n\n---\n\nChoice A:\napp/javascript/mastodon/features/home_timeline/components/inline_follow_suggestions.jsx\n@@ -129,8 +129,13 @@ export const InlineFollowSuggestions = ({ hidden }) => {\n       return;\n     }\n \n-    setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n-    setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    if (getComputedStyle(bodyRef.current).direction === 'rtl') {\n+      setCanScrollLeft((bodyRef.current.clientWidth - bodyRef.current.scrollLeft) < bodyRef.current.scrollWidth);\n+      setCanScrollRight(bodyRef.current.scrollLeft < 0);\n+    } else {\n+      setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n+      setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    }\n   }, [setCanScrollRight, setCanScrollLeft, bodyRef, suggestions]);\n \n   const handleLeftNav = useCallback(() => {\n---\n\n\n---\n\nChoice B:\nconfig/routes.rb\n@@ -3,6 +3,18 @@\n require 'sidekiq_unique_jobs/web'\n require 'sidekiq-scheduler/web'\n \n+class RedirectWithVary < ActionDispatch::Routing::PathRedirect\n+  def serve(...)\n+    super.tap do |_, headers, _|\n+      headers['Vary'] = 'Origin, Accept'\n+    end\n+  end\n+end\n+\n+def redirect_with_vary(path)\n+  RedirectWithVary.new(301, path)\n+end\n+\n Rails.application.routes.draw do\n   # Paths of routes on the web app that to not require to be indexed or\n   # have alternative format representations requiring separate controllers\n@@ -90,10 +102,13 @@\n     confirmations:      'auth/confirmations',\n   }\n \n-  get '/users/:username', to: redirect('/@%{username}'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n-  get '/users/:username/following', to: redirect('/@%{username}/following'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n-  get '/users/:username/followers', to: redirect('/@%{username}/followers'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n-  get '/users/:username/statuses/:id', to: redirect('/@%{username}/%{id}'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  # rubocop:disable Style/FormatStringToken - those do not go through the usual formatting functions and are not safe to correct\n+  get '/users/:username', to: redirect_with_vary('/@%{username}'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  get '/users/:username/following', to: redirect_with_vary('/@%{username}/following'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  get '/users/:username/followers', to: redirect_with_vary('/@%{username}/followers'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  get '/users/:username/statuses/:id', to: redirect_with_vary('/@%{username}/%{id}'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  # rubocop:enable Style/FormatStringToken\n+\n   get '/authorize_follow', to: redirect { |_, request| \"/authorize_interaction?#{request.params.to_query}\" }\n \n   resources :accounts, path: 'users', only: [:show], param: :username do\n---\nspec/requests/cache_spec.rb\n@@ -124,7 +124,7 @@ module DisabledAnonymousAPI\n       expect(response.cookies).to be_empty\n     end\n \n-    it 'sets public cache control' do\n+    it 'sets public cache control', :aggregate_failures do\n       # expect(response.cache_control[:max_age]&.to_i).to be_positive\n       expect(response.cache_control[:public]).to be_truthy\n       expect(response.cache_control[:private]).to be_falsy\n@@ -141,11 +141,8 @@ module DisabledAnonymousAPI\n   end\n \n   shared_examples 'non-cacheable error' do\n-    it 'does not return HTTP success' do\n+    it 'does not return HTTP success and does not have cache headers', :aggregate_failures do\n       expect(response).to_not have_http_status(200)\n-    end\n-\n-    it 'does not have cache headers' do\n       expect(response.cache_control[:public]).to be_falsy\n     end\n   end\n@@ -182,6 +179,15 @@ module DisabledAnonymousAPI\n   end\n \n   context 'when anonymously accessed' do\n+    describe '/users/alice' do\n+      it 'redirects with proper cache header', :aggregate_failures do\n+        get '/users/alice'\n+\n+        expect(response).to redirect_to('/@alice')\n+        expect(response.headers['Vary']&.split(',')&.map { |x| x.strip.downcase }).to include('accept')\n+      end\n+    end\n+\n     TestEndpoints::ALWAYS_CACHED.each do |endpoint|\n       describe endpoint do\n         before { get endpoint }\n---\n\n\n---\n\nChoice C:\nbabel.config.js\n@@ -52,6 +52,10 @@ module.exports = (api) => {\n   case 'development':\n     reactOptions.development = true;\n     envOptions.debug = true;\n+\n+    // We need Babel to not inject polyfills in dev, as this breaks `preval` files\n+    envOptions.useBuiltIns = false;\n+    envOptions.corejs = undefined;\n     break;\n   }\n \n---\n\n\n---\n\nChoice D:\napp/models/account.rb\n@@ -68,7 +68,7 @@ class Account < ApplicationRecord\n   INSTANCE_ACTOR_ID = -99\n \n   USERNAME_RE   = /[a-z0-9_]+([a-z0-9_.-]+[a-z0-9_]+)?/i\n-  MENTION_RE    = %r{(?<![=/[:word:]])@((#{USERNAME_RE})(?:@[[:word:].-]+[[:word:]]+)?)}i\n+  MENTION_RE    = %r{(?<![=/[:word:]])@((#{USERNAME_RE})(?:@[[:word:].-]+[[:word:]]+)?)}\n   URL_PREFIX_RE = %r{\\Ahttp(s?)://[^/]+}\n   USERNAME_ONLY_RE = /\\A#{USERNAME_RE}\\z/i\n   USERNAME_LENGTH_LIMIT = 30\n---\napp/models/tag.rb\n@@ -37,7 +37,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]\\u0E47-\\u0E4E#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/account_spec.rb\n@@ -711,6 +711,14 @@\n     it 'does not match URL query string' do\n       expect(subject.match('https://example.com/?x=@alice')).to be_nil\n     end\n+\n+    it 'matches usernames immediately following the letter \u00df' do\n+      expect(subject.match('Hello to\u00df @alice from me')[1]).to eq 'alice'\n+    end\n+\n+    it 'matches usernames containing uppercase characters' do\n+      expect(subject.match('Hello to @aLice@Example.com from me')[1]).to eq 'aLice@Example.com'\n+    end\n   end\n \n   describe 'validations' do\n---\nspec/models/tag_spec.rb\n@@ -95,6 +95,14 @@\n     it 'does not match purely-numeric hashtags' do\n       expect(subject.match('hello #0123456')).to be_nil\n     end\n+\n+    it 'matches hashtags immediately following the letter \u00df' do\n+      expect(subject.match('Hello to\u00df #ruby').to_s).to eq '#ruby'\n+    end\n+\n+    it 'matches hashtags containing uppercase characters' do\n+      expect(subject.match('Hello #rubyOnRails').to_s).to eq '#rubyOnRails'\n+    end\n   end\n \n   describe '#to_param' do\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nSeen on these pages:\r\n\r\nhttps://www.smithsonianmag.com/history/how-the-rise-of-the-camera-launched-a-fight-to-protect-gilded-age-americans-privacy-180984656/\r\nhttps://www.bostonglobe.com/2024/07/05/metro/wampanoag-plymouth-dei-cape-cod/\r\n\r\n![CleanShot 2024-07-05 at 17 51 00@2x](https://github.com/mastodon/mastodon/assets/3002053/e05b590b-ccb5-4866-9bba-ee020283d867)\r\n\n\n### Expected behaviour\n\nNo error\n\n### Actual behaviour\n\nError\n\n### Detailed description\n\nI seems like these are triggered from the author details on the page being listed in an array.\n\n### Mastodon instance\n\nvmst.io\n\n### Mastodon version\n\nv4.3.0-alpha.5\n\n### Technical details\n\nLatest `main`\n\n---\n\nChoice A:\napp/lib/link_details_extractor.rb\n@@ -62,7 +62,8 @@ def date_modified\n     end\n \n     def author_name\n-      author['name']\n+      name = author['name']\n+      name.is_a?(Array) ? name.join(', ') : name\n     end\n \n     def author_url\n@@ -294,7 +295,7 @@ def detector\n   def html_entities_decode(string)\n     return if string.nil?\n \n-    unicode_string = string.encode('UTF-8')\n+    unicode_string = string.to_s.encode('UTF-8')\n     raise EncodingError, 'cannot convert string to valid UTF-8' unless unicode_string.valid_encoding?\n \n     html_entities.decode(unicode_string)\n---\nspec/lib/link_details_extractor_spec.rb\n@@ -192,6 +192,35 @@\n \n       include_examples 'structured data'\n     end\n+\n+    context 'with author names as array' do\n+      let(:ld_json) do\n+        {\n+          '@context' => 'https://schema.org',\n+          '@type' => 'NewsArticle',\n+          'headline' => 'A lot of authors',\n+          'description' => 'But we decided to cram them into one',\n+          'author' => {\n+            '@type' => 'Person',\n+            'name' => ['Author 1', 'Author 2'],\n+          },\n+        }.to_json\n+      end\n+      let(:html) { <<~HTML }\n+        <!doctype html>\n+        <html>\n+        <body>\n+          <script type=\"application/ld+json\">\n+            #{ld_json}\n+          </script>\n+        </body>\n+        </html>\n+      HTML\n+\n+      it 'joins author names' do\n+        expect(subject.author_name).to eq 'Author 1, Author 2'\n+      end\n+    end\n   end\n \n   context 'when Open Graph protocol data is present' do\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/ui/components/navigation_panel.jsx\n@@ -64,8 +64,8 @@ const NotificationsLink = () => {\n     <ColumnLink\n       transparent\n       to='/notifications'\n-      icon={<IconWithBadge icon={NotificationsIcon} count={count} className='column-link__icon' />}\n-      activeIcon={<IconWithBadge icon={NotificationsActiveIcon} count={count} className='column-link__icon' />}\n+      icon={<IconWithBadge id='bell' icon={NotificationsIcon} count={count} className='column-link__icon' />}\n+      activeIcon={<IconWithBadge id='bell' icon={NotificationsActiveIcon} count={count} className='column-link__icon' />}\n       text={intl.formatMessage(messages.notifications)}\n     />\n   );\n@@ -88,8 +88,8 @@ const FollowRequestsLink = () => {\n     <ColumnLink\n       transparent\n       to='/follow_requests'\n-      icon={<IconWithBadge icon={PersonAddIcon} count={count} className='column-link__icon' />}\n-      activeIcon={<IconWithBadge icon={PersonAddActiveIcon} count={count} className='column-link__icon' />}\n+      icon={<IconWithBadge id='user-plus' icon={PersonAddIcon} count={count} className='column-link__icon' />}\n+      activeIcon={<IconWithBadge id='user-plus' icon={PersonAddActiveIcon} count={count} className='column-link__icon' />}\n       text={intl.formatMessage(messages.followRequests)}\n     />\n   );\n---\n\n\n---\n\nChoice C:\napp/lib/search_query_transformer.rb\n@@ -225,7 +225,7 @@ def language_code_from_term(term)\n   end\n \n   rule(clause: subtree(:clause)) do\n-    prefix   = clause[:prefix][:term].to_s if clause[:prefix]\n+    prefix   = clause[:prefix][:term].to_s.downcase if clause[:prefix]\n     operator = clause[:operator]&.to_s\n     term     = clause[:phrase] ? clause[:phrase].map { |term| term[:term].to_s }.join(' ') : clause[:term].to_s\n \n---\n\n\n---\n\nChoice D:\nconfig/routes.rb\n@@ -3,6 +3,18 @@\n require 'sidekiq_unique_jobs/web'\n require 'sidekiq-scheduler/web'\n \n+class RedirectWithVary < ActionDispatch::Routing::PathRedirect\n+  def serve(...)\n+    super.tap do |_, headers, _|\n+      headers['Vary'] = 'Origin, Accept'\n+    end\n+  end\n+end\n+\n+def redirect_with_vary(path)\n+  RedirectWithVary.new(301, path)\n+end\n+\n Rails.application.routes.draw do\n   # Paths of routes on the web app that to not require to be indexed or\n   # have alternative format representations requiring separate controllers\n@@ -90,10 +102,13 @@\n     confirmations:      'auth/confirmations',\n   }\n \n-  get '/users/:username', to: redirect('/@%{username}'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n-  get '/users/:username/following', to: redirect('/@%{username}/following'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n-  get '/users/:username/followers', to: redirect('/@%{username}/followers'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n-  get '/users/:username/statuses/:id', to: redirect('/@%{username}/%{id}'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  # rubocop:disable Style/FormatStringToken - those do not go through the usual formatting functions and are not safe to correct\n+  get '/users/:username', to: redirect_with_vary('/@%{username}'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  get '/users/:username/following', to: redirect_with_vary('/@%{username}/following'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  get '/users/:username/followers', to: redirect_with_vary('/@%{username}/followers'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  get '/users/:username/statuses/:id', to: redirect_with_vary('/@%{username}/%{id}'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  # rubocop:enable Style/FormatStringToken\n+\n   get '/authorize_follow', to: redirect { |_, request| \"/authorize_interaction?#{request.params.to_query}\" }\n \n   resources :accounts, path: 'users', only: [:show], param: :username do\n---\nspec/requests/cache_spec.rb\n@@ -124,7 +124,7 @@ module DisabledAnonymousAPI\n       expect(response.cookies).to be_empty\n     end\n \n-    it 'sets public cache control' do\n+    it 'sets public cache control', :aggregate_failures do\n       # expect(response.cache_control[:max_age]&.to_i).to be_positive\n       expect(response.cache_control[:public]).to be_truthy\n       expect(response.cache_control[:private]).to be_falsy\n@@ -141,11 +141,8 @@ module DisabledAnonymousAPI\n   end\n \n   shared_examples 'non-cacheable error' do\n-    it 'does not return HTTP success' do\n+    it 'does not return HTTP success and does not have cache headers', :aggregate_failures do\n       expect(response).to_not have_http_status(200)\n-    end\n-\n-    it 'does not have cache headers' do\n       expect(response.cache_control[:public]).to be_falsy\n     end\n   end\n@@ -182,6 +179,15 @@ module DisabledAnonymousAPI\n   end\n \n   context 'when anonymously accessed' do\n+    describe '/users/alice' do\n+      it 'redirects with proper cache header', :aggregate_failures do\n+        get '/users/alice'\n+\n+        expect(response).to redirect_to('/@alice')\n+        expect(response.headers['Vary']&.split(',')&.map { |x| x.strip.downcase }).to include('accept')\n+      end\n+    end\n+\n     TestEndpoints::ALWAYS_CACHED.each do |endpoint|\n       describe endpoint do\n         before { get endpoint }\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. View the hover card of `@media_dept@mastodon.social`\r\n2. Notice the overflow\r\n3.  ![Screenshot from 2024-07-04 23-42-41](https://github.com/mastodon/mastodon/assets/837136/07e44a70-29b2-4b64-97bb-b51e25caa76a)\r\n\n\n### Expected behaviour\n\nText should not overflow the bounds of the hover card\n\n### Actual behaviour\n\nLong URl descriptions break the look and feel.\n\n### Detailed description\n\nThe user appears to have very long descriptions of their URls. For example `Voting options for UK General Election, Thursday 4th July 2024`\r\n![Screenshot 2024-07-04 at 23-43-50 Games Games Games (@media_dept@mastodon social) - Mastodon](https://github.com/mastodon/mastodon/assets/837136/cda3ffb3-6b85-4d9f-9b00-fe8704db7167)\r\n\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.3.0-nightly.2024-07-05-security\n\n### Browser name and version\n\nFirefox 127\n\n### Operating system\n\nUbuntu 22.04\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/status/components/card.jsx\n@@ -141,7 +141,7 @@ export default class Card extends PureComponent {\n     const showAuthor  = !!card.getIn(['authors', 0, 'accountId']);\n \n     const description = (\n-      <div className='status-card__content'>\n+      <div className='status-card__content' dir='auto'>\n         <span className='status-card__host'>\n           <span lang={language}>{provider}</span>\n           {card.get('published_at') && <> \u00b7 <RelativeTimestamp timestamp={card.get('published_at')} /></>}\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -10453,7 +10453,7 @@ noscript {\n       gap: 4px;\n \n       dt {\n-        flex: 0 0 auto;\n+        flex: 0 1 auto;\n         color: $dark-text-color;\n         min-width: 0;\n         overflow: hidden;\n---\n\n\n---\n\nChoice C:\napp/models/account.rb\n@@ -127,7 +127,7 @@ class Account < ApplicationRecord\n   scope :searchable, -> { without_unapproved.without_suspended.where(moved_to_account_id: nil) }\n   scope :discoverable, -> { searchable.without_silenced.where(discoverable: true).joins(:account_stat) }\n   scope :followable_by, ->(account) { joins(arel_table.join(Follow.arel_table, Arel::Nodes::OuterJoin).on(arel_table[:id].eq(Follow.arel_table[:target_account_id]).and(Follow.arel_table[:account_id].eq(account.id))).join_sources).where(Follow.arel_table[:id].eq(nil)).joins(arel_table.join(FollowRequest.arel_table, Arel::Nodes::OuterJoin).on(arel_table[:id].eq(FollowRequest.arel_table[:target_account_id]).and(FollowRequest.arel_table[:account_id].eq(account.id))).join_sources).where(FollowRequest.arel_table[:id].eq(nil)) }\n-  scope :by_recent_status, -> { order(Arel.sql('account_stats.last_status_at DESC NULLS LAST')) }\n+  scope :by_recent_status, -> { includes(:account_stat).merge(AccountStat.order('last_status_at DESC NULLS LAST')).references(:account_stat) }\n   scope :by_recent_sign_in, -> { order(Arel.sql('users.current_sign_in_at DESC NULLS LAST')) }\n   scope :popular, -> { order('account_stats.followers_count desc') }\n   scope :by_domain_and_subdomains, ->(domain) { where(domain: Instance.by_domain_and_subdomains(domain).select(:domain)) }\n---\napp/models/relationship_filter.rb\n@@ -114,7 +114,7 @@ def order_scope(value)\n   def activity_scope(value)\n     case value\n     when 'dormant'\n-      AccountStat.where(last_status_at: nil).or(AccountStat.where(AccountStat.arel_table[:last_status_at].lt(1.month.ago)))\n+      Account.joins(:account_stat).where(account_stat: { last_status_at: [nil, ...1.month.ago] })\n     else\n       raise Mastodon::InvalidParameterError, \"Unknown activity: #{value}\"\n     end\n---\nspec/models/relationship_filter_spec.rb\n@@ -6,32 +6,60 @@\n   let(:account) { Fabricate(:account) }\n \n   describe '#results' do\n-    context 'when default params are used' do\n-      subject do\n-        described_class.new(account, 'order' => 'active').results\n-      end\n+    let(:account_of_7_months) { Fabricate(:account_stat, statuses_count: 1, last_status_at: 7.months.ago).account }\n+    let(:account_of_1_day)    { Fabricate(:account_stat, statuses_count: 1, last_status_at: 1.day.ago).account }\n+    let(:account_of_3_days)   { Fabricate(:account_stat, statuses_count: 1, last_status_at: 3.days.ago).account }\n+    let(:silent_account)      { Fabricate(:account_stat, statuses_count: 0, last_status_at: nil).account }\n+\n+    before do\n+      account.follow!(account_of_7_months)\n+      account.follow!(account_of_1_day)\n+      account.follow!(account_of_3_days)\n+      account.follow!(silent_account)\n+    end\n \n-      before do\n-        add_following_account_with(last_status_at: 7.days.ago)\n-        add_following_account_with(last_status_at: 1.day.ago)\n-        add_following_account_with(last_status_at: 3.days.ago)\n+    context 'when ordering by last activity' do\n+      context 'when not filtering' do\n+        subject do\n+          described_class.new(account, 'order' => 'active').results\n+        end\n+\n+        it 'returns followings ordered by last activity' do\n+          expect(subject).to eq [account_of_1_day, account_of_3_days, account_of_7_months, silent_account]\n+        end\n       end\n \n-      it 'returns followings ordered by last activity' do\n-        expected_result = account.following.eager_load(:account_stat).reorder(nil).by_recent_status\n+      context 'when filtering for dormant accounts' do\n+        subject do\n+          described_class.new(account, 'order' => 'active', 'activity' => 'dormant').results\n+        end\n \n-        expect(subject).to eq expected_result\n+        it 'returns dormant followings ordered by last activity' do\n+          expect(subject).to eq [account_of_7_months, silent_account]\n+        end\n       end\n     end\n-  end\n \n-  def add_following_account_with(last_status_at:)\n-    following_account = Fabricate(:account)\n-    Fabricate(:account_stat, account: following_account,\n-                             last_status_at: last_status_at,\n-                             statuses_count: 1,\n-                             following_count: 0,\n-                             followers_count: 0)\n-    Fabricate(:follow, account: account, target_account: following_account).account\n+    context 'when ordering by account creation' do\n+      context 'when not filtering' do\n+        subject do\n+          described_class.new(account, 'order' => 'recent').results\n+        end\n+\n+        it 'returns followings ordered by last account creation' do\n+          expect(subject).to eq [silent_account, account_of_3_days, account_of_1_day, account_of_7_months]\n+        end\n+      end\n+\n+      context 'when filtering for dormant accounts' do\n+        subject do\n+          described_class.new(account, 'order' => 'recent', 'activity' => 'dormant').results\n+        end\n+\n+        it 'returns dormant followings ordered by last activity' do\n+          expect(subject).to eq [silent_account, account_of_7_months]\n+        end\n+      end\n+    end\n   end\n end\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/components/edited_timestamp/index.jsx\n@@ -67,7 +67,7 @@ class EditedTimestamp extends PureComponent {\n     return (\n       <DropdownMenu statusId={statusId} renderItem={this.renderItem} scrollable renderHeader={this.renderHeader} onItemClick={this.handleItemClick}>\n         <button className='dropdown-menu__text-button'>\n-          <FormattedMessage id='status.edited' defaultMessage='Edited {date}' values={{ date: intl.formatDate(timestamp, { hour12: false, month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) }} /> <Icon id='caret-down' icon={ArrowDropDownIcon} />\n+          <FormattedMessage id='status.edited' defaultMessage='Edited {date}' values={{ date: intl.formatDate(timestamp, { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) }} /> <Icon id='caret-down' icon={ArrowDropDownIcon} />\n         </button>\n       </DropdownMenu>\n     );\n---\napp/javascript/mastodon/components/relative_timestamp.tsx\n@@ -53,7 +53,6 @@ const messages = defineMessages({\n });\n \n const dateFormatOptions = {\n-  hour12: false,\n   year: 'numeric',\n   month: 'short',\n   day: '2-digit',\n---\napp/javascript/mastodon/components/status.jsx\n@@ -554,7 +554,7 @@ class Status extends ImmutablePureComponent {\n             <div onClick={this.handleClick} className='status__info'>\n               <a href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} className='status__relative-time' target='_blank' rel='noopener noreferrer'>\n                 <span className='status__visibility-icon'><VisibilityIcon visibility={status.get('visibility')} /></span>\n-                <RelativeTimestamp timestamp={status.get('created_at')} />{status.get('edited_at') && <abbr title={intl.formatMessage(messages.edited, { date: intl.formatDate(status.get('edited_at'), { hour12: false, year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) })}> *</abbr>}\n+                <RelativeTimestamp timestamp={status.get('created_at')} />{status.get('edited_at') && <abbr title={intl.formatMessage(messages.edited, { date: intl.formatDate(status.get('edited_at'), { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) })}> *</abbr>}\n               </a>\n \n               <a onClick={this.handleAccountClick} href={`/@${status.getIn(['account', 'acct'])}`} title={status.getIn(['account', 'acct'])} className='status__display-name' target='_blank' rel='noopener noreferrer'>\n---\napp/javascript/mastodon/features/account/components/header.jsx\n@@ -101,7 +101,6 @@ const dateFormatOptions = {\n   month: 'short',\n   day: 'numeric',\n   year: 'numeric',\n-  hour12: false,\n   hour: '2-digit',\n   minute: '2-digit',\n };\n---\napp/javascript/mastodon/features/getting_started/components/announcements.jsx\n@@ -343,7 +343,7 @@ class Announcement extends ImmutablePureComponent {\n       <div className='announcements__item'>\n         <strong className='announcements__item__range'>\n           <FormattedMessage id='announcement.announcement' defaultMessage='Announcement' />\n-          {hasTimeRange && <span> \u00b7 <FormattedDate value={startsAt} hour12={false} year={(skipYear || startsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month='short' day='2-digit' hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /> - <FormattedDate value={endsAt} hour12={false} year={(skipYear || endsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month={skipEndDate ? undefined : 'short'} day={skipEndDate ? undefined : '2-digit'} hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /></span>}\n+          {hasTimeRange && <span> \u00b7 <FormattedDate value={startsAt} year={(skipYear || startsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month='short' day='2-digit' hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /> - <FormattedDate value={endsAt} year={(skipYear || endsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month={skipEndDate ? undefined : 'short'} day={skipEndDate ? undefined : '2-digit'} hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /></span>}\n         </strong>\n \n         <Content announcement={announcement} />\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -311,7 +311,7 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n-              <FormattedDate value={new Date(status.get('created_at'))} hour12={false} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n+              <FormattedDate value={new Date(status.get('created_at'))} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n             </a>{edited}{visibilityLink}{applicationLink}{reblogLink} \u00b7 {favouriteLink}\n           </div>\n         </div>\n---\napp/javascript/packs/public.jsx\n@@ -65,7 +65,6 @@ function loaded() {\n \n   const timeFormat = new Intl.DateTimeFormat(locale, {\n     timeStyle: 'short',\n-    hour12: false,\n   });\n \n   const formatMessage = ({ id, defaultMessage }, values) => {\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Sending a link in Mastodon that contains Persian or Arabic content.\r\n2. Waiting for the preview to be generated.\n\n### Expected behaviour\n\nPersian or Arabic texts in link previews should be right-to-left.\n\n### Actual behaviour\n\nPersian or Arabic texts in link previews are displayed left-to-right.\n\n### Detailed description\n\n![Screenshot 2024-07-04 21 30 51](https://github.com/mastodon/mastodon/assets/87318660/cb2c1c5e-9b3d-4707-94cf-be90a5553d8b)\r\nhttps://khiar.net/@drcode/112729514922262834\r\n\r\n![Screenshot 2024-07-04 21 30 19](https://github.com/mastodon/mastodon/assets/87318660/810f3e59-b837-4391-839a-2c467745c809)\r\nhttps://khiar.net/@drcode/112729520487495122\n\n### Mastodon instance\n\nany instance - khiar.net\n\n### Mastodon version\n\nv4 and up - v4.2.10\n\n### Browser name and version\n\nany browser - Google chrome Version 128.0.6558.0 (Official Build) dev (64-bit)\n\n### Operating system\n\nany os - Google chrome OS Version 128.0.6558.0 (Official Build) dev (64-bit)\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\nlib/http_extensions.rb\n@@ -2,9 +2,7 @@\n \n # Monkey patching until https://github.com/httprb/http/pull/757 is merged\n unless HTTP::Request::METHODS.include?(:purge)\n-  module HTTP\n-    class Request\n-      METHODS = METHODS.dup.push(:purge).freeze\n-    end\n-  end\n+  methods = HTTP::Request::METHODS.dup\n+  HTTP::Request.send(:remove_const, :METHODS)\n+  HTTP::Request.const_set(:METHODS, methods.push(:purge).freeze)\n end\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -159,8 +159,8 @@\n .error-modal,\n .onboarding-modal,\n .compare-history-modal,\n-.report-modal__comment .setting-text__wrapper,\n-.report-modal__comment .setting-text,\n+.report-modal__comment,\n+.report-modal__comment,\n .announcements,\n .picture-in-picture__header,\n .picture-in-picture__footer,\n@@ -169,6 +169,11 @@\n   border: 1px solid var(--background-border-color);\n }\n \n+.setting-text__wrapper,\n+.setting-text {\n+  border: 1px solid var(--background-border-color);\n+}\n+\n .reactions-bar__item:hover,\n .reactions-bar__item:focus,\n .reactions-bar__item:active {\n@@ -198,14 +203,6 @@\n   color: $white;\n }\n \n-.report-modal__comment {\n-  border-right-color: lighten($ui-base-color, 8%);\n-}\n-\n-.report-modal__container {\n-  border-top-color: lighten($ui-base-color, 8%);\n-}\n-\n .column-settings__hashtags .column-select__option {\n   color: $white;\n }\n---\napp/javascript/styles/mastodon/components.scss\n@@ -3911,7 +3911,7 @@ $ui-header-logo-wordmark-width: 99px;\n \n   &__wrapper {\n     background: $white;\n-    border: 1px solid $ui-secondary-color;\n+    border: 1px solid var(--background-border-color);\n     margin-bottom: 10px;\n     border-radius: 4px;\n \n@@ -6298,9 +6298,10 @@ a.status-card {\n .report-modal,\n .actions-modal,\n .compare-history-modal {\n-  background: lighten($ui-secondary-color, 8%);\n-  color: $inverted-text-color;\n-  border-radius: 8px;\n+  background: var(--background-color);\n+  color: $primary-text-color;\n+  border-radius: 4px;\n+  border: 1px solid var(--background-border-color);\n   overflow: hidden;\n   max-width: 90vw;\n   width: 480px;\n@@ -6344,6 +6345,7 @@ a.status-card {\n .report-modal {\n   width: 90vw;\n   max-width: 700px;\n+  border: 1px solid var(--background-border-color);\n }\n \n .report-dialog-modal {\n@@ -6567,7 +6569,7 @@ a.status-card {\n \n .report-modal__container {\n   display: flex;\n-  border-top: 1px solid $ui-secondary-color;\n+  border-top: 1px solid var(--background-border-color);\n \n   @media screen and (width <= 480px) {\n     flex-wrap: wrap;\n@@ -6625,7 +6627,7 @@ a.status-card {\n \n .report-modal__comment {\n   padding: 20px;\n-  border-inline-end: 1px solid $ui-secondary-color;\n+  border-inline-end: 1px solid var(--background-border-color);\n   max-width: 320px;\n \n   p {\n@@ -6636,7 +6638,7 @@ a.status-card {\n \n   .setting-text-label {\n     display: block;\n-    color: $inverted-text-color;\n+    color: $secondary-text-color;\n     font-size: 14px;\n     font-weight: 500;\n     margin-bottom: 10px;\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/status/components/card.jsx\n@@ -141,7 +141,7 @@ export default class Card extends PureComponent {\n     const showAuthor  = !!card.getIn(['authors', 0, 'accountId']);\n \n     const description = (\n-      <div className='status-card__content'>\n+      <div className='status-card__content' dir='auto'>\n         <span className='status-card__host'>\n           <span lang={language}>{provider}</span>\n           {card.get('published_at') && <> \u00b7 <RelativeTimestamp timestamp={card.get('published_at')} /></>}\n---\n\n\n---\n\nChoice D:\napp/models/account.rb\n@@ -68,7 +68,7 @@ class Account < ApplicationRecord\n   INSTANCE_ACTOR_ID = -99\n \n   USERNAME_RE   = /[a-z0-9_]+([a-z0-9_.-]+[a-z0-9_]+)?/i\n-  MENTION_RE    = %r{(?<![=/[:word:]])@((#{USERNAME_RE})(?:@[[:word:].-]+[[:word:]]+)?)}i\n+  MENTION_RE    = %r{(?<![=/[:word:]])@((#{USERNAME_RE})(?:@[[:word:].-]+[[:word:]]+)?)}\n   URL_PREFIX_RE = %r{\\Ahttp(s?)://[^/]+}\n   USERNAME_ONLY_RE = /\\A#{USERNAME_RE}\\z/i\n   USERNAME_LENGTH_LIMIT = 30\n---\napp/models/tag.rb\n@@ -37,7 +37,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]\\u0E47-\\u0E4E#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/account_spec.rb\n@@ -711,6 +711,14 @@\n     it 'does not match URL query string' do\n       expect(subject.match('https://example.com/?x=@alice')).to be_nil\n     end\n+\n+    it 'matches usernames immediately following the letter \u00df' do\n+      expect(subject.match('Hello to\u00df @alice from me')[1]).to eq 'alice'\n+    end\n+\n+    it 'matches usernames containing uppercase characters' do\n+      expect(subject.match('Hello to @aLice@Example.com from me')[1]).to eq 'aLice@Example.com'\n+    end\n   end\n \n   describe 'validations' do\n---\nspec/models/tag_spec.rb\n@@ -95,6 +95,14 @@\n     it 'does not match purely-numeric hashtags' do\n       expect(subject.match('hello #0123456')).to be_nil\n     end\n+\n+    it 'matches hashtags immediately following the letter \u00df' do\n+      expect(subject.match('Hello to\u00df #ruby').to_s).to eq '#ruby'\n+    end\n+\n+    it 'matches hashtags containing uppercase characters' do\n+      expect(subject.match('Hello #rubyOnRails').to_s).to eq '#rubyOnRails'\n+    end\n   end\n \n   describe '#to_param' do\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nGenerated by these status/links:\r\nhttps://mastodon.online/users/michael_w_busch/statuses/112689809505071015\r\nhttps://www.mprnews.org/story/2024/06/26/new-facial-recognition-to-add-more-layers-to-mall-of-america-security\n\n### Expected behaviour\n\nNo error\n\n### Actual behaviour\n\nError\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nvmst.io\n\n### Mastodon version\n\nv4.3.0-alpha.4\n\n### Technical details\n\n![CleanShot 2024-06-27 at 13 19 37@2x](https://github.com/mastodon/mastodon/assets/3002053/e7450f70-c873-4592-9c7e-fe83b598fdbc)\r\n\n\n---\n\nChoice A:\nlib/mastodon/cli/feeds.rb\n@@ -5,6 +5,7 @@\n module Mastodon::CLI\n   class Feeds < Base\n     include Redisable\n+    include DatabaseHelper\n \n     option :all, type: :boolean, default: false\n     option :concurrency, type: :numeric, default: 5, aliases: [:c]\n@@ -44,6 +45,38 @@ def clear\n       say('OK', :green)\n     end\n \n+    desc 'vacuum', 'Remove home feeds of inactive users from Redis'\n+    long_desc <<-LONG_DESC\n+      Running this task should not be needed in most cases, as Mastodon will\n+      automatically clean up feeds from inactive accounts every day.\n+\n+      However, this task is more aggressive in order to clean up feeds that\n+      may have been missed because of bugs or database mishaps.\n+    LONG_DESC\n+    def vacuum\n+      with_read_replica do\n+        say('Deleting orphaned home feeds\u2026')\n+        redis.scan_each(match: 'feed:home:*').each_slice(1000) do |keys|\n+          ids = keys.map { |key| key.split(':')[2] }.compact_blank\n+\n+          known_ids = User.confirmed.signed_in_recently.where(account_id: ids).pluck(:account_id)\n+\n+          keys_to_delete = keys.filter { |key| known_ids.exclude?(key.split(':')[2]&.to_i) }\n+          redis.del(keys_to_delete)\n+        end\n+\n+        say('Deleting orphaned list feeds\u2026')\n+        redis.scan_each(match: 'feed:list:*').each_slice(1000) do |keys|\n+          ids = keys.map { |key| key.split(':')[2] }.compact_blank\n+\n+          known_ids = List.where(account_id: User.confirmed.signed_in_recently.select(:account_id)).where(id: ids).pluck(:id)\n+\n+          keys_to_delete = keys.filter { |key| known_ids.exclude?(key.split(':')[2]&.to_i) }\n+          redis.del(keys_to_delete)\n+        end\n+      end\n+    end\n+\n     private\n \n     def active_user_accounts\n---\n\n\n---\n\nChoice B:\nGemfile\n@@ -6,7 +6,7 @@ ruby '>= 3.2.0'\n gem 'propshaft'\n gem 'puma', '~> 6.3'\n gem 'rack', '~> 2.2.7'\n-gem 'rails', '~> 7.2.0'\n+gem 'rails', '~> 8.0'\n gem 'thor', '~> 1.2'\n \n gem 'dotenv'\n@@ -73,7 +73,7 @@ gem 'public_suffix', '~> 6.0'\n gem 'pundit', '~> 2.3'\n gem 'rack-attack', '~> 6.6'\n gem 'rack-cors', '~> 2.0', require: 'rack/cors'\n-gem 'rails-i18n', '~> 7.0'\n+gem 'rails-i18n', '~> 8.0'\n gem 'redcarpet', '~> 3.6'\n gem 'redis', '~> 4.5', require: ['redis', 'redis/connection/hiredis']\n gem 'redis-namespace', '~> 1.10'\n---\nGemfile.lock\n@@ -10,46 +10,45 @@ GIT\n GEM\n   remote: https://rubygems.org/\n   specs:\n-    actioncable (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actioncable (8.0.1)\n+      actionpack (= 8.0.1)\n+      activesupport (= 8.0.1)\n       nio4r (~> 2.0)\n       websocket-driver (>= 0.6.1)\n       zeitwerk (~> 2.6)\n-    actionmailbox (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activestorage (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionmailbox (8.0.1)\n+      actionpack (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activestorage (= 8.0.1)\n+      activesupport (= 8.0.1)\n       mail (>= 2.8.0)\n-    actionmailer (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      actionview (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionmailer (8.0.1)\n+      actionpack (= 8.0.1)\n+      actionview (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activesupport (= 8.0.1)\n       mail (>= 2.8.0)\n       rails-dom-testing (~> 2.2)\n-    actionpack (7.2.2.1)\n-      actionview (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionpack (8.0.1)\n+      actionview (= 8.0.1)\n+      activesupport (= 8.0.1)\n       nokogiri (>= 1.8.5)\n-      racc\n-      rack (>= 2.2.4, < 3.2)\n+      rack (>= 2.2.4)\n       rack-session (>= 1.0.1)\n       rack-test (>= 0.6.3)\n       rails-dom-testing (~> 2.2)\n       rails-html-sanitizer (~> 1.6)\n       useragent (~> 0.16)\n-    actiontext (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activestorage (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actiontext (8.0.1)\n+      actionpack (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activestorage (= 8.0.1)\n+      activesupport (= 8.0.1)\n       globalid (>= 0.6.0)\n       nokogiri (>= 1.8.5)\n-    actionview (7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionview (8.0.1)\n+      activesupport (= 8.0.1)\n       builder (~> 3.1)\n       erubi (~> 1.11)\n       rails-dom-testing (~> 2.2)\n@@ -59,22 +58,22 @@ GEM\n       activemodel (>= 4.1)\n       case_transform (>= 0.2)\n       jsonapi-renderer (>= 0.1.1.beta1, < 0.3)\n-    activejob (7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    activejob (8.0.1)\n+      activesupport (= 8.0.1)\n       globalid (>= 0.3.6)\n-    activemodel (7.2.2.1)\n-      activesupport (= 7.2.2.1)\n-    activerecord (7.2.2.1)\n-      activemodel (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    activemodel (8.0.1)\n+      activesupport (= 8.0.1)\n+    activerecord (8.0.1)\n+      activemodel (= 8.0.1)\n+      activesupport (= 8.0.1)\n       timeout (>= 0.4.0)\n-    activestorage (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    activestorage (8.0.1)\n+      actionpack (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activesupport (= 8.0.1)\n       marcel (~> 1.0)\n-    activesupport (7.2.2.1)\n+    activesupport (8.0.1)\n       base64\n       benchmark (>= 0.3)\n       bigdecimal\n@@ -86,6 +85,7 @@ GEM\n       minitest (>= 5.1)\n       securerandom (>= 0.3)\n       tzinfo (~> 2.0, >= 2.0.5)\n+      uri (>= 0.13.1)\n     addressable (2.8.7)\n       public_suffix (>= 2.0.2, < 7.0)\n     aes_key_wrap (1.1.0)\n@@ -613,20 +613,20 @@ GEM\n     rackup (1.0.1)\n       rack (< 3)\n       webrick\n-    rails (7.2.2.1)\n-      actioncable (= 7.2.2.1)\n-      actionmailbox (= 7.2.2.1)\n-      actionmailer (= 7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      actiontext (= 7.2.2.1)\n-      actionview (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activemodel (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activestorage (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    rails (8.0.1)\n+      actioncable (= 8.0.1)\n+      actionmailbox (= 8.0.1)\n+      actionmailer (= 8.0.1)\n+      actionpack (= 8.0.1)\n+      actiontext (= 8.0.1)\n+      actionview (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activemodel (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activestorage (= 8.0.1)\n+      activesupport (= 8.0.1)\n       bundler (>= 1.15.0)\n-      railties (= 7.2.2.1)\n+      railties (= 8.0.1)\n     rails-controller-testing (1.0.5)\n       actionpack (>= 5.0.1.rc1)\n       actionview (>= 5.0.1.rc1)\n@@ -638,12 +638,12 @@ GEM\n     rails-html-sanitizer (1.6.2)\n       loofah (~> 2.21)\n       nokogiri (>= 1.15.7, != 1.16.7, != 1.16.6, != 1.16.5, != 1.16.4, != 1.16.3, != 1.16.2, != 1.16.1, != 1.16.0.rc1, != 1.16.0)\n-    rails-i18n (7.0.10)\n+    rails-i18n (8.0.1)\n       i18n (>= 0.7, < 2)\n-      railties (>= 6.0.0, < 8)\n-    railties (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+      railties (>= 8.0.0, < 9)\n+    railties (8.0.1)\n+      actionpack (= 8.0.1)\n+      activesupport (= 8.0.1)\n       irb (~> 1.13)\n       rackup (>= 1.0.0)\n       rake (>= 12.2)\n@@ -986,9 +986,9 @@ DEPENDENCIES\n   rack-attack (~> 6.6)\n   rack-cors (~> 2.0)\n   rack-test (~> 2.1)\n-  rails (~> 7.2.0)\n+  rails (~> 8.0)\n   rails-controller-testing (~> 1.0)\n-  rails-i18n (~> 7.0)\n+  rails-i18n (~> 8.0)\n   rdf-normalize (~> 0.5)\n   redcarpet (~> 3.6)\n   redis (~> 4.5)\n---\nconfig/application.rb\n@@ -59,7 +59,7 @@\n module Mastodon\n   class Application < Rails::Application\n     # Initialize configuration defaults for originally generated Rails version.\n-    config.load_defaults 7.2\n+    config.load_defaults 8.0\n \n     # Please, add to the `ignore` list any other `lib` subdirectories that do\n     # not contain `.rb` files, or that should not be reloaded or eager loaded.\n---\nconfig/initializers/filter_parameter_logging.rb\n@@ -6,5 +6,5 @@\n # Use this to limit dissemination of sensitive information.\n # See the ActiveSupport::ParameterFilter documentation for supported notations and behaviors.\n Rails.application.config.filter_parameters += [\n-  :passw, :email, :secret, :token, :_key, :crypt, :salt, :certificate, :otp, :ssn\n+  :passw, :email, :secret, :token, :_key, :crypt, :salt, :certificate, :otp, :ssn, :cvv, :cvc\n ]\n---\nlib/active_record/batches.rb\n@@ -13,7 +13,9 @@ def pluck_each(*column_names)\n \n       column_names.unshift(primary_key)\n \n-      relation = relation.reorder(build_batch_orders(order).to_h).limit(batch_limit)\n+      cursor = Array(primary_key)\n+\n+      relation = relation.reorder(build_batch_orders(cursor, order).to_h).limit(batch_limit)\n       relation.skip_query_cache!\n \n       batch_relation = relation\n---\nspec/rails_helper.rb\n@@ -119,6 +119,11 @@ def sign_in(resource, _deprecated = nil, scope: nil)\n   config.include CommandLineHelpers, type: :cli\n   config.include SystemHelpers, type: :system\n \n+  # TODO: Remove when Devise fixes https://github.com/heartcombo/devise/issues/5705\n+  config.before do\n+    Rails.application.reload_routes_unless_loaded\n+  end\n+\n   config.around(:each, use_transactional_tests: false) do |example|\n     self.use_transactional_tests = false\n     example.run\n---\n\n\n---\n\nChoice C:\nlib/mastodon/cli/search.rb\n@@ -100,6 +100,14 @@ def deploy\n       progress.finish\n \n       say(\"Indexed #{added} records, de-indexed #{removed}\", :green, true)\n+    rescue Elasticsearch::Transport::Transport::ServerError => e\n+      fail_with_message <<~ERROR\n+        There was an issue connecting to the search server. Make sure the\n+        server is configured and running correctly, and that the environment\n+        variable settings match what the server is expecting.\n+\n+        #{e.message}\n+      ERROR\n     end\n \n     private\n---\nspec/lib/mastodon/cli/search_spec.rb\n@@ -33,6 +33,17 @@\n       end\n     end\n \n+    context 'when server communication raises an error' do\n+      let(:options) { { reset_chewy: true } }\n+\n+      before { allow(Chewy::Stash::Specification).to receive(:reset!).and_raise(Elasticsearch::Transport::Transport::Errors::InternalServerError) }\n+\n+      it 'Exits with error message' do\n+        expect { subject }\n+          .to raise_error(Thor::Error, /issue connecting to the search/)\n+      end\n+    end\n+\n     context 'without options' do\n       before { stub_search_indexes }\n \n---\n\n\n---\n\nChoice D:\napp/lib/link_details_extractor.rb\n@@ -101,7 +101,7 @@ def root_array(root)\n     end\n \n     def json\n-      @json ||= root_array(Oj.load(@data)).find { |obj| SUPPORTED_TYPES.include?(obj['@type']) } || {}\n+      @json ||= root_array(Oj.load(@data)).compact.find { |obj| SUPPORTED_TYPES.include?(obj['@type']) } || {}\n     end\n   end\n \n---\nspec/lib/link_details_extractor_spec.rb\n@@ -129,6 +129,24 @@\n       include_examples 'structured data'\n     end\n \n+    context 'with the first tag is null' do\n+      let(:html) { <<~HTML }\n+        <!doctype html>\n+        <html>\n+        <body>\n+          <script type=\"application/ld+json\">\n+            null\n+          </script>\n+          <script type=\"application/ld+json\">\n+            #{ld_json}\n+          </script>\n+        </body>\n+        </html>\n+      HTML\n+\n+      include_examples 'structured data'\n+    end\n+\n     context 'with preceding block of unsupported LD+JSON' do\n       let(:html) { <<~HTML }\n         <!doctype html>\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Look at this post: https://mastodon.gamedev.place/@CarePackage17/112688958098239356\r\n2. Try clicking the link\r\n3. Observe it leads to a 404 instead of https://gta.fandom.com/wiki/TW@\r\n\n\n### Expected behaviour\n\nThe link should include the @ as part of its URL: https://gta.fandom.com/wiki/TW@\n\n### Actual behaviour\n\nthe link gets broken\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nmastodon.gamedev.place\n\n### Mastodon version\n\n4.2.9\n\n### Browser name and version\n\nFirefox Nightly 129\n\n### Operating system\n\nAndroid\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -80,6 +80,7 @@ html {\n }\n \n .search__input,\n+.search__popout,\n .setting-text,\n .report-dialog-modal__textarea,\n .audio-player {\n@@ -439,7 +440,8 @@ html {\n .directory__tag > div,\n .card > a,\n .page-header,\n-.compose-form .compose-form__warning {\n+.compose-form,\n+.compose-form__warning {\n   box-shadow: none;\n }\n \n@@ -475,12 +477,17 @@ html {\n   color: $white;\n }\n \n-.compose-form .spoiler-input__input {\n+.compose-form,\n+.spoiler-input__input,\n+.search__input,\n+.search__popout {\n   color: lighten($ui-highlight-color, 8%);\n }\n \n .compose-form .autosuggest-textarea__textarea,\n .compose-form__highlightable,\n+.search__input,\n+.search__popout,\n .poll__option input[type='text'] {\n   background: darken($ui-base-color, 10%);\n }\n---\n\n\n---\n\nChoice B:\napp/controllers/admin/accounts_controller.rb\n@@ -128,7 +128,7 @@ def remove_header\n     def unblock_email\n       authorize @account, :unblock_email?\n \n-      CanonicalEmailBlock.matching_account(@account).delete_all\n+      CanonicalEmailBlock.where(reference_account: @account).delete_all\n \n       log_action :unblock_email, @account\n \n---\napp/models/canonical_email_block.rb\n@@ -20,7 +20,6 @@ class CanonicalEmailBlock < ApplicationRecord\n   validates :canonical_email_hash, presence: true, uniqueness: true\n \n   scope :matching_email, ->(email) { where(canonical_email_hash: email_to_canonical_email_hash(email)) }\n-  scope :matching_account, ->(account) { matching_email(account&.user_email).or(where(reference_account: account)) }\n \n   def to_log_human_identifier\n     canonical_email_hash\n---\napp/views/admin/accounts/show.html.haml\n@@ -30,7 +30,7 @@\n = render 'admin/accounts/counters', account: @account\n \n - if @account.local? && @account.user.nil?\n-  = link_to t('admin.accounts.unblock_email'), unblock_email_admin_account_path(@account.id), method: :post, class: 'button' if can?(:unblock_email, @account) && CanonicalEmailBlock.matching_account(@account).exists?\n+  = link_to t('admin.accounts.unblock_email'), unblock_email_admin_account_path(@account.id), method: :post, class: 'button' if can?(:unblock_email, @account) && CanonicalEmailBlock.exists?(reference_account_id: @account.id)\n - else\n   .table-wrapper\n     %table.table.inline-table\n---\nspec/fabricators/canonical_email_block_fabricator.rb\n@@ -1,6 +1,6 @@\n # frozen_string_literal: true\n \n Fabricator(:canonical_email_block) do\n-  email { |attrs| attrs[:reference_account] ? attrs[:reference_account].user_email : sequence(:email) { |i| \"#{i}#{Faker::Internet.email}\" } }\n+  email { sequence(:email) { |i| \"#{i}#{Faker::Internet.email}\" } }\n   reference_account { Fabricate.build(:account) }\n end\n---\nspec/controllers/admin/accounts_controller_spec.rb\n@@ -53,11 +53,32 @@\n \n   describe 'GET #show' do\n     let(:current_user) { Fabricate(:user, role: UserRole.find_by(name: 'Admin')) }\n-    let(:account) { Fabricate(:account) }\n \n-    it 'returns http success' do\n-      get :show, params: { id: account.id }\n-      expect(response).to have_http_status(200)\n+    context 'with a remote account' do\n+      let(:account) { Fabricate(:account, domain: 'example.com') }\n+\n+      it 'returns http success' do\n+        get :show, params: { id: account.id }\n+        expect(response).to have_http_status(200)\n+      end\n+    end\n+\n+    context 'with a local account' do\n+      let(:account) { Fabricate(:account, domain: nil) }\n+\n+      it 'returns http success' do\n+        get :show, params: { id: account.id }\n+        expect(response).to have_http_status(200)\n+      end\n+    end\n+\n+    context 'with a local deleted account' do\n+      let(:account) { Fabricate(:account, domain: nil, user: nil) }\n+\n+      it 'returns http success' do\n+        get :show, params: { id: account.id }\n+        expect(response).to have_http_status(200)\n+      end\n     end\n   end\n \n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -4,8 +4,6 @@ import { Children, cloneElement, useCallback } from 'react';\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import ImmutablePureComponent from 'react-immutable-pure-component';\n \n-import { supportsPassiveEvents } from 'detect-passive-events';\n-\n import { scrollRight } from '../../../scroll';\n import BundleContainer from '../containers/bundle_container';\n import {\n@@ -71,10 +69,6 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   };\n \n   componentDidMount() {\n-    if (!this.props.singleColumn) {\n-      this.node.addEventListener('wheel', this.handleWheel, supportsPassiveEvents ? { passive: true } : false);\n-    }\n-\n     if (this.mediaQuery) {\n       if (this.mediaQuery.addEventListener) {\n         this.mediaQuery.addEventListener('change', this.handleLayoutChange);\n@@ -87,23 +81,7 @@ export default class ColumnsArea extends ImmutablePureComponent {\n     this.isRtlLayout = document.getElementsByTagName('body')[0].classList.contains('rtl');\n   }\n \n-  UNSAFE_componentWillUpdate(nextProps) {\n-    if (this.props.singleColumn !== nextProps.singleColumn && nextProps.singleColumn) {\n-      this.node.removeEventListener('wheel', this.handleWheel);\n-    }\n-  }\n-\n-  componentDidUpdate(prevProps) {\n-    if (this.props.singleColumn !== prevProps.singleColumn && !this.props.singleColumn) {\n-      this.node.addEventListener('wheel', this.handleWheel, supportsPassiveEvents ? { passive: true } : false);\n-    }\n-  }\n-\n   componentWillUnmount () {\n-    if (!this.props.singleColumn) {\n-      this.node.removeEventListener('wheel', this.handleWheel);\n-    }\n-\n     if (this.mediaQuery) {\n       if (this.mediaQuery.removeEventListener) {\n         this.mediaQuery.removeEventListener('change', this.handleLayoutChange);\n@@ -116,22 +94,14 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   handleChildrenContentChange() {\n     if (!this.props.singleColumn) {\n       const modifier = this.isRtlLayout ? -1 : 1;\n-      this._interruptScrollAnimation = scrollRight(this.node, (this.node.scrollWidth - window.innerWidth) * modifier);\n+      scrollRight(this.node, (this.node.scrollWidth - window.innerWidth) * modifier);\n     }\n   }\n \n   handleLayoutChange = (e) => {\n     this.setState({ renderComposePanel: !e.matches });\n   };\n \n-  handleWheel = () => {\n-    if (typeof this._interruptScrollAnimation !== 'function') {\n-      return;\n-    }\n-\n-    this._interruptScrollAnimation();\n-  };\n-\n   setRef = (node) => {\n     this.node = node;\n   };\n---\napp/javascript/mastodon/scroll.ts\n@@ -38,13 +38,20 @@ const scroll = (\n const isScrollBehaviorSupported =\n   'scrollBehavior' in document.documentElement.style;\n \n-export const scrollRight = (node: Element, position: number) => {\n-  if (isScrollBehaviorSupported)\n-    node.scrollTo({ left: position, behavior: 'smooth' });\n-  else scroll(node, 'scrollLeft', position);\n-};\n-\n-export const scrollTop = (node: Element) => {\n-  if (isScrollBehaviorSupported) node.scrollTo({ top: 0, behavior: 'smooth' });\n-  else scroll(node, 'scrollTop', 0);\n-};\n+export const scrollRight = (node: Element, position: number) =>\n+  requestIdleCallback(() => {\n+    if (isScrollBehaviorSupported) {\n+      node.scrollTo({ left: position, behavior: 'smooth' });\n+    } else {\n+      scroll(node, 'scrollLeft', position);\n+    }\n+  });\n+\n+export const scrollTop = (node: Element) =>\n+  requestIdleCallback(() => {\n+    if (isScrollBehaviorSupported) {\n+      node.scrollTo({ top: 0, behavior: 'smooth' });\n+    } else {\n+      scroll(node, 'scrollTop', 0);\n+    }\n+  });\n---\napp/javascript/mastodon/test_helpers.tsx\n@@ -8,6 +8,14 @@ import { render as rtlRender } from '@testing-library/react';\n \n import { IdentityContext } from './identity_context';\n \n+beforeEach(() => {\n+  global.requestIdleCallback = jest\n+    .fn()\n+    .mockImplementation((fn: () => void) => {\n+      fn();\n+    });\n+});\n+\n function render(\n   ui: React.ReactElement,\n   {\n---\n\n\n---\n\nChoice D:\nconfig/initializers/twitter_regex.rb\n@@ -9,7 +9,7 @@ def emoji_parsing_enabled\n \n   class Regex\n     REGEXEN[:valid_general_url_path_chars] = /[^\\p{White_Space}<>()?]/iou\n-    REGEXEN[:valid_url_path_ending_chars] = /[^\\p{White_Space}()?!*\"'\u300c\u300d<>;:=,.$%\\[\\]~&|@]|(?:#{REGEXEN[:valid_url_balanced_parens]})/iou\n+    REGEXEN[:valid_url_path_ending_chars] = /[^\\p{White_Space}()?!*\"'\u300c\u300d<>;:=,.$%\\[\\]~&|]|(?:#{REGEXEN[:valid_url_balanced_parens]})/iou\n     REGEXEN[:valid_url_balanced_parens] = /\n       \\(\n         (?:\n---\nspec/lib/text_formatter_spec.rb\n@@ -224,6 +224,14 @@\n       end\n     end\n \n+    context 'when given a URL with trailing @ symbol' do\n+      let(:text) { 'https://gta.fandom.com/wiki/TW@ Content' }\n+\n+      it 'matches the full URL' do\n+        expect(subject).to include 'href=\"https://gta.fandom.com/wiki/TW@\"'\n+      end\n+    end\n+\n     context 'when given a URL containing unsafe code (XSS attack, visible part)' do\n       let(:text) { 'http://example.com/b<del>b</del>' }\n \n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Search for \"From:username\"\r\n\r\n\r\n### Expected behaviour\r\n\r\nOnly posts from username are listed\r\n\r\n### Actual behaviour\r\n\r\nPosts mentioning username are listed\r\n\r\n### Detailed description\r\n\r\nMost phones will automatically capitalize the first word of a sentence that you type.\r\n\r\nBecause Mastodon doesn't recognize \"From:\", but only \"from:\", it gives the impression that Mastodon doesn't support the ability to search for posts from a username.\r\n\r\nThis should be the case for all search modifiers. \r\n\r\n### Mastodon instance\r\n\r\nInfosec.exchange\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-alpha.4+glitch\r\n\r\n### Technical details\r\n\r\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: (from `ruby --version`, eg. v3.1.2)\r\n- Node.js version: (from `node --version`, eg. v18.16.0)\r\n\n\n---\n\nChoice A:\napp/lib/search_query_transformer.rb\n@@ -225,7 +225,7 @@ def language_code_from_term(term)\n   end\n \n   rule(clause: subtree(:clause)) do\n-    prefix   = clause[:prefix][:term].to_s if clause[:prefix]\n+    prefix   = clause[:prefix][:term].to_s.downcase if clause[:prefix]\n     operator = clause[:operator]&.to_s\n     term     = clause[:phrase] ? clause[:phrase].map { |term| term[:term].to_s }.join(' ') : clause[:term].to_s\n \n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/reducers/accounts.ts\n@@ -41,40 +41,42 @@ const normalizeAccounts = (\n   return state;\n };\n \n-export const accountsReducer: Reducer<typeof initialState> = (\n-  state = initialState,\n-  action,\n-) => {\n-  const currentUserId = me;\n-\n-  if (!currentUserId)\n+function getCurrentUser() {\n+  if (!me)\n     throw new Error(\n       'No current user (me) defined when calling `accountsReducer`',\n     );\n \n+  return me;\n+}\n+\n+export const accountsReducer: Reducer<typeof initialState> = (\n+  state = initialState,\n+  action,\n+) => {\n   if (revealAccount.match(action))\n     return state.setIn([action.payload.id, 'hidden'], false);\n   else if (importAccounts.match(action))\n     return normalizeAccounts(state, action.payload.accounts);\n-  else if (followAccountSuccess.match(action))\n+  else if (followAccountSuccess.match(action)) {\n     return state\n       .update(\n         action.payload.relationship.id,\n         (account) => account?.update('followers_count', (n) => n + 1),\n       )\n       .update(\n-        currentUserId,\n+        getCurrentUser(),\n         (account) => account?.update('following_count', (n) => n + 1),\n       );\n-  else if (unfollowAccountSuccess.match(action))\n+  } else if (unfollowAccountSuccess.match(action))\n     return state\n       .update(\n         action.payload.relationship.id,\n         (account) =>\n           account?.update('followers_count', (n) => Math.max(0, n - 1)),\n       )\n       .update(\n-        currentUserId,\n+        getCurrentUser(),\n         (account) =>\n           account?.update('following_count', (n) => Math.max(0, n - 1)),\n       );\n---\nspec/system/unlogged_spec.rb\n@@ -0,0 +1,17 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+describe 'UnloggedBrowsing' do\n+  subject { page }\n+\n+  before do\n+    visit root_path\n+  end\n+\n+  it 'loads the home page' do\n+    expect(subject).to have_css('div.app-holder')\n+\n+    expect(subject).to have_css('div.columns-area__panels__main')\n+  end\n+end\n---\n\n\n---\n\nChoice C:\napp/services/fetch_oembed_service.rb\n@@ -100,7 +100,7 @@ def parse_for_format(body)\n   end\n \n   def validate(oembed)\n-    oembed if oembed[:version].to_s == '1.0' && oembed[:type].present?\n+    oembed if oembed.present? && oembed[:version].to_s == '1.0' && oembed[:type].present?\n   end\n \n   def html\n---\n\n\n---\n\nChoice D:\nlib/http_extensions.rb\n@@ -2,9 +2,7 @@\n \n # Monkey patching until https://github.com/httprb/http/pull/757 is merged\n unless HTTP::Request::METHODS.include?(:purge)\n-  module HTTP\n-    class Request\n-      METHODS = METHODS.dup.push(:purge).freeze\n-    end\n-  end\n+  methods = HTTP::Request::METHODS.dup\n+  HTTP::Request.send(:remove_const, :METHODS)\n+  HTTP::Request.const_set(:METHODS, methods.push(:purge).freeze)\n end\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\nhttps://social.bund.de/@bfdi works as expected but a %40 encoded @ results in an error.\r\n\r\nhttps://social.bund.de/%40bfdi returns an error\r\nhttps://mastodon.social/%40Mastodon returns an error\r\n\r\n### Expected behaviour\r\n\r\nthe %40 should be rewritten to @\r\nhttps://social.bund.de/%40bfdi  -> https://social.bund.de/@bfdi \r\n\r\n### Actual behaviour\r\n\r\nerror \"The page you are looking for isn't here. \"\r\n\r\n### Detailed description\r\n\r\nthis was reported and closed in #15153 but wasn't reopened after reporting it is still an issue.\r\nThe patch #23593 does not fix it and the comments are confirming it is still a problem.\r\n\r\n### Mastodon instance\r\n\r\nhttps://social.bund.de but also https://mastodon.social\r\n\r\n### Mastodon version\r\n\r\n4.2.9\r\n\r\nsorry, if it should/could be handled different but I#m not able to reopen the closed bug #15153 \n\n---\n\nChoice A:\nbabel.config.js\n@@ -52,6 +52,10 @@ module.exports = (api) => {\n   case 'development':\n     reactOptions.development = true;\n     envOptions.debug = true;\n+\n+    // We need Babel to not inject polyfills in dev, as this breaks `preval` files\n+    envOptions.useBuiltIns = false;\n+    envOptions.corejs = undefined;\n     break;\n   }\n \n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/reducers/notifications.js\n@@ -281,7 +281,7 @@ export default function notifications(state = initialState, action) {\n   case blockAccountSuccess.type:\n     return filterNotifications(state, [action.payload.relationship.id]);\n   case muteAccountSuccess.type:\n-    return action.relationship.muting_notifications ? filterNotifications(state, [action.payload.relationship.id]) : state;\n+    return action.payload.relationship.muting_notifications ? filterNotifications(state, [action.payload.relationship.id]) : state;\n   case blockDomainSuccess.type:\n     return filterNotifications(state, action.payload.accounts);\n   case authorizeFollowRequestSuccess.type:\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -424,6 +424,10 @@ html {\n   border-bottom: 0;\n }\n \n+.column-settings__hashtags .column-select__option {\n+  color: $white;\n+}\n+\n .dashboard__quick-access,\n .focal-point__preview strong,\n .admin-wrapper .content__heading__tabs a.selected {\n---\n\n\n---\n\nChoice D:\nconfig/routes.rb\n@@ -142,7 +142,11 @@ def redirect_with_vary(path)\n \n   resource :inbox, only: [:create], module: :activitypub\n \n-  get '/:encoded_at(*path)', to: redirect('/@%{path}'), constraints: { encoded_at: /%40/ }\n+  constraints(encoded_path: /%40.*/) do\n+    get '/:encoded_path', to: redirect { |params|\n+      \"/#{params[:encoded_path].gsub('%40', '@')}\"\n+    }\n+  end\n \n   constraints(username: %r{[^@/.]+}) do\n     with_options to: 'accounts#show' do\n---\nspec/routing/accounts_routing_spec.rb\n@@ -47,6 +47,61 @@\n     end\n   end\n \n+  context 'with local username encoded at' do\n+    include RSpec::Rails::RequestExampleGroup\n+    let(:username) { 'alice' }\n+\n+    it 'routes /%40:username' do\n+      get \"/%40#{username}\"\n+      expect(response).to redirect_to(\"/@#{username}\")\n+    end\n+\n+    it 'routes /%40:username.json' do\n+      get(\"/%40#{username}.json\")\n+      expect(response).to redirect_to(\"/@#{username}.json\")\n+    end\n+\n+    it 'routes /%40:username.rss' do\n+      get(\"/%40#{username}.rss\")\n+      expect(response).to redirect_to(\"/@#{username}.rss\")\n+    end\n+\n+    it 'routes /%40:username/:id' do\n+      get(\"/%40#{username}/123\")\n+      expect(response).to redirect_to(\"/@#{username}/123\")\n+    end\n+\n+    it 'routes /%40:username/:id/embed' do\n+      get(\"/%40#{username}/123/embed\")\n+      expect(response).to redirect_to(\"/@#{username}/123/embed\")\n+    end\n+\n+    it 'routes /%40:username/following' do\n+      get(\"/%40#{username}/following\")\n+      expect(response).to redirect_to(\"/@#{username}/following\")\n+    end\n+\n+    it 'routes /%40:username/followers' do\n+      get(\"/%40#{username}/followers\")\n+      expect(response).to redirect_to(\"/@#{username}/followers\")\n+    end\n+\n+    it 'routes /%40:username/with_replies' do\n+      get(\"/%40#{username}/with_replies\")\n+      expect(response).to redirect_to(\"/@#{username}/with_replies\")\n+    end\n+\n+    it 'routes /%40:username/media' do\n+      get(\"/%40#{username}/media\")\n+      expect(response).to redirect_to(\"/@#{username}/media\")\n+    end\n+\n+    it 'routes /%40:username/tagged/:tag' do\n+      get(\"/%40#{username}/tagged/foo\")\n+      expect(response).to redirect_to(\"/@#{username}/tagged/foo\")\n+    end\n+  end\n+\n   context 'with remote username' do\n     let(:username) { 'alice@example.com' }\n \n@@ -82,4 +137,50 @@\n       expect(get(\"/@#{username}/tagged/foo\")).to route_to('home#index', username_with_domain: username, any: 'tagged/foo')\n     end\n   end\n+\n+  context 'with remote username encoded at' do\n+    include RSpec::Rails::RequestExampleGroup\n+    let(:username) { 'alice%40example.com' }\n+    let(:username_decoded) { 'alice@example.com' }\n+\n+    it 'routes /%40:username' do\n+      get(\"/%40#{username}\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}\")\n+    end\n+\n+    it 'routes /%40:username/:id' do\n+      get(\"/%40#{username}/123\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/123\")\n+    end\n+\n+    it 'routes /%40:username/:id/embed' do\n+      get(\"/%40#{username}/123/embed\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/123/embed\")\n+    end\n+\n+    it 'routes /%40:username/following' do\n+      get(\"/%40#{username}/following\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/following\")\n+    end\n+\n+    it 'routes /%40:username/followers' do\n+      get(\"/%40#{username}/followers\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/followers\")\n+    end\n+\n+    it 'routes /%40:username/with_replies' do\n+      get(\"/%40#{username}/with_replies\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/with_replies\")\n+    end\n+\n+    it 'routes /%40:username/media' do\n+      get(\"/%40#{username}/media\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/media\")\n+    end\n+\n+    it 'routes /%40:username/tagged/:tag' do\n+      get(\"/%40#{username}/tagged/foo\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/tagged/foo\")\n+    end\n+  end\n end\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n![image](https://github.com/mastodon/mastodon/assets/17537000/be8ceca9-e9f1-4924-afd9-a3e021800209)\n\n### Expected behaviour\n\nNo dead jobs\n\n### Actual behaviour\n\nDead jobs\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\naus.social\n\n### Mastodon version\n\nMain\n\n### Technical details\n\nDocker.\n\n---\n\nChoice A:\napp/javascript/mastodon/actions/notification_groups.ts\n@@ -47,7 +47,7 @@ function dispatchAssociatedRecords(\n       fetchedAccounts.push(notification.moderation_warning.target_account);\n     }\n \n-    if ('status' in notification) {\n+    if ('status' in notification && notification.status) {\n       fetchedStatuses.push(notification.status);\n     }\n   });\n@@ -119,7 +119,7 @@ export const processNewNotificationForGroups = createAppAsyncThunk(\n \n     if (\n       (notification.type === 'mention' || notification.type === 'update') &&\n-      notification.status.filtered\n+      notification.status?.filtered\n     ) {\n       const filters = notification.status.filtered.filter((result) =>\n         result.filter.context.includes('notifications'),\n---\napp/javascript/mastodon/api_types/notifications.ts\n@@ -60,12 +60,12 @@ export interface BaseNotificationGroupJSON {\n \n interface NotificationGroupWithStatusJSON extends BaseNotificationGroupJSON {\n   type: NotificationWithStatusType;\n-  status_id: string;\n+  status_id: string | null;\n }\n \n interface NotificationWithStatusJSON extends BaseNotificationJSON {\n   type: NotificationWithStatusType;\n-  status: ApiStatusJSON;\n+  status: ApiStatusJSON | null;\n }\n \n interface ReportNotificationGroupJSON extends BaseNotificationGroupJSON {\n---\napp/javascript/mastodon/features/notifications_v2/components/notification_mention.tsx\n@@ -37,7 +37,11 @@ export const NotificationMention: React.FC<{\n   unread: boolean;\n }> = ({ notification, unread }) => {\n   const [isDirect, isReply] = useAppSelector((state) => {\n-    const status = state.statuses.get(notification.statusId) as Status;\n+    const status = state.statuses.get(notification.statusId) as\n+      | Status\n+      | undefined;\n+\n+    if (!status) return [false, false] as const;\n \n     return [\n       status.get('visibility') === 'direct',\n---\napp/javascript/mastodon/features/notifications_v2/components/notification_with_status.tsx\n@@ -23,7 +23,7 @@ export const NotificationWithStatus: React.FC<{\n   icon: IconProp;\n   iconId: string;\n   accountIds: string[];\n-  statusId: string;\n+  statusId: string | undefined;\n   count: number;\n   labelRenderer: LabelRenderer;\n   unread: boolean;\n@@ -76,6 +76,8 @@ export const NotificationWithStatus: React.FC<{\n     [dispatch, statusId],\n   );\n \n+  if (!statusId) return null;\n+\n   return (\n     <HotKeys handlers={handlers}>\n       <div\n---\napp/javascript/mastodon/models/notification_group.ts\n@@ -21,7 +21,7 @@ interface BaseNotificationGroup\n interface BaseNotificationWithStatus<Type extends NotificationWithStatusType>\n   extends BaseNotificationGroup {\n   type: Type;\n-  statusId: string;\n+  statusId: string | undefined;\n }\n \n interface BaseNotification<Type extends NotificationType>\n@@ -126,7 +126,7 @@ export function createNotificationGroupFromJSON(\n     case 'update': {\n       const { status_id: statusId, ...groupWithoutStatus } = group;\n       return {\n-        statusId,\n+        statusId: statusId ?? undefined,\n         sampleAccountIds,\n         ...groupWithoutStatus,\n       };\n@@ -183,7 +183,7 @@ export function createNotificationGroupFromNotificationJSON(\n     case 'mention':\n     case 'poll':\n     case 'update':\n-      return { ...group, statusId: notification.status.id };\n+      return { ...group, statusId: notification.status?.id };\n     case 'admin.report':\n       return { ...group, report: createReportFromJSON(notification.report) };\n     case 'severed_relationships':\n---\n\n\n---\n\nChoice B:\napp/lib/link_details_extractor.rb\n@@ -156,11 +156,11 @@ def height\n   end\n \n   def title\n-    html_entities.decode(structured_data&.headline || opengraph_tag('og:title') || document.xpath('//title').map(&:content).first).strip\n+    html_entities_decode(structured_data&.headline || opengraph_tag('og:title') || document.xpath('//title').map(&:content).first).strip\n   end\n \n   def description\n-    html_entities.decode(structured_data&.description || opengraph_tag('og:description') || meta_tag('description'))\n+    html_entities_decode(structured_data&.description || opengraph_tag('og:description') || meta_tag('description'))\n   end\n \n   def published_at\n@@ -180,15 +180,15 @@ def canonical_url\n   end\n \n   def provider_name\n-    html_entities.decode(structured_data&.publisher_name || opengraph_tag('og:site_name'))\n+    html_entities_decode(structured_data&.publisher_name || opengraph_tag('og:site_name'))\n   end\n \n   def provider_url\n     valid_url_or_nil(host_to_url(opengraph_tag('og:site')))\n   end\n \n   def author_name\n-    html_entities.decode(structured_data&.author_name || opengraph_tag('og:author') || opengraph_tag('og:author:username'))\n+    html_entities_decode(structured_data&.author_name || opengraph_tag('og:author') || opengraph_tag('og:author:username'))\n   end\n \n   def author_url\n@@ -257,7 +257,7 @@ def structured_data\n \n       next if json_ld.blank?\n \n-      structured_data = StructuredData.new(html_entities.decode(json_ld))\n+      structured_data = StructuredData.new(html_entities_decode(json_ld))\n \n       next unless structured_data.valid?\n \n@@ -273,10 +273,11 @@ def document\n   end\n \n   def detect_encoding_and_parse_document\n-    [detect_encoding, nil, @html_charset, 'UTF-8'].uniq.each do |encoding|\n+    [detect_encoding, nil, @html_charset].uniq.each do |encoding|\n       document = Nokogiri::HTML(@html, nil, encoding)\n       return document if document.to_s.valid_encoding?\n     end\n+    Nokogiri::HTML(@html, nil, 'UTF-8')\n   end\n \n   def detect_encoding\n@@ -290,6 +291,15 @@ def detector\n     end\n   end\n \n+  def html_entities_decode(string)\n+    return if string.nil?\n+\n+    unicode_string = string.encode('UTF-8')\n+    raise EncodingError, 'cannot convert string to valid UTF-8' unless unicode_string.valid_encoding?\n+\n+    html_entities.decode(unicode_string)\n+  end\n+\n   def html_entities\n     @html_entities ||= HTMLEntities.new(:expanded)\n   end\n---\napp/services/fetch_link_card_service.rb\n@@ -32,7 +32,7 @@ def call(status)\n     end\n \n     attach_card if @card&.persisted?\n-  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError, Encoding::UndefinedConversionError => e\n+  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError, EncodingError => e\n     Rails.logger.debug { \"Error fetching link #{@original_url}: #{e}\" }\n     nil\n   end\n---\nspec/fixtures/requests/latin1_posing_as_utf8_broken.txt\n@@ -0,0 +1,17 @@\n+HTTP/1.1 200 OK\n+server: nginx\n+date: Thu, 13 Jun 2024 14:33:13 GMT\n+content-type: text/html; charset=utf-8\n+content-length: 158\n+accept-ranges: bytes\n+\n+<!doctype html>\n+<html lang=\"en\">\n+<head>\n+  <meta charset=\"UTF-8\">\n+  <title>Tofu \ufffd l'orange</title>\n+</head>\n+<body>\n+  <h2>Tofu \ufffd l'orange</h2>\n+</body>\n+</html>\n---\nspec/fixtures/requests/latin1_posing_as_utf8_recoverable.txt\n@@ -0,0 +1,17 @@\n+HTTP/1.1 200 OK\n+server: nginx\n+date: Thu, 13 Jun 2024 14:33:13 GMT\n+content-type: text/html; charset=utf-8\n+content-length: 158\n+accept-ranges: bytes\n+\n+<!doctype html>\n+<html lang=\"en\">\n+<head>\n+  <meta charset=\"UTF-8\">\n+  <title>Tofu with orange sauce</title>\n+</head>\n+<body>\n+  <h2>Tofu \ufffd l'orange</h2>\n+</body>\n+</html>\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -27,6 +27,8 @@\n     stub_request(:get, 'http://example.com/koi8-r').to_return(request_fixture('koi8-r.txt'))\n     stub_request(:get, 'http://example.com/windows-1251').to_return(request_fixture('windows-1251.txt'))\n     stub_request(:get, 'http://example.com/low_confidence_latin1').to_return(request_fixture('low_confidence_latin1.txt'))\n+    stub_request(:get, 'http://example.com/latin1_posing_as_utf8_broken').to_return(request_fixture('latin1_posing_as_utf8_broken.txt'))\n+    stub_request(:get, 'http://example.com/latin1_posing_as_utf8_recoverable').to_return(request_fixture('latin1_posing_as_utf8_recoverable.txt'))\n     stub_request(:get, 'http://example.com/aergerliche-umlaute').to_return(request_fixture('redirect_with_utf8_url.txt'))\n \n     Rails.cache.write('oembed_endpoint:example.com', oembed_cache) if oembed_cache\n@@ -159,10 +161,30 @@\n     end\n \n     context 'with a URL of a page in ISO-8859-1 encoding, that charlock_holmes cannot detect' do\n-      let(:status) { Fabricate(:status, text: 'Check out http://example.com/low_confidence_latin1') }\n+      context 'when encoding in http header is correct' do\n+        let(:status) { Fabricate(:status, text: 'Check out http://example.com/low_confidence_latin1') }\n \n-      it 'decodes the HTML' do\n-        expect(status.preview_card.title).to eq(\"Tofu \u00e1 l'orange\")\n+        it 'decodes the HTML' do\n+          expect(status.preview_card.title).to eq(\"Tofu \u00e1 l'orange\")\n+        end\n+      end\n+\n+      context 'when encoding in http header is incorrect' do\n+        context 'when encoding problems appear in unrelated tags' do\n+          let(:status) { Fabricate(:status, text: 'Check out http://example.com/latin1_posing_as_utf8_recoverable') }\n+\n+          it 'decodes the HTML' do\n+            expect(status.preview_card.title).to eq('Tofu with orange sauce')\n+          end\n+        end\n+\n+        context 'when encoding problems appear in title tag' do\n+          let(:status) { Fabricate(:status, text: 'Check out http://example.com/latin1_posing_as_utf8_broken') }\n+\n+          it 'does not create a preview card' do\n+            expect(status.preview_card).to be_nil\n+          end\n+        end\n       end\n     end\n \n---\n\n\n---\n\nChoice C:\napp/lib/link_details_extractor.rb\n@@ -37,6 +37,7 @@ def description\n \n     def language\n       lang = json['inLanguage']\n+      lang = lang.first if lang.is_a?(Array)\n       lang.is_a?(Hash) ? (lang['alternateName'] || lang['name']) : lang\n     end\n \n---\n\n\n---\n\nChoice D:\napp/models/custom_emoji.rb\n@@ -39,7 +39,7 @@ class CustomEmoji < ApplicationRecord\n \n   has_one :local_counterpart, -> { where(domain: nil) }, class_name: 'CustomEmoji', primary_key: :shortcode, foreign_key: :shortcode, inverse_of: false, dependent: nil\n \n-  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' } }, validate_media_type: false\n+  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp', file_geometry_parser: FastGeometryParser } }, validate_media_type: false, processors: [:lazy_thumbnail]\n \n   normalizes :domain, with: ->(domain) { domain.downcase }\n \n---\nspec/models/custom_emoji_spec.rb\n@@ -2,7 +2,7 @@\n \n require 'rails_helper'\n \n-RSpec.describe CustomEmoji do\n+RSpec.describe CustomEmoji, :paperclip_processing do\n   describe '#search' do\n     subject { described_class.search(search_term) }\n \n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\nStarting seeing a lot of these appear recently, connected to links posted by https://mastodon.social/@ukraineforum\r\n\r\n`\"\\xC3\" from ASCII-8BIT to UTF-8 on https://ukraineforum.de/unterstaatssekret%C3%A4r-au%C3%9Fenministerium-gespr%C3%A4chen-kyjiw-eingetroffen-t160676.html?mtm_source=mastodon&mtm_medium=social&mtm_campaign=ma`\r\n\r\nEncoding fixes just added in #30780 did not cover these.\r\n\r\n### Expected behaviour\r\n\r\nNo encoding errors\r\n\r\n### Actual behaviour\r\n\r\nErrors\r\n\r\n### Detailed description\r\n\r\n![CleanShot 2024-06-21 at 08 05 33@2x](https://github.com/mastodon/mastodon/assets/3002053/19bdeb63-4587-4d0f-b62b-b50a8eed5c2b)\r\n\r\n\r\n### Mastodon instance\r\n\r\nvmst.io\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-alpha.4\r\n\r\n### Technical details\r\n\r\n- Mastodon\t4.3.0-alpha.4+pr-30780\r\n- Ruby\t3.3.3p89\r\n- PostgreSQL\t16.3\r\n- Redis\t7.2.4\r\n- OpenSearch\t2.14.0\r\n- libvips\t8.15.2\r\n- FFmpeg\t7.0.1\n\n---\n\nChoice A:\napp/javascript/mastodon/components/dropdown_menu.jsx\n@@ -257,7 +257,7 @@ class Dropdown extends PureComponent {\n   };\n \n   findTarget = () => {\n-    return this.target?.buttonRef?.current;\n+    return this.target?.buttonRef?.current ?? this.target;\n   };\n \n   componentWillUnmount = () => {\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/components/status_action_bar.jsx\n@@ -375,20 +375,29 @@ class StatusActionBar extends ImmutablePureComponent {\n \n     return (\n       <div className='status__action-bar'>\n-        <IconButton className='status__action-bar__button' title={replyTitle} icon={isReply ? 'reply' : replyIcon} iconComponent={isReply ? ReplyIcon : replyIconComponent} onClick={this.handleReplyClick} counter={status.get('replies_count')} />\n-        <IconButton className={classNames('status__action-bar__button', { reblogPrivate })} disabled={!publicStatus && !reblogPrivate} active={status.get('reblogged')} title={reblogTitle} icon='retweet' iconComponent={reblogIconComponent} onClick={this.handleReblogClick} counter={withCounters ? status.get('reblogs_count') : undefined} />\n-        <IconButton className='status__action-bar__button star-icon' animate active={status.get('favourited')} title={intl.formatMessage(messages.favourite)} icon='star' iconComponent={status.get('favourited') ? StarIcon : StarBorderIcon} onClick={this.handleFavouriteClick} counter={withCounters ? status.get('favourites_count') : undefined} />\n-        <IconButton className='status__action-bar__button bookmark-icon' disabled={!signedIn} active={status.get('bookmarked')} title={intl.formatMessage(messages.bookmark)} icon='bookmark' iconComponent={status.get('bookmarked') ? BookmarkIcon : BookmarkBorderIcon} onClick={this.handleBookmarkClick} />\n-\n-        <DropdownMenuContainer\n-          scrollKey={scrollKey}\n-          status={status}\n-          items={menu}\n-          icon='ellipsis-h'\n-          iconComponent={MoreHorizIcon}\n-          direction='right'\n-          title={intl.formatMessage(messages.more)}\n-        />\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className='status__action-bar__button' title={replyTitle} icon={isReply ? 'reply' : replyIcon} iconComponent={isReply ? ReplyIcon : replyIconComponent} onClick={this.handleReplyClick} counter={status.get('replies_count')} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className={classNames('status__action-bar__button', { reblogPrivate })} disabled={!publicStatus && !reblogPrivate} active={status.get('reblogged')} title={reblogTitle} icon='retweet' iconComponent={reblogIconComponent} onClick={this.handleReblogClick} counter={withCounters ? status.get('reblogs_count') : undefined} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className='status__action-bar__button star-icon' animate active={status.get('favourited')} title={intl.formatMessage(messages.favourite)} icon='star' iconComponent={status.get('favourited') ? StarIcon : StarBorderIcon} onClick={this.handleFavouriteClick} counter={withCounters ? status.get('favourites_count') : undefined} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className='status__action-bar__button bookmark-icon' disabled={!signedIn} active={status.get('bookmarked')} title={intl.formatMessage(messages.bookmark)} icon='bookmark' iconComponent={status.get('bookmarked') ? BookmarkIcon : BookmarkBorderIcon} onClick={this.handleBookmarkClick} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <DropdownMenuContainer\n+            scrollKey={scrollKey}\n+            status={status}\n+            items={menu}\n+            icon='ellipsis-h'\n+            iconComponent={MoreHorizIcon}\n+            direction='right'\n+            title={intl.formatMessage(messages.more)}\n+          />\n+        </div>\n       </div>\n     );\n   }\n---\napp/javascript/styles/mastodon/components.scss\n@@ -299,6 +299,10 @@\n     }\n   }\n \n+  &--with-counter {\n+    padding-inline-end: 4px;\n+  }\n+\n   &__counter {\n     display: block;\n     width: auto;\n@@ -1465,6 +1469,15 @@ body > [data-popper-placement] {\n     }\n   }\n \n+  &__action-bar__button-wrapper {\n+    flex-basis: 0;\n+    flex-grow: 1;\n+\n+    &:last-child {\n+      flex-grow: 0;\n+    }\n+  }\n+\n   &--first-in-thread {\n     border-top: 1px solid var(--background-border-color);\n   }\n---\n\n\n---\n\nChoice C:\napp/controllers/api/v1/timelines/tag_controller.rb\n@@ -1,6 +1,7 @@\n # frozen_string_literal: true\n \n class Api::V1::Timelines::TagController < Api::BaseController\n+  before_action -> { doorkeeper_authorize! :read, :'read:statuses' }, only: :show, if: :require_auth?\n   before_action :load_tag\n   after_action :insert_pagination_headers, unless: -> { @statuses.empty? }\n \n@@ -12,6 +13,10 @@ def show\n \n   private\n \n+  def require_auth?\n+    !Setting.timeline_preview\n+  end\n+\n   def load_tag\n     @tag = Tag.find_normalized(params[:id])\n   end\n---\nspec/controllers/api/v1/timelines/tag_controller_spec.rb\n@@ -5,36 +5,66 @@\n describe Api::V1::Timelines::TagController do\n   render_views\n \n-  let(:user) { Fabricate(:user) }\n+  let(:user)   { Fabricate(:user) }\n+  let(:token)  { Fabricate(:accessible_access_token, resource_owner_id: user.id, scopes: 'read:statuses') }\n \n   before do\n     allow(controller).to receive(:doorkeeper_token) { token }\n   end\n \n-  context 'with a user context' do\n-    let(:token) { Fabricate(:accessible_access_token, resource_owner_id: user.id) }\n+  describe 'GET #show' do\n+    subject do\n+      get :show, params: { id: 'test' }\n+    end\n \n-    describe 'GET #show' do\n-      before do\n-        PostStatusService.new.call(user.account, text: 'It is a #test')\n+    before do\n+      PostStatusService.new.call(user.account, text: 'It is a #test')\n+    end\n+\n+    context 'when the instance allows public preview' do\n+      context 'when the user is not authenticated' do\n+        let(:token) { nil }\n+\n+        it 'returns http success', :aggregate_failures do\n+          subject\n+\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n \n-      it 'returns http success' do\n-        get :show, params: { id: 'test' }\n-        expect(response).to have_http_status(200)\n-        expect(response.headers['Link'].links.size).to eq(2)\n+      context 'when the user is authenticated' do\n+        it 'returns http success', :aggregate_failures do\n+          subject\n+\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n     end\n-  end\n \n-  context 'without a user context' do\n-    let(:token) { Fabricate(:accessible_access_token, resource_owner_id: nil) }\n+    context 'when the instance does not allow public preview' do\n+      before do\n+        Form::AdminSettings.new(timeline_preview: false).save\n+      end\n+\n+      context 'when the user is not authenticated' do\n+        let(:token) { nil }\n+\n+        it 'returns http unauthorized' do\n+          subject\n+\n+          expect(response).to have_http_status(401)\n+        end\n+      end\n+\n+      context 'when the user is authenticated' do\n+        it 'returns http success', :aggregate_failures do\n+          subject\n \n-    describe 'GET #show' do\n-      it 'returns http success' do\n-        get :show, params: { id: 'test' }\n-        expect(response).to have_http_status(200)\n-        expect(response.headers['Link']).to be_nil\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n     end\n   end\n---\n\n\n---\n\nChoice D:\napp/services/fetch_link_card_service.rb\n@@ -29,7 +29,7 @@ def call(status)\n     end\n \n     attach_card if @card&.persisted?\n-  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError => e\n+  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError, Encoding::UndefinedConversionError => e\n     Rails.logger.debug { \"Error fetching link #{@original_url}: #{e}\" }\n     nil\n   end\n---\nspec/fixtures/requests/redirect_with_utf8_url.txt\n@@ -0,0 +1,5 @@\n+HTTP/1.1 301 Moved Permanently\n+server: nginx\n+date: Thu, 27 Jun 2024 11:04:53 GMT\n+content-type: text/html; charset=UTF-8\n+location: http://example.com/\u00e4rgerliche-umlaute.html\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -27,6 +27,7 @@\n     stub_request(:get, 'http://example.com/koi8-r').to_return(request_fixture('koi8-r.txt'))\n     stub_request(:get, 'http://example.com/windows-1251').to_return(request_fixture('windows-1251.txt'))\n     stub_request(:get, 'http://example.com/low_confidence_latin1').to_return(request_fixture('low_confidence_latin1.txt'))\n+    stub_request(:get, 'http://example.com/aergerliche-umlaute').to_return(request_fixture('redirect_with_utf8_url.txt'))\n \n     Rails.cache.write('oembed_endpoint:example.com', oembed_cache) if oembed_cache\n \n@@ -101,6 +102,14 @@\n       end\n     end\n \n+    context 'with a redirect URL with faulty encoding' do\n+      let(:status) { Fabricate(:status, text: 'http://example.com/aergerliche-umlaute') }\n+\n+      it 'does not create a preview card' do\n+        expect(status.preview_card).to be_nil\n+      end\n+    end\n+\n     context 'with a 404 URL' do\n       let(:status) { Fabricate(:status, text: 'http://example.com/not-found') }\n \n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Write a post in the web interface.\r\n2. Select the \"Delete & re-draft\" option from the ... menu.\r\n3. Post is deleted, but \"Oops an error occurred\" happens.\r\n4. Post content is lost.\r\n\r\n\n\n### Expected behaviour\n\nPost is lost\n\n### Actual behaviour\n\nPost is ready to draft\n\n### Detailed description\n\n\r\nhttps://github.com/mastodon/mastodon/assets/3002053/c136f811-2a35-4cd7-85d1-2c3f828b5191\r\n\r\n\n\n### Mastodon instance\n\nvmst.io\n\n### Mastodon version\n\nv4.3.0-alpha.4\n\n### Browser name and version\n\nMultiple\n\n### Operating system\n\nMultiple\n\n### Technical details\n\nReproduced on mastodon.online as well\n\n---\n\nChoice A:\napp/javascript/mastodon/components/hashtag_bar.jsx\n@@ -0,0 +1,50 @@\n+import PropTypes from 'prop-types';\n+import { useMemo, useState, useCallback } from 'react';\n+\n+import { FormattedMessage } from 'react-intl';\n+\n+import { Link } from 'react-router-dom';\n+\n+import ImmutablePropTypes from 'react-immutable-proptypes';\n+\n+const domParser = new DOMParser();\n+\n+// About two lines on desktop\n+const VISIBLE_HASHTAGS = 7;\n+\n+export const HashtagBar = ({ hashtags, text }) => {\n+  const renderedHashtags = useMemo(() => {\n+    const body = domParser.parseFromString(text, 'text/html').documentElement;\n+    return [].map.call(body.querySelectorAll('[rel=tag]'), node => node.textContent.toLowerCase());\n+  }, [text]);\n+\n+  const invisibleHashtags = useMemo(() => (\n+    hashtags.filter(hashtag => !renderedHashtags.some(textContent => textContent === `#${hashtag.get('name')}` || textContent === hashtag.get('name')))\n+  ), [hashtags, renderedHashtags]);\n+\n+  const [expanded, setExpanded] = useState(false);\n+  const handleClick = useCallback(() => setExpanded(true), []);\n+\n+  if (invisibleHashtags.isEmpty()) {\n+    return null;\n+  }\n+\n+  const revealedHashtags = expanded ? invisibleHashtags : invisibleHashtags.take(VISIBLE_HASHTAGS);\n+\n+  return (\n+    <div className='hashtag-bar'>\n+      {revealedHashtags.map(hashtag => (\n+        <Link key={hashtag.get('name')} to={`/tags/${hashtag.get('name')}`}>\n+          #{hashtag.get('name')}\n+        </Link>\n+      ))}\n+\n+      {!expanded && invisibleHashtags.size > VISIBLE_HASHTAGS && <button className='link-button' onClick={handleClick}><FormattedMessage id='hashtags.and_other' defaultMessage='\u2026and {count, plural, other {# more}}' values={{ count: invisibleHashtags.size - VISIBLE_HASHTAGS }} /></button>}\n+    </div>\n+  );\n+};\n+\n+HashtagBar.propTypes = {\n+  hashtags: ImmutablePropTypes.list,\n+  text: PropTypes.string,\n+};\n\\ No newline at end of file\n---\napp/javascript/mastodon/components/status.jsx\n@@ -22,6 +22,7 @@ import { displayMedia } from '../initial_state';\n import { Avatar } from './avatar';\n import { AvatarOverlay } from './avatar_overlay';\n import { DisplayName } from './display_name';\n+import { HashtagBar } from './hashtag_bar';\n import { RelativeTimestamp } from './relative_timestamp';\n import StatusActionBar from './status_action_bar';\n import StatusContent from './status_content';\n@@ -580,6 +581,8 @@ class Status extends ImmutablePureComponent {\n \n             {media}\n \n+            <HashtagBar hashtags={status.get('tags')} text={status.get('content')} />\n+\n             <StatusActionBar scrollKey={scrollKey} status={status} account={account} onFilter={matchedFilters ? this.handleFilterClick : null} {...other} />\n           </div>\n         </div>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -10,6 +10,7 @@ import ImmutablePureComponent from 'react-immutable-pure-component';\n \n import { AnimatedNumber } from 'mastodon/components/animated_number';\n import EditedTimestamp from 'mastodon/components/edited_timestamp';\n+import { HashtagBar } from 'mastodon/components/hashtag_bar';\n import { Icon }  from 'mastodon/components/icon';\n import PictureInPicturePlaceholder from 'mastodon/components/picture_in_picture_placeholder';\n \n@@ -314,6 +315,8 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           {media}\n \n+          <HashtagBar hashtags={status.get('tags')} text={status.get('content')} />\n+\n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n               <FormattedDate value={new Date(status.get('created_at'))} hour12={false} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n---\napp/javascript/mastodon/locales/en.json\n@@ -300,6 +300,7 @@\n   \"hashtag.counter_by_uses_today\": \"{count, plural, one {{counter} post} other {{counter} posts}} today\",\n   \"hashtag.follow\": \"Follow hashtag\",\n   \"hashtag.unfollow\": \"Unfollow hashtag\",\n+  \"hashtags.and_other\": \"\u2026and {count, plural, other {# more}}\",\n   \"home.actions.go_to_explore\": \"See what's trending\",\n   \"home.actions.go_to_suggestions\": \"Find people to follow\",\n   \"home.column_settings.basic\": \"Basic\",\n---\napp/javascript/styles/mastodon/components.scss\n@@ -9256,3 +9256,26 @@ noscript {\n     }\n   }\n }\n+\n+.hashtag-bar {\n+  margin-top: 16px;\n+  display: flex;\n+  flex-wrap: wrap;\n+  font-size: 14px;\n+  gap: 4px;\n+\n+  a {\n+    display: inline-flex;\n+    border-radius: 4px;\n+    background: rgba($highlight-text-color, 0.2);\n+    color: $highlight-text-color;\n+    padding: 0.4em 0.6em;\n+    text-decoration: none;\n+\n+    &:hover,\n+    &:focus,\n+    &:active {\n+      background: rgba($highlight-text-color, 0.3);\n+    }\n+  }\n+}\n---\napp/javascript/mastodon/components/status.jsx\n@@ -546,6 +546,7 @@ class Status extends ImmutablePureComponent {\n     const visibilityIcon = visibilityIconInfo[status.get('visibility')];\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n+    const expanded = !status.get('hidden')\n \n     return (\n       <HotKeys handlers={handlers}>\n@@ -574,7 +575,7 @@ class Status extends ImmutablePureComponent {\n             <StatusContent\n               status={status}\n               onClick={this.handleClick}\n-              expanded={!status.get('hidden')}\n+              expanded={expanded}\n               onExpandedToggle={this.handleExpandedToggle}\n               onTranslate={this.handleTranslate}\n               collapsible\n@@ -584,7 +585,7 @@ class Status extends ImmutablePureComponent {\n \n             {media}\n \n-            {hashtagBar}\n+            {expanded && hashtagBar}\n \n             <StatusActionBar scrollKey={scrollKey} status={status} account={account} onFilter={matchedFilters ? this.handleFilterClick : null} {...other} />\n           </div>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -293,6 +293,7 @@ class DetailedStatus extends ImmutablePureComponent {\n     }\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n+    const expanded = !status.get('hidden')\n \n     return (\n       <div style={outerStyle}>\n@@ -318,7 +319,7 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           {media}\n \n-          {hashtagBar}\n+          {expanded && hashtagBar}\n \n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/actions/timelines.js\n@@ -63,10 +63,10 @@ export function updateTimeline(timeline, status, accept) {\n export function deleteFromTimelines(id) {\n   return (dispatch, getState) => {\n     const accountId  = getState().getIn(['statuses', id, 'account']);\n-    const references = getState().get('statuses').filter(status => status.get('reblog') === id).map(status => status.get('id')).toJSON();\n+    const references = getState().get('statuses').filter(status => status.get('reblog') === id).map(status => status.get('id')).valueSeq().toJSON();\n     const reblogOf   = getState().getIn(['statuses', id, 'reblog'], null);\n \n-    dispatch(timelineDelete(id, accountId, references, reblogOf));\n+    dispatch(timelineDelete({ statusId: id, accountId, references, reblogOf }));\n   };\n }\n \n---\napp/javascript/mastodon/reducers/timelines.js\n@@ -159,7 +159,7 @@ const filterTimelines = (state, relationship, statuses) => {\n       return;\n     }\n \n-    references = statuses.filter(item => item.get('reblog') === status.get('id')).map(item => item.get('id'));\n+    references = statuses.filter(item => item.get('reblog') === status.get('id')).map(item => item.get('id')).valueSeq().toJSON();\n     state      = deleteStatus(state, status.get('id'), references, relationship.id);\n   });\n \n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/account/components/header.jsx\n@@ -265,9 +265,9 @@ class Header extends ImmutablePureComponent {\n       if (signedIn && !account.get('relationship')) { // Wait until the relationship is loaded\n         actionBtn = '';\n       } else if (account.getIn(['relationship', 'requested'])) {\n-        actionBtn = <Button className={classNames({ 'button--with-bell': bellBtn !== '' })} text={intl.formatMessage(messages.cancel_follow_request)} title={intl.formatMessage(messages.requested)} onClick={this.props.onFollow} />;\n+        actionBtn = <Button text={intl.formatMessage(messages.cancel_follow_request)} title={intl.formatMessage(messages.requested)} onClick={this.props.onFollow} />;\n       } else if (!account.getIn(['relationship', 'blocking'])) {\n-        actionBtn = <Button disabled={account.getIn(['relationship', 'blocked_by'])} className={classNames({ 'button--destructive': account.getIn(['relationship', 'following']), 'button--with-bell': bellBtn !== '' })} text={intl.formatMessage(account.getIn(['relationship', 'following']) ? messages.unfollow : messages.follow)} onClick={signedIn ? this.props.onFollow : this.props.onInteractionModal} />;\n+        actionBtn = <Button disabled={account.getIn(['relationship', 'blocked_by'])} className={classNames({ 'button--destructive': account.getIn(['relationship', 'following']) })} text={intl.formatMessage(account.getIn(['relationship', 'following']) ? messages.unfollow : messages.follow)} onClick={signedIn ? this.props.onFollow : this.props.onInteractionModal} />;\n       } else if (account.getIn(['relationship', 'blocking'])) {\n         actionBtn = <Button text={intl.formatMessage(messages.unblock, { name: account.get('username') })} onClick={this.props.onBlock} />;\n       }\n---\napp/javascript/styles/mastodon/components.scss\n@@ -170,11 +170,6 @@\n     display: block;\n     width: 100%;\n   }\n-\n-  .layout-multiple-columns &.button--with-bell {\n-    font-size: 12px;\n-    padding: 0 8px;\n-  }\n }\n \n .column__wrapper {\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/dashboard.scss\n@@ -86,9 +86,7 @@\n     color: $primary-text-color;\n     transition: all 100ms ease-in;\n     font-size: 14px;\n-    padding: 0 16px;\n-    line-height: 36px;\n-    height: 36px;\n+    padding: 8px 16px;\n     text-decoration: none;\n     margin-bottom: 4px;\n \n---\napp/javascript/styles/mastodon/dashboard.scss\n@@ -91,6 +91,7 @@\n     height: 36px;\n     text-decoration: none;\n     margin-bottom: 4px;\n+    white-space: nowrap;\n \n     &:active,\n     &:focus,\n@@ -111,6 +112,8 @@\n \n     span {\n       flex: 1 1 auto;\n+      overflow: hidden;\n+      text-overflow: ellipsis;\n     }\n \n     strong {\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. As a server admin, customize favicon using capabilities introduced in #30040\n\n### Expected behaviour\n\nUsers should be able to see the customized icon everywhere and/or admin should be able to configure the svg mask-icon separately\n\n### Actual behaviour\n\nThe svg `mask-icon` is still the mastodon logo in the mastodon brand color, so users may see it as their browser\u2019s tab icon rather than the custom one\n\n### Detailed description\n\nIdeally, the admin should be able to upload their own properly formatted vector file for the `mask-icon`, choose a color for it, and see a preview of how it would be displayed in the admin interface along with the other icons. Maybe the admin should be able to disable the mask-icon if they use a custom favicon without uploading a matching `mask-icon`.\n\n### Mastodon instance\n\nN/A\n\n### Mastodon version\n\nanything that includes #30040\n\n### Browser name and version\n\nSafari (any version)\n\n### Operating system\n\nany apple OS\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/helpers/application_helper.rb\n@@ -256,6 +256,10 @@ def app_icon_path(size = '48')\n     instance_presenter.app_icon&.file&.url(size)\n   end\n \n+  def use_mask_icon?\n+    instance_presenter.app_icon.blank?\n+  end\n+\n   private\n \n   def storage_host_var\n---\napp/views/layouts/application.html.haml\n@@ -19,7 +19,8 @@\n     - SiteUpload::APPLE_ICON_SIZES.each do |size|\n       %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: app_icon_path(size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n \n-    %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n+    - if use_mask_icon?\n+      %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n     %link{ rel: 'manifest', href: manifest_path(format: :json) }/\n     = theme_color_tags current_theme\n     %meta{ name: 'apple-mobile-web-app-capable', content: 'yes' }/\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/actions/settings.js\n@@ -20,7 +20,7 @@ export function changeSetting(path, value) {\n }\n \n const debouncedSave = debounce((dispatch, getState) => {\n-  if (getState().getIn(['settings', 'saved'])) {\n+  if (getState().getIn(['settings', 'saved']) || !getState().getIn(['meta', 'me'])) {\n     return;\n   }\n \n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/getting_started/index.jsx\n@@ -11,6 +11,7 @@ import { connect } from 'react-redux';\n \n import AlternateEmailIcon from '@/material-icons/400-24px/alternate_email.svg?react';\n import BookmarksIcon from '@/material-icons/400-24px/bookmarks-fill.svg?react';\n+import ExploreIcon from '@/material-icons/400-24px/explore.svg?react';\n import PeopleIcon from '@/material-icons/400-24px/group.svg?react';\n import HomeIcon from '@/material-icons/400-24px/home-fill.svg?react';\n import ListAltIcon from '@/material-icons/400-24px/list_alt.svg?react';\n@@ -19,7 +20,6 @@ import PersonAddIcon from '@/material-icons/400-24px/person_add.svg?react';\n import PublicIcon from '@/material-icons/400-24px/public.svg?react';\n import SettingsIcon from '@/material-icons/400-24px/settings-fill.svg?react';\n import StarIcon from '@/material-icons/400-24px/star.svg?react';\n-import TagIcon from '@/material-icons/400-24px/tag.svg?react';\n import { fetchFollowRequests } from 'mastodon/actions/accounts';\n import Column from 'mastodon/components/column';\n import ColumnHeader from 'mastodon/components/column_header';\n@@ -112,7 +112,7 @@ class GettingStarted extends ImmutablePureComponent {\n \n     if (showTrends) {\n       navItems.push(\n-        <ColumnLink key='explore' icon='explore' iconComponent={TagIcon} text={intl.formatMessage(messages.explore)} to='/explore' />,\n+        <ColumnLink key='explore' icon='explore' iconComponent={ExploreIcon} text={intl.formatMessage(messages.explore)} to='/explore' />,\n       );\n     }\n \n---\n\n\n---\n\nChoice D:\napp/models/account.rb\n@@ -112,7 +112,7 @@ class Account < ApplicationRecord\n   scope :matches_domain, ->(value) { where(arel_table[:domain].matches(\"%#{value}%\")) }\n   scope :without_unapproved, -> { left_outer_joins(:user).remote.or(left_outer_joins(:user).merge(User.approved.confirmed)) }\n   scope :searchable, -> { without_unapproved.without_suspended.where(moved_to_account_id: nil) }\n-  scope :discoverable, -> { searchable.without_silenced.where(discoverable: true).left_outer_joins(:account_stat) }\n+  scope :discoverable, -> { searchable.without_silenced.where(discoverable: true).joins(:account_stat) }\n   scope :followable_by, ->(account) { joins(arel_table.join(Follow.arel_table, Arel::Nodes::OuterJoin).on(arel_table[:id].eq(Follow.arel_table[:target_account_id]).and(Follow.arel_table[:account_id].eq(account.id))).join_sources).where(Follow.arel_table[:id].eq(nil)).joins(arel_table.join(FollowRequest.arel_table, Arel::Nodes::OuterJoin).on(arel_table[:id].eq(FollowRequest.arel_table[:target_account_id]).and(FollowRequest.arel_table[:account_id].eq(account.id))).join_sources).where(FollowRequest.arel_table[:id].eq(nil)) }\n   scope :by_recent_status, -> { includes(:account_stat).merge(AccountStat.order('last_status_at DESC NULLS LAST')).references(:account_stat) }\n   scope :by_recent_sign_in, -> { order(Arel.sql('users.current_sign_in_at DESC NULLS LAST')) }\n---\nspec/requests/api/v1/directories_spec.rb\n@@ -0,0 +1,139 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+describe 'Directories API' do\n+  let(:user)    { Fabricate(:user, confirmed_at: nil) }\n+  let(:token)   { Fabricate(:accessible_access_token, resource_owner_id: user.id, scopes: scopes) }\n+  let(:scopes)  { 'read:follows' }\n+  let(:headers) { { 'Authorization' => \"Bearer #{token.token}\" } }\n+\n+  describe 'GET /api/v1/directories' do\n+    context 'with no params' do\n+      before do\n+        local_unconfirmed_account = Fabricate(\n+          :account,\n+          domain: nil,\n+          user: Fabricate(:user, confirmed_at: nil, approved: true),\n+          username: 'local_unconfirmed'\n+        )\n+        local_unconfirmed_account.create_account_stat!\n+\n+        local_unapproved_account = Fabricate(\n+          :account,\n+          domain: nil,\n+          user: Fabricate(:user, confirmed_at: 10.days.ago),\n+          username: 'local_unapproved'\n+        )\n+        local_unapproved_account.create_account_stat!\n+        local_unapproved_account.user.update(approved: false)\n+\n+        local_undiscoverable_account = Fabricate(\n+          :account,\n+          domain: nil,\n+          user: Fabricate(:user, confirmed_at: 10.days.ago, approved: true),\n+          discoverable: false,\n+          username: 'local_undiscoverable'\n+        )\n+        local_undiscoverable_account.create_account_stat!\n+\n+        excluded_from_timeline_account = Fabricate(\n+          :account,\n+          domain: 'host.example',\n+          discoverable: true,\n+          username: 'remote_excluded_from_timeline'\n+        )\n+        excluded_from_timeline_account.create_account_stat!\n+        Fabricate(:block, account: user.account, target_account: excluded_from_timeline_account)\n+\n+        domain_blocked_account = Fabricate(\n+          :account,\n+          domain: 'test.example',\n+          discoverable: true,\n+          username: 'remote_domain_blocked'\n+        )\n+        domain_blocked_account.create_account_stat!\n+        Fabricate(:account_domain_block, account: user.account, domain: 'test.example')\n+\n+        local_discoverable_account.create_account_stat!\n+        eligible_remote_account.create_account_stat!\n+      end\n+\n+      let(:local_discoverable_account) do\n+        Fabricate(\n+          :account,\n+          domain: nil,\n+          user: Fabricate(:user, confirmed_at: 10.days.ago, approved: true),\n+          discoverable: true,\n+          username: 'local_discoverable'\n+        )\n+      end\n+\n+      let(:eligible_remote_account) do\n+        Fabricate(\n+          :account,\n+          domain: 'host.example',\n+          discoverable: true,\n+          username: 'eligible_remote'\n+        )\n+      end\n+\n+      it 'returns the local discoverable account and the remote discoverable account' do\n+        get '/api/v1/directory', headers: headers\n+\n+        expect(response).to have_http_status(200)\n+        expect(body_as_json.size).to eq(2)\n+        expect(body_as_json.pluck(:id)).to contain_exactly(eligible_remote_account.id.to_s, local_discoverable_account.id.to_s)\n+      end\n+    end\n+\n+    context 'when asking for local accounts only' do\n+      let(:user) { Fabricate(:user, confirmed_at: 10.days.ago, approved: true) }\n+      let(:local_account) { Fabricate(:account, domain: nil, user: user) }\n+      let(:remote_account) { Fabricate(:account, domain: 'host.example') }\n+\n+      before do\n+        local_account.create_account_stat!\n+        remote_account.create_account_stat!\n+      end\n+\n+      it 'returns only the local accounts' do\n+        get '/api/v1/directory', headers: headers, params: { local: '1' }\n+\n+        expect(response).to have_http_status(200)\n+        expect(body_as_json.size).to eq(1)\n+        expect(body_as_json.first[:id]).to include(local_account.id.to_s)\n+        expect(response.body).to_not include(remote_account.id.to_s)\n+      end\n+    end\n+\n+    context 'when ordered by active' do\n+      it 'returns accounts in order of most recent status activity' do\n+        old_stat = Fabricate(:account_stat, last_status_at: 1.day.ago)\n+        new_stat = Fabricate(:account_stat, last_status_at: 1.minute.ago)\n+\n+        get '/api/v1/directory', headers: headers, params: { order: 'active' }\n+\n+        expect(response).to have_http_status(200)\n+        expect(body_as_json.size).to eq(2)\n+        expect(body_as_json.first[:id]).to include(new_stat.account_id.to_s)\n+        expect(body_as_json.second[:id]).to include(old_stat.account_id.to_s)\n+      end\n+    end\n+\n+    context 'when ordered by new' do\n+      it 'returns accounts in order of creation' do\n+        account_old = Fabricate(:account_stat).account\n+        travel_to 10.seconds.from_now\n+        account_new = Fabricate(:account_stat).account\n+\n+        get '/api/v1/directory', headers: headers, params: { order: 'new' }\n+\n+        expect(response).to have_http_status(200)\n+        expect(body_as_json.size).to eq(2)\n+        expect(body_as_json.first[:id]).to include(account_new.id.to_s)\n+        expect(body_as_json.second[:id]).to include(account_old.id.to_s)\n+      end\n+    end\n+  end\n+end\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. View a post, in the advanced interface, which has a URl that triggers the `fediverse:creator` action, and a reply.\r\n2. The reply thread overlaps the icon.\r\n3. e.g. https://mastodon.social/@Edent/112580788461146395\r\n\n\n### Expected behaviour\n\nThe reply line should be lower than the icon.\n\n### Actual behaviour\n\nSee image:\n\n### Detailed description\n\n![image](https://github.com/mastodon/mastodon/assets/837136/05b158e2-1de0-4737-a392-fd58178f03dc)\r\n\r\n\r\nThis can be fixed with:\r\n\r\n```css\r\n.more-from-author {\r\n   position: relative;\r\n}\r\n```\r\n\r\n(And probably a few other ways.)\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.3.0-nightly.2024-06-06\n\n### Browser name and version\n\n126.0.1\n\n### Operating system\n\nUbuntu 22.04\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/models/status.rb\n@@ -266,7 +266,7 @@ def non_sensitive_with_media?\n   end\n \n   def reported?\n-    @reported ||= Report.where(target_account: account).unresolved.exists?(['? = ANY(status_ids)', id])\n+    @reported ||= account.targeted_reports.unresolved.exists?(['? = ANY(status_ids)', id]) || account.strikes.exists?(['? = ANY(status_ids)', id.to_s])\n   end\n \n   def emojis\n---\nspec/models/status_spec.rb\n@@ -205,6 +205,48 @@\n     end\n   end\n \n+  describe '#reported?' do\n+    context 'when the status is not reported' do\n+      it 'returns false' do\n+        expect(subject.reported?).to be false\n+      end\n+    end\n+\n+    context 'when the status is part of an open report' do\n+      before do\n+        Fabricate(:report, target_account: subject.account, status_ids: [subject.id])\n+      end\n+\n+      it 'returns true' do\n+        expect(subject.reported?).to be true\n+      end\n+    end\n+\n+    context 'when the status is part of a closed report with an account warning mentioning the account' do\n+      before do\n+        report = Fabricate(:report, target_account: subject.account, status_ids: [subject.id])\n+        report.resolve!(Fabricate(:account))\n+        Fabricate(:account_warning, target_account: subject.account, status_ids: [subject.id], report: report)\n+      end\n+\n+      it 'returns true' do\n+        expect(subject.reported?).to be true\n+      end\n+    end\n+\n+    context 'when the status is part of a closed report with an account warning not mentioning the account' do\n+      before do\n+        report = Fabricate(:report, target_account: subject.account, status_ids: [subject.id])\n+        report.resolve!(Fabricate(:account))\n+        Fabricate(:account_warning, target_account: subject.account, report: report)\n+      end\n+\n+      it 'returns false' do\n+        expect(subject.reported?).to be false\n+      end\n+    end\n+  end\n+\n   describe '.mutes_map' do\n     subject { described_class.mutes_map([status.conversation.id], account) }\n \n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/home_timeline/components/inline_follow_suggestions.jsx\n@@ -151,8 +151,13 @@ export const InlineFollowSuggestions = ({ hidden }) => {\n       return;\n     }\n \n-    setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n-    setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    if (getComputedStyle(bodyRef.current).direction === 'rtl') {\n+      setCanScrollLeft((bodyRef.current.clientWidth - bodyRef.current.scrollLeft) < bodyRef.current.scrollWidth);\n+      setCanScrollRight(bodyRef.current.scrollLeft < 0);\n+    } else {\n+      setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n+      setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    }\n   }, [setCanScrollRight, setCanScrollLeft, bodyRef]);\n \n   const handleDismiss = useCallback(() => {\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -1411,10 +1411,15 @@ body > [data-popper-placement] {\n     .audio-player,\n     .attachment-list,\n     .picture-in-picture-placeholder,\n+    .more-from-author,\n     .status-card,\n     .hashtag-bar {\n       margin-inline-start: $thread-margin;\n-      width: calc(100% - ($thread-margin));\n+      width: calc(100% - $thread-margin);\n+    }\n+\n+    .more-from-author {\n+      width: calc(100% - $thread-margin + 2px);\n     }\n \n     .status__content__read-more-button {\n@@ -4129,6 +4134,13 @@ a.status-card {\n   border-end-start-radius: 0;\n }\n \n+.status-card.bottomless .status-card__image,\n+.status-card.bottomless .status-card__image-image,\n+.status-card.bottomless .status-card__image-preview {\n+  border-end-end-radius: 0;\n+  border-end-start-radius: 0;\n+}\n+\n .status-card.expanded > a {\n   width: 100%;\n }\n@@ -10229,6 +10241,7 @@ noscript {\n }\n \n .more-from-author {\n+  box-sizing: border-box;\n   font-size: 14px;\n   color: $darker-text-color;\n   background: var(--surface-background-color);\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/list_timeline/index.jsx\n@@ -204,7 +204,7 @@ class ListTimeline extends PureComponent {\n           </div>\n \n           <div className='setting-toggle'>\n-            <Toggle id={`list-${id}-exclusive`} defaultChecked={isExclusive} onChange={this.onExclusiveToggle} />\n+            <Toggle id={`list-${id}-exclusive`} checked={isExclusive} onChange={this.onExclusiveToggle} />\n             <label htmlFor={`list-${id}-exclusive`} className='setting-toggle__label'>\n               <FormattedMessage id='lists.exclusive' defaultMessage='Hide these posts from home' />\n             </label>\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nTreat libvips failures as paperclip failures so that they are caught and handled like other media processing failures.\n\n---\n\nChoice A:\nconfig/initializers/vips.rb\n@@ -25,3 +25,11 @@\n \n   Vips.block_untrusted(true)\n end\n+\n+# In some places of the code, we rescue this exception, but we don't always\n+# load libvips, so it may be an undefined constant:\n+unless defined?(Vips)\n+  module Vips\n+    class Error < StandardError; end\n+  end\n+end\n---\n\n\n---\n\nChoice B:\napp/controllers/api/v1/timelines/tag_controller.rb\n@@ -1,6 +1,7 @@\n # frozen_string_literal: true\n \n class Api::V1::Timelines::TagController < Api::BaseController\n+  before_action -> { doorkeeper_authorize! :read, :'read:statuses' }, only: :show, if: :require_auth?\n   before_action :load_tag\n   after_action :insert_pagination_headers, unless: -> { @statuses.empty? }\n \n@@ -12,6 +13,10 @@ def show\n \n   private\n \n+  def require_auth?\n+    !Setting.timeline_preview\n+  end\n+\n   def load_tag\n     @tag = Tag.find_normalized(params[:id])\n   end\n---\nspec/controllers/api/v1/timelines/tag_controller_spec.rb\n@@ -5,36 +5,66 @@\n describe Api::V1::Timelines::TagController do\n   render_views\n \n-  let(:user) { Fabricate(:user) }\n+  let(:user)   { Fabricate(:user) }\n+  let(:token)  { Fabricate(:accessible_access_token, resource_owner_id: user.id, scopes: 'read:statuses') }\n \n   before do\n     allow(controller).to receive(:doorkeeper_token) { token }\n   end\n \n-  context 'with a user context' do\n-    let(:token) { Fabricate(:accessible_access_token, resource_owner_id: user.id) }\n+  describe 'GET #show' do\n+    subject do\n+      get :show, params: { id: 'test' }\n+    end\n \n-    describe 'GET #show' do\n-      before do\n-        PostStatusService.new.call(user.account, text: 'It is a #test')\n+    before do\n+      PostStatusService.new.call(user.account, text: 'It is a #test')\n+    end\n+\n+    context 'when the instance allows public preview' do\n+      context 'when the user is not authenticated' do\n+        let(:token) { nil }\n+\n+        it 'returns http success', :aggregate_failures do\n+          subject\n+\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n \n-      it 'returns http success' do\n-        get :show, params: { id: 'test' }\n-        expect(response).to have_http_status(200)\n-        expect(response.headers['Link'].links.size).to eq(2)\n+      context 'when the user is authenticated' do\n+        it 'returns http success', :aggregate_failures do\n+          subject\n+\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n     end\n-  end\n \n-  context 'without a user context' do\n-    let(:token) { Fabricate(:accessible_access_token, resource_owner_id: nil) }\n+    context 'when the instance does not allow public preview' do\n+      before do\n+        Form::AdminSettings.new(timeline_preview: false).save\n+      end\n+\n+      context 'when the user is not authenticated' do\n+        let(:token) { nil }\n+\n+        it 'returns http unauthorized' do\n+          subject\n+\n+          expect(response).to have_http_status(401)\n+        end\n+      end\n+\n+      context 'when the user is authenticated' do\n+        it 'returns http success', :aggregate_failures do\n+          subject\n \n-    describe 'GET #show' do\n-      it 'returns http success' do\n-        get :show, params: { id: 'test' }\n-        expect(response).to have_http_status(200)\n-        expect(response.headers['Link']).to be_nil\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n     end\n   end\n---\n\n\n---\n\nChoice C:\napp/models/concerns/account_avatar.rb\n@@ -18,7 +18,7 @@ def avatar_styles(file)\n \n   included do\n     # Avatar upload\n-    has_attached_file :avatar, styles: ->(f) { avatar_styles(f) }, convert_options: { all: '+profile \"!icc,*\" +set modify-date +set create-date' }, processors: [:lazy_thumbnail]\n+    has_attached_file :avatar, styles: ->(f) { avatar_styles(f) }, convert_options: { all: '+profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' }, processors: [:lazy_thumbnail]\n     validates_attachment_content_type :avatar, content_type: IMAGE_MIME_TYPES\n     validates_attachment_size :avatar, less_than: LIMIT\n     remotable_attachment :avatar, LIMIT, suppress_errors: false\n---\napp/models/concerns/account_header.rb\n@@ -19,7 +19,7 @@ def header_styles(file)\n \n   included do\n     # Header upload\n-    has_attached_file :header, styles: ->(f) { header_styles(f) }, convert_options: { all: '+profile \"!icc,*\" +set modify-date +set create-date' }, processors: [:lazy_thumbnail]\n+    has_attached_file :header, styles: ->(f) { header_styles(f) }, convert_options: { all: '+profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' }, processors: [:lazy_thumbnail]\n     validates_attachment_content_type :header, content_type: IMAGE_MIME_TYPES\n     validates_attachment_size :header, less_than: LIMIT\n     remotable_attachment :header, LIMIT, suppress_errors: false\n---\napp/models/custom_emoji.rb\n@@ -39,7 +39,7 @@ class CustomEmoji < ApplicationRecord\n \n   has_one :local_counterpart, -> { where(domain: nil) }, class_name: 'CustomEmoji', primary_key: :shortcode, foreign_key: :shortcode, inverse_of: false\n \n-  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set modify-date +set create-date' } }, validate_media_type: false\n+  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' } }, validate_media_type: false\n \n   before_validation :downcase_domain\n \n---\napp/models/media_attachment.rb\n@@ -171,7 +171,7 @@ class MediaAttachment < ApplicationRecord\n   DEFAULT_STYLES = [:original].freeze\n \n   GLOBAL_CONVERT_OPTIONS = {\n-    all: '-quality 90 +profile \"!icc,*\" +set modify-date -define jpeg:dct-method=float +set create-date',\n+    all: '-quality 90 +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp -define jpeg:dct-method=float',\n   }.freeze\n \n   belongs_to :account,          inverse_of: :media_attachments, optional: true\n---\napp/models/preview_card.rb\n@@ -53,7 +53,7 @@ class PreviewCard < ApplicationRecord\n   has_and_belongs_to_many :statuses\n   has_one :trend, class_name: 'PreviewCardTrend', inverse_of: :preview_card, dependent: :destroy\n \n-  has_attached_file :image, processors: [:thumbnail, :blurhash_transcoder], styles: ->(f) { image_styles(f) }, convert_options: { all: '-quality 90 +profile \"!icc,*\" +set modify-date +set create-date' }, validate_media_type: false\n+  has_attached_file :image, processors: [:thumbnail, :blurhash_transcoder], styles: ->(f) { image_styles(f) }, convert_options: { all: '-quality 90 +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' }, validate_media_type: false\n \n   validates :url, presence: true, uniqueness: true\n   validates_attachment_content_type :image, content_type: IMAGE_MIME_TYPES\n---\napp/models/preview_card_provider.rb\n@@ -27,7 +27,7 @@ class PreviewCardProvider < ApplicationRecord\n \n   validates :domain, presence: true, uniqueness: true, domain: true\n \n-  has_attached_file :icon, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set modify-date +set create-date' } }, validate_media_type: false\n+  has_attached_file :icon, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' } }, validate_media_type: false\n   validates_attachment :icon, content_type: { content_type: ICON_MIME_TYPES }, size: { less_than: LIMIT }\n   remotable_attachment :icon, LIMIT\n \n---\napp/models/site_upload.rb\n@@ -41,7 +41,7 @@ class SiteUpload < ApplicationRecord\n     mascot: {}.freeze,\n   }.freeze\n \n-  has_attached_file :file, styles: ->(file) { STYLES[file.instance.var.to_sym] }, convert_options: { all: '-coalesce +profile \"!icc,*\" +set modify-date +set create-date' }, processors: [:lazy_thumbnail, :blurhash_transcoder, :type_corrector]\n+  has_attached_file :file, styles: ->(file) { STYLES[file.instance.var.to_sym] }, convert_options: { all: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' }, processors: [:lazy_thumbnail, :blurhash_transcoder, :type_corrector]\n \n   validates_attachment_content_type :file, content_type: %r{\\Aimage/.*\\z}\n   validates :file, presence: true\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -1411,10 +1411,15 @@ body > [data-popper-placement] {\n     .audio-player,\n     .attachment-list,\n     .picture-in-picture-placeholder,\n+    .more-from-author,\n     .status-card,\n     .hashtag-bar {\n       margin-inline-start: $thread-margin;\n-      width: calc(100% - ($thread-margin));\n+      width: calc(100% - $thread-margin);\n+    }\n+\n+    .more-from-author {\n+      width: calc(100% - $thread-margin + 2px);\n     }\n \n     .status__content__read-more-button {\n@@ -4129,6 +4134,13 @@ a.status-card {\n   border-end-start-radius: 0;\n }\n \n+.status-card.bottomless .status-card__image,\n+.status-card.bottomless .status-card__image-image,\n+.status-card.bottomless .status-card__image-preview {\n+  border-end-end-radius: 0;\n+  border-end-start-radius: 0;\n+}\n+\n .status-card.expanded > a {\n   width: 100%;\n }\n@@ -10229,6 +10241,7 @@ noscript {\n }\n \n .more-from-author {\n+  box-sizing: border-box;\n   font-size: 14px;\n   color: $darker-text-color;\n   background: var(--surface-background-color);\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Request data archive\r\n2. Download archive\r\n3. Extract archive, open 'outbox.json'\r\n4. Validate JSON, which fails\r\n\r\n\r\n### Expected behaviour\r\n\r\nA single `@context` key\r\n\r\n### Actual behaviour\r\n\r\nA second `@context` key is present\r\n\r\n### Detailed description\r\n\r\nAs far as I have been able to determine, this was introduced between December 31st and February 14th, which are the dates of the two exports we can test against; the former opens and validates just fine, while the latter throws an error. If the second `@context`, which as far as I can tell contains no actual data, is removed, the file validates.\r\n\r\nThis happens both in larger exports, with over 17.000 items, as well as a small one, with just 111 'orderedItems', exported right before creating this ticket. See attached screenshot from the VDT Labs JSON Editor.\r\n\r\nComparing the dates with available releases, this may have been introduced in 4.2.4, 4.2.5, or 4.2.6?\r\n\r\n![Screenshot 2024-06-07 at 08 17 15-optimised](https://github.com/mastodon/mastodon/assets/91268/65d42d5e-dfc3-4c90-b088-8500f82c4e30)\r\n\r\n\r\n### Mastodon instance\r\n\r\nngmx.com\r\n\r\n### Mastodon version\r\n\r\nv4.2.9\r\n\r\n### Technical details\r\n\r\n```\r\n$ ruby --version\r\nruby 3.0.4p208 (2022-04-12 revision 3fa771dded) [x86_64-linux]\r\n\r\n$ node --version\r\nv16.20.2\r\n```\n\n---\n\nChoice A:\napp/helpers/application_helper.rb\n@@ -240,11 +240,16 @@ def prerender_custom_emojis(html, custom_emojis, other_options = {})\n     EmojiFormatter.new(html, custom_emojis, other_options.merge(animate: prefers_autoplay?)).to_s\n   end\n \n-  def site_icon_path(type, size = '48')\n-    icon = SiteUpload.find_by(var: type)\n-    return nil unless icon\n+  def instance_presenter\n+    @instance_presenter ||= InstancePresenter.new\n+  end\n+\n+  def favicon_path(size = '48')\n+    instance_presenter.favicon&.file&.url(size)\n+  end\n \n-    icon.file.url(size)\n+  def app_icon_path(size = '48')\n+    instance_presenter.app_icon&.file&.url(size)\n   end\n \n   private\n---\napp/presenters/instance_presenter.rb\n@@ -81,4 +81,16 @@ def thumbnail\n   def mascot\n     @mascot ||= Rails.cache.fetch('site_uploads/mascot') { SiteUpload.find_by(var: 'mascot') }\n   end\n+\n+  def favicon\n+    return @favicon if defined?(@favicon)\n+\n+    @favicon ||= Rails.cache.fetch('site_uploads/favicon') { SiteUpload.find_by(var: 'favicon') }\n+  end\n+\n+  def app_icon\n+    return @app_icon if defined?(@app_icon)\n+\n+    @app_icon ||= Rails.cache.fetch('site_uploads/app_icon') { SiteUpload.find_by(var: 'app_icon') }\n+  end\n end\n---\napp/serializers/manifest_serializer.rb\n@@ -27,7 +27,7 @@ def short_name\n \n   def icons\n     SiteUpload::ANDROID_ICON_SIZES.map do |size|\n-      src = site_icon_path('app_icon', size.to_i)\n+      src = app_icon_path(size.to_i)\n       src = URI.join(root_url, src).to_s if src.present?\n \n       {\n---\napp/views/layouts/application.html.haml\n@@ -11,13 +11,13 @@\n     - if storage_host?\n       %link{ rel: 'dns-prefetch', href: storage_host }/\n \n-    %link{ rel: 'icon', href: site_icon_path('favicon', 'ico') || '/favicon.ico', type: 'image/x-icon' }/\n+    %link{ rel: 'icon', href: favicon_path('ico') || '/favicon.ico', type: 'image/x-icon' }/\n \n     - SiteUpload::FAVICON_SIZES.each do |size|\n-      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: site_icon_path('favicon', size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n+      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: favicon_path(size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n \n     - SiteUpload::APPLE_ICON_SIZES.each do |size|\n-      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: site_icon_path('app_icon', size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n+      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: app_icon_path(size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n \n     %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n     %link{ rel: 'manifest', href: manifest_path(format: :json) }/\n---\nspec/helpers/application_helper_spec.rb\n@@ -286,26 +286,31 @@ def current_theme = 'default'\n     end\n   end\n \n-  describe '#site_icon_path' do\n+  describe 'favicon' do\n     context 'when an icon exists' do\n       let!(:favicon) { Fabricate(:site_upload, var: 'favicon') }\n+      let!(:app_icon) { Fabricate(:site_upload, var: 'app_icon') }\n \n       it 'returns the URL of the icon' do\n-        expect(helper.site_icon_path('favicon')).to eq(favicon.file.url('48'))\n+        expect(helper.favicon_path).to eq(favicon.file.url('48'))\n+        expect(helper.app_icon_path).to eq(app_icon.file.url('48'))\n       end\n \n       it 'returns the URL of the icon with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to eq(favicon.file.url('16'))\n+        expect(helper.favicon_path(16)).to eq(favicon.file.url('16'))\n+        expect(helper.app_icon_path(16)).to eq(app_icon.file.url('16'))\n       end\n     end\n \n     context 'when an icon does not exist' do\n       it 'returns nil' do\n-        expect(helper.site_icon_path('favicon')).to be_nil\n+        expect(helper.favicon_path).to be_nil\n+        expect(helper.app_icon_path).to be_nil\n       end\n \n       it 'returns nil with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to be_nil\n+        expect(helper.favicon_path(16)).to be_nil\n+        expect(helper.app_icon_path(16)).to be_nil\n       end\n     end\n   end\n---\n\n\n---\n\nChoice B:\nlib/mastodon/cli/feeds.rb\n@@ -5,6 +5,7 @@\n module Mastodon::CLI\n   class Feeds < Base\n     include Redisable\n+    include DatabaseHelper\n \n     option :all, type: :boolean, default: false\n     option :concurrency, type: :numeric, default: 5, aliases: [:c]\n@@ -44,6 +45,38 @@ def clear\n       say('OK', :green)\n     end\n \n+    desc 'vacuum', 'Remove home feeds of inactive users from Redis'\n+    long_desc <<-LONG_DESC\n+      Running this task should not be needed in most cases, as Mastodon will\n+      automatically clean up feeds from inactive accounts every day.\n+\n+      However, this task is more aggressive in order to clean up feeds that\n+      may have been missed because of bugs or database mishaps.\n+    LONG_DESC\n+    def vacuum\n+      with_read_replica do\n+        say('Deleting orphaned home feeds\u2026')\n+        redis.scan_each(match: 'feed:home:*').each_slice(1000) do |keys|\n+          ids = keys.map { |key| key.split(':')[2] }.compact_blank\n+\n+          known_ids = User.confirmed.signed_in_recently.where(account_id: ids).pluck(:account_id)\n+\n+          keys_to_delete = keys.filter { |key| known_ids.exclude?(key.split(':')[2]&.to_i) }\n+          redis.del(keys_to_delete)\n+        end\n+\n+        say('Deleting orphaned list feeds\u2026')\n+        redis.scan_each(match: 'feed:list:*').each_slice(1000) do |keys|\n+          ids = keys.map { |key| key.split(':')[2] }.compact_blank\n+\n+          known_ids = List.where(account_id: User.confirmed.signed_in_recently.select(:account_id)).where(id: ids).pluck(:id)\n+\n+          keys_to_delete = keys.filter { |key| known_ids.exclude?(key.split(':')[2]&.to_i) }\n+          redis.del(keys_to_delete)\n+        end\n+      end\n+    end\n+\n     private\n \n     def active_user_accounts\n---\n\n\n---\n\nChoice C:\napp/controllers/api/v1/admin/accounts_controller.rb\n@@ -46,8 +46,10 @@ def show\n \n   def enable\n     authorize @account.user, :enable?\n-    @account.user.enable!\n-    log_action :enable, @account.user\n+    if @account.user.disabled\n+      @account.user.enable!\n+      log_action :enable, @account.user\n+    end\n     render json: @account, serializer: REST::Admin::AccountSerializer\n   end\n \n@@ -71,15 +73,19 @@ def destroy\n \n   def unsensitive\n     authorize @account, :unsensitive?\n-    @account.unsensitize!\n-    log_action :unsensitive, @account\n+    if @account.sensitized?\n+      @account.unsensitize!\n+      log_action :unsensitive, @account\n+    end\n     render json: @account, serializer: REST::Admin::AccountSerializer\n   end\n \n   def unsilence\n     authorize @account, :unsilence?\n-    @account.unsilence!\n-    log_action :unsilence, @account\n+    if @account.silenced?\n+      @account.unsilence!\n+      log_action :unsilence, @account\n+    end\n     render json: @account, serializer: REST::Admin::AccountSerializer\n   end\n \n---\napp/controllers/api/v1/admin/reports_controller.rb\n@@ -40,29 +40,37 @@ def update\n \n   def assign_to_self\n     authorize @report, :update?\n-    @report.update!(assigned_account_id: current_account.id)\n-    log_action :assigned_to_self, @report\n+    unless @report.assigned_account_id == current_account.id\n+      @report.update!(assigned_account_id: current_account.id)\n+      log_action :assigned_to_self, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n   def unassign\n     authorize @report, :update?\n-    @report.update!(assigned_account_id: nil)\n-    log_action :unassigned, @report\n+    if @report.assigned_account_id\n+      @report.update!(assigned_account_id: nil)\n+      log_action :unassigned, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n   def reopen\n     authorize @report, :update?\n-    @report.unresolve!\n-    log_action :reopen, @report\n+    unless @report.unresolved?\n+      @report.unresolve!\n+      log_action :reopen, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n   def resolve\n     authorize @report, :update?\n-    @report.resolve!(current_account)\n-    log_action :resolve, @report\n+    unless @report.action_taken?\n+      @report.resolve!(current_account)\n+      log_action :resolve, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n---\nspec/controllers/admin/reports_controller_spec.rb\n@@ -64,7 +64,7 @@\n \n   describe 'POST #reopen' do\n     it 'reopens the report' do\n-      report = Fabricate(:report)\n+      report = Fabricate(:report, action_taken_at: 3.days.ago)\n \n       put :reopen, params: { id: report }\n       expect(response).to redirect_to(admin_report_path(report))\n@@ -89,7 +89,7 @@\n \n   describe 'POST #unassign' do\n     it 'reopens the report' do\n-      report = Fabricate(:report)\n+      report = Fabricate(:report, assigned_account_id: Account.last.id)\n \n       put :unassign, params: { id: report }\n       expect(response).to redirect_to(admin_report_path(report))\n---\napp/models/admin/account_action.rb\n@@ -132,26 +132,26 @@ def process_reports!\n \n   def handle_disable!\n     authorize(target_account.user, :disable?)\n-    log_action(:disable, target_account.user)\n     target_account.user&.disable!\n+    log_action(:disable, target_account.user)\n   end\n \n   def handle_sensitive!\n     authorize(target_account, :sensitive?)\n-    log_action(:sensitive, target_account)\n     target_account.sensitize!\n+    log_action(:sensitive, target_account)\n   end\n \n   def handle_silence!\n     authorize(target_account, :silence?)\n-    log_action(:silence, target_account)\n     target_account.silence!\n+    log_action(:silence, target_account)\n   end\n \n   def handle_suspend!\n     authorize(target_account, :suspend?)\n-    log_action(:suspend, target_account)\n     target_account.suspend!(origin: :local)\n+    log_action(:suspend, target_account)\n   end\n \n   def text_for_warning\n---\n\n\n---\n\nChoice D:\napp/services/backup_service.rb\n@@ -19,8 +19,8 @@ def call(backup)\n \n   def build_outbox_json!(file)\n     skeleton = serialize(collection_presenter, ActivityPub::CollectionSerializer)\n-    skeleton[:@context] = full_context\n-    skeleton[:orderedItems] = ['!PLACEHOLDER!']\n+    skeleton['@context'] = full_context\n+    skeleton['orderedItems'] = ['!PLACEHOLDER!']\n     skeleton = Oj.dump(skeleton)\n     prepend, append = skeleton.split('\"!PLACEHOLDER!\"')\n     add_comma = false\n---\nspec/services/backup_service_spec.rb\n@@ -55,9 +55,11 @@ def process_backup\n   end\n \n   def expect_outbox_export\n-    json = export_json(:outbox)\n+    body = export_json_raw(:outbox)\n+    json = Oj.load(body)\n \n     aggregate_failures do\n+      expect(body.scan('@context').count).to eq 1\n       expect(json['@context']).to_not be_nil\n       expect(json['type']).to eq 'OrderedCollection'\n       expect(json['totalItems']).to eq 2\n@@ -85,8 +87,12 @@ def expect_bookmarks_export\n     end\n   end\n \n+  def export_json_raw(type)\n+    read_zip_file(backup, \"#{type}.json\")\n+  end\n+\n   def export_json(type)\n-    Oj.load(read_zip_file(backup, \"#{type}.json\"))\n+    Oj.load(export_json_raw(type))\n   end\n \n   def include_create_item(status)\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Set an emoji name and select the emoji file\r\n2. Clicking Upload immediately throws an error\r\n\n\n### Expected behaviour\n\nSuccessful upload and emoji added\n\n### Actual behaviour\n\nImediate error, failed upload\n\n### Detailed description\n\nAfter #30090, when uploading an emoji file, an error is immediately thrown.\r\n\r\n```\r\nINFO -- : [747998e2-f015-4df6-9828-21284dd45a61] [paperclip] Trying to link /tmp/RackMultipart20240606-4122054-jvtb5n.gif to /tmp/727f3ea9cd9c5f222fec438bb341a8a020240606-4122054-79d0xi.gif\r\nINFO -- : [747998e2-f015-4df6-9828-21284dd45a61] Command :: identify -format '%wx%h,%[exif:orientation]' '/tmp/727f3ea9cd9c5f222fec438bb341a8a020240606-4122054-79d0xi.gif[0]' 2>/dev/null\r\nINFO -- : [747998e2-f015-4df6-9828-21284dd45a61] method=POST path=/admin/custom_emojis format=html controller=Admin::CustomEmojisController action=create status=500 allocations=3481 duration=45.68 view=0.00 db=11.68\r\nFATAL -- : [747998e2-f015-4df6-9828-21284dd45a61]\r\n[747998e2-f015-4df6-9828-21284dd45a61] Paperclip::Errors::CommandNotFoundError (Could not run the `identify` command. Please install ImageMagick.):\r\n[747998e2-f015-4df6-9828-21284dd45a61] lib/paperclip/attachment_extensions.rb:21:in `block in post_process_style'\r\n[747998e2-f015-4df6-9828-21284dd45a61] lib/paperclip/attachment_extensions.rb:20:in `each'\r\n[747998e2-f015-4df6-9828-21284dd45a61] lib/paperclip/attachment_extensions.rb:20:in `inject'\r\n[747998e2-f015-4df6-9828-21284dd45a61] lib/paperclip/attachment_extensions.rb:20:in `post_process_style'\r\n[747998e2-f015-4df6-9828-21284dd45a61] app/controllers/admin/custom_emojis_controller.rb:21:in `create'\r\n[747998e2-f015-4df6-9828-21284dd45a61] app/controllers/concerns/localized.rb:11:in `set_locale'\r\n[747998e2-f015-4df6-9828-21284dd45a61] lib/mastodon/rack_middleware.rb:9:in `call'\r\n```\r\n\r\nI enabled `libvips` and uninstalled `ImageMagick`. If emojis are meant to be processed by IM instead, I'll reinstall it again.\n\n### Mastodon instance\n\nbolha.one\n\n### Mastodon version\n\nv4.3.0-alpha.4-4655be0\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -2249,6 +2249,10 @@ a.account__display-name {\n   }\n }\n \n+.notification-follow {\n+  border-bottom: 1px solid var(--background-border-color);\n+}\n+\n .notification-group--link {\n   color: $secondary-text-color;\n   text-decoration: none;\n---\napp/javascript/styles/mastodon/admin.scss\n@@ -872,6 +872,7 @@ a.name-tag,\n \n     .account {\n       padding: 0;\n+      border: none;\n \n       &__avatar-wrapper {\n         margin-inline-start: 0;\n---\napp/javascript/styles/mastodon/components.scss\n@@ -1808,6 +1808,7 @@ body > [data-popper-placement] {\n \n .account {\n   padding: 16px;\n+  border-bottom: 1px solid var(--background-border-color);\n \n   .account__display-name {\n     flex: 1 1 auto;\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -6437,7 +6437,7 @@ a.status-card {\n   }\n \n   .dialog-option .poll__input {\n-    border-color: $inverted-text-color;\n+    border-color: $darker-text-color;\n     color: $ui-secondary-color;\n     display: inline-flex;\n     align-items: center;\n@@ -6451,13 +6451,13 @@ a.status-card {\n     &:active,\n     &:focus,\n     &:hover {\n-      border-color: lighten($inverted-text-color, 15%);\n+      border-color: $valid-value-color;\n       border-width: 4px;\n     }\n \n     &.active {\n-      border-color: $inverted-text-color;\n-      background: $inverted-text-color;\n+      border-color: $valid-value-color;\n+      background: $valid-value-color;\n     }\n   }\n \n---\n\n\n---\n\nChoice C:\napp/models/custom_emoji.rb\n@@ -39,7 +39,7 @@ class CustomEmoji < ApplicationRecord\n \n   has_one :local_counterpart, -> { where(domain: nil) }, class_name: 'CustomEmoji', primary_key: :shortcode, foreign_key: :shortcode, inverse_of: false, dependent: nil\n \n-  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' } }, validate_media_type: false\n+  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp', file_geometry_parser: FastGeometryParser } }, validate_media_type: false, processors: [:lazy_thumbnail]\n \n   normalizes :domain, with: ->(domain) { domain.downcase }\n \n---\nspec/models/custom_emoji_spec.rb\n@@ -2,7 +2,7 @@\n \n require 'rails_helper'\n \n-RSpec.describe CustomEmoji do\n+RSpec.describe CustomEmoji, :paperclip_processing do\n   describe '#search' do\n     subject { described_class.search(search_term) }\n \n---\n\n\n---\n\nChoice D:\napp/helpers/languages_helper.rb\n@@ -194,7 +194,10 @@ module LanguagesHelper\n     jbo: ['Lojban', 'la .lojban.'].freeze,\n     kab: ['Kabyle', 'Taqbaylit'].freeze,\n     ldn: ['L\u00e1adan', 'L\u00e1adan'].freeze,\n+    ltg: ['Latgalian', 'latgal\u012b\u0161u'].freeze,\n     lfn: ['Lingua Franca Nova', 'lingua franca nova'].freeze,\n+    prg: ['Prussian', 'pr\u016bsiskai'].freeze,\n+    sgs: ['Samogitian', '\u017eemaitiu'].freeze,\n     sco: ['Scots', 'Scots'].freeze,\n     sma: ['Southern Sami', '\u00c5arjelsaemien G\u00efele'].freeze,\n     smj: ['Lule Sami', 'Julevs\u00e1megiella'].freeze,\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nWhen creating a `Web::PushSubscription` via `POST /api/v1/push/subscription`, there is no validation in place for the `keys` properties, as such, it's possible to create a `Web::PushSubscription` which will cause errors in `Web::PushNotificationWorker`\n\n### Expected behaviour\n\nInvalid keys should result in a 422\n\n### Actual behaviour\n\nInvalid keys are accepted\n\n### Detailed description\n\nThis is related to #21481, where it's possible for the keys values in the `Web::PushSubscription` to not actually be valid base64 data, nor valid keys on an elliptical curve.\r\n\r\nI suspect this is what creates #28023 #29716 issues.\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\nmain\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/helpers/email_helper.rb\n@@ -6,13 +6,17 @@ def self.included(base)\n   end\n \n   def email_to_canonical_email(str)\n+    return nil if str.nil?\n+\n     username, domain = str.downcase.split('@', 2)\n     username, = username.delete('.').split('+', 2)\n \n     \"#{username}@#{domain}\"\n   end\n \n   def email_to_canonical_email_hash(str)\n+    return nil if str.nil?\n+\n     Digest::SHA2.new(256).hexdigest(email_to_canonical_email(str))\n   end\n end\n---\n\n\n---\n\nChoice B:\nstreaming/index.js\n@@ -109,6 +109,11 @@ const pgConfigFromEnv = (env) => {\n \n   if (env.DATABASE_URL) {\n     baseConfig = dbUrlToConfig(env.DATABASE_URL);\n+\n+    // Support overriding the database password in the connection URL\n+    if (!baseConfig.password && env.DB_PASS) {\n+      baseConfig.password = env.DB_PASS;\n+    }\n   } else {\n     baseConfig = pgConfigs[environment];\n \n---\n\n\n---\n\nChoice C:\napp/controllers/auth/sessions_controller.rb\n@@ -187,4 +187,15 @@ def on_authentication_failure(user, security_measure, failure_reason)\n   def second_factor_attempts_key(user)\n     \"2fa_auth_attempts:#{user.id}:#{Time.now.utc.hour}\"\n   end\n+\n+  def respond_to_on_destroy\n+    respond_to do |format|\n+      format.json do\n+        render json: {\n+          redirect_to: after_sign_out_path_for(resource_name),\n+        }, status: 200\n+      end\n+      format.all { super }\n+    end\n+  end\n end\n---\napp/javascript/mastodon/features/ui/components/confirmation_modals/log_out.tsx\n@@ -25,7 +25,7 @@ export const ConfirmLogOutModal: React.FC<BaseConfirmationModalProps> = ({\n   const intl = useIntl();\n \n   const onConfirm = useCallback(() => {\n-    logOut();\n+    void logOut();\n   }, []);\n \n   return (\n---\napp/javascript/mastodon/utils/log_out.ts\n@@ -1,36 +1,20 @@\n-export const logOut = () => {\n-  const form = document.createElement('form');\n+import api from 'mastodon/api';\n \n-  const methodInput = document.createElement('input');\n-  methodInput.setAttribute('name', '_method');\n-  methodInput.setAttribute('value', 'delete');\n-  methodInput.setAttribute('type', 'hidden');\n-  form.appendChild(methodInput);\n+export async function logOut() {\n+  try {\n+    const response = await api(false).delete<{ redirect_to?: string }>(\n+      '/auth/sign_out',\n+      { headers: { Accept: 'application/json' }, withCredentials: true },\n+    );\n \n-  const csrfToken = document.querySelector<HTMLMetaElement>(\n-    'meta[name=csrf-token]',\n-  );\n-\n-  const csrfParam = document.querySelector<HTMLMetaElement>(\n-    'meta[name=csrf-param]',\n-  );\n-\n-  if (csrfParam && csrfToken) {\n-    const csrfInput = document.createElement('input');\n-    csrfInput.setAttribute('name', csrfParam.content);\n-    csrfInput.setAttribute('value', csrfToken.content);\n-    csrfInput.setAttribute('type', 'hidden');\n-    form.appendChild(csrfInput);\n+    if (response.status === 200 && response.data.redirect_to)\n+      window.location.href = response.data.redirect_to;\n+    else\n+      console.error(\n+        'Failed to log out, got an unexpected non-redirect response from the server',\n+        response,\n+      );\n+  } catch (error) {\n+    console.error('Failed to log out, response was an error', error);\n   }\n-\n-  const submitButton = document.createElement('input');\n-  submitButton.setAttribute('type', 'submit');\n-  form.appendChild(submitButton);\n-\n-  form.method = 'post';\n-  form.action = '/auth/sign_out';\n-  form.style.display = 'none';\n-\n-  document.body.appendChild(form);\n-  submitButton.click();\n-};\n+}\n---\nspec/requests/log_out_spec.rb\n@@ -0,0 +1,30 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+describe 'Log Out' do\n+  include RoutingHelper\n+\n+  describe 'DELETE /auth/sign_out' do\n+    let(:user) { Fabricate(:user) }\n+\n+    before do\n+      sign_in user\n+    end\n+\n+    it 'Logs out the user and redirect' do\n+      delete '/auth/sign_out'\n+\n+      expect(response).to redirect_to('/auth/sign_in')\n+    end\n+\n+    it 'Logs out the user and return a page to redirect to with a JSON request' do\n+      delete '/auth/sign_out', headers: { 'HTTP_ACCEPT' => 'application/json' }\n+\n+      expect(response).to have_http_status(200)\n+      expect(response.media_type).to eq 'application/json'\n+\n+      expect(body_as_json[:redirect_to]).to eq '/auth/sign_in'\n+    end\n+  end\n+end\n---\nspec/system/log_out_spec.rb\n@@ -0,0 +1,43 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+describe 'Log out' do\n+  include ProfileStories\n+\n+  before do\n+    as_a_logged_in_user\n+  end\n+\n+  describe 'Logging out from the preferences' do\n+    it 'logs the user out' do\n+      visit settings_path\n+\n+      within '.sidebar' do\n+        click_on 'Logout'\n+      end\n+\n+      expect(page).to have_title(I18n.t('auth.login'))\n+      expect(page).to have_current_path('/auth/sign_in')\n+    end\n+  end\n+\n+  describe 'Logging out from the JS app', :js, :streaming do\n+    it 'logs the user out' do\n+      visit root_path\n+\n+      within '.navigation-bar' do\n+        click_on 'Menu'\n+      end\n+\n+      within '.dropdown-menu' do\n+        click_on 'Logout'\n+      end\n+\n+      click_on 'Log out'\n+\n+      expect(page).to have_title(I18n.t('auth.login'))\n+      expect(page).to have_current_path('/auth/sign_in')\n+    end\n+  end\n+end\n---\n\n\n---\n\nChoice D:\napp/models/web/push_subscription.rb\n@@ -21,7 +21,7 @@ class Web::PushSubscription < ApplicationRecord\n \n   has_one :session_activation, foreign_key: 'web_push_subscription_id', inverse_of: :web_push_subscription, dependent: nil\n \n-  validates :endpoint, presence: true\n+  validates :endpoint, presence: true, url: true\n   validates :key_p256dh, presence: true\n   validates :key_auth, presence: true\n \n---\nspec/requests/api/v1/push/subscriptions_spec.rb\n@@ -4,10 +4,11 @@\n \n describe 'API V1 Push Subscriptions' do\n   let(:user) { Fabricate(:user) }\n+  let(:endpoint) { 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX' }\n   let(:create_payload) do\n     {\n       subscription: {\n-        endpoint: 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX',\n+        endpoint: endpoint,\n         keys: {\n           p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n           auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n@@ -63,6 +64,18 @@\n       expect(endpoint_push_subscriptions.count)\n         .to eq(1)\n     end\n+\n+    context 'with invalid endpoint URL' do\n+      let(:endpoint) { 'app://example.foo' }\n+\n+      it 'returns a validation error' do\n+        subject\n+\n+        expect(response).to have_http_status(422)\n+        expect(endpoint_push_subscriptions.count).to eq(0)\n+        expect(endpoint_push_subscription).to be_nil\n+      end\n+    end\n   end\n \n   describe 'PUT /api/v1/push/subscription' do\n---\napp/models/web/push_subscription.rb\n@@ -25,6 +25,8 @@ class Web::PushSubscription < ApplicationRecord\n   validates :key_p256dh, presence: true\n   validates :key_auth, presence: true\n \n+  validates_with WebPushKeyValidator\n+\n   delegate :locale, to: :associated_user\n \n   def encrypt(payload)\n---\napp/validators/web_push_key_validator.rb\n@@ -0,0 +1,11 @@\n+# frozen_string_literal: true\n+\n+class WebPushKeyValidator < ActiveModel::Validator\n+  def validate(subscription)\n+    begin\n+      Webpush::Encryption.encrypt('validation_test', subscription.key_p256dh, subscription.key_auth)\n+    rescue ArgumentError, OpenSSL::PKey::EC::Point::Error\n+      subscription.errors.add(:base, I18n.t('crypto.errors.invalid_key'))\n+    end\n+  end\n+end\n---\nspec/fabricators/web_push_subscription_fabricator.rb\n@@ -2,6 +2,10 @@\n \n Fabricator(:web_push_subscription, from: Web::PushSubscription) do\n   endpoint   Faker::Internet.url\n-  key_p256dh Faker::Internet.password\n-  key_auth   Faker::Internet.password\n+  key_p256dh do\n+    curve = OpenSSL::PKey::EC.generate('prime256v1')\n+    ecdh_key = curve.public_key.to_bn.to_s(2)\n+    Base64.urlsafe_encode64(ecdh_key)\n+  end\n+  key_auth { Base64.urlsafe_encode64(Random.new.bytes(16)) }\n end\n---\nspec/requests/api/v1/push/subscriptions_spec.rb\n@@ -5,14 +5,17 @@\n describe 'API V1 Push Subscriptions' do\n   let(:user) { Fabricate(:user) }\n   let(:endpoint) { 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX' }\n+  let(:keys) do\n+    {\n+      p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n+      auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+    }\n+  end\n   let(:create_payload) do\n     {\n       subscription: {\n         endpoint: endpoint,\n-        keys: {\n-          p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n-          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n-        },\n+        keys: keys,\n       },\n     }.with_indifferent_access\n   end\n@@ -37,6 +40,16 @@\n   let(:token) { Fabricate(:accessible_access_token, resource_owner_id: user.id, scopes: scopes) }\n   let(:headers) { { 'Authorization' => \"Bearer #{token.token}\" } }\n \n+  shared_examples 'validation error' do\n+    it 'returns a validation error' do\n+      subject\n+\n+      expect(response).to have_http_status(422)\n+      expect(endpoint_push_subscriptions.count).to eq(0)\n+      expect(endpoint_push_subscription).to be_nil\n+    end\n+  end\n+\n   describe 'POST /api/v1/push/subscription' do\n     subject { post '/api/v1/push/subscription', params: create_payload, headers: headers }\n \n@@ -68,13 +81,29 @@\n     context 'with invalid endpoint URL' do\n       let(:endpoint) { 'app://example.foo' }\n \n-      it 'returns a validation error' do\n-        subject\n+      it_behaves_like 'validation error'\n+    end\n+\n+    context 'with invalid p256dh key' do\n+      let(:keys) do\n+        {\n+          p256dh: 'BEm_invalidf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n+          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+        }\n+      end\n \n-        expect(response).to have_http_status(422)\n-        expect(endpoint_push_subscriptions.count).to eq(0)\n-        expect(endpoint_push_subscription).to be_nil\n+      it_behaves_like 'validation error'\n+    end\n+\n+    context 'with invalid base64 p256dh key' do\n+      let(:keys) do\n+        {\n+          p256dh: 'not base64',\n+          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+        }\n       end\n+\n+      it_behaves_like 'validation error'\n     end\n   end\n \n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nReported on Discord, an user has memorialized accounts recommended to them in follow suggestions.\n\n### Expected behaviour\n\nThey are not recommended\n\n### Actual behaviour\n\nThey are recommended\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nrivals.space\n\n### Mastodon version\n\nLatest nightly\n\n### Browser name and version\n\n-\n\n### Operating system\n\n-\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/models/account.rb\n@@ -144,6 +144,7 @@ class Account < ApplicationRecord\n   scope :dormant, -> { joins(:account_stat).merge(AccountStat.without_recent_activity) }\n   scope :with_username, ->(value) { where arel_table[:username].lower.eq(value.to_s.downcase) }\n   scope :with_domain, ->(value) { where arel_table[:domain].lower.eq(value&.to_s&.downcase) }\n+  scope :without_memorial, -> { where(memorial: false) }\n \n   after_update_commit :trigger_update_webhooks\n \n---\napp/models/account_suggestions/friends_of_friends_source.rb\n@@ -31,6 +31,7 @@ def source_query(account, limit: DEFAULT_LIMIT)\n         AND accounts.suspended_at IS NULL\n         AND accounts.silenced_at IS NULL\n         AND accounts.moved_to_account_id IS NULL\n+        AND accounts.memorial = FALSE\n         AND follow_recommendation_mutes.target_account_id IS NULL\n       GROUP BY accounts.id, account_stats.id\n       ORDER BY frequency DESC, account_stats.followers_count ASC\n---\napp/models/account_suggestions/source.rb\n@@ -14,6 +14,7 @@ def base_account_scope(account)\n       .searchable\n       .where(discoverable: true)\n       .without_silenced\n+      .without_memorial\n       .where.not(follows_sql, id: account.id)\n       .where.not(follow_requests_sql, id: account.id)\n       .not_excluded_by_account(account)\n---\nspec/models/account_suggestions/friends_of_friends_source_spec.rb\n@@ -15,6 +15,7 @@\n     let!(:john) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:jerk) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:larry) { Fabricate(:account, discoverable: true, hide_collections: false) }\n+    let!(:morty) { Fabricate(:account, discoverable: true, hide_collections: false, memorial: true) }\n \n     context 'with follows and blocks' do\n       before do\n@@ -27,8 +28,8 @@\n         # alice follows eve and mallory\n         [john, mallory].each { |account| alice.follow!(account) }\n \n-        # eugen follows eve, john, jerk, larry and neil\n-        [eve, mallory, jerk, larry, neil].each { |account| eugen.follow!(account) }\n+        # eugen follows eve, john, jerk, larry, neil and morty\n+        [eve, mallory, jerk, larry, neil, morty].each { |account| eugen.follow!(account) }\n       end\n \n       it 'returns eligible accounts', :aggregate_failures do\n@@ -51,6 +52,9 @@\n \n         # the suggestion for neil has already been rejected\n         expect(results).to_not include([neil.id, :friends_of_friends])\n+\n+        # morty is not included because his account is in memoriam\n+        expect(results).to_not include([morty.id, :friends_of_friends])\n       end\n     end\n \n---\nspec/models/account_suggestions/source_spec.rb\n@@ -21,6 +21,7 @@\n       let!(:moved_account) { Fabricate(:account, moved_to_account: Fabricate(:account), discoverable: true) }\n       let!(:silenced_account) { Fabricate(:account, silenced: true, discoverable: true) }\n       let!(:undiscoverable_account) { Fabricate(:account, discoverable: false) }\n+      let!(:memorial_account) { Fabricate(:account, memorial: true, discoverable: true) }\n \n       before do\n         Fabricate :account_domain_block, account: account, domain: account_domain_blocked_account.domain\n@@ -44,6 +45,7 @@\n           .and not_include(moved_account)\n           .and not_include(silenced_account)\n           .and not_include(undiscoverable_account)\n+          .and not_include(memorial_account)\n       end\n     end\n   end\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/components/status_action_bar.jsx\n@@ -375,20 +375,29 @@ class StatusActionBar extends ImmutablePureComponent {\n \n     return (\n       <div className='status__action-bar'>\n-        <IconButton className='status__action-bar__button' title={replyTitle} icon={isReply ? 'reply' : replyIcon} iconComponent={isReply ? ReplyIcon : replyIconComponent} onClick={this.handleReplyClick} counter={status.get('replies_count')} />\n-        <IconButton className={classNames('status__action-bar__button', { reblogPrivate })} disabled={!publicStatus && !reblogPrivate} active={status.get('reblogged')} title={reblogTitle} icon='retweet' iconComponent={reblogIconComponent} onClick={this.handleReblogClick} counter={withCounters ? status.get('reblogs_count') : undefined} />\n-        <IconButton className='status__action-bar__button star-icon' animate active={status.get('favourited')} title={intl.formatMessage(messages.favourite)} icon='star' iconComponent={status.get('favourited') ? StarIcon : StarBorderIcon} onClick={this.handleFavouriteClick} counter={withCounters ? status.get('favourites_count') : undefined} />\n-        <IconButton className='status__action-bar__button bookmark-icon' disabled={!signedIn} active={status.get('bookmarked')} title={intl.formatMessage(messages.bookmark)} icon='bookmark' iconComponent={status.get('bookmarked') ? BookmarkIcon : BookmarkBorderIcon} onClick={this.handleBookmarkClick} />\n-\n-        <DropdownMenuContainer\n-          scrollKey={scrollKey}\n-          status={status}\n-          items={menu}\n-          icon='ellipsis-h'\n-          iconComponent={MoreHorizIcon}\n-          direction='right'\n-          title={intl.formatMessage(messages.more)}\n-        />\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className='status__action-bar__button' title={replyTitle} icon={isReply ? 'reply' : replyIcon} iconComponent={isReply ? ReplyIcon : replyIconComponent} onClick={this.handleReplyClick} counter={status.get('replies_count')} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className={classNames('status__action-bar__button', { reblogPrivate })} disabled={!publicStatus && !reblogPrivate} active={status.get('reblogged')} title={reblogTitle} icon='retweet' iconComponent={reblogIconComponent} onClick={this.handleReblogClick} counter={withCounters ? status.get('reblogs_count') : undefined} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className='status__action-bar__button star-icon' animate active={status.get('favourited')} title={intl.formatMessage(messages.favourite)} icon='star' iconComponent={status.get('favourited') ? StarIcon : StarBorderIcon} onClick={this.handleFavouriteClick} counter={withCounters ? status.get('favourites_count') : undefined} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className='status__action-bar__button bookmark-icon' disabled={!signedIn} active={status.get('bookmarked')} title={intl.formatMessage(messages.bookmark)} icon='bookmark' iconComponent={status.get('bookmarked') ? BookmarkIcon : BookmarkBorderIcon} onClick={this.handleBookmarkClick} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <DropdownMenuContainer\n+            scrollKey={scrollKey}\n+            status={status}\n+            items={menu}\n+            icon='ellipsis-h'\n+            iconComponent={MoreHorizIcon}\n+            direction='right'\n+            title={intl.formatMessage(messages.more)}\n+          />\n+        </div>\n       </div>\n     );\n   }\n---\napp/javascript/styles/mastodon/components.scss\n@@ -299,6 +299,10 @@\n     }\n   }\n \n+  &--with-counter {\n+    padding-inline-end: 4px;\n+  }\n+\n   &__counter {\n     display: block;\n     width: auto;\n@@ -1465,6 +1469,15 @@ body > [data-popper-placement] {\n     }\n   }\n \n+  &__action-bar__button-wrapper {\n+    flex-basis: 0;\n+    flex-grow: 1;\n+\n+    &:last-child {\n+      flex-grow: 0;\n+    }\n+  }\n+\n   &--first-in-thread {\n     border-top: 1px solid var(--background-border-color);\n   }\n---\n\n\n---\n\nChoice C:\napp/lib/link_details_extractor.rb\n@@ -269,16 +269,21 @@ def structured_data\n   end\n \n   def document\n-    @document ||= Nokogiri::HTML(@html, nil, encoding)\n+    @document ||= detect_encoding_and_parse_document\n   end\n \n-  def encoding\n-    @encoding ||= begin\n-      guess = detector.detect(@html, @html_charset)\n-      guess&.fetch(:confidence, 0).to_i > 60 ? guess&.fetch(:encoding, nil) : nil\n+  def detect_encoding_and_parse_document\n+    [detect_encoding, nil, @html_charset, 'UTF-8'].uniq.each do |encoding|\n+      document = Nokogiri::HTML(@html, nil, encoding)\n+      return document if document.to_s.valid_encoding?\n     end\n   end\n \n+  def detect_encoding\n+    guess = detector.detect(@html, @html_charset)\n+    guess&.fetch(:confidence, 0).to_i > 60 ? guess&.fetch(:encoding, nil) : nil\n+  end\n+\n   def detector\n     @detector ||= CharlockHolmes::EncodingDetector.new.tap do |detector|\n       detector.strip_tags = true\n---\nspec/fixtures/requests/low_confidence_latin1.txt\n@@ -0,0 +1,17 @@\n+HTTP/1.1 200 OK\n+server: nginx\n+date: Thu, 13 Jun 2024 14:33:13 GMT\n+content-type: text/html; charset=ISO-8859-1\n+content-length: 158\n+accept-ranges: bytes\n+\n+<!doctype html>\n+<html lang=\"en\">\n+<head>\n+  <meta charset=\"UTF-8\">\n+  <title>Tofu \ufffd l'orange</title>\n+</head>\n+<body>\n+  <h2>Tofu \ufffd l'orange</h2>\n+</body>\n+</html>\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -26,6 +26,7 @@\n     stub_request(:get, 'http://example.com/sjis_with_wrong_charset').to_return(request_fixture('sjis_with_wrong_charset.txt'))\n     stub_request(:get, 'http://example.com/koi8-r').to_return(request_fixture('koi8-r.txt'))\n     stub_request(:get, 'http://example.com/windows-1251').to_return(request_fixture('windows-1251.txt'))\n+    stub_request(:get, 'http://example.com/low_confidence_latin1').to_return(request_fixture('low_confidence_latin1.txt'))\n \n     Rails.cache.write('oembed_endpoint:example.com', oembed_cache) if oembed_cache\n \n@@ -148,6 +149,14 @@\n       end\n     end\n \n+    context 'with a URL of a page in ISO-8859-1 encoding, that charlock_holmes cannot detect' do\n+      let(:status) { Fabricate(:status, text: 'Check out http://example.com/low_confidence_latin1') }\n+\n+      it 'decodes the HTML' do\n+        expect(status.preview_card.title).to eq(\"Tofu \u00e1 l'orange\")\n+      end\n+    end\n+\n     context 'with a Japanese path URL' do\n       let(:status) { Fabricate(:status, text: '\u30c6\u30b9\u30c8http://example.com/\u65e5\u672c\u8a9e') }\n \n---\n\n\n---\n\nChoice D:\napp/workers/web/push_notification_worker.rb\n@@ -55,12 +55,8 @@ def web_push_request\n   end\n \n   def push_notification_json\n-    Oj.dump(serialized_notification_in_subscription_locale.as_json)\n-  end\n-\n-  def serialized_notification_in_subscription_locale\n     I18n.with_locale(@subscription.locale.presence || I18n.default_locale) do\n-      serialized_notification\n+      Oj.dump(serialized_notification.as_json)\n     end\n   end\n \n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nAlternative to https://github.com/mastodon/mastodon/pull/20206\r\n\r\nFirst three commits are prep work (reasons should be clear from messages), last commit is actual change.\n\n---\n\nChoice A:\nconfig/initializers/paperclip.rb\n@@ -88,6 +88,19 @@\n \n   Paperclip::Attachment.default_options[:s3_headers]['X-Amz-Storage-Class'] = ENV['S3_STORAGE_CLASS'] if ENV.has_key?('S3_STORAGE_CLASS')\n \n+  # Some S3 providers are not compatible with the checksum mode\n+  # See https://github.com/mastodon/mastodon/issues/26394\n+  if ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n+    module Aws::S3::FileDownloaderExtensions\n+      def validate!\n+        @params.delete(:checksum_mode)\n+        super\n+      end\n+    end\n+\n+    Aws::S3::FileDownloader.prepend(Aws::S3::FileDownloaderExtensions)\n+  end\n+\n   # Some S3-compatible providers might not actually be compatible with some APIs\n   # used by kt-paperclip, see https://github.com/mastodon/mastodon/issues/16822\n   if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n---\nconfig/initializers/paperclip.rb\n@@ -90,13 +90,19 @@\n \n   # Some S3-compatible providers might not actually be compatible with some APIs\n   # used by kt-paperclip, see https://github.com/mastodon/mastodon/issues/16822\n-  if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n+  # and https://github.com/mastodon/mastodon/issues/26394\n+  if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true' || ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n     module Paperclip\n       module Storage\n         module S3Extensions\n           def copy_to_local_file(style, local_dest_path)\n             log(\"copying #{path(style)} to local file #{local_dest_path}\")\n-            s3_object(style).download_file(local_dest_path, { mode: 'single_request' })\n+\n+            options = {}\n+            options[:mode] = 'single_request' if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n+            options[:checksum_mode] = 'DISABLED' if ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n+\n+            s3_object(style).download_file(local_dest_path, options)\n           rescue Aws::Errors::ServiceError => e\n             warn(\"#{e} - cannot copy #{path(style)} to local file #{local_dest_path}\")\n             false\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -4,8 +4,6 @@ import { Children, cloneElement, useCallback } from 'react';\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import ImmutablePureComponent from 'react-immutable-pure-component';\n \n-import { supportsPassiveEvents } from 'detect-passive-events';\n-\n import { scrollRight } from '../../../scroll';\n import BundleContainer from '../containers/bundle_container';\n import {\n@@ -71,10 +69,6 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   };\n \n   componentDidMount() {\n-    if (!this.props.singleColumn) {\n-      this.node.addEventListener('wheel', this.handleWheel, supportsPassiveEvents ? { passive: true } : false);\n-    }\n-\n     if (this.mediaQuery) {\n       if (this.mediaQuery.addEventListener) {\n         this.mediaQuery.addEventListener('change', this.handleLayoutChange);\n@@ -87,23 +81,7 @@ export default class ColumnsArea extends ImmutablePureComponent {\n     this.isRtlLayout = document.getElementsByTagName('body')[0].classList.contains('rtl');\n   }\n \n-  UNSAFE_componentWillUpdate(nextProps) {\n-    if (this.props.singleColumn !== nextProps.singleColumn && nextProps.singleColumn) {\n-      this.node.removeEventListener('wheel', this.handleWheel);\n-    }\n-  }\n-\n-  componentDidUpdate(prevProps) {\n-    if (this.props.singleColumn !== prevProps.singleColumn && !this.props.singleColumn) {\n-      this.node.addEventListener('wheel', this.handleWheel, supportsPassiveEvents ? { passive: true } : false);\n-    }\n-  }\n-\n   componentWillUnmount () {\n-    if (!this.props.singleColumn) {\n-      this.node.removeEventListener('wheel', this.handleWheel);\n-    }\n-\n     if (this.mediaQuery) {\n       if (this.mediaQuery.removeEventListener) {\n         this.mediaQuery.removeEventListener('change', this.handleLayoutChange);\n@@ -116,22 +94,14 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   handleChildrenContentChange() {\n     if (!this.props.singleColumn) {\n       const modifier = this.isRtlLayout ? -1 : 1;\n-      this._interruptScrollAnimation = scrollRight(this.node, (this.node.scrollWidth - window.innerWidth) * modifier);\n+      scrollRight(this.node, (this.node.scrollWidth - window.innerWidth) * modifier);\n     }\n   }\n \n   handleLayoutChange = (e) => {\n     this.setState({ renderComposePanel: !e.matches });\n   };\n \n-  handleWheel = () => {\n-    if (typeof this._interruptScrollAnimation !== 'function') {\n-      return;\n-    }\n-\n-    this._interruptScrollAnimation();\n-  };\n-\n   setRef = (node) => {\n     this.node = node;\n   };\n---\napp/javascript/mastodon/scroll.ts\n@@ -38,13 +38,20 @@ const scroll = (\n const isScrollBehaviorSupported =\n   'scrollBehavior' in document.documentElement.style;\n \n-export const scrollRight = (node: Element, position: number) => {\n-  if (isScrollBehaviorSupported)\n-    node.scrollTo({ left: position, behavior: 'smooth' });\n-  else scroll(node, 'scrollLeft', position);\n-};\n-\n-export const scrollTop = (node: Element) => {\n-  if (isScrollBehaviorSupported) node.scrollTo({ top: 0, behavior: 'smooth' });\n-  else scroll(node, 'scrollTop', 0);\n-};\n+export const scrollRight = (node: Element, position: number) =>\n+  requestIdleCallback(() => {\n+    if (isScrollBehaviorSupported) {\n+      node.scrollTo({ left: position, behavior: 'smooth' });\n+    } else {\n+      scroll(node, 'scrollLeft', position);\n+    }\n+  });\n+\n+export const scrollTop = (node: Element) =>\n+  requestIdleCallback(() => {\n+    if (isScrollBehaviorSupported) {\n+      node.scrollTo({ top: 0, behavior: 'smooth' });\n+    } else {\n+      scroll(node, 'scrollTop', 0);\n+    }\n+  });\n---\napp/javascript/mastodon/test_helpers.tsx\n@@ -8,6 +8,14 @@ import { render as rtlRender } from '@testing-library/react';\n \n import { IdentityContext } from './identity_context';\n \n+beforeEach(() => {\n+  global.requestIdleCallback = jest\n+    .fn()\n+    .mockImplementation((fn: () => void) => {\n+      fn();\n+    });\n+});\n+\n function render(\n   ui: React.ReactElement,\n   {\n---\n\n\n---\n\nChoice C:\napp/lib/link_details_extractor.rb\n@@ -37,6 +37,7 @@ def description\n \n     def language\n       lang = json['inLanguage']\n+      lang = lang.first if lang.is_a?(Array)\n       lang.is_a?(Hash) ? (lang['alternateName'] || lang['name']) : lang\n     end\n \n---\n\n\n---\n\nChoice D:\napp/controllers/api/v1/admin/accounts_controller.rb\n@@ -46,8 +46,10 @@ def show\n \n   def enable\n     authorize @account.user, :enable?\n-    @account.user.enable!\n-    log_action :enable, @account.user\n+    if @account.user.disabled\n+      @account.user.enable!\n+      log_action :enable, @account.user\n+    end\n     render json: @account, serializer: REST::Admin::AccountSerializer\n   end\n \n@@ -71,15 +73,19 @@ def destroy\n \n   def unsensitive\n     authorize @account, :unsensitive?\n-    @account.unsensitize!\n-    log_action :unsensitive, @account\n+    if @account.sensitized?\n+      @account.unsensitize!\n+      log_action :unsensitive, @account\n+    end\n     render json: @account, serializer: REST::Admin::AccountSerializer\n   end\n \n   def unsilence\n     authorize @account, :unsilence?\n-    @account.unsilence!\n-    log_action :unsilence, @account\n+    if @account.silenced?\n+      @account.unsilence!\n+      log_action :unsilence, @account\n+    end\n     render json: @account, serializer: REST::Admin::AccountSerializer\n   end\n \n---\napp/controllers/api/v1/admin/reports_controller.rb\n@@ -40,29 +40,37 @@ def update\n \n   def assign_to_self\n     authorize @report, :update?\n-    @report.update!(assigned_account_id: current_account.id)\n-    log_action :assigned_to_self, @report\n+    unless @report.assigned_account_id == current_account.id\n+      @report.update!(assigned_account_id: current_account.id)\n+      log_action :assigned_to_self, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n   def unassign\n     authorize @report, :update?\n-    @report.update!(assigned_account_id: nil)\n-    log_action :unassigned, @report\n+    if @report.assigned_account_id\n+      @report.update!(assigned_account_id: nil)\n+      log_action :unassigned, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n   def reopen\n     authorize @report, :update?\n-    @report.unresolve!\n-    log_action :reopen, @report\n+    unless @report.unresolved?\n+      @report.unresolve!\n+      log_action :reopen, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n   def resolve\n     authorize @report, :update?\n-    @report.resolve!(current_account)\n-    log_action :resolve, @report\n+    unless @report.action_taken?\n+      @report.resolve!(current_account)\n+      log_action :resolve, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n---\nspec/controllers/admin/reports_controller_spec.rb\n@@ -64,7 +64,7 @@\n \n   describe 'POST #reopen' do\n     it 'reopens the report' do\n-      report = Fabricate(:report)\n+      report = Fabricate(:report, action_taken_at: 3.days.ago)\n \n       put :reopen, params: { id: report }\n       expect(response).to redirect_to(admin_report_path(report))\n@@ -89,7 +89,7 @@\n \n   describe 'POST #unassign' do\n     it 'reopens the report' do\n-      report = Fabricate(:report)\n+      report = Fabricate(:report, assigned_account_id: Account.last.id)\n \n       put :unassign, params: { id: report }\n       expect(response).to redirect_to(admin_report_path(report))\n---\napp/models/admin/account_action.rb\n@@ -132,26 +132,26 @@ def process_reports!\n \n   def handle_disable!\n     authorize(target_account.user, :disable?)\n-    log_action(:disable, target_account.user)\n     target_account.user&.disable!\n+    log_action(:disable, target_account.user)\n   end\n \n   def handle_sensitive!\n     authorize(target_account, :sensitive?)\n-    log_action(:sensitive, target_account)\n     target_account.sensitize!\n+    log_action(:sensitive, target_account)\n   end\n \n   def handle_silence!\n     authorize(target_account, :silence?)\n-    log_action(:silence, target_account)\n     target_account.silence!\n+    log_action(:silence, target_account)\n   end\n \n   def handle_suspend!\n     authorize(target_account, :suspend?)\n-    log_action(:suspend, target_account)\n     target_account.suspend!(origin: :local)\n+    log_action(:suspend, target_account)\n   end\n \n   def text_for_warning\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nThis reverts commit 8a1423a47425dd67615e94bdfd13d64b53676da4.\r\n\r\nFixes #29807\r\n\r\nThe implementation of #29305 was misguided and caused an error, while bringing no functionality. There are other ways to fix the error, but implementing the actual feature the PR aimed to will require more work.\n\n---\n\nChoice A:\napp/helpers/email_helper.rb\n@@ -6,13 +6,17 @@ def self.included(base)\n   end\n \n   def email_to_canonical_email(str)\n+    return nil if str.nil?\n+\n     username, domain = str.downcase.split('@', 2)\n     username, = username.delete('.').split('+', 2)\n \n     \"#{username}@#{domain}\"\n   end\n \n   def email_to_canonical_email_hash(str)\n+    return nil if str.nil?\n+\n     Digest::SHA2.new(256).hexdigest(email_to_canonical_email(str))\n   end\n end\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/polyfills/base_polyfills.ts\n@@ -1,4 +1,5 @@\n import 'core-js/features/object/assign';\n+import 'core-js/features/object/has-own';\n import 'core-js/features/object/values';\n import 'core-js/features/symbol';\n import 'core-js/features/promise/finally';\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/notifications/components/column_settings.jsx\n@@ -45,14 +45,18 @@ class ColumnSettings extends PureComponent {\n \n     return (\n       <div className='column-settings'>\n-        {alertsEnabled && browserSupport && browserPermission === 'denied' && (\n-          <span className='warning-hint'><FormattedMessage id='notifications.permission_denied' defaultMessage='Desktop notifications are unavailable due to previously denied browser permissions request' /></span>\n-        )}\n-\n         <section>\n           <ClearColumnButton onClick={onClear} />\n         </section>\n \n+        {alertsEnabled && browserSupport && browserPermission === 'denied' && (\n+          <section>\n+            <span className='warning-hint'>\n+              <FormattedMessage id='notifications.permission_denied' defaultMessage='Desktop notifications are unavailable due to previously denied browser permissions request' />\n+            </span>\n+          </section>\n+        )}\n+\n         {alertsEnabled && browserSupport && browserPermission === 'default' && (\n           <section>\n             <span className='warning-hint'>\n---\n\n\n---\n\nChoice D:\napp/helpers/application_helper.rb\n@@ -240,11 +240,16 @@ def prerender_custom_emojis(html, custom_emojis, other_options = {})\n     EmojiFormatter.new(html, custom_emojis, other_options.merge(animate: prefers_autoplay?)).to_s\n   end\n \n-  def site_icon_path(type, size = '48')\n-    icon = SiteUpload.find_by(var: type)\n-    return nil unless icon\n+  def instance_presenter\n+    @instance_presenter ||= InstancePresenter.new\n+  end\n+\n+  def favicon_path(size = '48')\n+    instance_presenter.favicon&.file&.url(size)\n+  end\n \n-    icon.file.url(size)\n+  def app_icon_path(size = '48')\n+    instance_presenter.app_icon&.file&.url(size)\n   end\n \n   private\n---\napp/presenters/instance_presenter.rb\n@@ -81,4 +81,16 @@ def thumbnail\n   def mascot\n     @mascot ||= Rails.cache.fetch('site_uploads/mascot') { SiteUpload.find_by(var: 'mascot') }\n   end\n+\n+  def favicon\n+    return @favicon if defined?(@favicon)\n+\n+    @favicon ||= Rails.cache.fetch('site_uploads/favicon') { SiteUpload.find_by(var: 'favicon') }\n+  end\n+\n+  def app_icon\n+    return @app_icon if defined?(@app_icon)\n+\n+    @app_icon ||= Rails.cache.fetch('site_uploads/app_icon') { SiteUpload.find_by(var: 'app_icon') }\n+  end\n end\n---\napp/serializers/manifest_serializer.rb\n@@ -27,7 +27,7 @@ def short_name\n \n   def icons\n     SiteUpload::ANDROID_ICON_SIZES.map do |size|\n-      src = site_icon_path('app_icon', size.to_i)\n+      src = app_icon_path(size.to_i)\n       src = URI.join(root_url, src).to_s if src.present?\n \n       {\n---\napp/views/layouts/application.html.haml\n@@ -11,13 +11,13 @@\n     - if storage_host?\n       %link{ rel: 'dns-prefetch', href: storage_host }/\n \n-    %link{ rel: 'icon', href: site_icon_path('favicon', 'ico') || '/favicon.ico', type: 'image/x-icon' }/\n+    %link{ rel: 'icon', href: favicon_path('ico') || '/favicon.ico', type: 'image/x-icon' }/\n \n     - SiteUpload::FAVICON_SIZES.each do |size|\n-      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: site_icon_path('favicon', size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n+      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: favicon_path(size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n \n     - SiteUpload::APPLE_ICON_SIZES.each do |size|\n-      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: site_icon_path('app_icon', size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n+      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: app_icon_path(size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n \n     %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n     %link{ rel: 'manifest', href: manifest_path(format: :json) }/\n---\nspec/helpers/application_helper_spec.rb\n@@ -286,26 +286,31 @@ def current_theme = 'default'\n     end\n   end\n \n-  describe '#site_icon_path' do\n+  describe 'favicon' do\n     context 'when an icon exists' do\n       let!(:favicon) { Fabricate(:site_upload, var: 'favicon') }\n+      let!(:app_icon) { Fabricate(:site_upload, var: 'app_icon') }\n \n       it 'returns the URL of the icon' do\n-        expect(helper.site_icon_path('favicon')).to eq(favicon.file.url('48'))\n+        expect(helper.favicon_path).to eq(favicon.file.url('48'))\n+        expect(helper.app_icon_path).to eq(app_icon.file.url('48'))\n       end\n \n       it 'returns the URL of the icon with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to eq(favicon.file.url('16'))\n+        expect(helper.favicon_path(16)).to eq(favicon.file.url('16'))\n+        expect(helper.app_icon_path(16)).to eq(app_icon.file.url('16'))\n       end\n     end\n \n     context 'when an icon does not exist' do\n       it 'returns nil' do\n-        expect(helper.site_icon_path('favicon')).to be_nil\n+        expect(helper.favicon_path).to be_nil\n+        expect(helper.app_icon_path).to be_nil\n       end\n \n       it 'returns nil with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to be_nil\n+        expect(helper.favicon_path(16)).to be_nil\n+        expect(helper.app_icon_path(16)).to be_nil\n       end\n     end\n   end\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Upload a favicon in **Branding** settings\r\n2. Run `tootctl media remove-orphans`\r\n3. Favicon `.png` is now gone, but `.ico` remains.\r\n...\r\n\n\n### Expected behaviour\n\nFavicon not to be considered orphaned media\n\n### Actual behaviour\n\nFavicon is considered orphaned media and deleted\n\n### Detailed description\n\nAfter #30040, admins can now upload favicons to their instances. But the `tootctl media remove-orphans` command considers them as orphaned media, so the `.png` files are deleted. The `.ico` version is preserved, but the favicon used by browsers is the `.png` one, so they fail to show a favicon at all. Akkoma instances also fails to present the favicon.\r\n\r\n```\r\nI, [2024-05-13T10:04:45.895906 #421984]  INFO -- : [dotenv] Loaded .env.production\r\n(...)\r\nFound and removed orphan: site_uploads/files/000/000/019/16/724461bd9f815f15.png                                 \r\nFound and removed orphan: site_uploads/files/000/000/019/32/724461bd9f815f15.png                                 \r\nFound and removed orphan: site_uploads/files/000/000/019/48/724461bd9f815f15.png\r\n(...)\r\n```\n\n### Mastodon instance\n\nbolha.one\n\n### Mastodon version\n\nv4.3.0-alpha.3-1959365\n\n### Technical details\n\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: `3.3.1 (2024-04-23 revision c56cd86388)`\r\n- Node.js version: `v20.13.0`\n\n---\n\nChoice A:\napp/lib/activitypub/adapter.rb\n@@ -20,6 +20,6 @@ def serializable_hash(options = nil)\n     serialized_hash = serialized_hash.select { |k, _| options[:fields].include?(k) } if options[:fields]\n     serialized_hash = self.class.transform_key_casing!(serialized_hash, instance_options)\n \n-    { '@context' => serialized_context(named_contexts, context_extensions) }.merge(serialized_hash)\n+    { '@context': serialized_context(named_contexts, context_extensions) }.merge(serialized_hash)\n   end\n end\n---\napp/services/backup_service.rb\n@@ -19,8 +19,8 @@ def call(backup)\n \n   def build_outbox_json!(file)\n     skeleton = serialize(collection_presenter, ActivityPub::CollectionSerializer)\n-    skeleton['@context'] = full_context\n-    skeleton['orderedItems'] = ['!PLACEHOLDER!']\n+    skeleton[:@context] = full_context\n+    skeleton[:orderedItems] = ['!PLACEHOLDER!']\n     skeleton = Oj.dump(skeleton)\n     prepend, append = skeleton.split('\"!PLACEHOLDER!\"')\n     add_comma = false\n@@ -33,7 +33,7 @@ def build_outbox_json!(file)\n \n       file.write(statuses.map do |status|\n         item = serialize_payload(ActivityPub::ActivityPresenter.from_status(status), ActivityPub::ActivitySerializer)\n-        item.delete('@context')\n+        item.delete(:@context)\n \n         unless item[:type] == 'Announce' || item[:object][:attachment].blank?\n           item[:object][:attachment].each do |attachment|\n---\nspec/lib/activitypub/adapter_spec.rb\n@@ -59,39 +59,39 @@ def virtual_object\n       let(:serializer_class) { TestWithBasicContextSerializer }\n \n       it 'renders a basic @context' do\n-        expect(subject).to include({ '@context' => 'https://www.w3.org/ns/activitystreams' })\n+        expect(subject).to include({ '@context': 'https://www.w3.org/ns/activitystreams' })\n       end\n     end\n \n     context 'when serializer defines a named context' do\n       let(:serializer_class) { TestWithNamedContextSerializer }\n \n       it 'renders a @context with both items' do\n-        expect(subject).to include({ '@context' => ['https://www.w3.org/ns/activitystreams', 'https://w3id.org/security/v1'] })\n+        expect(subject).to include({ '@context': ['https://www.w3.org/ns/activitystreams', 'https://w3id.org/security/v1'] })\n       end\n     end\n \n     context 'when serializer has children that define a named context' do\n       let(:serializer_class) { TestWithNestedNamedContextSerializer }\n \n       it 'renders a @context with both items' do\n-        expect(subject).to include({ '@context' => ['https://www.w3.org/ns/activitystreams', 'https://w3id.org/security/v1'] })\n+        expect(subject).to include({ '@context': ['https://www.w3.org/ns/activitystreams', 'https://w3id.org/security/v1'] })\n       end\n     end\n \n     context 'when serializer defines context extensions' do\n       let(:serializer_class) { TestWithContextExtensionSerializer }\n \n       it 'renders a @context with the extension' do\n-        expect(subject).to include({ '@context' => ['https://www.w3.org/ns/activitystreams', { 'sensitive' => 'as:sensitive' }] })\n+        expect(subject).to include({ '@context': ['https://www.w3.org/ns/activitystreams', { 'sensitive' => 'as:sensitive' }] })\n       end\n     end\n \n     context 'when serializer has children that define context extensions' do\n       let(:serializer_class) { TestWithNestedContextExtensionSerializer }\n \n       it 'renders a @context with both extensions' do\n-        expect(subject).to include({ '@context' => ['https://www.w3.org/ns/activitystreams', { 'manuallyApprovesFollowers' => 'as:manuallyApprovesFollowers', 'sensitive' => 'as:sensitive' }] })\n+        expect(subject).to include({ '@context': ['https://www.w3.org/ns/activitystreams', { 'manuallyApprovesFollowers' => 'as:manuallyApprovesFollowers', 'sensitive' => 'as:sensitive' }] })\n       end\n     end\n   end\n---\nspec/services/backup_service_spec.rb\n@@ -60,6 +60,7 @@ def expect_outbox_export\n \n     aggregate_failures do\n       expect(body.scan('@context').count).to eq 1\n+      expect(body.scan('orderedItems').count).to eq 1\n       expect(json['@context']).to_not be_nil\n       expect(json['type']).to eq 'OrderedCollection'\n       expect(json['totalItems']).to eq 2\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/actions/search.js\n@@ -147,6 +147,10 @@ export const openURL = (value, history, onFailure) => (dispatch, getState) => {\n   const signedIn = !!getState().getIn(['meta', 'me']);\n \n   if (!signedIn) {\n+    if (onFailure) {\n+      onFailure();\n+    }\n+\n     return;\n   }\n \n---\n\n\n---\n\nChoice C:\ndocker-compose.yml\n@@ -2,7 +2,7 @@ version: '3'\n services:\n   db:\n     restart: always\n-    image: postgres:14-alpine\n+    image: postgres:15-alpine\n     shm_size: 256mb\n     networks:\n       - internal_network\n@@ -25,7 +25,7 @@ services:\n \n   # es:\n   #   restart: always\n-  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.4\n+  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9\n   #   environment:\n   #     - \"ES_JAVA_OPTS=-Xms512m -Xmx512m -Des.enforce.bootstrap.checks=true\"\n   #     - \"xpack.license.self_generated.type=basic\"\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\n\n\n---\n\nChoice D:\nlib/mastodon/cli/media.rb\n@@ -128,7 +128,7 @@ def remove_orphans\n \n             model_name      = path_segments.first.classify\n             attachment_name = path_segments[1].singularize\n-            record_id       = path_segments[2..-2].join.to_i\n+            record_id       = path_segments[2...-2].join.to_i\n             file_name       = path_segments.last\n             record          = record_map.dig(model_name, record_id)\n             attachment      = record&.public_send(attachment_name)\n@@ -172,7 +172,7 @@ def remove_orphans\n           end\n \n           model_name      = path_segments.first.classify\n-          record_id       = path_segments[2..-2].join.to_i\n+          record_id       = path_segments[2...-2].join.to_i\n           attachment_name = path_segments[1].singularize\n           file_name       = path_segments.last\n \n@@ -297,7 +297,7 @@ def lookup(url)\n       fail_with_message 'Not a media URL' unless VALID_PATH_SEGMENTS_SIZE.include?(path_segments.size)\n \n       model_name = path_segments.first.classify\n-      record_id  = path_segments[2..-2].join.to_i\n+      record_id  = path_segments[2...-2].join.to_i\n \n       fail_with_message \"Cannot find corresponding model: #{model_name}\" unless PRELOAD_MODEL_WHITELIST.include?(model_name)\n \n@@ -353,7 +353,7 @@ def preload_records_from_mixed_objects(objects)\n         next unless VALID_PATH_SEGMENTS_SIZE.include?(segments.size)\n \n         model_name = segments.first.classify\n-        record_id  = segments[2..-2].join.to_i\n+        record_id  = segments[2...-2].join.to_i\n \n         next unless PRELOAD_MODEL_WHITELIST.include?(model_name)\n \n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\nYou can reproduce this problem by loading the /home page.\r\n\r\n### Expected behaviour\r\n\r\nFewer round trips to the database\r\n\r\n### Actual behaviour\r\n\r\nToo many round trips to the database\r\n\r\n### Detailed description\r\n\r\n#30040 adds the ability for admins to configure favicons. An effect of that PR is now every time the `application.html.haml` layout is run (on things like initial loads of /home) a series of queries are sent to the database...\r\n\r\n![image](https://github.com/mastodon/mastodon/assets/157782/03b447a0-2497-4bb0-bd4a-9bc6f92817ff)\r\n\r\nAll these queries are repeatedly going for one of two rows, the `favicon` row or the `app_icon` row.\r\n\r\nThese queries originate from the `site_icon_path` calls in the loops here.\r\n\r\nhttps://github.com/mastodon/mastodon/blob/d09b02efb653e59488cac530db8ae2757ad0cd02/app/views/layouts/application.html.haml#L14-L20\r\n\r\nI don't know what the right number of queries is (I could see two, I could see zero) but this feels like too much.\r\n\r\n### Mastodon instance\r\n\r\nLocal development\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-alpha.3\r\n\n\n---\n\nChoice A:\ndocker-compose.yml\n@@ -2,7 +2,7 @@ version: '3'\n services:\n   db:\n     restart: always\n-    image: postgres:14-alpine\n+    image: postgres:15-alpine\n     shm_size: 256mb\n     networks:\n       - internal_network\n@@ -25,7 +25,7 @@ services:\n \n   # es:\n   #   restart: always\n-  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.4\n+  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9\n   #   environment:\n   #     - \"ES_JAVA_OPTS=-Xms512m -Xmx512m -Des.enforce.bootstrap.checks=true\"\n   #     - \"xpack.license.self_generated.type=basic\"\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\n\n\n---\n\nChoice B:\napp/lib/video_metadata_extractor.rb\n@@ -22,7 +22,7 @@ def valid?\n   private\n \n   def ffmpeg_command_output\n-    command = Terrapin::CommandLine.new('ffprobe', '-i :path -print_format :format -show_format -show_streams -show_error -loglevel :loglevel')\n+    command = Terrapin::CommandLine.new(Rails.configuration.x.ffprobe_binary, '-i :path -print_format :format -show_format -show_streams -show_error -loglevel :loglevel')\n     command.run(path: @path, format: 'json', loglevel: 'fatal')\n   end\n \n---\nconfig/initializers/ffmpeg.rb\n@@ -1,5 +1,6 @@\n # frozen_string_literal: true\n \n-if ENV['FFMPEG_BINARY'].present?\n-  FFMPEG.ffmpeg_binary = ENV['FFMPEG_BINARY']\n+Rails.application.configure do\n+  config.x.ffmpeg_binary = ENV['FFMPEG_BINARY'] || 'ffmpeg'\n+  config.x.ffprobe_binary = ENV['FFPROBE_BINARY'] || 'ffprobe'\n end\n---\nlib/paperclip/image_extractor.rb\n@@ -35,7 +35,7 @@ def extract_image_from_file!\n       dst.binmode\n \n       begin\n-        command = Terrapin::CommandLine.new('ffmpeg', '-i :source -loglevel :loglevel -y :destination', logger: Paperclip.logger)\n+        command = Terrapin::CommandLine.new(Rails.configuration.x.ffmpeg_binary, '-i :source -loglevel :loglevel -y :destination', logger: Paperclip.logger)\n         command.run(source: @file.path, destination: dst.path, loglevel: 'fatal')\n       rescue Terrapin::ExitStatusError\n         dst.close(true)\n---\nlib/paperclip/transcoder.rb\n@@ -61,7 +61,7 @@ def make\n       command_arguments, interpolations = prepare_command(destination)\n \n       begin\n-        command = Terrapin::CommandLine.new('ffmpeg', command_arguments.join(' '), logger: Paperclip.logger)\n+        command = Terrapin::CommandLine.new(Rails.configuration.x.ffmpeg_binary, command_arguments.join(' '), logger: Paperclip.logger)\n         command.run(interpolations)\n       rescue Terrapin::ExitStatusError => e\n         raise Paperclip::Error, \"Error while transcoding #{@basename}: #{e}\"\n---\n\n\n---\n\nChoice C:\napp/lib/activitypub/adapter.rb\n@@ -20,6 +20,6 @@ def serializable_hash(options = nil)\n     serialized_hash = serialized_hash.select { |k, _| options[:fields].include?(k) } if options[:fields]\n     serialized_hash = self.class.transform_key_casing!(serialized_hash, instance_options)\n \n-    { '@context' => serialized_context(named_contexts, context_extensions) }.merge(serialized_hash)\n+    { '@context': serialized_context(named_contexts, context_extensions) }.merge(serialized_hash)\n   end\n end\n---\napp/services/backup_service.rb\n@@ -19,8 +19,8 @@ def call(backup)\n \n   def build_outbox_json!(file)\n     skeleton = serialize(collection_presenter, ActivityPub::CollectionSerializer)\n-    skeleton['@context'] = full_context\n-    skeleton['orderedItems'] = ['!PLACEHOLDER!']\n+    skeleton[:@context] = full_context\n+    skeleton[:orderedItems] = ['!PLACEHOLDER!']\n     skeleton = Oj.dump(skeleton)\n     prepend, append = skeleton.split('\"!PLACEHOLDER!\"')\n     add_comma = false\n@@ -33,7 +33,7 @@ def build_outbox_json!(file)\n \n       file.write(statuses.map do |status|\n         item = serialize_payload(ActivityPub::ActivityPresenter.from_status(status), ActivityPub::ActivitySerializer)\n-        item.delete('@context')\n+        item.delete(:@context)\n \n         unless item[:type] == 'Announce' || item[:object][:attachment].blank?\n           item[:object][:attachment].each do |attachment|\n---\nspec/lib/activitypub/adapter_spec.rb\n@@ -59,39 +59,39 @@ def virtual_object\n       let(:serializer_class) { TestWithBasicContextSerializer }\n \n       it 'renders a basic @context' do\n-        expect(subject).to include({ '@context' => 'https://www.w3.org/ns/activitystreams' })\n+        expect(subject).to include({ '@context': 'https://www.w3.org/ns/activitystreams' })\n       end\n     end\n \n     context 'when serializer defines a named context' do\n       let(:serializer_class) { TestWithNamedContextSerializer }\n \n       it 'renders a @context with both items' do\n-        expect(subject).to include({ '@context' => ['https://www.w3.org/ns/activitystreams', 'https://w3id.org/security/v1'] })\n+        expect(subject).to include({ '@context': ['https://www.w3.org/ns/activitystreams', 'https://w3id.org/security/v1'] })\n       end\n     end\n \n     context 'when serializer has children that define a named context' do\n       let(:serializer_class) { TestWithNestedNamedContextSerializer }\n \n       it 'renders a @context with both items' do\n-        expect(subject).to include({ '@context' => ['https://www.w3.org/ns/activitystreams', 'https://w3id.org/security/v1'] })\n+        expect(subject).to include({ '@context': ['https://www.w3.org/ns/activitystreams', 'https://w3id.org/security/v1'] })\n       end\n     end\n \n     context 'when serializer defines context extensions' do\n       let(:serializer_class) { TestWithContextExtensionSerializer }\n \n       it 'renders a @context with the extension' do\n-        expect(subject).to include({ '@context' => ['https://www.w3.org/ns/activitystreams', { 'sensitive' => 'as:sensitive' }] })\n+        expect(subject).to include({ '@context': ['https://www.w3.org/ns/activitystreams', { 'sensitive' => 'as:sensitive' }] })\n       end\n     end\n \n     context 'when serializer has children that define context extensions' do\n       let(:serializer_class) { TestWithNestedContextExtensionSerializer }\n \n       it 'renders a @context with both extensions' do\n-        expect(subject).to include({ '@context' => ['https://www.w3.org/ns/activitystreams', { 'manuallyApprovesFollowers' => 'as:manuallyApprovesFollowers', 'sensitive' => 'as:sensitive' }] })\n+        expect(subject).to include({ '@context': ['https://www.w3.org/ns/activitystreams', { 'manuallyApprovesFollowers' => 'as:manuallyApprovesFollowers', 'sensitive' => 'as:sensitive' }] })\n       end\n     end\n   end\n---\nspec/services/backup_service_spec.rb\n@@ -60,6 +60,7 @@ def expect_outbox_export\n \n     aggregate_failures do\n       expect(body.scan('@context').count).to eq 1\n+      expect(body.scan('orderedItems').count).to eq 1\n       expect(json['@context']).to_not be_nil\n       expect(json['type']).to eq 'OrderedCollection'\n       expect(json['totalItems']).to eq 2\n---\n\n\n---\n\nChoice D:\napp/helpers/application_helper.rb\n@@ -240,11 +240,16 @@ def prerender_custom_emojis(html, custom_emojis, other_options = {})\n     EmojiFormatter.new(html, custom_emojis, other_options.merge(animate: prefers_autoplay?)).to_s\n   end\n \n-  def site_icon_path(type, size = '48')\n-    icon = SiteUpload.find_by(var: type)\n-    return nil unless icon\n+  def instance_presenter\n+    @instance_presenter ||= InstancePresenter.new\n+  end\n+\n+  def favicon_path(size = '48')\n+    instance_presenter.favicon&.file&.url(size)\n+  end\n \n-    icon.file.url(size)\n+  def app_icon_path(size = '48')\n+    instance_presenter.app_icon&.file&.url(size)\n   end\n \n   private\n---\napp/presenters/instance_presenter.rb\n@@ -81,4 +81,16 @@ def thumbnail\n   def mascot\n     @mascot ||= Rails.cache.fetch('site_uploads/mascot') { SiteUpload.find_by(var: 'mascot') }\n   end\n+\n+  def favicon\n+    return @favicon if defined?(@favicon)\n+\n+    @favicon ||= Rails.cache.fetch('site_uploads/favicon') { SiteUpload.find_by(var: 'favicon') }\n+  end\n+\n+  def app_icon\n+    return @app_icon if defined?(@app_icon)\n+\n+    @app_icon ||= Rails.cache.fetch('site_uploads/app_icon') { SiteUpload.find_by(var: 'app_icon') }\n+  end\n end\n---\napp/serializers/manifest_serializer.rb\n@@ -27,7 +27,7 @@ def short_name\n \n   def icons\n     SiteUpload::ANDROID_ICON_SIZES.map do |size|\n-      src = site_icon_path('app_icon', size.to_i)\n+      src = app_icon_path(size.to_i)\n       src = URI.join(root_url, src).to_s if src.present?\n \n       {\n---\napp/views/layouts/application.html.haml\n@@ -11,13 +11,13 @@\n     - if storage_host?\n       %link{ rel: 'dns-prefetch', href: storage_host }/\n \n-    %link{ rel: 'icon', href: site_icon_path('favicon', 'ico') || '/favicon.ico', type: 'image/x-icon' }/\n+    %link{ rel: 'icon', href: favicon_path('ico') || '/favicon.ico', type: 'image/x-icon' }/\n \n     - SiteUpload::FAVICON_SIZES.each do |size|\n-      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: site_icon_path('favicon', size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n+      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: favicon_path(size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n \n     - SiteUpload::APPLE_ICON_SIZES.each do |size|\n-      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: site_icon_path('app_icon', size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n+      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: app_icon_path(size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n \n     %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n     %link{ rel: 'manifest', href: manifest_path(format: :json) }/\n---\nspec/helpers/application_helper_spec.rb\n@@ -286,26 +286,31 @@ def current_theme = 'default'\n     end\n   end\n \n-  describe '#site_icon_path' do\n+  describe 'favicon' do\n     context 'when an icon exists' do\n       let!(:favicon) { Fabricate(:site_upload, var: 'favicon') }\n+      let!(:app_icon) { Fabricate(:site_upload, var: 'app_icon') }\n \n       it 'returns the URL of the icon' do\n-        expect(helper.site_icon_path('favicon')).to eq(favicon.file.url('48'))\n+        expect(helper.favicon_path).to eq(favicon.file.url('48'))\n+        expect(helper.app_icon_path).to eq(app_icon.file.url('48'))\n       end\n \n       it 'returns the URL of the icon with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to eq(favicon.file.url('16'))\n+        expect(helper.favicon_path(16)).to eq(favicon.file.url('16'))\n+        expect(helper.app_icon_path(16)).to eq(app_icon.file.url('16'))\n       end\n     end\n \n     context 'when an icon does not exist' do\n       it 'returns nil' do\n-        expect(helper.site_icon_path('favicon')).to be_nil\n+        expect(helper.favicon_path).to be_nil\n+        expect(helper.app_icon_path).to be_nil\n       end\n \n       it 'returns nil with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to be_nil\n+        expect(helper.favicon_path(16)).to be_nil\n+        expect(helper.app_icon_path(16)).to be_nil\n       end\n     end\n   end\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Clone the repository on MacOS and follow the steps to get the Docker virtualization running\r\n2. Execute `docker-compose -f .devcontainer/docker-compose.yml exec -w /workspaces/mastodon app .devcontainer/post-create.sh` as described [here](https://github.com/mastodon/mastodon/discussions/27843#discussioncomment-7872344) to fix the issue in that link.\r\n\r\n\r\n### Expected behaviour\r\n\r\nWebpack compilation should complete successfully\r\n\r\n### Actual behaviour\r\n\r\nWebpack fails\r\n\r\n### Detailed description\r\n\r\n\r\nWebpacker starts compiling the frontend assets and will stop with the following error: (excerpt)\r\n\r\n```log\r\n...\r\n[Webpacker] Everything's up-to-date. Nothing to do\r\n[Webpacker] Everything's up-to-date. Nothing to do\r\n[Webpacker] Everything's up-to-date. Nothing to do\r\n[Webpacker] Everything's up-to-date. Nothing to do\r\n[Webpacker] Everything's up-to-date. Nothing to do\r\n  Rendered layout layouts/error.html.haml (Duration: 1529.2ms | Allocations: 582036)\r\nCompiling...\r\nCompilation failed:\r\n/workspaces/mastodon/node_modules/webpack-cli/bin/cli.js:93\r\n                                throw err;\r\n                                ^\r\n\r\nTypeError: Cannot read properties of undefined (reading 'compress')\r\n    at Object.<anonymous> (/workspaces/mastodon/config/webpack/development.js:32:35)\r\n    at Module._compile (/workspaces/mastodon/node_modules/v8-compile-cache/v8-compile-cache.js:192:30)\r\n    at Module._extensions..js (node:internal/modules/cjs/loader:1427:10)\r\n    at Module.load (node:internal/modules/cjs/loader:1206:32)\r\n    at Module._load (node:internal/modules/cjs/loader:1022:12)\r\n    at Module.require (node:internal/modules/cjs/loader:1231:19)\r\n    at require (/workspaces/mastodon/node_modules/v8-compile-cache/v8-compile-cache.js:159:20)\r\n    at WEBPACK_OPTIONS (/workspaces/mastodon/node_modules/webpack-cli/bin/utils/convert-argv.js:114:13)\r\n    at requireConfig (/workspaces/mastodon/node_modules/webpack-cli/bin/utils/convert-argv.js:116:6)\r\n    at /workspaces/mastodon/node_modules/webpack-cli/bin/utils/convert-argv.js:123:17\r\n    at Array.forEach (<anonymous>)\r\n    at module.exports (/workspaces/mastodon/node_modules/webpack-cli/bin/utils/convert-argv.js:121:15)\r\n    at /workspaces/mastodon/node_modules/webpack-cli/bin/cli.js:71:45\r\n    at Object.parse (/workspaces/mastodon/node_modules/yargs/yargs.js:576:18)\r\n    at /workspaces/mastodon/node_modules/webpack-cli/bin/cli.js:49:8\r\n    at Object.<anonymous> (/workspaces/mastodon/node_modules/webpack-cli/bin/cli.js:366:3)\r\n    at Module._compile (node:internal/modules/cjs/loader:1369:14)\r\n    at Module._extensions..js (node:internal/modules/cjs/loader:1427:10)\r\n    at Module.load (node:internal/modules/cjs/loader:1206:32)\r\n    at Module._load (node:internal/modules/cjs/loader:1022:12)\r\n    at Module.require (node:internal/modules/cjs/loader:1231:19)\r\n    at require (node:internal/modules/helpers:179:18)\r\n    at Object.<anonymous> (/workspaces/mastodon/node_modules/webpack/bin/webpack.js:156:2)\r\n    at Module._compile (node:internal/modules/cjs/loader:1369:14)\r\n    at Module._extensions..js (node:internal/modules/cjs/loader:1427:10)\r\n    at Module.load (node:internal/modules/cjs/loader:1206:32)\r\n    at Module._load (node:internal/modules/cjs/loader:1022:12)\r\n    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:135:12)\r\n    at node:internal/main/run_main_module:28:49\r\n\r\nNode.js v20.12.2\r\n```\r\n\r\nIt seems to me that the configuration in `config/webpacker.yml` is not being read. Anyone facing this error?\r\nThanks in advance!\r\n\r\n\r\n\r\n### Mastodon instance\r\n\r\n_No response_\r\n\r\n### Mastodon version\r\n\r\n_No response_\r\n\r\n### Technical details\r\n\r\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: v3.2.4\r\n- Node.js version: v20.12.2\r\n- MacOS 14.4.1 on Apple Silicon M3\r\n- Docker version 25.0.3\n\n---\n\nChoice A:\napp/controllers/api/v1/admin/accounts_controller.rb\n@@ -46,8 +46,10 @@ def show\n \n   def enable\n     authorize @account.user, :enable?\n-    @account.user.enable!\n-    log_action :enable, @account.user\n+    if @account.user.disabled\n+      @account.user.enable!\n+      log_action :enable, @account.user\n+    end\n     render json: @account, serializer: REST::Admin::AccountSerializer\n   end\n \n@@ -71,15 +73,19 @@ def destroy\n \n   def unsensitive\n     authorize @account, :unsensitive?\n-    @account.unsensitize!\n-    log_action :unsensitive, @account\n+    if @account.sensitized?\n+      @account.unsensitize!\n+      log_action :unsensitive, @account\n+    end\n     render json: @account, serializer: REST::Admin::AccountSerializer\n   end\n \n   def unsilence\n     authorize @account, :unsilence?\n-    @account.unsilence!\n-    log_action :unsilence, @account\n+    if @account.silenced?\n+      @account.unsilence!\n+      log_action :unsilence, @account\n+    end\n     render json: @account, serializer: REST::Admin::AccountSerializer\n   end\n \n---\napp/controllers/api/v1/admin/reports_controller.rb\n@@ -40,29 +40,37 @@ def update\n \n   def assign_to_self\n     authorize @report, :update?\n-    @report.update!(assigned_account_id: current_account.id)\n-    log_action :assigned_to_self, @report\n+    unless @report.assigned_account_id == current_account.id\n+      @report.update!(assigned_account_id: current_account.id)\n+      log_action :assigned_to_self, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n   def unassign\n     authorize @report, :update?\n-    @report.update!(assigned_account_id: nil)\n-    log_action :unassigned, @report\n+    if @report.assigned_account_id\n+      @report.update!(assigned_account_id: nil)\n+      log_action :unassigned, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n   def reopen\n     authorize @report, :update?\n-    @report.unresolve!\n-    log_action :reopen, @report\n+    unless @report.unresolved?\n+      @report.unresolve!\n+      log_action :reopen, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n   def resolve\n     authorize @report, :update?\n-    @report.resolve!(current_account)\n-    log_action :resolve, @report\n+    unless @report.action_taken?\n+      @report.resolve!(current_account)\n+      log_action :resolve, @report\n+    end\n     render json: @report, serializer: REST::Admin::ReportSerializer\n   end\n \n---\nspec/controllers/admin/reports_controller_spec.rb\n@@ -64,7 +64,7 @@\n \n   describe 'POST #reopen' do\n     it 'reopens the report' do\n-      report = Fabricate(:report)\n+      report = Fabricate(:report, action_taken_at: 3.days.ago)\n \n       put :reopen, params: { id: report }\n       expect(response).to redirect_to(admin_report_path(report))\n@@ -89,7 +89,7 @@\n \n   describe 'POST #unassign' do\n     it 'reopens the report' do\n-      report = Fabricate(:report)\n+      report = Fabricate(:report, assigned_account_id: Account.last.id)\n \n       put :unassign, params: { id: report }\n       expect(response).to redirect_to(admin_report_path(report))\n---\napp/models/admin/account_action.rb\n@@ -132,26 +132,26 @@ def process_reports!\n \n   def handle_disable!\n     authorize(target_account.user, :disable?)\n-    log_action(:disable, target_account.user)\n     target_account.user&.disable!\n+    log_action(:disable, target_account.user)\n   end\n \n   def handle_sensitive!\n     authorize(target_account, :sensitive?)\n-    log_action(:sensitive, target_account)\n     target_account.sensitize!\n+    log_action(:sensitive, target_account)\n   end\n \n   def handle_silence!\n     authorize(target_account, :silence?)\n-    log_action(:silence, target_account)\n     target_account.silence!\n+    log_action(:silence, target_account)\n   end\n \n   def handle_suspend!\n     authorize(target_account, :suspend?)\n-    log_action(:suspend, target_account)\n     target_account.suspend!(origin: :local)\n+    log_action(:suspend, target_account)\n   end\n \n   def text_for_warning\n---\n\n\n---\n\nChoice B:\napp/models/user_role.rb\n@@ -41,7 +41,7 @@ class UserRole < ApplicationRecord\n   EVERYONE_ROLE_ID = -99\n   NOBODY_POSITION = -1\n \n-  POSITION_LIMIT = 2**31\n+  POSITION_LIMIT = (2**31) - 1\n \n   module Flags\n     NONE = 0\n@@ -91,7 +91,7 @@ module Flags\n \n   validates :name, presence: true, unless: :everyone?\n   validates :color, format: { with: /\\A#?(?:[A-F0-9]{3}){1,2}\\z/i }, unless: -> { color.blank? }\n-  validates :position, numericality: { greater_than_or_equal_to: -POSITION_LIMIT, less_than_or_equal_to: POSITION_LIMIT }\n+  validates :position, numericality: { in: (-POSITION_LIMIT..POSITION_LIMIT) }\n \n   validate :validate_permissions_elevation\n   validate :validate_position_elevation\n---\nspec/models/user_role_spec.rb\n@@ -21,11 +21,9 @@\n     describe 'position' do\n       subject { Fabricate.build :user_role }\n \n-      let(:excess) { 2**32 }\n-      let(:limit) { 2**31 }\n+      let(:limit) { described_class::POSITION_LIMIT }\n \n-      it { is_expected.to_not allow_values(-excess, excess).for(:position) }\n-      it { is_expected.to allow_values(-limit, limit).for(:position) }\n+      it { is_expected.to validate_numericality_of(:position).is_in(-limit..limit) }\n     end\n \n     describe 'color' do\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -4365,12 +4365,20 @@ a.status-card {\n     outline: $ui-button-focus-outline;\n   }\n \n+  .no-reduce-motion .icon {\n+    transition: transform 0.15s ease-in-out;\n+  }\n+\n   &.active {\n     color: $primary-text-color;\n \n     &:hover {\n       color: $primary-text-color;\n     }\n+\n+    .icon {\n+      transform: rotate(60deg);\n+    }\n   }\n \n   &:disabled {\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/notifications/components/column_settings.jsx\n@@ -45,14 +45,18 @@ class ColumnSettings extends PureComponent {\n \n     return (\n       <div className='column-settings'>\n-        {alertsEnabled && browserSupport && browserPermission === 'denied' && (\n-          <span className='warning-hint'><FormattedMessage id='notifications.permission_denied' defaultMessage='Desktop notifications are unavailable due to previously denied browser permissions request' /></span>\n-        )}\n-\n         <section>\n           <ClearColumnButton onClick={onClear} />\n         </section>\n \n+        {alertsEnabled && browserSupport && browserPermission === 'denied' && (\n+          <section>\n+            <span className='warning-hint'>\n+              <FormattedMessage id='notifications.permission_denied' defaultMessage='Desktop notifications are unavailable due to previously denied browser permissions request' />\n+            </span>\n+          </section>\n+        )}\n+\n         {alertsEnabled && browserSupport && browserPermission === 'default' && (\n           <section>\n             <span className='warning-hint'>\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\nWhen you make a post on Mastodon and include a link with a # in it e.g. https://...org/#example\r\nthe post will have the # example under it.\r\nSee this post for a live example:\r\nhttps://mastodon.social/@madeindex/112388235443765052\r\nOther social media platforms have this issue also, some of them even do not display the link at all.\r\n\r\n### Expected behaviour\r\n\r\nNo hashtag under the post\r\n\r\n### Actual behaviour\r\n\r\nA hashtag under the post\r\n\r\n### Detailed description\r\n\r\n_No response_\r\n\r\n### Mastodon instance\r\n\r\nmastodon.social\r\n\r\n### Mastodon version\r\n\r\nv4.3.0\r\n\r\n### Browser name and version\r\n\r\n/\r\n\r\n### Operating system\r\n\r\n/\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/models/tag.rb\n@@ -37,7 +37,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?<![=/)\\w])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}i\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]\\u0E47-\\u0E4E#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/tag_spec.rb\n@@ -36,6 +36,10 @@\n       expect(subject.match('https://gcc.gnu.org/bugzilla/show_bug.cgi?id=111895#c4')).to be_nil\n     end\n \n+    it 'does not match URLs with hashtag-like anchors after a non-ascii character' do\n+      expect(subject.match('https://example.org/test\u00e9#foo')).to be_nil\n+    end\n+\n     it 'does not match URLs with hashtag-like anchors after an empty query parameter' do\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)?foo=#Lawsuit')).to be_nil\n     end\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/actions/interactions.js\n@@ -1,5 +1,6 @@\n-import api from '../api';\n+import api, { getLinks } from '../api';\n \n+import { fetchRelationships } from './accounts';\n import { importFetchedAccounts, importFetchedStatus } from './importer';\n \n export const REBLOG_REQUEST = 'REBLOG_REQUEST';\n@@ -26,6 +27,10 @@ export const FAVOURITES_FETCH_REQUEST = 'FAVOURITES_FETCH_REQUEST';\n export const FAVOURITES_FETCH_SUCCESS = 'FAVOURITES_FETCH_SUCCESS';\n export const FAVOURITES_FETCH_FAIL    = 'FAVOURITES_FETCH_FAIL';\n \n+export const FAVOURITES_EXPAND_REQUEST = 'FAVOURITES_EXPAND_REQUEST';\n+export const FAVOURITES_EXPAND_SUCCESS = 'FAVOURITES_EXPAND_SUCCESS';\n+export const FAVOURITES_EXPAND_FAIL = 'FAVOURITES_EXPAND_FAIL';\n+\n export const PIN_REQUEST = 'PIN_REQUEST';\n export const PIN_SUCCESS = 'PIN_SUCCESS';\n export const PIN_FAIL    = 'PIN_FAIL';\n@@ -308,8 +313,10 @@ export function fetchFavourites(id) {\n     dispatch(fetchFavouritesRequest(id));\n \n     api(getState).get(`/api/v1/statuses/${id}/favourited_by`).then(response => {\n+      const next = getLinks(response).refs.find(link => link.rel === 'next');\n       dispatch(importFetchedAccounts(response.data));\n-      dispatch(fetchFavouritesSuccess(id, response.data));\n+      dispatch(fetchFavouritesSuccess(id, response.data, next ? next.uri : null));\n+      dispatch(fetchRelationships(response.data.map(item => item.id)));\n     }).catch(error => {\n       dispatch(fetchFavouritesFail(id, error));\n     });\n@@ -323,17 +330,62 @@ export function fetchFavouritesRequest(id) {\n   };\n }\n \n-export function fetchFavouritesSuccess(id, accounts) {\n+export function fetchFavouritesSuccess(id, accounts, next) {\n   return {\n     type: FAVOURITES_FETCH_SUCCESS,\n     id,\n     accounts,\n+    next,\n   };\n }\n \n export function fetchFavouritesFail(id, error) {\n   return {\n     type: FAVOURITES_FETCH_FAIL,\n+    id,\n+    error,\n+  };\n+}\n+\n+export function expandFavourites(id) {\n+  return (dispatch, getState) => {\n+    const url = getState().getIn(['user_lists', 'favourited_by', id, 'next']);\n+    if (url === null) {\n+      return;\n+    }\n+\n+    dispatch(expandFavouritesRequest(id));\n+\n+    api(getState).get(url).then(response => {\n+      const next = getLinks(response).refs.find(link => link.rel === 'next');\n+\n+      dispatch(importFetchedAccounts(response.data));\n+      dispatch(expandFavouritesSuccess(id, response.data, next ? next.uri : null));\n+      dispatch(fetchRelationships(response.data.map(item => item.id)));\n+    }).catch(error => dispatch(expandFavouritesFail(id, error)));\n+  };\n+}\n+\n+export function expandFavouritesRequest(id) {\n+  return {\n+    type: FAVOURITES_EXPAND_REQUEST,\n+    id,\n+  };\n+}\n+\n+export function expandFavouritesSuccess(id, accounts, next) {\n+  return {\n+    type: FAVOURITES_EXPAND_SUCCESS,\n+    id,\n+    accounts,\n+    next,\n+  };\n+}\n+\n+export function expandFavouritesFail(id, error) {\n+  return {\n+    type: FAVOURITES_EXPAND_FAIL,\n+    id,\n     error,\n   };\n }\n---\napp/javascript/mastodon/features/favourites/index.jsx\n@@ -8,7 +8,9 @@ import ImmutablePropTypes from 'react-immutable-proptypes';\n import ImmutablePureComponent from 'react-immutable-pure-component';\n import { connect } from 'react-redux';\n \n-import { fetchFavourites } from 'mastodon/actions/interactions';\n+import { debounce } from 'lodash';\n+\n+import { fetchFavourites, expandFavourites } from 'mastodon/actions/interactions';\n import ColumnHeader from 'mastodon/components/column_header';\n import { Icon }  from 'mastodon/components/icon';\n import { LoadingIndicator } from 'mastodon/components/loading_indicator';\n@@ -21,7 +23,9 @@ const messages = defineMessages({\n });\n \n const mapStateToProps = (state, props) => ({\n-  accountIds: state.getIn(['user_lists', 'favourited_by', props.params.statusId]),\n+  accountIds: state.getIn(['user_lists', 'favourited_by', props.params.statusId, 'items']),\n+  hasMore: !!state.getIn(['user_lists', 'favourited_by', props.params.statusId, 'next']),\n+  isLoading: state.getIn(['user_lists', 'favourited_by', props.params.statusId, 'isLoading'], true),\n });\n \n class Favourites extends ImmutablePureComponent {\n@@ -30,6 +34,8 @@ class Favourites extends ImmutablePureComponent {\n     params: PropTypes.object.isRequired,\n     dispatch: PropTypes.func.isRequired,\n     accountIds: ImmutablePropTypes.list,\n+    hasMore: PropTypes.bool,\n+    isLoading: PropTypes.bool,\n     multiColumn: PropTypes.bool,\n     intl: PropTypes.object.isRequired,\n   };\n@@ -40,18 +46,16 @@ class Favourites extends ImmutablePureComponent {\n     }\n   }\n \n-  UNSAFE_componentWillReceiveProps (nextProps) {\n-    if (nextProps.params.statusId !== this.props.params.statusId && nextProps.params.statusId) {\n-      this.props.dispatch(fetchFavourites(nextProps.params.statusId));\n-    }\n-  }\n-\n   handleRefresh = () => {\n     this.props.dispatch(fetchFavourites(this.props.params.statusId));\n   };\n \n+  handleLoadMore = debounce(() => {\n+    this.props.dispatch(expandFavourites(this.props.params.statusId));\n+  }, 300, { leading: true });\n+\n   render () {\n-    const { intl, accountIds, multiColumn } = this.props;\n+    const { intl, accountIds, hasMore, isLoading, multiColumn } = this.props;\n \n     if (!accountIds) {\n       return (\n@@ -75,6 +79,9 @@ class Favourites extends ImmutablePureComponent {\n \n         <ScrollableList\n           scrollKey='favourites'\n+          onLoadMore={this.handleLoadMore}\n+          hasMore={hasMore}\n+          isLoading={isLoading}\n           emptyMessage={emptyMessage}\n           bindToDocument={!multiColumn}\n         >\n---\napp/javascript/mastodon/reducers/user_lists.js\n@@ -46,7 +46,12 @@ import {\n } from '../actions/blocks';\n import {\n   REBLOGS_FETCH_SUCCESS,\n+  FAVOURITES_FETCH_REQUEST,\n   FAVOURITES_FETCH_SUCCESS,\n+  FAVOURITES_FETCH_FAIL,\n+  FAVOURITES_EXPAND_REQUEST,\n+  FAVOURITES_EXPAND_SUCCESS,\n+  FAVOURITES_EXPAND_FAIL,\n } from '../actions/interactions';\n import {\n   MUTES_FETCH_REQUEST,\n@@ -136,7 +141,15 @@ export default function userLists(state = initialState, action) {\n   case REBLOGS_FETCH_SUCCESS:\n     return state.setIn(['reblogged_by', action.id], ImmutableList(action.accounts.map(item => item.id)));\n   case FAVOURITES_FETCH_SUCCESS:\n-    return state.setIn(['favourited_by', action.id], ImmutableList(action.accounts.map(item => item.id)));\n+    return normalizeList(state, ['favourited_by', action.id], action.accounts, action.next);\n+  case FAVOURITES_EXPAND_SUCCESS:\n+    return appendToList(state, ['favourited_by', action.id], action.accounts, action.next);\n+  case FAVOURITES_FETCH_REQUEST:\n+  case FAVOURITES_EXPAND_REQUEST:\n+    return state.setIn(['favourited_by', action.id, 'isLoading'], true);\n+  case FAVOURITES_FETCH_FAIL:\n+  case FAVOURITES_EXPAND_FAIL:\n+    return state.setIn(['favourited_by', action.id, 'isLoading'], false);\n   case NOTIFICATIONS_UPDATE:\n     return action.notification.type === 'follow_request' ? normalizeFollowRequest(state, action.notification) : state;\n   case FOLLOW_REQUESTS_FETCH_SUCCESS:\n---\n\n\n---\n\nChoice C:\napp/models/status.rb\n@@ -266,7 +266,7 @@ def non_sensitive_with_media?\n   end\n \n   def reported?\n-    @reported ||= Report.where(target_account: account).unresolved.exists?(['? = ANY(status_ids)', id])\n+    @reported ||= account.targeted_reports.unresolved.exists?(['? = ANY(status_ids)', id]) || account.strikes.exists?(['? = ANY(status_ids)', id.to_s])\n   end\n \n   def emojis\n---\nspec/models/status_spec.rb\n@@ -205,6 +205,48 @@\n     end\n   end\n \n+  describe '#reported?' do\n+    context 'when the status is not reported' do\n+      it 'returns false' do\n+        expect(subject.reported?).to be false\n+      end\n+    end\n+\n+    context 'when the status is part of an open report' do\n+      before do\n+        Fabricate(:report, target_account: subject.account, status_ids: [subject.id])\n+      end\n+\n+      it 'returns true' do\n+        expect(subject.reported?).to be true\n+      end\n+    end\n+\n+    context 'when the status is part of a closed report with an account warning mentioning the account' do\n+      before do\n+        report = Fabricate(:report, target_account: subject.account, status_ids: [subject.id])\n+        report.resolve!(Fabricate(:account))\n+        Fabricate(:account_warning, target_account: subject.account, status_ids: [subject.id], report: report)\n+      end\n+\n+      it 'returns true' do\n+        expect(subject.reported?).to be true\n+      end\n+    end\n+\n+    context 'when the status is part of a closed report with an account warning not mentioning the account' do\n+      before do\n+        report = Fabricate(:report, target_account: subject.account, status_ids: [subject.id])\n+        report.resolve!(Fabricate(:account))\n+        Fabricate(:account_warning, target_account: subject.account, report: report)\n+      end\n+\n+      it 'returns false' do\n+        expect(subject.reported?).to be false\n+      end\n+    end\n+  end\n+\n   describe '.mutes_map' do\n     subject { described_class.mutes_map([status.conversation.id], account) }\n \n---\n\n\n---\n\nChoice D:\napp/models/concerns/account_avatar.rb\n@@ -18,7 +18,7 @@ def avatar_styles(file)\n \n   included do\n     # Avatar upload\n-    has_attached_file :avatar, styles: ->(f) { avatar_styles(f) }, convert_options: { all: '+profile \"!icc,*\" +set modify-date +set create-date' }, processors: [:lazy_thumbnail]\n+    has_attached_file :avatar, styles: ->(f) { avatar_styles(f) }, convert_options: { all: '+profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' }, processors: [:lazy_thumbnail]\n     validates_attachment_content_type :avatar, content_type: IMAGE_MIME_TYPES\n     validates_attachment_size :avatar, less_than: LIMIT\n     remotable_attachment :avatar, LIMIT, suppress_errors: false\n---\napp/models/concerns/account_header.rb\n@@ -19,7 +19,7 @@ def header_styles(file)\n \n   included do\n     # Header upload\n-    has_attached_file :header, styles: ->(f) { header_styles(f) }, convert_options: { all: '+profile \"!icc,*\" +set modify-date +set create-date' }, processors: [:lazy_thumbnail]\n+    has_attached_file :header, styles: ->(f) { header_styles(f) }, convert_options: { all: '+profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' }, processors: [:lazy_thumbnail]\n     validates_attachment_content_type :header, content_type: IMAGE_MIME_TYPES\n     validates_attachment_size :header, less_than: LIMIT\n     remotable_attachment :header, LIMIT, suppress_errors: false\n---\napp/models/custom_emoji.rb\n@@ -39,7 +39,7 @@ class CustomEmoji < ApplicationRecord\n \n   has_one :local_counterpart, -> { where(domain: nil) }, class_name: 'CustomEmoji', primary_key: :shortcode, foreign_key: :shortcode, inverse_of: false\n \n-  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set modify-date +set create-date' } }, validate_media_type: false\n+  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' } }, validate_media_type: false\n \n   before_validation :downcase_domain\n \n---\napp/models/media_attachment.rb\n@@ -171,7 +171,7 @@ class MediaAttachment < ApplicationRecord\n   DEFAULT_STYLES = [:original].freeze\n \n   GLOBAL_CONVERT_OPTIONS = {\n-    all: '-quality 90 +profile \"!icc,*\" +set modify-date -define jpeg:dct-method=float +set create-date',\n+    all: '-quality 90 +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp -define jpeg:dct-method=float',\n   }.freeze\n \n   belongs_to :account,          inverse_of: :media_attachments, optional: true\n---\napp/models/preview_card.rb\n@@ -53,7 +53,7 @@ class PreviewCard < ApplicationRecord\n   has_and_belongs_to_many :statuses\n   has_one :trend, class_name: 'PreviewCardTrend', inverse_of: :preview_card, dependent: :destroy\n \n-  has_attached_file :image, processors: [:thumbnail, :blurhash_transcoder], styles: ->(f) { image_styles(f) }, convert_options: { all: '-quality 90 +profile \"!icc,*\" +set modify-date +set create-date' }, validate_media_type: false\n+  has_attached_file :image, processors: [:thumbnail, :blurhash_transcoder], styles: ->(f) { image_styles(f) }, convert_options: { all: '-quality 90 +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' }, validate_media_type: false\n \n   validates :url, presence: true, uniqueness: true\n   validates_attachment_content_type :image, content_type: IMAGE_MIME_TYPES\n---\napp/models/preview_card_provider.rb\n@@ -27,7 +27,7 @@ class PreviewCardProvider < ApplicationRecord\n \n   validates :domain, presence: true, uniqueness: true, domain: true\n \n-  has_attached_file :icon, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set modify-date +set create-date' } }, validate_media_type: false\n+  has_attached_file :icon, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' } }, validate_media_type: false\n   validates_attachment :icon, content_type: { content_type: ICON_MIME_TYPES }, size: { less_than: LIMIT }\n   remotable_attachment :icon, LIMIT\n \n---\napp/models/site_upload.rb\n@@ -41,7 +41,7 @@ class SiteUpload < ApplicationRecord\n     mascot: {}.freeze,\n   }.freeze\n \n-  has_attached_file :file, styles: ->(file) { STYLES[file.instance.var.to_sym] }, convert_options: { all: '-coalesce +profile \"!icc,*\" +set modify-date +set create-date' }, processors: [:lazy_thumbnail, :blurhash_transcoder, :type_corrector]\n+  has_attached_file :file, styles: ->(file) { STYLES[file.instance.var.to_sym] }, convert_options: { all: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' }, processors: [:lazy_thumbnail, :blurhash_transcoder, :type_corrector]\n \n   validates_attachment_content_type :file, content_type: %r{\\Aimage/.*\\z}\n   validates :file, presence: true\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Post a link to [an article](https://hackingcpp.com/cpp/libs/fmt.html) which has curly braces in title\r\n2. \r\n3.\r\n...\r\n\n\n### Expected behaviour\n\nSee article title with curly braces in link preview\n\n### Actual behaviour\n\nCurly braces in article title are shown as HTML entities\n\n### Detailed description\n\nExpected:\r\n\r\n```{fmt} Formatting & Printing Library```\r\n\r\nActual:\r\n\r\n```&lcub;fmt&rcub; Formatting & Printing Library```\r\n\n\n### Mastodon instance\n\nhttps://mastodon.gamedev.place\n\n### Mastodon version\n\n4.2.8\n\n### Browser name and version\n\nSafari 17.3.1\n\n### Operating system\n\nmacOS 14.3.1\n\n### Technical details\n\n![Screenshot 2024-05-03 at 10 56 52](https://github.com/mastodon/mastodon/assets/42672549/0d12c859-23ff-43a0-8ca2-bd2eca94bfab)\r\n\n\n---\n\nChoice A:\napp/services/verify_link_service.rb\n@@ -19,7 +19,7 @@ def call(field)\n \n   def perform_request!\n     @body = Request.new(:get, @url).add_headers('Accept' => 'text/html').perform do |res|\n-      res.code == 200 ? res.body_with_limit : nil\n+      res.code == 200 ? res.truncated_body : nil\n     end\n   end\n \n---\nspec/services/verify_link_service_spec.rb\n@@ -80,24 +80,25 @@\n         \"\n           <!doctype html>\n           <body>\n-            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\\\"\n+            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\\\">\n         \"\n       end\n \n-      it 'marks the field as not verified' do\n-        expect(field.verified?).to be false\n+      it 'marks the field as verified' do\n+        expect(field.verified?).to be true\n       end\n     end\n \n-    context 'when a link back might be truncated' do\n+    context 'when a link tag might be truncated' do\n       let(:html) do\n         \"\n           <!doctype html>\n           <body>\n-            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\"\n+            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\\\"\n+        \"\n       end\n \n-      it 'does not mark the field as verified' do\n+      it 'marks the field as not verified' do\n         expect(field.verified?).to be false\n       end\n     end\n---\napp/services/verify_link_service.rb\n@@ -19,7 +19,7 @@ def call(field)\n \n   def perform_request!\n     @body = Request.new(:get, @url).add_headers('Accept' => 'text/html').perform do |res|\n-      res.code == 200 ? res.body_with_limit : nil\n+      res.code == 200 ? res.truncated_body : nil\n     end\n   end\n \n---\nspec/services/verify_link_service_spec.rb\n@@ -78,24 +78,25 @@\n         \"\n           <!doctype html>\n           <body>\n-            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\\\"\n+            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\\\">\n         \"\n       end\n \n-      it 'marks the field as not verified' do\n-        expect(field.verified?).to be false\n+      it 'marks the field as verified' do\n+        expect(field.verified?).to be true\n       end\n     end\n \n-    context 'when a link back might be truncated' do\n+    context 'when a link tag might be truncated' do\n       let(:html) do\n         \"\n           <!doctype html>\n           <body>\n-            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\"\n+            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\\\"\n+        \"\n       end\n \n-      it 'does not mark the field as verified' do\n+      it 'marks the field as not verified' do\n         expect(field.verified?).to be false\n       end\n     end\n---\nspec/services/verify_link_service_spec.rb\n@@ -77,11 +77,11 @@\n \n     context 'when a document is truncated but the link back is valid' do\n       let(:html) do\n-        \"\n+        <<-HTML\n           <!doctype html>\n           <body>\n-            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\\\">\n-        \"\n+            <a rel=\"me\" href=\"#{ActivityPub::TagManager.instance.url_for(account)}\">\n+        HTML\n       end\n \n       it 'marks the field as verified' do\n@@ -91,11 +91,11 @@\n \n     context 'when a link tag might be truncated' do\n       let(:html) do\n-        \"\n+        <<-HTML_TRUNCATED\n           <!doctype html>\n           <body>\n-            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\\\"\n-        \"\n+            <a rel=\"me\" href=\"#{ActivityPub::TagManager.instance.url_for(account)}\"\n+        HTML_TRUNCATED\n       end\n \n       it 'marks the field as not verified' do\n@@ -166,7 +166,11 @@\n       #\n       # apparently github allows the user to enter website URLs with a single\n       # slash and makes no attempts to correct that.\n-      let(:html) { '<a href=\"http:/unrelated.example\">Hello</a>' }\n+      let(:html) do\n+        <<-HTML\n+          <a href=\"http:/unrelated.example\">Hello</a>\n+        HTML\n+      end\n \n       it 'does not crash' do\n         # We could probably put more effort into perhaps auto-correcting the\n---\nCHANGELOG.md\n@@ -2,6 +2,26 @@\n \n All notable changes to this project will be documented in this file.\n \n+## [4.2.8] - 2024-02-23\n+\n+### Added\n+\n+- Add hourly task to automatically require approval for new registrations in the absence of moderators ([ClearlyClaire](https://github.com/mastodon/mastodon/pull/29318), [ClearlyClaire](https://github.com/mastodon/mastodon/pull/29355))\n+  In order to prevent future abandoned Mastodon servers from being used for spam, harassment and other malicious activity, Mastodon will now automatically switch new user registrations to require moderator approval whenever they are left open and no activity (including non-moderation actions from apps) from any logged-in user with permission to access moderation reports has been detected in a full week.\n+  When this happens, users with the permission to change server settings will receive an email notification.\n+  This feature is disabled when `EMAIL_DOMAIN_ALLOWLIST` is used, and can also be disabled with `DISABLE_AUTOMATIC_SWITCHING_TO_APPROVED_REGISTRATIONS=true`.\n+\n+### Changed\n+\n+- Change registrations to be closed by default on new installations ([ClearlyClaire](https://github.com/mastodon/mastodon/pull/29280))\n+  If you are running a server and never changed your registrations mode from the default, updating will automatically close your registrations.\n+  Simply re-enable them through the administration interface or using `tootctl settings registrations open` if you want to enable them again.\n+\n+### Fixed\n+\n+- Fix processing of remote ActivityPub actors making use of `Link` objects as `Image` `url` ([ClearlyClaire](https://github.com/mastodon/mastodon/pull/29335))\n+- Fix link verifications when page size exceeds 1MB ([ClearlyClaire](https://github.com/mastodon/mastodon/pull/29358))\n+\n ## [4.2.7] - 2024-02-16\n \n ### Fixed\n---\ndocker-compose.yml\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bash -c \"rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000\"\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\nlib/mastodon/version.rb\n@@ -13,7 +13,7 @@ def minor\n     end\n \n     def patch\n-      7\n+      8\n     end\n \n     def default_prerelease\n---\n\n\n---\n\nChoice B:\napp/lib/link_details_extractor.rb\n@@ -282,6 +282,6 @@ def detector\n   end\n \n   def html_entities\n-    @html_entities ||= HTMLEntities.new\n+    @html_entities ||= HTMLEntities.new(:expanded)\n   end\n end\n---\n\n\n---\n\nChoice C:\nconfig/application.rb\n@@ -64,13 +64,6 @@ class Application < Rails::Application\n     # Initialize configuration defaults for originally generated Rails version.\n     config.load_defaults 7.0\n \n-    # TODO: Release a version which uses the 7.0 defaults as specified above,\n-    # but preserves the 6.1 cache format as set below. In a subsequent change,\n-    # remove this line setting to 6.1 cache format, and then release another version.\n-    # https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#new-activesupport-cache-serialization-format\n-    # https://github.com/mastodon/mastodon/pull/24241#discussion_r1162890242\n-    config.active_support.cache_format_version = 6.1\n-\n     # Please, add to the `ignore` list any other `lib` subdirectories that do\n     # not contain `.rb` files, or that should not be reloaded or eager loaded.\n     # Common ones are `templates`, `generators`, or `middleware`, for example.\n---\n\n\n---\n\nChoice D:\napp/lib/link_details_extractor.rb\n@@ -101,7 +101,7 @@ def root_array(root)\n     end\n \n     def json\n-      @json ||= root_array(Oj.load(@data)).find { |obj| SUPPORTED_TYPES.include?(obj['@type']) } || {}\n+      @json ||= root_array(Oj.load(@data)).compact.find { |obj| SUPPORTED_TYPES.include?(obj['@type']) } || {}\n     end\n   end\n \n---\nspec/lib/link_details_extractor_spec.rb\n@@ -129,6 +129,24 @@\n       include_examples 'structured data'\n     end\n \n+    context 'with the first tag is null' do\n+      let(:html) { <<~HTML }\n+        <!doctype html>\n+        <html>\n+        <body>\n+          <script type=\"application/ld+json\">\n+            null\n+          </script>\n+          <script type=\"application/ld+json\">\n+            #{ld_json}\n+          </script>\n+        </body>\n+        </html>\n+      HTML\n+\n+      include_examples 'structured data'\n+    end\n+\n     context 'with preceding block of unsupported LD+JSON' do\n       let(:html) { <<~HTML }\n         <!doctype html>\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Pitch\n\nAny content (post, media, or accounts) that is made inaccessible through moderation action should sill be accessible to moderators when an appeal is reviewed. Similarly, if the moderator intervention is overturned then the content should be restored; which is not possible if it's been purged from the system.\r\n\r\nWhen intervening with reports, there should be an option to \"deny appeal\" which would have today's behavior of (near) immediate deletion. However, this should require opt-in so that any appeal can be fully actioned. \n\n### Motivation\n\nWhile there are definitely compliance cases where media should be immediately purged, offending content should generally be accessible for appeal. The moderation team at SFBA requires that a different moderator than the intervening one reviews any appeal. Not having the context for the posts makes this checked workflow much more difficult; since the content is often deleted before the appeal is filed or reviewed. \r\n\r\nThis aggressive deletion pattern makes auditing and reviewing moderation interventions near impossible at times. \r\n\r\n![486-622-max](https://github.com/mastodon/mastodon/assets/6901054/39c77e6b-1538-450c-8fb3-5060fda9b0e1)\n\n---\n\nChoice A:\napp/controllers/auth/sessions_controller.rb\n@@ -187,4 +187,15 @@ def on_authentication_failure(user, security_measure, failure_reason)\n   def second_factor_attempts_key(user)\n     \"2fa_auth_attempts:#{user.id}:#{Time.now.utc.hour}\"\n   end\n+\n+  def respond_to_on_destroy\n+    respond_to do |format|\n+      format.json do\n+        render json: {\n+          redirect_to: after_sign_out_path_for(resource_name),\n+        }, status: 200\n+      end\n+      format.all { super }\n+    end\n+  end\n end\n---\napp/javascript/mastodon/features/ui/components/confirmation_modals/log_out.tsx\n@@ -25,7 +25,7 @@ export const ConfirmLogOutModal: React.FC<BaseConfirmationModalProps> = ({\n   const intl = useIntl();\n \n   const onConfirm = useCallback(() => {\n-    logOut();\n+    void logOut();\n   }, []);\n \n   return (\n---\napp/javascript/mastodon/utils/log_out.ts\n@@ -1,36 +1,20 @@\n-export const logOut = () => {\n-  const form = document.createElement('form');\n+import api from 'mastodon/api';\n \n-  const methodInput = document.createElement('input');\n-  methodInput.setAttribute('name', '_method');\n-  methodInput.setAttribute('value', 'delete');\n-  methodInput.setAttribute('type', 'hidden');\n-  form.appendChild(methodInput);\n+export async function logOut() {\n+  try {\n+    const response = await api(false).delete<{ redirect_to?: string }>(\n+      '/auth/sign_out',\n+      { headers: { Accept: 'application/json' }, withCredentials: true },\n+    );\n \n-  const csrfToken = document.querySelector<HTMLMetaElement>(\n-    'meta[name=csrf-token]',\n-  );\n-\n-  const csrfParam = document.querySelector<HTMLMetaElement>(\n-    'meta[name=csrf-param]',\n-  );\n-\n-  if (csrfParam && csrfToken) {\n-    const csrfInput = document.createElement('input');\n-    csrfInput.setAttribute('name', csrfParam.content);\n-    csrfInput.setAttribute('value', csrfToken.content);\n-    csrfInput.setAttribute('type', 'hidden');\n-    form.appendChild(csrfInput);\n+    if (response.status === 200 && response.data.redirect_to)\n+      window.location.href = response.data.redirect_to;\n+    else\n+      console.error(\n+        'Failed to log out, got an unexpected non-redirect response from the server',\n+        response,\n+      );\n+  } catch (error) {\n+    console.error('Failed to log out, response was an error', error);\n   }\n-\n-  const submitButton = document.createElement('input');\n-  submitButton.setAttribute('type', 'submit');\n-  form.appendChild(submitButton);\n-\n-  form.method = 'post';\n-  form.action = '/auth/sign_out';\n-  form.style.display = 'none';\n-\n-  document.body.appendChild(form);\n-  submitButton.click();\n-};\n+}\n---\nspec/requests/log_out_spec.rb\n@@ -0,0 +1,30 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+describe 'Log Out' do\n+  include RoutingHelper\n+\n+  describe 'DELETE /auth/sign_out' do\n+    let(:user) { Fabricate(:user) }\n+\n+    before do\n+      sign_in user\n+    end\n+\n+    it 'Logs out the user and redirect' do\n+      delete '/auth/sign_out'\n+\n+      expect(response).to redirect_to('/auth/sign_in')\n+    end\n+\n+    it 'Logs out the user and return a page to redirect to with a JSON request' do\n+      delete '/auth/sign_out', headers: { 'HTTP_ACCEPT' => 'application/json' }\n+\n+      expect(response).to have_http_status(200)\n+      expect(response.media_type).to eq 'application/json'\n+\n+      expect(body_as_json[:redirect_to]).to eq '/auth/sign_in'\n+    end\n+  end\n+end\n---\nspec/system/log_out_spec.rb\n@@ -0,0 +1,43 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+describe 'Log out' do\n+  include ProfileStories\n+\n+  before do\n+    as_a_logged_in_user\n+  end\n+\n+  describe 'Logging out from the preferences' do\n+    it 'logs the user out' do\n+      visit settings_path\n+\n+      within '.sidebar' do\n+        click_on 'Logout'\n+      end\n+\n+      expect(page).to have_title(I18n.t('auth.login'))\n+      expect(page).to have_current_path('/auth/sign_in')\n+    end\n+  end\n+\n+  describe 'Logging out from the JS app', :js, :streaming do\n+    it 'logs the user out' do\n+      visit root_path\n+\n+      within '.navigation-bar' do\n+        click_on 'Menu'\n+      end\n+\n+      within '.dropdown-menu' do\n+        click_on 'Logout'\n+      end\n+\n+      click_on 'Log out'\n+\n+      expect(page).to have_title(I18n.t('auth.login'))\n+      expect(page).to have_current_path('/auth/sign_in')\n+    end\n+  end\n+end\n---\n\n\n---\n\nChoice B:\napp/models/status.rb\n@@ -266,7 +266,7 @@ def non_sensitive_with_media?\n   end\n \n   def reported?\n-    @reported ||= Report.where(target_account: account).unresolved.exists?(['? = ANY(status_ids)', id])\n+    @reported ||= account.targeted_reports.unresolved.exists?(['? = ANY(status_ids)', id]) || account.strikes.exists?(['? = ANY(status_ids)', id.to_s])\n   end\n \n   def emojis\n---\nspec/models/status_spec.rb\n@@ -205,6 +205,48 @@\n     end\n   end\n \n+  describe '#reported?' do\n+    context 'when the status is not reported' do\n+      it 'returns false' do\n+        expect(subject.reported?).to be false\n+      end\n+    end\n+\n+    context 'when the status is part of an open report' do\n+      before do\n+        Fabricate(:report, target_account: subject.account, status_ids: [subject.id])\n+      end\n+\n+      it 'returns true' do\n+        expect(subject.reported?).to be true\n+      end\n+    end\n+\n+    context 'when the status is part of a closed report with an account warning mentioning the account' do\n+      before do\n+        report = Fabricate(:report, target_account: subject.account, status_ids: [subject.id])\n+        report.resolve!(Fabricate(:account))\n+        Fabricate(:account_warning, target_account: subject.account, status_ids: [subject.id], report: report)\n+      end\n+\n+      it 'returns true' do\n+        expect(subject.reported?).to be true\n+      end\n+    end\n+\n+    context 'when the status is part of a closed report with an account warning not mentioning the account' do\n+      before do\n+        report = Fabricate(:report, target_account: subject.account, status_ids: [subject.id])\n+        report.resolve!(Fabricate(:account))\n+        Fabricate(:account_warning, target_account: subject.account, report: report)\n+      end\n+\n+      it 'returns false' do\n+        expect(subject.reported?).to be false\n+      end\n+    end\n+  end\n+\n   describe '.mutes_map' do\n     subject { described_class.mutes_map([status.conversation.id], account) }\n \n---\n\n\n---\n\nChoice C:\napp/helpers/languages_helper.rb\n@@ -254,6 +254,7 @@ def standard_locale_name(locale)\n \n   def valid_locale_or_nil(str)\n     return if str.blank?\n+    return str if valid_locale?(str)\n \n     code, = str.to_s.split(/[_-]/) # Strip out the region from e.g. en_US or ja-JP\n \n---\n\n\n---\n\nChoice D:\napp/controllers/admin/domain_blocks_controller.rb\n@@ -37,7 +37,7 @@ def create\n         @domain_block.errors.delete(:domain)\n         render :new\n       else\n-        if existing_domain_block.present?\n+        if existing_domain_block.present? && existing_domain_block.domain == resource_params[:domain]\n           @domain_block = existing_domain_block\n           @domain_block.update(resource_params)\n         end\n---\nspec/controllers/admin/domain_blocks_controller_spec.rb\n@@ -68,6 +68,26 @@\n       expect(flash[:notice]).to eq I18n.t('admin.domain_blocks.created_msg')\n       expect(response).to redirect_to(admin_instances_path(limited: '1'))\n     end\n+\n+    context 'when a block for a parent domain already exists' do\n+      subject { post :create, params: { domain_block: { domain: 'subdomain.example.com', severity: child_severity } } }\n+\n+      let(:parent_severity) { 'silence' }\n+      let(:child_severity)  { 'suspend' }\n+\n+      before do\n+        Fabricate(:domain_block, domain: 'example.com', severity: parent_severity)\n+      end\n+\n+      it 'does not change the existing block' do\n+        expect { subject }.to_not change { DomainBlock.find_by(domain: 'example.com') }\n+      end\n+\n+      it 'creates a domain block with expected severity' do\n+        subject\n+        expect(DomainBlock.where(domain: 'subdomain.example.com', severity: child_severity)).to exist\n+      end\n+    end\n   end\n \n   describe 'PUT #update' do\n---\napp/controllers/admin/domain_blocks_controller.rb\n@@ -40,7 +40,7 @@ def create\n       end\n \n       # Allow transparently upgrading a domain block\n-      if existing_domain_block.present?\n+      if existing_domain_block.present? && existing_domain_block.domain == TagManager.instance.normalize_domain(@domain_block.domain.strip)\n         @domain_block = existing_domain_block\n         @domain_block.assign_attributes(resource_params)\n       end\n---\nspec/features/admin/domain_blocks_spec.rb\n@@ -57,6 +57,30 @@\n     end\n   end\n \n+  context 'when suspending a subdomain of an already-silenced domain' do\n+    it 'presents a confirmation screen before suspending the domain' do\n+      domain_block = Fabricate(:domain_block, domain: 'example.com', severity: 'silence')\n+\n+      visit new_admin_domain_block_path\n+\n+      fill_in 'domain_block_domain', with: 'subdomain.example.com'\n+      select I18n.t('admin.domain_blocks.new.severity.suspend'), from: 'domain_block_severity'\n+      click_on I18n.t('admin.domain_blocks.new.create')\n+\n+      # It presents a confirmation screen\n+      expect(page).to have_title(I18n.t('admin.domain_blocks.confirm_suspension.title', domain: 'subdomain.example.com'))\n+\n+      # Confirming creates the block\n+      click_on I18n.t('admin.domain_blocks.confirm_suspension.confirm')\n+\n+      expect(DomainBlock.where(domain: 'subdomain.example.com', severity: 'suspend')).to exist\n+\n+      # And leaves the previous block alone\n+      expect(domain_block.reload.severity).to eq 'silence'\n+      expect(domain_block.reload.domain).to eq 'example.com'\n+    end\n+  end\n+\n   context 'when editing a domain block' do\n     it 'presents a confirmation screen before suspending the domain' do\n       domain_block = Fabricate(:domain_block, domain: 'example.com', severity: 'silence')\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Goto the \"pending review\" page for trending hashtags (admin/trends/tags?status=pending_review) when there are multiple tags awaiting approval \r\n2. observe what hashtags are on the first page\r\n3. Hit Ctrl+R or your favourite page reload process.\r\n4. observe a completely different set of hashtags.\r\n\r\n\r\n### Expected behaviour\r\n\r\nThe hashtags for review will always appear in a consistent order\r\n\r\n### Actual behaviour\r\n\r\nThe sort order appears random, this is exacerbated when there are multiple pages \r\n\r\n### Detailed description\r\n\r\nI think the above covers it well.  The reason this is a specific issue is I have ~800 tags to review and my intended process was to start at the end, allow all the ones I liked on the last page, then I could disallow anything remaining on the last page.  However since the contents of the page keep changing it means I can't know which tags on the page I have already discounted and haveto review them all again.\r\n\r\n### Mastodon instance\r\n\r\nmstdn.crmbl.uk\r\n\r\n### Mastodon version\r\n\r\nv4.2.8\r\n\r\n### Browser name and version\r\n\r\nVivaldi 6.7.3329.21 (Stable channel) (64-bit) \r\n\r\n### Operating system\r\n\r\nWindows 11\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/components/admin/Retention.jsx\n@@ -9,11 +9,12 @@ import api from 'mastodon/api';\n import { roundTo10 } from 'mastodon/utils/numbers';\n \n const dateForCohort = cohort => {\n+  const timeZone = 'UTC';\n   switch(cohort.frequency) {\n   case 'day':\n-    return <FormattedDate value={cohort.period} month='long' day='2-digit' />;\n+    return <FormattedDate value={cohort.period} month='long' day='2-digit' timeZone={timeZone} />;\n   default:\n-    return <FormattedDate value={cohort.period} month='long' year='numeric' />;\n+    return <FormattedDate value={cohort.period} month='long' year='numeric' timeZone={timeZone} />;\n   }\n };\n \n---\n\n\n---\n\nChoice B:\napp/models/account.rb\n@@ -144,6 +144,7 @@ class Account < ApplicationRecord\n   scope :dormant, -> { joins(:account_stat).merge(AccountStat.without_recent_activity) }\n   scope :with_username, ->(value) { where arel_table[:username].lower.eq(value.to_s.downcase) }\n   scope :with_domain, ->(value) { where arel_table[:domain].lower.eq(value&.to_s&.downcase) }\n+  scope :without_memorial, -> { where(memorial: false) }\n \n   after_update_commit :trigger_update_webhooks\n \n---\napp/models/account_suggestions/friends_of_friends_source.rb\n@@ -31,6 +31,7 @@ def source_query(account, limit: DEFAULT_LIMIT)\n         AND accounts.suspended_at IS NULL\n         AND accounts.silenced_at IS NULL\n         AND accounts.moved_to_account_id IS NULL\n+        AND accounts.memorial = FALSE\n         AND follow_recommendation_mutes.target_account_id IS NULL\n       GROUP BY accounts.id, account_stats.id\n       ORDER BY frequency DESC, account_stats.followers_count ASC\n---\napp/models/account_suggestions/source.rb\n@@ -14,6 +14,7 @@ def base_account_scope(account)\n       .searchable\n       .where(discoverable: true)\n       .without_silenced\n+      .without_memorial\n       .where.not(follows_sql, id: account.id)\n       .where.not(follow_requests_sql, id: account.id)\n       .not_excluded_by_account(account)\n---\nspec/models/account_suggestions/friends_of_friends_source_spec.rb\n@@ -15,6 +15,7 @@\n     let!(:john) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:jerk) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:larry) { Fabricate(:account, discoverable: true, hide_collections: false) }\n+    let!(:morty) { Fabricate(:account, discoverable: true, hide_collections: false, memorial: true) }\n \n     context 'with follows and blocks' do\n       before do\n@@ -27,8 +28,8 @@\n         # alice follows eve and mallory\n         [john, mallory].each { |account| alice.follow!(account) }\n \n-        # eugen follows eve, john, jerk, larry and neil\n-        [eve, mallory, jerk, larry, neil].each { |account| eugen.follow!(account) }\n+        # eugen follows eve, john, jerk, larry, neil and morty\n+        [eve, mallory, jerk, larry, neil, morty].each { |account| eugen.follow!(account) }\n       end\n \n       it 'returns eligible accounts', :aggregate_failures do\n@@ -51,6 +52,9 @@\n \n         # the suggestion for neil has already been rejected\n         expect(results).to_not include([neil.id, :friends_of_friends])\n+\n+        # morty is not included because his account is in memoriam\n+        expect(results).to_not include([morty.id, :friends_of_friends])\n       end\n     end\n \n---\nspec/models/account_suggestions/source_spec.rb\n@@ -21,6 +21,7 @@\n       let!(:moved_account) { Fabricate(:account, moved_to_account: Fabricate(:account), discoverable: true) }\n       let!(:silenced_account) { Fabricate(:account, silenced: true, discoverable: true) }\n       let!(:undiscoverable_account) { Fabricate(:account, discoverable: false) }\n+      let!(:memorial_account) { Fabricate(:account, memorial: true, discoverable: true) }\n \n       before do\n         Fabricate :account_domain_block, account: account, domain: account_domain_blocked_account.domain\n@@ -44,6 +45,7 @@\n           .and not_include(moved_account)\n           .and not_include(silenced_account)\n           .and not_include(undiscoverable_account)\n+          .and not_include(memorial_account)\n       end\n     end\n   end\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -9284,14 +9284,17 @@ noscript {\n     0 10px 15px -3px rgba($base-shadow-color, 0.25),\n     0 4px 6px -4px rgba($base-shadow-color, 0.25);\n   cursor: default;\n-  transition: 0.5s cubic-bezier(0.89, 0.01, 0.5, 1.1);\n-  transform: translateZ(0);\n   font-size: 15px;\n   line-height: 21px;\n \n   &.notification-bar-active {\n     inset-inline-start: 1rem;\n   }\n+\n+  .no-reduce-motion & {\n+    transition: 0.5s cubic-bezier(0.89, 0.01, 0.5, 1.1);\n+    transform: translateZ(0);\n+  }\n }\n \n .notification-bar-title {\n---\n\n\n---\n\nChoice D:\napp/models/trends/tag_filter.rb\n@@ -14,7 +14,7 @@ def initialize(params)\n \n   def results\n     scope = if params[:status] == 'pending_review'\n-              Tag.unscoped\n+              Tag.unscoped.order(id: :desc)\n             else\n               trending_scope\n             end\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\nTry to boost a post with confirmation modal enabled\r\n\r\n### Expected behaviour\r\n\r\nBoost modal appears in the middle of the page\r\n\r\n### Actual behaviour\r\n\r\nBoost modal appears at the bottom of the page\r\n\r\n### Detailed description\r\n\r\nThere's probably a media query / breakpoint being set for some CSS that moves the modal to the bottom, but it seems to only account for the default/simple UI and not the advanced UI. This bug is hitting me even at 1021px wide.\r\n\r\n### Mastodon instance\r\n\r\nmastodon.social v4.3.0-nightly.2024-04-29\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -5616,7 +5616,7 @@ a.status-card {\n   user-select: text;\n   display: flex;\n \n-  @media screen and (max-width: $no-gap-breakpoint) {\n+  @media screen and (width <= 630px) {\n     margin-top: auto;\n   }\n }\n---\n\n\n---\n\nChoice B:\napp/lib/link_details_extractor.rb\n@@ -156,11 +156,11 @@ def height\n   end\n \n   def title\n-    html_entities.decode(structured_data&.headline || opengraph_tag('og:title') || document.xpath('//title').map(&:content).first).strip\n+    html_entities_decode(structured_data&.headline || opengraph_tag('og:title') || document.xpath('//title').map(&:content).first).strip\n   end\n \n   def description\n-    html_entities.decode(structured_data&.description || opengraph_tag('og:description') || meta_tag('description'))\n+    html_entities_decode(structured_data&.description || opengraph_tag('og:description') || meta_tag('description'))\n   end\n \n   def published_at\n@@ -180,15 +180,15 @@ def canonical_url\n   end\n \n   def provider_name\n-    html_entities.decode(structured_data&.publisher_name || opengraph_tag('og:site_name'))\n+    html_entities_decode(structured_data&.publisher_name || opengraph_tag('og:site_name'))\n   end\n \n   def provider_url\n     valid_url_or_nil(host_to_url(opengraph_tag('og:site')))\n   end\n \n   def author_name\n-    html_entities.decode(structured_data&.author_name || opengraph_tag('og:author') || opengraph_tag('og:author:username'))\n+    html_entities_decode(structured_data&.author_name || opengraph_tag('og:author') || opengraph_tag('og:author:username'))\n   end\n \n   def author_url\n@@ -257,7 +257,7 @@ def structured_data\n \n       next if json_ld.blank?\n \n-      structured_data = StructuredData.new(html_entities.decode(json_ld))\n+      structured_data = StructuredData.new(html_entities_decode(json_ld))\n \n       next unless structured_data.valid?\n \n@@ -273,10 +273,11 @@ def document\n   end\n \n   def detect_encoding_and_parse_document\n-    [detect_encoding, nil, @html_charset, 'UTF-8'].uniq.each do |encoding|\n+    [detect_encoding, nil, @html_charset].uniq.each do |encoding|\n       document = Nokogiri::HTML(@html, nil, encoding)\n       return document if document.to_s.valid_encoding?\n     end\n+    Nokogiri::HTML(@html, nil, 'UTF-8')\n   end\n \n   def detect_encoding\n@@ -290,6 +291,15 @@ def detector\n     end\n   end\n \n+  def html_entities_decode(string)\n+    return if string.nil?\n+\n+    unicode_string = string.encode('UTF-8')\n+    raise EncodingError, 'cannot convert string to valid UTF-8' unless unicode_string.valid_encoding?\n+\n+    html_entities.decode(unicode_string)\n+  end\n+\n   def html_entities\n     @html_entities ||= HTMLEntities.new(:expanded)\n   end\n---\napp/services/fetch_link_card_service.rb\n@@ -32,7 +32,7 @@ def call(status)\n     end\n \n     attach_card if @card&.persisted?\n-  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError, Encoding::UndefinedConversionError => e\n+  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError, EncodingError => e\n     Rails.logger.debug { \"Error fetching link #{@original_url}: #{e}\" }\n     nil\n   end\n---\nspec/fixtures/requests/latin1_posing_as_utf8_broken.txt\n@@ -0,0 +1,17 @@\n+HTTP/1.1 200 OK\n+server: nginx\n+date: Thu, 13 Jun 2024 14:33:13 GMT\n+content-type: text/html; charset=utf-8\n+content-length: 158\n+accept-ranges: bytes\n+\n+<!doctype html>\n+<html lang=\"en\">\n+<head>\n+  <meta charset=\"UTF-8\">\n+  <title>Tofu \ufffd l'orange</title>\n+</head>\n+<body>\n+  <h2>Tofu \ufffd l'orange</h2>\n+</body>\n+</html>\n---\nspec/fixtures/requests/latin1_posing_as_utf8_recoverable.txt\n@@ -0,0 +1,17 @@\n+HTTP/1.1 200 OK\n+server: nginx\n+date: Thu, 13 Jun 2024 14:33:13 GMT\n+content-type: text/html; charset=utf-8\n+content-length: 158\n+accept-ranges: bytes\n+\n+<!doctype html>\n+<html lang=\"en\">\n+<head>\n+  <meta charset=\"UTF-8\">\n+  <title>Tofu with orange sauce</title>\n+</head>\n+<body>\n+  <h2>Tofu \ufffd l'orange</h2>\n+</body>\n+</html>\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -27,6 +27,8 @@\n     stub_request(:get, 'http://example.com/koi8-r').to_return(request_fixture('koi8-r.txt'))\n     stub_request(:get, 'http://example.com/windows-1251').to_return(request_fixture('windows-1251.txt'))\n     stub_request(:get, 'http://example.com/low_confidence_latin1').to_return(request_fixture('low_confidence_latin1.txt'))\n+    stub_request(:get, 'http://example.com/latin1_posing_as_utf8_broken').to_return(request_fixture('latin1_posing_as_utf8_broken.txt'))\n+    stub_request(:get, 'http://example.com/latin1_posing_as_utf8_recoverable').to_return(request_fixture('latin1_posing_as_utf8_recoverable.txt'))\n     stub_request(:get, 'http://example.com/aergerliche-umlaute').to_return(request_fixture('redirect_with_utf8_url.txt'))\n \n     Rails.cache.write('oembed_endpoint:example.com', oembed_cache) if oembed_cache\n@@ -159,10 +161,30 @@\n     end\n \n     context 'with a URL of a page in ISO-8859-1 encoding, that charlock_holmes cannot detect' do\n-      let(:status) { Fabricate(:status, text: 'Check out http://example.com/low_confidence_latin1') }\n+      context 'when encoding in http header is correct' do\n+        let(:status) { Fabricate(:status, text: 'Check out http://example.com/low_confidence_latin1') }\n \n-      it 'decodes the HTML' do\n-        expect(status.preview_card.title).to eq(\"Tofu \u00e1 l'orange\")\n+        it 'decodes the HTML' do\n+          expect(status.preview_card.title).to eq(\"Tofu \u00e1 l'orange\")\n+        end\n+      end\n+\n+      context 'when encoding in http header is incorrect' do\n+        context 'when encoding problems appear in unrelated tags' do\n+          let(:status) { Fabricate(:status, text: 'Check out http://example.com/latin1_posing_as_utf8_recoverable') }\n+\n+          it 'decodes the HTML' do\n+            expect(status.preview_card.title).to eq('Tofu with orange sauce')\n+          end\n+        end\n+\n+        context 'when encoding problems appear in title tag' do\n+          let(:status) { Fabricate(:status, text: 'Check out http://example.com/latin1_posing_as_utf8_broken') }\n+\n+          it 'does not create a preview card' do\n+            expect(status.preview_card).to be_nil\n+          end\n+        end\n       end\n     end\n \n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/actions/interactions.js\n@@ -1,5 +1,6 @@\n-import api from '../api';\n+import api, { getLinks } from '../api';\n \n+import { fetchRelationships } from './accounts';\n import { importFetchedAccounts, importFetchedStatus } from './importer';\n \n export const REBLOG_REQUEST = 'REBLOG_REQUEST';\n@@ -26,6 +27,10 @@ export const FAVOURITES_FETCH_REQUEST = 'FAVOURITES_FETCH_REQUEST';\n export const FAVOURITES_FETCH_SUCCESS = 'FAVOURITES_FETCH_SUCCESS';\n export const FAVOURITES_FETCH_FAIL    = 'FAVOURITES_FETCH_FAIL';\n \n+export const FAVOURITES_EXPAND_REQUEST = 'FAVOURITES_EXPAND_REQUEST';\n+export const FAVOURITES_EXPAND_SUCCESS = 'FAVOURITES_EXPAND_SUCCESS';\n+export const FAVOURITES_EXPAND_FAIL = 'FAVOURITES_EXPAND_FAIL';\n+\n export const PIN_REQUEST = 'PIN_REQUEST';\n export const PIN_SUCCESS = 'PIN_SUCCESS';\n export const PIN_FAIL    = 'PIN_FAIL';\n@@ -308,8 +313,10 @@ export function fetchFavourites(id) {\n     dispatch(fetchFavouritesRequest(id));\n \n     api(getState).get(`/api/v1/statuses/${id}/favourited_by`).then(response => {\n+      const next = getLinks(response).refs.find(link => link.rel === 'next');\n       dispatch(importFetchedAccounts(response.data));\n-      dispatch(fetchFavouritesSuccess(id, response.data));\n+      dispatch(fetchFavouritesSuccess(id, response.data, next ? next.uri : null));\n+      dispatch(fetchRelationships(response.data.map(item => item.id)));\n     }).catch(error => {\n       dispatch(fetchFavouritesFail(id, error));\n     });\n@@ -323,17 +330,62 @@ export function fetchFavouritesRequest(id) {\n   };\n }\n \n-export function fetchFavouritesSuccess(id, accounts) {\n+export function fetchFavouritesSuccess(id, accounts, next) {\n   return {\n     type: FAVOURITES_FETCH_SUCCESS,\n     id,\n     accounts,\n+    next,\n   };\n }\n \n export function fetchFavouritesFail(id, error) {\n   return {\n     type: FAVOURITES_FETCH_FAIL,\n+    id,\n+    error,\n+  };\n+}\n+\n+export function expandFavourites(id) {\n+  return (dispatch, getState) => {\n+    const url = getState().getIn(['user_lists', 'favourited_by', id, 'next']);\n+    if (url === null) {\n+      return;\n+    }\n+\n+    dispatch(expandFavouritesRequest(id));\n+\n+    api(getState).get(url).then(response => {\n+      const next = getLinks(response).refs.find(link => link.rel === 'next');\n+\n+      dispatch(importFetchedAccounts(response.data));\n+      dispatch(expandFavouritesSuccess(id, response.data, next ? next.uri : null));\n+      dispatch(fetchRelationships(response.data.map(item => item.id)));\n+    }).catch(error => dispatch(expandFavouritesFail(id, error)));\n+  };\n+}\n+\n+export function expandFavouritesRequest(id) {\n+  return {\n+    type: FAVOURITES_EXPAND_REQUEST,\n+    id,\n+  };\n+}\n+\n+export function expandFavouritesSuccess(id, accounts, next) {\n+  return {\n+    type: FAVOURITES_EXPAND_SUCCESS,\n+    id,\n+    accounts,\n+    next,\n+  };\n+}\n+\n+export function expandFavouritesFail(id, error) {\n+  return {\n+    type: FAVOURITES_EXPAND_FAIL,\n+    id,\n     error,\n   };\n }\n---\napp/javascript/mastodon/features/favourites/index.jsx\n@@ -8,7 +8,9 @@ import ImmutablePropTypes from 'react-immutable-proptypes';\n import ImmutablePureComponent from 'react-immutable-pure-component';\n import { connect } from 'react-redux';\n \n-import { fetchFavourites } from 'mastodon/actions/interactions';\n+import { debounce } from 'lodash';\n+\n+import { fetchFavourites, expandFavourites } from 'mastodon/actions/interactions';\n import ColumnHeader from 'mastodon/components/column_header';\n import { Icon }  from 'mastodon/components/icon';\n import { LoadingIndicator } from 'mastodon/components/loading_indicator';\n@@ -21,7 +23,9 @@ const messages = defineMessages({\n });\n \n const mapStateToProps = (state, props) => ({\n-  accountIds: state.getIn(['user_lists', 'favourited_by', props.params.statusId]),\n+  accountIds: state.getIn(['user_lists', 'favourited_by', props.params.statusId, 'items']),\n+  hasMore: !!state.getIn(['user_lists', 'favourited_by', props.params.statusId, 'next']),\n+  isLoading: state.getIn(['user_lists', 'favourited_by', props.params.statusId, 'isLoading'], true),\n });\n \n class Favourites extends ImmutablePureComponent {\n@@ -30,6 +34,8 @@ class Favourites extends ImmutablePureComponent {\n     params: PropTypes.object.isRequired,\n     dispatch: PropTypes.func.isRequired,\n     accountIds: ImmutablePropTypes.list,\n+    hasMore: PropTypes.bool,\n+    isLoading: PropTypes.bool,\n     multiColumn: PropTypes.bool,\n     intl: PropTypes.object.isRequired,\n   };\n@@ -40,18 +46,16 @@ class Favourites extends ImmutablePureComponent {\n     }\n   }\n \n-  UNSAFE_componentWillReceiveProps (nextProps) {\n-    if (nextProps.params.statusId !== this.props.params.statusId && nextProps.params.statusId) {\n-      this.props.dispatch(fetchFavourites(nextProps.params.statusId));\n-    }\n-  }\n-\n   handleRefresh = () => {\n     this.props.dispatch(fetchFavourites(this.props.params.statusId));\n   };\n \n+  handleLoadMore = debounce(() => {\n+    this.props.dispatch(expandFavourites(this.props.params.statusId));\n+  }, 300, { leading: true });\n+\n   render () {\n-    const { intl, accountIds, multiColumn } = this.props;\n+    const { intl, accountIds, hasMore, isLoading, multiColumn } = this.props;\n \n     if (!accountIds) {\n       return (\n@@ -75,6 +79,9 @@ class Favourites extends ImmutablePureComponent {\n \n         <ScrollableList\n           scrollKey='favourites'\n+          onLoadMore={this.handleLoadMore}\n+          hasMore={hasMore}\n+          isLoading={isLoading}\n           emptyMessage={emptyMessage}\n           bindToDocument={!multiColumn}\n         >\n---\napp/javascript/mastodon/reducers/user_lists.js\n@@ -46,7 +46,12 @@ import {\n } from '../actions/blocks';\n import {\n   REBLOGS_FETCH_SUCCESS,\n+  FAVOURITES_FETCH_REQUEST,\n   FAVOURITES_FETCH_SUCCESS,\n+  FAVOURITES_FETCH_FAIL,\n+  FAVOURITES_EXPAND_REQUEST,\n+  FAVOURITES_EXPAND_SUCCESS,\n+  FAVOURITES_EXPAND_FAIL,\n } from '../actions/interactions';\n import {\n   MUTES_FETCH_REQUEST,\n@@ -136,7 +141,15 @@ export default function userLists(state = initialState, action) {\n   case REBLOGS_FETCH_SUCCESS:\n     return state.setIn(['reblogged_by', action.id], ImmutableList(action.accounts.map(item => item.id)));\n   case FAVOURITES_FETCH_SUCCESS:\n-    return state.setIn(['favourited_by', action.id], ImmutableList(action.accounts.map(item => item.id)));\n+    return normalizeList(state, ['favourited_by', action.id], action.accounts, action.next);\n+  case FAVOURITES_EXPAND_SUCCESS:\n+    return appendToList(state, ['favourited_by', action.id], action.accounts, action.next);\n+  case FAVOURITES_FETCH_REQUEST:\n+  case FAVOURITES_EXPAND_REQUEST:\n+    return state.setIn(['favourited_by', action.id, 'isLoading'], true);\n+  case FAVOURITES_FETCH_FAIL:\n+  case FAVOURITES_EXPAND_FAIL:\n+    return state.setIn(['favourited_by', action.id, 'isLoading'], false);\n   case NOTIFICATIONS_UPDATE:\n     return action.notification.type === 'follow_request' ? normalizeFollowRequest(state, action.notification) : state;\n   case FOLLOW_REQUESTS_FETCH_SUCCESS:\n---\n\n\n---\n\nChoice D:\nbabel.config.js\n@@ -52,6 +52,10 @@ module.exports = (api) => {\n   case 'development':\n     reactOptions.development = true;\n     envOptions.debug = true;\n+\n+    // We need Babel to not inject polyfills in dev, as this breaks `preval` files\n+    envOptions.useBuiltIns = false;\n+    envOptions.corejs = undefined;\n     break;\n   }\n \n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1.  [POST `/api/v1/push/subscription`](https://docs.joinmastodon.org/methods/push/#create) many times. (Not sure if many times in a short time matters though, just stating based on what I (accidentally) did)\r\n2. Send a post via another account, tagging the logged in user.\r\n3. Wait for notification to arrive\r\n4. Realised that tons of notifications came flooding in, only one decoded correctly (non unexpected, since my app only saved the latest keys)\n\n### Expected behaviour\n\n1 notification with correct contents.\n\n### Actual behaviour\n\nhundreds? of notifications.\n\n### Detailed description\n\nNow, I am not entirely sure if the fault is on my end, but I am somewhat confident that it is the API's fault. Please advise if I'm doing something terribly wrong without noticing \ud83d\ude05\r\n\r\nI am referring to the [POST `/api/v1/push/subscription`](https://docs.joinmastodon.org/methods/push/#create) endpoint.\r\nSo the story here is that, new (unreleased) app here, where a bug occurred, which resulted in an endless loop, causing the app to accidentally send out many requests.\r\n\r\nI realised this probably after like 2 seconds, shut the app down, fixed the issue, and relaunched the app.\r\n\r\nI sent a post out using another account, tagging my app's logged in account, the rest is explained in the steps to reproduce section.\r\n\r\nThe documentation for that, states: \r\n\r\n>  If you create a new subscription, the old subscription is deleted.\r\n\r\nIn this case, it didn't seem to be true? Eventually, I also tried calling [DELETE `/api/v1/push/subscription`](https://docs.joinmastodon.org/methods/push/#delete), but symptoms remains.\r\n\r\nMy setup is for a watchOS app. Notifications are relayed using [metatext-apns](https://github.com/metabolist/metatext-apns), which by the looks of it is just a simple relay so that shouldn't be the cause, right?\r\n\r\n I am very new to this Mastodon/Web Push notifications stuff, so please let me know if you believe it's an issue from my end. Thank you!\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.3.0-nightly.2024-04-18\n\n### Technical details\n\n- watchOS 10.2\r\n- Both accounts are on mastodon.social\r\n\n\n---\n\nChoice A:\napp/lib/activitypub/parser/status_parser.rb\n@@ -3,6 +3,8 @@\n class ActivityPub::Parser::StatusParser\n   include JsonLdHelper\n \n+  NORMALIZED_LOCALE_NAMES = LanguagesHelper::SUPPORTED_LOCALES.keys.index_by(&:downcase).freeze\n+\n   # @param [Hash] json\n   # @param [Hash] options\n   # @option options [String] :followers_collection\n@@ -87,6 +89,13 @@ def visibility\n   end\n \n   def language\n+    lang = raw_language_code\n+    lang.presence && NORMALIZED_LOCALE_NAMES.fetch(lang.downcase.to_sym, lang)\n+  end\n+\n+  private\n+\n+  def raw_language_code\n     if content_language_map?\n       @object['contentMap'].keys.first\n     elsif name_language_map?\n@@ -96,8 +105,6 @@ def language\n     end\n   end\n \n-  private\n-\n   def audience_to\n     as_array(@object['to'] || @json['to']).map { |x| value_or_id(x) }\n   end\n---\nspec/lib/activitypub/parser/status_parser_spec.rb\n@@ -0,0 +1,50 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+RSpec.describe ActivityPub::Parser::StatusParser do\n+  subject { described_class.new(json) }\n+\n+  let(:sender) { Fabricate(:account, followers_url: 'http://example.com/followers', domain: 'example.com', uri: 'https://example.com/actor') }\n+  let(:follower) { Fabricate(:account, username: 'bob') }\n+\n+  let(:json) do\n+    {\n+      '@context': 'https://www.w3.org/ns/activitystreams',\n+      id: [ActivityPub::TagManager.instance.uri_for(sender), '#foo'].join,\n+      type: 'Create',\n+      actor: ActivityPub::TagManager.instance.uri_for(sender),\n+      object: object_json,\n+    }.with_indifferent_access\n+  end\n+\n+  let(:object_json) do\n+    {\n+      id: [ActivityPub::TagManager.instance.uri_for(sender), 'post1'].join('/'),\n+      type: 'Note',\n+      to: [\n+        'https://www.w3.org/ns/activitystreams#Public',\n+        ActivityPub::TagManager.instance.uri_for(follower),\n+      ],\n+      content: '@bob lorem ipsum',\n+      contentMap: {\n+        EN: '@bob lorem ipsum',\n+      },\n+      published: 1.hour.ago.utc.iso8601,\n+      updated: 1.hour.ago.utc.iso8601,\n+      tag: {\n+        type: 'Mention',\n+        href: ActivityPub::TagManager.instance.uri_for(follower),\n+      },\n+    }\n+  end\n+\n+  it 'correctly parses status' do\n+    expect(subject).to have_attributes(\n+      text: '@bob lorem ipsum',\n+      uri: [ActivityPub::TagManager.instance.uri_for(sender), 'post1'].join('/'),\n+      reply: false,\n+      language: :en\n+    )\n+  end\n+end\n---\n\n\n---\n\nChoice B:\napp/controllers/api/v1/push/subscriptions_controller.rb\n@@ -1,26 +1,31 @@\n # frozen_string_literal: true\n \n class Api::V1::Push::SubscriptionsController < Api::BaseController\n+  include Redisable\n+  include Lockable\n+\n   before_action -> { doorkeeper_authorize! :push }\n   before_action :require_user!\n-  before_action :set_push_subscription\n+  before_action :set_push_subscription, only: [:show, :update]\n   before_action :check_push_subscription, only: [:show, :update]\n \n   def show\n     render json: @push_subscription, serializer: REST::WebPushSubscriptionSerializer\n   end\n \n   def create\n-    @push_subscription&.destroy!\n+    with_redis_lock(\"push_subscription:#{current_user.id}\") do\n+      destroy_web_push_subscriptions!\n \n-    @push_subscription = Web::PushSubscription.create!(\n-      endpoint: subscription_params[:endpoint],\n-      key_p256dh: subscription_params[:keys][:p256dh],\n-      key_auth: subscription_params[:keys][:auth],\n-      data: data_params,\n-      user_id: current_user.id,\n-      access_token_id: doorkeeper_token.id\n-    )\n+      @push_subscription = Web::PushSubscription.create!(\n+        endpoint: subscription_params[:endpoint],\n+        key_p256dh: subscription_params[:keys][:p256dh],\n+        key_auth: subscription_params[:keys][:auth],\n+        data: data_params,\n+        user_id: current_user.id,\n+        access_token_id: doorkeeper_token.id\n+      )\n+    end\n \n     render json: @push_subscription, serializer: REST::WebPushSubscriptionSerializer\n   end\n@@ -31,14 +36,18 @@ def update\n   end\n \n   def destroy\n-    @push_subscription&.destroy!\n+    destroy_web_push_subscriptions!\n     render_empty\n   end\n \n   private\n \n+  def destroy_web_push_subscriptions!\n+    doorkeeper_token.web_push_subscriptions.destroy_all\n+  end\n+\n   def set_push_subscription\n-    @push_subscription = Web::PushSubscription.find_by(access_token_id: doorkeeper_token.id)\n+    @push_subscription = doorkeeper_token.web_push_subscriptions.first\n   end\n \n   def check_push_subscription\n---\napp/lib/access_token_extension.rb\n@@ -6,6 +6,8 @@ module AccessTokenExtension\n   included do\n     include Redisable\n \n+    has_many :web_push_subscriptions, class_name: 'Web::PushSubscription', inverse_of: :access_token\n+\n     after_commit :push_to_streaming_api\n   end\n \n---\n\n\n---\n\nChoice C:\napp/models/account_pin.rb\n@@ -5,10 +5,10 @@\n # Table name: account_pins\n #\n #  id                :bigint(8)        not null, primary key\n-#  account_id        :bigint(8)\n-#  target_account_id :bigint(8)\n #  created_at        :datetime         not null\n #  updated_at        :datetime         not null\n+#  account_id        :bigint(8)        not null\n+#  target_account_id :bigint(8)        not null\n #\n \n class AccountPin < ApplicationRecord\n---\ndb/migrate/20241210140838_add_not_null_to_account_pin_account_columns.rb\n@@ -0,0 +1,23 @@\n+# frozen_string_literal: true\n+\n+class AddNotNullToAccountPinAccountColumns < ActiveRecord::Migration[7.2]\n+  def up\n+    connection.execute(<<~SQL.squish)\n+      DELETE FROM account_pins\n+      WHERE account_id IS NULL\n+      OR target_account_id IS NULL\n+    SQL\n+\n+    safety_assured do\n+      change_column_null :account_pins, :account_id, false\n+      change_column_null :account_pins, :target_account_id, false\n+    end\n+  end\n+\n+  def down\n+    safety_assured do\n+      change_column_null :account_pins, :account_id, true\n+      change_column_null :account_pins, :target_account_id, true\n+    end\n+  end\n+end\n---\ndb/schema.rb\n@@ -10,7 +10,7 @@\n #\n # It's strongly recommended that you check this file into your version control system.\n \n-ActiveRecord::Schema[7.2].define(version: 2024_12_05_163118) do\n+ActiveRecord::Schema[7.2].define(version: 2024_12_10_140838) do\n   # These are extensions that must be enabled in order to support this database\n   enable_extension \"plpgsql\"\n \n@@ -82,8 +82,8 @@\n   end\n \n   create_table \"account_pins\", force: :cascade do |t|\n-    t.bigint \"account_id\"\n-    t.bigint \"target_account_id\"\n+    t.bigint \"account_id\", null: false\n+    t.bigint \"target_account_id\", null: false\n     t.datetime \"created_at\", precision: nil, null: false\n     t.datetime \"updated_at\", precision: nil, null: false\n     t.index [\"account_id\", \"target_account_id\"], name: \"index_account_pins_on_account_id_and_target_account_id\", unique: true\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -6437,7 +6437,7 @@ a.status-card {\n   }\n \n   .dialog-option .poll__input {\n-    border-color: $inverted-text-color;\n+    border-color: $darker-text-color;\n     color: $ui-secondary-color;\n     display: inline-flex;\n     align-items: center;\n@@ -6451,13 +6451,13 @@ a.status-card {\n     &:active,\n     &:focus,\n     &:hover {\n-      border-color: lighten($inverted-text-color, 15%);\n+      border-color: $valid-value-color;\n       border-width: 4px;\n     }\n \n     &.active {\n-      border-color: $inverted-text-color;\n-      background: $inverted-text-color;\n+      border-color: $valid-value-color;\n+      background: $valid-value-color;\n     }\n   }\n \n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Visit typo.social/explore\r\n2. Scroll down\r\n3. See error:\r\n\r\n![Screenshot_20240425-110837](https://github.com/mastodon/mastodon/assets/3739866/282a3222-78ea-424b-af98-9fc3ec97bbe4)\r\n\r\nOn desktop (Windows, Firefox) no error is produced, but scrolling stops at the same point, suggesting to me that the error occurs but is not communicated.\n\n### Expected behaviour\n\nNo error\n\n### Actual behaviour\n\nError (and then no additional posts will load)\n\n### Detailed description\n\nAlso reported here:\r\n- https://www.reddit.com/r/Mastodon/comments/18fmda5/422_cant_verify_csrf_token_authenticity/?rdt=43597\r\n- https://mementomori.social/@rolle/110802929745486086\r\n- Possible duplicate of https://github.com/mastodon/mastodon/issues/1236 (I can't tell)\n\n### Mastodon instance\n\ntypo.social\n\n### Mastodon version\n\nv4.2.8\n\n### Browser name and version\n\nFirefox on Android, 124.2.0 (Build #2016012559), 7a0e399c7b+ GV: 124.0.2-20240401114208 AS: 124.0 2024-04-01T17:18:00.821594648\n\n### Operating system\n\nAndroid 13\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/controllers/auth/sessions_controller.rb\n@@ -187,4 +187,15 @@ def on_authentication_failure(user, security_measure, failure_reason)\n   def second_factor_attempts_key(user)\n     \"2fa_auth_attempts:#{user.id}:#{Time.now.utc.hour}\"\n   end\n+\n+  def respond_to_on_destroy\n+    respond_to do |format|\n+      format.json do\n+        render json: {\n+          redirect_to: after_sign_out_path_for(resource_name),\n+        }, status: 200\n+      end\n+      format.all { super }\n+    end\n+  end\n end\n---\napp/javascript/mastodon/features/ui/components/confirmation_modals/log_out.tsx\n@@ -25,7 +25,7 @@ export const ConfirmLogOutModal: React.FC<BaseConfirmationModalProps> = ({\n   const intl = useIntl();\n \n   const onConfirm = useCallback(() => {\n-    logOut();\n+    void logOut();\n   }, []);\n \n   return (\n---\napp/javascript/mastodon/utils/log_out.ts\n@@ -1,36 +1,20 @@\n-export const logOut = () => {\n-  const form = document.createElement('form');\n+import api from 'mastodon/api';\n \n-  const methodInput = document.createElement('input');\n-  methodInput.setAttribute('name', '_method');\n-  methodInput.setAttribute('value', 'delete');\n-  methodInput.setAttribute('type', 'hidden');\n-  form.appendChild(methodInput);\n+export async function logOut() {\n+  try {\n+    const response = await api(false).delete<{ redirect_to?: string }>(\n+      '/auth/sign_out',\n+      { headers: { Accept: 'application/json' }, withCredentials: true },\n+    );\n \n-  const csrfToken = document.querySelector<HTMLMetaElement>(\n-    'meta[name=csrf-token]',\n-  );\n-\n-  const csrfParam = document.querySelector<HTMLMetaElement>(\n-    'meta[name=csrf-param]',\n-  );\n-\n-  if (csrfParam && csrfToken) {\n-    const csrfInput = document.createElement('input');\n-    csrfInput.setAttribute('name', csrfParam.content);\n-    csrfInput.setAttribute('value', csrfToken.content);\n-    csrfInput.setAttribute('type', 'hidden');\n-    form.appendChild(csrfInput);\n+    if (response.status === 200 && response.data.redirect_to)\n+      window.location.href = response.data.redirect_to;\n+    else\n+      console.error(\n+        'Failed to log out, got an unexpected non-redirect response from the server',\n+        response,\n+      );\n+  } catch (error) {\n+    console.error('Failed to log out, response was an error', error);\n   }\n-\n-  const submitButton = document.createElement('input');\n-  submitButton.setAttribute('type', 'submit');\n-  form.appendChild(submitButton);\n-\n-  form.method = 'post';\n-  form.action = '/auth/sign_out';\n-  form.style.display = 'none';\n-\n-  document.body.appendChild(form);\n-  submitButton.click();\n-};\n+}\n---\nspec/requests/log_out_spec.rb\n@@ -0,0 +1,30 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+describe 'Log Out' do\n+  include RoutingHelper\n+\n+  describe 'DELETE /auth/sign_out' do\n+    let(:user) { Fabricate(:user) }\n+\n+    before do\n+      sign_in user\n+    end\n+\n+    it 'Logs out the user and redirect' do\n+      delete '/auth/sign_out'\n+\n+      expect(response).to redirect_to('/auth/sign_in')\n+    end\n+\n+    it 'Logs out the user and return a page to redirect to with a JSON request' do\n+      delete '/auth/sign_out', headers: { 'HTTP_ACCEPT' => 'application/json' }\n+\n+      expect(response).to have_http_status(200)\n+      expect(response.media_type).to eq 'application/json'\n+\n+      expect(body_as_json[:redirect_to]).to eq '/auth/sign_in'\n+    end\n+  end\n+end\n---\nspec/system/log_out_spec.rb\n@@ -0,0 +1,43 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+describe 'Log out' do\n+  include ProfileStories\n+\n+  before do\n+    as_a_logged_in_user\n+  end\n+\n+  describe 'Logging out from the preferences' do\n+    it 'logs the user out' do\n+      visit settings_path\n+\n+      within '.sidebar' do\n+        click_on 'Logout'\n+      end\n+\n+      expect(page).to have_title(I18n.t('auth.login'))\n+      expect(page).to have_current_path('/auth/sign_in')\n+    end\n+  end\n+\n+  describe 'Logging out from the JS app', :js, :streaming do\n+    it 'logs the user out' do\n+      visit root_path\n+\n+      within '.navigation-bar' do\n+        click_on 'Menu'\n+      end\n+\n+      within '.dropdown-menu' do\n+        click_on 'Logout'\n+      end\n+\n+      click_on 'Log out'\n+\n+      expect(page).to have_title(I18n.t('auth.login'))\n+      expect(page).to have_current_path('/auth/sign_in')\n+    end\n+  end\n+end\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/actions/settings.js\n@@ -20,7 +20,7 @@ export function changeSetting(path, value) {\n }\n \n const debouncedSave = debounce((dispatch, getState) => {\n-  if (getState().getIn(['settings', 'saved'])) {\n+  if (getState().getIn(['settings', 'saved']) || !getState().getIn(['meta', 'me'])) {\n     return;\n   }\n \n---\n\n\n---\n\nChoice C:\napp/views/application/mailer/_hashtag.html.haml\n@@ -17,4 +17,5 @@\n                           %span.email-mini-hashtag-img-span\n                             = image_tag full_asset_url(account.avatar.url), alt: '', width: 16, height: 16\n                       %td\n-                        %p= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(hashtag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts))\n+                        - people = hashtag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts\n+                        %p= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(people), count: people)\n---\n\n\n---\n\nChoice D:\napp/controllers/api/v1/notifications/requests_controller.rb\n@@ -52,7 +52,7 @@ def dismiss_bulk\n   private\n \n   def load_requests\n-    requests = NotificationRequest.where(account: current_account).includes(:last_status, from_account: [:account_stat, :user]).to_a_paginated_by_id(\n+    requests = NotificationRequest.where(account: current_account).without_suspended.includes(:last_status, from_account: [:account_stat, :user]).to_a_paginated_by_id(\n       limit_param(DEFAULT_ACCOUNTS_LIMIT),\n       params_slice(:max_id, :since_id, :min_id)\n     )\n---\napp/models/notification_policy.rb\n@@ -62,6 +62,6 @@ def filter_private_mentions=(value)\n   private\n \n   def pending_notification_requests\n-    @pending_notification_requests ||= notification_requests.limit(MAX_MEANINGFUL_COUNT).pick(Arel.sql('count(*), coalesce(sum(notifications_count), 0)::bigint'))\n+    @pending_notification_requests ||= notification_requests.without_suspended.limit(MAX_MEANINGFUL_COUNT).pick(Arel.sql('count(*), coalesce(sum(notifications_count), 0)::bigint'))\n   end\n end\n---\napp/models/notification_request.rb\n@@ -26,6 +26,8 @@ class NotificationRequest < ApplicationRecord\n \n   before_save :prepare_notifications_count\n \n+  scope :without_suspended, -> { joins(:from_account).merge(Account.without_suspended) }\n+\n   def self.preload_cache_collection(requests)\n     cached_statuses_by_id = yield(requests.filter_map(&:last_status)).index_by(&:id) # Call cache_collection in block\n \n---\nspec/models/notification_policy_spec.rb\n@@ -7,19 +7,25 @@\n     subject { Fabricate(:notification_policy) }\n \n     let(:sender) { Fabricate(:account) }\n+    let(:suspended_sender) { Fabricate(:account) }\n \n     before do\n       Fabricate.times(2, :notification, account: subject.account, activity: Fabricate(:status, account: sender), filtered: true, type: :mention)\n       Fabricate(:notification_request, account: subject.account, from_account: sender)\n-      subject.summarize!\n-    end\n \n-    it 'sets pending_requests_count' do\n-      expect(subject.pending_requests_count).to eq 1\n+      Fabricate(:notification, account: subject.account, activity: Fabricate(:status, account: suspended_sender), filtered: true, type: :mention)\n+      Fabricate(:notification_request, account: subject.account, from_account: suspended_sender)\n+\n+      suspended_sender.suspend!\n+\n+      subject.summarize!\n     end\n \n-    it 'sets pending_notifications_count' do\n-      expect(subject.pending_notifications_count).to eq 2\n+    it 'sets pending_requests_count and pending_notifications_count' do\n+      expect(subject).to have_attributes(\n+        pending_requests_count: 1,\n+        pending_notifications_count: 2\n+      )\n     end\n   end\n end\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nMake multiple requests to schedule a post to `POST /api/v1/statuses`, e.g. with this body\r\n\r\n`{\"status\":\"Test\",\"spoiler_text\":\"\",\"visibility\":\"private\",\"sensitive\":false,\"media_ids\":[],\"media_attributes\":[],\"scheduled_at\":\"2024-04-24T14:59:42.868Z\",\"language\":\"en\"}`\r\n\r\nand with the same `Idempotency-Key` header.\r\n\r\n\r\n\n\n### Expected behaviour\n\nThere is one scheduled status created because the Idempotency-Key was the same.\n\n### Actual behaviour\n\nMultiple scheduled statuses were created\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\n4.3.0-nightly.2024-04-18\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\nlib/mastodon/cli/feeds.rb\n@@ -5,6 +5,7 @@\n module Mastodon::CLI\n   class Feeds < Base\n     include Redisable\n+    include DatabaseHelper\n \n     option :all, type: :boolean, default: false\n     option :concurrency, type: :numeric, default: 5, aliases: [:c]\n@@ -44,6 +45,38 @@ def clear\n       say('OK', :green)\n     end\n \n+    desc 'vacuum', 'Remove home feeds of inactive users from Redis'\n+    long_desc <<-LONG_DESC\n+      Running this task should not be needed in most cases, as Mastodon will\n+      automatically clean up feeds from inactive accounts every day.\n+\n+      However, this task is more aggressive in order to clean up feeds that\n+      may have been missed because of bugs or database mishaps.\n+    LONG_DESC\n+    def vacuum\n+      with_read_replica do\n+        say('Deleting orphaned home feeds\u2026')\n+        redis.scan_each(match: 'feed:home:*').each_slice(1000) do |keys|\n+          ids = keys.map { |key| key.split(':')[2] }.compact_blank\n+\n+          known_ids = User.confirmed.signed_in_recently.where(account_id: ids).pluck(:account_id)\n+\n+          keys_to_delete = keys.filter { |key| known_ids.exclude?(key.split(':')[2]&.to_i) }\n+          redis.del(keys_to_delete)\n+        end\n+\n+        say('Deleting orphaned list feeds\u2026')\n+        redis.scan_each(match: 'feed:list:*').each_slice(1000) do |keys|\n+          ids = keys.map { |key| key.split(':')[2] }.compact_blank\n+\n+          known_ids = List.where(account_id: User.confirmed.signed_in_recently.select(:account_id)).where(id: ids).pluck(:id)\n+\n+          keys_to_delete = keys.filter { |key| known_ids.exclude?(key.split(':')[2]&.to_i) }\n+          redis.del(keys_to_delete)\n+        end\n+      end\n+    end\n+\n     private\n \n     def active_user_accounts\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/actions/notification_groups.ts\n@@ -47,7 +47,7 @@ function dispatchAssociatedRecords(\n       fetchedAccounts.push(notification.moderation_warning.target_account);\n     }\n \n-    if ('status' in notification) {\n+    if ('status' in notification && notification.status) {\n       fetchedStatuses.push(notification.status);\n     }\n   });\n@@ -119,7 +119,7 @@ export const processNewNotificationForGroups = createAppAsyncThunk(\n \n     if (\n       (notification.type === 'mention' || notification.type === 'update') &&\n-      notification.status.filtered\n+      notification.status?.filtered\n     ) {\n       const filters = notification.status.filtered.filter((result) =>\n         result.filter.context.includes('notifications'),\n---\napp/javascript/mastodon/api_types/notifications.ts\n@@ -60,12 +60,12 @@ export interface BaseNotificationGroupJSON {\n \n interface NotificationGroupWithStatusJSON extends BaseNotificationGroupJSON {\n   type: NotificationWithStatusType;\n-  status_id: string;\n+  status_id: string | null;\n }\n \n interface NotificationWithStatusJSON extends BaseNotificationJSON {\n   type: NotificationWithStatusType;\n-  status: ApiStatusJSON;\n+  status: ApiStatusJSON | null;\n }\n \n interface ReportNotificationGroupJSON extends BaseNotificationGroupJSON {\n---\napp/javascript/mastodon/features/notifications_v2/components/notification_mention.tsx\n@@ -37,7 +37,11 @@ export const NotificationMention: React.FC<{\n   unread: boolean;\n }> = ({ notification, unread }) => {\n   const [isDirect, isReply] = useAppSelector((state) => {\n-    const status = state.statuses.get(notification.statusId) as Status;\n+    const status = state.statuses.get(notification.statusId) as\n+      | Status\n+      | undefined;\n+\n+    if (!status) return [false, false] as const;\n \n     return [\n       status.get('visibility') === 'direct',\n---\napp/javascript/mastodon/features/notifications_v2/components/notification_with_status.tsx\n@@ -23,7 +23,7 @@ export const NotificationWithStatus: React.FC<{\n   icon: IconProp;\n   iconId: string;\n   accountIds: string[];\n-  statusId: string;\n+  statusId: string | undefined;\n   count: number;\n   labelRenderer: LabelRenderer;\n   unread: boolean;\n@@ -76,6 +76,8 @@ export const NotificationWithStatus: React.FC<{\n     [dispatch, statusId],\n   );\n \n+  if (!statusId) return null;\n+\n   return (\n     <HotKeys handlers={handlers}>\n       <div\n---\napp/javascript/mastodon/models/notification_group.ts\n@@ -21,7 +21,7 @@ interface BaseNotificationGroup\n interface BaseNotificationWithStatus<Type extends NotificationWithStatusType>\n   extends BaseNotificationGroup {\n   type: Type;\n-  statusId: string;\n+  statusId: string | undefined;\n }\n \n interface BaseNotification<Type extends NotificationType>\n@@ -126,7 +126,7 @@ export function createNotificationGroupFromJSON(\n     case 'update': {\n       const { status_id: statusId, ...groupWithoutStatus } = group;\n       return {\n-        statusId,\n+        statusId: statusId ?? undefined,\n         sampleAccountIds,\n         ...groupWithoutStatus,\n       };\n@@ -183,7 +183,7 @@ export function createNotificationGroupFromNotificationJSON(\n     case 'mention':\n     case 'poll':\n     case 'update':\n-      return { ...group, statusId: notification.status.id };\n+      return { ...group, statusId: notification.status?.id };\n     case 'admin.report':\n       return { ...group, report: createReportFromJSON(notification.report) };\n     case 'severed_relationships':\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/about.scss\n@@ -547,6 +547,7 @@\n   }\n \n   #mastodon-timeline {\n+    display: flex;\n     -webkit-overflow-scrolling: touch;\n     -ms-overflow-style: -ms-autohiding-scrollbar;\n     font-family: 'mastodon-font-sans-serif', sans-serif;\n@@ -565,7 +566,6 @@\n       padding: 0;\n       border-radius: 4px;\n       overflow: hidden;\n-      height: 100%;\n     }\n \n     .scrollable {\n---\napp/services/post_status_service.rb\n@@ -160,7 +160,7 @@ def idempotency_given?\n \n   def idempotency_duplicate\n     if scheduled?\n-      @account.schedule_statuses.find(@idempotency_duplicate)\n+      @account.scheduled_statuses.find(@idempotency_duplicate)\n     else\n       @account.statuses.find(@idempotency_duplicate)\n     end\n@@ -211,7 +211,7 @@ def poll_attributes\n   end\n \n   def scheduled_options\n-    @options.tap do |options_hash|\n+    @options.dup.tap do |options_hash|\n       options_hash[:in_reply_to_id]  = options_hash.delete(:thread)&.id\n       options_hash[:application_id]  = options_hash.delete(:application)&.id\n       options_hash[:scheduled_at]    = nil\n---\nspec/services/post_status_service_spec.rb\n@@ -54,6 +54,13 @@\n         .to not_change { account.statuses_count }\n         .and(not_change { previous_status.replies_count })\n     end\n+\n+    it 'returns existing status when used twice with idempotency key' do\n+      account = Fabricate(:account)\n+      status1 = subject.call(account, text: 'test', idempotency: 'meepmeep', scheduled_at: future)\n+      status2 = subject.call(account, text: 'test', idempotency: 'meepmeep', scheduled_at: future)\n+      expect(status2.id).to eq status1.id\n+    end\n   end\n \n   it 'creates response to the original status of boost' do\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -10453,7 +10453,7 @@ noscript {\n       gap: 4px;\n \n       dt {\n-        flex: 0 0 auto;\n+        flex: 0 1 auto;\n         color: $dark-text-color;\n         min-width: 0;\n         overflow: hidden;\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. View the post https://mastodon.social/@gvwilson/112294375846907813 and look at the title of the link preview card.\n\n### Expected behaviour\n\nTitle should begin with text, not excessive whitespace\n\n### Actual behaviour\n\nTitle contains excessive whitespace before the text\n\n### Detailed description\n\nThe site this post links to has an\u2026\u00a0interesting way of marking up their title tags:\r\n<img width=\"667\" alt=\"image\" src=\"https://github.com/mastodon/mastodon/assets/3615519/cb4e0848-523e-4d60-adaf-dff12d79fbfe\">\r\n\r\nWhile that is ultimately that site\u2019s fault, Mastodon should probably strip the whitespace when parsing it for link previews. It doesn\u2019t, so the result in the web UI is:\r\n<img width=\"315\" alt=\"image\" src=\"https://github.com/mastodon/mastodon/assets/3615519/0ac6b12b-2ea7-4449-811f-6b967d32a301\">\r\n\r\nThe string returned for the `card` by the Mastodon API (https://mastodon.social/api/v1/statuses/112294375846907813) is even worse:\r\n`\"title\": \"\\r\\n\\t\\t\\r\\n\\t\\t\\r\\n\\t\\t\\t\\r\\n\\t\\t\\t\\r\\n\\t\\t\\r\\n\\t\\tLab Dynamics: Management and Leadership Skills for Scientists, Third Edition\\r\\n\\t\"`\r\n\r\nFor comparison, it seems web browsers *do* strip the whitespace when displaying page titles.\r\n<img width=\"301\" alt=\"image\" src=\"https://github.com/mastodon/mastodon/assets/3615519/d7785977-a4d2-47e8-a626-6c25b11e533b\">\r\n\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.3.0-nightly.2024-04-18\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\nconfig/application.rb\n@@ -64,13 +64,6 @@ class Application < Rails::Application\n     # Initialize configuration defaults for originally generated Rails version.\n     config.load_defaults 7.0\n \n-    # TODO: Release a version which uses the 7.0 defaults as specified above,\n-    # but preserves the 6.1 cache format as set below. In a subsequent change,\n-    # remove this line setting to 6.1 cache format, and then release another version.\n-    # https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#new-activesupport-cache-serialization-format\n-    # https://github.com/mastodon/mastodon/pull/24241#discussion_r1162890242\n-    config.active_support.cache_format_version = 6.1\n-\n     # Please, add to the `ignore` list any other `lib` subdirectories that do\n     # not contain `.rb` files, or that should not be reloaded or eager loaded.\n     # Common ones are `templates`, `generators`, or `middleware`, for example.\n---\n\n\n---\n\nChoice B:\napp/controllers/well_known/host_meta_controller.rb\n@@ -7,7 +7,23 @@ class HostMetaController < ActionController::Base # rubocop:disable Rails/Applic\n     def show\n       @webfinger_template = \"#{webfinger_url}?resource={uri}\"\n       expires_in 3.days, public: true\n-      render content_type: 'application/xrd+xml', formats: [:xml]\n+\n+      respond_to do |format|\n+        format.any do\n+          render content_type: 'application/xrd+xml', formats: [:xml]\n+        end\n+\n+        format.json do\n+          render json: {\n+            links: [\n+              {\n+                rel: 'lrdd',\n+                template: @webfinger_template,\n+              },\n+            ],\n+          }\n+        end\n+      end\n     end\n   end\n end\n---\nconfig/routes.rb\n@@ -67,7 +67,7 @@ def redirect_with_vary(path)\n   scope path: '.well-known' do\n     scope module: :well_known do\n       get 'oauth-authorization-server', to: 'oauth_metadata#show', as: :oauth_metadata, defaults: { format: 'json' }\n-      get 'host-meta', to: 'host_meta#show', as: :host_meta, defaults: { format: 'xml' }\n+      get 'host-meta', to: 'host_meta#show', as: :host_meta\n       get 'nodeinfo', to: 'node_info#index', as: :nodeinfo, defaults: { format: 'json' }\n       get 'webfinger', to: 'webfinger#show', as: :webfinger\n     end\n---\nspec/requests/well_known/host_meta_spec.rb\n@@ -9,19 +9,39 @@\n     expect(response)\n       .to have_http_status(200)\n       .and have_attributes(\n-        media_type: 'application/xrd+xml',\n-        body: host_meta_xml_template\n+        media_type: 'application/xrd+xml'\n+      )\n+\n+    doc = Nokogiri::XML(response.parsed_body)\n+    expect(doc.at_xpath('/xrd:XRD/xrd:Link[@rel=\"lrdd\"]/@template', 'xrd' => 'http://docs.oasis-open.org/ns/xri/xrd-1.0').value)\n+      .to eq 'https://cb6e6126.ngrok.io/.well-known/webfinger?resource={uri}'\n+  end\n+\n+  it 'returns http success with valid JSON response with .json extension' do\n+    get '/.well-known/host-meta.json'\n+\n+    expect(response)\n+      .to have_http_status(200)\n+      .and have_attributes(\n+        media_type: 'application/json'\n+      )\n+\n+    expect(response.parsed_body)\n+      .to include(\n+        links: [\n+          'rel' => 'lrdd',\n+          'template' => 'https://cb6e6126.ngrok.io/.well-known/webfinger?resource={uri}',\n+        ]\n       )\n   end\n \n-  private\n+  it 'returns http success with valid JSON response with Accept header' do\n+    get '/.well-known/host-meta', headers: { 'Accept' => 'application/json' }\n \n-  def host_meta_xml_template\n-    <<~XML\n-      <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-      <XRD xmlns=\"http://docs.oasis-open.org/ns/xri/xrd-1.0\">\n-        <Link rel=\"lrdd\" template=\"https://cb6e6126.ngrok.io/.well-known/webfinger?resource={uri}\"/>\n-      </XRD>\n-    XML\n+    expect(response)\n+      .to have_http_status(200)\n+      .and have_attributes(\n+        media_type: 'application/json'\n+      )\n   end\n end\n---\nspec/routing/well_known_routes_spec.rb\n@@ -4,9 +4,14 @@\n \n RSpec.describe 'Well Known routes' do\n   describe 'the host-meta route' do\n-    it 'routes to correct place with xml format' do\n+    it 'routes to correct place' do\n       expect(get('/.well-known/host-meta'))\n-        .to route_to('well_known/host_meta#show', format: 'xml')\n+        .to route_to('well_known/host_meta#show')\n+    end\n+\n+    it 'routes to correct place with json format' do\n+      expect(get('/.well-known/host-meta.json'))\n+        .to route_to('well_known/host_meta#show', format: 'json')\n     end\n   end\n \n---\n\n\n---\n\nChoice C:\nspec/lib/search_query_transformer_spec.rb\n@@ -16,6 +16,7 @@\n       ['\"2022-01-01\"', '2022-01-01'],\n       ['12345678', '12345678'],\n       ['\"12345678\"', '12345678'],\n+      ['\"2024-10-31T23:47:20Z\"', '2024-10-31T23:47:20Z'],\n     ].each do |value, parsed|\n       context \"with #{operator}:#{value}\" do\n         let(:query) { \"#{operator}:#{value}\" }\n---\n\n\n---\n\nChoice D:\napp/lib/link_details_extractor.rb\n@@ -156,7 +156,7 @@ def height\n   end\n \n   def title\n-    html_entities.decode(structured_data&.headline || opengraph_tag('og:title') || document.xpath('//title').map(&:content).first)\n+    html_entities.decode(structured_data&.headline || opengraph_tag('og:title') || document.xpath('//title').map(&:content).first).strip\n   end\n \n   def description\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Repo fork\r\n2. Create Dev Containers\r\n3. Run `foreman start`\r\n4. Sign in as `admin@localhost`\r\n\n\n### Expected behaviour\n\nThe development web app works\n\n### Actual behaviour\n\nI can't navigate away from `http://localhost:3000/auth/edit` because `Your application is pending review by our staff. ~`\n\n### Detailed description\n\n<img width=\"2000\" alt=\"image\" src=\"https://github.com/mastodon/mastodon/assets/58300794/ed8e5aca-1cbd-46fb-8497-65875bc8f7c4\">\r\n\n\n### Mastodon instance\n\nI don't know. What is the instance of your development environment?\n\n### Mastodon version\n\nv4.3.0-alpha.3\n\n### Browser name and version\n\nGoogle Chrome 123.0.6312.107\n\n### Operating system\n\nmacOS Sonoma 14.4.1\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\ndb/seeds/04_admin.rb\n@@ -7,5 +7,7 @@\n   admin = Account.where(username: 'admin').first_or_initialize(username: 'admin')\n   admin.save(validate: false)\n \n-  User.where(email: \"admin@#{domain}\").first_or_initialize(email: \"admin@#{domain}\", password: 'mastodonadmin', password_confirmation: 'mastodonadmin', confirmed_at: Time.now.utc, role: UserRole.find_by(name: 'Owner'), account: admin, agreement: true, approved: true).save!\n+  user = User.where(email: \"admin@#{domain}\").first_or_initialize(email: \"admin@#{domain}\", password: 'mastodonadmin', password_confirmation: 'mastodonadmin', confirmed_at: Time.now.utc, role: UserRole.find_by(name: 'Owner'), account: admin, agreement: true, approved: true)\n+  user.save!\n+  user.approve!\n end\n---\n\n\n---\n\nChoice B:\napp/controllers/api/v1/push/subscriptions_controller.rb\n@@ -1,26 +1,31 @@\n # frozen_string_literal: true\n \n class Api::V1::Push::SubscriptionsController < Api::BaseController\n+  include Redisable\n+  include Lockable\n+\n   before_action -> { doorkeeper_authorize! :push }\n   before_action :require_user!\n-  before_action :set_push_subscription\n+  before_action :set_push_subscription, only: [:show, :update]\n   before_action :check_push_subscription, only: [:show, :update]\n \n   def show\n     render json: @push_subscription, serializer: REST::WebPushSubscriptionSerializer\n   end\n \n   def create\n-    @push_subscription&.destroy!\n+    with_redis_lock(\"push_subscription:#{current_user.id}\") do\n+      destroy_web_push_subscriptions!\n \n-    @push_subscription = Web::PushSubscription.create!(\n-      endpoint: subscription_params[:endpoint],\n-      key_p256dh: subscription_params[:keys][:p256dh],\n-      key_auth: subscription_params[:keys][:auth],\n-      data: data_params,\n-      user_id: current_user.id,\n-      access_token_id: doorkeeper_token.id\n-    )\n+      @push_subscription = Web::PushSubscription.create!(\n+        endpoint: subscription_params[:endpoint],\n+        key_p256dh: subscription_params[:keys][:p256dh],\n+        key_auth: subscription_params[:keys][:auth],\n+        data: data_params,\n+        user_id: current_user.id,\n+        access_token_id: doorkeeper_token.id\n+      )\n+    end\n \n     render json: @push_subscription, serializer: REST::WebPushSubscriptionSerializer\n   end\n@@ -31,14 +36,18 @@ def update\n   end\n \n   def destroy\n-    @push_subscription&.destroy!\n+    destroy_web_push_subscriptions!\n     render_empty\n   end\n \n   private\n \n+  def destroy_web_push_subscriptions!\n+    doorkeeper_token.web_push_subscriptions.destroy_all\n+  end\n+\n   def set_push_subscription\n-    @push_subscription = Web::PushSubscription.find_by(access_token_id: doorkeeper_token.id)\n+    @push_subscription = doorkeeper_token.web_push_subscriptions.first\n   end\n \n   def check_push_subscription\n---\napp/lib/access_token_extension.rb\n@@ -6,6 +6,8 @@ module AccessTokenExtension\n   included do\n     include Redisable\n \n+    has_many :web_push_subscriptions, class_name: 'Web::PushSubscription', inverse_of: :access_token\n+\n     after_commit :push_to_streaming_api\n   end\n \n---\n\n\n---\n\nChoice C:\nconfig/initializers/twitter_regex.rb\n@@ -9,7 +9,7 @@ def emoji_parsing_enabled\n \n   class Regex\n     REGEXEN[:valid_general_url_path_chars] = /[^\\p{White_Space}<>()?]/iou\n-    REGEXEN[:valid_url_path_ending_chars] = /[^\\p{White_Space}()?!*\"'\u300c\u300d<>;:=,.$%\\[\\]~&|@]|(?:#{REGEXEN[:valid_url_balanced_parens]})/iou\n+    REGEXEN[:valid_url_path_ending_chars] = /[^\\p{White_Space}()?!*\"'\u300c\u300d<>;:=,.$%\\[\\]~&|]|(?:#{REGEXEN[:valid_url_balanced_parens]})/iou\n     REGEXEN[:valid_url_balanced_parens] = /\n       \\(\n         (?:\n---\nspec/lib/text_formatter_spec.rb\n@@ -224,6 +224,14 @@\n       end\n     end\n \n+    context 'when given a URL with trailing @ symbol' do\n+      let(:text) { 'https://gta.fandom.com/wiki/TW@ Content' }\n+\n+      it 'matches the full URL' do\n+        expect(subject).to include 'href=\"https://gta.fandom.com/wiki/TW@\"'\n+      end\n+    end\n+\n     context 'when given a URL containing unsafe code (XSS attack, visible part)' do\n       let(:text) { 'http://example.com/b<del>b</del>' }\n \n---\n\n\n---\n\nChoice D:\napp/controllers/admin/domain_blocks_controller.rb\n@@ -37,7 +37,7 @@ def create\n         @domain_block.errors.delete(:domain)\n         render :new\n       else\n-        if existing_domain_block.present?\n+        if existing_domain_block.present? && existing_domain_block.domain == resource_params[:domain]\n           @domain_block = existing_domain_block\n           @domain_block.update(resource_params)\n         end\n---\nspec/controllers/admin/domain_blocks_controller_spec.rb\n@@ -68,6 +68,26 @@\n       expect(flash[:notice]).to eq I18n.t('admin.domain_blocks.created_msg')\n       expect(response).to redirect_to(admin_instances_path(limited: '1'))\n     end\n+\n+    context 'when a block for a parent domain already exists' do\n+      subject { post :create, params: { domain_block: { domain: 'subdomain.example.com', severity: child_severity } } }\n+\n+      let(:parent_severity) { 'silence' }\n+      let(:child_severity)  { 'suspend' }\n+\n+      before do\n+        Fabricate(:domain_block, domain: 'example.com', severity: parent_severity)\n+      end\n+\n+      it 'does not change the existing block' do\n+        expect { subject }.to_not change { DomainBlock.find_by(domain: 'example.com') }\n+      end\n+\n+      it 'creates a domain block with expected severity' do\n+        subject\n+        expect(DomainBlock.where(domain: 'subdomain.example.com', severity: child_severity)).to exist\n+      end\n+    end\n   end\n \n   describe 'PUT #update' do\n---\napp/controllers/admin/domain_blocks_controller.rb\n@@ -40,7 +40,7 @@ def create\n       end\n \n       # Allow transparently upgrading a domain block\n-      if existing_domain_block.present?\n+      if existing_domain_block.present? && existing_domain_block.domain == TagManager.instance.normalize_domain(@domain_block.domain.strip)\n         @domain_block = existing_domain_block\n         @domain_block.assign_attributes(resource_params)\n       end\n---\nspec/features/admin/domain_blocks_spec.rb\n@@ -57,6 +57,30 @@\n     end\n   end\n \n+  context 'when suspending a subdomain of an already-silenced domain' do\n+    it 'presents a confirmation screen before suspending the domain' do\n+      domain_block = Fabricate(:domain_block, domain: 'example.com', severity: 'silence')\n+\n+      visit new_admin_domain_block_path\n+\n+      fill_in 'domain_block_domain', with: 'subdomain.example.com'\n+      select I18n.t('admin.domain_blocks.new.severity.suspend'), from: 'domain_block_severity'\n+      click_on I18n.t('admin.domain_blocks.new.create')\n+\n+      # It presents a confirmation screen\n+      expect(page).to have_title(I18n.t('admin.domain_blocks.confirm_suspension.title', domain: 'subdomain.example.com'))\n+\n+      # Confirming creates the block\n+      click_on I18n.t('admin.domain_blocks.confirm_suspension.confirm')\n+\n+      expect(DomainBlock.where(domain: 'subdomain.example.com', severity: 'suspend')).to exist\n+\n+      # And leaves the previous block alone\n+      expect(domain_block.reload.severity).to eq 'silence'\n+      expect(domain_block.reload.domain).to eq 'example.com'\n+    end\n+  end\n+\n   context 'when editing a domain block' do\n     it 'presents a confirmation screen before suspending the domain' do\n       domain_block = Fabricate(:domain_block, domain: 'example.com', severity: 'silence')\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Receive a welcome email\r\n \r\n![IMG_5948](https://github.com/mastodon/mastodon/assets/42070/49ed7965-e751-4745-b2d2-5eaea1813244)\r\n\r\n\r\n### Expected behaviour\r\n\r\nEnglish text should be shown\r\n\r\n### Actual behaviour\r\n\r\nText in the trending hashtags is showing i18n syntax\r\n\r\n### Detailed description\r\n\r\n_No response_\r\n\r\n### Mastodon instance\r\n\r\nmastodon.online\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-nightly.2024-04-05\r\n\r\n### Browser name and version\r\n\r\n-\r\n\r\n### Operating system\r\n\r\n-\r\n\r\n### Technical details\r\n\r\nProbably related to the translators comments that were left on Crowdin\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -2612,6 +2612,7 @@ a.account__display-name {\n }\n \n $ui-header-height: 55px;\n+$ui-header-logo-wordmark-width: 99px;\n \n .ui__header {\n   display: none;\n@@ -2627,6 +2628,10 @@ $ui-header-height: 55px;\n   &__logo {\n     display: inline-flex;\n     padding: 15px;\n+    flex-grow: 1;\n+    flex-shrink: 1;\n+    overflow: hidden;\n+    container: header-logo / inline-size;\n \n     .logo {\n       height: $ui-header-height - 30px;\n@@ -2637,7 +2642,7 @@ $ui-header-height: 55px;\n       display: none;\n     }\n \n-    @media screen and (width >= 320px) {\n+    @container header-logo (min-width: #{$ui-header-logo-wordmark-width}) {\n       .logo--wordmark {\n         display: block;\n       }\n@@ -2654,6 +2659,7 @@ $ui-header-height: 55px;\n     gap: 10px;\n     padding: 0 10px;\n     overflow: hidden;\n+    flex-shrink: 0;\n \n     .button {\n       flex: 0 0 auto;\n---\n\n\n---\n\nChoice B:\ndocs/Using-Mastodon/List-of-Mastodon-instances.md\n@@ -65,7 +65,7 @@ There is also a list at [instances.mastodon.xyz](https://instances.mastodon.xyz)\n | [off-the-clock.us](https://off-the-clock.us/)|The work day is over.|Yes|No|\n | [infinimatix.net](https://infinimatix.net)|Informatics|Yes|Yes|\n | [social.0day.agency](https://social.0day.agency)|Infosec, Hacking, Fun (only protonmail)|Yes|Yes|\n-| [kagrumez.lerk.io](https://kagrumez.lerk.io)|Open registration. German end english.|Yes|No|\n+| [social.k40s.net](https://social.k40s.net)|Open registration. German end english.|Yes|No|\n | [meow.social](https://meow.social)|A furry fandom focused instance|Yes|No|\n | [neumastodon.com](https://neumastodon.com/)|Northeastern University Mastodon |Yes|No|\n | [dancingbanana.party](https://dancingbanana.party)|La banane qui danse.|Yes|No|\n---\napp/lib/status_finder.rb\n@@ -10,6 +10,8 @@ def initialize(url)\n   def status\n     verify_action!\n \n+    raise ActiveRecord::RecordNotFound unless TagManager.instance.local_url?(url)\n+\n     case recognized_params[:controller]\n     when 'stream_entries'\n       StreamEntry.find(recognized_params[:id]).status\n---\nspec/controllers/api/oembed_controller_spec.rb\n@@ -8,6 +8,7 @@\n \n   describe 'GET #show' do\n     before do\n+      request.host = Rails.configuration.x.local_domain\n       get :show, params: { url: account_stream_entry_url(alice, status.stream_entry) }, format: :json\n     end\n \n---\nspec/lib/status_finder_spec.rb\n@@ -34,6 +34,16 @@\n       end\n     end\n \n+    context 'with a remote url even if id exists on local' do\n+      let(:status) { Fabricate(:status) }\n+      let(:url) { \"https://example.com/users/test/statuses/#{status.id}\" }\n+      subject { described_class.new(url) }\n+\n+      it 'raises an error' do\n+        expect { subject.status }.to raise_error(ActiveRecord::RecordNotFound)\n+      end\n+    end\n+\n     context 'with a plausible url' do\n       let(:url) { 'https://example.com/users/test/updates/123/embed' }\n       subject { described_class.new(url) }\n---\n\n\n---\n\nChoice C:\napp/views/application/mailer/_hashtag.html.haml\n@@ -17,4 +17,5 @@\n                           %span.email-mini-hashtag-img-span\n                             = image_tag full_asset_url(account.avatar.url), alt: '', width: 16, height: 16\n                       %td\n-                        %p= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(hashtag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts))\n+                        - people = hashtag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts\n+                        %p= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(people), count: people)\n---\n\n\n---\n\nChoice D:\napp/services/fetch_link_card_service.rb\n@@ -29,7 +29,7 @@ def call(status)\n     end\n \n     attach_card if @card&.persisted?\n-  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError => e\n+  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError, Encoding::UndefinedConversionError => e\n     Rails.logger.debug { \"Error fetching link #{@original_url}: #{e}\" }\n     nil\n   end\n---\nspec/fixtures/requests/redirect_with_utf8_url.txt\n@@ -0,0 +1,5 @@\n+HTTP/1.1 301 Moved Permanently\n+server: nginx\n+date: Thu, 27 Jun 2024 11:04:53 GMT\n+content-type: text/html; charset=UTF-8\n+location: http://example.com/\u00e4rgerliche-umlaute.html\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -27,6 +27,7 @@\n     stub_request(:get, 'http://example.com/koi8-r').to_return(request_fixture('koi8-r.txt'))\n     stub_request(:get, 'http://example.com/windows-1251').to_return(request_fixture('windows-1251.txt'))\n     stub_request(:get, 'http://example.com/low_confidence_latin1').to_return(request_fixture('low_confidence_latin1.txt'))\n+    stub_request(:get, 'http://example.com/aergerliche-umlaute').to_return(request_fixture('redirect_with_utf8_url.txt'))\n \n     Rails.cache.write('oembed_endpoint:example.com', oembed_cache) if oembed_cache\n \n@@ -101,6 +102,14 @@\n       end\n     end\n \n+    context 'with a redirect URL with faulty encoding' do\n+      let(:status) { Fabricate(:status, text: 'http://example.com/aergerliche-umlaute') }\n+\n+      it 'does not create a preview card' do\n+        expect(status.preview_card).to be_nil\n+      end\n+    end\n+\n     context 'with a 404 URL' do\n       let(:status) { Fabricate(:status, text: 'http://example.com/not-found') }\n \n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\nI'm not sure if it can reproduced.\r\n\r\n### Expected behaviour\r\n\r\nThe user should work.\r\n\r\n### Actual behaviour\r\n\r\nSomething wrong with the user.\r\n\r\n### Detailed description\r\n\r\nAn user from my instance said she can't log in. When I look for her username in the admin it looks like this:\r\n\r\n![image](https://github.com/mastodon/mastodon/assets/1534150/eac3d75c-7f69-4aa6-adb6-cba10d9c0828)\r\n\r\nWhen I select it, I get the error page.\r\n\r\nThe actual error in mastodon-web.service:\r\n\r\n```\r\nMar 29 19:45:05 mementomori bundle[1461]: F, [2024-03-29T19:45:05.874603 #1461] FATAL -- : [e5621941-7639-4c15-901a-a8766cc3b7ec]\r\nMar 29 19:45:05 mementomori bundle[1461]: [e5621941-7639-4c15-901a-a8766cc3b7ec] ActionView::Template::Error (undefined method `downcase' for nil:NilClass):\r\nMar 29 19:45:05 mementomori bundle[1461]: [e5621941-7639-4c15-901a-a8766cc3b7ec]     30: = render 'admin/accounts/counters', account: @account\r\nMar 29 19:45:05 mementomori bundle[1461]: [e5621941-7639-4c15-901a-a8766cc3b7ec]     31:\r\nMar 29 19:45:05 mementomori bundle[1461]: [e5621941-7639-4c15-901a-a8766cc3b7ec]     32: - if @account.local? && @account.user.nil?\r\nMar 29 19:45:05 mementomori bundle[1461]: [e5621941-7639-4c15-901a-a8766cc3b7ec]     33:   = link_to t('admin.accounts.unblock_email'), unblock_email_admin_account_path(@account.id), method: :post, class: 'button' if can?(:unblock_email, @account) && CanonicalEmailBlock.matching_account(@account).exists?\r\nMar 29 19:45:05 mementomori bundle[1461]: [e5621941-7639-4c15-901a-a8766cc3b7ec]     34: - else\r\nMar 29 19:45:05 mementomori bundle[1461]: [e5621941-7639-4c15-901a-a8766cc3b7ec]     35:   .table-wrapper\r\nMar 29 19:45:05 mementomori bundle[1461]: [e5621941-7639-4c15-901a-a8766cc3b7ec]     36:     %table.table.inline-table\r\nMar 29 19:45:05 mementomori bundle[1461]: [e5621941-7639-4c15-901a-a8766cc3b7ec]\r\nMar 29 19:45:05 mementomori bundle[1461]: [e5621941-7639-4c15-901a-a8766cc3b7ec] app/helpers/email_helper.rb:9:in `email_to_canonical_email'\r\nMar 29 19:45:05 mementomori bundle[1461]: [e5621941-7639-4c15-901a-a8766cc3b7ec] app/helpers/email_helper.rb:16:in `email_to_canonical_email_hash'\r\nMar 29 19:45:05 mementomori bundle[1461]: [e5621941-7639-4c15-901a-a8766cc3b7ec] app/models/canonical_email_block.rb:22:in `block in <class:CanonicalEmailBlock>'\r\nMar 29 19:45:05 mementomori bundle[1461]: [e5621941-7639-4c15-901a-a8766cc3b7ec] app/models/canonical_email_block.rb:23:in `block in <class:CanonicalEmailBlock>'\r\nMar 29 19:45:05 mementomori bundle[1461]: [e5621941-7639-4c15-901a-a8766cc3b7ec] app/views/admin/accounts/show.html.haml:33\r\nMar 29 19:45:05 mementomori bundle[1461]: [e5621941-7639-4c15-901a-a8766cc3b7ec] app/controllers/concerns/localized.rb:11:in `set_locale'\r\nMar 29 19:45:05 mementomori bundle[1461]: [e5621941-7639-4c15-901a-a8766cc3b7ec] lib/mastodon/rack_middleware.rb:9:in `call'\r\n```\r\n\r\nAny idea what happened to this user and why this error occurs? The user is not disabled, suspended, etc. What's going on?\r\n\r\n### Mastodon instance\r\n\r\nmementomori.social\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-alpha.3+mementomods-2024-03-22\r\n\r\n### Browser name and version\r\n\r\nGoogle Chrome Version 123.0.6312.58 (Official Build) (64-bit)\r\n\r\n### Operating system\r\n\r\nPop!_OS by System76 (Ubuntu Jammy 22.04)\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/video/index.jsx\n@@ -469,6 +469,10 @@ class Video extends PureComponent {\n   };\n \n   _syncVideoToVolumeState = (volume = null, muted = null) => {\n+    if (!this.video) {\n+      return;\n+    }\n+\n     this.video.volume = volume ?? this.state.volume;\n     this.video.muted = muted ?? this.state.muted;\n   };\n---\n\n\n---\n\nChoice B:\napp/helpers/application_helper.rb\n@@ -240,11 +240,16 @@ def prerender_custom_emojis(html, custom_emojis, other_options = {})\n     EmojiFormatter.new(html, custom_emojis, other_options.merge(animate: prefers_autoplay?)).to_s\n   end\n \n-  def site_icon_path(type, size = '48')\n-    icon = SiteUpload.find_by(var: type)\n-    return nil unless icon\n+  def instance_presenter\n+    @instance_presenter ||= InstancePresenter.new\n+  end\n+\n+  def favicon_path(size = '48')\n+    instance_presenter.favicon&.file&.url(size)\n+  end\n \n-    icon.file.url(size)\n+  def app_icon_path(size = '48')\n+    instance_presenter.app_icon&.file&.url(size)\n   end\n \n   private\n---\napp/presenters/instance_presenter.rb\n@@ -81,4 +81,16 @@ def thumbnail\n   def mascot\n     @mascot ||= Rails.cache.fetch('site_uploads/mascot') { SiteUpload.find_by(var: 'mascot') }\n   end\n+\n+  def favicon\n+    return @favicon if defined?(@favicon)\n+\n+    @favicon ||= Rails.cache.fetch('site_uploads/favicon') { SiteUpload.find_by(var: 'favicon') }\n+  end\n+\n+  def app_icon\n+    return @app_icon if defined?(@app_icon)\n+\n+    @app_icon ||= Rails.cache.fetch('site_uploads/app_icon') { SiteUpload.find_by(var: 'app_icon') }\n+  end\n end\n---\napp/serializers/manifest_serializer.rb\n@@ -27,7 +27,7 @@ def short_name\n \n   def icons\n     SiteUpload::ANDROID_ICON_SIZES.map do |size|\n-      src = site_icon_path('app_icon', size.to_i)\n+      src = app_icon_path(size.to_i)\n       src = URI.join(root_url, src).to_s if src.present?\n \n       {\n---\napp/views/layouts/application.html.haml\n@@ -11,13 +11,13 @@\n     - if storage_host?\n       %link{ rel: 'dns-prefetch', href: storage_host }/\n \n-    %link{ rel: 'icon', href: site_icon_path('favicon', 'ico') || '/favicon.ico', type: 'image/x-icon' }/\n+    %link{ rel: 'icon', href: favicon_path('ico') || '/favicon.ico', type: 'image/x-icon' }/\n \n     - SiteUpload::FAVICON_SIZES.each do |size|\n-      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: site_icon_path('favicon', size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n+      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: favicon_path(size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n \n     - SiteUpload::APPLE_ICON_SIZES.each do |size|\n-      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: site_icon_path('app_icon', size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n+      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: app_icon_path(size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n \n     %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n     %link{ rel: 'manifest', href: manifest_path(format: :json) }/\n---\nspec/helpers/application_helper_spec.rb\n@@ -286,26 +286,31 @@ def current_theme = 'default'\n     end\n   end\n \n-  describe '#site_icon_path' do\n+  describe 'favicon' do\n     context 'when an icon exists' do\n       let!(:favicon) { Fabricate(:site_upload, var: 'favicon') }\n+      let!(:app_icon) { Fabricate(:site_upload, var: 'app_icon') }\n \n       it 'returns the URL of the icon' do\n-        expect(helper.site_icon_path('favicon')).to eq(favicon.file.url('48'))\n+        expect(helper.favicon_path).to eq(favicon.file.url('48'))\n+        expect(helper.app_icon_path).to eq(app_icon.file.url('48'))\n       end\n \n       it 'returns the URL of the icon with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to eq(favicon.file.url('16'))\n+        expect(helper.favicon_path(16)).to eq(favicon.file.url('16'))\n+        expect(helper.app_icon_path(16)).to eq(app_icon.file.url('16'))\n       end\n     end\n \n     context 'when an icon does not exist' do\n       it 'returns nil' do\n-        expect(helper.site_icon_path('favicon')).to be_nil\n+        expect(helper.favicon_path).to be_nil\n+        expect(helper.app_icon_path).to be_nil\n       end\n \n       it 'returns nil with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to be_nil\n+        expect(helper.favicon_path(16)).to be_nil\n+        expect(helper.app_icon_path(16)).to be_nil\n       end\n     end\n   end\n---\n\n\n---\n\nChoice C:\napp/controllers/admin/accounts_controller.rb\n@@ -128,7 +128,7 @@ def remove_header\n     def unblock_email\n       authorize @account, :unblock_email?\n \n-      CanonicalEmailBlock.matching_account(@account).delete_all\n+      CanonicalEmailBlock.where(reference_account: @account).delete_all\n \n       log_action :unblock_email, @account\n \n---\napp/models/canonical_email_block.rb\n@@ -20,7 +20,6 @@ class CanonicalEmailBlock < ApplicationRecord\n   validates :canonical_email_hash, presence: true, uniqueness: true\n \n   scope :matching_email, ->(email) { where(canonical_email_hash: email_to_canonical_email_hash(email)) }\n-  scope :matching_account, ->(account) { matching_email(account&.user_email).or(where(reference_account: account)) }\n \n   def to_log_human_identifier\n     canonical_email_hash\n---\napp/views/admin/accounts/show.html.haml\n@@ -30,7 +30,7 @@\n = render 'admin/accounts/counters', account: @account\n \n - if @account.local? && @account.user.nil?\n-  = link_to t('admin.accounts.unblock_email'), unblock_email_admin_account_path(@account.id), method: :post, class: 'button' if can?(:unblock_email, @account) && CanonicalEmailBlock.matching_account(@account).exists?\n+  = link_to t('admin.accounts.unblock_email'), unblock_email_admin_account_path(@account.id), method: :post, class: 'button' if can?(:unblock_email, @account) && CanonicalEmailBlock.exists?(reference_account_id: @account.id)\n - else\n   .table-wrapper\n     %table.table.inline-table\n---\nspec/fabricators/canonical_email_block_fabricator.rb\n@@ -1,6 +1,6 @@\n # frozen_string_literal: true\n \n Fabricator(:canonical_email_block) do\n-  email { |attrs| attrs[:reference_account] ? attrs[:reference_account].user_email : sequence(:email) { |i| \"#{i}#{Faker::Internet.email}\" } }\n+  email { sequence(:email) { |i| \"#{i}#{Faker::Internet.email}\" } }\n   reference_account { Fabricate.build(:account) }\n end\n---\nspec/controllers/admin/accounts_controller_spec.rb\n@@ -53,11 +53,32 @@\n \n   describe 'GET #show' do\n     let(:current_user) { Fabricate(:user, role: UserRole.find_by(name: 'Admin')) }\n-    let(:account) { Fabricate(:account) }\n \n-    it 'returns http success' do\n-      get :show, params: { id: account.id }\n-      expect(response).to have_http_status(200)\n+    context 'with a remote account' do\n+      let(:account) { Fabricate(:account, domain: 'example.com') }\n+\n+      it 'returns http success' do\n+        get :show, params: { id: account.id }\n+        expect(response).to have_http_status(200)\n+      end\n+    end\n+\n+    context 'with a local account' do\n+      let(:account) { Fabricate(:account, domain: nil) }\n+\n+      it 'returns http success' do\n+        get :show, params: { id: account.id }\n+        expect(response).to have_http_status(200)\n+      end\n+    end\n+\n+    context 'with a local deleted account' do\n+      let(:account) { Fabricate(:account, domain: nil, user: nil) }\n+\n+      it 'returns http success' do\n+        get :show, params: { id: account.id }\n+        expect(response).to have_http_status(200)\n+      end\n     end\n   end\n \n---\n\n\n---\n\nChoice D:\napp/helpers/languages_helper.rb\n@@ -194,7 +194,10 @@ module LanguagesHelper\n     jbo: ['Lojban', 'la .lojban.'].freeze,\n     kab: ['Kabyle', 'Taqbaylit'].freeze,\n     ldn: ['L\u00e1adan', 'L\u00e1adan'].freeze,\n+    ltg: ['Latgalian', 'latgal\u012b\u0161u'].freeze,\n     lfn: ['Lingua Franca Nova', 'lingua franca nova'].freeze,\n+    prg: ['Prussian', 'pr\u016bsiskai'].freeze,\n+    sgs: ['Samogitian', '\u017eemaitiu'].freeze,\n     sco: ['Scots', 'Scots'].freeze,\n     sma: ['Southern Sami', '\u00c5arjelsaemien G\u00efele'].freeze,\n     smj: ['Lule Sami', 'Julevs\u00e1megiella'].freeze,\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nSwitching between light and dark themes highlights difference between text input boxes for the search and post fields. It is consistent in the dark theme but different for light.\r\n\r\n![CleanShot 2024-03-29 at 12 00 16@2x](https://github.com/mastodon/mastodon/assets/3002053/051577d6-6b90-430c-8b7a-5c5657440f2c)\r\n![CleanShot 2024-03-29 at 12 00 32@2x](https://github.com/mastodon/mastodon/assets/3002053/c2acdace-b029-445b-9af2-37f473a339d4)\r\n\n\n### Expected behaviour\n\nConsistent text field background colors\n\n### Actual behaviour\n\nInconsistent background colors\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nvmst.io\n\n### Mastodon version\n\nv4.3.0-alpha.3\n\n### Browser name and version\n\nSafari\n\n### Operating system\n\nmacOS\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/controllers/api/v1/suggestions_controller.rb\n@@ -4,7 +4,7 @@ class Api::V1::SuggestionsController < Api::BaseController\n   include Authorization\n   include DeprecationConcern\n \n-  deprecate_api '2021-05-16'\n+  deprecate_api '2021-05-16', only: [:index]\n \n   before_action -> { doorkeeper_authorize! :read, :'read:accounts' }, only: :index\n   before_action -> { doorkeeper_authorize! :write, :'write:accounts' }, except: :index\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -80,6 +80,7 @@ html {\n }\n \n .search__input,\n+.search__popout,\n .setting-text,\n .report-dialog-modal__textarea,\n .audio-player {\n@@ -439,7 +440,8 @@ html {\n .directory__tag > div,\n .card > a,\n .page-header,\n-.compose-form .compose-form__warning {\n+.compose-form,\n+.compose-form__warning {\n   box-shadow: none;\n }\n \n@@ -475,12 +477,17 @@ html {\n   color: $white;\n }\n \n-.compose-form .spoiler-input__input {\n+.compose-form,\n+.spoiler-input__input,\n+.search__input,\n+.search__popout {\n   color: lighten($ui-highlight-color, 8%);\n }\n \n .compose-form .autosuggest-textarea__textarea,\n .compose-form__highlightable,\n+.search__input,\n+.search__popout,\n .poll__option input[type='text'] {\n   background: darken($ui-base-color, 10%);\n }\n---\n\n\n---\n\nChoice C:\napp/controllers/api/v1/timelines/tag_controller.rb\n@@ -1,6 +1,7 @@\n # frozen_string_literal: true\n \n class Api::V1::Timelines::TagController < Api::BaseController\n+  before_action -> { doorkeeper_authorize! :read, :'read:statuses' }, only: :show, if: :require_auth?\n   before_action :load_tag\n   after_action :insert_pagination_headers, unless: -> { @statuses.empty? }\n \n@@ -12,6 +13,10 @@ def show\n \n   private\n \n+  def require_auth?\n+    !Setting.timeline_preview\n+  end\n+\n   def load_tag\n     @tag = Tag.find_normalized(params[:id])\n   end\n---\nspec/controllers/api/v1/timelines/tag_controller_spec.rb\n@@ -5,36 +5,66 @@\n describe Api::V1::Timelines::TagController do\n   render_views\n \n-  let(:user) { Fabricate(:user) }\n+  let(:user)   { Fabricate(:user) }\n+  let(:token)  { Fabricate(:accessible_access_token, resource_owner_id: user.id, scopes: 'read:statuses') }\n \n   before do\n     allow(controller).to receive(:doorkeeper_token) { token }\n   end\n \n-  context 'with a user context' do\n-    let(:token) { Fabricate(:accessible_access_token, resource_owner_id: user.id) }\n+  describe 'GET #show' do\n+    subject do\n+      get :show, params: { id: 'test' }\n+    end\n \n-    describe 'GET #show' do\n-      before do\n-        PostStatusService.new.call(user.account, text: 'It is a #test')\n+    before do\n+      PostStatusService.new.call(user.account, text: 'It is a #test')\n+    end\n+\n+    context 'when the instance allows public preview' do\n+      context 'when the user is not authenticated' do\n+        let(:token) { nil }\n+\n+        it 'returns http success', :aggregate_failures do\n+          subject\n+\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n \n-      it 'returns http success' do\n-        get :show, params: { id: 'test' }\n-        expect(response).to have_http_status(200)\n-        expect(response.headers['Link'].links.size).to eq(2)\n+      context 'when the user is authenticated' do\n+        it 'returns http success', :aggregate_failures do\n+          subject\n+\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n     end\n-  end\n \n-  context 'without a user context' do\n-    let(:token) { Fabricate(:accessible_access_token, resource_owner_id: nil) }\n+    context 'when the instance does not allow public preview' do\n+      before do\n+        Form::AdminSettings.new(timeline_preview: false).save\n+      end\n+\n+      context 'when the user is not authenticated' do\n+        let(:token) { nil }\n+\n+        it 'returns http unauthorized' do\n+          subject\n+\n+          expect(response).to have_http_status(401)\n+        end\n+      end\n+\n+      context 'when the user is authenticated' do\n+        it 'returns http success', :aggregate_failures do\n+          subject\n \n-    describe 'GET #show' do\n-      it 'returns http success' do\n-        get :show, params: { id: 'test' }\n-        expect(response).to have_http_status(200)\n-        expect(response.headers['Link']).to be_nil\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n     end\n   end\n---\n\n\n---\n\nChoice D:\nlib/paperclip/response_with_limit_adapter.rb\n@@ -16,7 +16,7 @@ def initialize(target, options = {})\n     private\n \n     def cache_current_values\n-      @original_filename = filename_from_content_disposition.presence || filename_from_path.presence || 'data'\n+      @original_filename = truncated_filename\n       @tempfile = copy_to_tempfile(@target)\n       @content_type = ContentTypeDetector.new(@tempfile.path).detect\n       @size = File.size(@tempfile)\n@@ -43,6 +43,13 @@ def copy_to_tempfile(source)\n       source.response.connection.close\n     end\n \n+    def truncated_filename\n+      filename = filename_from_content_disposition.presence || filename_from_path.presence || 'data'\n+      extension = File.extname(filename)\n+      basename = File.basename(filename, extension)\n+      [basename[...20], extension[..4]].compact_blank.join\n+    end\n+\n     def filename_from_content_disposition\n       disposition = @target.response.headers['content-disposition']\n       disposition&.match(/filename=\"([^\"]*)\"/)&.captures&.first\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Use light theme\r\n\r\n![image](https://github.com/mastodon/mastodon/assets/3002053/cdb2518e-28d0-423c-875e-48f9516ade89)\r\n\n\n### Expected behaviour\n\nBackground color doesn't bleed outside header\n\n### Actual behaviour\n\nBackground color is outside header\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nvmst.io\n\n### Mastodon version\n\nv4.3.0-alpha.3\n\n### Browser name and version\n\nSafari\n\n### Operating system\n\nmacOS\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\ndb/migrate/20180812173710_copy_status_stats.rb\n@@ -45,7 +45,7 @@ def up_slow\n     # We cannot use bulk INSERT or overarching transactions here because of possible\n     # uniqueness violations that we need to skip over\n     Status.unscoped.select('id, reblogs_count, favourites_count, created_at, updated_at').find_each do |status|\n-      params = [[nil, status.id], [nil, status.reblogs_count], [nil, status.favourites_count], [nil, status.created_at], [nil, status.updated_at]]\n+      params = [status.id, status.reblogs_count, status.favourites_count, status.created_at, status.updated_at]\n       exec_insert('INSERT INTO status_stats (status_id, reblogs_count, favourites_count, created_at, updated_at) VALUES ($1, $2, $3, $4, $5)', nil, params)\n     rescue ActiveRecord::RecordNotUnique\n       next\n---\ndb/migrate/20181116173541_copy_account_stats.rb\n@@ -45,7 +45,7 @@ def up_slow\n     # We cannot use bulk INSERT or overarching transactions here because of possible\n     # uniqueness violations that we need to skip over\n     Account.unscoped.select('id, statuses_count, following_count, followers_count, created_at, updated_at').find_each do |account|\n-      params = [[nil, account.id], [nil, account[:statuses_count]], [nil, account[:following_count]], [nil, account[:followers_count]], [nil, account.created_at], [nil, account.updated_at]]\n+      params = [account.id, account[:statuses_count], account[:following_count], account[:followers_count], account.created_at, account.updated_at]\n       exec_insert('INSERT INTO account_stats (account_id, statuses_count, following_count, followers_count, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6)', nil, params)\n     rescue ActiveRecord::RecordNotUnique\n       next\n---\nlib/mastodon/cli/statuses.rb\n@@ -61,7 +61,7 @@ def remove_statuses\n         # Skip accounts followed by local accounts\n         clean_followed_sql = 'AND NOT EXISTS (SELECT 1 FROM follows WHERE statuses.account_id = follows.target_account_id)' unless options[:clean_followed]\n \n-        ActiveRecord::Base.connection.exec_insert(<<-SQL.squish, 'SQL', [[nil, max_id]])\n+        ActiveRecord::Base.connection.exec_insert(<<-SQL.squish, 'SQL', [max_id])\n           INSERT INTO statuses_to_be_deleted (id)\n           SELECT statuses.id FROM statuses WHERE deleted_at IS NULL AND NOT local AND uri IS NOT NULL AND (id < $1)\n           AND NOT EXISTS (SELECT 1 FROM statuses AS statuses1 WHERE statuses.id = statuses1.in_reply_to_id)\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -2677,7 +2677,7 @@ $ui-header-logo-wordmark-width: 99px;\n }\n \n .tabs-bar__wrapper {\n-  background: var(--background-color-tint);\n+  background: var(--background-color);\n   backdrop-filter: var(--background-filter);\n   position: sticky;\n   top: $ui-header-height;\n---\n\n\n---\n\nChoice C:\napp/lib/account_statuses_filter.rb\n@@ -60,8 +60,12 @@ def filtered_reblogs_scope\n       .where(reblog_of_id: nil)\n       .or(\n         scope\n+          # This is basically `Status.not_domain_blocked_by_account(current_account)`\n+          # and `Status.not_excluded_by_account(current_account)` but on the\n+          # `reblog` association. Unfortunately, there seem to be no clean way\n+          # to re-use those scopes in our case.\n+          .where(reblog: { accounts: { domain: nil } }).or(scope.where.not(reblog: { accounts: { domain: current_account.excluded_from_timeline_domains } }))\n           .where.not(reblog: { account_id: current_account.excluded_from_timeline_account_ids })\n-          .where.not(reblog: { accounts: { domain: current_account.excluded_from_timeline_domains } })\n       )\n   end\n \n---\nspec/lib/account_statuses_filter_spec.rb\n@@ -202,7 +202,7 @@ def status_with_media_attachment!(visibility)\n       context 'when blocking a reblogged domain' do\n         let(:other_account) { Fabricate(:account, domain: 'example.com') }\n         let(:reblogging_status) { Fabricate(:status, account: other_account) }\n-        let(:reblog) { Fabricate(:status, account: account, visibility: 'public', reblog: reblogging_status) }\n+        let!(:reblog) { Fabricate(:status, account: account, visibility: 'public', reblog: reblogging_status) }\n \n         before do\n           current_account.block_domain!(other_account.domain)\n@@ -213,6 +213,20 @@ def status_with_media_attachment!(visibility)\n         end\n       end\n \n+      context 'when blocking an unrelated domain' do\n+        let(:other_account) { Fabricate(:account, domain: nil) }\n+        let(:reblogging_status) { Fabricate(:status, account: other_account, visibility: 'public') }\n+        let!(:reblog) { Fabricate(:status, account: account, visibility: 'public', reblog: reblogging_status) }\n+\n+        before do\n+          current_account.block_domain!('example.com')\n+        end\n+\n+        it 'returns the reblog from the non-blocked domain' do\n+          expect(subject.results.pluck(:id)).to include(reblog.id)\n+        end\n+      end\n+\n       context 'when muting a reblogged account' do\n         let(:reblog) { status_with_reblog!('public') }\n \n---\n\n\n---\n\nChoice D:\napp/controllers/api/v1/suggestions_controller.rb\n@@ -4,7 +4,7 @@ class Api::V1::SuggestionsController < Api::BaseController\n   include Authorization\n   include DeprecationConcern\n \n-  deprecate_api '2021-05-16'\n+  deprecate_api '2021-05-16', only: [:index]\n \n   before_action -> { doorkeeper_authorize! :read, :'read:accounts' }, only: :index\n   before_action -> { doorkeeper_authorize! :write, :'write:accounts' }, except: :index\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. In Settings, choose \u201cAutomatic (use system theme)\u201d as the UI theme\r\n2. Set system to light mode\r\n\n\n### Expected behaviour\n\nThe `theme-color` meta tag (and thus the browser chrome) should match the light/dark mode\n\n### Actual behaviour\n\nThe `theme-color` meta tag stays set to a dark color when the system and site are in light mode\n\n### Detailed description\n\nHow it appears on macOS with Safari\u2019s compact UI:\r\n<img width=\"1117\" alt=\"Screenshot 2024-03-28 at 4 30 17\u202fPM\" src=\"https://github.com/mastodon/mastodon/assets/3615519/24fa9faa-9d8a-4bf5-b278-5e9ba099b86d\">\r\n\r\nAnd iOS:\r\n![Simulator Screenshot - iPhone 15 - 2024-03-28 at 16 37 02](https://github.com/mastodon/mastodon/assets/3615519/01427304-1b48-43a1-8707-aaee414b8ba3)\r\n\n\n### Mastodon instance\n\nmastodon.online\n\n### Mastodon version\n\nv4.3.0-nightly.2024-03-27\n\n### Browser name and version\n\nSafari 17.4.1\n\n### Operating system\n\nmacOS 14.4.1\n\n### Technical details\n\nThe problem tag: `<meta content=\"#191b22\" name=\"theme-color\u201d>`\r\n\r\nPer https://webkit.org/blog/11989/new-webkit-features-in-safari-15/, that tag supports media queries for light and dark mode.\n\n---\n\nChoice A:\ndb/post_migrate/20230811103651_remove_index_preview_cards_statuses_on_status_id_and_preview_card_id.rb\n@@ -0,0 +1,9 @@\n+# frozen_string_literal: true\n+\n+class RemoveIndexPreviewCardsStatusesOnStatusIdAndPreviewCardId < ActiveRecord::Migration[7.0]\n+  disable_ddl_transaction!\n+\n+  def change\n+    remove_index :preview_cards_statuses, column: [:status_id, :preview_card_id], name: :index_preview_cards_statuses_on_status_id_and_preview_card_id\n+  end\n+end\n---\ndb/schema.rb\n@@ -10,7 +10,7 @@\n #\n # It's strongly recommended that you check this file into your version control system.\n \n-ActiveRecord::Schema[7.0].define(version: 2023_08_03_112520) do\n+ActiveRecord::Schema[7.0].define(version: 2023_08_11_103651) do\n   # These are extensions that must be enabled in order to support this database\n   enable_extension \"plpgsql\"\n \n@@ -809,7 +809,6 @@\n   create_table \"preview_cards_statuses\", primary_key: [\"status_id\", \"preview_card_id\"], force: :cascade do |t|\n     t.bigint \"preview_card_id\", null: false\n     t.bigint \"status_id\", null: false\n-    t.index [\"status_id\", \"preview_card_id\"], name: \"index_preview_cards_statuses_on_status_id_and_preview_card_id\"\n   end\n \n   create_table \"relays\", force: :cascade do |t|\n---\n\n\n---\n\nChoice B:\napp/helpers/application_helper.rb\n@@ -164,8 +164,11 @@ def theme_style_tags(theme)\n     if theme == 'system'\n       concat stylesheet_pack_tag('mastodon-light', media: 'not all and (prefers-color-scheme: dark)', crossorigin: 'anonymous')\n       concat stylesheet_pack_tag('default', media: '(prefers-color-scheme: dark)', crossorigin: 'anonymous')\n+      concat tag.meta name: 'theme-color', content: Themes::MASTODON_DARK_THEME_COLOR, media: '(prefers-color-scheme: dark)'\n+      concat tag.meta name: 'theme-color', content: Themes::MASTODON_LIGHT_THEME_COLOR, media: '(prefers-color-scheme: light)'\n     else\n-      stylesheet_pack_tag theme, media: 'all', crossorigin: 'anonymous'\n+      concat stylesheet_pack_tag theme, media: 'all', crossorigin: 'anonymous'\n+      concat tag.meta name: 'theme-color', content: theme == 'mastodon-light' ? Themes::MASTODON_LIGHT_THEME_COLOR : Themes::MASTODON_DARK_THEME_COLOR\n     end\n   end\n \n---\napp/lib/themes.rb\n@@ -6,6 +6,9 @@\n class Themes\n   include Singleton\n \n+  MASTODON_DARK_THEME_COLOR = '#191b22'\n+  MASTODON_LIGHT_THEME_COLOR = '#f3f5f7'\n+\n   def initialize\n     @conf = YAML.load_file(Rails.root.join('config', 'themes.yml'))\n   end\n---\napp/views/layouts/application.html.haml\n@@ -21,7 +21,6 @@\n \n     %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n     %link{ rel: 'manifest', href: manifest_path(format: :json) }/\n-    %meta{ name: 'theme-color', content: '#191b22' }/\n     %meta{ name: 'apple-mobile-web-app-capable', content: 'yes' }/\n \n     %title= html_title\n---\n\n\n---\n\nChoice C:\nconfig/routes.rb\n@@ -142,7 +142,11 @@ def redirect_with_vary(path)\n \n   resource :inbox, only: [:create], module: :activitypub\n \n-  get '/:encoded_at(*path)', to: redirect('/@%{path}'), constraints: { encoded_at: /%40/ }\n+  constraints(encoded_path: /%40.*/) do\n+    get '/:encoded_path', to: redirect { |params|\n+      \"/#{params[:encoded_path].gsub('%40', '@')}\"\n+    }\n+  end\n \n   constraints(username: %r{[^@/.]+}) do\n     with_options to: 'accounts#show' do\n---\nspec/routing/accounts_routing_spec.rb\n@@ -47,6 +47,61 @@\n     end\n   end\n \n+  context 'with local username encoded at' do\n+    include RSpec::Rails::RequestExampleGroup\n+    let(:username) { 'alice' }\n+\n+    it 'routes /%40:username' do\n+      get \"/%40#{username}\"\n+      expect(response).to redirect_to(\"/@#{username}\")\n+    end\n+\n+    it 'routes /%40:username.json' do\n+      get(\"/%40#{username}.json\")\n+      expect(response).to redirect_to(\"/@#{username}.json\")\n+    end\n+\n+    it 'routes /%40:username.rss' do\n+      get(\"/%40#{username}.rss\")\n+      expect(response).to redirect_to(\"/@#{username}.rss\")\n+    end\n+\n+    it 'routes /%40:username/:id' do\n+      get(\"/%40#{username}/123\")\n+      expect(response).to redirect_to(\"/@#{username}/123\")\n+    end\n+\n+    it 'routes /%40:username/:id/embed' do\n+      get(\"/%40#{username}/123/embed\")\n+      expect(response).to redirect_to(\"/@#{username}/123/embed\")\n+    end\n+\n+    it 'routes /%40:username/following' do\n+      get(\"/%40#{username}/following\")\n+      expect(response).to redirect_to(\"/@#{username}/following\")\n+    end\n+\n+    it 'routes /%40:username/followers' do\n+      get(\"/%40#{username}/followers\")\n+      expect(response).to redirect_to(\"/@#{username}/followers\")\n+    end\n+\n+    it 'routes /%40:username/with_replies' do\n+      get(\"/%40#{username}/with_replies\")\n+      expect(response).to redirect_to(\"/@#{username}/with_replies\")\n+    end\n+\n+    it 'routes /%40:username/media' do\n+      get(\"/%40#{username}/media\")\n+      expect(response).to redirect_to(\"/@#{username}/media\")\n+    end\n+\n+    it 'routes /%40:username/tagged/:tag' do\n+      get(\"/%40#{username}/tagged/foo\")\n+      expect(response).to redirect_to(\"/@#{username}/tagged/foo\")\n+    end\n+  end\n+\n   context 'with remote username' do\n     let(:username) { 'alice@example.com' }\n \n@@ -82,4 +137,50 @@\n       expect(get(\"/@#{username}/tagged/foo\")).to route_to('home#index', username_with_domain: username, any: 'tagged/foo')\n     end\n   end\n+\n+  context 'with remote username encoded at' do\n+    include RSpec::Rails::RequestExampleGroup\n+    let(:username) { 'alice%40example.com' }\n+    let(:username_decoded) { 'alice@example.com' }\n+\n+    it 'routes /%40:username' do\n+      get(\"/%40#{username}\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}\")\n+    end\n+\n+    it 'routes /%40:username/:id' do\n+      get(\"/%40#{username}/123\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/123\")\n+    end\n+\n+    it 'routes /%40:username/:id/embed' do\n+      get(\"/%40#{username}/123/embed\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/123/embed\")\n+    end\n+\n+    it 'routes /%40:username/following' do\n+      get(\"/%40#{username}/following\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/following\")\n+    end\n+\n+    it 'routes /%40:username/followers' do\n+      get(\"/%40#{username}/followers\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/followers\")\n+    end\n+\n+    it 'routes /%40:username/with_replies' do\n+      get(\"/%40#{username}/with_replies\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/with_replies\")\n+    end\n+\n+    it 'routes /%40:username/media' do\n+      get(\"/%40#{username}/media\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/media\")\n+    end\n+\n+    it 'routes /%40:username/tagged/:tag' do\n+      get(\"/%40#{username}/tagged/foo\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/tagged/foo\")\n+    end\n+  end\n end\n---\n\n\n---\n\nChoice D:\napp/views/user_mailer/confirmation_instructions.html.haml\n@@ -8,9 +8,7 @@\n           %td.email-inner-card-td.email-prose\n             %p= t @resource.approved? ? 'devise.mailer.confirmation_instructions.explanation' : 'devise.mailer.confirmation_instructions.explanation_when_pending', host: site_hostname\n             - if @resource.created_by_application\n-              = render 'application/mailer/button', text: t('settings.account_settings'), url: edit_user_registration_url\n-              = link_to confirmation_url(@resource, confirmation_token: @token, redirect_to_app: 'true') do\n-                %span= t 'devise.mailer.confirmation_instructions.action_with_app', app: @resource.created_by_application.name\n+              = render 'application/mailer/button', text: t('devise.mailer.confirmation_instructions.action_with_app', app: @resource.created_by_application.name), url: confirmation_url(@resource, confirmation_token: @token, redirect_to_app: 'true')\n             - else\n               = render 'application/mailer/button', text: t('devise.mailer.confirmation_instructions.action'), url: confirmation_url(@resource, confirmation_token: @token)\n             %p= t 'devise.mailer.confirmation_instructions.extra_html', terms_path: about_more_url, policy_path: privacy_policy_url\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Visit `/admin/rules`\n\n### Expected behaviour\n\nThe addtional information should be shown, just as in the user facing UI\n\n### Actual behaviour\n\nThe server rule is shown twice\n\n### Detailed description\n\nAdmin-facing server rule looks like this:\r\n\r\n![server_rules_admin](https://github.com/mastodon/mastodon/assets/4095570/33060017-841f-4119-b26f-69f3340d954f)\r\n\r\nThe user-facing server rule looks like this:\r\n\r\n![server_rules_public](https://github.com/mastodon/mastodon/assets/4095570/41075199-a9d7-4295-8f80-0ed8954724ba)\r\n\n\n### Mastodon instance\n\nhttps://ailbhean.co-shaoghal.net/\n\n### Mastodon version\n\nv4.3.0-alpha.3+git-77897cd24cbf9802bd000c88ab3c7bfb6714f968\n\n### Browser name and version\n\nFirefox 123.0.1\n\n### Operating system\n\nLinux Mint 21.3 Mate\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/views/admin/rules/_rule.html.haml\n@@ -5,7 +5,7 @@\n \n   .announcements-list__item__action-bar\n     .announcements-list__item__meta\n-      = rule.text\n+      = rule.hint\n \n     %div\n       = table_link_to 'trash', t('admin.rules.delete'), admin_rule_path(rule), method: :delete, data: { confirm: t('admin.accounts.are_you_sure') } if can?(:destroy, rule)\n---\n\n\n---\n\nChoice B:\ndocker-compose.yml\n@@ -2,7 +2,7 @@ version: '3'\n services:\n   db:\n     restart: always\n-    image: postgres:14-alpine\n+    image: postgres:15-alpine\n     shm_size: 256mb\n     networks:\n       - internal_network\n@@ -25,7 +25,7 @@ services:\n \n   # es:\n   #   restart: always\n-  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.4\n+  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9\n   #   environment:\n   #     - \"ES_JAVA_OPTS=-Xms512m -Xmx512m -Des.enforce.bootstrap.checks=true\"\n   #     - \"xpack.license.self_generated.type=basic\"\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\n\n\n---\n\nChoice C:\nlib/paperclip/transcoder.rb\n@@ -43,7 +43,8 @@ def make\n         unless eligible_to_passthrough?(metadata)\n           size_limit_in_bits = MediaAttachment::VIDEO_LIMIT * 8\n           desired_bitrate = (metadata.width * metadata.height * 30 * BITS_PER_PIXEL).floor\n-          maximum_bitrate = (size_limit_in_bits / metadata.duration).floor - 192_000 # Leave some space for the audio stream\n+          duration = [metadata.duration, 1].max\n+          maximum_bitrate = (size_limit_in_bits / duration).floor - 192_000 # Leave some space for the audio stream\n           bitrate = [desired_bitrate, maximum_bitrate].min\n \n           @output_options['b:v']     = bitrate\n---\n\n\n---\n\nChoice D:\napp/lib/permalink_redirector.rb\n@@ -14,6 +14,8 @@ def redirect_path\n       find_account_url_by_name(first_segment)\n     elsif accounts_request? && record_integer_id_request?\n       find_account_url_by_id(second_segment)\n+    elsif @path.start_with?('/deck')\n+      @path.delete_prefix('/deck')\n     end\n   end\n \n@@ -52,7 +54,7 @@ def second_segment\n   end\n \n   def path_segments\n-    @path_segments ||= @path.delete_prefix('/').split('/')\n+    @path_segments ||= @path.delete_prefix('/deck').delete_prefix('/').split('/')\n   end\n \n   def find_status_url_by_id(id)\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Deny notifications \r\n2. Open the notification menu\r\n3. Look at the message \u201cDesktop notifications are unavailable due to previously denied browser permissions request\u201d\n\n### Expected behaviour\n\nThe message should look well integrated in the menu\n\n### Actual behaviour\n\nThe message looks non-integrated in the menu, at least because of missing padding\n\n### Detailed description\n\n<img width=\"623\" alt=\"Screenshot 2024-03-21 at 16 10 10\" src=\"https://github.com/mastodon/mastodon/assets/923008/f6ae3b2e-1134-486d-934a-929a6bdd9e59\">\r\n\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.3.0-nightly.2024-03-19\n\n### Browser name and version\n\nn/a\n\n### Operating system\n\nn/a\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/notifications/components/column_settings.jsx\n@@ -45,14 +45,18 @@ class ColumnSettings extends PureComponent {\n \n     return (\n       <div className='column-settings'>\n-        {alertsEnabled && browserSupport && browserPermission === 'denied' && (\n-          <span className='warning-hint'><FormattedMessage id='notifications.permission_denied' defaultMessage='Desktop notifications are unavailable due to previously denied browser permissions request' /></span>\n-        )}\n-\n         <section>\n           <ClearColumnButton onClick={onClear} />\n         </section>\n \n+        {alertsEnabled && browserSupport && browserPermission === 'denied' && (\n+          <section>\n+            <span className='warning-hint'>\n+              <FormattedMessage id='notifications.permission_denied' defaultMessage='Desktop notifications are unavailable due to previously denied browser permissions request' />\n+            </span>\n+          </section>\n+        )}\n+\n         {alertsEnabled && browserSupport && browserPermission === 'default' && (\n           <section>\n             <span className='warning-hint'>\n---\n\n\n---\n\nChoice B:\napp/controllers/concerns/web_app_controller_concern.rb\n@@ -11,7 +11,7 @@ module WebAppControllerConcern\n   end\n \n   def skip_csrf_meta_tags?\n-    !(ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1) && current_user.nil?\n+    !(ENV['ONE_CLICK_SSO_LOGIN'] == 'true' && ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1) && current_user.nil?\n   end\n \n   def set_app_body_class\n---\napp/serializers/initial_state_serializer.rb\n@@ -113,6 +113,6 @@ def instance_presenter\n   end\n \n   def sso_redirect\n-    \"/auth/auth/#{Devise.omniauth_providers[0]}\" if ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1\n+    \"/auth/auth/#{Devise.omniauth_providers[0]}\" if ENV['ONE_CLICK_SSO_LOGIN'] == 'true' && ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1\n   end\n end\n---\nconfig/initializers/content_security_policy.rb\n@@ -19,6 +19,22 @@ def host_to_url(str)\n media_host ||= host_to_url(ENV['S3_HOSTNAME']) if ENV['S3_ENABLED'] == 'true'\n media_host ||= assets_host\n \n+def sso_host\n+  return unless ENV['ONE_CLICK_SSO_LOGIN'] == 'true'\n+  return unless ENV['OMNIAUTH_ONLY'] == 'true'\n+  return unless Devise.omniauth_providers.length == 1\n+\n+  provider = Devise.omniauth_configs[Devise.omniauth_providers[0]]\n+  @sso_host ||= begin\n+    # using CAS\n+    provider.cas_url if ENV['CAS_ENABLED'] == 'true'\n+    # using SAML\n+    provider.options[:idp_sso_target_url] if ENV['SAML_ENABLED'] == 'true'\n+    # or using OIDC\n+    ENV['OIDC_AUTH_ENDPOINT'] || (OpenIDConnect::Discovery::Provider::Config.discover!(ENV['OIDC_ISSUER']).authorization_endpoint if ENV['OIDC_ENABLED'] == 'true')\n+  end\n+end\n+\n Rails.application.config.content_security_policy do |p|\n   p.base_uri        :none\n   p.default_src     :none\n@@ -29,7 +45,13 @@ def host_to_url(str)\n   p.media_src       :self, :https, :data, assets_host\n   p.frame_src       :self, :https\n   p.manifest_src    :self, assets_host\n-  p.form_action     :self\n+\n+  if sso_host.present?\n+    p.form_action     :self, sso_host\n+  else\n+    p.form_action     :self\n+  end\n+\n   p.child_src       :self, :blob, assets_host\n   p.worker_src      :self, :blob, assets_host\n \n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -4,8 +4,6 @@ import { Children, cloneElement, useCallback } from 'react';\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import ImmutablePureComponent from 'react-immutable-pure-component';\n \n-import { supportsPassiveEvents } from 'detect-passive-events';\n-\n import { scrollRight } from '../../../scroll';\n import BundleContainer from '../containers/bundle_container';\n import {\n@@ -71,10 +69,6 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   };\n \n   componentDidMount() {\n-    if (!this.props.singleColumn) {\n-      this.node.addEventListener('wheel', this.handleWheel, supportsPassiveEvents ? { passive: true } : false);\n-    }\n-\n     if (this.mediaQuery) {\n       if (this.mediaQuery.addEventListener) {\n         this.mediaQuery.addEventListener('change', this.handleLayoutChange);\n@@ -87,23 +81,7 @@ export default class ColumnsArea extends ImmutablePureComponent {\n     this.isRtlLayout = document.getElementsByTagName('body')[0].classList.contains('rtl');\n   }\n \n-  UNSAFE_componentWillUpdate(nextProps) {\n-    if (this.props.singleColumn !== nextProps.singleColumn && nextProps.singleColumn) {\n-      this.node.removeEventListener('wheel', this.handleWheel);\n-    }\n-  }\n-\n-  componentDidUpdate(prevProps) {\n-    if (this.props.singleColumn !== prevProps.singleColumn && !this.props.singleColumn) {\n-      this.node.addEventListener('wheel', this.handleWheel, supportsPassiveEvents ? { passive: true } : false);\n-    }\n-  }\n-\n   componentWillUnmount () {\n-    if (!this.props.singleColumn) {\n-      this.node.removeEventListener('wheel', this.handleWheel);\n-    }\n-\n     if (this.mediaQuery) {\n       if (this.mediaQuery.removeEventListener) {\n         this.mediaQuery.removeEventListener('change', this.handleLayoutChange);\n@@ -116,22 +94,14 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   handleChildrenContentChange() {\n     if (!this.props.singleColumn) {\n       const modifier = this.isRtlLayout ? -1 : 1;\n-      this._interruptScrollAnimation = scrollRight(this.node, (this.node.scrollWidth - window.innerWidth) * modifier);\n+      scrollRight(this.node, (this.node.scrollWidth - window.innerWidth) * modifier);\n     }\n   }\n \n   handleLayoutChange = (e) => {\n     this.setState({ renderComposePanel: !e.matches });\n   };\n \n-  handleWheel = () => {\n-    if (typeof this._interruptScrollAnimation !== 'function') {\n-      return;\n-    }\n-\n-    this._interruptScrollAnimation();\n-  };\n-\n   setRef = (node) => {\n     this.node = node;\n   };\n---\napp/javascript/mastodon/scroll.ts\n@@ -38,13 +38,20 @@ const scroll = (\n const isScrollBehaviorSupported =\n   'scrollBehavior' in document.documentElement.style;\n \n-export const scrollRight = (node: Element, position: number) => {\n-  if (isScrollBehaviorSupported)\n-    node.scrollTo({ left: position, behavior: 'smooth' });\n-  else scroll(node, 'scrollLeft', position);\n-};\n-\n-export const scrollTop = (node: Element) => {\n-  if (isScrollBehaviorSupported) node.scrollTo({ top: 0, behavior: 'smooth' });\n-  else scroll(node, 'scrollTop', 0);\n-};\n+export const scrollRight = (node: Element, position: number) =>\n+  requestIdleCallback(() => {\n+    if (isScrollBehaviorSupported) {\n+      node.scrollTo({ left: position, behavior: 'smooth' });\n+    } else {\n+      scroll(node, 'scrollLeft', position);\n+    }\n+  });\n+\n+export const scrollTop = (node: Element) =>\n+  requestIdleCallback(() => {\n+    if (isScrollBehaviorSupported) {\n+      node.scrollTo({ top: 0, behavior: 'smooth' });\n+    } else {\n+      scroll(node, 'scrollTop', 0);\n+    }\n+  });\n---\napp/javascript/mastodon/test_helpers.tsx\n@@ -8,6 +8,14 @@ import { render as rtlRender } from '@testing-library/react';\n \n import { IdentityContext } from './identity_context';\n \n+beforeEach(() => {\n+  global.requestIdleCallback = jest\n+    .fn()\n+    .mockImplementation((fn: () => void) => {\n+      fn();\n+    });\n+});\n+\n function render(\n   ui: React.ReactElement,\n   {\n---\n\n\n---\n\nChoice D:\nCHANGELOG.md\n@@ -2,6 +2,29 @@\n \n All notable changes to this project will be documented in this file.\n \n+## [4.3.7] - 2025-04-02\n+\n+### Add\n+\n+- Add delay to profile updates to debounce them (#34137 by @ClearlyClaire)\n+- Add support for paginating partial collections in `SynchronizeFollowersService` (#34272 and #34277 by @ClearlyClaire)\n+\n+### Changed\n+\n+- Change account suspensions to be federated to recently-followed accounts as well (#34294 by @ClearlyClaire)\n+- Change `AccountReachFinder` to consider statuses based on suspension date (#32805 and #34291 by @ClearlyClaire and @mjankowski)\n+- Change user archive signed URL TTL from 10 seconds to 1 hour (#34254 by @ClearlyClaire)\n+\n+### Fixed\n+\n+- Fix static version of animated PNG emojis not being properly extracted (#34337 by @ClearlyClaire)\n+- Fix filters not applying in detailed view, favourites and bookmarks (#34259 and #34260 by @ClearlyClaire)\n+- Fix handling of malformed/unusual HTML (#34201 by @ClearlyClaire)\n+- Fix `CacheBuster` being queued for missing media attachments (#34253 by @ClearlyClaire)\n+- Fix incorrect URL being used when cache busting (#34189 by @ClearlyClaire)\n+- Fix streaming server refusing unix socket path in `DATABASE_URL` (#34091 by @ClearlyClaire)\n+- Fix \u201cx\u201d hotkey not working on boosted filtered posts (#33758 by @ClearlyClaire)\n+\n ## [4.3.6] - 2025-03-13\n \n ### Security\n---\ndocker-compose.yml\n@@ -59,7 +59,7 @@ services:\n   web:\n     # You can uncomment the following line if you want to not use the prebuilt image, for example if you have local code changes\n     # build: .\n-    image: ghcr.io/mastodon/mastodon:v4.3.6\n+    image: ghcr.io/mastodon/mastodon:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -83,7 +83,7 @@ services:\n     # build:\n     #   dockerfile: ./streaming/Dockerfile\n     #   context: .\n-    image: ghcr.io/mastodon/mastodon-streaming:v4.3.6\n+    image: ghcr.io/mastodon/mastodon-streaming:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: node ./streaming/index.js\n@@ -102,7 +102,7 @@ services:\n   sidekiq:\n     # You can uncomment the following line if you want to not use the prebuilt image, for example if you have local code changes\n     # build: .\n-    image: ghcr.io/mastodon/mastodon:v4.3.6\n+    image: ghcr.io/mastodon/mastodon:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\nlib/mastodon/version.rb\n@@ -13,7 +13,7 @@ def minor\n     end\n \n     def patch\n-      6\n+      7\n     end\n \n     def default_prerelease\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\nThis issue randomly occurs and I am not sure of a consistent reproduction aside from using the web UI on an iPad for more than a few minutes.\r\n\r\n### Expected behaviour\r\n\r\nPointer events should map directly underneath the pointer location\r\n\r\n### Actual behaviour\r\n\r\nPointer events map to a location offset to the left of the pointer\r\n\r\n### Detailed description\r\n\r\nWhen using the web UI from an iPad (running iPad OS 17.3 and the stock Safari browser), after scrolling on Mastodon for a little bit the pointer events will start to fire for a location around 100px to the left of the actual pointer, making it very difficult to interact with intended UI elements. For example, attempting to click on the favorite or boost button on one toot might interact with a toot in a different column.\r\n\r\nHowever, scroll events still map correctly.\r\n\r\nIn this video I am using the touchpad on my iPad keyboard as this makes it obvious that the hover events aren\u2019t mapping to the actual pointer location; similar things occur when using touch events.\r\n\r\nhttps://github.com/mastodon/mastodon/assets/347162/7ff9ea2e-8dfa-4a98-b704-2a270fb684eb\r\n\r\n\r\n\r\n### Mastodon instance\r\n\r\nplush.city\r\n\r\n### Mastodon version\r\n\r\n4.2.8\r\n\r\n### Browser name and version\r\n\r\nSafari from iPadOS 17.3.1\r\n\r\n### Operating system\r\n\r\niPadOS 17.3.1\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/services/fetch_link_card_service.rb\n@@ -106,12 +106,11 @@ def skip_link?(anchor)\n   end\n \n   def attempt_oembed\n-    service         = FetchOEmbedService.new\n-    url_domain      = Addressable::URI.parse(@url).normalized_host\n-    cached_endpoint = Rails.cache.read(\"oembed_endpoint:#{url_domain}\")\n+    service = FetchOEmbedService.new\n \n-    embed   = service.call(@url, cached_endpoint: cached_endpoint) unless cached_endpoint.nil?\n+    embed   = service.call(@url, use_cached_endpoint: true)\n     embed ||= service.call(@url, html: html) unless html.nil?\n+    embed ||= service.call(@url, use_cached_endpoint: true) if @url != @original_url.to_s\n \n     return false if embed.nil?\n \n---\napp/services/fetch_oembed_service.rb\n@@ -10,7 +10,7 @@ def call(url, options = {})\n     @url     = url\n     @options = options\n \n-    if @options[:cached_endpoint]\n+    if @options[:use_cached_endpoint]\n       parse_cached_endpoint!\n     else\n       discover_endpoint!\n@@ -57,9 +57,9 @@ def discover_endpoint!\n   end\n \n   def parse_cached_endpoint!\n-    cached = @options[:cached_endpoint]\n+    cached = Rails.cache.read(cache_key)\n \n-    return if cached[:endpoint].nil? || cached[:format].nil?\n+    return if cached.nil? || cached[:endpoint].nil? || cached[:format].nil?\n \n     @endpoint_url = Addressable::Template.new(cached[:endpoint]).expand(url: @url).to_s\n     @format       = cached[:format]\n@@ -68,14 +68,16 @@ def parse_cached_endpoint!\n   def cache_endpoint!\n     return unless URL_REGEX.match?(@endpoint_url)\n \n-    url_domain = Addressable::URI.parse(@url).normalized_host\n-\n     endpoint_hash = {\n       endpoint: @endpoint_url.gsub(URL_REGEX, '={url}'),\n       format: @format,\n     }\n \n-    Rails.cache.write(\"oembed_endpoint:#{url_domain}\", endpoint_hash, expires_in: ENDPOINT_CACHE_EXPIRES_IN)\n+    Rails.cache.write(cache_key, endpoint_hash, expires_in: ENDPOINT_CACHE_EXPIRES_IN)\n+  end\n+\n+  def cache_key\n+    \"oembed_endpoint:#{Addressable::URI.parse(@url).normalized_host}\"\n   end\n \n   def fetch!\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -13,6 +13,7 @@\n     stub_request(:get, 'http://example.com/not-found').to_return(status: 404, headers: { 'Content-Type' => 'text/html' }, body: html)\n     stub_request(:get, 'http://example.com/text').to_return(status: 404, headers: { 'Content-Type' => 'text/plain' }, body: 'Hello')\n     stub_request(:get, 'http://example.com/redirect').to_return(status: 302, headers: { 'Location' => 'http://example.com/html' })\n+    stub_request(:get, 'http://example.net/redirect-to-other-domain').to_return(status: 302, headers: { 'Location' => 'http://example.com/html' })\n     stub_request(:get, 'http://example.com/redirect-to-404').to_return(status: 302, headers: { 'Location' => 'http://example.com/not-found' })\n     stub_request(:get, 'http://example.com/oembed?url=http://example.com/html').to_return(headers: { 'Content-Type' => 'application/json' }, body: '{ \"version\": \"1.0\", \"type\": \"link\", \"title\": \"oEmbed title\" }')\n     stub_request(:get, 'http://example.com/oembed?format=json&url=http://example.com/html').to_return(headers: { 'Content-Type' => 'application/json' }, body: '{ \"version\": \"1.0\", \"type\": \"link\", \"title\": \"oEmbed title\" }')\n@@ -264,6 +265,39 @@\n         end\n       end\n \n+      context 'when oEmbed endpoint cache populated with redirect target' do\n+        let(:status) { Fabricate(:status, text: 'http://example.net/redirect-to-other-domain') }\n+        let(:oembed_cache) { { endpoint: 'http://example.com/oembed?format=json&url={url}', format: :json } }\n+\n+        it 'uses the cached oEmbed response' do\n+          expect(a_request(:get, 'http://example.net/redirect-to-other-domain')).to have_been_made\n+          expect(a_request(:get, 'http://example.com/oembed?url=http://example.com/html')).to have_been_made\n+        end\n+\n+        it 'creates preview card' do\n+          expect(status.preview_card).to_not be_nil\n+          expect(status.preview_card.url).to eq 'http://example.com/html'\n+          expect(status.preview_card.title).to eq 'oEmbed title'\n+        end\n+      end\n+\n+      context 'when oEmbed endpoint cache populated with redirect target but page contains no oEmbed tags' do\n+        let(:status) { Fabricate(:status, text: 'http://example.net/redirect-to-other-domain') }\n+        let(:html) { 'Please fill out CAPTCHA' }\n+        let(:oembed_cache) { { endpoint: 'http://example.com/oembed?format=json&url={url}', format: :json } }\n+\n+        it 'uses the cached oEmbed response' do\n+          expect(a_request(:get, 'http://example.net/redirect-to-other-domain')).to have_been_made\n+          expect(a_request(:get, 'http://example.com/oembed?format=json&url=http://example.com/html')).to have_been_made\n+        end\n+\n+        it 'creates preview card' do\n+          expect(status.preview_card).to_not be_nil\n+          expect(status.preview_card.url).to eq 'http://example.com/html'\n+          expect(status.preview_card.title).to eq 'oEmbed title'\n+        end\n+      end\n+\n       # If the original HTML URL for whatever reason (e.g. DOS protection) redirects to\n       # an error page, we can still use the cached oEmbed but should not use the\n       # redirect URL on the card.\n---\nspec/services/fetch_oembed_service_spec.rb\n@@ -160,10 +160,12 @@\n           headers: { 'Content-Type': 'text/html' },\n           body: request_fixture('oembed_json_empty.html')\n         )\n+\n+        Rails.cache.write('oembed_endpoint:www.youtube.com', { endpoint: 'http://www.youtube.com/oembed?format=json&url={url}', format: :json })\n       end\n \n       it 'returns new provider without fetching original URL first' do\n-        subject.call('https://www.youtube.com/watch?v=dqwpQarrDwk', cached_endpoint: { endpoint: 'http://www.youtube.com/oembed?format=json&url={url}', format: :json })\n+        subject.call('https://www.youtube.com/watch?v=dqwpQarrDwk', use_cached_endpoint: true)\n         expect(a_request(:get, 'https://www.youtube.com/watch?v=dqwpQarrDwk')).to_not have_been_made\n         expect(subject.endpoint_url).to eq 'http://www.youtube.com/oembed?format=json&url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DdqwpQarrDwk'\n         expect(subject.format).to eq :json\n---\napp/lib/link_details_extractor.rb\n@@ -225,7 +225,7 @@ def host_to_url(str)\n   end\n \n   def valid_url_or_nil(str, same_origin_only: false)\n-    return if str.blank? || str == 'null'\n+    return if str.blank? || str == 'null' || str == 'undefined'\n \n     url = @original_url + Addressable::URI.parse(str)\n \n---\nspec/lib/link_details_extractor_spec.rb\n@@ -33,6 +33,14 @@\n         expect(subject.canonical_url).to eq original_url\n       end\n     end\n+\n+    context 'when canonical URL is set to \"undefined\"' do\n+      let(:url) { 'undefined' }\n+\n+      it 'ignores the canonical URLs' do\n+        expect(subject.canonical_url).to eq original_url\n+      end\n+    end\n   end\n \n   context 'when only basic metadata is present' do\n---\n\n\n---\n\nChoice B:\napp/lib/search_query_transformer.rb\n@@ -225,7 +225,7 @@ def language_code_from_term(term)\n   end\n \n   rule(clause: subtree(:clause)) do\n-    prefix   = clause[:prefix][:term].to_s if clause[:prefix]\n+    prefix   = clause[:prefix][:term].to_s.downcase if clause[:prefix]\n     operator = clause[:operator]&.to_s\n     term     = clause[:phrase] ? clause[:phrase].map { |term| term[:term].to_s }.join(' ') : clause[:term].to_s\n \n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/components/alt_text_badge.tsx\n@@ -0,0 +1,67 @@\n+import { useState, useCallback, useRef } from 'react';\n+\n+import { FormattedMessage } from 'react-intl';\n+\n+import Overlay from 'react-overlays/Overlay';\n+import type {\n+  OffsetValue,\n+  UsePopperOptions,\n+} from 'react-overlays/esm/usePopper';\n+\n+const offset = [0, 4] as OffsetValue;\n+const popperConfig = { strategy: 'fixed' } as UsePopperOptions;\n+\n+export const AltTextBadge: React.FC<{\n+  description: string;\n+}> = ({ description }) => {\n+  const anchorRef = useRef<HTMLButtonElement>(null);\n+  const [open, setOpen] = useState(false);\n+\n+  const handleClick = useCallback(() => {\n+    setOpen((v) => !v);\n+  }, [setOpen]);\n+\n+  const handleClose = useCallback(() => {\n+    setOpen(false);\n+  }, [setOpen]);\n+\n+  return (\n+    <>\n+      <button\n+        ref={anchorRef}\n+        className='media-gallery__alt__label'\n+        onClick={handleClick}\n+      >\n+        ALT\n+      </button>\n+\n+      <Overlay\n+        rootClose\n+        onHide={handleClose}\n+        show={open}\n+        target={anchorRef.current}\n+        placement='top-end'\n+        flip\n+        offset={offset}\n+        popperConfig={popperConfig}\n+      >\n+        {({ props }) => (\n+          <div {...props} className='hover-card-controller'>\n+            <div\n+              className='media-gallery__alt__popover dropdown-animation'\n+              role='tooltip'\n+            >\n+              <h4>\n+                <FormattedMessage\n+                  id='alt_text_badge.title'\n+                  defaultMessage='Alt text'\n+                />\n+              </h4>\n+              <p>{description}</p>\n+            </div>\n+          </div>\n+        )}\n+      </Overlay>\n+    </>\n+  );\n+};\n---\napp/javascript/mastodon/components/media_gallery.jsx\n@@ -10,6 +10,7 @@ import ImmutablePropTypes from 'react-immutable-proptypes';\n \n import { debounce } from 'lodash';\n \n+import { AltTextBadge } from 'mastodon/components/alt_text_badge';\n import { Blurhash } from 'mastodon/components/blurhash';\n import { formatTime } from 'mastodon/features/video';\n \n@@ -97,7 +98,7 @@ class Item extends PureComponent {\n     }\n \n     if (attachment.get('description')?.length > 0) {\n-      badges.push(<span key='alt' className='media-gallery__alt__label'>ALT</span>);\n+      badges.push(<AltTextBadge key='alt' description={attachment.get('description')} />);\n     }\n \n     const description = attachment.getIn(['translation', 'description']) || attachment.get('description');\n@@ -156,9 +157,9 @@ class Item extends PureComponent {\n       const duration = attachment.getIn(['meta', 'original', 'duration']);\n \n       if (attachment.get('type') === 'gifv') {\n-        badges.push(<span key='gif' className='media-gallery__gifv__label'>GIF</span>);\n+        badges.push(<span key='gif' className='media-gallery__alt__label media-gallery__alt__label--non-interactive'>GIF</span>);\n       } else {\n-        badges.push(<span key='video' className='media-gallery__gifv__label'>{formatTime(Math.floor(duration))}</span>);\n+        badges.push(<span key='video' className='media-gallery__alt__label media-gallery__alt__label--non-interactive'>{formatTime(Math.floor(duration))}</span>);\n       }\n \n       thumbnail = (\n---\napp/javascript/mastodon/features/account_gallery/components/media_item.tsx\n@@ -5,6 +5,7 @@ import classNames from 'classnames';\n import HeadphonesIcon from '@/material-icons/400-24px/headphones-fill.svg?react';\n import MovieIcon from '@/material-icons/400-24px/movie-fill.svg?react';\n import VisibilityOffIcon from '@/material-icons/400-24px/visibility_off.svg?react';\n+import { AltTextBadge } from 'mastodon/components/alt_text_badge';\n import { Blurhash } from 'mastodon/components/blurhash';\n import { Icon } from 'mastodon/components/icon';\n import { formatTime } from 'mastodon/features/video';\n@@ -77,11 +78,7 @@ export const MediaItem: React.FC<{\n   const badges = [];\n \n   if (description && description.length > 0) {\n-    badges.push(\n-      <span key='alt' className='media-gallery__alt__label'>\n-        ALT\n-      </span>,\n-    );\n+    badges.push(<AltTextBadge key='alt' description={description} />);\n   }\n \n   if (!visible) {\n@@ -156,13 +153,19 @@ export const MediaItem: React.FC<{\n \n     if (type === 'gifv') {\n       badges.push(\n-        <span key='gif' className='media-gallery__gifv__label'>\n+        <span\n+          key='gif'\n+          className='media-gallery__alt__label media-gallery__alt__label--non-interactive'\n+        >\n           GIF\n         </span>,\n       );\n     } else {\n       badges.push(\n-        <span key='video' className='media-gallery__gifv__label'>\n+        <span\n+          key='video'\n+          className='media-gallery__alt__label media-gallery__alt__label--non-interactive'\n+        >\n           {formatTime(Math.floor(duration))}\n         </span>,\n       );\n---\napp/javascript/mastodon/locales/en.json\n@@ -85,6 +85,7 @@\n   \"alert.rate_limited.title\": \"Rate limited\",\n   \"alert.unexpected.message\": \"An unexpected error occurred.\",\n   \"alert.unexpected.title\": \"Oops!\",\n+  \"alt_text_badge.title\": \"Alt text\",\n   \"announcement.announcement\": \"Announcement\",\n   \"attachments_list.unprocessed\": \"(unprocessed)\",\n   \"audio.hide\": \"Hide audio\",\n---\napp/javascript/styles/mastodon/components.scss\n@@ -6971,23 +6971,56 @@ a.status-card {\n   inset-inline-end: 8px;\n   display: flex;\n   gap: 2px;\n+  pointer-events: none;\n }\n \n-.media-gallery__alt__label,\n-.media-gallery__gifv__label {\n-  display: flex;\n-  align-items: center;\n-  justify-content: center;\n+.media-gallery__alt__label {\n+  display: block;\n+  text-align: center;\n   color: $white;\n+  border: 0;\n   background: rgba($black, 0.65);\n   backdrop-filter: blur(10px) saturate(180%) contrast(75%) brightness(70%);\n   padding: 3px 8px;\n   border-radius: 4px;\n   font-size: 12px;\n   font-weight: 700;\n   z-index: 1;\n-  pointer-events: none;\n   line-height: 20px;\n+  cursor: pointer;\n+  pointer-events: auto;\n+\n+  &--non-interactive {\n+    pointer-events: none;\n+  }\n+}\n+\n+.media-gallery__alt__popover {\n+  background: rgba($black, 0.65);\n+  backdrop-filter: blur(10px) saturate(180%) contrast(75%) brightness(70%);\n+  border-radius: 4px;\n+  box-shadow: var(--dropdown-shadow);\n+  padding: 16px;\n+  min-width: 16em;\n+  min-height: 2em;\n+  max-width: 22em;\n+  max-height: 30em;\n+  overflow-y: auto;\n+\n+  h4 {\n+    font-size: 15px;\n+    line-height: 20px;\n+    font-weight: 500;\n+    color: $white;\n+    margin-bottom: 8px;\n+  }\n+\n+  p {\n+    font-size: 15px;\n+    line-height: 20px;\n+    color: rgba($white, 0.85);\n+    white-space: pre-line;\n+  }\n }\n \n .attachment-list {\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -4,8 +4,6 @@ import { Children, cloneElement, useCallback } from 'react';\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import ImmutablePureComponent from 'react-immutable-pure-component';\n \n-import { supportsPassiveEvents } from 'detect-passive-events';\n-\n import { scrollRight } from '../../../scroll';\n import BundleContainer from '../containers/bundle_container';\n import {\n@@ -71,10 +69,6 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   };\n \n   componentDidMount() {\n-    if (!this.props.singleColumn) {\n-      this.node.addEventListener('wheel', this.handleWheel, supportsPassiveEvents ? { passive: true } : false);\n-    }\n-\n     if (this.mediaQuery) {\n       if (this.mediaQuery.addEventListener) {\n         this.mediaQuery.addEventListener('change', this.handleLayoutChange);\n@@ -87,23 +81,7 @@ export default class ColumnsArea extends ImmutablePureComponent {\n     this.isRtlLayout = document.getElementsByTagName('body')[0].classList.contains('rtl');\n   }\n \n-  UNSAFE_componentWillUpdate(nextProps) {\n-    if (this.props.singleColumn !== nextProps.singleColumn && nextProps.singleColumn) {\n-      this.node.removeEventListener('wheel', this.handleWheel);\n-    }\n-  }\n-\n-  componentDidUpdate(prevProps) {\n-    if (this.props.singleColumn !== prevProps.singleColumn && !this.props.singleColumn) {\n-      this.node.addEventListener('wheel', this.handleWheel, supportsPassiveEvents ? { passive: true } : false);\n-    }\n-  }\n-\n   componentWillUnmount () {\n-    if (!this.props.singleColumn) {\n-      this.node.removeEventListener('wheel', this.handleWheel);\n-    }\n-\n     if (this.mediaQuery) {\n       if (this.mediaQuery.removeEventListener) {\n         this.mediaQuery.removeEventListener('change', this.handleLayoutChange);\n@@ -116,22 +94,14 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   handleChildrenContentChange() {\n     if (!this.props.singleColumn) {\n       const modifier = this.isRtlLayout ? -1 : 1;\n-      this._interruptScrollAnimation = scrollRight(this.node, (this.node.scrollWidth - window.innerWidth) * modifier);\n+      scrollRight(this.node, (this.node.scrollWidth - window.innerWidth) * modifier);\n     }\n   }\n \n   handleLayoutChange = (e) => {\n     this.setState({ renderComposePanel: !e.matches });\n   };\n \n-  handleWheel = () => {\n-    if (typeof this._interruptScrollAnimation !== 'function') {\n-      return;\n-    }\n-\n-    this._interruptScrollAnimation();\n-  };\n-\n   setRef = (node) => {\n     this.node = node;\n   };\n---\napp/javascript/mastodon/scroll.ts\n@@ -38,13 +38,20 @@ const scroll = (\n const isScrollBehaviorSupported =\n   'scrollBehavior' in document.documentElement.style;\n \n-export const scrollRight = (node: Element, position: number) => {\n-  if (isScrollBehaviorSupported)\n-    node.scrollTo({ left: position, behavior: 'smooth' });\n-  else scroll(node, 'scrollLeft', position);\n-};\n-\n-export const scrollTop = (node: Element) => {\n-  if (isScrollBehaviorSupported) node.scrollTo({ top: 0, behavior: 'smooth' });\n-  else scroll(node, 'scrollTop', 0);\n-};\n+export const scrollRight = (node: Element, position: number) =>\n+  requestIdleCallback(() => {\n+    if (isScrollBehaviorSupported) {\n+      node.scrollTo({ left: position, behavior: 'smooth' });\n+    } else {\n+      scroll(node, 'scrollLeft', position);\n+    }\n+  });\n+\n+export const scrollTop = (node: Element) =>\n+  requestIdleCallback(() => {\n+    if (isScrollBehaviorSupported) {\n+      node.scrollTo({ top: 0, behavior: 'smooth' });\n+    } else {\n+      scroll(node, 'scrollTop', 0);\n+    }\n+  });\n---\napp/javascript/mastodon/test_helpers.tsx\n@@ -8,6 +8,14 @@ import { render as rtlRender } from '@testing-library/react';\n \n import { IdentityContext } from './identity_context';\n \n+beforeEach(() => {\n+  global.requestIdleCallback = jest\n+    .fn()\n+    .mockImplementation((fn: () => void) => {\n+      fn();\n+    });\n+});\n+\n function render(\n   ui: React.ReactElement,\n   {\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\nInspect the Notifications icon in the navigation panel.\r\n\r\n![Safari - 2024-03-13 a\u0300 12 01@2x](https://github.com/mastodon/mastodon/assets/914451/123be21b-1d58-43a7-9775-56d9015874bf)\r\n\r\n\r\n### Expected behaviour\r\n\r\nThe Notifications icon class should be \"icon-bell\"\r\n\r\n### Actual behaviour\r\n\r\nThe Notifications icon class is \"icon-undefined\"\r\n\r\n### Detailed description\r\n\r\nThe class of the Notifications icon is \"icon-undefined\" instead of \"icon-bell\".\r\nThis breaks custom theme compatibility.\r\n\r\n### Mastodon instance\r\n\r\nmastodon.social\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-nightly.2024-03-13\r\n\r\n### Browser name and version\r\n\r\nSafari 17.4\r\n\r\n### Operating system\r\n\r\nmacOS Sonoma 14.4\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -4389,7 +4389,7 @@ a.status-card.compact:hover {\n }\n \n .relationship-tag {\n-  color: $primary-text-color;\n+  color: $white;\n   margin-bottom: 4px;\n   display: block;\n   background-color: rgba($black, 0.45);\n---\n\n\n---\n\nChoice B:\nDockerfile\n@@ -103,6 +103,7 @@ RUN \\\n     procps \\\n     tini \\\n     tzdata \\\n+    wget \\\n   ; \\\n # Patch Ruby to use jemalloc\n   patchelf --add-needed libjemalloc.so.2 /usr/local/bin/ruby; \\\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/explore/results.jsx\n@@ -156,45 +156,43 @@ class Results extends PureComponent {\n \n     let filteredResults;\n \n-    if (!isLoading) {\n-      const accounts = results.get('accounts', ImmutableList());\n-      const hashtags = results.get('hashtags', ImmutableList());\n-      const statuses = results.get('statuses', ImmutableList());\n-\n-      switch(type) {\n-      case 'all':\n-        filteredResults = (accounts.size + hashtags.size + statuses.size) > 0 ? (\n-          <>\n-            {accounts.size > 0 && (\n-              <SearchSection key='accounts' title={<><Icon id='users' fixedWidth /><FormattedMessage id='search_results.accounts' defaultMessage='Profiles' /></>} onClickMore={this.handleLoadMoreAccounts}>\n-                {accounts.take(INITIAL_DISPLAY).map(id => <Account key={id} id={id} />)}\n-              </SearchSection>\n-            )}\n-\n-            {hashtags.size > 0 && (\n-              <SearchSection key='hashtags' title={<><Icon id='hashtag' fixedWidth /><FormattedMessage id='search_results.hashtags' defaultMessage='Hashtags' /></>} onClickMore={this.handleLoadMoreHashtags}>\n-                {hashtags.take(INITIAL_DISPLAY).map(hashtag => <Hashtag key={hashtag.get('name')} hashtag={hashtag} />)}\n-              </SearchSection>\n-            )}\n-\n-            {statuses.size > 0 && (\n-              <SearchSection key='statuses' title={<><Icon id='quote-right' fixedWidth /><FormattedMessage id='search_results.statuses' defaultMessage='Posts' /></>} onClickMore={this.handleLoadMoreStatuses}>\n-                {statuses.take(INITIAL_DISPLAY).map(id => <Status key={id} id={id} />)}\n-              </SearchSection>\n-            )}\n-          </>\n-        ) : [];\n-        break;\n-      case 'accounts':\n-        filteredResults = renderAccounts(accounts);\n-        break;\n-      case 'hashtags':\n-        filteredResults = renderHashtags(hashtags);\n-        break;\n-      case 'statuses':\n-        filteredResults = renderStatuses(statuses);\n-        break;\n-      }\n+    const accounts = results.get('accounts', ImmutableList());\n+    const hashtags = results.get('hashtags', ImmutableList());\n+    const statuses = results.get('statuses', ImmutableList());\n+\n+    switch(type) {\n+    case 'all':\n+      filteredResults = (accounts.size + hashtags.size + statuses.size) > 0 ? (\n+        <>\n+          {accounts.size > 0 && (\n+            <SearchSection key='accounts' title={<><Icon id='users' fixedWidth /><FormattedMessage id='search_results.accounts' defaultMessage='Profiles' /></>} onClickMore={this.handleLoadMoreAccounts}>\n+              {accounts.take(INITIAL_DISPLAY).map(id => <Account key={id} id={id} />)}\n+            </SearchSection>\n+          )}\n+\n+          {hashtags.size > 0 && (\n+            <SearchSection key='hashtags' title={<><Icon id='hashtag' fixedWidth /><FormattedMessage id='search_results.hashtags' defaultMessage='Hashtags' /></>} onClickMore={this.handleLoadMoreHashtags}>\n+              {hashtags.take(INITIAL_DISPLAY).map(hashtag => <Hashtag key={hashtag.get('name')} hashtag={hashtag} />)}\n+            </SearchSection>\n+          )}\n+\n+          {statuses.size > 0 && (\n+            <SearchSection key='statuses' title={<><Icon id='quote-right' fixedWidth /><FormattedMessage id='search_results.statuses' defaultMessage='Posts' /></>} onClickMore={this.handleLoadMoreStatuses}>\n+              {statuses.take(INITIAL_DISPLAY).map(id => <Status key={id} id={id} />)}\n+            </SearchSection>\n+          )}\n+        </>\n+      ) : [];\n+      break;\n+    case 'accounts':\n+      filteredResults = renderAccounts(accounts);\n+      break;\n+    case 'hashtags':\n+      filteredResults = renderHashtags(hashtags);\n+      break;\n+    case 'statuses':\n+      filteredResults = renderStatuses(statuses);\n+      break;\n     }\n \n     return (\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/ui/components/navigation_panel.jsx\n@@ -64,8 +64,8 @@ const NotificationsLink = () => {\n     <ColumnLink\n       transparent\n       to='/notifications'\n-      icon={<IconWithBadge icon={NotificationsIcon} count={count} className='column-link__icon' />}\n-      activeIcon={<IconWithBadge icon={NotificationsActiveIcon} count={count} className='column-link__icon' />}\n+      icon={<IconWithBadge id='bell' icon={NotificationsIcon} count={count} className='column-link__icon' />}\n+      activeIcon={<IconWithBadge id='bell' icon={NotificationsActiveIcon} count={count} className='column-link__icon' />}\n       text={intl.formatMessage(messages.notifications)}\n     />\n   );\n@@ -88,8 +88,8 @@ const FollowRequestsLink = () => {\n     <ColumnLink\n       transparent\n       to='/follow_requests'\n-      icon={<IconWithBadge icon={PersonAddIcon} count={count} className='column-link__icon' />}\n-      activeIcon={<IconWithBadge icon={PersonAddActiveIcon} count={count} className='column-link__icon' />}\n+      icon={<IconWithBadge id='user-plus' icon={PersonAddIcon} count={count} className='column-link__icon' />}\n+      activeIcon={<IconWithBadge id='user-plus' icon={PersonAddActiveIcon} count={count} className='column-link__icon' />}\n       text={intl.formatMessage(messages.followRequests)}\n     />\n   );\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nUnder \"Getting Started\", the old \"# Explore\" option is present in the column.\n\n### Expected behaviour\n\nThe modern compass Explorer icon should be present.\n\n### Actual behaviour\n\nThe hashtag icon is displayed next to Explore.\n\n### Detailed description\n\nWhen clicking on Explore, the new icon is used at the top of the Explore column, it just doesn't show on the Getting Started tab.\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.3.0-nightly.2024-02-23\n\n### Browser name and version\n\nFirefox 123.0.1\n\n### Operating system\n\nWindows 11 22H2\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/services/post_status_service.rb\n@@ -134,7 +134,7 @@ def validate_media!\n \n     @media = @account.media_attachments.where(status_id: nil).where(id: @options[:media_ids].take(Status::MEDIA_ATTACHMENTS_LIMIT).map(&:to_i))\n \n-    not_found_ids = @options[:media_ids] - @media.map(&:id)\n+    not_found_ids = @options[:media_ids].map(&:to_i) - @media.map(&:id)\n     raise Mastodon::ValidationError, I18n.t('media_attachments.validations.not_found', ids: not_found_ids.join(', ')) if not_found_ids.any?\n \n     raise Mastodon::ValidationError, I18n.t('media_attachments.validations.images_and_video') if @media.size > 1 && @media.find(&:audio_or_video?)\n---\napp/services/update_status_service.rb\n@@ -73,7 +73,7 @@ def validate_media!\n \n     media_attachments = @status.account.media_attachments.where(status_id: [nil, @status.id]).where(scheduled_status_id: nil).where(id: @options[:media_ids].take(Status::MEDIA_ATTACHMENTS_LIMIT).map(&:to_i)).to_a\n \n-    not_found_ids = @options[:media_ids] - media_attachments.map(&:id)\n+    not_found_ids = @options[:media_ids].map(&:to_i) - media_attachments.map(&:id)\n     raise Mastodon::ValidationError, I18n.t('media_attachments.validations.not_found', ids: not_found_ids.join(', ')) if not_found_ids.any?\n \n     raise Mastodon::ValidationError, I18n.t('media_attachments.validations.images_and_video') if media_attachments.size > 1 && media_attachments.find(&:audio_or_video?)\n---\nspec/services/post_status_service_spec.rb\n@@ -34,15 +34,15 @@\n \n     it 'schedules a status for future creation and does not create one immediately' do\n       media = Fabricate(:media_attachment, account: account)\n-      status = subject.call(account, text: 'Hi future!', media_ids: [media.id], scheduled_at: future)\n+      status = subject.call(account, text: 'Hi future!', media_ids: [media.id.to_s], scheduled_at: future)\n \n       expect(status)\n         .to be_a(ScheduledStatus)\n         .and have_attributes(\n           scheduled_at: eq(future),\n           params: include(\n             'text' => eq('Hi future!'),\n-            'media_ids' => contain_exactly(media.id)\n+            'media_ids' => contain_exactly(media.id.to_s)\n           )\n         )\n       expect(media.reload.status).to be_nil\n@@ -219,7 +219,7 @@\n     status = subject.call(\n       account,\n       text: 'test status update',\n-      media_ids: [media.id]\n+      media_ids: [media.id.to_s]\n     )\n \n     expect(media.reload.status).to eq status\n@@ -233,7 +233,7 @@\n       subject.call(\n         account,\n         text: 'test status update',\n-        media_ids: [media.id]\n+        media_ids: [media.id.to_s]\n       )\n     end.to raise_error(\n       Mastodon::ValidationError,\n@@ -249,7 +249,7 @@\n       subject.call(\n         account,\n         text: 'test status update',\n-        media_ids: Array.new(2) { Fabricate(:media_attachment, account: account) }.map(&:id)\n+        media_ids: Array.new(2) { Fabricate(:media_attachment, account: account) }.map { |m| m.id.to_s }\n       )\n     end.to raise_error(\n       Mastodon::ValidationError,\n@@ -271,7 +271,7 @@\n         media_ids: [\n           video,\n           image,\n-        ].map(&:id)\n+        ].map { |m| m.id.to_s }\n       )\n     end.to raise_error(\n       Mastodon::ValidationError,\n---\nspec/services/update_status_service_spec.rb\n@@ -69,7 +69,7 @@\n \n     before do\n       status.media_attachments << detached_media_attachment\n-      subject.call(status, status.account_id, text: 'Foo', media_ids: [attached_media_attachment.id])\n+      subject.call(status, status.account_id, text: 'Foo', media_ids: [attached_media_attachment.id.to_s])\n     end\n \n     it 'updates media attachments' do\n@@ -95,7 +95,7 @@\n \n     before do\n       status.media_attachments << media_attachment\n-      subject.call(status, status.account_id, text: 'Foo', media_ids: [media_attachment.id], media_attributes: [{ id: media_attachment.id, description: 'New description' }])\n+      subject.call(status, status.account_id, text: 'Foo', media_ids: [media_attachment.id.to_s], media_attributes: [{ id: media_attachment.id, description: 'New description' }])\n     end\n \n     it 'does not detach media attachment' do\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/getting_started/index.jsx\n@@ -11,6 +11,7 @@ import { connect } from 'react-redux';\n \n import AlternateEmailIcon from '@/material-icons/400-24px/alternate_email.svg?react';\n import BookmarksIcon from '@/material-icons/400-24px/bookmarks-fill.svg?react';\n+import ExploreIcon from '@/material-icons/400-24px/explore.svg?react';\n import PeopleIcon from '@/material-icons/400-24px/group.svg?react';\n import HomeIcon from '@/material-icons/400-24px/home-fill.svg?react';\n import ListAltIcon from '@/material-icons/400-24px/list_alt.svg?react';\n@@ -19,7 +20,6 @@ import PersonAddIcon from '@/material-icons/400-24px/person_add.svg?react';\n import PublicIcon from '@/material-icons/400-24px/public.svg?react';\n import SettingsIcon from '@/material-icons/400-24px/settings-fill.svg?react';\n import StarIcon from '@/material-icons/400-24px/star.svg?react';\n-import TagIcon from '@/material-icons/400-24px/tag.svg?react';\n import { fetchFollowRequests } from 'mastodon/actions/accounts';\n import Column from 'mastodon/components/column';\n import ColumnHeader from 'mastodon/components/column_header';\n@@ -112,7 +112,7 @@ class GettingStarted extends ImmutablePureComponent {\n \n     if (showTrends) {\n       navItems.push(\n-        <ColumnLink key='explore' icon='explore' iconComponent={TagIcon} text={intl.formatMessage(messages.explore)} to='/explore' />,\n+        <ColumnLink key='explore' icon='explore' iconComponent={ExploreIcon} text={intl.formatMessage(messages.explore)} to='/explore' />,\n       );\n     }\n \n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/reducers/accounts.ts\n@@ -41,40 +41,42 @@ const normalizeAccounts = (\n   return state;\n };\n \n-export const accountsReducer: Reducer<typeof initialState> = (\n-  state = initialState,\n-  action,\n-) => {\n-  const currentUserId = me;\n-\n-  if (!currentUserId)\n+function getCurrentUser() {\n+  if (!me)\n     throw new Error(\n       'No current user (me) defined when calling `accountsReducer`',\n     );\n \n+  return me;\n+}\n+\n+export const accountsReducer: Reducer<typeof initialState> = (\n+  state = initialState,\n+  action,\n+) => {\n   if (revealAccount.match(action))\n     return state.setIn([action.payload.id, 'hidden'], false);\n   else if (importAccounts.match(action))\n     return normalizeAccounts(state, action.payload.accounts);\n-  else if (followAccountSuccess.match(action))\n+  else if (followAccountSuccess.match(action)) {\n     return state\n       .update(\n         action.payload.relationship.id,\n         (account) => account?.update('followers_count', (n) => n + 1),\n       )\n       .update(\n-        currentUserId,\n+        getCurrentUser(),\n         (account) => account?.update('following_count', (n) => n + 1),\n       );\n-  else if (unfollowAccountSuccess.match(action))\n+  } else if (unfollowAccountSuccess.match(action))\n     return state\n       .update(\n         action.payload.relationship.id,\n         (account) =>\n           account?.update('followers_count', (n) => Math.max(0, n - 1)),\n       )\n       .update(\n-        currentUserId,\n+        getCurrentUser(),\n         (account) =>\n           account?.update('following_count', (n) => Math.max(0, n - 1)),\n       );\n---\nspec/system/unlogged_spec.rb\n@@ -0,0 +1,17 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+describe 'UnloggedBrowsing' do\n+  subject { page }\n+\n+  before do\n+    visit root_path\n+  end\n+\n+  it 'loads the home page' do\n+    expect(subject).to have_css('div.app-holder')\n+\n+    expect(subject).to have_css('div.columns-area__panels__main')\n+  end\n+end\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/components/status.jsx\n@@ -546,7 +546,7 @@ class Status extends ImmutablePureComponent {\n     const visibilityIcon = visibilityIconInfo[status.get('visibility')];\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n-    const expanded = !status.get('hidden')\n+    const expanded = !status.get('hidden') || status.get('spoiler_text').length === 0;\n \n     return (\n       <HotKeys handlers={handlers}>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -293,7 +293,7 @@ class DetailedStatus extends ImmutablePureComponent {\n     }\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n-    const expanded = !status.get('hidden')\n+    const expanded = !status.get('hidden') || status.get('spoiler_text').length === 0;\n \n     return (\n       <div style={outerStyle}>\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\nI have to translate \"`%{people}` people in the past `%{days}` days\" as \"People in the past `%{days}` day(s): `%{people}`\" to avoid grammar errors, which is really bad UX.\r\n\r\nc.f. [Issue on Crowdin](https://crowdin.com/editor/mastodon/54/en-gd?view=comfortable#28120).\r\n\r\n### Expected behaviour\r\n\r\nPlural form syntax used\r\n\r\n### Actual behaviour\r\n\r\nPlural form syntax not used\r\n\r\n### Detailed description\r\n\r\nThis actually needs splitting into 2 separate strings, because there are 2 plural-controlling placeholders in there.\r\n\r\nKey: `user_mailer.welcome.hashtags_recent_count\r\nroot -> user_mailer -> welcome -> hashtags_recent_count`\r\nFile: [en.yml](https://crowdin.com/editor/mastodon/54/en-gd)\r\n\r\n### Mastodon instance\r\n\r\nmastodon.social\r\n\r\n### Mastodon version\r\n\r\nv4.3.0.x\r\n\r\n### Browser name and version\r\n\r\nAny\r\n\r\n### Operating system\r\n\r\nAny\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/components/edited_timestamp/index.jsx\n@@ -67,7 +67,7 @@ class EditedTimestamp extends PureComponent {\n     return (\n       <DropdownMenu statusId={statusId} renderItem={this.renderItem} scrollable renderHeader={this.renderHeader} onItemClick={this.handleItemClick}>\n         <button className='dropdown-menu__text-button'>\n-          <FormattedMessage id='status.edited' defaultMessage='Edited {date}' values={{ date: intl.formatDate(timestamp, { hour12: false, month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) }} /> <Icon id='caret-down' icon={ArrowDropDownIcon} />\n+          <FormattedMessage id='status.edited' defaultMessage='Edited {date}' values={{ date: intl.formatDate(timestamp, { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) }} /> <Icon id='caret-down' icon={ArrowDropDownIcon} />\n         </button>\n       </DropdownMenu>\n     );\n---\napp/javascript/mastodon/components/relative_timestamp.tsx\n@@ -53,7 +53,6 @@ const messages = defineMessages({\n });\n \n const dateFormatOptions = {\n-  hour12: false,\n   year: 'numeric',\n   month: 'short',\n   day: '2-digit',\n---\napp/javascript/mastodon/components/status.jsx\n@@ -554,7 +554,7 @@ class Status extends ImmutablePureComponent {\n             <div onClick={this.handleClick} className='status__info'>\n               <a href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} className='status__relative-time' target='_blank' rel='noopener noreferrer'>\n                 <span className='status__visibility-icon'><VisibilityIcon visibility={status.get('visibility')} /></span>\n-                <RelativeTimestamp timestamp={status.get('created_at')} />{status.get('edited_at') && <abbr title={intl.formatMessage(messages.edited, { date: intl.formatDate(status.get('edited_at'), { hour12: false, year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) })}> *</abbr>}\n+                <RelativeTimestamp timestamp={status.get('created_at')} />{status.get('edited_at') && <abbr title={intl.formatMessage(messages.edited, { date: intl.formatDate(status.get('edited_at'), { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) })}> *</abbr>}\n               </a>\n \n               <a onClick={this.handleAccountClick} href={`/@${status.getIn(['account', 'acct'])}`} title={status.getIn(['account', 'acct'])} className='status__display-name' target='_blank' rel='noopener noreferrer'>\n---\napp/javascript/mastodon/features/account/components/header.jsx\n@@ -101,7 +101,6 @@ const dateFormatOptions = {\n   month: 'short',\n   day: 'numeric',\n   year: 'numeric',\n-  hour12: false,\n   hour: '2-digit',\n   minute: '2-digit',\n };\n---\napp/javascript/mastodon/features/getting_started/components/announcements.jsx\n@@ -343,7 +343,7 @@ class Announcement extends ImmutablePureComponent {\n       <div className='announcements__item'>\n         <strong className='announcements__item__range'>\n           <FormattedMessage id='announcement.announcement' defaultMessage='Announcement' />\n-          {hasTimeRange && <span> \u00b7 <FormattedDate value={startsAt} hour12={false} year={(skipYear || startsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month='short' day='2-digit' hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /> - <FormattedDate value={endsAt} hour12={false} year={(skipYear || endsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month={skipEndDate ? undefined : 'short'} day={skipEndDate ? undefined : '2-digit'} hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /></span>}\n+          {hasTimeRange && <span> \u00b7 <FormattedDate value={startsAt} year={(skipYear || startsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month='short' day='2-digit' hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /> - <FormattedDate value={endsAt} year={(skipYear || endsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month={skipEndDate ? undefined : 'short'} day={skipEndDate ? undefined : '2-digit'} hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /></span>}\n         </strong>\n \n         <Content announcement={announcement} />\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -311,7 +311,7 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n-              <FormattedDate value={new Date(status.get('created_at'))} hour12={false} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n+              <FormattedDate value={new Date(status.get('created_at'))} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n             </a>{edited}{visibilityLink}{applicationLink}{reblogLink} \u00b7 {favouriteLink}\n           </div>\n         </div>\n---\napp/javascript/packs/public.jsx\n@@ -65,7 +65,6 @@ function loaded() {\n \n   const timeFormat = new Intl.DateTimeFormat(locale, {\n     timeStyle: 'short',\n-    hour12: false,\n   });\n \n   const formatMessage = ({ id, defaultMessage }, values) => {\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -4,8 +4,6 @@ import { Children, cloneElement, useCallback } from 'react';\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import ImmutablePureComponent from 'react-immutable-pure-component';\n \n-import { supportsPassiveEvents } from 'detect-passive-events';\n-\n import { scrollRight } from '../../../scroll';\n import BundleContainer from '../containers/bundle_container';\n import {\n@@ -71,10 +69,6 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   };\n \n   componentDidMount() {\n-    if (!this.props.singleColumn) {\n-      this.node.addEventListener('wheel', this.handleWheel, supportsPassiveEvents ? { passive: true } : false);\n-    }\n-\n     if (this.mediaQuery) {\n       if (this.mediaQuery.addEventListener) {\n         this.mediaQuery.addEventListener('change', this.handleLayoutChange);\n@@ -87,23 +81,7 @@ export default class ColumnsArea extends ImmutablePureComponent {\n     this.isRtlLayout = document.getElementsByTagName('body')[0].classList.contains('rtl');\n   }\n \n-  UNSAFE_componentWillUpdate(nextProps) {\n-    if (this.props.singleColumn !== nextProps.singleColumn && nextProps.singleColumn) {\n-      this.node.removeEventListener('wheel', this.handleWheel);\n-    }\n-  }\n-\n-  componentDidUpdate(prevProps) {\n-    if (this.props.singleColumn !== prevProps.singleColumn && !this.props.singleColumn) {\n-      this.node.addEventListener('wheel', this.handleWheel, supportsPassiveEvents ? { passive: true } : false);\n-    }\n-  }\n-\n   componentWillUnmount () {\n-    if (!this.props.singleColumn) {\n-      this.node.removeEventListener('wheel', this.handleWheel);\n-    }\n-\n     if (this.mediaQuery) {\n       if (this.mediaQuery.removeEventListener) {\n         this.mediaQuery.removeEventListener('change', this.handleLayoutChange);\n@@ -116,22 +94,14 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   handleChildrenContentChange() {\n     if (!this.props.singleColumn) {\n       const modifier = this.isRtlLayout ? -1 : 1;\n-      this._interruptScrollAnimation = scrollRight(this.node, (this.node.scrollWidth - window.innerWidth) * modifier);\n+      scrollRight(this.node, (this.node.scrollWidth - window.innerWidth) * modifier);\n     }\n   }\n \n   handleLayoutChange = (e) => {\n     this.setState({ renderComposePanel: !e.matches });\n   };\n \n-  handleWheel = () => {\n-    if (typeof this._interruptScrollAnimation !== 'function') {\n-      return;\n-    }\n-\n-    this._interruptScrollAnimation();\n-  };\n-\n   setRef = (node) => {\n     this.node = node;\n   };\n---\napp/javascript/mastodon/scroll.ts\n@@ -38,13 +38,20 @@ const scroll = (\n const isScrollBehaviorSupported =\n   'scrollBehavior' in document.documentElement.style;\n \n-export const scrollRight = (node: Element, position: number) => {\n-  if (isScrollBehaviorSupported)\n-    node.scrollTo({ left: position, behavior: 'smooth' });\n-  else scroll(node, 'scrollLeft', position);\n-};\n-\n-export const scrollTop = (node: Element) => {\n-  if (isScrollBehaviorSupported) node.scrollTo({ top: 0, behavior: 'smooth' });\n-  else scroll(node, 'scrollTop', 0);\n-};\n+export const scrollRight = (node: Element, position: number) =>\n+  requestIdleCallback(() => {\n+    if (isScrollBehaviorSupported) {\n+      node.scrollTo({ left: position, behavior: 'smooth' });\n+    } else {\n+      scroll(node, 'scrollLeft', position);\n+    }\n+  });\n+\n+export const scrollTop = (node: Element) =>\n+  requestIdleCallback(() => {\n+    if (isScrollBehaviorSupported) {\n+      node.scrollTo({ top: 0, behavior: 'smooth' });\n+    } else {\n+      scroll(node, 'scrollTop', 0);\n+    }\n+  });\n---\napp/javascript/mastodon/test_helpers.tsx\n@@ -8,6 +8,14 @@ import { render as rtlRender } from '@testing-library/react';\n \n import { IdentityContext } from './identity_context';\n \n+beforeEach(() => {\n+  global.requestIdleCallback = jest\n+    .fn()\n+    .mockImplementation((fn: () => void) => {\n+      fn();\n+    });\n+});\n+\n function render(\n   ui: React.ReactElement,\n   {\n---\n\n\n---\n\nChoice C:\napp/lib/link_details_extractor.rb\n@@ -269,16 +269,21 @@ def structured_data\n   end\n \n   def document\n-    @document ||= Nokogiri::HTML(@html, nil, encoding)\n+    @document ||= detect_encoding_and_parse_document\n   end\n \n-  def encoding\n-    @encoding ||= begin\n-      guess = detector.detect(@html, @html_charset)\n-      guess&.fetch(:confidence, 0).to_i > 60 ? guess&.fetch(:encoding, nil) : nil\n+  def detect_encoding_and_parse_document\n+    [detect_encoding, nil, @html_charset, 'UTF-8'].uniq.each do |encoding|\n+      document = Nokogiri::HTML(@html, nil, encoding)\n+      return document if document.to_s.valid_encoding?\n     end\n   end\n \n+  def detect_encoding\n+    guess = detector.detect(@html, @html_charset)\n+    guess&.fetch(:confidence, 0).to_i > 60 ? guess&.fetch(:encoding, nil) : nil\n+  end\n+\n   def detector\n     @detector ||= CharlockHolmes::EncodingDetector.new.tap do |detector|\n       detector.strip_tags = true\n---\nspec/fixtures/requests/low_confidence_latin1.txt\n@@ -0,0 +1,17 @@\n+HTTP/1.1 200 OK\n+server: nginx\n+date: Thu, 13 Jun 2024 14:33:13 GMT\n+content-type: text/html; charset=ISO-8859-1\n+content-length: 158\n+accept-ranges: bytes\n+\n+<!doctype html>\n+<html lang=\"en\">\n+<head>\n+  <meta charset=\"UTF-8\">\n+  <title>Tofu \ufffd l'orange</title>\n+</head>\n+<body>\n+  <h2>Tofu \ufffd l'orange</h2>\n+</body>\n+</html>\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -26,6 +26,7 @@\n     stub_request(:get, 'http://example.com/sjis_with_wrong_charset').to_return(request_fixture('sjis_with_wrong_charset.txt'))\n     stub_request(:get, 'http://example.com/koi8-r').to_return(request_fixture('koi8-r.txt'))\n     stub_request(:get, 'http://example.com/windows-1251').to_return(request_fixture('windows-1251.txt'))\n+    stub_request(:get, 'http://example.com/low_confidence_latin1').to_return(request_fixture('low_confidence_latin1.txt'))\n \n     Rails.cache.write('oembed_endpoint:example.com', oembed_cache) if oembed_cache\n \n@@ -148,6 +149,14 @@\n       end\n     end\n \n+    context 'with a URL of a page in ISO-8859-1 encoding, that charlock_holmes cannot detect' do\n+      let(:status) { Fabricate(:status, text: 'Check out http://example.com/low_confidence_latin1') }\n+\n+      it 'decodes the HTML' do\n+        expect(status.preview_card.title).to eq(\"Tofu \u00e1 l'orange\")\n+      end\n+    end\n+\n     context 'with a Japanese path URL' do\n       let(:status) { Fabricate(:status, text: '\u30c6\u30b9\u30c8http://example.com/\u65e5\u672c\u8a9e') }\n \n---\n\n\n---\n\nChoice D:\napp/views/application/mailer/_hashtag.html.haml\n@@ -17,4 +17,4 @@\n                           %span.email-mini-hashtag-img-span\n                             = image_tag full_asset_url(account.avatar.url), alt: '', width: 16, height: 16\n                       %td\n-                        %p= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(hashtag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts), days: 2)\n+                        %p= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(hashtag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts))\n---\napp/views/user_mailer/welcome.text.erb\n@@ -53,7 +53,7 @@\n <%= t('user_mailer.welcome.hashtags_subtitle') %>\n \n <%- @tags.each do |tag| %>\n-* #<%= tag.display_name %> \u00b7 <%= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(tag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts), days: 2) %>\n+* #<%= tag.display_name %> \u00b7 <%= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(tag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts)) %>\n   <%= tag_url(tag) %>\n <%- end %>\n \n---\nconfig/locales/en.yml\n@@ -1868,7 +1868,9 @@ en:\n       follows_subtitle: Follow well-known accounts\n       follows_title: Who to follow\n       follows_view_more: View more people to follow\n-      hashtags_recent_count: \"%{people} people in the past %{days} days\"\n+      hashtags_recent_count:\n+        one: \"%{people} person in the past 2 days\"\n+        other: \"%{people} people in the past 2 days\"\n       hashtags_subtitle: Explore what\u2019s trending since past 2 days\n       hashtags_title: Trending hashtags\n       hashtags_view_more: View more trending hashtags\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Run `RAILS_ENV=production DB_HOST=10.0.0.115 DB_PORT=5432 bundle exec rails db:migrate`\r\n\r\n\r\n\r\n### Expected behaviour\r\n\r\nStatus should be `up 20240304090449  Migrate interaction settings to policy`\r\n\r\n### Actual behaviour\r\n\r\nMigration fails\r\n\r\n### Detailed description\r\n\r\nWhen I try to run the database migrations, ends in this error.\r\n\r\n<details>\r\n<summary>Click to toggle contents of `code`</summary>\r\n\r\n```\r\nRAILS_ENV=production DB_HOST=10.0.0.115 DB_PORT=5432 bundle exec rails db:migrate --trace\r\n** Invoke db:migrate (first_time)\r\n** Invoke db:load_config (first_time)\r\n** Invoke environment (first_time)\r\n** Execute environment\r\n** Execute db:load_config\r\n** Invoke db:pre_migration_check (first_time)\r\n** Invoke environment\r\n** Execute db:pre_migration_check\r\n** Execute db:migrate\r\nI, [2024-03-07T18:45:48.122499 #3092892]  INFO -- : Migrating to MigrateInteractionSettingsToPolicy (20240304090449)\r\n== 20240304090449 MigrateInteractionSettingsToPolicy: migrating ===============\r\nWARNING:  you don't own a lock of type ExclusiveLock\r\nbin/rails aborted!\r\nActiveRecord::ConcurrentMigrationError:  (ActiveRecord::ConcurrentMigrationError)\r\n\r\nFailed to release advisory lock\r\n\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1603:in `ensure in with_advisory_lock'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1603:in `with_advisory_lock'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1448:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/railtie.rb:28:in `block in migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/strategy.rb:60:in `wrap'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy.rb:151:in `strategy'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/railtie.rb:28:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1274:in `up'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1249:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/tasks/database_tasks.rb:243:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/strong_migrations-1.7.0/lib/strong_migrations/database_tasks.rb:5:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/railties/databases.rake:93:in `block (2 levels) in <main>'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:281:in `block in execute'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:281:in `each'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:281:in `execute'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:219:in `block in invoke_with_call_chain'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:199:in `synchronize'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:199:in `invoke_with_call_chain'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:188:in `invoke'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:182:in `invoke_task'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:138:in `block (2 levels) in top_level'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:138:in `each'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:138:in `block in top_level'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:147:in `run_with_threads'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:132:in `top_level'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:27:in `block (2 levels) in perform'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:208:in `standard_exception_handling'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:27:in `block in perform'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:44:in `block in with_rake'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/rake_module.rb:59:in `with_application'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:41:in `with_rake'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:20:in `perform'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/command.rb:156:in `invoke_rake'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/command.rb:73:in `block in invoke'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/command.rb:149:in `with_argv'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/command.rb:69:in `invoke'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands.rb:18:in `<main>'\r\n<internal:/home/mastodon/.rbenv/versions/3.2.3/lib/ruby/site_ruby/3.2.0/rubygems/core_ext/kernel_require.rb>:37:in `require'\r\n<internal:/home/mastodon/.rbenv/versions/3.2.3/lib/ruby/site_ruby/3.2.0/rubygems/core_ext/kernel_require.rb>:37:in `require'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bootsnap-1.18.3/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\nbin/rails:4:in `<main>'\r\n\r\nCaused by:\r\nStandardError: An error has occurred, all later migrations canceled: (StandardError)\r\n\r\nundefined method `[]' for nil:NilClass\r\n/home/mastodon/live/db/migrate/20240304090449_migrate_interaction_settings_to_policy.rb:26:in `block in up'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:82:in `each'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:82:in `block in find_each'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:158:in `block in find_in_batches'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:396:in `block in batch_on_unloaded_relation'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:372:in `loop'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:372:in `batch_on_unloaded_relation'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:269:in `in_batches'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:157:in `find_in_batches'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:81:in `find_each'\r\n/home/mastodon/live/db/migrate/20240304090449_migrate_interaction_settings_to_policy.rb:21:in `up'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:989:in `public_send'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:989:in `exec_migration'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:970:in `block (2 levels) in migrate'\r\n/home/mastodon/.rbenv/versions/3.2.3/lib/ruby/3.2.0/benchmark.rb:296:in `measure'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:969:in `block in migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/connection_adapters/abstract/connection_pool.rb:227:in `with_connection'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:968:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/strong_migrations-1.7.0/lib/strong_migrations/migration.rb:5:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/railtie.rb:28:in `block in migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/strategy.rb:60:in `wrap'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy.rb:151:in `strategy'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/railtie.rb:28:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1178:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1529:in `block in execute_migration_in_transaction'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1582:in `ddl_transaction'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/strong_migrations-1.7.0/lib/strong_migrations/migrator.rb:4:in `ddl_transaction'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1528:in `execute_migration_in_transaction'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1503:in `each'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1503:in `migrate_without_lock'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1448:in `block in migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1600:in `with_advisory_lock'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1448:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/railtie.rb:28:in `block in migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/strategy.rb:60:in `wrap'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy.rb:151:in `strategy'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/railtie.rb:28:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1274:in `up'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1249:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/tasks/database_tasks.rb:243:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/strong_migrations-1.7.0/lib/strong_migrations/database_tasks.rb:5:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/railties/databases.rake:93:in `block (2 levels) in <main>'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:281:in `block in execute'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:281:in `each'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:281:in `execute'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:219:in `block in invoke_with_call_chain'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:199:in `synchronize'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:199:in `invoke_with_call_chain'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:188:in `invoke'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:182:in `invoke_task'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:138:in `block (2 levels) in top_level'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:138:in `each'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:138:in `block in top_level'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:147:in `run_with_threads'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:132:in `top_level'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:27:in `block (2 levels) in perform'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:208:in `standard_exception_handling'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:27:in `block in perform'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:44:in `block in with_rake'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/rake_module.rb:59:in `with_application'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:41:in `with_rake'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:20:in `perform'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/command.rb:156:in `invoke_rake'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/command.rb:73:in `block in invoke'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/command.rb:149:in `with_argv'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/command.rb:69:in `invoke'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands.rb:18:in `<main>'\r\n<internal:/home/mastodon/.rbenv/versions/3.2.3/lib/ruby/site_ruby/3.2.0/rubygems/core_ext/kernel_require.rb>:37:in `require'\r\n<internal:/home/mastodon/.rbenv/versions/3.2.3/lib/ruby/site_ruby/3.2.0/rubygems/core_ext/kernel_require.rb>:37:in `require'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bootsnap-1.18.3/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\nbin/rails:4:in `<main>'\r\n\r\nCaused by:\r\nNoMethodError: undefined method `[]' for nil:NilClass (NoMethodError)\r\n\r\n      if deserialized_settings['interactions.must_be_follower']\r\n                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n/home/mastodon/live/db/migrate/20240304090449_migrate_interaction_settings_to_policy.rb:26:in `block in up'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:82:in `each'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:82:in `block in find_each'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:158:in `block in find_in_batches'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:396:in `block in batch_on_unloaded_relation'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:372:in `loop'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:372:in `batch_on_unloaded_relation'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:269:in `in_batches'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:157:in `find_in_batches'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/relation/batches.rb:81:in `find_each'\r\n/home/mastodon/live/db/migrate/20240304090449_migrate_interaction_settings_to_policy.rb:21:in `up'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:989:in `public_send'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:989:in `exec_migration'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:970:in `block (2 levels) in migrate'\r\n/home/mastodon/.rbenv/versions/3.2.3/lib/ruby/3.2.0/benchmark.rb:296:in `measure'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:969:in `block in migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/connection_adapters/abstract/connection_pool.rb:227:in `with_connection'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:968:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/strong_migrations-1.7.0/lib/strong_migrations/migration.rb:5:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/railtie.rb:28:in `block in migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/strategy.rb:60:in `wrap'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy.rb:151:in `strategy'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/railtie.rb:28:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1178:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1529:in `block in execute_migration_in_transaction'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1582:in `ddl_transaction'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/strong_migrations-1.7.0/lib/strong_migrations/migrator.rb:4:in `ddl_transaction'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1528:in `execute_migration_in_transaction'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1503:in `each'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1503:in `migrate_without_lock'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1448:in `block in migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1600:in `with_advisory_lock'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1448:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/railtie.rb:28:in `block in migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/strategy.rb:60:in `wrap'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy.rb:151:in `strategy'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/railtie.rb:28:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1274:in `up'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1249:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/tasks/database_tasks.rb:243:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/strong_migrations-1.7.0/lib/strong_migrations/database_tasks.rb:5:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/railties/databases.rake:93:in `block (2 levels) in <main>'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:281:in `block in execute'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:281:in `each'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:281:in `execute'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:219:in `block in invoke_with_call_chain'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:199:in `synchronize'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:199:in `invoke_with_call_chain'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:188:in `invoke'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:182:in `invoke_task'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:138:in `block (2 levels) in top_level'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:138:in `each'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:138:in `block in top_level'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:147:in `run_with_threads'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:132:in `top_level'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:27:in `block (2 levels) in perform'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:208:in `standard_exception_handling'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:27:in `block in perform'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:44:in `block in with_rake'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/rake_module.rb:59:in `with_application'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:41:in `with_rake'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:20:in `perform'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/command.rb:156:in `invoke_rake'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/command.rb:73:in `block in invoke'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/command.rb:149:in `with_argv'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/command.rb:69:in `invoke'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands.rb:18:in `<main>'\r\n<internal:/home/mastodon/.rbenv/versions/3.2.3/lib/ruby/site_ruby/3.2.0/rubygems/core_ext/kernel_require.rb>:37:in `require'\r\n<internal:/home/mastodon/.rbenv/versions/3.2.3/lib/ruby/site_ruby/3.2.0/rubygems/core_ext/kernel_require.rb>:37:in `require'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bootsnap-1.18.3/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\nbin/rails:4:in `<main>'\r\nTasks: TOP => db:migrate\r\n```\r\n</details>\r\n\r\nWhen I try to run it again:\r\n<details>\r\n<summary>Click to toggle contents of `code`</summary>\r\n\r\n```\r\nRAILS_ENV=production DB_HOST=10.0.0.115 DB_PORT=5432 bundle exec rails db:migrate --trace\r\n** Invoke db:migrate (first_time)\r\n** Invoke db:load_config (first_time)\r\n** Invoke environment (first_time)\r\n** Execute environment\r\n** Execute db:load_config\r\n** Invoke db:pre_migration_check (first_time)\r\n** Invoke environment\r\n** Execute db:pre_migration_check\r\n** Execute db:migrate\r\nbin/rails aborted!\r\nActiveRecord::ConcurrentMigrationError:  (ActiveRecord::ConcurrentMigrationError)\r\n\r\nCannot run migrations because another migration process is currently running.\r\n\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1598:in `with_advisory_lock'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1448:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/railtie.rb:28:in `block in migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/strategy.rb:60:in `wrap'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy.rb:151:in `strategy'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.5.1/lib/chewy/railtie.rb:28:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1274:in `up'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/migration.rb:1249:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/tasks/database_tasks.rb:243:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/strong_migrations-1.7.0/lib/strong_migrations/database_tasks.rb:5:in `migrate'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.1.3.2/lib/active_record/railties/databases.rake:93:in `block (2 levels) in <main>'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:281:in `block in execute'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:281:in `each'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:281:in `execute'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:219:in `block in invoke_with_call_chain'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:199:in `synchronize'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:199:in `invoke_with_call_chain'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/task.rb:188:in `invoke'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:182:in `invoke_task'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:138:in `block (2 levels) in top_level'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:138:in `each'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:138:in `block in top_level'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:147:in `run_with_threads'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:132:in `top_level'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:27:in `block (2 levels) in perform'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/application.rb:208:in `standard_exception_handling'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:27:in `block in perform'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:44:in `block in with_rake'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rake-13.1.0/lib/rake/rake_module.rb:59:in `with_application'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:41:in `with_rake'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands/rake/rake_command.rb:20:in `perform'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/command.rb:156:in `invoke_rake'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/command.rb:73:in `block in invoke'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/command.rb:149:in `with_argv'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/command.rb:69:in `invoke'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.1.3.2/lib/rails/commands.rb:18:in `<main>'\r\n<internal:/home/mastodon/.rbenv/versions/3.2.3/lib/ruby/site_ruby/3.2.0/rubygems/core_ext/kernel_require.rb>:37:in `require'\r\n<internal:/home/mastodon/.rbenv/versions/3.2.3/lib/ruby/site_ruby/3.2.0/rubygems/core_ext/kernel_require.rb>:37:in `require'\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bootsnap-1.18.3/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:30:in `require'\r\nbin/rails:4:in `<main>'\r\nTasks: TOP => db:migrate\r\n```\r\n</details>\r\n\r\nEven if I manually release the lock using `SELECT pid, locktype, mode FROM pg_locks WHERE locktype = 'advisory';`, or if I wait long enough, we're back to the first error. So the database migration status is always:\r\n\r\n`down    20240304090449  Migrate interaction settings to policy`.\r\n\r\nAll the other migrations are up:\r\n\r\n```\r\n  (...)\r\n   up     20230822081029  Create software updates\r\n   up     20230904134623  Fix kmr locale settings\r\n   up     20230907150100  Add index account stats on last status at and account\r\n   up     20231006183200  Add URL to preview cards statuses\r\n   up     20231211234923  Create follow recommendation mutes\r\n   up     20231212073317  Add languages index to account summaries\r\n   up     20231222100226  Add allow with approval to email domain blocks\r\n   up     20240109103012  Fix canadian french locale\r\n   up     20240111033014  Create generated annual reports\r\n   up     20240221195424  Add filtered to notifications\r\n   up     20240221195828  Create notification requests\r\n   up     20240221211359  Notification request ids to timestamp ids\r\n   up     20240222193403  Create notification permissions\r\n   up     20240222203722  Create notification policies\r\n   up     20240227191620  Add filtered index on notifications\r\n```\r\n\r\n### Mastodon instance\r\n\r\nbolha.one\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-alpha.3\r\n\r\n### Technical details\r\n\r\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: `ruby 3.2.3 (2024-01-18 revision 52bb2ac0a6) [x86_64-linux]`\r\n- Node.js version: `v20.10.0`\r\n\n\n---\n\nChoice A:\nyarn.lock\n@@ -14663,8 +14663,8 @@ __metadata:\n   linkType: hard\n \n \"sass-loader@npm:^10.2.0\":\n-  version: 10.4.1\n-  resolution: \"sass-loader@npm:10.4.1\"\n+  version: 10.5.0\n+  resolution: \"sass-loader@npm:10.5.0\"\n   dependencies:\n     klona: \"npm:^2.0.4\"\n     loader-utils: \"npm:^2.0.0\"\n@@ -14673,7 +14673,7 @@ __metadata:\n     semver: \"npm:^7.3.2\"\n   peerDependencies:\n     fibers: \">= 3.1.0\"\n-    node-sass: ^4.0.0 || ^5.0.0 || ^6.0.0 || ^7.0.0 || ^8.0.0\n+    node-sass: ^4.0.0 || ^5.0.0 || ^6.0.0 || ^7.0.0 || ^8.0.0 || ^9.0.0\n     sass: ^1.3.0\n     webpack: ^4.36.0 || ^5.0.0\n   peerDependenciesMeta:\n@@ -14683,7 +14683,7 @@ __metadata:\n       optional: true\n     sass:\n       optional: true\n-  checksum: bf04a440fe471928f3cf884bc12c6b70bc391795b35510b1b9021e8a2cca3b8f966aef9518f4171e87e9cb78193a774f695921e6b61881a1580ae0a3c7b1b5e4\n+  checksum: be5da7784fd21c4f526cc3afaa1a765ba44cdc2f9798ecbac87b296ab44184ac5ba9bbda68a7a86f8cdcb6130acceefeb8912260fca14bdfc97f9dad02658400\n   languageName: node\n   linkType: hard\n \n---\n\n\n---\n\nChoice B:\napp/models/concerns/attachmentable.rb\n@@ -52,9 +52,13 @@ def check_image_dimension(attachment)\n     return if attachment.blank? || !/image.*/.match?(attachment.content_type) || attachment.queued_for_write[:original].blank?\n \n     width, height = FastImage.size(attachment.queued_for_write[:original].path)\n-    matrix_limit  = attachment.content_type == 'image/gif' ? GIF_MATRIX_LIMIT : MAX_MATRIX_LIMIT\n+    return unless width.present? && height.present?\n \n-    raise Mastodon::DimensionsValidationError, \"#{width}x#{height} images are not supported\" if width.present? && height.present? && (width * height > matrix_limit)\n+    if attachment.content_type == 'image/gif' && width * height > GIF_MATRIX_LIMIT\n+      raise Mastodon::DimensionsValidationError, \"#{width}x#{height} GIF files are not supported\"\n+    elsif width * height > MAX_MATRIX_LIMIT\n+      raise Mastodon::DimensionsValidationError, \"#{width}x#{height} images are not supported\"\n+    end\n   end\n \n   def appropriate_extension(attachment)\n---\n\n\n---\n\nChoice C:\ndb/migrate/20240304090449_migrate_interaction_settings_to_policy.rb\n@@ -20,6 +20,9 @@ class NotificationPolicy < ApplicationRecord\n   def up\n     User.includes(account: :notification_policy).find_each do |user|\n       deserialized_settings = Oj.load(user.attributes_before_type_cast['settings'])\n+\n+      next if deserialized_settings.nil?\n+\n       policy = user.account.notification_policy || user.account.build_notification_policy\n       requires_new_policy = false\n \n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/home_timeline/components/inline_follow_suggestions.jsx\n@@ -151,8 +151,13 @@ export const InlineFollowSuggestions = ({ hidden }) => {\n       return;\n     }\n \n-    setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n-    setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    if (getComputedStyle(bodyRef.current).direction === 'rtl') {\n+      setCanScrollLeft((bodyRef.current.clientWidth - bodyRef.current.scrollLeft) < bodyRef.current.scrollWidth);\n+      setCanScrollRight(bodyRef.current.scrollLeft < 0);\n+    } else {\n+      setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n+      setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    }\n   }, [setCanScrollRight, setCanScrollLeft, bodyRef]);\n \n   const handleDismiss = useCallback(() => {\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Set your computer\u2019s locale to something like en-US that uses 12 hour time.\r\n2. Look at the detail view of a post created in the afternoon.\r\n\n\n### Expected behaviour\n\nTime stamp should be 12 hour time, e.g. \u201c2:48 PM\u201d if that\u2019s what the user\u2019s locale is\n\n### Actual behaviour\n\nTime stamp is 24 hour time, e.g. \u201c14:48\u201d\n\n### Detailed description\n\nMastodon shouldn\u2019t override the user\u2019s locale for time display. Reading 24-hour times is unnatural for some people accustomed to 12 hour time. Using a different format than what the user\u2019s device is set to contributes to Mastodon feeling foreign, technical, and not user-friendly.\r\n\r\n<img width=\"172\" alt=\"Screenshot 2024-02-28 at 2 58 40\u202fPM\" src=\"https://github.com/mastodon/mastodon/assets/3615519/adfc2e9f-8cf9-46f9-885a-f80e8781d917\">\r\n<img width=\"236\" alt=\"Screenshot 2024-02-28 at 3 18 14\u202fPM\" src=\"https://github.com/mastodon/mastodon/assets/3615519/b283183e-54a0-4e78-b5fa-5b404a039956\">\r\n\n\n### Mastodon instance\n\nmastodon.online\n\n### Mastodon version\n\nv4.3.0-nightly.2024-02-23\n\n### Browser name and version\n\nSafari 17.3.1\n\n### Operating system\n\nmacOS 14.3.1\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -4365,12 +4365,20 @@ a.status-card {\n     outline: $ui-button-focus-outline;\n   }\n \n+  .no-reduce-motion .icon {\n+    transition: transform 0.15s ease-in-out;\n+  }\n+\n   &.active {\n     color: $primary-text-color;\n \n     &:hover {\n       color: $primary-text-color;\n     }\n+\n+    .icon {\n+      transform: rotate(60deg);\n+    }\n   }\n \n   &:disabled {\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -63,8 +63,8 @@ export default class ColumnsArea extends ImmutablePureComponent {\n     children: PropTypes.node,\n   };\n \n-  // Corresponds to (max-width: $no-gap-breakpoint + 285px - 1px) in SCSS\n-  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1174px)');\n+  // Corresponds to (max-width: $no-gap-breakpoint - 1px) in SCSS\n+  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1206px)');\n \n   state = {\n     renderComposePanel: !(this.mediaQuery && this.mediaQuery.matches),\n---\napp/javascript/styles/mastodon/variables.scss\n@@ -87,7 +87,7 @@ $media-modal-media-max-width: 100%;\n // put margins on top and bottom of image to avoid the screen covered by image.\n $media-modal-media-max-height: 80%;\n \n-$no-gap-breakpoint: 1175px;\n+$no-gap-breakpoint: 1207px;\n $mobile-breakpoint: 630px;\n \n $font-sans-serif: 'mastodon-font-sans-serif' !default;\n---\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -62,7 +62,7 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   };\n \n   // Corresponds to (max-width: $no-gap-breakpoint - 1px) in SCSS\n-  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1206px)');\n+  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1174px)');\n \n   state = {\n     renderComposePanel: !(this.mediaQuery && this.mediaQuery.matches),\n---\napp/javascript/styles/mastodon/components.scss\n@@ -2708,7 +2708,7 @@ a.account__display-name {\n     &__main {\n       box-sizing: border-box;\n       width: 100%;\n-      flex: 0 0 auto;\n+      flex: 0 1 auto;\n       display: flex;\n       flex-direction: column;\n \n---\napp/javascript/styles/mastodon/variables.scss\n@@ -87,7 +87,7 @@ $media-modal-media-max-width: 100%;\n // put margins on top and bottom of image to avoid the screen covered by image.\n $media-modal-media-max-height: 80%;\n \n-$no-gap-breakpoint: 1207px;\n+$no-gap-breakpoint: 1175px;\n $mobile-breakpoint: 630px;\n \n $font-sans-serif: 'mastodon-font-sans-serif' !default;\n---\n\n\n---\n\nChoice C:\napp/lib/link_details_extractor.rb\n@@ -156,11 +156,11 @@ def height\n   end\n \n   def title\n-    html_entities.decode(structured_data&.headline || opengraph_tag('og:title') || document.xpath('//title').map(&:content).first).strip\n+    html_entities_decode(structured_data&.headline || opengraph_tag('og:title') || document.xpath('//title').map(&:content).first).strip\n   end\n \n   def description\n-    html_entities.decode(structured_data&.description || opengraph_tag('og:description') || meta_tag('description'))\n+    html_entities_decode(structured_data&.description || opengraph_tag('og:description') || meta_tag('description'))\n   end\n \n   def published_at\n@@ -180,15 +180,15 @@ def canonical_url\n   end\n \n   def provider_name\n-    html_entities.decode(structured_data&.publisher_name || opengraph_tag('og:site_name'))\n+    html_entities_decode(structured_data&.publisher_name || opengraph_tag('og:site_name'))\n   end\n \n   def provider_url\n     valid_url_or_nil(host_to_url(opengraph_tag('og:site')))\n   end\n \n   def author_name\n-    html_entities.decode(structured_data&.author_name || opengraph_tag('og:author') || opengraph_tag('og:author:username'))\n+    html_entities_decode(structured_data&.author_name || opengraph_tag('og:author') || opengraph_tag('og:author:username'))\n   end\n \n   def author_url\n@@ -257,7 +257,7 @@ def structured_data\n \n       next if json_ld.blank?\n \n-      structured_data = StructuredData.new(html_entities.decode(json_ld))\n+      structured_data = StructuredData.new(html_entities_decode(json_ld))\n \n       next unless structured_data.valid?\n \n@@ -273,10 +273,11 @@ def document\n   end\n \n   def detect_encoding_and_parse_document\n-    [detect_encoding, nil, @html_charset, 'UTF-8'].uniq.each do |encoding|\n+    [detect_encoding, nil, @html_charset].uniq.each do |encoding|\n       document = Nokogiri::HTML(@html, nil, encoding)\n       return document if document.to_s.valid_encoding?\n     end\n+    Nokogiri::HTML(@html, nil, 'UTF-8')\n   end\n \n   def detect_encoding\n@@ -290,6 +291,15 @@ def detector\n     end\n   end\n \n+  def html_entities_decode(string)\n+    return if string.nil?\n+\n+    unicode_string = string.encode('UTF-8')\n+    raise EncodingError, 'cannot convert string to valid UTF-8' unless unicode_string.valid_encoding?\n+\n+    html_entities.decode(unicode_string)\n+  end\n+\n   def html_entities\n     @html_entities ||= HTMLEntities.new(:expanded)\n   end\n---\napp/services/fetch_link_card_service.rb\n@@ -32,7 +32,7 @@ def call(status)\n     end\n \n     attach_card if @card&.persisted?\n-  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError, Encoding::UndefinedConversionError => e\n+  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError, EncodingError => e\n     Rails.logger.debug { \"Error fetching link #{@original_url}: #{e}\" }\n     nil\n   end\n---\nspec/fixtures/requests/latin1_posing_as_utf8_broken.txt\n@@ -0,0 +1,17 @@\n+HTTP/1.1 200 OK\n+server: nginx\n+date: Thu, 13 Jun 2024 14:33:13 GMT\n+content-type: text/html; charset=utf-8\n+content-length: 158\n+accept-ranges: bytes\n+\n+<!doctype html>\n+<html lang=\"en\">\n+<head>\n+  <meta charset=\"UTF-8\">\n+  <title>Tofu \ufffd l'orange</title>\n+</head>\n+<body>\n+  <h2>Tofu \ufffd l'orange</h2>\n+</body>\n+</html>\n---\nspec/fixtures/requests/latin1_posing_as_utf8_recoverable.txt\n@@ -0,0 +1,17 @@\n+HTTP/1.1 200 OK\n+server: nginx\n+date: Thu, 13 Jun 2024 14:33:13 GMT\n+content-type: text/html; charset=utf-8\n+content-length: 158\n+accept-ranges: bytes\n+\n+<!doctype html>\n+<html lang=\"en\">\n+<head>\n+  <meta charset=\"UTF-8\">\n+  <title>Tofu with orange sauce</title>\n+</head>\n+<body>\n+  <h2>Tofu \ufffd l'orange</h2>\n+</body>\n+</html>\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -27,6 +27,8 @@\n     stub_request(:get, 'http://example.com/koi8-r').to_return(request_fixture('koi8-r.txt'))\n     stub_request(:get, 'http://example.com/windows-1251').to_return(request_fixture('windows-1251.txt'))\n     stub_request(:get, 'http://example.com/low_confidence_latin1').to_return(request_fixture('low_confidence_latin1.txt'))\n+    stub_request(:get, 'http://example.com/latin1_posing_as_utf8_broken').to_return(request_fixture('latin1_posing_as_utf8_broken.txt'))\n+    stub_request(:get, 'http://example.com/latin1_posing_as_utf8_recoverable').to_return(request_fixture('latin1_posing_as_utf8_recoverable.txt'))\n     stub_request(:get, 'http://example.com/aergerliche-umlaute').to_return(request_fixture('redirect_with_utf8_url.txt'))\n \n     Rails.cache.write('oembed_endpoint:example.com', oembed_cache) if oembed_cache\n@@ -159,10 +161,30 @@\n     end\n \n     context 'with a URL of a page in ISO-8859-1 encoding, that charlock_holmes cannot detect' do\n-      let(:status) { Fabricate(:status, text: 'Check out http://example.com/low_confidence_latin1') }\n+      context 'when encoding in http header is correct' do\n+        let(:status) { Fabricate(:status, text: 'Check out http://example.com/low_confidence_latin1') }\n \n-      it 'decodes the HTML' do\n-        expect(status.preview_card.title).to eq(\"Tofu \u00e1 l'orange\")\n+        it 'decodes the HTML' do\n+          expect(status.preview_card.title).to eq(\"Tofu \u00e1 l'orange\")\n+        end\n+      end\n+\n+      context 'when encoding in http header is incorrect' do\n+        context 'when encoding problems appear in unrelated tags' do\n+          let(:status) { Fabricate(:status, text: 'Check out http://example.com/latin1_posing_as_utf8_recoverable') }\n+\n+          it 'decodes the HTML' do\n+            expect(status.preview_card.title).to eq('Tofu with orange sauce')\n+          end\n+        end\n+\n+        context 'when encoding problems appear in title tag' do\n+          let(:status) { Fabricate(:status, text: 'Check out http://example.com/latin1_posing_as_utf8_broken') }\n+\n+          it 'does not create a preview card' do\n+            expect(status.preview_card).to be_nil\n+          end\n+        end\n       end\n     end\n \n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/components/edited_timestamp/index.jsx\n@@ -67,7 +67,7 @@ class EditedTimestamp extends PureComponent {\n     return (\n       <DropdownMenu statusId={statusId} renderItem={this.renderItem} scrollable renderHeader={this.renderHeader} onItemClick={this.handleItemClick}>\n         <button className='dropdown-menu__text-button'>\n-          <FormattedMessage id='status.edited' defaultMessage='Edited {date}' values={{ date: intl.formatDate(timestamp, { hour12: false, month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) }} /> <Icon id='caret-down' icon={ArrowDropDownIcon} />\n+          <FormattedMessage id='status.edited' defaultMessage='Edited {date}' values={{ date: intl.formatDate(timestamp, { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) }} /> <Icon id='caret-down' icon={ArrowDropDownIcon} />\n         </button>\n       </DropdownMenu>\n     );\n---\napp/javascript/mastodon/components/relative_timestamp.tsx\n@@ -53,7 +53,6 @@ const messages = defineMessages({\n });\n \n const dateFormatOptions = {\n-  hour12: false,\n   year: 'numeric',\n   month: 'short',\n   day: '2-digit',\n---\napp/javascript/mastodon/components/status.jsx\n@@ -554,7 +554,7 @@ class Status extends ImmutablePureComponent {\n             <div onClick={this.handleClick} className='status__info'>\n               <a href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} className='status__relative-time' target='_blank' rel='noopener noreferrer'>\n                 <span className='status__visibility-icon'><VisibilityIcon visibility={status.get('visibility')} /></span>\n-                <RelativeTimestamp timestamp={status.get('created_at')} />{status.get('edited_at') && <abbr title={intl.formatMessage(messages.edited, { date: intl.formatDate(status.get('edited_at'), { hour12: false, year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) })}> *</abbr>}\n+                <RelativeTimestamp timestamp={status.get('created_at')} />{status.get('edited_at') && <abbr title={intl.formatMessage(messages.edited, { date: intl.formatDate(status.get('edited_at'), { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) })}> *</abbr>}\n               </a>\n \n               <a onClick={this.handleAccountClick} href={`/@${status.getIn(['account', 'acct'])}`} title={status.getIn(['account', 'acct'])} className='status__display-name' target='_blank' rel='noopener noreferrer'>\n---\napp/javascript/mastodon/features/account/components/header.jsx\n@@ -101,7 +101,6 @@ const dateFormatOptions = {\n   month: 'short',\n   day: 'numeric',\n   year: 'numeric',\n-  hour12: false,\n   hour: '2-digit',\n   minute: '2-digit',\n };\n---\napp/javascript/mastodon/features/getting_started/components/announcements.jsx\n@@ -343,7 +343,7 @@ class Announcement extends ImmutablePureComponent {\n       <div className='announcements__item'>\n         <strong className='announcements__item__range'>\n           <FormattedMessage id='announcement.announcement' defaultMessage='Announcement' />\n-          {hasTimeRange && <span> \u00b7 <FormattedDate value={startsAt} hour12={false} year={(skipYear || startsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month='short' day='2-digit' hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /> - <FormattedDate value={endsAt} hour12={false} year={(skipYear || endsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month={skipEndDate ? undefined : 'short'} day={skipEndDate ? undefined : '2-digit'} hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /></span>}\n+          {hasTimeRange && <span> \u00b7 <FormattedDate value={startsAt} year={(skipYear || startsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month='short' day='2-digit' hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /> - <FormattedDate value={endsAt} year={(skipYear || endsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month={skipEndDate ? undefined : 'short'} day={skipEndDate ? undefined : '2-digit'} hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /></span>}\n         </strong>\n \n         <Content announcement={announcement} />\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -311,7 +311,7 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n-              <FormattedDate value={new Date(status.get('created_at'))} hour12={false} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n+              <FormattedDate value={new Date(status.get('created_at'))} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n             </a>{edited}{visibilityLink}{applicationLink}{reblogLink} \u00b7 {favouriteLink}\n           </div>\n         </div>\n---\napp/javascript/packs/public.jsx\n@@ -65,7 +65,6 @@ function loaded() {\n \n   const timeFormat = new Intl.DateTimeFormat(locale, {\n     timeStyle: 'short',\n-    hour12: false,\n   });\n \n   const formatMessage = ({ id, defaultMessage }, values) => {\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nFollow-up to #22879, which introduced `Request#truncated_body` but did not make use of it.\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -4389,7 +4389,7 @@ a.status-card.compact:hover {\n }\n \n .relationship-tag {\n-  color: $primary-text-color;\n+  color: $white;\n   margin-bottom: 4px;\n   display: block;\n   background-color: rgba($black, 0.45);\n---\n\n\n---\n\nChoice B:\ndocker-compose.yml\n@@ -88,7 +88,7 @@ services:\n       - internal_network\n     healthcheck:\n       # prettier-ignore\n-      test: ['CMD-SHELL', \"curl -s --noproxy localhost localhost:4000/api/v1/streaming/health | grep -q 'OK' || exit 1'\"]\n+      test: ['CMD-SHELL', \"curl -s --noproxy localhost localhost:4000/api/v1/streaming/health | grep -q 'OK' || exit 1\"]\n     ports:\n       - '127.0.0.1:4000:4000'\n     depends_on:\n---\n\n\n---\n\nChoice C:\napp/services/verify_link_service.rb\n@@ -19,7 +19,7 @@ def call(field)\n \n   def perform_request!\n     @body = Request.new(:get, @url).add_headers('Accept' => 'text/html').perform do |res|\n-      res.code == 200 ? res.body_with_limit : nil\n+      res.code == 200 ? res.truncated_body : nil\n     end\n   end\n \n---\nspec/services/verify_link_service_spec.rb\n@@ -80,24 +80,25 @@\n         \"\n           <!doctype html>\n           <body>\n-            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\\\"\n+            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\\\">\n         \"\n       end\n \n-      it 'marks the field as not verified' do\n-        expect(field.verified?).to be false\n+      it 'marks the field as verified' do\n+        expect(field.verified?).to be true\n       end\n     end\n \n-    context 'when a link back might be truncated' do\n+    context 'when a link tag might be truncated' do\n       let(:html) do\n         \"\n           <!doctype html>\n           <body>\n-            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\"\n+            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\\\"\n+        \"\n       end\n \n-      it 'does not mark the field as verified' do\n+      it 'marks the field as not verified' do\n         expect(field.verified?).to be false\n       end\n     end\n---\napp/services/verify_link_service.rb\n@@ -19,7 +19,7 @@ def call(field)\n \n   def perform_request!\n     @body = Request.new(:get, @url).add_headers('Accept' => 'text/html').perform do |res|\n-      res.code == 200 ? res.body_with_limit : nil\n+      res.code == 200 ? res.truncated_body : nil\n     end\n   end\n \n---\nspec/services/verify_link_service_spec.rb\n@@ -78,24 +78,25 @@\n         \"\n           <!doctype html>\n           <body>\n-            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\\\"\n+            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\\\">\n         \"\n       end\n \n-      it 'marks the field as not verified' do\n-        expect(field.verified?).to be false\n+      it 'marks the field as verified' do\n+        expect(field.verified?).to be true\n       end\n     end\n \n-    context 'when a link back might be truncated' do\n+    context 'when a link tag might be truncated' do\n       let(:html) do\n         \"\n           <!doctype html>\n           <body>\n-            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\"\n+            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\\\"\n+        \"\n       end\n \n-      it 'does not mark the field as verified' do\n+      it 'marks the field as not verified' do\n         expect(field.verified?).to be false\n       end\n     end\n---\nspec/services/verify_link_service_spec.rb\n@@ -77,11 +77,11 @@\n \n     context 'when a document is truncated but the link back is valid' do\n       let(:html) do\n-        \"\n+        <<-HTML\n           <!doctype html>\n           <body>\n-            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\\\">\n-        \"\n+            <a rel=\"me\" href=\"#{ActivityPub::TagManager.instance.url_for(account)}\">\n+        HTML\n       end\n \n       it 'marks the field as verified' do\n@@ -91,11 +91,11 @@\n \n     context 'when a link tag might be truncated' do\n       let(:html) do\n-        \"\n+        <<-HTML_TRUNCATED\n           <!doctype html>\n           <body>\n-            <a rel=\\\"me\\\" href=\\\"#{ActivityPub::TagManager.instance.url_for(account)}\\\"\n-        \"\n+            <a rel=\"me\" href=\"#{ActivityPub::TagManager.instance.url_for(account)}\"\n+        HTML_TRUNCATED\n       end\n \n       it 'marks the field as not verified' do\n@@ -166,7 +166,11 @@\n       #\n       # apparently github allows the user to enter website URLs with a single\n       # slash and makes no attempts to correct that.\n-      let(:html) { '<a href=\"http:/unrelated.example\">Hello</a>' }\n+      let(:html) do\n+        <<-HTML\n+          <a href=\"http:/unrelated.example\">Hello</a>\n+        HTML\n+      end\n \n       it 'does not crash' do\n         # We could probably put more effort into perhaps auto-correcting the\n---\nCHANGELOG.md\n@@ -2,6 +2,26 @@\n \n All notable changes to this project will be documented in this file.\n \n+## [4.2.8] - 2024-02-23\n+\n+### Added\n+\n+- Add hourly task to automatically require approval for new registrations in the absence of moderators ([ClearlyClaire](https://github.com/mastodon/mastodon/pull/29318), [ClearlyClaire](https://github.com/mastodon/mastodon/pull/29355))\n+  In order to prevent future abandoned Mastodon servers from being used for spam, harassment and other malicious activity, Mastodon will now automatically switch new user registrations to require moderator approval whenever they are left open and no activity (including non-moderation actions from apps) from any logged-in user with permission to access moderation reports has been detected in a full week.\n+  When this happens, users with the permission to change server settings will receive an email notification.\n+  This feature is disabled when `EMAIL_DOMAIN_ALLOWLIST` is used, and can also be disabled with `DISABLE_AUTOMATIC_SWITCHING_TO_APPROVED_REGISTRATIONS=true`.\n+\n+### Changed\n+\n+- Change registrations to be closed by default on new installations ([ClearlyClaire](https://github.com/mastodon/mastodon/pull/29280))\n+  If you are running a server and never changed your registrations mode from the default, updating will automatically close your registrations.\n+  Simply re-enable them through the administration interface or using `tootctl settings registrations open` if you want to enable them again.\n+\n+### Fixed\n+\n+- Fix processing of remote ActivityPub actors making use of `Link` objects as `Image` `url` ([ClearlyClaire](https://github.com/mastodon/mastodon/pull/29335))\n+- Fix link verifications when page size exceeds 1MB ([ClearlyClaire](https://github.com/mastodon/mastodon/pull/29358))\n+\n ## [4.2.7] - 2024-02-16\n \n ### Fixed\n---\ndocker-compose.yml\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bash -c \"rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000\"\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\nlib/mastodon/version.rb\n@@ -13,7 +13,7 @@ def minor\n     end\n \n     def patch\n-      7\n+      8\n     end\n \n     def default_prerelease\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/components/admin/Retention.jsx\n@@ -9,11 +9,12 @@ import api from 'mastodon/api';\n import { roundTo10 } from 'mastodon/utils/numbers';\n \n const dateForCohort = cohort => {\n+  const timeZone = 'UTC';\n   switch(cohort.frequency) {\n   case 'day':\n-    return <FormattedDate value={cohort.period} month='long' day='2-digit' />;\n+    return <FormattedDate value={cohort.period} month='long' day='2-digit' timeZone={timeZone} />;\n   default:\n-    return <FormattedDate value={cohort.period} month='long' year='numeric' />;\n+    return <FormattedDate value={cohort.period} month='long' year='numeric' timeZone={timeZone} />;\n   }\n };\n \n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nI think the new friends-of-friends query should be roughly equivalent, but I have not evaluated it.\r\n\r\nThe two-pass query for similar profiles means if there is anything to filter, the suggestion provider will always return less results than the limit allows.\n\n---\n\nChoice A:\napp/views/user_mailer/confirmation_instructions.html.haml\n@@ -8,9 +8,7 @@\n           %td.email-inner-card-td.email-prose\n             %p= t @resource.approved? ? 'devise.mailer.confirmation_instructions.explanation' : 'devise.mailer.confirmation_instructions.explanation_when_pending', host: site_hostname\n             - if @resource.created_by_application\n-              = render 'application/mailer/button', text: t('settings.account_settings'), url: edit_user_registration_url\n-              = link_to confirmation_url(@resource, confirmation_token: @token, redirect_to_app: 'true') do\n-                %span= t 'devise.mailer.confirmation_instructions.action_with_app', app: @resource.created_by_application.name\n+              = render 'application/mailer/button', text: t('devise.mailer.confirmation_instructions.action_with_app', app: @resource.created_by_application.name), url: confirmation_url(@resource, confirmation_token: @token, redirect_to_app: 'true')\n             - else\n               = render 'application/mailer/button', text: t('devise.mailer.confirmation_instructions.action'), url: confirmation_url(@resource, confirmation_token: @token)\n             %p= t 'devise.mailer.confirmation_instructions.extra_html', terms_path: about_more_url, policy_path: privacy_policy_url\n---\n\n\n---\n\nChoice B:\napp/models/account_suggestions/friends_of_friends_source.rb\n@@ -2,15 +2,19 @@\n \n class AccountSuggestions::FriendsOfFriendsSource < AccountSuggestions::Source\n   def get(account, limit: DEFAULT_LIMIT)\n+    source_query(account, limit: limit)\n+      .map { |id, _frequency, _followers_count| [id, key] }\n+  end\n+\n+  def source_query(account, limit: DEFAULT_LIMIT)\n     first_degree = account.following.where.not(hide_collections: true).select(:id).reorder(nil)\n     base_account_scope(account)\n       .joins(:account_stat)\n-      .where(id: Follow.where(account_id: first_degree).select(:target_account_id))\n+      .joins(:passive_relationships).where(passive_relationships: { account_id: first_degree })\n       .group('accounts.id, account_stats.id')\n-      .reorder('frequency DESC, followers_count DESC')\n+      .reorder(frequency: :desc, followers_count: :desc)\n       .limit(limit)\n-      .pluck(Arel.sql('accounts.id, COUNT(*) AS frequency'))\n-      .map { |id, _frequency| [id, key] }\n+      .pluck(Arel.sql('accounts.id, COUNT(*) AS frequency, followers_count'))\n   end\n \n   private\n---\nspec/models/account_suggestions/friends_of_friends_source_spec.rb\n@@ -11,9 +11,9 @@\n     let!(:eve) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:mallory) { Fabricate(:account, discoverable: false, hide_collections: false) }\n     let!(:eugen) { Fabricate(:account, discoverable: true, hide_collections: false) }\n+    let!(:neil) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:john) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:jerk) { Fabricate(:account, discoverable: true, hide_collections: false) }\n-    let!(:neil) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:larry) { Fabricate(:account, discoverable: true, hide_collections: false) }\n \n     context 'with follows and blocks' do\n@@ -70,13 +70,31 @@\n       end\n \n       it 'returns eligible accounts in the expected order' do\n-        expect(subject.get(bob)).to eq [\n-          [eugen.id, :friends_of_friends], # followed by 2 friends, 3 followers total\n-          [john.id, :friends_of_friends], # followed by 2 friends, 2 followers total\n-          [neil.id, :friends_of_friends], # followed by 1 friend, 2 followers total\n-          [jerk.id, :friends_of_friends], # followed by 1 friend, 1 follower total\n+        expect(subject.get(bob)).to eq expected_results\n+      end\n+\n+      it 'contains correct underlying source data' do\n+        expect(source_query_values)\n+          .to contain_exactly(\n+            [eugen.id, 2, 3], # Followed by 2 friends of bob (eve, mallory), 3 followers total (breaks tie)\n+            [john.id, 2, 2],  # Followed by 2 friends of bob (eve, mallory), 2 followers total\n+            [neil.id, 1, 2],  # Followed by 1 friends of bob (mallory), 2 followers total (breaks tie)\n+            [jerk.id, 1, 1]   # Followed by 1 friends of bob (eve), 1 followers total\n+          )\n+      end\n+\n+      def expected_results\n+        [\n+          [eugen.id, :friends_of_friends],\n+          [john.id, :friends_of_friends],\n+          [neil.id, :friends_of_friends],\n+          [jerk.id, :friends_of_friends],\n         ]\n       end\n+\n+      def source_query_values\n+        subject.source_query(bob).to_a\n+      end\n     end\n   end\n end\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/components/status.jsx\n@@ -546,7 +546,7 @@ class Status extends ImmutablePureComponent {\n     const visibilityIcon = visibilityIconInfo[status.get('visibility')];\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n-    const expanded = !status.get('hidden')\n+    const expanded = !status.get('hidden') || status.get('spoiler_text').length === 0;\n \n     return (\n       <HotKeys handlers={handlers}>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -293,7 +293,7 @@ class DetailedStatus extends ImmutablePureComponent {\n     }\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n-    const expanded = !status.get('hidden')\n+    const expanded = !status.get('hidden') || status.get('spoiler_text').length === 0;\n \n     return (\n       <div style={outerStyle}>\n---\n\n\n---\n\nChoice D:\napp/services/post_status_service.rb\n@@ -134,7 +134,7 @@ def validate_media!\n \n     @media = @account.media_attachments.where(status_id: nil).where(id: @options[:media_ids].take(Status::MEDIA_ATTACHMENTS_LIMIT).map(&:to_i))\n \n-    not_found_ids = @options[:media_ids] - @media.map(&:id)\n+    not_found_ids = @options[:media_ids].map(&:to_i) - @media.map(&:id)\n     raise Mastodon::ValidationError, I18n.t('media_attachments.validations.not_found', ids: not_found_ids.join(', ')) if not_found_ids.any?\n \n     raise Mastodon::ValidationError, I18n.t('media_attachments.validations.images_and_video') if @media.size > 1 && @media.find(&:audio_or_video?)\n---\napp/services/update_status_service.rb\n@@ -73,7 +73,7 @@ def validate_media!\n \n     media_attachments = @status.account.media_attachments.where(status_id: [nil, @status.id]).where(scheduled_status_id: nil).where(id: @options[:media_ids].take(Status::MEDIA_ATTACHMENTS_LIMIT).map(&:to_i)).to_a\n \n-    not_found_ids = @options[:media_ids] - media_attachments.map(&:id)\n+    not_found_ids = @options[:media_ids].map(&:to_i) - media_attachments.map(&:id)\n     raise Mastodon::ValidationError, I18n.t('media_attachments.validations.not_found', ids: not_found_ids.join(', ')) if not_found_ids.any?\n \n     raise Mastodon::ValidationError, I18n.t('media_attachments.validations.images_and_video') if media_attachments.size > 1 && media_attachments.find(&:audio_or_video?)\n---\nspec/services/post_status_service_spec.rb\n@@ -34,15 +34,15 @@\n \n     it 'schedules a status for future creation and does not create one immediately' do\n       media = Fabricate(:media_attachment, account: account)\n-      status = subject.call(account, text: 'Hi future!', media_ids: [media.id], scheduled_at: future)\n+      status = subject.call(account, text: 'Hi future!', media_ids: [media.id.to_s], scheduled_at: future)\n \n       expect(status)\n         .to be_a(ScheduledStatus)\n         .and have_attributes(\n           scheduled_at: eq(future),\n           params: include(\n             'text' => eq('Hi future!'),\n-            'media_ids' => contain_exactly(media.id)\n+            'media_ids' => contain_exactly(media.id.to_s)\n           )\n         )\n       expect(media.reload.status).to be_nil\n@@ -219,7 +219,7 @@\n     status = subject.call(\n       account,\n       text: 'test status update',\n-      media_ids: [media.id]\n+      media_ids: [media.id.to_s]\n     )\n \n     expect(media.reload.status).to eq status\n@@ -233,7 +233,7 @@\n       subject.call(\n         account,\n         text: 'test status update',\n-        media_ids: [media.id]\n+        media_ids: [media.id.to_s]\n       )\n     end.to raise_error(\n       Mastodon::ValidationError,\n@@ -249,7 +249,7 @@\n       subject.call(\n         account,\n         text: 'test status update',\n-        media_ids: Array.new(2) { Fabricate(:media_attachment, account: account) }.map(&:id)\n+        media_ids: Array.new(2) { Fabricate(:media_attachment, account: account) }.map { |m| m.id.to_s }\n       )\n     end.to raise_error(\n       Mastodon::ValidationError,\n@@ -271,7 +271,7 @@\n         media_ids: [\n           video,\n           image,\n-        ].map(&:id)\n+        ].map { |m| m.id.to_s }\n       )\n     end.to raise_error(\n       Mastodon::ValidationError,\n---\nspec/services/update_status_service_spec.rb\n@@ -69,7 +69,7 @@\n \n     before do\n       status.media_attachments << detached_media_attachment\n-      subject.call(status, status.account_id, text: 'Foo', media_ids: [attached_media_attachment.id])\n+      subject.call(status, status.account_id, text: 'Foo', media_ids: [attached_media_attachment.id.to_s])\n     end\n \n     it 'updates media attachments' do\n@@ -95,7 +95,7 @@\n \n     before do\n       status.media_attachments << media_attachment\n-      subject.call(status, status.account_id, text: 'Foo', media_ids: [media_attachment.id], media_attributes: [{ id: media_attachment.id, description: 'New description' }])\n+      subject.call(status, status.account_id, text: 'Foo', media_ids: [media_attachment.id.to_s], media_attributes: [{ id: media_attachment.id, description: 'New description' }])\n     end\n \n     it 'does not detach media attachment' do\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Go to `/admin/instances?limited=1` to manage federation\r\n2. Add a domain block for `example` (noop/none severity)\r\n3. Using the API try to create a domain block for `test.example` observe that an error is returned\r\n4. Go back to the admin UI and create a domain block for `test.example` observe that no error is returned and the block is successfully created.\r\n\n\n### Expected behaviour\n\nBoth methods for creating domain blocks should have same behaviour\n\n### Actual behaviour\n\nThe API failed whilst the Admin UI succeeded\n\n### Detailed description\n\nThis bug affects IFTAS FediCheck, where we weren't observing the same logic as `DomainBlock.rule_for` when attempting to create a domain block, which meant an existing block of `example` would fail the block creation of `test.example` leaving us out of sync with the Mastodon server (we also weren't handling the error response from the API correctly.\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\nmain\n\n### Technical details\n\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: v 3.2.3\r\n- Node.js version: v20.11.0\r\n\n\n---\n\nChoice A:\napp/controllers/api/v1/admin/domain_blocks_controller.rb\n@@ -29,10 +29,11 @@ def show\n   def create\n     authorize :domain_block, :create?\n \n+    @domain_block = DomainBlock.new(resource_params)\n     existing_domain_block = resource_params[:domain].present? ? DomainBlock.rule_for(resource_params[:domain]) : nil\n-    return render json: existing_domain_block, serializer: REST::Admin::ExistingDomainBlockErrorSerializer, status: 422 if existing_domain_block.present?\n+    return render json: existing_domain_block, serializer: REST::Admin::ExistingDomainBlockErrorSerializer, status: 422 if conflicts_with_existing_block?(@domain_block, existing_domain_block)\n \n-    @domain_block = DomainBlock.create!(resource_params)\n+    @domain_block.save!\n     DomainBlockWorker.perform_async(@domain_block.id)\n     log_action :create, @domain_block\n     render json: @domain_block, serializer: REST::Admin::DomainBlockSerializer\n@@ -55,6 +56,10 @@ def destroy\n \n   private\n \n+  def conflicts_with_existing_block?(domain_block, existing_domain_block)\n+    existing_domain_block.present? && (existing_domain_block.domain == TagManager.instance.normalize_domain(domain_block.domain) || !domain_block.stricter_than?(existing_domain_block))\n+  end\n+\n   def set_domain_blocks\n     @domain_blocks = filtered_domain_blocks.order(id: :desc).to_a_paginated_by_id(limit_param(LIMIT), params_slice(:max_id, :since_id, :min_id))\n   end\n---\nspec/requests/api/v1/admin/domain_blocks_spec.rb\n@@ -130,7 +130,7 @@\n     it_behaves_like 'forbidden for wrong role', ''\n     it_behaves_like 'forbidden for wrong role', 'Moderator'\n \n-    it 'returns expected domain name and severity', :aggregate_failures do\n+    it 'creates a domain block with the expected domain name and severity', :aggregate_failures do\n       subject\n \n       body = body_as_json\n@@ -146,7 +146,44 @@\n       expect(DomainBlock.find_by(domain: 'foo.bar.com')).to be_present\n     end\n \n-    context 'when a stricter domain block already exists' do\n+    context 'when a looser domain block already exists on a higher level domain' do\n+      let(:params) { { domain: 'foo.bar.com', severity: :suspend } }\n+\n+      before do\n+        Fabricate(:domain_block, domain: 'bar.com', severity: :silence)\n+      end\n+\n+      it 'creates a domain block with the expected domain name and severity', :aggregate_failures do\n+        subject\n+\n+        body = body_as_json\n+\n+        expect(response).to have_http_status(200)\n+        expect(body).to match a_hash_including(\n+          {\n+            domain: 'foo.bar.com',\n+            severity: 'suspend',\n+          }\n+        )\n+\n+        expect(DomainBlock.find_by(domain: 'foo.bar.com')).to be_present\n+      end\n+    end\n+\n+    context 'when a domain block already exists on the same domain' do\n+      before do\n+        Fabricate(:domain_block, domain: 'foo.bar.com', severity: :silence)\n+      end\n+\n+      it 'returns existing domain block in error', :aggregate_failures do\n+        subject\n+\n+        expect(response).to have_http_status(422)\n+        expect(body_as_json[:existing_domain_block][:domain]).to eq('foo.bar.com')\n+      end\n+    end\n+\n+    context 'when a stricter domain block already exists on a higher level domain' do\n       before do\n         Fabricate(:domain_block, domain: 'bar.com', severity: :suspend)\n       end\n---\n\n\n---\n\nChoice B:\napp/models/status.rb\n@@ -162,7 +162,7 @@ class Status < ApplicationRecord\n   REAL_TIME_WINDOW = 6.hours\n \n   def cache_key\n-    \"v2:#{super}\"\n+    \"v3:#{super}\"\n   end\n \n   def searchable_by(preloaded = nil)\n---\n\n\n---\n\nChoice C:\nDockerfile\n@@ -103,6 +103,7 @@ RUN \\\n     procps \\\n     tini \\\n     tzdata \\\n+    wget \\\n   ; \\\n # Patch Ruby to use jemalloc\n   patchelf --add-needed libjemalloc.so.2 /usr/local/bin/ruby; \\\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/actions/notifications_typed.ts\n@@ -18,6 +18,6 @@ export const notificationsUpdate = createAction(\n     playSound: boolean;\n   }) => ({\n     payload: args,\n-    meta: { playSound: playSound ? { sound: 'boop' } : undefined },\n+    meta: { sound: playSound ? 'boop' : undefined },\n   }),\n );\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. On `mastodon.social`, call [`/api/v2/suggestions`](https://docs.joinmastodon.org/methods/suggestions/#v2)\r\n2. Attempt to decode output as documented, as an array of [`Suggestion`](https://docs.joinmastodon.org/entities/Suggestion/) objects\r\n3. Decoding fails because object has changed from documented format\r\n\n\n### Expected behaviour\n\n`Suggestion.source` should be a string\n\n### Actual behaviour\n\n`Suggestion.source` is an array of strings\n\n### Detailed description\n\nI'm not sure when this changed, but it's not documented, or backwards compatible with existing clients. My suggestion for the fix would be to keep `source` as a string, populate it with the first or most important of the possible source strings, deprecate `source`, and return the full list of sources as a new `sources` property on `Suggestion`.\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.3.0-nightly.2024-02-02\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/actions/search.js\n@@ -147,6 +147,10 @@ export const openURL = (value, history, onFailure) => (dispatch, getState) => {\n   const signedIn = !!getState().getIn(['meta', 'me']);\n \n   if (!signedIn) {\n+    if (onFailure) {\n+      onFailure();\n+    }\n+\n     return;\n   }\n \n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/components/__tests__/hashtag_bar.tsx\n@@ -45,6 +45,21 @@ describe('computeHashtagBarForStatus', () => {\n     );\n   });\n \n+  it('does not truncate the contents when the last child is a text node', () => {\n+    const status = createStatus(\n+      'this is a #<a class=\"zrl\" href=\"https://example.com/search?tag=test\">test</a>. Some more text',\n+      ['test'],\n+    );\n+\n+    const { hashtagsInBar, statusContentProps } =\n+      computeHashtagBarForStatus(status);\n+\n+    expect(hashtagsInBar).toEqual([]);\n+    expect(statusContentProps.statusContent).toMatchInlineSnapshot(\n+      `\"this is a #<a class=\"zrl\" href=\"https://example.com/search?tag=test\">test</a>. Some more text\"`,\n+    );\n+  });\n+\n   it('extract tags from the last line', () => {\n     const status = createStatus(\n       '<p>Simple text</p><p><a href=\"test\">#hashtag</a></p>',\n---\napp/javascript/mastodon/components/hashtag_bar.tsx\n@@ -109,7 +109,7 @@ export function computeHashtagBarForStatus(status: StatusLike): {\n \n   const lastChild = template.content.lastChild;\n \n-  if (!lastChild) return defaultResult;\n+  if (!lastChild || lastChild.nodeType === Node.TEXT_NODE) return defaultResult;\n \n   template.content.removeChild(lastChild);\n   const contentWithoutLastLine = template;\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/home_timeline/components/inline_follow_suggestions.jsx\n@@ -59,7 +59,7 @@ Source.propTypes = {\n   id: PropTypes.oneOf(['friends_of_friends', 'similar_to_recently_followed', 'featured', 'most_followed', 'most_interactions']),\n };\n \n-const Card = ({ id, source }) => {\n+const Card = ({ id, sources }) => {\n   const intl = useIntl();\n   const account = useSelector(state => state.getIn(['accounts', id]));\n   const relationship = useSelector(state => state.getIn(['relationships', id]));\n@@ -89,7 +89,7 @@ const Card = ({ id, source }) => {\n \n       <div className='inline-follow-suggestions__body__scrollable__card__text-stack'>\n         <Link to={`/@${account.get('acct')}`}><DisplayName account={account} /></Link>\n-        {firstVerifiedField ? <VerifiedBadge link={firstVerifiedField.get('value')} /> : <Source id={source.get(0)} />}\n+        {firstVerifiedField ? <VerifiedBadge link={firstVerifiedField.get('value')} /> : <Source id={sources.get(0)} />}\n       </div>\n \n       <Button text={intl.formatMessage(following ? messages.unfollow : messages.follow)} onClick={handleFollow} />\n@@ -99,7 +99,7 @@ const Card = ({ id, source }) => {\n \n Card.propTypes = {\n   id: PropTypes.string.isRequired,\n-  source: ImmutablePropTypes.list,\n+  sources: ImmutablePropTypes.list,\n };\n \n const DISMISSIBLE_ID = 'home/follow-suggestions';\n@@ -175,7 +175,7 @@ export const InlineFollowSuggestions = ({ hidden }) => {\n             <Card\n               key={suggestion.get('account')}\n               id={suggestion.get('account')}\n-              source={suggestion.get('source')}\n+              sources={suggestion.get('sources')}\n             />\n           ))}\n         </div>\n---\napp/models/account_suggestions.rb\n@@ -31,12 +31,12 @@ def get(limit, offset = 0)\n       account_ids  = account_ids_with_sources[offset, limit]\n       accounts_map = Account.where(id: account_ids.map(&:first)).includes(:account_stat, :user).index_by(&:id)\n \n-      account_ids.filter_map do |(account_id, source)|\n+      account_ids.filter_map do |(account_id, sources)|\n         next unless accounts_map.key?(account_id)\n \n         AccountSuggestions::Suggestion.new(\n           account: accounts_map[account_id],\n-          source: source\n+          sources: sources\n         )\n       end\n     end\n---\napp/models/account_suggestions/suggestion.rb\n@@ -1,7 +1,7 @@\n # frozen_string_literal: true\n \n class AccountSuggestions::Suggestion < ActiveModelSerializers::Model\n-  attributes :account, :source\n+  attributes :account, :sources\n \n   delegate :id, to: :account, prefix: true\n end\n---\napp/serializers/rest/suggestion_serializer.rb\n@@ -1,7 +1,20 @@\n # frozen_string_literal: true\n \n class REST::SuggestionSerializer < ActiveModel::Serializer\n-  attributes :source\n+  attributes :source, :sources\n \n   has_one :account, serializer: REST::AccountSerializer\n+\n+  LEGACY_SOURCE_TYPE_MAP = {\n+    featured: 'staff',\n+    most_followed: 'global',\n+    most_interactions: 'global',\n+    # NOTE: Those are not completely accurate, but those are personalized interactions\n+    similar_to_recently_followed: 'past_interactions',\n+    friends_of_friends: 'past_interactions',\n+  }.freeze\n+\n+  def source\n+    LEGACY_SOURCE_TYPE_MAP[object.sources.first]\n+  end\n end\n---\nspec/requests/api/v2/suggestions_spec.rb\n@@ -9,10 +9,28 @@\n   let(:headers) { { 'Authorization' => \"Bearer #{token.token}\" } }\n \n   describe 'GET /api/v2/suggestions' do\n-    it 'returns http success' do\n+    let(:bob) { Fabricate(:account) }\n+    let(:jeff) { Fabricate(:account) }\n+    let(:params) { {} }\n+\n+    before do\n+      Setting.bootstrap_timeline_accounts = [bob, jeff].map(&:acct).join(',')\n+    end\n+\n+    it 'returns the expected suggestions' do\n       get '/api/v2/suggestions', headers: headers\n \n       expect(response).to have_http_status(200)\n+\n+      expect(body_as_json).to match_array(\n+        [bob, jeff].map do |account|\n+          hash_including({\n+            source: 'staff',\n+            sources: ['featured'],\n+            account: hash_including({ id: account.id.to_s }),\n+          })\n+        end\n+      )\n     end\n   end\n end\n---\nspec/serializers/rest/suggestion_serializer_spec.rb\n@@ -7,7 +7,7 @@\n   let(:record) do\n     AccountSuggestions::Suggestion.new(\n       account: account,\n-      source: 'SuggestionSource'\n+      sources: ['SuggestionSource']\n     )\n   end\n   let(:account) { Fabricate(:account) }\n---\n\n\n---\n\nChoice D:\napp/controllers/api/v1/push/subscriptions_controller.rb\n@@ -1,26 +1,31 @@\n # frozen_string_literal: true\n \n class Api::V1::Push::SubscriptionsController < Api::BaseController\n+  include Redisable\n+  include Lockable\n+\n   before_action -> { doorkeeper_authorize! :push }\n   before_action :require_user!\n-  before_action :set_push_subscription\n+  before_action :set_push_subscription, only: [:show, :update]\n   before_action :check_push_subscription, only: [:show, :update]\n \n   def show\n     render json: @push_subscription, serializer: REST::WebPushSubscriptionSerializer\n   end\n \n   def create\n-    @push_subscription&.destroy!\n+    with_redis_lock(\"push_subscription:#{current_user.id}\") do\n+      destroy_web_push_subscriptions!\n \n-    @push_subscription = Web::PushSubscription.create!(\n-      endpoint: subscription_params[:endpoint],\n-      key_p256dh: subscription_params[:keys][:p256dh],\n-      key_auth: subscription_params[:keys][:auth],\n-      data: data_params,\n-      user_id: current_user.id,\n-      access_token_id: doorkeeper_token.id\n-    )\n+      @push_subscription = Web::PushSubscription.create!(\n+        endpoint: subscription_params[:endpoint],\n+        key_p256dh: subscription_params[:keys][:p256dh],\n+        key_auth: subscription_params[:keys][:auth],\n+        data: data_params,\n+        user_id: current_user.id,\n+        access_token_id: doorkeeper_token.id\n+      )\n+    end\n \n     render json: @push_subscription, serializer: REST::WebPushSubscriptionSerializer\n   end\n@@ -31,14 +36,18 @@ def update\n   end\n \n   def destroy\n-    @push_subscription&.destroy!\n+    destroy_web_push_subscriptions!\n     render_empty\n   end\n \n   private\n \n+  def destroy_web_push_subscriptions!\n+    doorkeeper_token.web_push_subscriptions.destroy_all\n+  end\n+\n   def set_push_subscription\n-    @push_subscription = Web::PushSubscription.find_by(access_token_id: doorkeeper_token.id)\n+    @push_subscription = doorkeeper_token.web_push_subscriptions.first\n   end\n \n   def check_push_subscription\n---\napp/lib/access_token_extension.rb\n@@ -6,6 +6,8 @@ module AccessTokenExtension\n   included do\n     include Redisable\n \n+    has_many :web_push_subscriptions, class_name: 'Web::PushSubscription', inverse_of: :access_token\n+\n     after_commit :push_to_streaming_api\n   end\n \n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. register a new email in the Android app (latest)\r\n2. wait for verification email\r\n3. notice how the email doesn't have a verification link, but has an \"Account Setting\" link instead, which will lead you to change your password rather than verify your email. \r\n...\r\n\n\n### Expected behaviour\n\nVerify email link\n\n### Actual behaviour\n\nAccount settings link \n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nAndroid app latest version\n\n### Mastodon version\n\nLatest\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/views/user_mailer/confirmation_instructions.html.haml\n@@ -8,9 +8,7 @@\n           %td.email-inner-card-td.email-prose\n             %p= t @resource.approved? ? 'devise.mailer.confirmation_instructions.explanation' : 'devise.mailer.confirmation_instructions.explanation_when_pending', host: site_hostname\n             - if @resource.created_by_application\n-              = render 'application/mailer/button', text: t('settings.account_settings'), url: edit_user_registration_url\n-              = link_to confirmation_url(@resource, confirmation_token: @token, redirect_to_app: 'true') do\n-                %span= t 'devise.mailer.confirmation_instructions.action_with_app', app: @resource.created_by_application.name\n+              = render 'application/mailer/button', text: t('devise.mailer.confirmation_instructions.action_with_app', app: @resource.created_by_application.name), url: confirmation_url(@resource, confirmation_token: @token, redirect_to_app: 'true')\n             - else\n               = render 'application/mailer/button', text: t('devise.mailer.confirmation_instructions.action'), url: confirmation_url(@resource, confirmation_token: @token)\n             %p= t 'devise.mailer.confirmation_instructions.extra_html', terms_path: about_more_url, policy_path: privacy_policy_url\n---\n\n\n---\n\nChoice B:\napp/lib/link_details_extractor.rb\n@@ -36,7 +36,8 @@ def description\n     end\n \n     def language\n-      json['inLanguage']\n+      lang = json['inLanguage']\n+      lang.is_a?(Hash) ? (lang['alternateName'] || lang['name']) : lang\n     end\n \n     def type\n---\nspec/lib/link_details_extractor_spec.rb\n@@ -82,6 +82,10 @@\n           'name' => 'Pet News',\n           'url' => 'https://example.com',\n         },\n+        'inLanguage' => {\n+          name: 'English',\n+          alternateName: 'en',\n+        },\n       }.to_json\n     end\n \n@@ -115,6 +119,12 @@\n           expect(subject.provider_name).to eq 'Pet News'\n         end\n       end\n+\n+      describe '#language' do\n+        it 'returns the language from structured data' do\n+          expect(subject.language).to eq 'en'\n+        end\n+      end\n     end\n \n     context 'when is wrapped in CDATA tags' do\n---\n\n\n---\n\nChoice C:\napp/workers/import/row_worker.rb\n@@ -8,7 +8,7 @@ class Import::RowWorker\n   sidekiq_retries_exhausted do |msg, _exception|\n     ActiveRecord::Base.connection_pool.with_connection do\n       # Increment the total number of processed items, and bump the state of the import if needed\n-      bulk_import_id = BulkImportRow.where(id: msg['args'][0]).pick(:id)\n+      bulk_import_id = BulkImportRow.where(id: msg['args'][0]).pick(:bulk_import_id)\n       BulkImport.progress!(bulk_import_id) unless bulk_import_id.nil?\n     end\n   end\n---\n\n\n---\n\nChoice D:\napp/controllers/api/v1/notifications/requests_controller.rb\n@@ -52,7 +52,7 @@ def dismiss_bulk\n   private\n \n   def load_requests\n-    requests = NotificationRequest.where(account: current_account).includes(:last_status, from_account: [:account_stat, :user]).to_a_paginated_by_id(\n+    requests = NotificationRequest.where(account: current_account).without_suspended.includes(:last_status, from_account: [:account_stat, :user]).to_a_paginated_by_id(\n       limit_param(DEFAULT_ACCOUNTS_LIMIT),\n       params_slice(:max_id, :since_id, :min_id)\n     )\n---\napp/models/notification_policy.rb\n@@ -62,6 +62,6 @@ def filter_private_mentions=(value)\n   private\n \n   def pending_notification_requests\n-    @pending_notification_requests ||= notification_requests.limit(MAX_MEANINGFUL_COUNT).pick(Arel.sql('count(*), coalesce(sum(notifications_count), 0)::bigint'))\n+    @pending_notification_requests ||= notification_requests.without_suspended.limit(MAX_MEANINGFUL_COUNT).pick(Arel.sql('count(*), coalesce(sum(notifications_count), 0)::bigint'))\n   end\n end\n---\napp/models/notification_request.rb\n@@ -26,6 +26,8 @@ class NotificationRequest < ApplicationRecord\n \n   before_save :prepare_notifications_count\n \n+  scope :without_suspended, -> { joins(:from_account).merge(Account.without_suspended) }\n+\n   def self.preload_cache_collection(requests)\n     cached_statuses_by_id = yield(requests.filter_map(&:last_status)).index_by(&:id) # Call cache_collection in block\n \n---\nspec/models/notification_policy_spec.rb\n@@ -7,19 +7,25 @@\n     subject { Fabricate(:notification_policy) }\n \n     let(:sender) { Fabricate(:account) }\n+    let(:suspended_sender) { Fabricate(:account) }\n \n     before do\n       Fabricate.times(2, :notification, account: subject.account, activity: Fabricate(:status, account: sender), filtered: true, type: :mention)\n       Fabricate(:notification_request, account: subject.account, from_account: sender)\n-      subject.summarize!\n-    end\n \n-    it 'sets pending_requests_count' do\n-      expect(subject.pending_requests_count).to eq 1\n+      Fabricate(:notification, account: subject.account, activity: Fabricate(:status, account: suspended_sender), filtered: true, type: :mention)\n+      Fabricate(:notification_request, account: subject.account, from_account: suspended_sender)\n+\n+      suspended_sender.suspend!\n+\n+      subject.summarize!\n     end\n \n-    it 'sets pending_notifications_count' do\n-      expect(subject.pending_notifications_count).to eq 2\n+    it 'sets pending_requests_count and pending_notifications_count' do\n+      expect(subject).to have_attributes(\n+        pending_requests_count: 1,\n+        pending_notifications_count: 2\n+      )\n     end\n   end\n end\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\nI am using mastodon.social with the new (beta?) compose UI. Now below the status I am typing there is a box with a little \u6587A icon and the word \"English\", indicating my post language. (There are several things I don't like about the new compose UI, but I do like this one change because it makes it harder to post with the wrong language metadata set.)\r\n\r\nBut! Consider this one post (or in general, any post by the user @suricrasia@lethargic.talkative.fish), which breaks the \"English\" box:\r\n\r\nhttps://lethargic.talkative.fish/@suricrasia/statuses/01HN1NGM7F2N63PJYE5W2YTPY9\r\n\r\nTo reproduce, bring up this post (for example by entering it into the Mastodon search box) and hit reply.\r\n\r\n### Expected behaviour\r\n\r\nWhen replying to a post, Mastodon's current behavior is to copy the original poster's language field into your own. Suricrasia is speaking English. Therefore, I assume replying to Suricrasia, my language will be set to English. For example:\r\n\r\n![image](https://github.com/mastodon/mastodon/assets/277318/da37504a-c835-4761-8cff-29ede6fa7608) \r\n![image](https://github.com/mastodon/mastodon/assets/277318/17a5f64c-fa16-4ba1-b3fb-28f001bcd406)\r\n\r\n### Actual behaviour\r\n\r\nThe language is set to the letters \"EN\".\r\n\r\n![image](https://github.com/mastodon/mastodon/assets/277318/04ebee4d-5716-41e4-bccb-a3eceff358f4)\r\n\r\nI don't actually know what happens to my status language code if I send this reply.\r\n\r\n### Detailed description\r\n\r\nI suspect this may be a variant of issue #19302, that mastodon.social in general chokes on language codes with dialects such as en-US (I think in the past I remember noticing this same user posting with en-US language). ~~If my guess is correct, this means #19302 has got worse because rather than \"en-US\" being relayed verbatim, which may be confusing to some users, it has been changed to \"EN\" which both will confuse some users and also is (if my guess is right) incorrect.~~ EDIT: Not quite\r\n\r\n### Mastodon instance\r\n\r\nmastodon.social\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-alpha.0+pr-28119-b84fe92\r\n\r\nlethargic.talkative.fish, the source of the problematic status, says it is running GoToSocial v0.12.0 git-5fd2e42\r\n\r\n### Browser name and version\r\n\r\nChrome 120.0.6099.227 (Official Build) (64-bit) \r\nI am running with uBlock. I usually run with Stylus but for these tests/screenshots I have disabled it and reloaded the page.\r\n\r\n### Operating system\r\n\r\nWindows 10\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/explore/results.jsx\n@@ -156,45 +156,43 @@ class Results extends PureComponent {\n \n     let filteredResults;\n \n-    if (!isLoading) {\n-      const accounts = results.get('accounts', ImmutableList());\n-      const hashtags = results.get('hashtags', ImmutableList());\n-      const statuses = results.get('statuses', ImmutableList());\n-\n-      switch(type) {\n-      case 'all':\n-        filteredResults = (accounts.size + hashtags.size + statuses.size) > 0 ? (\n-          <>\n-            {accounts.size > 0 && (\n-              <SearchSection key='accounts' title={<><Icon id='users' fixedWidth /><FormattedMessage id='search_results.accounts' defaultMessage='Profiles' /></>} onClickMore={this.handleLoadMoreAccounts}>\n-                {accounts.take(INITIAL_DISPLAY).map(id => <Account key={id} id={id} />)}\n-              </SearchSection>\n-            )}\n-\n-            {hashtags.size > 0 && (\n-              <SearchSection key='hashtags' title={<><Icon id='hashtag' fixedWidth /><FormattedMessage id='search_results.hashtags' defaultMessage='Hashtags' /></>} onClickMore={this.handleLoadMoreHashtags}>\n-                {hashtags.take(INITIAL_DISPLAY).map(hashtag => <Hashtag key={hashtag.get('name')} hashtag={hashtag} />)}\n-              </SearchSection>\n-            )}\n-\n-            {statuses.size > 0 && (\n-              <SearchSection key='statuses' title={<><Icon id='quote-right' fixedWidth /><FormattedMessage id='search_results.statuses' defaultMessage='Posts' /></>} onClickMore={this.handleLoadMoreStatuses}>\n-                {statuses.take(INITIAL_DISPLAY).map(id => <Status key={id} id={id} />)}\n-              </SearchSection>\n-            )}\n-          </>\n-        ) : [];\n-        break;\n-      case 'accounts':\n-        filteredResults = renderAccounts(accounts);\n-        break;\n-      case 'hashtags':\n-        filteredResults = renderHashtags(hashtags);\n-        break;\n-      case 'statuses':\n-        filteredResults = renderStatuses(statuses);\n-        break;\n-      }\n+    const accounts = results.get('accounts', ImmutableList());\n+    const hashtags = results.get('hashtags', ImmutableList());\n+    const statuses = results.get('statuses', ImmutableList());\n+\n+    switch(type) {\n+    case 'all':\n+      filteredResults = (accounts.size + hashtags.size + statuses.size) > 0 ? (\n+        <>\n+          {accounts.size > 0 && (\n+            <SearchSection key='accounts' title={<><Icon id='users' fixedWidth /><FormattedMessage id='search_results.accounts' defaultMessage='Profiles' /></>} onClickMore={this.handleLoadMoreAccounts}>\n+              {accounts.take(INITIAL_DISPLAY).map(id => <Account key={id} id={id} />)}\n+            </SearchSection>\n+          )}\n+\n+          {hashtags.size > 0 && (\n+            <SearchSection key='hashtags' title={<><Icon id='hashtag' fixedWidth /><FormattedMessage id='search_results.hashtags' defaultMessage='Hashtags' /></>} onClickMore={this.handleLoadMoreHashtags}>\n+              {hashtags.take(INITIAL_DISPLAY).map(hashtag => <Hashtag key={hashtag.get('name')} hashtag={hashtag} />)}\n+            </SearchSection>\n+          )}\n+\n+          {statuses.size > 0 && (\n+            <SearchSection key='statuses' title={<><Icon id='quote-right' fixedWidth /><FormattedMessage id='search_results.statuses' defaultMessage='Posts' /></>} onClickMore={this.handleLoadMoreStatuses}>\n+              {statuses.take(INITIAL_DISPLAY).map(id => <Status key={id} id={id} />)}\n+            </SearchSection>\n+          )}\n+        </>\n+      ) : [];\n+      break;\n+    case 'accounts':\n+      filteredResults = renderAccounts(accounts);\n+      break;\n+    case 'hashtags':\n+      filteredResults = renderHashtags(hashtags);\n+      break;\n+    case 'statuses':\n+      filteredResults = renderStatuses(statuses);\n+      break;\n     }\n \n     return (\n---\n\n\n---\n\nChoice B:\napp/models/account.rb\n@@ -144,6 +144,7 @@ class Account < ApplicationRecord\n   scope :dormant, -> { joins(:account_stat).merge(AccountStat.without_recent_activity) }\n   scope :with_username, ->(value) { where arel_table[:username].lower.eq(value.to_s.downcase) }\n   scope :with_domain, ->(value) { where arel_table[:domain].lower.eq(value&.to_s&.downcase) }\n+  scope :without_memorial, -> { where(memorial: false) }\n \n   after_update_commit :trigger_update_webhooks\n \n---\napp/models/account_suggestions/friends_of_friends_source.rb\n@@ -31,6 +31,7 @@ def source_query(account, limit: DEFAULT_LIMIT)\n         AND accounts.suspended_at IS NULL\n         AND accounts.silenced_at IS NULL\n         AND accounts.moved_to_account_id IS NULL\n+        AND accounts.memorial = FALSE\n         AND follow_recommendation_mutes.target_account_id IS NULL\n       GROUP BY accounts.id, account_stats.id\n       ORDER BY frequency DESC, account_stats.followers_count ASC\n---\napp/models/account_suggestions/source.rb\n@@ -14,6 +14,7 @@ def base_account_scope(account)\n       .searchable\n       .where(discoverable: true)\n       .without_silenced\n+      .without_memorial\n       .where.not(follows_sql, id: account.id)\n       .where.not(follow_requests_sql, id: account.id)\n       .not_excluded_by_account(account)\n---\nspec/models/account_suggestions/friends_of_friends_source_spec.rb\n@@ -15,6 +15,7 @@\n     let!(:john) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:jerk) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:larry) { Fabricate(:account, discoverable: true, hide_collections: false) }\n+    let!(:morty) { Fabricate(:account, discoverable: true, hide_collections: false, memorial: true) }\n \n     context 'with follows and blocks' do\n       before do\n@@ -27,8 +28,8 @@\n         # alice follows eve and mallory\n         [john, mallory].each { |account| alice.follow!(account) }\n \n-        # eugen follows eve, john, jerk, larry and neil\n-        [eve, mallory, jerk, larry, neil].each { |account| eugen.follow!(account) }\n+        # eugen follows eve, john, jerk, larry, neil and morty\n+        [eve, mallory, jerk, larry, neil, morty].each { |account| eugen.follow!(account) }\n       end\n \n       it 'returns eligible accounts', :aggregate_failures do\n@@ -51,6 +52,9 @@\n \n         # the suggestion for neil has already been rejected\n         expect(results).to_not include([neil.id, :friends_of_friends])\n+\n+        # morty is not included because his account is in memoriam\n+        expect(results).to_not include([morty.id, :friends_of_friends])\n       end\n     end\n \n---\nspec/models/account_suggestions/source_spec.rb\n@@ -21,6 +21,7 @@\n       let!(:moved_account) { Fabricate(:account, moved_to_account: Fabricate(:account), discoverable: true) }\n       let!(:silenced_account) { Fabricate(:account, silenced: true, discoverable: true) }\n       let!(:undiscoverable_account) { Fabricate(:account, discoverable: false) }\n+      let!(:memorial_account) { Fabricate(:account, memorial: true, discoverable: true) }\n \n       before do\n         Fabricate :account_domain_block, account: account, domain: account_domain_blocked_account.domain\n@@ -44,6 +45,7 @@\n           .and not_include(moved_account)\n           .and not_include(silenced_account)\n           .and not_include(undiscoverable_account)\n+          .and not_include(memorial_account)\n       end\n     end\n   end\n---\n\n\n---\n\nChoice C:\napp/presenters/language_presenter.rb\n@@ -1,7 +1,7 @@\n # frozen_string_literal: true\n \n class LanguagePresenter < ActiveModelSerializers::Model\n-  attributes :code, :name, :native_name\n+  attributes :code, :name\n \n   def initialize(code)\n     super()\n@@ -13,8 +13,4 @@ def initialize(code)\n   def name\n     @item[0]\n   end\n-\n-  def native_name\n-    @item[1]\n-  end\n end\n---\nspec/requests/api/v1/instances/languages_spec.rb\n@@ -9,10 +9,21 @@\n     end\n \n     it 'returns http success and includes supported languages' do\n-      expect(response).to have_http_status(200)\n+      expect(response)\n+        .to have_http_status(200)\n       expect(response.content_type)\n         .to start_with('application/json')\n-      expect(response.parsed_body.pluck(:code)).to match_array LanguagesHelper::SUPPORTED_LOCALES.keys.map(&:to_s)\n+      expect(response.parsed_body)\n+        .to match_array(supported_locale_expectations)\n+    end\n+\n+    def supported_locale_expectations\n+      LanguagesHelper::SUPPORTED_LOCALES.map do |key, values|\n+        include(\n+          code: key.to_s,\n+          name: values.first\n+        )\n+      end\n     end\n   end\n end\n---\n\n\n---\n\nChoice D:\napp/lib/activitypub/parser/status_parser.rb\n@@ -3,6 +3,8 @@\n class ActivityPub::Parser::StatusParser\n   include JsonLdHelper\n \n+  NORMALIZED_LOCALE_NAMES = LanguagesHelper::SUPPORTED_LOCALES.keys.index_by(&:downcase).freeze\n+\n   # @param [Hash] json\n   # @param [Hash] options\n   # @option options [String] :followers_collection\n@@ -87,6 +89,13 @@ def visibility\n   end\n \n   def language\n+    lang = raw_language_code\n+    lang.presence && NORMALIZED_LOCALE_NAMES.fetch(lang.downcase.to_sym, lang)\n+  end\n+\n+  private\n+\n+  def raw_language_code\n     if content_language_map?\n       @object['contentMap'].keys.first\n     elsif name_language_map?\n@@ -96,8 +105,6 @@ def language\n     end\n   end\n \n-  private\n-\n   def audience_to\n     as_array(@object['to'] || @json['to']).map { |x| value_or_id(x) }\n   end\n---\nspec/lib/activitypub/parser/status_parser_spec.rb\n@@ -0,0 +1,50 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+RSpec.describe ActivityPub::Parser::StatusParser do\n+  subject { described_class.new(json) }\n+\n+  let(:sender) { Fabricate(:account, followers_url: 'http://example.com/followers', domain: 'example.com', uri: 'https://example.com/actor') }\n+  let(:follower) { Fabricate(:account, username: 'bob') }\n+\n+  let(:json) do\n+    {\n+      '@context': 'https://www.w3.org/ns/activitystreams',\n+      id: [ActivityPub::TagManager.instance.uri_for(sender), '#foo'].join,\n+      type: 'Create',\n+      actor: ActivityPub::TagManager.instance.uri_for(sender),\n+      object: object_json,\n+    }.with_indifferent_access\n+  end\n+\n+  let(:object_json) do\n+    {\n+      id: [ActivityPub::TagManager.instance.uri_for(sender), 'post1'].join('/'),\n+      type: 'Note',\n+      to: [\n+        'https://www.w3.org/ns/activitystreams#Public',\n+        ActivityPub::TagManager.instance.uri_for(follower),\n+      ],\n+      content: '@bob lorem ipsum',\n+      contentMap: {\n+        EN: '@bob lorem ipsum',\n+      },\n+      published: 1.hour.ago.utc.iso8601,\n+      updated: 1.hour.ago.utc.iso8601,\n+      tag: {\n+        type: 'Mention',\n+        href: ActivityPub::TagManager.instance.uri_for(follower),\n+      },\n+    }\n+  end\n+\n+  it 'correctly parses status' do\n+    expect(subject).to have_attributes(\n+      text: '@bob lorem ipsum',\n+      uri: [ActivityPub::TagManager.instance.uri_for(sender), 'post1'].join('/'),\n+      reply: false,\n+      language: :en\n+    )\n+  end\n+end\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nTiny bug report: clicking on the emoji icon when the emoji picker is opened should close the picker (in the same way clicking again the poll or cw icon closes the poll or cw fields). Right now, clicking the emoji icon again seems to reopen the emoji picker which is already opened.\r\n\r\n_Originally posted by @nclm in https://github.com/mastodon/mastodon/issues/28119#issuecomment-1911588913_\r\n            \n\n---\n\nChoice A:\napp/services/fetch_link_card_service.rb\n@@ -29,7 +29,7 @@ def call(status)\n     end\n \n     attach_card if @card&.persisted?\n-  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError => e\n+  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError, Encoding::UndefinedConversionError => e\n     Rails.logger.debug { \"Error fetching link #{@original_url}: #{e}\" }\n     nil\n   end\n---\nspec/fixtures/requests/redirect_with_utf8_url.txt\n@@ -0,0 +1,5 @@\n+HTTP/1.1 301 Moved Permanently\n+server: nginx\n+date: Thu, 27 Jun 2024 11:04:53 GMT\n+content-type: text/html; charset=UTF-8\n+location: http://example.com/\u00e4rgerliche-umlaute.html\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -27,6 +27,7 @@\n     stub_request(:get, 'http://example.com/koi8-r').to_return(request_fixture('koi8-r.txt'))\n     stub_request(:get, 'http://example.com/windows-1251').to_return(request_fixture('windows-1251.txt'))\n     stub_request(:get, 'http://example.com/low_confidence_latin1').to_return(request_fixture('low_confidence_latin1.txt'))\n+    stub_request(:get, 'http://example.com/aergerliche-umlaute').to_return(request_fixture('redirect_with_utf8_url.txt'))\n \n     Rails.cache.write('oembed_endpoint:example.com', oembed_cache) if oembed_cache\n \n@@ -101,6 +102,14 @@\n       end\n     end\n \n+    context 'with a redirect URL with faulty encoding' do\n+      let(:status) { Fabricate(:status, text: 'http://example.com/aergerliche-umlaute') }\n+\n+      it 'does not create a preview card' do\n+        expect(status.preview_card).to be_nil\n+      end\n+    end\n+\n     context 'with a 404 URL' do\n       let(:status) { Fabricate(:status, text: 'http://example.com/not-found') }\n \n---\n\n\n---\n\nChoice B:\napp/helpers/languages_helper.rb\n@@ -194,7 +194,10 @@ module LanguagesHelper\n     jbo: ['Lojban', 'la .lojban.'].freeze,\n     kab: ['Kabyle', 'Taqbaylit'].freeze,\n     ldn: ['L\u00e1adan', 'L\u00e1adan'].freeze,\n+    ltg: ['Latgalian', 'latgal\u012b\u0161u'].freeze,\n     lfn: ['Lingua Franca Nova', 'lingua franca nova'].freeze,\n+    prg: ['Prussian', 'pr\u016bsiskai'].freeze,\n+    sgs: ['Samogitian', '\u017eemaitiu'].freeze,\n     sco: ['Scots', 'Scots'].freeze,\n     sma: ['Southern Sami', '\u00c5arjelsaemien G\u00efele'].freeze,\n     smj: ['Lule Sami', 'Julevs\u00e1megiella'].freeze,\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/compose/components/emoji_picker_dropdown.jsx\n@@ -164,6 +164,7 @@ class EmojiPickerMenuImpl extends PureComponent {\n     intl: PropTypes.object.isRequired,\n     skinTone: PropTypes.number.isRequired,\n     onSkinTone: PropTypes.func.isRequired,\n+    pickerButtonRef: PropTypes.func.isRequired\n   };\n \n   static defaultProps = {\n@@ -178,7 +179,7 @@ class EmojiPickerMenuImpl extends PureComponent {\n   };\n \n   handleDocumentClick = e => {\n-    if (this.node && !this.node.contains(e.target)) {\n+    if (this.node && !this.node.contains(e.target) && !this.props.pickerButtonRef.contains(e.target)) {\n       this.props.onClose();\n     }\n   };\n@@ -233,6 +234,7 @@ class EmojiPickerMenuImpl extends PureComponent {\n       emoji.native = emoji.colons;\n     }\n     if (!(event.ctrlKey || event.metaKey)) {\n+\n       this.props.onClose();\n     }\n     this.props.onPick(emoji);\n@@ -407,6 +409,7 @@ class EmojiPickerDropdown extends PureComponent {\n                   onSkinTone={onSkinTone}\n                   skinTone={skinTone}\n                   frequentlyUsedEmojis={frequentlyUsedEmojis}\n+                  pickerButtonRef={this.target}\n                 />\n               </div>\n             </div>\n---\n\n\n---\n\nChoice D:\napp/models/tag.rb\n@@ -35,7 +35,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?<![=/)[:word]])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)\\w])#(#{HASHTAG_NAME_PAT})}i\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/tag_spec.rb\n@@ -32,6 +32,10 @@\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)#Lawsuit')).to be_nil\n     end\n \n+    it 'does not match URLs with hashtag-like anchors after a numeral' do\n+      expect(subject.match('https://gcc.gnu.org/bugzilla/show_bug.cgi?id=111895#c4')).to be_nil\n+    end\n+\n     it 'does not match URLs with hashtag-like anchors after an empty query parameter' do\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)?foo=#Lawsuit')).to be_nil\n     end\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1.  Visit a toot in Samogitian https://mastodon.online/@zordsdavini@s.arns.lt/111816755464674968 (original URL: https://s.arns.lt/@zordsdavini/statuses/01HN0BY8GNF0AV87XGNE95WPAG)\r\n2. Click Reply\r\n3. Observe an error page\n\n### Expected behaviour\n\nReply UI should appear\n\n### Actual behaviour\n\nan error is shown\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nmastodon.online\n\n### Mastodon version\n\nv4.3.0-alpha.0+pr-28119-7cf1356\n\n### Browser name and version\n\nFirefox 121.0.1\n\n### Operating system\n\nLinux (Pop!_OS)\n\n### Technical details\n\nThe following stack trace is copied to clipboard:\r\n```\r\nTypeError: i is undefined\r\n\r\n\r\nrender@https://mastodon.online/packs/js/common-38d8b29eb2f4d33d6b6d.js:2:608016\r\nCs@https://mastodon.online/packs/js/common-38d8b29eb2f4d33d6b6d.js:2:1294139\r\nTs@https://mastodon.online/packs/js/common-38d8b29eb2f4d33d6b6d.js:2:1293937\r\nkl@https://mastodon.online/packs/js/common-38d8b29eb2f4d33d6b6d.js:2:1337281\r\n_c@https://mastodon.online/packs/js/common-38d8b29eb2f4d33d6b6d.js:2:1325486\r\nvc@https://mastodon.online/packs/js/common-38d8b29eb2f4d33d6b6d.js:2:1325414\r\nbc@https://mastodon.online/packs/js/common-38d8b29eb2f4d33d6b6d.js:2:1325275\r\nic@https://mastodon.online/packs/js/common-38d8b29eb2f4d33d6b6d.js:2:1322082\r\ncc@https://mastodon.online/packs/js/common-38d8b29eb2f4d33d6b6d.js:2:1322471\r\nza@https://mastodon.online/packs/js/common-38d8b29eb2f4d33d6b6d.js:2:1263318\r\nac/<@https://mastodon.online/packs/js/common-38d8b29eb2f4d33d6b6d.js:2:1320019\r\n\r\n\r\n\r\nrender (webpack:///app/javascript/mastodon/features/compose/components/language_dropdown.jsx:315:52)\r\nkj (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:204:188)\r\nij (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:203:148)\r\nnull,Zf(d)?(f=!0,cg (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:292:171)\r\nuj (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:280:391)\r\nuj (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:280:322)\r\nuj (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:280:179)\r\nOk (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:271:87)\r\nDk (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:273:299)\r\njg (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:127:104)\r\nEk (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:267:272)\r\n```\n\n---\n\nChoice A:\napp/helpers/languages_helper.rb\n@@ -194,7 +194,10 @@ module LanguagesHelper\n     jbo: ['Lojban', 'la .lojban.'].freeze,\n     kab: ['Kabyle', 'Taqbaylit'].freeze,\n     ldn: ['L\u00e1adan', 'L\u00e1adan'].freeze,\n+    ltg: ['Latgalian', 'latgal\u012b\u0161u'].freeze,\n     lfn: ['Lingua Franca Nova', 'lingua franca nova'].freeze,\n+    prg: ['Prussian', 'pr\u016bsiskai'].freeze,\n+    sgs: ['Samogitian', '\u017eemaitiu'].freeze,\n     sco: ['Scots', 'Scots'].freeze,\n     sma: ['Southern Sami', '\u00c5arjelsaemien G\u00efele'].freeze,\n     smj: ['Lule Sami', 'Julevs\u00e1megiella'].freeze,\n---\n\n\n---\n\nChoice B:\nCHANGELOG.md\n@@ -2,6 +2,29 @@\n \n All notable changes to this project will be documented in this file.\n \n+## [4.3.7] - 2025-04-02\n+\n+### Add\n+\n+- Add delay to profile updates to debounce them (#34137 by @ClearlyClaire)\n+- Add support for paginating partial collections in `SynchronizeFollowersService` (#34272 and #34277 by @ClearlyClaire)\n+\n+### Changed\n+\n+- Change account suspensions to be federated to recently-followed accounts as well (#34294 by @ClearlyClaire)\n+- Change `AccountReachFinder` to consider statuses based on suspension date (#32805 and #34291 by @ClearlyClaire and @mjankowski)\n+- Change user archive signed URL TTL from 10 seconds to 1 hour (#34254 by @ClearlyClaire)\n+\n+### Fixed\n+\n+- Fix static version of animated PNG emojis not being properly extracted (#34337 by @ClearlyClaire)\n+- Fix filters not applying in detailed view, favourites and bookmarks (#34259 and #34260 by @ClearlyClaire)\n+- Fix handling of malformed/unusual HTML (#34201 by @ClearlyClaire)\n+- Fix `CacheBuster` being queued for missing media attachments (#34253 by @ClearlyClaire)\n+- Fix incorrect URL being used when cache busting (#34189 by @ClearlyClaire)\n+- Fix streaming server refusing unix socket path in `DATABASE_URL` (#34091 by @ClearlyClaire)\n+- Fix \u201cx\u201d hotkey not working on boosted filtered posts (#33758 by @ClearlyClaire)\n+\n ## [4.3.6] - 2025-03-13\n \n ### Security\n---\ndocker-compose.yml\n@@ -59,7 +59,7 @@ services:\n   web:\n     # You can uncomment the following line if you want to not use the prebuilt image, for example if you have local code changes\n     # build: .\n-    image: ghcr.io/mastodon/mastodon:v4.3.6\n+    image: ghcr.io/mastodon/mastodon:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -83,7 +83,7 @@ services:\n     # build:\n     #   dockerfile: ./streaming/Dockerfile\n     #   context: .\n-    image: ghcr.io/mastodon/mastodon-streaming:v4.3.6\n+    image: ghcr.io/mastodon/mastodon-streaming:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: node ./streaming/index.js\n@@ -102,7 +102,7 @@ services:\n   sidekiq:\n     # You can uncomment the following line if you want to not use the prebuilt image, for example if you have local code changes\n     # build: .\n-    image: ghcr.io/mastodon/mastodon:v4.3.6\n+    image: ghcr.io/mastodon/mastodon:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\nlib/mastodon/version.rb\n@@ -13,7 +13,7 @@ def minor\n     end\n \n     def patch\n-      6\n+      7\n     end\n \n     def default_prerelease\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/notifications/components/column_settings.jsx\n@@ -45,14 +45,18 @@ class ColumnSettings extends PureComponent {\n \n     return (\n       <div className='column-settings'>\n-        {alertsEnabled && browserSupport && browserPermission === 'denied' && (\n-          <span className='warning-hint'><FormattedMessage id='notifications.permission_denied' defaultMessage='Desktop notifications are unavailable due to previously denied browser permissions request' /></span>\n-        )}\n-\n         <section>\n           <ClearColumnButton onClick={onClear} />\n         </section>\n \n+        {alertsEnabled && browserSupport && browserPermission === 'denied' && (\n+          <section>\n+            <span className='warning-hint'>\n+              <FormattedMessage id='notifications.permission_denied' defaultMessage='Desktop notifications are unavailable due to previously denied browser permissions request' />\n+            </span>\n+          </section>\n+        )}\n+\n         {alertsEnabled && browserSupport && browserPermission === 'default' && (\n           <section>\n             <span className='warning-hint'>\n---\n\n\n---\n\nChoice D:\nlib/mastodon/cli/search.rb\n@@ -100,6 +100,14 @@ def deploy\n       progress.finish\n \n       say(\"Indexed #{added} records, de-indexed #{removed}\", :green, true)\n+    rescue Elasticsearch::Transport::Transport::ServerError => e\n+      fail_with_message <<~ERROR\n+        There was an issue connecting to the search server. Make sure the\n+        server is configured and running correctly, and that the environment\n+        variable settings match what the server is expecting.\n+\n+        #{e.message}\n+      ERROR\n     end\n \n     private\n---\nspec/lib/mastodon/cli/search_spec.rb\n@@ -33,6 +33,17 @@\n       end\n     end\n \n+    context 'when server communication raises an error' do\n+      let(:options) { { reset_chewy: true } }\n+\n+      before { allow(Chewy::Stash::Specification).to receive(:reset!).and_raise(Elasticsearch::Transport::Transport::Errors::InternalServerError) }\n+\n+      it 'Exits with error message' do\n+        expect { subject }\n+          .to raise_error(Thor::Error, /issue connecting to the search/)\n+      end\n+    end\n+\n     context 'without options' do\n       before { stub_search_indexes }\n \n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. docker compose build\r\n2.  docker compose up -d\r\n3. [FATAL tini (7)] exec node failed: No such file or directory\r\n...\r\n\n\n### Expected behaviour\n\nStart the streaming backend\n\n### Actual behaviour\n\n[FATAL tini (7)] exec node failed: No such file or directory\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\ncommit 93957da\n\n### Technical details\n\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: (from `ruby --version`, eg. v3.1.2)\r\n- Node.js version: (from `node --version`, eg. v18.16.0)\r\n\n\n---\n\nChoice A:\napp/javascript/mastodon/features/ui/components/modal_root.jsx\n@@ -61,6 +61,8 @@ export default class ModalRoot extends PureComponent {\n     props: PropTypes.object,\n     onClose: PropTypes.func.isRequired,\n     ignoreFocus: PropTypes.bool,\n+    beforeOpen: PropTypes.func,\n+    afterClose: PropTypes.func,\n   };\n \n   state = {\n@@ -81,6 +83,10 @@ export default class ModalRoot extends PureComponent {\n     }\n   }\n \n+  componentDidMount() {\n+    this.props.beforeOpen();\n+  }\n+\n   setBackgroundColor = color => {\n     this.setState({ backgroundColor: color });\n   };\n@@ -96,9 +102,10 @@ export default class ModalRoot extends PureComponent {\n   };\n \n   handleClose = (ignoreFocus = false) => {\n-    const { onClose } = this.props;\n+    const { onClose, afterClose } = this.props;\n     const message = this._modal?.getCloseConfirmationMessage?.();\n     onClose(message, ignoreFocus);\n+    afterClose();\n   };\n \n   setModalRef = (c) => {\n---\napp/javascript/mastodon/features/ui/index.jsx\n@@ -549,6 +549,18 @@ class UI extends PureComponent {\n     this.context.router.history.push('/follow_requests');\n   };\n \n+  handleModalOpened = () => {\n+    if (!this.context.router.history.location.state?.modalOpen) {\n+      this.context.router.history.push(this.context.router.history.pathname, { modalOpen: true });\n+    }\n+  };\n+\n+  handleModalClosed = () => {\n+    if (this.context.router.history.location.state?.modalOpen) {\n+      this.context.router.history.goBack();\n+    }\n+  };\n+\n   render () {\n     const { draggingOver } = this.state;\n     const { children, isComposing, location, dropdownMenuIsOpen, layout } = this.props;\n@@ -587,7 +599,7 @@ class UI extends PureComponent {\n           {layout !== 'mobile' && <PictureInPicture />}\n           <NotificationsContainer />\n           <LoadingBarContainer className='loading-bar' />\n-          <ModalContainer />\n+          <ModalContainer beforeOpen={this.handleModalOpened} afterClose={this.handleModalClosed} />\n           <UploadArea active={draggingOver} onClose={this.closeUploadModal} />\n         </div>\n       </HotKeys>\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/actions/notifications_typed.ts\n@@ -18,6 +18,6 @@ export const notificationsUpdate = createAction(\n     playSound: boolean;\n   }) => ({\n     payload: args,\n-    meta: { playSound: playSound ? { sound: 'boop' } : undefined },\n+    meta: { sound: playSound ? 'boop' : undefined },\n   }),\n );\n---\n\n\n---\n\nChoice C:\ndocker-compose.yml\n@@ -2,7 +2,7 @@ version: '3'\n services:\n   db:\n     restart: always\n-    image: postgres:14-alpine\n+    image: postgres:15-alpine\n     shm_size: 256mb\n     networks:\n       - internal_network\n@@ -25,7 +25,7 @@ services:\n \n   # es:\n   #   restart: always\n-  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.4\n+  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9\n   #   environment:\n   #     - \"ES_JAVA_OPTS=-Xms512m -Xmx512m -Des.enforce.bootstrap.checks=true\"\n   #     - \"xpack.license.self_generated.type=basic\"\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\n\n\n---\n\nChoice D:\napp/workers/web/push_notification_worker.rb\n@@ -55,12 +55,8 @@ def web_push_request\n   end\n \n   def push_notification_json\n-    Oj.dump(serialized_notification_in_subscription_locale.as_json)\n-  end\n-\n-  def serialized_notification_in_subscription_locale\n     I18n.with_locale(@subscription.locale.presence || I18n.default_locale) do\n-      serialized_notification\n+      Oj.dump(serialized_notification.as_json)\n     end\n   end\n \n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Let LinkCrawlWorker in Sidekiq process a link that is affected, the following post seems to trigger this issue: https://very.tastytea.de/notes/9o0dw2kljs\r\n\r\n### Expected behaviour\r\n\r\nLinkCrawler should've given the temporary file a correct name\r\n\r\n### Actual behaviour\r\n\r\nLinkCrawler ended up with the filename containing all headers, making it too long. The operation fails and ends up in the dead queue\r\n\r\n### Detailed description\r\n\r\n_No response_\r\n\r\n### Mastodon instance\r\n\r\nwoof.tech\r\n\r\n### Mastodon version\r\n\r\nv4.1.11-3-woof\r\n\r\n### Technical details\r\n\r\n- Ruby 3.0.4p208\r\n- Node.js v16.20.2\r\n\r\nUsing some backported changes from main onto v4.1.11 (Like #28788), but this issue seems to happen on mainline mastodon as well\r\n\r\nLogs:\r\n\r\n```\r\nJan 19 15:15:47 woof-tech-mastodon-prod bundle[4091868]: 2024-01-19T15:15:47.065Z pid=4091868 tid=1yb5g class=LinkCrawlWorker jid=9febc4943b665a5240d5540a INFO: start\r\nJan 19 15:15:47 woof-tech-mastodon-prod bundle[4091868]: 2024-01-19T15:15:47.345Z pid=4091868 tid=1yb5g class=LinkCrawlWorker jid=9febc4943b665a5240d5540a INFO: Adding dead LinkCrawlWorker job 9febc4943b665a5240d5540a\r\nJan 19 15:15:47 woof-tech-mastodon-prod bundle[4091868]: 2024-01-19T15:15:47.347Z pid=4091868 tid=1yb5g class=LinkCrawlWorker jid=9febc4943b665a5240d5540a elapsed=0.281 INFO: fail\r\nJan 19 15:15:47 woof-tech-mastodon-prod bundle[4091868]: 2024-01-19T15:15:47.347Z pid=4091868 tid=1yb5g WARN: {\"context\":\"Job raised exception\",\"job\":{\"retry\":0,\"queue\":\"pull\",\"class\":\"LinkCrawlWorker\",\"args\":[111688311417973189],\"jid\":\"9febc4943b665a5240d5540a\",\"created_at\":1704228394.274077,\"enqueued_at\":1705677347.065164,\"error_message\":\"File name too long @ rb_sysopen - /tmp/d603ba193612fc3ba84766851f3938c920240119-4091868-wwu875.png22response-content-typeimage2FpngExpires1704866743SignatureTOuki<part of sig>qDdV2LRe0kMjCZLAVHMmzdGSeMjRjSlPMnd1S-dRLeCjI62qA__Key-Pair-IdAP<part of key pair>5A\",\"error_class\":\"Errno::ENAMETOOLONG\",\"failed_at\":1704228412.275545,\"retry_count\":-1,\"retried_at\":1705677240.856181}}\r\nJan 19 15:15:47 woof-tech-mastodon-prod bundle[4091868]: 2024-01-19T15:15:47.347Z pid=4091868 tid=1yb5g WARN: Errno::ENAMETOOLONG: File name too long @ rb_sysopen - /tmp/d603ba193612fc3ba84766851f3938c920240119-4091868-4gdtvo.png22response-content-typeimage2FpngExpires1704866743SignatureTOuki<part of sig>qDdV2LRe0kMjCZLAVHMmzdGSeMjRjSlPMnd1S-dRLeCjI62qA__Key-Pair-IdAP<part of key pair>5A\r\nJan 19 15:15:47 woof-tech-mastodon-prod bundle[4091868]: 2024-01-19T15:15:47.347Z pid=4091868 tid=1yb5g WARN: /home/mastodon/.rbenv/versions/3.0.6/lib/ruby/3.0.0/tempfile.rb:141:in `initialize'\r\nJan 19 15:15:47 woof-tech-mastodon-prod bundle[4091868]: /home/mastodon/.rbenv/versions/3.0.6/lib/ruby/3.0.0/tempfile.rb:141:in `open'\r\nJan 19 15:15:47 woof-tech-mastodon-prod bundle[4091868]: /home/mastodon/.rbenv/versions/3.0.6/lib/ruby/3.0.0/tempfile.rb:141:in `block in initialize'\r\n```\r\n\r\nSidekiq: \r\n```\r\nErrno::ENAMETOOLONG: File name too long @ rb_sysopen - /tmp/d603ba193612fc3ba84766851f3938c920240119-4091868-4gdtvo.png22response-content-typeimage2FpngExpires1704866743SignatureTOukiuVPhRnvSiQFunalnM3[...]\r\n```\n\n---\n\nChoice A:\napp/lib/activitypub/case_transform.rb\n@@ -14,6 +14,8 @@ def camel_lower(value)\n       when String\n         camel_lower_cache[value] ||= if value.start_with?('_:')\n                                        \"_:#{value.delete_prefix('_:').underscore.camelize(:lower)}\"\n+                                     elsif LanguagesHelper::ISO_639_1_REGIONAL.key?(value.to_sym)\n+                                       value\n                                      else\n                                        value.underscore.camelize(:lower)\n                                      end\n---\nspec/serializers/activitypub/note_serializer_spec.rb\n@@ -7,7 +7,7 @@\n \n   let!(:account) { Fabricate(:account) }\n   let!(:other) { Fabricate(:account) }\n-  let!(:parent) { Fabricate(:status, account: account, visibility: :public) }\n+  let!(:parent) { Fabricate(:status, account: account, visibility: :public, language: 'zh-TW') }\n   let!(:reply_by_account_first) { Fabricate(:status, account: account, thread: parent, visibility: :public) }\n   let!(:reply_by_account_next) { Fabricate(:status, account: account, thread: parent, visibility: :public) }\n   let!(:reply_by_other_first) { Fabricate(:status, account: other, thread: parent, visibility: :public) }\n@@ -18,8 +18,15 @@\n     @serialization = ActiveModelSerializers::SerializableResource.new(parent, serializer: described_class, adapter: ActivityPub::Adapter)\n   end\n \n-  it 'has a Note type' do\n-    expect(subject['type']).to eql('Note')\n+  it 'has the expected shape' do\n+    expect(subject).to include({\n+      '@context' => include('https://www.w3.org/ns/activitystreams'),\n+      'type' => 'Note',\n+      'attributedTo' => ActivityPub::TagManager.instance.uri_for(account),\n+      'contentMap' => include({\n+        'zh-TW' => a_kind_of(String),\n+      }),\n+    })\n   end\n \n   it 'has a replies collection' do\n---\n\n\n---\n\nChoice B:\nlib/paperclip/response_with_limit_adapter.rb\n@@ -16,7 +16,7 @@ def initialize(target, options = {})\n     private\n \n     def cache_current_values\n-      @original_filename = filename_from_content_disposition.presence || filename_from_path.presence || 'data'\n+      @original_filename = truncated_filename\n       @tempfile = copy_to_tempfile(@target)\n       @content_type = ContentTypeDetector.new(@tempfile.path).detect\n       @size = File.size(@tempfile)\n@@ -43,6 +43,13 @@ def copy_to_tempfile(source)\n       source.response.connection.close\n     end\n \n+    def truncated_filename\n+      filename = filename_from_content_disposition.presence || filename_from_path.presence || 'data'\n+      extension = File.extname(filename)\n+      basename = File.basename(filename, extension)\n+      [basename[...20], extension[..4]].compact_blank.join\n+    end\n+\n     def filename_from_content_disposition\n       disposition = @target.response.headers['content-disposition']\n       disposition&.match(/filename=\"([^\"]*)\"/)&.captures&.first\n---\n\n\n---\n\nChoice C:\nCHANGELOG.md\n@@ -8,6 +8,12 @@ All notable changes to this project will be documented in this file.\n **The 4.0.x branch will not receive any update after 2023-10-31.**\n This means that no security fix will be made available for this branch after this date, and you will need to update to a more recent version (such as the 4.1.x branch) to receive security fixes.\n \n+## [4.0.11] - 2023-09-20\n+\n+### Fixed\n+\n+- Fix post translation erroring out ([ClearlyClaire](https://github.com/mastodon/mastodon/pull/26990))\n+\n ## [4.0.10] - 2023-09-19\n \n ### Fixed\n---\ndocker-compose.yml\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.0.10\n+    image: ghcr.io/mastodon/mastodon:v4.0.11\n     restart: always\n     env_file: .env.production\n     command: bash -c \"rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000\"\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.0.10\n+    image: ghcr.io/mastodon/mastodon:v4.0.11\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.0.10\n+    image: ghcr.io/mastodon/mastodon:v4.0.11\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\nlib/mastodon/version.rb\n@@ -13,7 +13,7 @@ def minor\n     end\n \n     def patch\n-      10\n+      11\n     end\n \n     def flags\n---\nCHANGELOG.md\n@@ -3,6 +3,12 @@ Changelog\n \n All notable changes to this project will be documented in this file.\n \n+## [4.1.9] - 2023-09-20\n+\n+### Fixed\n+\n+- Fix post translation erroring out ([ClearlyClaire](https://github.com/mastodon/mastodon/pull/26990))\n+\n ## [4.1.8] - 2023-09-19\n \n ### Fixed\n---\ndocker-compose.yml\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.1.8\n+    image: ghcr.io/mastodon/mastodon:v4.1.9\n     restart: always\n     env_file: .env.production\n     command: bash -c \"rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000\"\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.1.8\n+    image: ghcr.io/mastodon/mastodon:v4.1.9\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.1.8\n+    image: ghcr.io/mastodon/mastodon:v4.1.9\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\nlib/mastodon/version.rb\n@@ -13,7 +13,7 @@ def minor\n     end\n \n     def patch\n-      8\n+      9\n     end\n \n     def flags\n---\n\n\n---\n\nChoice D:\napp/controllers/admin/accounts_controller.rb\n@@ -128,7 +128,7 @@ def remove_header\n     def unblock_email\n       authorize @account, :unblock_email?\n \n-      CanonicalEmailBlock.matching_account(@account).delete_all\n+      CanonicalEmailBlock.where(reference_account: @account).delete_all\n \n       log_action :unblock_email, @account\n \n---\napp/models/canonical_email_block.rb\n@@ -20,7 +20,6 @@ class CanonicalEmailBlock < ApplicationRecord\n   validates :canonical_email_hash, presence: true, uniqueness: true\n \n   scope :matching_email, ->(email) { where(canonical_email_hash: email_to_canonical_email_hash(email)) }\n-  scope :matching_account, ->(account) { matching_email(account&.user_email).or(where(reference_account: account)) }\n \n   def to_log_human_identifier\n     canonical_email_hash\n---\napp/views/admin/accounts/show.html.haml\n@@ -30,7 +30,7 @@\n = render 'admin/accounts/counters', account: @account\n \n - if @account.local? && @account.user.nil?\n-  = link_to t('admin.accounts.unblock_email'), unblock_email_admin_account_path(@account.id), method: :post, class: 'button' if can?(:unblock_email, @account) && CanonicalEmailBlock.matching_account(@account).exists?\n+  = link_to t('admin.accounts.unblock_email'), unblock_email_admin_account_path(@account.id), method: :post, class: 'button' if can?(:unblock_email, @account) && CanonicalEmailBlock.exists?(reference_account_id: @account.id)\n - else\n   .table-wrapper\n     %table.table.inline-table\n---\nspec/fabricators/canonical_email_block_fabricator.rb\n@@ -1,6 +1,6 @@\n # frozen_string_literal: true\n \n Fabricator(:canonical_email_block) do\n-  email { |attrs| attrs[:reference_account] ? attrs[:reference_account].user_email : sequence(:email) { |i| \"#{i}#{Faker::Internet.email}\" } }\n+  email { sequence(:email) { |i| \"#{i}#{Faker::Internet.email}\" } }\n   reference_account { Fabricate.build(:account) }\n end\n---\nspec/controllers/admin/accounts_controller_spec.rb\n@@ -53,11 +53,32 @@\n \n   describe 'GET #show' do\n     let(:current_user) { Fabricate(:user, role: UserRole.find_by(name: 'Admin')) }\n-    let(:account) { Fabricate(:account) }\n \n-    it 'returns http success' do\n-      get :show, params: { id: account.id }\n-      expect(response).to have_http_status(200)\n+    context 'with a remote account' do\n+      let(:account) { Fabricate(:account, domain: 'example.com') }\n+\n+      it 'returns http success' do\n+        get :show, params: { id: account.id }\n+        expect(response).to have_http_status(200)\n+      end\n+    end\n+\n+    context 'with a local account' do\n+      let(:account) { Fabricate(:account, domain: nil) }\n+\n+      it 'returns http success' do\n+        get :show, params: { id: account.id }\n+        expect(response).to have_http_status(200)\n+      end\n+    end\n+\n+    context 'with a local deleted account' do\n+      let(:account) { Fabricate(:account, domain: nil, user: nil) }\n+\n+      it 'returns http success' do\n+        get :show, params: { id: account.id }\n+        expect(response).to have_http_status(200)\n+      end\n     end\n   end\n \n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nTrying to add opensearch to a running mastodon instance.\r\n\r\nInstall:\r\nOpensearch 2.11.0\r\nOpenjdk 17.0.9\r\n\r\nStart opensearch service.\r\n\r\nRun `tootctl search deploy`.\n\n### Expected behaviour\n\nCreate indices and load documents.\n\n### Actual behaviour\n\nJava error\n\n### Detailed description\n\n```\r\n[mastodon@company ~/live]$ RAILS_ENV=production bin/tootctl search deploy\r\nWARNING: could not load hiredis extension, using (slower) pure Ruby implementation.\r\n/opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/elasticsearch-transport-7.13.3/lib/elasticsearch/transport/transport/base.rb:218:in `__raise_transport_error': [500] {\"error\":{\"root_cause\":[{\"type\":\"class_cast_exception\",\"reason\":\"class java.lang.Boolean cannot be cast to class java.util.Map (java.lang.Boolean and java.util.Map are in module java.base of loader 'bootstrap')\"}],\"type\":\"class_cast_exception\",\"reason\":\"class java.lang.Boolean cannot be cast to class java.util.Map (java.lang.Boolean and java.util.Map are in module java.base of loader 'bootstrap')\"},\"status\":500} (Elasticsearch::Transport::Transport::Errors::InternalServerError)\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/elasticsearch-transport-7.13.3/lib/elasticsearch/transport/transport/base.rb:347:in `perform_request'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/elasticsearch-transport-7.13.3/lib/elasticsearch/transport/transport/http/faraday.rb:37:in `perform_request'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/elasticsearch-transport-7.13.3/lib/elasticsearch/transport/client.rb:192:in `perform_request'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/elasticsearch-api-7.13.3/lib/elasticsearch/api/namespace/common.rb:38:in `perform_request'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/elasticsearch-api-7.13.3/lib/elasticsearch/api/actions/indices/create.rb:48:in `create'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.3.4/lib/chewy/index/actions.rb:62:in `create!'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.3.4/lib/chewy/index/actions.rb:34:in `create'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.3.4/lib/chewy/index/actions.rb:116:in `purge'\r\n        from /opt/mastodon/live/lib/mastodon/cli/search.rb:53:in `block in deploy'\r\n        from /opt/mastodon/live/lib/mastodon/cli/search.rb:51:in `each'\r\n        from /opt/mastodon/live/lib/mastodon/cli/search.rb:51:in `deploy'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor/command.rb:27:in `run'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor/invocation.rb:127:in `invoke_command'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor.rb:392:in `dispatch'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor/invocation.rb:116:in `invoke'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor.rb:243:in `block in subcommand'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor/command.rb:27:in `run'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor/invocation.rb:127:in `invoke_command'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor.rb:392:in `dispatch'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor/base.rb:485:in `start'\r\n        from bin/tootctl:9:in `block in <main>'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.3.4/lib/chewy/strategy.rb:60:in `wrap'\r\n        from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.3.4/lib/chewy.rb:154:in `strategy'\r\n        from bin/tootctl:8:in `<main>'\r\n```\n\n### Mastodon instance\n\nh-net.social\n\n### Mastodon version\n\nv4.2.1\n\n### Technical details\n\n- Ruby version: ruby 3.2.2 (2023-03-30 revision e51014f9c0) [x86_64-solaris2.11]\r\n- Node.js version: v16.20.2\r\n\n\n---\n\nChoice A:\nlib/mastodon/cli/search.rb\n@@ -100,6 +100,14 @@ def deploy\n       progress.finish\n \n       say(\"Indexed #{added} records, de-indexed #{removed}\", :green, true)\n+    rescue Elasticsearch::Transport::Transport::ServerError => e\n+      fail_with_message <<~ERROR\n+        There was an issue connecting to the search server. Make sure the\n+        server is configured and running correctly, and that the environment\n+        variable settings match what the server is expecting.\n+\n+        #{e.message}\n+      ERROR\n     end\n \n     private\n---\nspec/lib/mastodon/cli/search_spec.rb\n@@ -33,6 +33,17 @@\n       end\n     end\n \n+    context 'when server communication raises an error' do\n+      let(:options) { { reset_chewy: true } }\n+\n+      before { allow(Chewy::Stash::Specification).to receive(:reset!).and_raise(Elasticsearch::Transport::Transport::Errors::InternalServerError) }\n+\n+      it 'Exits with error message' do\n+        expect { subject }\n+          .to raise_error(Thor::Error, /issue connecting to the search/)\n+      end\n+    end\n+\n     context 'without options' do\n       before { stub_search_indexes }\n \n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/about/index.jsx\n@@ -6,6 +6,7 @@ import { defineMessages, injectIntl, FormattedMessage } from 'react-intl';\n import classNames from 'classnames';\n import { Helmet } from 'react-helmet';\n \n+import { List as ImmutableList } from 'immutable';\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import { connect } from 'react-redux';\n \n@@ -161,7 +162,7 @@ class About extends PureComponent {\n           </Section>\n \n           <Section title={intl.formatMessage(messages.rules)}>\n-            {!isLoading && (server.get('rules', []).isEmpty() ? (\n+            {!isLoading && (server.get('rules', ImmutableList()).isEmpty() ? (\n               <p><FormattedMessage id='about.not_available' defaultMessage='This information has not been made available on this server.' /></p>\n             ) : (\n               <ol className='rules-list'>\n---\n\n\n---\n\nChoice C:\napp/models/status.rb\n@@ -162,7 +162,7 @@ class Status < ApplicationRecord\n   REAL_TIME_WINDOW = 6.hours\n \n   def cache_key\n-    \"v2:#{super}\"\n+    \"v3:#{super}\"\n   end\n \n   def searchable_by(preloaded = nil)\n---\n\n\n---\n\nChoice D:\napp/models/admin/import.rb\n@@ -30,12 +30,14 @@ def csv_data\n \n     csv_converter = lambda do |field, field_info|\n       case field_info.header\n-      when '#domain', '#public_comment'\n+      when '#domain'\n+        field&.downcase&.strip\n+      when '#public_comment'\n         field&.strip\n       when '#severity'\n-        field&.strip&.to_sym\n+        field&.downcase&.strip&.to_sym\n       when '#reject_media', '#reject_reports', '#obfuscate'\n-        ActiveModel::Type::Boolean.new.cast(field)\n+        ActiveModel::Type::Boolean.new.cast(field&.downcase)\n       else\n         field\n       end\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nSince the web/streaming docker image split, wget was missing in the images.\r\nThere was a fix for streaming in https://github.com/mastodon/mastodon/pull/28497 but it is still missing in the web image and the docker-compose file still uses it https://github.com/mastodon/mastodon/blob/main/docker-compose.yml#L57-L68 resulting in a container restarting very frequently because of failed healthcheck.\n\n### Expected behaviour\n\nwget present in docker image\n\n### Actual behaviour\n\nwget not present in docker image\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\n_No response_\n\n### Technical details\n\nMastodon built from main branch\n\n---\n\nChoice A:\nlib/paperclip/transcoder.rb\n@@ -43,7 +43,8 @@ def make\n         unless eligible_to_passthrough?(metadata)\n           size_limit_in_bits = MediaAttachment::VIDEO_LIMIT * 8\n           desired_bitrate = (metadata.width * metadata.height * 30 * BITS_PER_PIXEL).floor\n-          maximum_bitrate = (size_limit_in_bits / metadata.duration).floor - 192_000 # Leave some space for the audio stream\n+          duration = [metadata.duration, 1].max\n+          maximum_bitrate = (size_limit_in_bits / duration).floor - 192_000 # Leave some space for the audio stream\n           bitrate = [desired_bitrate, maximum_bitrate].min\n \n           @output_options['b:v']     = bitrate\n---\n\n\n---\n\nChoice B:\nDockerfile\n@@ -103,6 +103,7 @@ RUN \\\n     procps \\\n     tini \\\n     tzdata \\\n+    wget \\\n   ; \\\n # Patch Ruby to use jemalloc\n   patchelf --add-needed libjemalloc.so.2 /usr/local/bin/ruby; \\\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -2612,6 +2612,7 @@ a.account__display-name {\n }\n \n $ui-header-height: 55px;\n+$ui-header-logo-wordmark-width: 99px;\n \n .ui__header {\n   display: none;\n@@ -2627,6 +2628,10 @@ $ui-header-height: 55px;\n   &__logo {\n     display: inline-flex;\n     padding: 15px;\n+    flex-grow: 1;\n+    flex-shrink: 1;\n+    overflow: hidden;\n+    container: header-logo / inline-size;\n \n     .logo {\n       height: $ui-header-height - 30px;\n@@ -2637,7 +2642,7 @@ $ui-header-height: 55px;\n       display: none;\n     }\n \n-    @media screen and (width >= 320px) {\n+    @container header-logo (min-width: #{$ui-header-logo-wordmark-width}) {\n       .logo--wordmark {\n         display: block;\n       }\n@@ -2654,6 +2659,7 @@ $ui-header-height: 55px;\n     gap: 10px;\n     padding: 0 10px;\n     overflow: hidden;\n+    flex-shrink: 0;\n \n     .button {\n       flex: 0 0 auto;\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/ui/components/column_link.jsx\n@@ -15,15 +15,15 @@ const ColumnLink = ({ icon, activeIcon, iconComponent, activeIconComponent, text\n \n   if (href) {\n     return (\n-      <a href={href} className={className} data-method={method} title={text} {...other}>\n+      <a href={href} className={className} data-method={method} {...other}>\n         {active ? activeIconElement : iconElement}\n         <span>{text}</span>\n         {badgeElement}\n       </a>\n     );\n   } else {\n     return (\n-      <NavLink to={to} className={className} title={text} exact {...other}>\n+      <NavLink to={to} className={className} exact {...other}>\n         {active ? activeIconElement : iconElement}\n         <span>{text}</span>\n         {badgeElement}\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nOn a Mastodon 4.1.11 instance:\r\n\r\n1. Go to `your-domain.tld/directory` on a browser. A `GET` request is made to `/api/v1/directory?order=active&local=false&limit=20`\r\n2. Check the mastodon-web logs and the database logs\r\n\n\n### Expected behaviour\n\nThe `/directory` page shows some profiles\n\n### Actual behaviour\n\nThe `/directory` page loads, but doesn't show any profile\n\n### Detailed description\n\nThe API call to `/api/v1/directory?order=active&local=false&limit=20` gives a `500` error\r\n\r\nmastodon-web logs:\r\n\r\n```\r\n[3f261ece-7921-40e8-83a1-15a7577819f0] ActiveRecord::StatementInvalid (PG::AmbiguousColumn: ERROR:  column reference \"last_status_at\" is ambiguous\r\nLINE 1: ... NULL AND \"accounts\".\"discoverable\" = $2 ORDER BY last_statu...\r\n                                                             ^\r\n):\r\n[3f261ece-7921-40e8-83a1-15a7577819f0]   \r\n[3f261ece-7921-40e8-83a1-15a7577819f0] app/controllers/api/v1/directories_controller.rb:8:in `show'\r\n[3f261ece-7921-40e8-83a1-15a7577819f0] app/controllers/concerns/localized.rb:11:in `set_locale'\r\n[3f261ece-7921-40e8-83a1-15a7577819f0] lib/mastodon/rack_middleware.rb:9:in `call'\r\n[3f261ece-7921-40e8-83a1-15a7577819f0] lib/public_file_server_middleware.rb:18:in `call'\r\n```\r\n\r\nPostgres logs:\r\n\r\n```\r\n2023-12-15T12:11:50.926973550+01:00 2023-12-15 11:11:50.926 UTC [789030] ERROR:  column reference \"last_status_at\" is ambiguous at character 2689\r\n2023-12-15T12:11:50.927009728+01:00 2023-12-15 11:11:50.926 UTC [789030] STATEMENT:  SELECT \"accounts\".\"username\" AS t0_r0, \"accounts\".\"domain\" AS t0_r1, \"accounts\".\"private_key\" AS t0_r2, \"accounts\".\"public_key\" AS t0_r3, \"accounts\".\"created_at\" AS t0_r4, \"accounts\".\"updated_at\" AS t0_r5, \"accounts\".\"note\" AS t0_r6, \"accounts\".\"display_name\" AS t0_r7, \"accounts\".\"uri\" AS t0_r8, \"accounts\".\"url\" AS t0_r9, \"accounts\".\"avatar_file_name\" AS t0_r10, \"accounts\".\"avatar_content_type\" AS t0_r11, \"accounts\".\"avatar_file_size\" AS t0_r12, \"accounts\".\"avatar_updated_at\" AS t0_r13, \"accounts\".\"header_file_name\" AS t0_r14, \"accounts\".\"header_content_type\" AS t0_r15, \"accounts\".\"header_file_size\" AS t0_r16, \"accounts\".\"header_updated_at\" AS t0_r17, \"accounts\".\"avatar_remote_url\" AS t0_r18, \"accounts\".\"locked\" AS t0_r19, \"accounts\".\"header_remote_url\" AS t0_r20, \"accounts\".\"last_webfingered_at\" AS t0_r21, \"accounts\".\"inbox_url\" AS t0_r22, \"accounts\".\"outbox_url\" AS t0_r23, \"accounts\".\"shared_inbox_url\" AS t0_r24, \"accounts\".\"followers_url\" AS t0_r25, \"accounts\".\"protocol\" AS t0_r26, \"accounts\".\"id\" AS t0_r27, \"accounts\".\"memorial\" AS t0_r28, \"accounts\".\"moved_to_account_id\" AS t0_r29, \"accounts\".\"featured_collection_url\" AS t0_r30, \"accounts\".\"fields\" AS t0_r31, \"accounts\".\"actor_type\" AS t0_r32, \"accounts\".\"discoverable\" AS t0_r33, \"accounts\".\"also_known_as\" AS t0_r34, \"accounts\".\"silenced_at\" AS t0_r35, \"accounts\".\"suspended_at\" AS t0_r36, \"accounts\".\"hide_collections\" AS t0_r37, \"accounts\".\"avatar_storage_schema_version\" AS t0_r38, \"accounts\".\"header_storage_schema_version\" AS t0_r39, \"accounts\".\"devices_url\" AS t0_r40, \"accounts\".\"sensitized_at\" AS t0_r41, \"accounts\".\"suspension_origin\" AS t0_r42, \"accounts\".\"trendable\" AS t0_r43, \"accounts\".\"reviewed_at\" AS t0_r44, \"accounts\".\"requested_review_at\" AS t0_r45, \"account_stats_accounts\".\"id\" AS t1_r0, \"account_stats_accounts\".\"account_id\" AS t1_r1, \"account_stats_accounts\".\"statuses_count\" AS t1_r2, \"account_stats_accounts\".\"following_count\" AS t1_r3, \"account_stats_accounts\".\"followers_count\" AS t1_r4, \"account_stats_accounts\".\"created_at\" AS t1_r5, \"account_stats_accounts\".\"updated_at\" AS t1_r6, \"account_stats_accounts\".\"last_status_at\" AS t1_r7 FROM \"accounts\" LEFT OUTER JOIN \"users\" ON \"users\".\"account_id\" = \"accounts\".\"id\" LEFT OUTER JOIN \"account_stats\" ON \"account_stats\".\"account_id\" = \"accounts\".\"id\" LEFT OUTER JOIN \"account_stats\" \"account_stats_accounts\" ON \"account_stats_accounts\".\"account_id\" = \"accounts\".\"id\" WHERE (\"accounts\".\"domain\" IS NOT NULL OR \"users\".\"approved\" = $1 AND \"users\".\"confirmed_at\" IS NOT NULL) AND \"accounts\".\"suspended_at\" IS NULL AND \"accounts\".\"moved_to_account_id\" IS NULL AND \"accounts\".\"silenced_at\" IS NULL AND \"accounts\".\"discoverable\" = $2 ORDER BY last_status_at DESC NULLS LAST LIMIT $3\r\n```\r\n\r\nIn the generated query, the `LEFT OUTER JOIN \"account_stats\" ON \"account_stats\".\"account_id\" = \"accounts\".\"id\" LEFT OUTER JOIN \"account_stats\" \"account_stats_accounts\" ON \"account_stats_accounts\".\"account_id\" = \"accounts\".\"id\"` seems weird.\n\n### Mastodon instance\n\nhttps://mastodon.libre-entreprise.com\n\n### Mastodon version\n\nv4.1.11\n\n### Technical details\n\nMastodon running with Docker, using official image\n\n---\n\nChoice A:\napp/models/concerns/account_avatar.rb\n@@ -18,7 +18,7 @@ def avatar_styles(file)\n \n   included do\n     # Avatar upload\n-    has_attached_file :avatar, styles: ->(f) { avatar_styles(f) }, convert_options: { all: '+profile \"!icc,*\" +set modify-date +set create-date' }, processors: [:lazy_thumbnail]\n+    has_attached_file :avatar, styles: ->(f) { avatar_styles(f) }, convert_options: { all: '+profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' }, processors: [:lazy_thumbnail]\n     validates_attachment_content_type :avatar, content_type: IMAGE_MIME_TYPES\n     validates_attachment_size :avatar, less_than: LIMIT\n     remotable_attachment :avatar, LIMIT, suppress_errors: false\n---\napp/models/concerns/account_header.rb\n@@ -19,7 +19,7 @@ def header_styles(file)\n \n   included do\n     # Header upload\n-    has_attached_file :header, styles: ->(f) { header_styles(f) }, convert_options: { all: '+profile \"!icc,*\" +set modify-date +set create-date' }, processors: [:lazy_thumbnail]\n+    has_attached_file :header, styles: ->(f) { header_styles(f) }, convert_options: { all: '+profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' }, processors: [:lazy_thumbnail]\n     validates_attachment_content_type :header, content_type: IMAGE_MIME_TYPES\n     validates_attachment_size :header, less_than: LIMIT\n     remotable_attachment :header, LIMIT, suppress_errors: false\n---\napp/models/custom_emoji.rb\n@@ -39,7 +39,7 @@ class CustomEmoji < ApplicationRecord\n \n   has_one :local_counterpart, -> { where(domain: nil) }, class_name: 'CustomEmoji', primary_key: :shortcode, foreign_key: :shortcode, inverse_of: false\n \n-  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set modify-date +set create-date' } }, validate_media_type: false\n+  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' } }, validate_media_type: false\n \n   before_validation :downcase_domain\n \n---\napp/models/media_attachment.rb\n@@ -171,7 +171,7 @@ class MediaAttachment < ApplicationRecord\n   DEFAULT_STYLES = [:original].freeze\n \n   GLOBAL_CONVERT_OPTIONS = {\n-    all: '-quality 90 +profile \"!icc,*\" +set modify-date -define jpeg:dct-method=float +set create-date',\n+    all: '-quality 90 +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp -define jpeg:dct-method=float',\n   }.freeze\n \n   belongs_to :account,          inverse_of: :media_attachments, optional: true\n---\napp/models/preview_card.rb\n@@ -53,7 +53,7 @@ class PreviewCard < ApplicationRecord\n   has_and_belongs_to_many :statuses\n   has_one :trend, class_name: 'PreviewCardTrend', inverse_of: :preview_card, dependent: :destroy\n \n-  has_attached_file :image, processors: [:thumbnail, :blurhash_transcoder], styles: ->(f) { image_styles(f) }, convert_options: { all: '-quality 90 +profile \"!icc,*\" +set modify-date +set create-date' }, validate_media_type: false\n+  has_attached_file :image, processors: [:thumbnail, :blurhash_transcoder], styles: ->(f) { image_styles(f) }, convert_options: { all: '-quality 90 +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' }, validate_media_type: false\n \n   validates :url, presence: true, uniqueness: true\n   validates_attachment_content_type :image, content_type: IMAGE_MIME_TYPES\n---\napp/models/preview_card_provider.rb\n@@ -27,7 +27,7 @@ class PreviewCardProvider < ApplicationRecord\n \n   validates :domain, presence: true, uniqueness: true, domain: true\n \n-  has_attached_file :icon, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set modify-date +set create-date' } }, validate_media_type: false\n+  has_attached_file :icon, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' } }, validate_media_type: false\n   validates_attachment :icon, content_type: { content_type: ICON_MIME_TYPES }, size: { less_than: LIMIT }\n   remotable_attachment :icon, LIMIT\n \n---\napp/models/site_upload.rb\n@@ -41,7 +41,7 @@ class SiteUpload < ApplicationRecord\n     mascot: {}.freeze,\n   }.freeze\n \n-  has_attached_file :file, styles: ->(file) { STYLES[file.instance.var.to_sym] }, convert_options: { all: '-coalesce +profile \"!icc,*\" +set modify-date +set create-date' }, processors: [:lazy_thumbnail, :blurhash_transcoder, :type_corrector]\n+  has_attached_file :file, styles: ->(file) { STYLES[file.instance.var.to_sym] }, convert_options: { all: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' }, processors: [:lazy_thumbnail, :blurhash_transcoder, :type_corrector]\n \n   validates_attachment_content_type :file, content_type: %r{\\Aimage/.*\\z}\n   validates :file, presence: true\n---\n\n\n---\n\nChoice B:\napp/models/account.rb\n@@ -112,7 +112,7 @@ class Account < ApplicationRecord\n   scope :matches_domain, ->(value) { where(arel_table[:domain].matches(\"%#{value}%\")) }\n   scope :without_unapproved, -> { left_outer_joins(:user).remote.or(left_outer_joins(:user).merge(User.approved.confirmed)) }\n   scope :searchable, -> { without_unapproved.without_suspended.where(moved_to_account_id: nil) }\n-  scope :discoverable, -> { searchable.without_silenced.where(discoverable: true).left_outer_joins(:account_stat) }\n+  scope :discoverable, -> { searchable.without_silenced.where(discoverable: true).joins(:account_stat) }\n   scope :followable_by, ->(account) { joins(arel_table.join(Follow.arel_table, Arel::Nodes::OuterJoin).on(arel_table[:id].eq(Follow.arel_table[:target_account_id]).and(Follow.arel_table[:account_id].eq(account.id))).join_sources).where(Follow.arel_table[:id].eq(nil)).joins(arel_table.join(FollowRequest.arel_table, Arel::Nodes::OuterJoin).on(arel_table[:id].eq(FollowRequest.arel_table[:target_account_id]).and(FollowRequest.arel_table[:account_id].eq(account.id))).join_sources).where(FollowRequest.arel_table[:id].eq(nil)) }\n   scope :by_recent_status, -> { includes(:account_stat).merge(AccountStat.order('last_status_at DESC NULLS LAST')).references(:account_stat) }\n   scope :by_recent_sign_in, -> { order(Arel.sql('users.current_sign_in_at DESC NULLS LAST')) }\n---\nspec/requests/api/v1/directories_spec.rb\n@@ -0,0 +1,139 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+describe 'Directories API' do\n+  let(:user)    { Fabricate(:user, confirmed_at: nil) }\n+  let(:token)   { Fabricate(:accessible_access_token, resource_owner_id: user.id, scopes: scopes) }\n+  let(:scopes)  { 'read:follows' }\n+  let(:headers) { { 'Authorization' => \"Bearer #{token.token}\" } }\n+\n+  describe 'GET /api/v1/directories' do\n+    context 'with no params' do\n+      before do\n+        local_unconfirmed_account = Fabricate(\n+          :account,\n+          domain: nil,\n+          user: Fabricate(:user, confirmed_at: nil, approved: true),\n+          username: 'local_unconfirmed'\n+        )\n+        local_unconfirmed_account.create_account_stat!\n+\n+        local_unapproved_account = Fabricate(\n+          :account,\n+          domain: nil,\n+          user: Fabricate(:user, confirmed_at: 10.days.ago),\n+          username: 'local_unapproved'\n+        )\n+        local_unapproved_account.create_account_stat!\n+        local_unapproved_account.user.update(approved: false)\n+\n+        local_undiscoverable_account = Fabricate(\n+          :account,\n+          domain: nil,\n+          user: Fabricate(:user, confirmed_at: 10.days.ago, approved: true),\n+          discoverable: false,\n+          username: 'local_undiscoverable'\n+        )\n+        local_undiscoverable_account.create_account_stat!\n+\n+        excluded_from_timeline_account = Fabricate(\n+          :account,\n+          domain: 'host.example',\n+          discoverable: true,\n+          username: 'remote_excluded_from_timeline'\n+        )\n+        excluded_from_timeline_account.create_account_stat!\n+        Fabricate(:block, account: user.account, target_account: excluded_from_timeline_account)\n+\n+        domain_blocked_account = Fabricate(\n+          :account,\n+          domain: 'test.example',\n+          discoverable: true,\n+          username: 'remote_domain_blocked'\n+        )\n+        domain_blocked_account.create_account_stat!\n+        Fabricate(:account_domain_block, account: user.account, domain: 'test.example')\n+\n+        local_discoverable_account.create_account_stat!\n+        eligible_remote_account.create_account_stat!\n+      end\n+\n+      let(:local_discoverable_account) do\n+        Fabricate(\n+          :account,\n+          domain: nil,\n+          user: Fabricate(:user, confirmed_at: 10.days.ago, approved: true),\n+          discoverable: true,\n+          username: 'local_discoverable'\n+        )\n+      end\n+\n+      let(:eligible_remote_account) do\n+        Fabricate(\n+          :account,\n+          domain: 'host.example',\n+          discoverable: true,\n+          username: 'eligible_remote'\n+        )\n+      end\n+\n+      it 'returns the local discoverable account and the remote discoverable account' do\n+        get '/api/v1/directory', headers: headers\n+\n+        expect(response).to have_http_status(200)\n+        expect(body_as_json.size).to eq(2)\n+        expect(body_as_json.pluck(:id)).to contain_exactly(eligible_remote_account.id.to_s, local_discoverable_account.id.to_s)\n+      end\n+    end\n+\n+    context 'when asking for local accounts only' do\n+      let(:user) { Fabricate(:user, confirmed_at: 10.days.ago, approved: true) }\n+      let(:local_account) { Fabricate(:account, domain: nil, user: user) }\n+      let(:remote_account) { Fabricate(:account, domain: 'host.example') }\n+\n+      before do\n+        local_account.create_account_stat!\n+        remote_account.create_account_stat!\n+      end\n+\n+      it 'returns only the local accounts' do\n+        get '/api/v1/directory', headers: headers, params: { local: '1' }\n+\n+        expect(response).to have_http_status(200)\n+        expect(body_as_json.size).to eq(1)\n+        expect(body_as_json.first[:id]).to include(local_account.id.to_s)\n+        expect(response.body).to_not include(remote_account.id.to_s)\n+      end\n+    end\n+\n+    context 'when ordered by active' do\n+      it 'returns accounts in order of most recent status activity' do\n+        old_stat = Fabricate(:account_stat, last_status_at: 1.day.ago)\n+        new_stat = Fabricate(:account_stat, last_status_at: 1.minute.ago)\n+\n+        get '/api/v1/directory', headers: headers, params: { order: 'active' }\n+\n+        expect(response).to have_http_status(200)\n+        expect(body_as_json.size).to eq(2)\n+        expect(body_as_json.first[:id]).to include(new_stat.account_id.to_s)\n+        expect(body_as_json.second[:id]).to include(old_stat.account_id.to_s)\n+      end\n+    end\n+\n+    context 'when ordered by new' do\n+      it 'returns accounts in order of creation' do\n+        account_old = Fabricate(:account_stat).account\n+        travel_to 10.seconds.from_now\n+        account_new = Fabricate(:account_stat).account\n+\n+        get '/api/v1/directory', headers: headers, params: { order: 'new' }\n+\n+        expect(response).to have_http_status(200)\n+        expect(body_as_json.size).to eq(2)\n+        expect(body_as_json.first[:id]).to include(account_new.id.to_s)\n+        expect(body_as_json.second[:id]).to include(account_old.id.to_s)\n+      end\n+    end\n+  end\n+end\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/api_types/accounts.ts\n@@ -13,7 +13,7 @@ export interface ApiAccountRoleJSON {\n }\n \n // See app/serializers/rest/account_serializer.rb\n-export interface ApiAccountJSON {\n+export interface BaseApiAccountJSON {\n   acct: string;\n   avatar: string;\n   avatar_static: string;\n@@ -45,3 +45,12 @@ export interface ApiAccountJSON {\n   memorial?: boolean;\n   hide_collections: boolean;\n }\n+\n+// See app/serializers/rest/muted_account_serializer.rb\n+export interface ApiMutedAccountJSON extends BaseApiAccountJSON {\n+  mute_expires_at?: string | null;\n+}\n+\n+// For now, we have the same type representing both `Account` and `MutedAccount`\n+// objects, but we should refactor this in the future.\n+export type ApiAccountJSON = ApiMutedAccountJSON;\n---\napp/javascript/mastodon/models/account.ts\n@@ -95,6 +95,9 @@ export const accountDefaultValues: AccountShape = {\n   limited: false,\n   moved: null,\n   hide_collections: false,\n+  // This comes from `ApiMutedAccountJSON`, but we should eventually\n+  // store that in a different object.\n+  mute_expires_at: null,\n };\n \n const AccountFactory = ImmutableRecord<AccountShape>(accountDefaultValues);\n---\n\n\n---\n\nChoice D:\napp/lib/attachment_batch.rb\n@@ -75,7 +75,12 @@ def remove_files\n             end\n           when :fog\n             logger.debug { \"Deleting #{attachment.path(style)}\" }\n-            attachment.send(:directory).files.new(key: attachment.path(style)).destroy\n+\n+            begin\n+              attachment.send(:directory).files.new(key: attachment.path(style)).destroy\n+            rescue Fog::Storage::OpenStack::NotFound\n+              # Ignore failure to delete a file that has already been deleted\n+            end\n           when :azure\n             logger.debug { \"Deleting #{attachment.path(style)}\" }\n             attachment.destroy\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Set FFMPEG_BINARY=/opt/mastodon/.local/bin/ffmpeg in .env.production\r\n2. Restart mastodon-web.service\r\n\r\n\n\n### Expected behaviour\n\nMastodon using custom FFMPEG binary\n\n### Actual behaviour\n\nmastodon-web service crashing\n\n### Detailed description\n\nAfter restarting mastodon-web it crashes with this error:\r\n\r\n```shell\r\nbundle[4015134]: /opt/mastodon/live/config/initializers/ffmpeg.rb:4:in `<main>': uninitialized constant FFMPEG (NameError)\r\nbundle[4015134]:   FFMPEG.ffmpeg_binary = ENV['FFMPEG_BINARY']\r\nbundle[4015134]:   ^^^^^^\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.0.8/lib/rails/engine.rb:667:in `load'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.0.8/lib/rails/engine.rb:667:in `block in load_config_initializer'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activesupport-7.0.8/lib/active_support/notifications.rb:208:in `instrument'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.0.8/lib/rails/engine.rb:666:in `load_config_initializer'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.0.8/lib/rails/engine.rb:620:in `block (2 levels) in <class:Engine>'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.0.8/lib/rails/engine.rb:619:in `each'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.0.8/lib/rails/engine.rb:619:in `block in <class:Engine>'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.0.8/lib/rails/initializable.rb:32:in `instance_exec'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.0.8/lib/rails/initializable.rb:32:in `run'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.0.8/lib/rails/initializable.rb:61:in `block in run_initializers'\r\nbundle[4015134]:         from /opt/mastodon/.rbenv/versions/3.2.2/lib/ruby/3.2.0/tsort.rb:228:in `block in tsort_each'\r\nbundle[4015134]:         from /opt/mastodon/.rbenv/versions/3.2.2/lib/ruby/3.2.0/tsort.rb:350:in `block (2 levels) in each_strongly_connected_component'\r\nbundle[4015134]:         from /opt/mastodon/.rbenv/versions/3.2.2/lib/ruby/3.2.0/tsort.rb:422:in `block (2 levels) in each_strongly_connected_component_from'\r\nbundle[4015134]:         from /opt/mastodon/.rbenv/versions/3.2.2/lib/ruby/3.2.0/tsort.rb:431:in `each_strongly_connected_component_from'\r\nbundle[4015134]:         from /opt/mastodon/.rbenv/versions/3.2.2/lib/ruby/3.2.0/tsort.rb:421:in `block in each_strongly_connected_component_from'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.0.8/lib/rails/initializable.rb:50:in `each'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.0.8/lib/rails/initializable.rb:50:in `tsort_each_child'\r\nbundle[4015134]:         from /opt/mastodon/.rbenv/versions/3.2.2/lib/ruby/3.2.0/tsort.rb:415:in `call'\r\nbundle[4015134]:         from /opt/mastodon/.rbenv/versions/3.2.2/lib/ruby/3.2.0/tsort.rb:415:in `each_strongly_connected_component_from'\r\nbundle[4015134]:         from /opt/mastodon/.rbenv/versions/3.2.2/lib/ruby/3.2.0/tsort.rb:349:in `block in each_strongly_connected_component'\r\nbundle[4015134]:         from /opt/mastodon/.rbenv/versions/3.2.2/lib/ruby/3.2.0/tsort.rb:347:in `each'\r\nbundle[4015134]:         from /opt/mastodon/.rbenv/versions/3.2.2/lib/ruby/3.2.0/tsort.rb:347:in `call'\r\nbundle[4015134]:         from /opt/mastodon/.rbenv/versions/3.2.2/lib/ruby/3.2.0/tsort.rb:347:in `each_strongly_connected_component'\r\nbundle[4015134]:         from /opt/mastodon/.rbenv/versions/3.2.2/lib/ruby/3.2.0/tsort.rb:226:in `tsort_each'\r\nbundle[4015134]:         from /opt/mastodon/.rbenv/versions/3.2.2/lib/ruby/3.2.0/tsort.rb:205:in `tsort_each'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.0.8/lib/rails/initializable.rb:60:in `run_initializers'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/railties-7.0.8/lib/rails/application.rb:372:in `initialize!'\r\nbundle[4015134]:         from /opt/mastodon/live/config/environment.rb:7:in `<top (required)>'\r\nbundle[4015134]:         from <internal:/opt/mastodon/.rbenv/versions/3.2.2/lib/ruby/3.2.0/rubygems/core_ext/kernel_require.rb>:37:in `require'\r\nbundle[4015134]:         from <internal:/opt/mastodon/.rbenv/versions/3.2.2/lib/ruby/3.2.0/rubygems/core_ext/kernel_require.rb>:37:in `require'\r\nbundle[4015134]:         from config.ru:5:in `block in <main>'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rack-2.2.8/lib/rack/builder.rb:116:in `eval'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rack-2.2.8/lib/rack/builder.rb:116:in `new_from_string'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rack-2.2.8/lib/rack/builder.rb:105:in `load_file'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/rack-2.2.8/lib/rack/builder.rb:66:in `parse_file'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/puma-6.3.1/lib/puma/configuration.rb:366:in `load_rackup'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/puma-6.3.1/lib/puma/configuration.rb:288:in `app'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/puma-6.3.1/lib/puma/runner.rb:158:in `load_and_bind'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/puma-6.3.1/lib/puma/cluster.rb:359:in `run'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/puma-6.3.1/lib/puma/launcher.rb:194:in `run'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/puma-6.3.1/lib/puma/cli.rb:75:in `run'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/puma-6.3.1/bin/puma:10:in `<top (required)>'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/bin/puma:25:in `load'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/bin/puma:25:in `<top (required)>'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bundler-2.4.13/lib/bundler/cli/exec.rb:58:in `load'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bundler-2.4.13/lib/bundler/cli/exec.rb:58:in `kernel_load'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bundler-2.4.13/lib/bundler/cli/exec.rb:23:in `run'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bundler-2.4.13/lib/bundler/cli.rb:492:in `exec'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bundler-2.4.13/lib/bundler/vendor/thor/lib/thor/command.rb:27:in `run'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bundler-2.4.13/lib/bundler/vendor/thor/lib/thor/invocation.rb:127:in `invoke_command'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bundler-2.4.13/lib/bundler/vendor/thor/lib/thor.rb:392:in `dispatch'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bundler-2.4.13/lib/bundler/cli.rb:34:in `dispatch'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bundler-2.4.13/lib/bundler/vendor/thor/lib/thor/base.rb:485:in `start'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bundler-2.4.13/lib/bundler/cli.rb:28:in `start'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bundler-2.4.13/exe/bundle:45:in `block in <top (required)>'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bundler-2.4.13/lib/bundler/friendly_errors.rb:117:in `with_friendly_errors'\r\nbundle[4015134]:         from /opt/mastodon/live/vendor/bundle/ruby/3.2.0/gems/bundler-2.4.13/exe/bundle:33:in `<top (required)>'\r\nbundle[4015134]:         from /opt/mastodon/.rbenv/versions/3.2.2/bin/bundle:25:in `load'\r\nbundle[4015134]:         from /opt/mastodon/.rbenv/versions/3.2.2/bin/bundle:25:in `<main>'\r\n```\n\n### Mastodon instance\n\nlocal test instance\n\n### Mastodon version\n\nv4.2.3\n\n### Browser name and version\n\nAny Browser\n\n### Operating system\n\nAny OS\n\n### Technical details\n\nIt seems this was introduced with the refactor to fix #16136\n\n---\n\nChoice A:\nconfig/initializers/cors.rb\n@@ -22,6 +22,7 @@\n                expose: %w(Link X-RateLimit-Reset X-RateLimit-Limit X-RateLimit-Remaining X-Request-Id),\n                methods: %i(post put delete get patch options)\n       resource '/oauth/token', methods: [:post]\n+      resource '/oauth/revoke', methods: [:post]\n     end\n   end\n end\n---\n\n\n---\n\nChoice B:\napp/controllers/concerns/web_app_controller_concern.rb\n@@ -13,7 +13,7 @@ module WebAppControllerConcern\n       policy = ContentSecurityPolicy.new\n \n       if policy.sso_host.present?\n-        p.form_action policy.sso_host\n+        p.form_action policy.sso_host, -> { \"https://#{request.host}/auth/auth/\" }\n       else\n         p.form_action :none\n       end\n---\n\n\n---\n\nChoice C:\nstreaming/redis.js\n@@ -50,9 +50,9 @@ function getSentinelConfiguration(env, commonOptions) {\n   return {\n     db: redisDatabase,\n     name: env.REDIS_SENTINEL_MASTER,\n-    username: env.REDIS_USERNAME,\n+    username: env.REDIS_USER,\n     password: env.REDIS_PASSWORD,\n-    sentinelUsername: env.REDIS_SENTINEL_USERNAME ?? env.REDIS_USERNAME,\n+    sentinelUsername: env.REDIS_SENTINEL_USERNAME ?? env.REDIS_USER,\n     sentinelPassword: env.REDIS_SENTINEL_PASSWORD ?? env.REDIS_PASSWORD,\n     sentinels,\n     ...commonOptions,\n@@ -104,7 +104,7 @@ export function configFromEnv(env) {\n     host: env.REDIS_HOST ?? '127.0.0.1',\n     port: redisPort,\n     db: redisDatabase,\n-    username: env.REDIS_USERNAME,\n+    username: env.REDIS_USER,\n     password: env.REDIS_PASSWORD,\n     ...commonOptions,\n   };\n---\n\n\n---\n\nChoice D:\napp/lib/video_metadata_extractor.rb\n@@ -22,7 +22,7 @@ def valid?\n   private\n \n   def ffmpeg_command_output\n-    command = Terrapin::CommandLine.new('ffprobe', '-i :path -print_format :format -show_format -show_streams -show_error -loglevel :loglevel')\n+    command = Terrapin::CommandLine.new(Rails.configuration.x.ffprobe_binary, '-i :path -print_format :format -show_format -show_streams -show_error -loglevel :loglevel')\n     command.run(path: @path, format: 'json', loglevel: 'fatal')\n   end\n \n---\nconfig/initializers/ffmpeg.rb\n@@ -1,5 +1,6 @@\n # frozen_string_literal: true\n \n-if ENV['FFMPEG_BINARY'].present?\n-  FFMPEG.ffmpeg_binary = ENV['FFMPEG_BINARY']\n+Rails.application.configure do\n+  config.x.ffmpeg_binary = ENV['FFMPEG_BINARY'] || 'ffmpeg'\n+  config.x.ffprobe_binary = ENV['FFPROBE_BINARY'] || 'ffprobe'\n end\n---\nlib/paperclip/image_extractor.rb\n@@ -35,7 +35,7 @@ def extract_image_from_file!\n       dst.binmode\n \n       begin\n-        command = Terrapin::CommandLine.new('ffmpeg', '-i :source -loglevel :loglevel -y :destination', logger: Paperclip.logger)\n+        command = Terrapin::CommandLine.new(Rails.configuration.x.ffmpeg_binary, '-i :source -loglevel :loglevel -y :destination', logger: Paperclip.logger)\n         command.run(source: @file.path, destination: dst.path, loglevel: 'fatal')\n       rescue Terrapin::ExitStatusError\n         dst.close(true)\n---\nlib/paperclip/transcoder.rb\n@@ -61,7 +61,7 @@ def make\n       command_arguments, interpolations = prepare_command(destination)\n \n       begin\n-        command = Terrapin::CommandLine.new('ffmpeg', command_arguments.join(' '), logger: Paperclip.logger)\n+        command = Terrapin::CommandLine.new(Rails.configuration.x.ffmpeg_binary, command_arguments.join(' '), logger: Paperclip.logger)\n         command.run(interpolations)\n       rescue Terrapin::ExitStatusError => e\n         raise Paperclip::Error, \"Error while transcoding #{@basename}: #{e}\"\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1.Create view that news are in columns (Home, Local timeline and Federated timeline) \r\n2. Open https://pol.social/deck/@linuxmagazine@fosstodon.org/following in fourth column and take a look on right down corner:\r\n![image](https://github.com/mastodon/mastodon/assets/26818304/283959fb-acc9-4ab1-b661-d1ca03326686)\r\n\n\n### Expected behaviour\n\nCorrect displaying of text\n\n### Actual behaviour\n\nThe text is cropped and difficult to read\n\n### Detailed description\n\nText `Follows from other servers are not displayed.` is cropped when profile has many informations on element `#mastodon > div > div > div.columns-area > div:nth-child(5) > div > div.account-timeline__header > div > div.account__header__bar`\r\n\r\nElement where text is cropped:\r\n\r\n`<div class=\"empty-column-indicator\"><div class=\"timeline-hint\"><strong><span><span>Follows</span> from other servers are not displayed.</span></strong><br><a href=\"https://fosstodon.org/@linuxmagazine\" target=\"_blank\" rel=\"noopener noreferrer\"><span>Browse more on the original profile</span></a></div></div>`\r\n\r\nSelector:\r\n`#mastodon > div > div > div.columns-area > div:nth-child(5) > div > div.empty-column-indicator`\n\n### Mastodon instance\n\npol.social\n\n### Mastodon version\n\nv4.2.0\n\n### Browser name and version\n\nMicrosoft Edge Version 120.0.2210.61 (Official build) (64-bit)\n\n### Operating system\n\nOS Name\tMicrosoft Windows 10 Enterprise\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\nGemfile\n@@ -6,7 +6,7 @@ ruby '>= 3.2.0'\n gem 'propshaft'\n gem 'puma', '~> 6.3'\n gem 'rack', '~> 2.2.7'\n-gem 'rails', '~> 7.2.0'\n+gem 'rails', '~> 8.0'\n gem 'thor', '~> 1.2'\n \n gem 'dotenv'\n@@ -73,7 +73,7 @@ gem 'public_suffix', '~> 6.0'\n gem 'pundit', '~> 2.3'\n gem 'rack-attack', '~> 6.6'\n gem 'rack-cors', '~> 2.0', require: 'rack/cors'\n-gem 'rails-i18n', '~> 7.0'\n+gem 'rails-i18n', '~> 8.0'\n gem 'redcarpet', '~> 3.6'\n gem 'redis', '~> 4.5', require: ['redis', 'redis/connection/hiredis']\n gem 'redis-namespace', '~> 1.10'\n---\nGemfile.lock\n@@ -10,46 +10,45 @@ GIT\n GEM\n   remote: https://rubygems.org/\n   specs:\n-    actioncable (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actioncable (8.0.1)\n+      actionpack (= 8.0.1)\n+      activesupport (= 8.0.1)\n       nio4r (~> 2.0)\n       websocket-driver (>= 0.6.1)\n       zeitwerk (~> 2.6)\n-    actionmailbox (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activestorage (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionmailbox (8.0.1)\n+      actionpack (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activestorage (= 8.0.1)\n+      activesupport (= 8.0.1)\n       mail (>= 2.8.0)\n-    actionmailer (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      actionview (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionmailer (8.0.1)\n+      actionpack (= 8.0.1)\n+      actionview (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activesupport (= 8.0.1)\n       mail (>= 2.8.0)\n       rails-dom-testing (~> 2.2)\n-    actionpack (7.2.2.1)\n-      actionview (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionpack (8.0.1)\n+      actionview (= 8.0.1)\n+      activesupport (= 8.0.1)\n       nokogiri (>= 1.8.5)\n-      racc\n-      rack (>= 2.2.4, < 3.2)\n+      rack (>= 2.2.4)\n       rack-session (>= 1.0.1)\n       rack-test (>= 0.6.3)\n       rails-dom-testing (~> 2.2)\n       rails-html-sanitizer (~> 1.6)\n       useragent (~> 0.16)\n-    actiontext (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activestorage (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actiontext (8.0.1)\n+      actionpack (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activestorage (= 8.0.1)\n+      activesupport (= 8.0.1)\n       globalid (>= 0.6.0)\n       nokogiri (>= 1.8.5)\n-    actionview (7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionview (8.0.1)\n+      activesupport (= 8.0.1)\n       builder (~> 3.1)\n       erubi (~> 1.11)\n       rails-dom-testing (~> 2.2)\n@@ -59,22 +58,22 @@ GEM\n       activemodel (>= 4.1)\n       case_transform (>= 0.2)\n       jsonapi-renderer (>= 0.1.1.beta1, < 0.3)\n-    activejob (7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    activejob (8.0.1)\n+      activesupport (= 8.0.1)\n       globalid (>= 0.3.6)\n-    activemodel (7.2.2.1)\n-      activesupport (= 7.2.2.1)\n-    activerecord (7.2.2.1)\n-      activemodel (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    activemodel (8.0.1)\n+      activesupport (= 8.0.1)\n+    activerecord (8.0.1)\n+      activemodel (= 8.0.1)\n+      activesupport (= 8.0.1)\n       timeout (>= 0.4.0)\n-    activestorage (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    activestorage (8.0.1)\n+      actionpack (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activesupport (= 8.0.1)\n       marcel (~> 1.0)\n-    activesupport (7.2.2.1)\n+    activesupport (8.0.1)\n       base64\n       benchmark (>= 0.3)\n       bigdecimal\n@@ -86,6 +85,7 @@ GEM\n       minitest (>= 5.1)\n       securerandom (>= 0.3)\n       tzinfo (~> 2.0, >= 2.0.5)\n+      uri (>= 0.13.1)\n     addressable (2.8.7)\n       public_suffix (>= 2.0.2, < 7.0)\n     aes_key_wrap (1.1.0)\n@@ -613,20 +613,20 @@ GEM\n     rackup (1.0.1)\n       rack (< 3)\n       webrick\n-    rails (7.2.2.1)\n-      actioncable (= 7.2.2.1)\n-      actionmailbox (= 7.2.2.1)\n-      actionmailer (= 7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      actiontext (= 7.2.2.1)\n-      actionview (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activemodel (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activestorage (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    rails (8.0.1)\n+      actioncable (= 8.0.1)\n+      actionmailbox (= 8.0.1)\n+      actionmailer (= 8.0.1)\n+      actionpack (= 8.0.1)\n+      actiontext (= 8.0.1)\n+      actionview (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activemodel (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activestorage (= 8.0.1)\n+      activesupport (= 8.0.1)\n       bundler (>= 1.15.0)\n-      railties (= 7.2.2.1)\n+      railties (= 8.0.1)\n     rails-controller-testing (1.0.5)\n       actionpack (>= 5.0.1.rc1)\n       actionview (>= 5.0.1.rc1)\n@@ -638,12 +638,12 @@ GEM\n     rails-html-sanitizer (1.6.2)\n       loofah (~> 2.21)\n       nokogiri (>= 1.15.7, != 1.16.7, != 1.16.6, != 1.16.5, != 1.16.4, != 1.16.3, != 1.16.2, != 1.16.1, != 1.16.0.rc1, != 1.16.0)\n-    rails-i18n (7.0.10)\n+    rails-i18n (8.0.1)\n       i18n (>= 0.7, < 2)\n-      railties (>= 6.0.0, < 8)\n-    railties (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+      railties (>= 8.0.0, < 9)\n+    railties (8.0.1)\n+      actionpack (= 8.0.1)\n+      activesupport (= 8.0.1)\n       irb (~> 1.13)\n       rackup (>= 1.0.0)\n       rake (>= 12.2)\n@@ -986,9 +986,9 @@ DEPENDENCIES\n   rack-attack (~> 6.6)\n   rack-cors (~> 2.0)\n   rack-test (~> 2.1)\n-  rails (~> 7.2.0)\n+  rails (~> 8.0)\n   rails-controller-testing (~> 1.0)\n-  rails-i18n (~> 7.0)\n+  rails-i18n (~> 8.0)\n   rdf-normalize (~> 0.5)\n   redcarpet (~> 3.6)\n   redis (~> 4.5)\n---\nconfig/application.rb\n@@ -59,7 +59,7 @@\n module Mastodon\n   class Application < Rails::Application\n     # Initialize configuration defaults for originally generated Rails version.\n-    config.load_defaults 7.2\n+    config.load_defaults 8.0\n \n     # Please, add to the `ignore` list any other `lib` subdirectories that do\n     # not contain `.rb` files, or that should not be reloaded or eager loaded.\n---\nconfig/initializers/filter_parameter_logging.rb\n@@ -6,5 +6,5 @@\n # Use this to limit dissemination of sensitive information.\n # See the ActiveSupport::ParameterFilter documentation for supported notations and behaviors.\n Rails.application.config.filter_parameters += [\n-  :passw, :email, :secret, :token, :_key, :crypt, :salt, :certificate, :otp, :ssn\n+  :passw, :email, :secret, :token, :_key, :crypt, :salt, :certificate, :otp, :ssn, :cvv, :cvc\n ]\n---\nlib/active_record/batches.rb\n@@ -13,7 +13,9 @@ def pluck_each(*column_names)\n \n       column_names.unshift(primary_key)\n \n-      relation = relation.reorder(build_batch_orders(order).to_h).limit(batch_limit)\n+      cursor = Array(primary_key)\n+\n+      relation = relation.reorder(build_batch_orders(cursor, order).to_h).limit(batch_limit)\n       relation.skip_query_cache!\n \n       batch_relation = relation\n---\nspec/rails_helper.rb\n@@ -119,6 +119,11 @@ def sign_in(resource, _deprecated = nil, scope: nil)\n   config.include CommandLineHelpers, type: :cli\n   config.include SystemHelpers, type: :system\n \n+  # TODO: Remove when Devise fixes https://github.com/heartcombo/devise/issues/5705\n+  config.before do\n+    Rails.application.reload_routes_unless_loaded\n+  end\n+\n   config.around(:each, use_transactional_tests: false) do |example|\n     self.use_transactional_tests = false\n     example.run\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -4398,11 +4398,6 @@ a.status-card {\n   align-items: center;\n   justify-content: center;\n \n-  @supports (display: grid) {\n-    // hack to fix Chrome <57\n-    contain: strict;\n-  }\n-\n   & > span {\n     max-width: 500px;\n   }\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/widgets.scss\n@@ -1,3 +1,85 @@\n+.directory {\n+  &__tag {\n+    box-sizing: border-box;\n+    margin-bottom: 10px;\n+\n+    & > a,\n+    & > div {\n+      display: flex;\n+      align-items: center;\n+      justify-content: space-between;\n+      border: 1px solid var(--background-border-color);\n+      border-radius: 4px;\n+      padding: 15px;\n+      text-decoration: none;\n+      color: inherit;\n+      box-shadow: 0 0 15px rgba($base-shadow-color, 0.2);\n+    }\n+\n+    & > a {\n+      &:hover,\n+      &:active,\n+      &:focus {\n+        background: $ui-base-color;\n+      }\n+    }\n+\n+    &.active > a {\n+      background: $ui-highlight-color;\n+      cursor: default;\n+    }\n+\n+    &.disabled > div {\n+      opacity: 0.5;\n+      cursor: default;\n+    }\n+\n+    h4 {\n+      flex: 1 1 auto;\n+      font-size: 18px;\n+      font-weight: 700;\n+      color: $primary-text-color;\n+      white-space: nowrap;\n+      overflow: hidden;\n+      text-overflow: ellipsis;\n+\n+      .fa {\n+        color: $darker-text-color;\n+      }\n+\n+      small {\n+        display: block;\n+        font-weight: 400;\n+        font-size: 15px;\n+        margin-top: 8px;\n+        color: $darker-text-color;\n+      }\n+    }\n+\n+    &.active h4 {\n+      &,\n+      .fa,\n+      small,\n+      .trends__item__current {\n+        color: $primary-text-color;\n+      }\n+    }\n+\n+    .avatar-stack {\n+      flex: 0 0 auto;\n+      width: (36px + 4px) * 3;\n+    }\n+\n+    &.active .avatar-stack .account__avatar {\n+      border-color: $ui-highlight-color;\n+    }\n+\n+    .trends__item__current {\n+      padding-inline-end: 0;\n+    }\n+  }\n+}\n+\n .accounts-table {\n   width: 100%;\n \n---\n\n\n---\n\nChoice D:\napp/lib/activitypub/case_transform.rb\n@@ -14,6 +14,8 @@ def camel_lower(value)\n       when String\n         camel_lower_cache[value] ||= if value.start_with?('_:')\n                                        \"_:#{value.delete_prefix('_:').underscore.camelize(:lower)}\"\n+                                     elsif LanguagesHelper::ISO_639_1_REGIONAL.key?(value.to_sym)\n+                                       value\n                                      else\n                                        value.underscore.camelize(:lower)\n                                      end\n---\nspec/serializers/activitypub/note_serializer_spec.rb\n@@ -7,7 +7,7 @@\n \n   let!(:account) { Fabricate(:account) }\n   let!(:other) { Fabricate(:account) }\n-  let!(:parent) { Fabricate(:status, account: account, visibility: :public) }\n+  let!(:parent) { Fabricate(:status, account: account, visibility: :public, language: 'zh-TW') }\n   let!(:reply_by_account_first) { Fabricate(:status, account: account, thread: parent, visibility: :public) }\n   let!(:reply_by_account_next) { Fabricate(:status, account: account, thread: parent, visibility: :public) }\n   let!(:reply_by_other_first) { Fabricate(:status, account: other, thread: parent, visibility: :public) }\n@@ -18,8 +18,15 @@\n     @serialization = ActiveModelSerializers::SerializableResource.new(parent, serializer: described_class, adapter: ActivityPub::Adapter)\n   end\n \n-  it 'has a Note type' do\n-    expect(subject['type']).to eql('Note')\n+  it 'has the expected shape' do\n+    expect(subject).to include({\n+      '@context' => include('https://www.w3.org/ns/activitystreams'),\n+      'type' => 'Note',\n+      'attributedTo' => ActivityPub::TagManager.instance.uri_for(account),\n+      'contentMap' => include({\n+        'zh-TW' => a_kind_of(String),\n+      }),\n+    })\n   end\n \n   it 'has a replies collection' do\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Send a status with direct visibility to a user who doesn't follow you\r\n2. Edit the sent status\r\n3. The recipient does not see the status edit unless they refresh\r\n\r\n\r\n### Expected behaviour\r\n\r\nThe recipient should have received the edited status\r\n\r\n### Actual behaviour\r\n\r\nThe recipient does not see the status edit unless they refresh\r\n\r\n### Detailed description\r\n\r\n_No response_\r\n\r\n### Mastodon instance\r\n\r\n_No response_\r\n\r\n### Mastodon version\r\n\r\nv4.2.3\r\n\r\n### Technical details\r\n\r\n- Ruby version: 3.2.2\r\n- Node.js version: v20.6.1\r\n\n\n---\n\nChoice A:\napp/services/fan_out_on_write_service.rb\n@@ -74,6 +74,15 @@ def notify_mentioned_accounts!\n       LocalNotificationWorker.push_bulk(mentions) do |mention|\n         [mention.account_id, mention.id, 'Mention', 'mention']\n       end\n+\n+      next unless update?\n+\n+      # This may result in duplicate update payloads, but this ensures clients\n+      # are aware of edits to posts only appearing in mention notifications\n+      # (e.g. private mentions or mentions by people they do not follow)\n+      PushUpdateWorker.push_bulk(mentions.filter { |mention| subscribed_to_streaming_api?(mention.account_id) }) do |mention|\n+        [mention.account_id, @status.id, \"timeline:#{mention.account_id}:notifications\", { 'update' => true }]\n+      end\n     end\n   end\n \n@@ -162,4 +171,8 @@ def update?\n   def broadcastable?\n     @status.public_visibility? && !@status.reblog? && !@account.silenced?\n   end\n+\n+  def subscribed_to_streaming_api?(account_id)\n+    redis.exists?(\"subscribed:timeline:#{account_id}\") || redis.exists?(\"subscribed:timeline:#{account_id}:notifications\")\n+  end\n end\n---\nspec/services/fan_out_on_write_service_spec.rb\n@@ -6,11 +6,12 @@\n   subject { described_class.new }\n \n   let(:last_active_at) { Time.now.utc }\n-  let(:status) { Fabricate(:status, account: alice, visibility: visibility, text: 'Hello @bob #hoge') }\n+  let(:status) { Fabricate(:status, account: alice, visibility: visibility, text: 'Hello @bob @eve #hoge') }\n \n   let!(:alice) { Fabricate(:user, current_sign_in_at: last_active_at).account }\n   let!(:bob)   { Fabricate(:user, current_sign_in_at: last_active_at, account_attributes: { username: 'bob' }).account }\n   let!(:tom)   { Fabricate(:user, current_sign_in_at: last_active_at).account }\n+  let!(:eve)   { Fabricate(:user, current_sign_in_at: last_active_at, account_attributes: { username: 'eve' }).account }\n \n   before do\n     bob.follow!(alice)\n@@ -109,5 +110,24 @@ def home_feed_of(account)\n       expect(redis).to_not have_received(:publish).with('timeline:hashtag:hoge', anything)\n       expect(redis).to_not have_received(:publish).with('timeline:public', anything)\n     end\n+\n+    context 'when handling status updates', :sidekiq_fake do\n+      before do\n+        subject.call(status)\n+\n+        status.snapshot!(at_time: status.created_at, rate_limit: false)\n+        status.update!(text: 'Hello @bob @eve #hoge (edited)')\n+        status.snapshot!(account_id: status.account_id)\n+\n+        redis.set(\"subscribed:timeline:#{eve.id}:notifications\", '1')\n+\n+        Sidekiq::Worker.clear_all\n+      end\n+\n+      it 'pushes the update to mentioned users through the notifications streaming channel' do\n+        subject.call(status, update: true)\n+        expect(PushUpdateWorker).to have_enqueued_sidekiq_job(anything, status.id, \"timeline:#{eve.id}:notifications\", { 'update' => true })\n+      end\n+    end\n   end\n end\n---\n\n\n---\n\nChoice B:\nlib/mastodon/cli/media.rb\n@@ -128,7 +128,7 @@ def remove_orphans\n \n             model_name      = path_segments.first.classify\n             attachment_name = path_segments[1].singularize\n-            record_id       = path_segments[2..-2].join.to_i\n+            record_id       = path_segments[2...-2].join.to_i\n             file_name       = path_segments.last\n             record          = record_map.dig(model_name, record_id)\n             attachment      = record&.public_send(attachment_name)\n@@ -172,7 +172,7 @@ def remove_orphans\n           end\n \n           model_name      = path_segments.first.classify\n-          record_id       = path_segments[2..-2].join.to_i\n+          record_id       = path_segments[2...-2].join.to_i\n           attachment_name = path_segments[1].singularize\n           file_name       = path_segments.last\n \n@@ -297,7 +297,7 @@ def lookup(url)\n       fail_with_message 'Not a media URL' unless VALID_PATH_SEGMENTS_SIZE.include?(path_segments.size)\n \n       model_name = path_segments.first.classify\n-      record_id  = path_segments[2..-2].join.to_i\n+      record_id  = path_segments[2...-2].join.to_i\n \n       fail_with_message \"Cannot find corresponding model: #{model_name}\" unless PRELOAD_MODEL_WHITELIST.include?(model_name)\n \n@@ -353,7 +353,7 @@ def preload_records_from_mixed_objects(objects)\n         next unless VALID_PATH_SEGMENTS_SIZE.include?(segments.size)\n \n         model_name = segments.first.classify\n-        record_id  = segments[2..-2].join.to_i\n+        record_id  = segments[2...-2].join.to_i\n \n         next unless PRELOAD_MODEL_WHITELIST.include?(model_name)\n \n---\n\n\n---\n\nChoice C:\napp/lib/link_details_extractor.rb\n@@ -282,6 +282,6 @@ def detector\n   end\n \n   def html_entities\n-    @html_entities ||= HTMLEntities.new\n+    @html_entities ||= HTMLEntities.new(:expanded)\n   end\n end\n---\n\n\n---\n\nChoice D:\napp/helpers/application_helper.rb\n@@ -164,8 +164,11 @@ def theme_style_tags(theme)\n     if theme == 'system'\n       concat stylesheet_pack_tag('mastodon-light', media: 'not all and (prefers-color-scheme: dark)', crossorigin: 'anonymous')\n       concat stylesheet_pack_tag('default', media: '(prefers-color-scheme: dark)', crossorigin: 'anonymous')\n+      concat tag.meta name: 'theme-color', content: Themes::MASTODON_DARK_THEME_COLOR, media: '(prefers-color-scheme: dark)'\n+      concat tag.meta name: 'theme-color', content: Themes::MASTODON_LIGHT_THEME_COLOR, media: '(prefers-color-scheme: light)'\n     else\n-      stylesheet_pack_tag theme, media: 'all', crossorigin: 'anonymous'\n+      concat stylesheet_pack_tag theme, media: 'all', crossorigin: 'anonymous'\n+      concat tag.meta name: 'theme-color', content: theme == 'mastodon-light' ? Themes::MASTODON_LIGHT_THEME_COLOR : Themes::MASTODON_DARK_THEME_COLOR\n     end\n   end\n \n---\napp/lib/themes.rb\n@@ -6,6 +6,9 @@\n class Themes\n   include Singleton\n \n+  MASTODON_DARK_THEME_COLOR = '#191b22'\n+  MASTODON_LIGHT_THEME_COLOR = '#f3f5f7'\n+\n   def initialize\n     @conf = YAML.load_file(Rails.root.join('config', 'themes.yml'))\n   end\n---\napp/views/layouts/application.html.haml\n@@ -21,7 +21,6 @@\n \n     %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n     %link{ rel: 'manifest', href: manifest_path(format: :json) }/\n-    %meta{ name: 'theme-color', content: '#191b22' }/\n     %meta{ name: 'apple-mobile-web-app-capable', content: 'yes' }/\n \n     %title= html_title\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nThe way the `PostDeploymentMigrationGenerator` spec prepares and cleans up the test environment causes the `tmp` directory to be deleted, while it's relied on by the emoji CLI spec.\n\n---\n\nChoice A:\nstreaming/index.js\n@@ -1351,15 +1351,23 @@ const startServer = async () => {\n  * @param {function(string): void} [onSuccess]\n  */\n const attachServerWithConfig = (server, onSuccess) => {\n-  if (process.env.SOCKET || process.env.PORT && isNaN(+process.env.PORT)) {\n-    server.listen(process.env.SOCKET || process.env.PORT, () => {\n+  if (process.env.SOCKET) {\n+    server.listen(process.env.SOCKET, () => {\n       if (onSuccess) {\n         fs.chmodSync(server.address(), 0o666);\n         onSuccess(server.address());\n       }\n     });\n   } else {\n-    server.listen(+(process.env.PORT || 4000), process.env.BIND || '127.0.0.1', () => {\n+    const port = +(process.env.PORT || 4000);\n+    let bind = process.env.BIND ?? '127.0.0.1';\n+    // Web uses the URI syntax for BIND, which means IPv6 addresses may\n+    // be wrapped in square brackets:\n+    if (bind.startsWith('[') && bind.endsWith(']')) {\n+      bind = bind.slice(1, -1);\n+    }\n+\n+    server.listen(port, bind, () => {\n       if (onSuccess) {\n         onSuccess(`${server.address().address}:${server.address().port}`);\n       }\n---\n\n\n---\n\nChoice B:\nyarn.lock\n@@ -14663,8 +14663,8 @@ __metadata:\n   linkType: hard\n \n \"sass-loader@npm:^10.2.0\":\n-  version: 10.4.1\n-  resolution: \"sass-loader@npm:10.4.1\"\n+  version: 10.5.0\n+  resolution: \"sass-loader@npm:10.5.0\"\n   dependencies:\n     klona: \"npm:^2.0.4\"\n     loader-utils: \"npm:^2.0.0\"\n@@ -14673,7 +14673,7 @@ __metadata:\n     semver: \"npm:^7.3.2\"\n   peerDependencies:\n     fibers: \">= 3.1.0\"\n-    node-sass: ^4.0.0 || ^5.0.0 || ^6.0.0 || ^7.0.0 || ^8.0.0\n+    node-sass: ^4.0.0 || ^5.0.0 || ^6.0.0 || ^7.0.0 || ^8.0.0 || ^9.0.0\n     sass: ^1.3.0\n     webpack: ^4.36.0 || ^5.0.0\n   peerDependenciesMeta:\n@@ -14683,7 +14683,7 @@ __metadata:\n       optional: true\n     sass:\n       optional: true\n-  checksum: bf04a440fe471928f3cf884bc12c6b70bc391795b35510b1b9021e8a2cca3b8f966aef9518f4171e87e9cb78193a774f695921e6b61881a1580ae0a3c7b1b5e4\n+  checksum: be5da7784fd21c4f526cc3afaa1a765ba44cdc2f9798ecbac87b296ab44184ac5ba9bbda68a7a86f8cdcb6130acceefeb8912260fca14bdfc97f9dad02658400\n   languageName: node\n   linkType: hard\n \n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -6437,7 +6437,7 @@ a.status-card {\n   }\n \n   .dialog-option .poll__input {\n-    border-color: $inverted-text-color;\n+    border-color: $darker-text-color;\n     color: $ui-secondary-color;\n     display: inline-flex;\n     align-items: center;\n@@ -6451,13 +6451,13 @@ a.status-card {\n     &:active,\n     &:focus,\n     &:hover {\n-      border-color: lighten($inverted-text-color, 15%);\n+      border-color: $valid-value-color;\n       border-width: 4px;\n     }\n \n     &.active {\n-      border-color: $inverted-text-color;\n-      background: $inverted-text-color;\n+      border-color: $valid-value-color;\n+      background: $valid-value-color;\n     }\n   }\n \n---\n\n\n---\n\nChoice D:\napp/models/account.rb\n@@ -112,7 +112,7 @@ class Account < ApplicationRecord\n   scope :matches_domain, ->(value) { where(arel_table[:domain].matches(\"%#{value}%\")) }\n   scope :without_unapproved, -> { left_outer_joins(:user).remote.or(left_outer_joins(:user).merge(User.approved.confirmed)) }\n   scope :searchable, -> { without_unapproved.without_suspended.where(moved_to_account_id: nil) }\n-  scope :discoverable, -> { searchable.without_silenced.where(discoverable: true).left_outer_joins(:account_stat) }\n+  scope :discoverable, -> { searchable.without_silenced.where(discoverable: true).joins(:account_stat) }\n   scope :followable_by, ->(account) { joins(arel_table.join(Follow.arel_table, Arel::Nodes::OuterJoin).on(arel_table[:id].eq(Follow.arel_table[:target_account_id]).and(Follow.arel_table[:account_id].eq(account.id))).join_sources).where(Follow.arel_table[:id].eq(nil)).joins(arel_table.join(FollowRequest.arel_table, Arel::Nodes::OuterJoin).on(arel_table[:id].eq(FollowRequest.arel_table[:target_account_id]).and(FollowRequest.arel_table[:account_id].eq(account.id))).join_sources).where(FollowRequest.arel_table[:id].eq(nil)) }\n   scope :by_recent_status, -> { includes(:account_stat).merge(AccountStat.order('last_status_at DESC NULLS LAST')).references(:account_stat) }\n   scope :by_recent_sign_in, -> { order(Arel.sql('users.current_sign_in_at DESC NULLS LAST')) }\n---\nspec/requests/api/v1/directories_spec.rb\n@@ -0,0 +1,139 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+describe 'Directories API' do\n+  let(:user)    { Fabricate(:user, confirmed_at: nil) }\n+  let(:token)   { Fabricate(:accessible_access_token, resource_owner_id: user.id, scopes: scopes) }\n+  let(:scopes)  { 'read:follows' }\n+  let(:headers) { { 'Authorization' => \"Bearer #{token.token}\" } }\n+\n+  describe 'GET /api/v1/directories' do\n+    context 'with no params' do\n+      before do\n+        local_unconfirmed_account = Fabricate(\n+          :account,\n+          domain: nil,\n+          user: Fabricate(:user, confirmed_at: nil, approved: true),\n+          username: 'local_unconfirmed'\n+        )\n+        local_unconfirmed_account.create_account_stat!\n+\n+        local_unapproved_account = Fabricate(\n+          :account,\n+          domain: nil,\n+          user: Fabricate(:user, confirmed_at: 10.days.ago),\n+          username: 'local_unapproved'\n+        )\n+        local_unapproved_account.create_account_stat!\n+        local_unapproved_account.user.update(approved: false)\n+\n+        local_undiscoverable_account = Fabricate(\n+          :account,\n+          domain: nil,\n+          user: Fabricate(:user, confirmed_at: 10.days.ago, approved: true),\n+          discoverable: false,\n+          username: 'local_undiscoverable'\n+        )\n+        local_undiscoverable_account.create_account_stat!\n+\n+        excluded_from_timeline_account = Fabricate(\n+          :account,\n+          domain: 'host.example',\n+          discoverable: true,\n+          username: 'remote_excluded_from_timeline'\n+        )\n+        excluded_from_timeline_account.create_account_stat!\n+        Fabricate(:block, account: user.account, target_account: excluded_from_timeline_account)\n+\n+        domain_blocked_account = Fabricate(\n+          :account,\n+          domain: 'test.example',\n+          discoverable: true,\n+          username: 'remote_domain_blocked'\n+        )\n+        domain_blocked_account.create_account_stat!\n+        Fabricate(:account_domain_block, account: user.account, domain: 'test.example')\n+\n+        local_discoverable_account.create_account_stat!\n+        eligible_remote_account.create_account_stat!\n+      end\n+\n+      let(:local_discoverable_account) do\n+        Fabricate(\n+          :account,\n+          domain: nil,\n+          user: Fabricate(:user, confirmed_at: 10.days.ago, approved: true),\n+          discoverable: true,\n+          username: 'local_discoverable'\n+        )\n+      end\n+\n+      let(:eligible_remote_account) do\n+        Fabricate(\n+          :account,\n+          domain: 'host.example',\n+          discoverable: true,\n+          username: 'eligible_remote'\n+        )\n+      end\n+\n+      it 'returns the local discoverable account and the remote discoverable account' do\n+        get '/api/v1/directory', headers: headers\n+\n+        expect(response).to have_http_status(200)\n+        expect(body_as_json.size).to eq(2)\n+        expect(body_as_json.pluck(:id)).to contain_exactly(eligible_remote_account.id.to_s, local_discoverable_account.id.to_s)\n+      end\n+    end\n+\n+    context 'when asking for local accounts only' do\n+      let(:user) { Fabricate(:user, confirmed_at: 10.days.ago, approved: true) }\n+      let(:local_account) { Fabricate(:account, domain: nil, user: user) }\n+      let(:remote_account) { Fabricate(:account, domain: 'host.example') }\n+\n+      before do\n+        local_account.create_account_stat!\n+        remote_account.create_account_stat!\n+      end\n+\n+      it 'returns only the local accounts' do\n+        get '/api/v1/directory', headers: headers, params: { local: '1' }\n+\n+        expect(response).to have_http_status(200)\n+        expect(body_as_json.size).to eq(1)\n+        expect(body_as_json.first[:id]).to include(local_account.id.to_s)\n+        expect(response.body).to_not include(remote_account.id.to_s)\n+      end\n+    end\n+\n+    context 'when ordered by active' do\n+      it 'returns accounts in order of most recent status activity' do\n+        old_stat = Fabricate(:account_stat, last_status_at: 1.day.ago)\n+        new_stat = Fabricate(:account_stat, last_status_at: 1.minute.ago)\n+\n+        get '/api/v1/directory', headers: headers, params: { order: 'active' }\n+\n+        expect(response).to have_http_status(200)\n+        expect(body_as_json.size).to eq(2)\n+        expect(body_as_json.first[:id]).to include(new_stat.account_id.to_s)\n+        expect(body_as_json.second[:id]).to include(old_stat.account_id.to_s)\n+      end\n+    end\n+\n+    context 'when ordered by new' do\n+      it 'returns accounts in order of creation' do\n+        account_old = Fabricate(:account_stat).account\n+        travel_to 10.seconds.from_now\n+        account_new = Fabricate(:account_stat).account\n+\n+        get '/api/v1/directory', headers: headers, params: { order: 'new' }\n+\n+        expect(response).to have_http_status(200)\n+        expect(body_as_json.size).to eq(2)\n+        expect(body_as_json.first[:id]).to include(account_new.id.to_s)\n+        expect(body_as_json.second[:id]).to include(account_old.id.to_s)\n+      end\n+    end\n+  end\n+end\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nThis is mostly a reproducibility report for another certain bug that'll cause `LinkCrawlWorker`s to pile up in the dead queue.\r\n\r\nGiven a status which contains any of the following links;\r\n- https://nos.nl/l/2500401\r\n- https://nos.nl/artikel/2500401-d66-kamerlid-van-weyenberg-volgt-uslu-op-als-staatssecretaris-van-cultuur\r\n\r\nIt'll eventually crash a `LinkCrawlWorker` with the following error;\r\n\r\n`NoMethodError: undefined method 'to_sym' for [{\"@type\"=>\"Language\", \"name\"=>\"Dutch\"}]:Array`\r\n\r\nBecause of the following backtrace;\r\n\r\n<details>\r\n<summary>Backtrace</summary>\r\n\r\n```\r\napp/helpers/languages_helper.rb:294:in `valid_locale?'\r\napp/helpers/languages_helper.rb:275:in `valid_locale_or_nil'\r\napp/lib/link_details_extractor.rb:202:in `language'\r\napp/lib/link_details_extractor.rb:128:in `to_preview_card_attributes'\r\napp/services/fetch_link_card_service.rb:152:in `attempt_opengraph'\r\napp/services/fetch_link_card_service.rb:42:in `process_url'\r\napp/services/fetch_link_card_service.rb:28:in `block in call'\r\napp/models/concerns/lockable.rb:12:in `block (2 levels) in with_redis_lock'\r\nvendor/bundle/ruby/3.0.0/gems/mario-redis-lock-1.2.1/lib/redis_lock.rb:44:in `acquire'\r\napp/models/concerns/lockable.rb:10:in `block in with_redis_lock'\r\nvendor/bundle/ruby/3.0.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:110:in `block (2 levels) in with'\r\nvendor/bundle/ruby/3.0.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:109:in `handle_interrupt'\r\nvendor/bundle/ruby/3.0.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:109:in `block in with'\r\nvendor/bundle/ruby/3.0.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:106:in `handle_interrupt'\r\nvendor/bundle/ruby/3.0.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:106:in `with'\r\napp/lib/redis_configuration.rb:10:in `with'\r\napp/models/concerns/redisable.rb:9:in `with_redis'\r\napp/models/concerns/lockable.rb:9:in `with_redis_lock'\r\napp/services/fetch_link_card_service.rb:26:in `call'\r\napp/workers/link_crawl_worker.rb:9:in `perform'\r\n(irb):134:in `<main>'\r\n\r\n```\r\n\r\n</details>\r\n\r\nBecause the following line allows it to go through without conversion;\r\n\r\nhttps://github.com/mastodon/mastodon/blob/89a8e6e6227eb901b5811d8417d81dc8ab1427a9/app/lib/link_details_extractor.rb#L40\n\n---\n\nChoice A:\ndb/migrate/20180812173710_copy_status_stats.rb\n@@ -45,7 +45,7 @@ def up_slow\n     # We cannot use bulk INSERT or overarching transactions here because of possible\n     # uniqueness violations that we need to skip over\n     Status.unscoped.select('id, reblogs_count, favourites_count, created_at, updated_at').find_each do |status|\n-      params = [[nil, status.id], [nil, status.reblogs_count], [nil, status.favourites_count], [nil, status.created_at], [nil, status.updated_at]]\n+      params = [status.id, status.reblogs_count, status.favourites_count, status.created_at, status.updated_at]\n       exec_insert('INSERT INTO status_stats (status_id, reblogs_count, favourites_count, created_at, updated_at) VALUES ($1, $2, $3, $4, $5)', nil, params)\n     rescue ActiveRecord::RecordNotUnique\n       next\n---\ndb/migrate/20181116173541_copy_account_stats.rb\n@@ -45,7 +45,7 @@ def up_slow\n     # We cannot use bulk INSERT or overarching transactions here because of possible\n     # uniqueness violations that we need to skip over\n     Account.unscoped.select('id, statuses_count, following_count, followers_count, created_at, updated_at').find_each do |account|\n-      params = [[nil, account.id], [nil, account[:statuses_count]], [nil, account[:following_count]], [nil, account[:followers_count]], [nil, account.created_at], [nil, account.updated_at]]\n+      params = [account.id, account[:statuses_count], account[:following_count], account[:followers_count], account.created_at, account.updated_at]\n       exec_insert('INSERT INTO account_stats (account_id, statuses_count, following_count, followers_count, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6)', nil, params)\n     rescue ActiveRecord::RecordNotUnique\n       next\n---\nlib/mastodon/cli/statuses.rb\n@@ -61,7 +61,7 @@ def remove_statuses\n         # Skip accounts followed by local accounts\n         clean_followed_sql = 'AND NOT EXISTS (SELECT 1 FROM follows WHERE statuses.account_id = follows.target_account_id)' unless options[:clean_followed]\n \n-        ActiveRecord::Base.connection.exec_insert(<<-SQL.squish, 'SQL', [[nil, max_id]])\n+        ActiveRecord::Base.connection.exec_insert(<<-SQL.squish, 'SQL', [max_id])\n           INSERT INTO statuses_to_be_deleted (id)\n           SELECT statuses.id FROM statuses WHERE deleted_at IS NULL AND NOT local AND uri IS NOT NULL AND (id < $1)\n           AND NOT EXISTS (SELECT 1 FROM statuses AS statuses1 WHERE statuses.id = statuses1.in_reply_to_id)\n---\n\n\n---\n\nChoice B:\napp/lib/search_query_parser.rb\n@@ -8,7 +8,7 @@ class SearchQueryParser < Parslet::Parser\n   rule(:operator)  { (str('+') | str('-')).as(:operator) }\n   rule(:prefix)    { term >> colon }\n   rule(:shortcode) { (colon >> term >> colon.maybe).as(:shortcode) }\n-  rule(:phrase)    { (quote >> (term >> space.maybe).repeat >> quote).as(:phrase) }\n+  rule(:phrase)    { (quote >> (match('[^\\s\"]').repeat(1).as(:term) >> space.maybe).repeat >> quote).as(:phrase) }\n   rule(:clause)    { (operator.maybe >> prefix.maybe.as(:prefix) >> (phrase | term | shortcode)).as(:clause) | prefix.as(:clause) | quote.as(:junk) }\n   rule(:query)     { (clause >> space.maybe).repeat.as(:query) }\n   root(:query)\n---\napp/lib/search_query_transformer.rb\n@@ -225,17 +225,16 @@ def language_code_from_term(term)\n   rule(clause: subtree(:clause)) do\n     prefix   = clause[:prefix][:term].to_s if clause[:prefix]\n     operator = clause[:operator]&.to_s\n+    term     = clause[:phrase] ? clause[:phrase].map { |term| term[:term].to_s }.join(' ') : clause[:term].to_s\n \n     if clause[:prefix] && SUPPORTED_PREFIXES.include?(prefix)\n-      PrefixClause.new(prefix, operator, clause[:term].to_s, current_account: current_account)\n+      PrefixClause.new(prefix, operator, term, current_account: current_account)\n     elsif clause[:prefix]\n-      TermClause.new(operator, \"#{prefix} #{clause[:term]}\")\n+      TermClause.new(operator, \"#{prefix} #{term}\")\n     elsif clause[:term]\n-      TermClause.new(operator, clause[:term].to_s)\n-    elsif clause[:shortcode]\n-      TermClause.new(operator, \":#{clause[:term]}:\")\n+      TermClause.new(operator, term)\n     elsif clause[:phrase]\n-      PhraseClause.new(operator, clause[:phrase].is_a?(Array) ? clause[:phrase].map { |p| p[:term].to_s }.join(' ') : clause[:phrase].to_s)\n+      PhraseClause.new(operator, term)\n     else\n       raise \"Unexpected clause type: #{clause}\"\n     end\n---\napp/services/statuses_search_service.rb\n@@ -8,6 +8,7 @@ def call(query, account = nil, options = {})\n     @limit   = options[:limit].to_i\n     @offset  = options[:offset].to_i\n \n+    convert_deprecated_options!\n     status_search_results\n   end\n \n@@ -28,4 +29,25 @@ def status_search_results\n   def parsed_query\n     SearchQueryTransformer.new.apply(SearchQueryParser.new.parse(@query), current_account: @account)\n   end\n+\n+  def convert_deprecated_options!\n+    syntax_options = []\n+\n+    if @options[:account_id]\n+      username = Account.select(:username, :domain).find(@options[:account_id]).acct\n+      syntax_options << \"from:@#{username}\"\n+    end\n+\n+    if @options[:min_id]\n+      timestamp = Mastodon::Snowflake.to_time(@options[:min_id])\n+      syntax_options << \"after:\\\"#{timestamp.iso8601}\\\"\"\n+    end\n+\n+    if @options[:max_id]\n+      timestamp = Mastodon::Snowflake.to_time(@options[:max_id])\n+      syntax_options << \"before:\\\"#{timestamp.iso8601}\\\"\"\n+    end\n+\n+    @query = \"#{@query} #{syntax_options.join(' ')}\".strip if syntax_options.any?\n+  end\n end\n---\nlib/mastodon/snowflake.rb\n@@ -104,6 +104,10 @@ def id_at(timestamp, with_random: true)\n       id\n     end\n \n+    def to_time(id)\n+      Time.at((id >> 16) / 1000).utc\n+    end\n+\n     private\n \n     def already_defined?\n---\nspec/lib/search_query_transformer_spec.rb\n@@ -57,4 +57,24 @@\n       expect(subject.send(:filter_clauses)).to be_empty\n     end\n   end\n+\n+  context 'with \\'\"hello world\"\\'' do\n+    let(:query) { '\"hello world\"' }\n+\n+    it 'transforms clauses' do\n+      expect(subject.send(:must_clauses).map(&:phrase)).to contain_exactly('hello world')\n+      expect(subject.send(:must_not_clauses)).to be_empty\n+      expect(subject.send(:filter_clauses)).to be_empty\n+    end\n+  end\n+\n+  context 'with \\'before:\"2022-01-01 23:00\"\\'' do\n+    let(:query) { 'before:\"2022-01-01 23:00\"' }\n+\n+    it 'transforms clauses' do\n+      expect(subject.send(:must_clauses)).to be_empty\n+      expect(subject.send(:must_not_clauses)).to be_empty\n+      expect(subject.send(:filter_clauses).map(&:term)).to contain_exactly(lt: '2022-01-01 23:00', time_zone: 'UTC')\n+    end\n+  end\n end\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/polyfills/base_polyfills.ts\n@@ -1,4 +1,5 @@\n import 'core-js/features/object/assign';\n+import 'core-js/features/object/has-own';\n import 'core-js/features/object/values';\n import 'core-js/features/symbol';\n import 'core-js/features/promise/finally';\n---\n\n\n---\n\nChoice D:\napp/lib/link_details_extractor.rb\n@@ -37,6 +37,7 @@ def description\n \n     def language\n       lang = json['inLanguage']\n+      lang = lang.first if lang.is_a?(Array)\n       lang.is_a?(Hash) ? (lang['alternateName'] || lang['name']) : lang\n     end\n \n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nThis is mostly a reproducibility report for a certain bug that'll cause `LinkCrawlWorker`s to pile up in the dead queue.\r\n\r\nGiven a status which contains the following link;\r\n- https://www.fimfiction.net/oembed\\?url\\=https%3A%2F%2Fwww.fimfiction.net%2Fblog%2F1027689%2Fasking-for-help\r\n\r\nIt'll eventually crash a `LinkCrawlWorker` with the following error;\r\n\r\n`NoMethodError: undefined method '[]' for nil:NilClass`\r\n\r\nBecause of the following backtrace;\r\n\r\n<details>\r\n<summary>Backtrace</summary>\r\n\r\n```\r\nlive/app/services/fetch_oembed_service.rb:103:in `validate'\r\nlive/app/services/fetch_oembed_service.rb:88:in `fetch!'\r\nlive/app/services/fetch_oembed_service.rb:19:in `call'\r\nlive/app/services/fetch_link_card_service.rb:107:in `attempt_oembed'\r\nlive/app/services/fetch_link_card_service.rb:42:in `process_url'\r\nlive/app/services/fetch_link_card_service.rb:28:in `block in call'\r\nlive/app/models/concerns/lockable.rb:12:in `block (2 levels) in with_redis_lock'\r\nlive/vendor/bundle/ruby/3.0.0/gems/mario-redis-lock-1.2.1/lib/redis_lock.rb:44:in `acquire'\r\nlive/app/models/concerns/lockable.rb:10:in `block in with_redis_lock'\r\nlive/vendor/bundle/ruby/3.0.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:110:in `block (2 levels) in with'\r\nlive/vendor/bundle/ruby/3.0.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:109:in `handle_interrupt'\r\nlive/vendor/bundle/ruby/3.0.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:109:in `block in with'\r\nlive/vendor/bundle/ruby/3.0.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:106:in `handle_interrupt'\r\nlive/vendor/bundle/ruby/3.0.0/gems/connection_pool-2.4.1/lib/connection_pool.rb:106:in `with'\r\nlive/app/lib/redis_configuration.rb:10:in `with'\r\nlive/app/models/concerns/redisable.rb:9:in `with_redis'\r\nlive/app/models/concerns/lockable.rb:9:in `with_redis_lock'\r\nlive/app/services/fetch_link_card_service.rb:26:in `call'\r\nlive/app/workers/link_crawl_worker.rb:9:in `perform'\r\n```\r\n\r\n</details>\r\n\r\nBecause `body` on the following line will become the string `\"null\"`;\r\n\r\nhttps://github.com/mastodon/mastodon/blob/89a8e6e6227eb901b5811d8417d81dc8ab1427a9/app/services/fetch_oembed_service.rb#L84\r\n\n\n---\n\nChoice A:\nlib/mastodon/version.rb\n@@ -17,7 +17,7 @@ def patch\n     end\n \n     def flags\n-      ENV.fetch('MASTODON_VERSION_FLAGS', '-beta2')\n+      ENV['MASTODON_VERSION_FLAGS'].presence || '-beta2'\n     end\n \n     def suffix\n---\n\n\n---\n\nChoice B:\napp/services/fetch_oembed_service.rb\n@@ -100,7 +100,7 @@ def parse_for_format(body)\n   end\n \n   def validate(oembed)\n-    oembed if oembed[:version].to_s == '1.0' && oembed[:type].present?\n+    oembed if oembed.present? && oembed[:version].to_s == '1.0' && oembed[:type].present?\n   end\n \n   def html\n---\n\n\n---\n\nChoice C:\napp/services/fetch_link_card_service.rb\n@@ -106,12 +106,11 @@ def skip_link?(anchor)\n   end\n \n   def attempt_oembed\n-    service         = FetchOEmbedService.new\n-    url_domain      = Addressable::URI.parse(@url).normalized_host\n-    cached_endpoint = Rails.cache.read(\"oembed_endpoint:#{url_domain}\")\n+    service = FetchOEmbedService.new\n \n-    embed   = service.call(@url, cached_endpoint: cached_endpoint) unless cached_endpoint.nil?\n+    embed   = service.call(@url, use_cached_endpoint: true)\n     embed ||= service.call(@url, html: html) unless html.nil?\n+    embed ||= service.call(@url, use_cached_endpoint: true) if @url != @original_url.to_s\n \n     return false if embed.nil?\n \n---\napp/services/fetch_oembed_service.rb\n@@ -10,7 +10,7 @@ def call(url, options = {})\n     @url     = url\n     @options = options\n \n-    if @options[:cached_endpoint]\n+    if @options[:use_cached_endpoint]\n       parse_cached_endpoint!\n     else\n       discover_endpoint!\n@@ -57,9 +57,9 @@ def discover_endpoint!\n   end\n \n   def parse_cached_endpoint!\n-    cached = @options[:cached_endpoint]\n+    cached = Rails.cache.read(cache_key)\n \n-    return if cached[:endpoint].nil? || cached[:format].nil?\n+    return if cached.nil? || cached[:endpoint].nil? || cached[:format].nil?\n \n     @endpoint_url = Addressable::Template.new(cached[:endpoint]).expand(url: @url).to_s\n     @format       = cached[:format]\n@@ -68,14 +68,16 @@ def parse_cached_endpoint!\n   def cache_endpoint!\n     return unless URL_REGEX.match?(@endpoint_url)\n \n-    url_domain = Addressable::URI.parse(@url).normalized_host\n-\n     endpoint_hash = {\n       endpoint: @endpoint_url.gsub(URL_REGEX, '={url}'),\n       format: @format,\n     }\n \n-    Rails.cache.write(\"oembed_endpoint:#{url_domain}\", endpoint_hash, expires_in: ENDPOINT_CACHE_EXPIRES_IN)\n+    Rails.cache.write(cache_key, endpoint_hash, expires_in: ENDPOINT_CACHE_EXPIRES_IN)\n+  end\n+\n+  def cache_key\n+    \"oembed_endpoint:#{Addressable::URI.parse(@url).normalized_host}\"\n   end\n \n   def fetch!\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -13,6 +13,7 @@\n     stub_request(:get, 'http://example.com/not-found').to_return(status: 404, headers: { 'Content-Type' => 'text/html' }, body: html)\n     stub_request(:get, 'http://example.com/text').to_return(status: 404, headers: { 'Content-Type' => 'text/plain' }, body: 'Hello')\n     stub_request(:get, 'http://example.com/redirect').to_return(status: 302, headers: { 'Location' => 'http://example.com/html' })\n+    stub_request(:get, 'http://example.net/redirect-to-other-domain').to_return(status: 302, headers: { 'Location' => 'http://example.com/html' })\n     stub_request(:get, 'http://example.com/redirect-to-404').to_return(status: 302, headers: { 'Location' => 'http://example.com/not-found' })\n     stub_request(:get, 'http://example.com/oembed?url=http://example.com/html').to_return(headers: { 'Content-Type' => 'application/json' }, body: '{ \"version\": \"1.0\", \"type\": \"link\", \"title\": \"oEmbed title\" }')\n     stub_request(:get, 'http://example.com/oembed?format=json&url=http://example.com/html').to_return(headers: { 'Content-Type' => 'application/json' }, body: '{ \"version\": \"1.0\", \"type\": \"link\", \"title\": \"oEmbed title\" }')\n@@ -264,6 +265,39 @@\n         end\n       end\n \n+      context 'when oEmbed endpoint cache populated with redirect target' do\n+        let(:status) { Fabricate(:status, text: 'http://example.net/redirect-to-other-domain') }\n+        let(:oembed_cache) { { endpoint: 'http://example.com/oembed?format=json&url={url}', format: :json } }\n+\n+        it 'uses the cached oEmbed response' do\n+          expect(a_request(:get, 'http://example.net/redirect-to-other-domain')).to have_been_made\n+          expect(a_request(:get, 'http://example.com/oembed?url=http://example.com/html')).to have_been_made\n+        end\n+\n+        it 'creates preview card' do\n+          expect(status.preview_card).to_not be_nil\n+          expect(status.preview_card.url).to eq 'http://example.com/html'\n+          expect(status.preview_card.title).to eq 'oEmbed title'\n+        end\n+      end\n+\n+      context 'when oEmbed endpoint cache populated with redirect target but page contains no oEmbed tags' do\n+        let(:status) { Fabricate(:status, text: 'http://example.net/redirect-to-other-domain') }\n+        let(:html) { 'Please fill out CAPTCHA' }\n+        let(:oembed_cache) { { endpoint: 'http://example.com/oembed?format=json&url={url}', format: :json } }\n+\n+        it 'uses the cached oEmbed response' do\n+          expect(a_request(:get, 'http://example.net/redirect-to-other-domain')).to have_been_made\n+          expect(a_request(:get, 'http://example.com/oembed?format=json&url=http://example.com/html')).to have_been_made\n+        end\n+\n+        it 'creates preview card' do\n+          expect(status.preview_card).to_not be_nil\n+          expect(status.preview_card.url).to eq 'http://example.com/html'\n+          expect(status.preview_card.title).to eq 'oEmbed title'\n+        end\n+      end\n+\n       # If the original HTML URL for whatever reason (e.g. DOS protection) redirects to\n       # an error page, we can still use the cached oEmbed but should not use the\n       # redirect URL on the card.\n---\nspec/services/fetch_oembed_service_spec.rb\n@@ -160,10 +160,12 @@\n           headers: { 'Content-Type': 'text/html' },\n           body: request_fixture('oembed_json_empty.html')\n         )\n+\n+        Rails.cache.write('oembed_endpoint:www.youtube.com', { endpoint: 'http://www.youtube.com/oembed?format=json&url={url}', format: :json })\n       end\n \n       it 'returns new provider without fetching original URL first' do\n-        subject.call('https://www.youtube.com/watch?v=dqwpQarrDwk', cached_endpoint: { endpoint: 'http://www.youtube.com/oembed?format=json&url={url}', format: :json })\n+        subject.call('https://www.youtube.com/watch?v=dqwpQarrDwk', use_cached_endpoint: true)\n         expect(a_request(:get, 'https://www.youtube.com/watch?v=dqwpQarrDwk')).to_not have_been_made\n         expect(subject.endpoint_url).to eq 'http://www.youtube.com/oembed?format=json&url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DdqwpQarrDwk'\n         expect(subject.format).to eq :json\n---\napp/lib/link_details_extractor.rb\n@@ -225,7 +225,7 @@ def host_to_url(str)\n   end\n \n   def valid_url_or_nil(str, same_origin_only: false)\n-    return if str.blank? || str == 'null'\n+    return if str.blank? || str == 'null' || str == 'undefined'\n \n     url = @original_url + Addressable::URI.parse(str)\n \n---\nspec/lib/link_details_extractor_spec.rb\n@@ -33,6 +33,14 @@\n         expect(subject.canonical_url).to eq original_url\n       end\n     end\n+\n+    context 'when canonical URL is set to \"undefined\"' do\n+      let(:url) { 'undefined' }\n+\n+      it 'ignores the canonical URLs' do\n+        expect(subject.canonical_url).to eq original_url\n+      end\n+    end\n   end\n \n   context 'when only basic metadata is present' do\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/components/hashtag_bar.jsx\n@@ -0,0 +1,50 @@\n+import PropTypes from 'prop-types';\n+import { useMemo, useState, useCallback } from 'react';\n+\n+import { FormattedMessage } from 'react-intl';\n+\n+import { Link } from 'react-router-dom';\n+\n+import ImmutablePropTypes from 'react-immutable-proptypes';\n+\n+const domParser = new DOMParser();\n+\n+// About two lines on desktop\n+const VISIBLE_HASHTAGS = 7;\n+\n+export const HashtagBar = ({ hashtags, text }) => {\n+  const renderedHashtags = useMemo(() => {\n+    const body = domParser.parseFromString(text, 'text/html').documentElement;\n+    return [].map.call(body.querySelectorAll('[rel=tag]'), node => node.textContent.toLowerCase());\n+  }, [text]);\n+\n+  const invisibleHashtags = useMemo(() => (\n+    hashtags.filter(hashtag => !renderedHashtags.some(textContent => textContent === `#${hashtag.get('name')}` || textContent === hashtag.get('name')))\n+  ), [hashtags, renderedHashtags]);\n+\n+  const [expanded, setExpanded] = useState(false);\n+  const handleClick = useCallback(() => setExpanded(true), []);\n+\n+  if (invisibleHashtags.isEmpty()) {\n+    return null;\n+  }\n+\n+  const revealedHashtags = expanded ? invisibleHashtags : invisibleHashtags.take(VISIBLE_HASHTAGS);\n+\n+  return (\n+    <div className='hashtag-bar'>\n+      {revealedHashtags.map(hashtag => (\n+        <Link key={hashtag.get('name')} to={`/tags/${hashtag.get('name')}`}>\n+          #{hashtag.get('name')}\n+        </Link>\n+      ))}\n+\n+      {!expanded && invisibleHashtags.size > VISIBLE_HASHTAGS && <button className='link-button' onClick={handleClick}><FormattedMessage id='hashtags.and_other' defaultMessage='\u2026and {count, plural, other {# more}}' values={{ count: invisibleHashtags.size - VISIBLE_HASHTAGS }} /></button>}\n+    </div>\n+  );\n+};\n+\n+HashtagBar.propTypes = {\n+  hashtags: ImmutablePropTypes.list,\n+  text: PropTypes.string,\n+};\n\\ No newline at end of file\n---\napp/javascript/mastodon/components/status.jsx\n@@ -22,6 +22,7 @@ import { displayMedia } from '../initial_state';\n import { Avatar } from './avatar';\n import { AvatarOverlay } from './avatar_overlay';\n import { DisplayName } from './display_name';\n+import { HashtagBar } from './hashtag_bar';\n import { RelativeTimestamp } from './relative_timestamp';\n import StatusActionBar from './status_action_bar';\n import StatusContent from './status_content';\n@@ -580,6 +581,8 @@ class Status extends ImmutablePureComponent {\n \n             {media}\n \n+            <HashtagBar hashtags={status.get('tags')} text={status.get('content')} />\n+\n             <StatusActionBar scrollKey={scrollKey} status={status} account={account} onFilter={matchedFilters ? this.handleFilterClick : null} {...other} />\n           </div>\n         </div>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -10,6 +10,7 @@ import ImmutablePureComponent from 'react-immutable-pure-component';\n \n import { AnimatedNumber } from 'mastodon/components/animated_number';\n import EditedTimestamp from 'mastodon/components/edited_timestamp';\n+import { HashtagBar } from 'mastodon/components/hashtag_bar';\n import { Icon }  from 'mastodon/components/icon';\n import PictureInPicturePlaceholder from 'mastodon/components/picture_in_picture_placeholder';\n \n@@ -314,6 +315,8 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           {media}\n \n+          <HashtagBar hashtags={status.get('tags')} text={status.get('content')} />\n+\n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n               <FormattedDate value={new Date(status.get('created_at'))} hour12={false} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n---\napp/javascript/mastodon/locales/en.json\n@@ -300,6 +300,7 @@\n   \"hashtag.counter_by_uses_today\": \"{count, plural, one {{counter} post} other {{counter} posts}} today\",\n   \"hashtag.follow\": \"Follow hashtag\",\n   \"hashtag.unfollow\": \"Unfollow hashtag\",\n+  \"hashtags.and_other\": \"\u2026and {count, plural, other {# more}}\",\n   \"home.actions.go_to_explore\": \"See what's trending\",\n   \"home.actions.go_to_suggestions\": \"Find people to follow\",\n   \"home.column_settings.basic\": \"Basic\",\n---\napp/javascript/styles/mastodon/components.scss\n@@ -9256,3 +9256,26 @@ noscript {\n     }\n   }\n }\n+\n+.hashtag-bar {\n+  margin-top: 16px;\n+  display: flex;\n+  flex-wrap: wrap;\n+  font-size: 14px;\n+  gap: 4px;\n+\n+  a {\n+    display: inline-flex;\n+    border-radius: 4px;\n+    background: rgba($highlight-text-color, 0.2);\n+    color: $highlight-text-color;\n+    padding: 0.4em 0.6em;\n+    text-decoration: none;\n+\n+    &:hover,\n+    &:focus,\n+    &:active {\n+      background: rgba($highlight-text-color, 0.3);\n+    }\n+  }\n+}\n---\napp/javascript/mastodon/components/status.jsx\n@@ -546,6 +546,7 @@ class Status extends ImmutablePureComponent {\n     const visibilityIcon = visibilityIconInfo[status.get('visibility')];\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n+    const expanded = !status.get('hidden')\n \n     return (\n       <HotKeys handlers={handlers}>\n@@ -574,7 +575,7 @@ class Status extends ImmutablePureComponent {\n             <StatusContent\n               status={status}\n               onClick={this.handleClick}\n-              expanded={!status.get('hidden')}\n+              expanded={expanded}\n               onExpandedToggle={this.handleExpandedToggle}\n               onTranslate={this.handleTranslate}\n               collapsible\n@@ -584,7 +585,7 @@ class Status extends ImmutablePureComponent {\n \n             {media}\n \n-            {hashtagBar}\n+            {expanded && hashtagBar}\n \n             <StatusActionBar scrollKey={scrollKey} status={status} account={account} onFilter={matchedFilters ? this.handleFilterClick : null} {...other} />\n           </div>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -293,6 +293,7 @@ class DetailedStatus extends ImmutablePureComponent {\n     }\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n+    const expanded = !status.get('hidden')\n \n     return (\n       <div style={outerStyle}>\n@@ -318,7 +319,7 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           {media}\n \n-          {hashtagBar}\n+          {expanded && hashtagBar}\n \n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Checkout v4.2.2 (4b8fe9df73cf27db68f3c92178e37eff9deb3bd3)\r\n2. Run docker compose build\r\n\r\n\r\n### Expected behaviour\r\n\r\nDocker build should succeed\r\n\r\n### Actual behaviour\r\n\r\nDocker build fails, bundler fails to download json-canonicalization 0.3.2 from rubygems\r\n\r\n### Detailed description\r\n\r\nError occurs with at least v4.2.2 and v4.2.1, have not tested others.\r\nAccording to https://rubygems.org/gems/json-canonicalization/versions/0.3.2?locale=en the 0.3.2 version was yanked.\r\n\r\n\r\n```\r\n53.56 Your bundle is locked to json-canonicalization (0.3.2) from rubygems repository\r\n53.56 https://rubygems.org/ or installed locally, but that version can no longer be\r\n53.56 found in that source. That means the author of json-canonicalization (0.3.2) has\r\n53.56 removed it. You'll need to update your bundle to a version other than\r\n53.56 json-canonicalization (0.3.2) that hasn't been removed in order to install.\r\n------\r\nDockerfile:19\r\n--------------------\r\n  18 |     # hadolint ignore=DL3008\r\n  19 | >>> RUN apt-get update && \\\r\n  20 | >>>     apt-get -yq dist-upgrade && \\\r\n  21 | >>>     apt-get install -y --no-install-recommends build-essential \\\r\n  22 | >>>         git \\\r\n  23 | >>>         libicu-dev \\\r\n  24 | >>>         libidn-dev \\\r\n  25 | >>>         libpq-dev \\\r\n  26 | >>>         libjemalloc-dev \\\r\n  27 | >>>         zlib1g-dev \\\r\n  28 | >>>         libgdbm-dev \\\r\n  29 | >>>         libgmp-dev \\\r\n  30 | >>>         libssl-dev \\\r\n  31 | >>>         libyaml-0-2 \\\r\n  32 | >>>         ca-certificates \\\r\n  33 | >>>         libreadline8 \\\r\n  34 | >>>         python3 \\\r\n  35 | >>>         shared-mime-info && \\\r\n  36 | >>>     bundle config set --local deployment 'true' && \\\r\n  37 | >>>     bundle config set --local without 'development test' && \\\r\n  38 | >>>     bundle config set silence_root_warning true && \\\r\n  39 | >>>     bundle install -j\"$(nproc)\" && \\\r\n  40 | >>>     yarn install --pure-lockfile --production --network-timeout 600000 && \\\r\n  41 | >>>     yarn cache clean\r\n  42 |\r\n--------------------\r\nERROR: failed to solve: process \"/bin/bash -o pipefail -c apt-get update &&     apt-get -yq dist-upgrade &&     apt-get install -y --no-install-recommends build-essential         git         libicu-dev         libidn-dev         libpq-dev         libjemalloc-dev         zlib1g-dev         libgdbm-dev         libgmp-dev         libssl-dev         libyaml-0-2         ca-certificates         libreadline8         python3         shared-mime-info &&     bundle config set --local deployment 'true' &&     bundle config set --local without 'development test' &&     bundle config set silence_root_warning true &&     bundle install -j\\\"$(nproc)\\\" &&     yarn install --pure-lockfile --production --network-timeout 600000 &&     yarn cache clean\" did not complete successfully: exit code: 7\r\nERROR: Service 'web' failed to build : Build failed\r\n```\r\n\r\n### Mastodon instance\r\n\r\n_No response_\r\n\r\n### Mastodon version\r\n\r\nv4.2.2\r\n\r\n### Technical details\r\n\r\nThis is for a build of stock mastodon in docker, host is Ubuntu 22.04.3 with Docker version 24.0.7\r\n\n\n---\n\nChoice A:\napp/controllers/api/v1/admin/domain_blocks_controller.rb\n@@ -29,10 +29,11 @@ def show\n   def create\n     authorize :domain_block, :create?\n \n+    @domain_block = DomainBlock.new(resource_params)\n     existing_domain_block = resource_params[:domain].present? ? DomainBlock.rule_for(resource_params[:domain]) : nil\n-    return render json: existing_domain_block, serializer: REST::Admin::ExistingDomainBlockErrorSerializer, status: 422 if existing_domain_block.present?\n+    return render json: existing_domain_block, serializer: REST::Admin::ExistingDomainBlockErrorSerializer, status: 422 if conflicts_with_existing_block?(@domain_block, existing_domain_block)\n \n-    @domain_block = DomainBlock.create!(resource_params)\n+    @domain_block.save!\n     DomainBlockWorker.perform_async(@domain_block.id)\n     log_action :create, @domain_block\n     render json: @domain_block, serializer: REST::Admin::DomainBlockSerializer\n@@ -55,6 +56,10 @@ def destroy\n \n   private\n \n+  def conflicts_with_existing_block?(domain_block, existing_domain_block)\n+    existing_domain_block.present? && (existing_domain_block.domain == TagManager.instance.normalize_domain(domain_block.domain) || !domain_block.stricter_than?(existing_domain_block))\n+  end\n+\n   def set_domain_blocks\n     @domain_blocks = filtered_domain_blocks.order(id: :desc).to_a_paginated_by_id(limit_param(LIMIT), params_slice(:max_id, :since_id, :min_id))\n   end\n---\nspec/requests/api/v1/admin/domain_blocks_spec.rb\n@@ -130,7 +130,7 @@\n     it_behaves_like 'forbidden for wrong role', ''\n     it_behaves_like 'forbidden for wrong role', 'Moderator'\n \n-    it 'returns expected domain name and severity', :aggregate_failures do\n+    it 'creates a domain block with the expected domain name and severity', :aggregate_failures do\n       subject\n \n       body = body_as_json\n@@ -146,7 +146,44 @@\n       expect(DomainBlock.find_by(domain: 'foo.bar.com')).to be_present\n     end\n \n-    context 'when a stricter domain block already exists' do\n+    context 'when a looser domain block already exists on a higher level domain' do\n+      let(:params) { { domain: 'foo.bar.com', severity: :suspend } }\n+\n+      before do\n+        Fabricate(:domain_block, domain: 'bar.com', severity: :silence)\n+      end\n+\n+      it 'creates a domain block with the expected domain name and severity', :aggregate_failures do\n+        subject\n+\n+        body = body_as_json\n+\n+        expect(response).to have_http_status(200)\n+        expect(body).to match a_hash_including(\n+          {\n+            domain: 'foo.bar.com',\n+            severity: 'suspend',\n+          }\n+        )\n+\n+        expect(DomainBlock.find_by(domain: 'foo.bar.com')).to be_present\n+      end\n+    end\n+\n+    context 'when a domain block already exists on the same domain' do\n+      before do\n+        Fabricate(:domain_block, domain: 'foo.bar.com', severity: :silence)\n+      end\n+\n+      it 'returns existing domain block in error', :aggregate_failures do\n+        subject\n+\n+        expect(response).to have_http_status(422)\n+        expect(body_as_json[:existing_domain_block][:domain]).to eq('foo.bar.com')\n+      end\n+    end\n+\n+    context 'when a stricter domain block already exists on a higher level domain' do\n       before do\n         Fabricate(:domain_block, domain: 'bar.com', severity: :suspend)\n       end\n---\n\n\n---\n\nChoice B:\nGemfile.lock\n@@ -382,15 +382,15 @@ GEM\n       reline (>= 0.3.8)\n     jmespath (1.6.2)\n     json (2.7.0)\n-    json-canonicalization (0.3.2)\n+    json-canonicalization (1.0.0)\n     json-jwt (1.15.3)\n       activesupport (>= 4.2)\n       aes_key_wrap\n       bindata\n       httpclient\n-    json-ld (3.3.0)\n+    json-ld (3.3.1)\n       htmlentities (~> 4.3)\n-      json-canonicalization (~> 0.3, >= 0.3.2)\n+      json-canonicalization (~> 1.0)\n       link_header (~> 0.0, >= 0.0.8)\n       multi_json (~> 1.15)\n       rack (>= 2.2, < 4)\n---\n\n\n---\n\nChoice C:\napp/models/trends/tag_filter.rb\n@@ -14,7 +14,7 @@ def initialize(params)\n \n   def results\n     scope = if params[:status] == 'pending_review'\n-              Tag.unscoped\n+              Tag.unscoped.order(id: :desc)\n             else\n               trending_scope\n             end\n---\n\n\n---\n\nChoice D:\napp/models/account.rb\n@@ -68,7 +68,7 @@ class Account < ApplicationRecord\n   INSTANCE_ACTOR_ID = -99\n \n   USERNAME_RE   = /[a-z0-9_]+([a-z0-9_.-]+[a-z0-9_]+)?/i\n-  MENTION_RE    = %r{(?<![=/[:word:]])@((#{USERNAME_RE})(?:@[[:word:].-]+[[:word:]]+)?)}i\n+  MENTION_RE    = %r{(?<![=/[:word:]])@((#{USERNAME_RE})(?:@[[:word:].-]+[[:word:]]+)?)}\n   URL_PREFIX_RE = %r{\\Ahttp(s?)://[^/]+}\n   USERNAME_ONLY_RE = /\\A#{USERNAME_RE}\\z/i\n   USERNAME_LENGTH_LIMIT = 30\n---\napp/models/tag.rb\n@@ -37,7 +37,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]\\u0E47-\\u0E4E#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/account_spec.rb\n@@ -711,6 +711,14 @@\n     it 'does not match URL query string' do\n       expect(subject.match('https://example.com/?x=@alice')).to be_nil\n     end\n+\n+    it 'matches usernames immediately following the letter \u00df' do\n+      expect(subject.match('Hello to\u00df @alice from me')[1]).to eq 'alice'\n+    end\n+\n+    it 'matches usernames containing uppercase characters' do\n+      expect(subject.match('Hello to @aLice@Example.com from me')[1]).to eq 'aLice@Example.com'\n+    end\n   end\n \n   describe 'validations' do\n---\nspec/models/tag_spec.rb\n@@ -95,6 +95,14 @@\n     it 'does not match purely-numeric hashtags' do\n       expect(subject.match('hello #0123456')).to be_nil\n     end\n+\n+    it 'matches hashtags immediately following the letter \u00df' do\n+      expect(subject.match('Hello to\u00df #ruby').to_s).to eq '#ruby'\n+    end\n+\n+    it 'matches hashtags containing uppercase characters' do\n+      expect(subject.match('Hello #rubyOnRails').to_s).to eq '#rubyOnRails'\n+    end\n   end\n \n   describe '#to_param' do\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Upgrade to 456597d\r\n2. Receive a notification\r\n3. Hear no sounds even if it's on\r\n...\r\n\n\n### Expected behaviour\n\nThe boop mp3/ogg should play\n\n### Actual behaviour\n\nNo sounds\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nmementomori.social\n\n### Mastodon version\n\nv4.3.0-alpha.0\n\n### Browser name and version\n\nGoogle Chrome, Version 119.0.6045.199 (Official Build) (64-bit) + Firefox 120.0 (64-bit)\n\n### Operating system\n\nPop!_OS 22.04 LTS\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/actions/notifications_typed.ts\n@@ -18,6 +18,6 @@ export const notificationsUpdate = createAction(\n     playSound: boolean;\n   }) => ({\n     payload: args,\n-    meta: { playSound: playSound ? { sound: 'boop' } : undefined },\n+    meta: { sound: playSound ? 'boop' : undefined },\n   }),\n );\n---\n\n\n---\n\nChoice B:\nGemfile\n@@ -6,7 +6,7 @@ ruby '>= 3.2.0'\n gem 'propshaft'\n gem 'puma', '~> 6.3'\n gem 'rack', '~> 2.2.7'\n-gem 'rails', '~> 7.2.0'\n+gem 'rails', '~> 8.0'\n gem 'thor', '~> 1.2'\n \n gem 'dotenv'\n@@ -73,7 +73,7 @@ gem 'public_suffix', '~> 6.0'\n gem 'pundit', '~> 2.3'\n gem 'rack-attack', '~> 6.6'\n gem 'rack-cors', '~> 2.0', require: 'rack/cors'\n-gem 'rails-i18n', '~> 7.0'\n+gem 'rails-i18n', '~> 8.0'\n gem 'redcarpet', '~> 3.6'\n gem 'redis', '~> 4.5', require: ['redis', 'redis/connection/hiredis']\n gem 'redis-namespace', '~> 1.10'\n---\nGemfile.lock\n@@ -10,46 +10,45 @@ GIT\n GEM\n   remote: https://rubygems.org/\n   specs:\n-    actioncable (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actioncable (8.0.1)\n+      actionpack (= 8.0.1)\n+      activesupport (= 8.0.1)\n       nio4r (~> 2.0)\n       websocket-driver (>= 0.6.1)\n       zeitwerk (~> 2.6)\n-    actionmailbox (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activestorage (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionmailbox (8.0.1)\n+      actionpack (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activestorage (= 8.0.1)\n+      activesupport (= 8.0.1)\n       mail (>= 2.8.0)\n-    actionmailer (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      actionview (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionmailer (8.0.1)\n+      actionpack (= 8.0.1)\n+      actionview (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activesupport (= 8.0.1)\n       mail (>= 2.8.0)\n       rails-dom-testing (~> 2.2)\n-    actionpack (7.2.2.1)\n-      actionview (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionpack (8.0.1)\n+      actionview (= 8.0.1)\n+      activesupport (= 8.0.1)\n       nokogiri (>= 1.8.5)\n-      racc\n-      rack (>= 2.2.4, < 3.2)\n+      rack (>= 2.2.4)\n       rack-session (>= 1.0.1)\n       rack-test (>= 0.6.3)\n       rails-dom-testing (~> 2.2)\n       rails-html-sanitizer (~> 1.6)\n       useragent (~> 0.16)\n-    actiontext (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activestorage (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actiontext (8.0.1)\n+      actionpack (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activestorage (= 8.0.1)\n+      activesupport (= 8.0.1)\n       globalid (>= 0.6.0)\n       nokogiri (>= 1.8.5)\n-    actionview (7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionview (8.0.1)\n+      activesupport (= 8.0.1)\n       builder (~> 3.1)\n       erubi (~> 1.11)\n       rails-dom-testing (~> 2.2)\n@@ -59,22 +58,22 @@ GEM\n       activemodel (>= 4.1)\n       case_transform (>= 0.2)\n       jsonapi-renderer (>= 0.1.1.beta1, < 0.3)\n-    activejob (7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    activejob (8.0.1)\n+      activesupport (= 8.0.1)\n       globalid (>= 0.3.6)\n-    activemodel (7.2.2.1)\n-      activesupport (= 7.2.2.1)\n-    activerecord (7.2.2.1)\n-      activemodel (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    activemodel (8.0.1)\n+      activesupport (= 8.0.1)\n+    activerecord (8.0.1)\n+      activemodel (= 8.0.1)\n+      activesupport (= 8.0.1)\n       timeout (>= 0.4.0)\n-    activestorage (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    activestorage (8.0.1)\n+      actionpack (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activesupport (= 8.0.1)\n       marcel (~> 1.0)\n-    activesupport (7.2.2.1)\n+    activesupport (8.0.1)\n       base64\n       benchmark (>= 0.3)\n       bigdecimal\n@@ -86,6 +85,7 @@ GEM\n       minitest (>= 5.1)\n       securerandom (>= 0.3)\n       tzinfo (~> 2.0, >= 2.0.5)\n+      uri (>= 0.13.1)\n     addressable (2.8.7)\n       public_suffix (>= 2.0.2, < 7.0)\n     aes_key_wrap (1.1.0)\n@@ -613,20 +613,20 @@ GEM\n     rackup (1.0.1)\n       rack (< 3)\n       webrick\n-    rails (7.2.2.1)\n-      actioncable (= 7.2.2.1)\n-      actionmailbox (= 7.2.2.1)\n-      actionmailer (= 7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      actiontext (= 7.2.2.1)\n-      actionview (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activemodel (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activestorage (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    rails (8.0.1)\n+      actioncable (= 8.0.1)\n+      actionmailbox (= 8.0.1)\n+      actionmailer (= 8.0.1)\n+      actionpack (= 8.0.1)\n+      actiontext (= 8.0.1)\n+      actionview (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activemodel (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activestorage (= 8.0.1)\n+      activesupport (= 8.0.1)\n       bundler (>= 1.15.0)\n-      railties (= 7.2.2.1)\n+      railties (= 8.0.1)\n     rails-controller-testing (1.0.5)\n       actionpack (>= 5.0.1.rc1)\n       actionview (>= 5.0.1.rc1)\n@@ -638,12 +638,12 @@ GEM\n     rails-html-sanitizer (1.6.2)\n       loofah (~> 2.21)\n       nokogiri (>= 1.15.7, != 1.16.7, != 1.16.6, != 1.16.5, != 1.16.4, != 1.16.3, != 1.16.2, != 1.16.1, != 1.16.0.rc1, != 1.16.0)\n-    rails-i18n (7.0.10)\n+    rails-i18n (8.0.1)\n       i18n (>= 0.7, < 2)\n-      railties (>= 6.0.0, < 8)\n-    railties (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+      railties (>= 8.0.0, < 9)\n+    railties (8.0.1)\n+      actionpack (= 8.0.1)\n+      activesupport (= 8.0.1)\n       irb (~> 1.13)\n       rackup (>= 1.0.0)\n       rake (>= 12.2)\n@@ -986,9 +986,9 @@ DEPENDENCIES\n   rack-attack (~> 6.6)\n   rack-cors (~> 2.0)\n   rack-test (~> 2.1)\n-  rails (~> 7.2.0)\n+  rails (~> 8.0)\n   rails-controller-testing (~> 1.0)\n-  rails-i18n (~> 7.0)\n+  rails-i18n (~> 8.0)\n   rdf-normalize (~> 0.5)\n   redcarpet (~> 3.6)\n   redis (~> 4.5)\n---\nconfig/application.rb\n@@ -59,7 +59,7 @@\n module Mastodon\n   class Application < Rails::Application\n     # Initialize configuration defaults for originally generated Rails version.\n-    config.load_defaults 7.2\n+    config.load_defaults 8.0\n \n     # Please, add to the `ignore` list any other `lib` subdirectories that do\n     # not contain `.rb` files, or that should not be reloaded or eager loaded.\n---\nconfig/initializers/filter_parameter_logging.rb\n@@ -6,5 +6,5 @@\n # Use this to limit dissemination of sensitive information.\n # See the ActiveSupport::ParameterFilter documentation for supported notations and behaviors.\n Rails.application.config.filter_parameters += [\n-  :passw, :email, :secret, :token, :_key, :crypt, :salt, :certificate, :otp, :ssn\n+  :passw, :email, :secret, :token, :_key, :crypt, :salt, :certificate, :otp, :ssn, :cvv, :cvc\n ]\n---\nlib/active_record/batches.rb\n@@ -13,7 +13,9 @@ def pluck_each(*column_names)\n \n       column_names.unshift(primary_key)\n \n-      relation = relation.reorder(build_batch_orders(order).to_h).limit(batch_limit)\n+      cursor = Array(primary_key)\n+\n+      relation = relation.reorder(build_batch_orders(cursor, order).to_h).limit(batch_limit)\n       relation.skip_query_cache!\n \n       batch_relation = relation\n---\nspec/rails_helper.rb\n@@ -119,6 +119,11 @@ def sign_in(resource, _deprecated = nil, scope: nil)\n   config.include CommandLineHelpers, type: :cli\n   config.include SystemHelpers, type: :system\n \n+  # TODO: Remove when Devise fixes https://github.com/heartcombo/devise/issues/5705\n+  config.before do\n+    Rails.application.reload_routes_unless_loaded\n+  end\n+\n   config.around(:each, use_transactional_tests: false) do |example|\n     self.use_transactional_tests = false\n     example.run\n---\n\n\n---\n\nChoice C:\napp/controllers/concerns/web_app_controller_concern.rb\n@@ -11,7 +11,7 @@ module WebAppControllerConcern\n   end\n \n   def skip_csrf_meta_tags?\n-    !(ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1) && current_user.nil?\n+    !(ENV['ONE_CLICK_SSO_LOGIN'] == 'true' && ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1) && current_user.nil?\n   end\n \n   def set_app_body_class\n---\napp/serializers/initial_state_serializer.rb\n@@ -113,6 +113,6 @@ def instance_presenter\n   end\n \n   def sso_redirect\n-    \"/auth/auth/#{Devise.omniauth_providers[0]}\" if ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1\n+    \"/auth/auth/#{Devise.omniauth_providers[0]}\" if ENV['ONE_CLICK_SSO_LOGIN'] == 'true' && ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1\n   end\n end\n---\nconfig/initializers/content_security_policy.rb\n@@ -19,6 +19,22 @@ def host_to_url(str)\n media_host ||= host_to_url(ENV['S3_HOSTNAME']) if ENV['S3_ENABLED'] == 'true'\n media_host ||= assets_host\n \n+def sso_host\n+  return unless ENV['ONE_CLICK_SSO_LOGIN'] == 'true'\n+  return unless ENV['OMNIAUTH_ONLY'] == 'true'\n+  return unless Devise.omniauth_providers.length == 1\n+\n+  provider = Devise.omniauth_configs[Devise.omniauth_providers[0]]\n+  @sso_host ||= begin\n+    # using CAS\n+    provider.cas_url if ENV['CAS_ENABLED'] == 'true'\n+    # using SAML\n+    provider.options[:idp_sso_target_url] if ENV['SAML_ENABLED'] == 'true'\n+    # or using OIDC\n+    ENV['OIDC_AUTH_ENDPOINT'] || (OpenIDConnect::Discovery::Provider::Config.discover!(ENV['OIDC_ISSUER']).authorization_endpoint if ENV['OIDC_ENABLED'] == 'true')\n+  end\n+end\n+\n Rails.application.config.content_security_policy do |p|\n   p.base_uri        :none\n   p.default_src     :none\n@@ -29,7 +45,13 @@ def host_to_url(str)\n   p.media_src       :self, :https, :data, assets_host\n   p.frame_src       :self, :https\n   p.manifest_src    :self, assets_host\n-  p.form_action     :self\n+\n+  if sso_host.present?\n+    p.form_action     :self, sso_host\n+  else\n+    p.form_action     :self\n+  end\n+\n   p.child_src       :self, :blob, assets_host\n   p.worker_src      :self, :blob, assets_host\n \n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/reducers/notifications.js\n@@ -281,7 +281,7 @@ export default function notifications(state = initialState, action) {\n   case blockAccountSuccess.type:\n     return filterNotifications(state, [action.payload.relationship.id]);\n   case muteAccountSuccess.type:\n-    return action.relationship.muting_notifications ? filterNotifications(state, [action.payload.relationship.id]) : state;\n+    return action.payload.relationship.muting_notifications ? filterNotifications(state, [action.payload.relationship.id]) : state;\n   case blockDomainSuccess.type:\n     return filterNotifications(state, action.payload.accounts);\n   case authorizeFollowRequestSuccess.type:\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Run Mastodon Nightly with Docker Compose via ```docker compose up -d --force-recreate```\r\n2. Check start up status via ```docker compose logs mastodon-web```\n\n### Expected behaviour\n\nMastodon web services should start without error.\n\n### Actual behaviour\n\nServer crashes with error: /usr/local/lib/ruby/3.2.0/fileutils.rb:406:in `mkdir': Permission denied @ dir_s_mkdir - /opt/mastodon/tmp/pids (Errno::EACCES)\n\n### Detailed description\n\nThis appears to be related to the following pull that made ```/opt/mastodon/``` into a read only directory:  #26850\r\nAbridged Docker Compose Fragment:\r\n```\r\n  mastodon-web:\r\n    image: ghcr.io/mastodon/mastodon:nightly\r\n    container_name: mastodon-web\r\n    restart: unless-stopped\r\n    command: bash -c \"rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000\"\r\n    healthcheck:\r\n      test: ['CMD-SHELL', 'wget -q --spider --proxy=off localhost:3000/health || exit 1']\r\n# The following will fix the /opt/mastodon/tmp read only issue:\r\n#    volumes:\r\n#      - ./mastodon_tmp:/opt/mastodon/tmp\r\n    env_file: mastodon-global.env\r\n```\r\nDocker Startup Log:\r\n```\r\nmastodon-web  | => Booting Puma\r\nmastodon-web  | => Rails 7.1.2 application starting in production \r\nmastodon-web  | => Run `bin/rails server --help` for more startup options\r\nmastodon-web  | Exiting\r\nmastodon-web  | /usr/local/lib/ruby/3.2.0/fileutils.rb:406:in `mkdir': Permission denied @ dir_s_mkdir - /opt/mastodon/tmp/pids (Errno::EACCES)\r\nmastodon-web  |         from /usr/local/lib/ruby/3.2.0/fileutils.rb:406:in `fu_mkdir'\r\nmastodon-web  |         from /usr/local/lib/ruby/3.2.0/fileutils.rb:384:in `block (2 levels) in mkdir_p'\r\nmastodon-web  |         from /usr/local/lib/ruby/3.2.0/fileutils.rb:382:in `reverse_each'\r\nmastodon-web  |         from /usr/local/lib/ruby/3.2.0/fileutils.rb:382:in `block in mkdir_p'\r\nmastodon-web  |         from /usr/local/lib/ruby/3.2.0/fileutils.rb:374:in `each'\r\nmastodon-web  |         from /usr/local/lib/ruby/3.2.0/fileutils.rb:374:in `mkdir_p'\r\nmastodon-web  |         from /usr/local/bundle/gems/railties-7.1.2/lib/rails/commands/server/server_command.rb:71:in `block in create_tmp_directories'\r\nmastodon-web  |         from /usr/local/bundle/gems/railties-7.1.2/lib/rails/commands/server/server_command.rb:70:in `each'\r\nmastodon-web  |         from /usr/local/bundle/gems/railties-7.1.2/lib/rails/commands/server/server_command.rb:70:in `create_tmp_directories'\r\nmastodon-web  |         from /usr/local/bundle/gems/railties-7.1.2/lib/rails/commands/server/server_command.rb:34:in `start'\r\nmastodon-web  |         from /usr/local/bundle/gems/railties-7.1.2/lib/rails/commands/server/server_command.rb:145:in `block in perform'\r\nmastodon-web  |         from <internal:kernel>:90:in `tap'\r\nmastodon-web  |         from /usr/local/bundle/gems/railties-7.1.2/lib/rails/commands/server/server_command.rb:136:in `perform'\r\nmastodon-web  |         from /usr/local/bundle/gems/thor-1.3.0/lib/thor/command.rb:28:in `run'\r\nmastodon-web  |         from /usr/local/bundle/gems/thor-1.3.0/lib/thor/invocation.rb:127:in `invoke_command'\r\nmastodon-web  |         from /usr/local/bundle/gems/railties-7.1.2/lib/rails/command/base.rb:178:in `invoke_command'\r\nmastodon-web  |         from /usr/local/bundle/gems/thor-1.3.0/lib/thor.rb:527:in `dispatch'\r\nmastodon-web  |         from /usr/local/bundle/gems/railties-7.1.2/lib/rails/command/base.rb:73:in `perform'\r\nmastodon-web  |         from /usr/local/bundle/gems/railties-7.1.2/lib/rails/command.rb:71:in `block in invoke'\r\nmastodon-web  |         from /usr/local/bundle/gems/railties-7.1.2/lib/rails/command.rb:149:in `with_argv'\r\nmastodon-web  |         from /usr/local/bundle/gems/railties-7.1.2/lib/rails/command.rb:69:in `invoke'\r\nmastodon-web  |         from /usr/local/bundle/gems/railties-7.1.2/lib/rails/commands.rb:18:in `<main>'\r\nmastodon-web  |         from <internal:/usr/local/lib/ruby/3.2.0/rubygems/core_ext/kernel_require.rb>:37:in `require'\r\nmastodon-web  |         from <internal:/usr/local/lib/ruby/3.2.0/rubygems/core_ext/kernel_require.rb>:37:in `require'\r\nmastodon-web  |         from /usr/local/bundle/gems/bootsnap-1.17.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:32:in `require'\r\nmastodon-web  |         from bin/rails:4:in `<main>'\r\n```\r\nI was able to work around this problem by bind mounting ```/opt/mastodon/tmp``` to a directory that is writable by  mastodon:mastodon (991:991).\n\n### Mastodon instance\n\nsocial.arazil.net\n\n### Mastodon version\n\n4.3.0-nightly.2023-11-30\n\n### Technical details\n\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: 3.2.2p53 +YJIT\r\n- Node.js version: N/A (no longer included in the main Docker image per #26850)\n\n---\n\nChoice A:\napp/controllers/admin/domain_blocks_controller.rb\n@@ -37,7 +37,7 @@ def create\n         @domain_block.errors.delete(:domain)\n         render :new\n       else\n-        if existing_domain_block.present?\n+        if existing_domain_block.present? && existing_domain_block.domain == resource_params[:domain]\n           @domain_block = existing_domain_block\n           @domain_block.update(resource_params)\n         end\n---\nspec/controllers/admin/domain_blocks_controller_spec.rb\n@@ -68,6 +68,26 @@\n       expect(flash[:notice]).to eq I18n.t('admin.domain_blocks.created_msg')\n       expect(response).to redirect_to(admin_instances_path(limited: '1'))\n     end\n+\n+    context 'when a block for a parent domain already exists' do\n+      subject { post :create, params: { domain_block: { domain: 'subdomain.example.com', severity: child_severity } } }\n+\n+      let(:parent_severity) { 'silence' }\n+      let(:child_severity)  { 'suspend' }\n+\n+      before do\n+        Fabricate(:domain_block, domain: 'example.com', severity: parent_severity)\n+      end\n+\n+      it 'does not change the existing block' do\n+        expect { subject }.to_not change { DomainBlock.find_by(domain: 'example.com') }\n+      end\n+\n+      it 'creates a domain block with expected severity' do\n+        subject\n+        expect(DomainBlock.where(domain: 'subdomain.example.com', severity: child_severity)).to exist\n+      end\n+    end\n   end\n \n   describe 'PUT #update' do\n---\napp/controllers/admin/domain_blocks_controller.rb\n@@ -40,7 +40,7 @@ def create\n       end\n \n       # Allow transparently upgrading a domain block\n-      if existing_domain_block.present?\n+      if existing_domain_block.present? && existing_domain_block.domain == TagManager.instance.normalize_domain(@domain_block.domain.strip)\n         @domain_block = existing_domain_block\n         @domain_block.assign_attributes(resource_params)\n       end\n---\nspec/features/admin/domain_blocks_spec.rb\n@@ -57,6 +57,30 @@\n     end\n   end\n \n+  context 'when suspending a subdomain of an already-silenced domain' do\n+    it 'presents a confirmation screen before suspending the domain' do\n+      domain_block = Fabricate(:domain_block, domain: 'example.com', severity: 'silence')\n+\n+      visit new_admin_domain_block_path\n+\n+      fill_in 'domain_block_domain', with: 'subdomain.example.com'\n+      select I18n.t('admin.domain_blocks.new.severity.suspend'), from: 'domain_block_severity'\n+      click_on I18n.t('admin.domain_blocks.new.create')\n+\n+      # It presents a confirmation screen\n+      expect(page).to have_title(I18n.t('admin.domain_blocks.confirm_suspension.title', domain: 'subdomain.example.com'))\n+\n+      # Confirming creates the block\n+      click_on I18n.t('admin.domain_blocks.confirm_suspension.confirm')\n+\n+      expect(DomainBlock.where(domain: 'subdomain.example.com', severity: 'suspend')).to exist\n+\n+      # And leaves the previous block alone\n+      expect(domain_block.reload.severity).to eq 'silence'\n+      expect(domain_block.reload.domain).to eq 'example.com'\n+    end\n+  end\n+\n   context 'when editing a domain block' do\n     it 'presents a confirmation screen before suspending the domain' do\n       domain_block = Fabricate(:domain_block, domain: 'example.com', severity: 'silence')\n---\n\n\n---\n\nChoice B:\nDockerfile\n@@ -247,7 +247,9 @@ RUN \\\n RUN \\\n # Pre-create and chown system volume to Mastodon user\n   mkdir -p /opt/mastodon/public/system; \\\n-  chown mastodon:mastodon /opt/mastodon/public/system;\n+  chown mastodon:mastodon /opt/mastodon/public/system; \\\n+# Set Mastodon user as owner of tmp folder\n+  chown -R mastodon:mastodon /opt/mastodon/tmp;\n \n # Set the running user for resulting container\n USER mastodon\n---\ndocker-compose.yml\n@@ -59,7 +59,7 @@ services:\n     image: ghcr.io/mastodon/mastodon:v4.2.0\n     restart: always\n     env_file: .env.production\n-    command: bash -c \"rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000\"\n+    command: bundle exec puma -C config/puma.rb\n     networks:\n       - external_network\n       - internal_network\n---\n\n\n---\n\nChoice C:\napp/models/tag.rb\n@@ -37,7 +37,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?<![=/)\\w])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}i\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]\\u0E47-\\u0E4E#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/tag_spec.rb\n@@ -36,6 +36,10 @@\n       expect(subject.match('https://gcc.gnu.org/bugzilla/show_bug.cgi?id=111895#c4')).to be_nil\n     end\n \n+    it 'does not match URLs with hashtag-like anchors after a non-ascii character' do\n+      expect(subject.match('https://example.org/test\u00e9#foo')).to be_nil\n+    end\n+\n     it 'does not match URLs with hashtag-like anchors after an empty query parameter' do\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)?foo=#Lawsuit')).to be_nil\n     end\n---\n\n\n---\n\nChoice D:\nCHANGELOG.md\n@@ -2,6 +2,29 @@\n \n All notable changes to this project will be documented in this file.\n \n+## [4.3.7] - 2025-04-02\n+\n+### Add\n+\n+- Add delay to profile updates to debounce them (#34137 by @ClearlyClaire)\n+- Add support for paginating partial collections in `SynchronizeFollowersService` (#34272 and #34277 by @ClearlyClaire)\n+\n+### Changed\n+\n+- Change account suspensions to be federated to recently-followed accounts as well (#34294 by @ClearlyClaire)\n+- Change `AccountReachFinder` to consider statuses based on suspension date (#32805 and #34291 by @ClearlyClaire and @mjankowski)\n+- Change user archive signed URL TTL from 10 seconds to 1 hour (#34254 by @ClearlyClaire)\n+\n+### Fixed\n+\n+- Fix static version of animated PNG emojis not being properly extracted (#34337 by @ClearlyClaire)\n+- Fix filters not applying in detailed view, favourites and bookmarks (#34259 and #34260 by @ClearlyClaire)\n+- Fix handling of malformed/unusual HTML (#34201 by @ClearlyClaire)\n+- Fix `CacheBuster` being queued for missing media attachments (#34253 by @ClearlyClaire)\n+- Fix incorrect URL being used when cache busting (#34189 by @ClearlyClaire)\n+- Fix streaming server refusing unix socket path in `DATABASE_URL` (#34091 by @ClearlyClaire)\n+- Fix \u201cx\u201d hotkey not working on boosted filtered posts (#33758 by @ClearlyClaire)\n+\n ## [4.3.6] - 2025-03-13\n \n ### Security\n---\ndocker-compose.yml\n@@ -59,7 +59,7 @@ services:\n   web:\n     # You can uncomment the following line if you want to not use the prebuilt image, for example if you have local code changes\n     # build: .\n-    image: ghcr.io/mastodon/mastodon:v4.3.6\n+    image: ghcr.io/mastodon/mastodon:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -83,7 +83,7 @@ services:\n     # build:\n     #   dockerfile: ./streaming/Dockerfile\n     #   context: .\n-    image: ghcr.io/mastodon/mastodon-streaming:v4.3.6\n+    image: ghcr.io/mastodon/mastodon-streaming:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: node ./streaming/index.js\n@@ -102,7 +102,7 @@ services:\n   sidekiq:\n     # You can uncomment the following line if you want to not use the prebuilt image, for example if you have local code changes\n     # build: .\n-    image: ghcr.io/mastodon/mastodon:v4.3.6\n+    image: ghcr.io/mastodon/mastodon:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\nlib/mastodon/version.rb\n@@ -13,7 +13,7 @@ def minor\n     end\n \n     def patch\n-      6\n+      7\n     end\n \n     def default_prerelease\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Follow a user on my instance  locally or remote\r\n2.\r\n3.\r\n...\r\n\r\n\r\n### Expected behaviour\r\n\r\nI should be able to locate the user\r\n\r\n### Actual behaviour\r\n\r\nI get a 500 error\r\n\r\n### Detailed description\r\n\r\nThis is as of the nightly and v4.2.1\r\n\r\n```\r\n023-11-20T21:08:50.319420414Z [d62150dd0a2ef6e9757c8140f713b10b] NoMethodError (undefined method `casecmp' for nil:NilClass):\r\n[d62150dd0a2ef6e9757c8140f713b10b]   \r\n2023-11-20T21:08:50.319465476Z [d62150dd0a2ef6e9757c8140f713b10b] app/services/resolve_account_service.rb:87:in `process_webfinger!'\r\n[d62150dd0a2ef6e9757c8140f713b10b] app/services/resolve_account_service.rb:34:in `call'\r\n2023-11-20T21:08:50.319507383Z [d62150dd0a2ef6e9757c8140f713b10b] app/services/account_search_service.rb:172:in `exact_match'\r\n2023-11-20T21:08:50.319528033Z [d62150dd0a2ef6e9757c8140f713b10b] app/services/account_search_service.rb:163:in `search_service_results'\r\n2023-11-20T21:08:50.319549412Z [d62150dd0a2ef6e9757c8140f713b10b] app/services/account_search_service.rb:155:in `call'\r\n2023-11-20T21:08:50.319570147Z [d62150dd0a2ef6e9757c8140f713b10b] app/services/search_service.rb:31:in `perform_accounts_search!'\r\n2023-11-20T21:08:50.319616214Z [d62150dd0a2ef6e9757c8140f713b10b] app/services/search_service.rb:21:in `block in call'\r\n2023-11-20T21:08:50.319637546Z [d62150dd0a2ef6e9757c8140f713b10b] app/services/search_service.rb:15:in `call'\r\n[d62150dd0a2ef6e9757c8140f713b10b] app/controllers/api/v2/search_controller.rb:33:in `search_results'\r\n2023-11-20T21:08:50.319678016Z [d62150dd0a2ef6e9757c8140f713b10b] app/controllers/api/v2/search_controller.rb:12:in `index'\r\n2023-11-20T21:08:50.319698481Z [d62150dd0a2ef6e9757c8140f713b10b] app/controllers/concerns/localized.rb:11:in `set_locale'\r\n2023-11-20T21:08:50.319718803Z [d62150dd0a2ef6e9757c8140f713b10b] lib/mastodon/rack_middleware.rb:9:in `call'\r\n[d62150dd0a2ef6e9757c8140f713b10b] lib/public_file_server_middleware.rb:18:in `call'\r\n\r\n```\r\n\r\n### Mastodon instance\r\n\r\nan internal test instance\r\n\r\n### Mastodon version\r\n\r\nnightly 2023-11-20, confirmed on v4.2.1\r\n\r\n### Technical details\r\n\r\nI use the containers.\n\n---\n\nChoice A:\napp/javascript/mastodon/features/getting_started/index.jsx\n@@ -11,6 +11,7 @@ import { connect } from 'react-redux';\n \n import AlternateEmailIcon from '@/material-icons/400-24px/alternate_email.svg?react';\n import BookmarksIcon from '@/material-icons/400-24px/bookmarks-fill.svg?react';\n+import ExploreIcon from '@/material-icons/400-24px/explore.svg?react';\n import PeopleIcon from '@/material-icons/400-24px/group.svg?react';\n import HomeIcon from '@/material-icons/400-24px/home-fill.svg?react';\n import ListAltIcon from '@/material-icons/400-24px/list_alt.svg?react';\n@@ -19,7 +20,6 @@ import PersonAddIcon from '@/material-icons/400-24px/person_add.svg?react';\n import PublicIcon from '@/material-icons/400-24px/public.svg?react';\n import SettingsIcon from '@/material-icons/400-24px/settings-fill.svg?react';\n import StarIcon from '@/material-icons/400-24px/star.svg?react';\n-import TagIcon from '@/material-icons/400-24px/tag.svg?react';\n import { fetchFollowRequests } from 'mastodon/actions/accounts';\n import Column from 'mastodon/components/column';\n import ColumnHeader from 'mastodon/components/column_header';\n@@ -112,7 +112,7 @@ class GettingStarted extends ImmutablePureComponent {\n \n     if (showTrends) {\n       navItems.push(\n-        <ColumnLink key='explore' icon='explore' iconComponent={TagIcon} text={intl.formatMessage(messages.explore)} to='/explore' />,\n+        <ColumnLink key='explore' icon='explore' iconComponent={ExploreIcon} text={intl.formatMessage(messages.explore)} to='/explore' />,\n       );\n     }\n \n---\n\n\n---\n\nChoice B:\napp/lib/link_details_extractor.rb\n@@ -101,7 +101,7 @@ def root_array(root)\n     end\n \n     def json\n-      @json ||= root_array(Oj.load(@data)).find { |obj| SUPPORTED_TYPES.include?(obj['@type']) } || {}\n+      @json ||= root_array(Oj.load(@data)).compact.find { |obj| SUPPORTED_TYPES.include?(obj['@type']) } || {}\n     end\n   end\n \n---\nspec/lib/link_details_extractor_spec.rb\n@@ -129,6 +129,24 @@\n       include_examples 'structured data'\n     end\n \n+    context 'with the first tag is null' do\n+      let(:html) { <<~HTML }\n+        <!doctype html>\n+        <html>\n+        <body>\n+          <script type=\"application/ld+json\">\n+            null\n+          </script>\n+          <script type=\"application/ld+json\">\n+            #{ld_json}\n+          </script>\n+        </body>\n+        </html>\n+      HTML\n+\n+      include_examples 'structured data'\n+    end\n+\n     context 'with preceding block of unsupported LD+JSON' do\n       let(:html) { <<~HTML }\n         <!doctype html>\n---\n\n\n---\n\nChoice C:\napp/services/resolve_account_service.rb\n@@ -100,7 +100,9 @@ def process_webfinger!(uri)\n   end\n \n   def split_acct(acct)\n-    acct.delete_prefix('acct:').split('@')\n+    acct.delete_prefix('acct:').split('@').tap do |parts|\n+      raise Webfinger::Error, 'Webfinger response is missing user or host value' unless parts.size == 2\n+    end\n   end\n \n   def fetch_account!\n---\nspec/services/resolve_account_service_spec.rb\n@@ -144,6 +144,19 @@\n     end\n   end\n \n+  context 'with webfinger response subject missing a host value' do\n+    let(:body) { Oj.dump({ subject: 'user@' }) }\n+    let(:url) { 'https://host.example/.well-known/webfinger?resource=acct:user@host.example' }\n+\n+    before do\n+      stub_request(:get, url).to_return(status: 200, body: body)\n+    end\n+\n+    it 'returns nil with incomplete subject in response' do\n+      expect(subject.call('user@host.example')).to be_nil\n+    end\n+  end\n+\n   context 'with an ActivityPub account' do\n     it 'returns new remote account' do\n       account = subject.call('foo@ap.example.com')\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/notifications_v2/components/notification_with_status.tsx\n@@ -13,6 +13,7 @@ import {\n import type { IconProp } from 'mastodon/components/icon';\n import { Icon } from 'mastodon/components/icon';\n import Status from 'mastodon/containers/status_container';\n+import { getStatusHidden } from 'mastodon/selectors/filters';\n import { useAppSelector, useAppDispatch } from 'mastodon/store';\n \n import { DisplayedName } from './displayed_name';\n@@ -48,6 +49,12 @@ export const NotificationWithStatus: React.FC<{\n     (state) => state.statuses.getIn([statusId, 'visibility']) === 'direct',\n   );\n \n+  const isFiltered = useAppSelector(\n+    (state) =>\n+      statusId &&\n+      getStatusHidden(state, { id: statusId, contextType: 'notifications' }),\n+  );\n+\n   const handlers = useMemo(\n     () => ({\n       open: () => {\n@@ -73,7 +80,7 @@ export const NotificationWithStatus: React.FC<{\n     [dispatch, statusId],\n   );\n \n-  if (!statusId) return null;\n+  if (!statusId || isFiltered) return null;\n \n   return (\n     <HotKeys handlers={handlers}>\n---\napp/javascript/mastodon/selectors/filters.ts\n@@ -0,0 +1,50 @@\n+import { createSelector } from '@reduxjs/toolkit';\n+\n+import type { RootState } from 'mastodon/store';\n+import { toServerSideType } from 'mastodon/utils/filters';\n+\n+// TODO: move to `app/javascript/mastodon/models` and use more globally\n+type Filter = Immutable.Map<string, unknown>;\n+\n+// TODO: move to `app/javascript/mastodon/models` and use more globally\n+type FilterResult = Immutable.Map<string, unknown>;\n+\n+export const getFilters = createSelector(\n+  [\n+    (state: RootState) => state.filters as Immutable.Map<string, Filter>,\n+    (_, { contextType }: { contextType: string }) => contextType,\n+  ],\n+  (filters, contextType) => {\n+    if (!contextType) {\n+      return null;\n+    }\n+\n+    const now = new Date();\n+    const serverSideType = toServerSideType(contextType);\n+\n+    return filters.filter((filter) => {\n+      const context = filter.get('context') as Immutable.List<string>;\n+      const expiration = filter.get('expires_at') as Date | null;\n+      return (\n+        context.includes(serverSideType) &&\n+        (expiration === null || expiration > now)\n+      );\n+    });\n+  },\n+);\n+\n+export const getStatusHidden = (\n+  state: RootState,\n+  { id, contextType }: { id: string; contextType: string },\n+) => {\n+  const filters = getFilters(state, { contextType });\n+  if (filters === null) return false;\n+\n+  const filtered = state.statuses.getIn([id, 'filtered']) as\n+    | Immutable.List<FilterResult>\n+    | undefined;\n+  return filtered?.some(\n+    (result) =>\n+      filters.getIn([result.get('filter'), 'filter_action']) === 'hide',\n+  );\n+};\n---\napp/javascript/mastodon/selectors/index.js\n@@ -1,22 +1,11 @@\n import { createSelector } from '@reduxjs/toolkit';\n import { List as ImmutableList, Map as ImmutableMap } from 'immutable';\n \n-import { toServerSideType } from 'mastodon/utils/filters';\n-\n import { me } from '../initial_state';\n \n-export { makeGetAccount } from \"./accounts\";\n-\n-const getFilters = createSelector([state => state.get('filters'), (_, { contextType }) => contextType], (filters, contextType) => {\n-  if (!contextType) {\n-    return null;\n-  }\n+import { getFilters } from './filters';\n \n-  const now = new Date();\n-  const serverSideType = toServerSideType(contextType);\n-\n-  return filters.filter(filter => filter.get('context').includes(serverSideType) && (filter.get('expires_at') === null || filter.get('expires_at') > now));\n-});\n+export { makeGetAccount } from \"./accounts\";\n \n export const makeGetStatus = () => {\n   return createSelector(\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Try to mute a user\r\n\r\n### Expected behaviour\r\n\r\nUser is muted\r\n\r\n### Actual behaviour\r\n\r\n\"Oops, an expected error has occurred\"\r\n(It appears the user is also then muted.)\r\n\r\n### Detailed description\r\n\r\n_No response_\r\n\r\n### Mastodon instance\r\n\r\nvmst.io, mastodon.online\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-alpha.0, v4.3.0-nightly.2023-11-19\r\n\r\n### Browser name and version\r\n\r\nSafari\r\n\r\n### Operating system\r\n\r\nmacOS\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/emoji/unicode_to_filename.js\n@@ -1,29 +0,0 @@\n-/* eslint-disable import/no-commonjs --\n-   We need to use CommonJS here as its imported into a preval file (`emoji_compressed.js`) */\n-\n-// taken from:\n-// https://github.com/twitter/twemoji/blob/47732c7/twemoji-generator.js#L848-L866\n-exports.unicodeToFilename = (str) => {\n-  let result = '';\n-  let charCode = 0;\n-  let p = 0;\n-  let i = 0;\n-  while (i < str.length) {\n-    charCode = str.charCodeAt(i++);\n-    if (p) {\n-      if (result.length > 0) {\n-        result += '-';\n-      }\n-      result += (0x10000 + ((p - 0xD800) << 10) + (charCode - 0xDC00)).toString(16);\n-      p = 0;\n-    } else if (0xD800 <= charCode && charCode <= 0xDBFF) {\n-      p = charCode;\n-    } else {\n-      if (result.length > 0) {\n-        result += '-';\n-      }\n-      result += charCode.toString(16);\n-    }\n-  }\n-  return result;\n-};\n---\napp/javascript/mastodon/features/emoji/unicode_to_unified_name.js\n@@ -1,24 +0,0 @@\n-/* eslint-disable import/no-commonjs --\n-   We need to use CommonJS here as its imported into a preval file (`emoji_compressed.js`) */\n-\n-function padLeft(str, num) {\n-  while (str.length < num) {\n-    str = '0' + str;\n-  }\n-\n-  return str;\n-}\n-\n-exports.unicodeToUnifiedName = (str) => {\n-  let output = '';\n-\n-  for (let i = 0; i < str.length; i += 2) {\n-    if (i > 0) {\n-      output += '-';\n-    }\n-\n-    output += padLeft(str.codePointAt(i).toString(16).toUpperCase(), 4);\n-  }\n-\n-  return output;\n-};\n---\napp/javascript/styles/mailer.scss\n@@ -253,7 +253,7 @@ h5 {\n \n .input {\n   td {\n-    background: darken($ui-base-color, 8%);\n+    background: #ffffff;\n     border-radius: 4px;\n     padding: 16px;\n     line-height: 20px;\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/components/edited_timestamp/index.jsx\n@@ -67,7 +67,7 @@ class EditedTimestamp extends PureComponent {\n     return (\n       <DropdownMenu statusId={statusId} renderItem={this.renderItem} scrollable renderHeader={this.renderHeader} onItemClick={this.handleItemClick}>\n         <button className='dropdown-menu__text-button'>\n-          <FormattedMessage id='status.edited' defaultMessage='Edited {date}' values={{ date: intl.formatDate(timestamp, { hour12: false, month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) }} /> <Icon id='caret-down' icon={ArrowDropDownIcon} />\n+          <FormattedMessage id='status.edited' defaultMessage='Edited {date}' values={{ date: intl.formatDate(timestamp, { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) }} /> <Icon id='caret-down' icon={ArrowDropDownIcon} />\n         </button>\n       </DropdownMenu>\n     );\n---\napp/javascript/mastodon/components/relative_timestamp.tsx\n@@ -53,7 +53,6 @@ const messages = defineMessages({\n });\n \n const dateFormatOptions = {\n-  hour12: false,\n   year: 'numeric',\n   month: 'short',\n   day: '2-digit',\n---\napp/javascript/mastodon/components/status.jsx\n@@ -554,7 +554,7 @@ class Status extends ImmutablePureComponent {\n             <div onClick={this.handleClick} className='status__info'>\n               <a href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} className='status__relative-time' target='_blank' rel='noopener noreferrer'>\n                 <span className='status__visibility-icon'><VisibilityIcon visibility={status.get('visibility')} /></span>\n-                <RelativeTimestamp timestamp={status.get('created_at')} />{status.get('edited_at') && <abbr title={intl.formatMessage(messages.edited, { date: intl.formatDate(status.get('edited_at'), { hour12: false, year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) })}> *</abbr>}\n+                <RelativeTimestamp timestamp={status.get('created_at')} />{status.get('edited_at') && <abbr title={intl.formatMessage(messages.edited, { date: intl.formatDate(status.get('edited_at'), { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) })}> *</abbr>}\n               </a>\n \n               <a onClick={this.handleAccountClick} href={`/@${status.getIn(['account', 'acct'])}`} title={status.getIn(['account', 'acct'])} className='status__display-name' target='_blank' rel='noopener noreferrer'>\n---\napp/javascript/mastodon/features/account/components/header.jsx\n@@ -101,7 +101,6 @@ const dateFormatOptions = {\n   month: 'short',\n   day: 'numeric',\n   year: 'numeric',\n-  hour12: false,\n   hour: '2-digit',\n   minute: '2-digit',\n };\n---\napp/javascript/mastodon/features/getting_started/components/announcements.jsx\n@@ -343,7 +343,7 @@ class Announcement extends ImmutablePureComponent {\n       <div className='announcements__item'>\n         <strong className='announcements__item__range'>\n           <FormattedMessage id='announcement.announcement' defaultMessage='Announcement' />\n-          {hasTimeRange && <span> \u00b7 <FormattedDate value={startsAt} hour12={false} year={(skipYear || startsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month='short' day='2-digit' hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /> - <FormattedDate value={endsAt} hour12={false} year={(skipYear || endsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month={skipEndDate ? undefined : 'short'} day={skipEndDate ? undefined : '2-digit'} hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /></span>}\n+          {hasTimeRange && <span> \u00b7 <FormattedDate value={startsAt} year={(skipYear || startsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month='short' day='2-digit' hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /> - <FormattedDate value={endsAt} year={(skipYear || endsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month={skipEndDate ? undefined : 'short'} day={skipEndDate ? undefined : '2-digit'} hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /></span>}\n         </strong>\n \n         <Content announcement={announcement} />\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -311,7 +311,7 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n-              <FormattedDate value={new Date(status.get('created_at'))} hour12={false} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n+              <FormattedDate value={new Date(status.get('created_at'))} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n             </a>{edited}{visibilityLink}{applicationLink}{reblogLink} \u00b7 {favouriteLink}\n           </div>\n         </div>\n---\napp/javascript/packs/public.jsx\n@@ -65,7 +65,6 @@ function loaded() {\n \n   const timeFormat = new Intl.DateTimeFormat(locale, {\n     timeStyle: 'short',\n-    hour12: false,\n   });\n \n   const formatMessage = ({ id, defaultMessage }, values) => {\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/reducers/notifications.js\n@@ -281,7 +281,7 @@ export default function notifications(state = initialState, action) {\n   case blockAccountSuccess.type:\n     return filterNotifications(state, [action.payload.relationship.id]);\n   case muteAccountSuccess.type:\n-    return action.relationship.muting_notifications ? filterNotifications(state, [action.payload.relationship.id]) : state;\n+    return action.payload.relationship.muting_notifications ? filterNotifications(state, [action.payload.relationship.id]) : state;\n   case blockDomainSuccess.type:\n     return filterNotifications(state, action.payload.accounts);\n   case authorizeFollowRequestSuccess.type:\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -7580,7 +7580,7 @@ a.status-card {\n   }\n }\n \n-.radio-button.checked::before {\n+.radio-button__input.checked::before {\n   position: absolute;\n   left: 2px;\n   top: 2px;\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Optionally switch to a language that has relatively long description lines (I saw Japanese).\r\n2. Go to the \u201cYou\u2019ve made it\u201d page (URL path /start).\r\n3. Reduce browser width so the main column is narrow. \r\n4. See the steps description lines (e.g. \u201cBoost your interactions by having...\u201d).\n\n### Expected behaviour\n\nDescription text wraps and takes up two or more lines if the width is not enough.\n\n### Actual behaviour\n\nThe latter part of description lines are ellipsized and there is no way to read the entire text.\n\n### Detailed description\n\nEllipsis is OK only when the text is an excerpt of what you will get after a click, but these descriptions are supposed to be read right here, so it doesn\u2019t make sense to be cut off. Removing `white-space: nowrap` (and optionally other related rules) from the stylesheet will fix this.\n\n### Mastodon instance\n\nmofu.kemo.no with the custom CSS disabled\n\n### Mastodon version\n\nv4.2.1\n\n### Browser name and version\n\nGoogle Chrome 116.0.5845.187\n\n### Operating system\n\nmacOS 10.13.6\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\nlib/paperclip/response_with_limit_adapter.rb\n@@ -16,7 +16,7 @@ def initialize(target, options = {})\n     private\n \n     def cache_current_values\n-      @original_filename = filename_from_content_disposition.presence || filename_from_path.presence || 'data'\n+      @original_filename = truncated_filename\n       @tempfile = copy_to_tempfile(@target)\n       @content_type = ContentTypeDetector.new(@tempfile.path).detect\n       @size = File.size(@tempfile)\n@@ -43,6 +43,13 @@ def copy_to_tempfile(source)\n       source.response.connection.close\n     end\n \n+    def truncated_filename\n+      filename = filename_from_content_disposition.presence || filename_from_path.presence || 'data'\n+      extension = File.extname(filename)\n+      basename = File.basename(filename, extension)\n+      [basename[...20], extension[..4]].compact_blank.join\n+    end\n+\n     def filename_from_content_disposition\n       disposition = @target.response.headers['content-disposition']\n       disposition&.match(/filename=\"([^\"]*)\"/)&.captures&.first\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -2732,22 +2732,16 @@ $ui-header-height: 55px;\n     &__description {\n       flex: 1 1 auto;\n       line-height: 20px;\n-      white-space: nowrap;\n-      text-overflow: ellipsis;\n-      overflow: hidden;\n \n       h6 {\n         color: $highlight-text-color;\n         font-weight: 500;\n         font-size: 14px;\n-        overflow: hidden;\n-        text-overflow: ellipsis;\n       }\n \n       p {\n         color: $darker-text-color;\n         overflow: hidden;\n-        text-overflow: ellipsis;\n       }\n     }\n   }\n---\n\n\n---\n\nChoice C:\nconfig/application.rb\n@@ -64,13 +64,6 @@ class Application < Rails::Application\n     # Initialize configuration defaults for originally generated Rails version.\n     config.load_defaults 7.0\n \n-    # TODO: Release a version which uses the 7.0 defaults as specified above,\n-    # but preserves the 6.1 cache format as set below. In a subsequent change,\n-    # remove this line setting to 6.1 cache format, and then release another version.\n-    # https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#new-activesupport-cache-serialization-format\n-    # https://github.com/mastodon/mastodon/pull/24241#discussion_r1162890242\n-    config.active_support.cache_format_version = 6.1\n-\n     # Please, add to the `ignore` list any other `lib` subdirectories that do\n     # not contain `.rb` files, or that should not be reloaded or eager loaded.\n     # Common ones are `templates`, `generators`, or `middleware`, for example.\n---\n\n\n---\n\nChoice D:\napp/helpers/application_helper.rb\n@@ -240,11 +240,16 @@ def prerender_custom_emojis(html, custom_emojis, other_options = {})\n     EmojiFormatter.new(html, custom_emojis, other_options.merge(animate: prefers_autoplay?)).to_s\n   end\n \n-  def site_icon_path(type, size = '48')\n-    icon = SiteUpload.find_by(var: type)\n-    return nil unless icon\n+  def instance_presenter\n+    @instance_presenter ||= InstancePresenter.new\n+  end\n+\n+  def favicon_path(size = '48')\n+    instance_presenter.favicon&.file&.url(size)\n+  end\n \n-    icon.file.url(size)\n+  def app_icon_path(size = '48')\n+    instance_presenter.app_icon&.file&.url(size)\n   end\n \n   private\n---\napp/presenters/instance_presenter.rb\n@@ -81,4 +81,16 @@ def thumbnail\n   def mascot\n     @mascot ||= Rails.cache.fetch('site_uploads/mascot') { SiteUpload.find_by(var: 'mascot') }\n   end\n+\n+  def favicon\n+    return @favicon if defined?(@favicon)\n+\n+    @favicon ||= Rails.cache.fetch('site_uploads/favicon') { SiteUpload.find_by(var: 'favicon') }\n+  end\n+\n+  def app_icon\n+    return @app_icon if defined?(@app_icon)\n+\n+    @app_icon ||= Rails.cache.fetch('site_uploads/app_icon') { SiteUpload.find_by(var: 'app_icon') }\n+  end\n end\n---\napp/serializers/manifest_serializer.rb\n@@ -27,7 +27,7 @@ def short_name\n \n   def icons\n     SiteUpload::ANDROID_ICON_SIZES.map do |size|\n-      src = site_icon_path('app_icon', size.to_i)\n+      src = app_icon_path(size.to_i)\n       src = URI.join(root_url, src).to_s if src.present?\n \n       {\n---\napp/views/layouts/application.html.haml\n@@ -11,13 +11,13 @@\n     - if storage_host?\n       %link{ rel: 'dns-prefetch', href: storage_host }/\n \n-    %link{ rel: 'icon', href: site_icon_path('favicon', 'ico') || '/favicon.ico', type: 'image/x-icon' }/\n+    %link{ rel: 'icon', href: favicon_path('ico') || '/favicon.ico', type: 'image/x-icon' }/\n \n     - SiteUpload::FAVICON_SIZES.each do |size|\n-      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: site_icon_path('favicon', size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n+      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: favicon_path(size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n \n     - SiteUpload::APPLE_ICON_SIZES.each do |size|\n-      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: site_icon_path('app_icon', size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n+      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: app_icon_path(size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n \n     %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n     %link{ rel: 'manifest', href: manifest_path(format: :json) }/\n---\nspec/helpers/application_helper_spec.rb\n@@ -286,26 +286,31 @@ def current_theme = 'default'\n     end\n   end\n \n-  describe '#site_icon_path' do\n+  describe 'favicon' do\n     context 'when an icon exists' do\n       let!(:favicon) { Fabricate(:site_upload, var: 'favicon') }\n+      let!(:app_icon) { Fabricate(:site_upload, var: 'app_icon') }\n \n       it 'returns the URL of the icon' do\n-        expect(helper.site_icon_path('favicon')).to eq(favicon.file.url('48'))\n+        expect(helper.favicon_path).to eq(favicon.file.url('48'))\n+        expect(helper.app_icon_path).to eq(app_icon.file.url('48'))\n       end\n \n       it 'returns the URL of the icon with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to eq(favicon.file.url('16'))\n+        expect(helper.favicon_path(16)).to eq(favicon.file.url('16'))\n+        expect(helper.app_icon_path(16)).to eq(app_icon.file.url('16'))\n       end\n     end\n \n     context 'when an icon does not exist' do\n       it 'returns nil' do\n-        expect(helper.site_icon_path('favicon')).to be_nil\n+        expect(helper.favicon_path).to be_nil\n+        expect(helper.app_icon_path).to be_nil\n       end\n \n       it 'returns nil with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to be_nil\n+        expect(helper.favicon_path(16)).to be_nil\n+        expect(helper.app_icon_path(16)).to be_nil\n       end\n     end\n   end\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. If you are using the Dark theme, switch to the Light theme.\r\n2. Open the dropdown menu of one of your posts and look at the \u201cDelete\u201d option.\n\n### Expected behaviour\n\nThe menu item is in red.\n\n### Actual behaviour\n\nThe menu item is in black just like others.\n\n### Detailed description\n\nNot limited to the \u201cDelete\u201d option, all \u201cdangerous\u201d menu items that are supposed to be red are not differentiated in the Light theme.\n\n### Mastodon instance\n\nmofu.kemo.no with the custom CSS disabled\n\n### Mastodon version\n\nv4.2.1\n\n### Browser name and version\n\nGoogle Chrome 116.0.5845.187\n\n### Operating system\n\nmacOS 10.13.6\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/emoji/unicode_to_filename.js\n@@ -1,29 +0,0 @@\n-/* eslint-disable import/no-commonjs --\n-   We need to use CommonJS here as its imported into a preval file (`emoji_compressed.js`) */\n-\n-// taken from:\n-// https://github.com/twitter/twemoji/blob/47732c7/twemoji-generator.js#L848-L866\n-exports.unicodeToFilename = (str) => {\n-  let result = '';\n-  let charCode = 0;\n-  let p = 0;\n-  let i = 0;\n-  while (i < str.length) {\n-    charCode = str.charCodeAt(i++);\n-    if (p) {\n-      if (result.length > 0) {\n-        result += '-';\n-      }\n-      result += (0x10000 + ((p - 0xD800) << 10) + (charCode - 0xDC00)).toString(16);\n-      p = 0;\n-    } else if (0xD800 <= charCode && charCode <= 0xDBFF) {\n-      p = charCode;\n-    } else {\n-      if (result.length > 0) {\n-        result += '-';\n-      }\n-      result += charCode.toString(16);\n-    }\n-  }\n-  return result;\n-};\n---\napp/javascript/mastodon/features/emoji/unicode_to_unified_name.js\n@@ -1,24 +0,0 @@\n-/* eslint-disable import/no-commonjs --\n-   We need to use CommonJS here as its imported into a preval file (`emoji_compressed.js`) */\n-\n-function padLeft(str, num) {\n-  while (str.length < num) {\n-    str = '0' + str;\n-  }\n-\n-  return str;\n-}\n-\n-exports.unicodeToUnifiedName = (str) => {\n-  let output = '';\n-\n-  for (let i = 0; i < str.length; i += 2) {\n-    if (i > 0) {\n-      output += '-';\n-    }\n-\n-    output += padLeft(str.codePointAt(i).toString(16).toUpperCase(), 4);\n-  }\n-\n-  return output;\n-};\n---\napp/javascript/styles/mailer.scss\n@@ -253,7 +253,7 @@ h5 {\n \n .input {\n   td {\n-    background: darken($ui-base-color, 8%);\n+    background: #ffffff;\n     border-radius: 4px;\n     padding: 16px;\n     line-height: 20px;\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -300,10 +300,15 @@ html {\n   }\n \n   &__item {\n+    color: $darker-text-color;\n+\n+    &--dangerous {\n+      color: $error-value-color;\n+    }\n+\n     a,\n     button {\n       background: $white;\n-      color: $darker-text-color;\n     }\n   }\n }\n@@ -315,9 +320,9 @@ html {\n .privacy-dropdown__option.active .privacy-dropdown__option__content strong,\n .privacy-dropdown__option:hover .privacy-dropdown__option__content,\n .privacy-dropdown__option:hover .privacy-dropdown__option__content strong,\n-.dropdown-menu__item a:active,\n-.dropdown-menu__item a:focus,\n-.dropdown-menu__item a:hover,\n+.dropdown-menu__item:not(.dropdown-menu__item--dangerous) a:active,\n+.dropdown-menu__item:not(.dropdown-menu__item--dangerous) a:focus,\n+.dropdown-menu__item:not(.dropdown-menu__item--dangerous) a:hover,\n .actions-modal ul li:not(:empty) a.active,\n .actions-modal ul li:not(:empty) a.active button,\n .actions-modal ul li:not(:empty) a:active,\n---\n\n\n---\n\nChoice C:\napp/controllers/api/v1/accounts/familiar_followers_controller.rb\n@@ -12,7 +12,7 @@ def index\n   private\n \n   def set_accounts\n-    @accounts = Account.without_suspended.where(id: account_ids).select('id, hide_collections').index_by(&:id).values_at(*account_ids).compact\n+    @accounts = Account.without_suspended.where(id: account_ids).select('id, hide_collections')\n   end\n \n   def familiar_followers\n---\napp/controllers/api/v1/accounts/relationships_controller.rb\n@@ -5,11 +5,8 @@ class Api::V1::Accounts::RelationshipsController < Api::BaseController\n   before_action :require_user!\n \n   def index\n-    scope = Account.where(id: account_ids).select('id')\n-    scope.merge!(Account.without_suspended) unless truthy_param?(:with_suspended)\n-    # .where doesn't guarantee that our results are in the same order\n-    # we requested them, so return the \"right\" order to the requestor.\n-    @accounts = scope.index_by(&:id).values_at(*account_ids).compact\n+    @accounts = Account.where(id: account_ids).select('id')\n+    @accounts.merge!(Account.without_suspended) unless truthy_param?(:with_suspended)\n     render json: @accounts, each_serializer: REST::RelationshipSerializer, relationships: relationships\n   end\n \n---\nspec/controllers/api/v1/accounts/familiar_followers_controller_spec.rb\n@@ -19,5 +19,17 @@\n \n       expect(response).to have_http_status(200)\n     end\n+\n+    context 'when there are duplicate account IDs in the params' do\n+      let(:account_a) { Fabricate(:account) }\n+      let(:account_b) { Fabricate(:account) }\n+\n+      it 'removes duplicate account IDs from params' do\n+        account_ids = [account_a, account_b, account_b, account_a, account_a].map { |a| a.id.to_s }\n+        get :index, params: { id: account_ids }\n+\n+        expect(body_as_json.pluck(:id)).to eq [account_a.id.to_s, account_b.id.to_s]\n+      end\n+    end\n   end\n end\n---\nspec/requests/api/v1/accounts/relationships_spec.rb\n@@ -79,6 +79,22 @@\n         end\n       end\n \n+      context 'when there are duplicate IDs in the params' do\n+        let(:params) { { id: [simon.id, lewis.id, lewis.id, lewis.id, simon.id] } }\n+\n+        it 'removes duplicate account IDs from params' do\n+          subject\n+\n+          expect(body_as_json)\n+            .to be_an(Enumerable)\n+            .and have_attributes(\n+              size: 2,\n+              first: include(simon_item),\n+              second: include(lewis_item)\n+            )\n+        end\n+      end\n+\n       def simon_item\n         {\n           id: simon.id.to_s,\n---\n\n\n---\n\nChoice D:\nlib/mastodon/version.rb\n@@ -17,7 +17,7 @@ def patch\n     end\n \n     def flags\n-      ENV.fetch('MASTODON_VERSION_FLAGS', '-beta2')\n+      ENV['MASTODON_VERSION_FLAGS'].presence || '-beta2'\n     end\n \n     def suffix\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Go to user profile: https://[101010.pl](https://101010.pl/@grzgrz)/@grzgrz\r\n\r\n\r\n### Expected behaviour\r\n\r\nOpen Profile\r\n\r\n### Actual behaviour\r\n\r\nError\r\n\r\n### Detailed description\r\n\r\n_No response_\r\n\r\n### Mastodon instance\r\n\r\n101010.pl\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-alpha.0\r\n\r\n### Browser name and version\r\n\r\nEdge 119.0.2151.44\r\n\r\n### Operating system\r\n\r\nWindows 11\r\n\r\n### Technical details\r\n\r\nTypeError: Cannot set properties of undefined (setting 'volume')\r\n_syncVideoToVolumeState (webpack:///app/javascript/mastodon/features/video/index.jsx:449:24)\r\n_syncVideoFromLocalStorage (webpack:///app/javascript/mastodon/features/video/index.jsx:460:11)\r\nih (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:144:188)\r\nlk (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:261:421)\r\njk (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:260:445)\r\nfk (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:259:430)\r\nXk (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:283:95)\r\nTk (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:281:400)\r\nDk (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:273:438)\r\njg (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:127:104)\n\n---\n\nChoice A:\napp/javascript/mastodon/features/video/index.jsx\n@@ -469,6 +469,10 @@ class Video extends PureComponent {\n   };\n \n   _syncVideoToVolumeState = (volume = null, muted = null) => {\n+    if (!this.video) {\n+      return;\n+    }\n+\n     this.video.volume = volume ?? this.state.volume;\n     this.video.muted = muted ?? this.state.muted;\n   };\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -4389,7 +4389,7 @@ a.status-card.compact:hover {\n }\n \n .relationship-tag {\n-  color: $primary-text-color;\n+  color: $white;\n   margin-bottom: 4px;\n   display: block;\n   background-color: rgba($black, 0.45);\n---\n\n\n---\n\nChoice C:\nspec/lib/mastodon/cli/accounts_spec.rb\n@@ -1356,4 +1356,77 @@ def stub_parallelize_with_progress!\n       end\n     end\n   end\n+\n+  describe '#prune' do\n+    let!(:local_account)     { Fabricate(:account) }\n+    let!(:bot_account)       { Fabricate(:account, bot: true, domain: 'example.com') }\n+    let!(:group_account)     { Fabricate(:account, actor_type: 'Group', domain: 'example.com') }\n+    let!(:mentioned_account) { Fabricate(:account, domain: 'example.com') }\n+    let!(:prunable_accounts) do\n+      Fabricate.times(3, :account, domain: 'example.com', bot: false, suspended_at: nil, silenced_at: nil)\n+    end\n+\n+    before do\n+      Fabricate(:mention, account: mentioned_account, status: Fabricate(:status, account: Fabricate(:account)))\n+      stub_parallelize_with_progress!\n+    end\n+\n+    it 'prunes all remote accounts with no interactions with local users' do\n+      cli.prune\n+\n+      prunable_account_ids = prunable_accounts.pluck(:id)\n+\n+      expect(Account.where(id: prunable_account_ids).count).to eq(0)\n+    end\n+\n+    it 'displays a successful message' do\n+      expect { cli.prune }.to output(\n+        a_string_including(\"OK, pruned #{prunable_accounts.size} accounts\")\n+      ).to_stdout\n+    end\n+\n+    it 'does not prune local accounts' do\n+      cli.prune\n+\n+      expect(Account.exists?(id: local_account.id)).to be(true)\n+    end\n+\n+    it 'does not prune bot accounts' do\n+      cli.prune\n+\n+      expect(Account.exists?(id: bot_account.id)).to be(true)\n+    end\n+\n+    it 'does not prune group accounts' do\n+      cli.prune\n+\n+      expect(Account.exists?(id: group_account.id)).to be(true)\n+    end\n+\n+    it 'does not prune accounts that have been mentioned' do\n+      cli.prune\n+\n+      expect(Account.exists?(id: mentioned_account.id)).to be true\n+    end\n+\n+    context 'with --dry-run option' do\n+      before do\n+        cli.options = { dry_run: true }\n+      end\n+\n+      it 'does not prune any account' do\n+        cli.prune\n+\n+        prunable_account_ids = prunable_accounts.pluck(:id)\n+\n+        expect(Account.where(id: prunable_account_ids).count).to eq(prunable_accounts.size)\n+      end\n+\n+      it 'displays a successful message with (DRY RUN)' do\n+        expect { cli.prune }.to output(\n+          a_string_including(\"OK, pruned #{prunable_accounts.size} accounts (DRY RUN)\")\n+        ).to_stdout\n+      end\n+    end\n+  end\n end\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -3611,6 +3611,7 @@ $ui-header-logo-wordmark-width: 99px;\n   overflow-y: auto;\n   width: 100%;\n   height: 100%;\n+  z-index: 0;\n }\n \n .drawer__inner__mastodon {\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nv4.3.0-nightly.2023-11-07 (docker image)\r\n`tootctl cache clear ` and `tootctl media remove-orphans` are both showing the below warning:\r\n\r\n\r\nDEPRECATION WARNING: Support for `config.active_support.cache_format_version = 6.1` has been deprecated and will be removed in Rails 7.2.\r\n\r\nCheck the Rails upgrade guide at https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#new-activesupport-cache-serialization-format\r\nfor more information on how to upgrade.\r\n (called from <main> at /opt/mastodon/config/environment.rb:7)\r\n\n\n### Expected behaviour\n\nrunning without showing warnings\n\n### Actual behaviour\n\nruns with the showed warnings\n\n### Detailed description\n\nsee above \"steps to reproduce\"\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\nv4.3.0-nightly.2023-11-07\n\n### Technical details\n\nimage: ghcr.io/mastodon/mastodon:edge\n\n---\n\nChoice A:\n.browserslistrc\n@@ -1,6 +1,7 @@\n [production]\n defaults\n > 0.2%\n+firefox >= 78\n ios >= 15.6\n not dead\n not OperaMini all\n---\n\n\n---\n\nChoice B:\nconfig/application.rb\n@@ -64,13 +64,6 @@ class Application < Rails::Application\n     # Initialize configuration defaults for originally generated Rails version.\n     config.load_defaults 7.0\n \n-    # TODO: Release a version which uses the 7.0 defaults as specified above,\n-    # but preserves the 6.1 cache format as set below. In a subsequent change,\n-    # remove this line setting to 6.1 cache format, and then release another version.\n-    # https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#new-activesupport-cache-serialization-format\n-    # https://github.com/mastodon/mastodon/pull/24241#discussion_r1162890242\n-    config.active_support.cache_format_version = 6.1\n-\n     # Please, add to the `ignore` list any other `lib` subdirectories that do\n     # not contain `.rb` files, or that should not be reloaded or eager loaded.\n     # Common ones are `templates`, `generators`, or `middleware`, for example.\n---\n\n\n---\n\nChoice C:\napp/helpers/application_helper.rb\n@@ -240,11 +240,16 @@ def prerender_custom_emojis(html, custom_emojis, other_options = {})\n     EmojiFormatter.new(html, custom_emojis, other_options.merge(animate: prefers_autoplay?)).to_s\n   end\n \n-  def site_icon_path(type, size = '48')\n-    icon = SiteUpload.find_by(var: type)\n-    return nil unless icon\n+  def instance_presenter\n+    @instance_presenter ||= InstancePresenter.new\n+  end\n+\n+  def favicon_path(size = '48')\n+    instance_presenter.favicon&.file&.url(size)\n+  end\n \n-    icon.file.url(size)\n+  def app_icon_path(size = '48')\n+    instance_presenter.app_icon&.file&.url(size)\n   end\n \n   private\n---\napp/presenters/instance_presenter.rb\n@@ -81,4 +81,16 @@ def thumbnail\n   def mascot\n     @mascot ||= Rails.cache.fetch('site_uploads/mascot') { SiteUpload.find_by(var: 'mascot') }\n   end\n+\n+  def favicon\n+    return @favicon if defined?(@favicon)\n+\n+    @favicon ||= Rails.cache.fetch('site_uploads/favicon') { SiteUpload.find_by(var: 'favicon') }\n+  end\n+\n+  def app_icon\n+    return @app_icon if defined?(@app_icon)\n+\n+    @app_icon ||= Rails.cache.fetch('site_uploads/app_icon') { SiteUpload.find_by(var: 'app_icon') }\n+  end\n end\n---\napp/serializers/manifest_serializer.rb\n@@ -27,7 +27,7 @@ def short_name\n \n   def icons\n     SiteUpload::ANDROID_ICON_SIZES.map do |size|\n-      src = site_icon_path('app_icon', size.to_i)\n+      src = app_icon_path(size.to_i)\n       src = URI.join(root_url, src).to_s if src.present?\n \n       {\n---\napp/views/layouts/application.html.haml\n@@ -11,13 +11,13 @@\n     - if storage_host?\n       %link{ rel: 'dns-prefetch', href: storage_host }/\n \n-    %link{ rel: 'icon', href: site_icon_path('favicon', 'ico') || '/favicon.ico', type: 'image/x-icon' }/\n+    %link{ rel: 'icon', href: favicon_path('ico') || '/favicon.ico', type: 'image/x-icon' }/\n \n     - SiteUpload::FAVICON_SIZES.each do |size|\n-      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: site_icon_path('favicon', size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n+      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: favicon_path(size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n \n     - SiteUpload::APPLE_ICON_SIZES.each do |size|\n-      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: site_icon_path('app_icon', size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n+      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: app_icon_path(size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n \n     %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n     %link{ rel: 'manifest', href: manifest_path(format: :json) }/\n---\nspec/helpers/application_helper_spec.rb\n@@ -286,26 +286,31 @@ def current_theme = 'default'\n     end\n   end\n \n-  describe '#site_icon_path' do\n+  describe 'favicon' do\n     context 'when an icon exists' do\n       let!(:favicon) { Fabricate(:site_upload, var: 'favicon') }\n+      let!(:app_icon) { Fabricate(:site_upload, var: 'app_icon') }\n \n       it 'returns the URL of the icon' do\n-        expect(helper.site_icon_path('favicon')).to eq(favicon.file.url('48'))\n+        expect(helper.favicon_path).to eq(favicon.file.url('48'))\n+        expect(helper.app_icon_path).to eq(app_icon.file.url('48'))\n       end\n \n       it 'returns the URL of the icon with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to eq(favicon.file.url('16'))\n+        expect(helper.favicon_path(16)).to eq(favicon.file.url('16'))\n+        expect(helper.app_icon_path(16)).to eq(app_icon.file.url('16'))\n       end\n     end\n \n     context 'when an icon does not exist' do\n       it 'returns nil' do\n-        expect(helper.site_icon_path('favicon')).to be_nil\n+        expect(helper.favicon_path).to be_nil\n+        expect(helper.app_icon_path).to be_nil\n       end\n \n       it 'returns nil with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to be_nil\n+        expect(helper.favicon_path(16)).to be_nil\n+        expect(helper.app_icon_path(16)).to be_nil\n       end\n     end\n   end\n---\n\n\n---\n\nChoice D:\napp/models/status.rb\n@@ -266,7 +266,7 @@ def non_sensitive_with_media?\n   end\n \n   def reported?\n-    @reported ||= Report.where(target_account: account).unresolved.exists?(['? = ANY(status_ids)', id])\n+    @reported ||= account.targeted_reports.unresolved.exists?(['? = ANY(status_ids)', id]) || account.strikes.exists?(['? = ANY(status_ids)', id.to_s])\n   end\n \n   def emojis\n---\nspec/models/status_spec.rb\n@@ -205,6 +205,48 @@\n     end\n   end\n \n+  describe '#reported?' do\n+    context 'when the status is not reported' do\n+      it 'returns false' do\n+        expect(subject.reported?).to be false\n+      end\n+    end\n+\n+    context 'when the status is part of an open report' do\n+      before do\n+        Fabricate(:report, target_account: subject.account, status_ids: [subject.id])\n+      end\n+\n+      it 'returns true' do\n+        expect(subject.reported?).to be true\n+      end\n+    end\n+\n+    context 'when the status is part of a closed report with an account warning mentioning the account' do\n+      before do\n+        report = Fabricate(:report, target_account: subject.account, status_ids: [subject.id])\n+        report.resolve!(Fabricate(:account))\n+        Fabricate(:account_warning, target_account: subject.account, status_ids: [subject.id], report: report)\n+      end\n+\n+      it 'returns true' do\n+        expect(subject.reported?).to be true\n+      end\n+    end\n+\n+    context 'when the status is part of a closed report with an account warning not mentioning the account' do\n+      before do\n+        report = Fabricate(:report, target_account: subject.account, status_ids: [subject.id])\n+        report.resolve!(Fabricate(:account))\n+        Fabricate(:account_warning, target_account: subject.account, report: report)\n+      end\n+\n+      it 'returns false' do\n+        expect(subject.reported?).to be false\n+      end\n+    end\n+  end\n+\n   describe '.mutes_map' do\n     subject { described_class.mutes_map([status.conversation.id], account) }\n \n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Set \"Media cache retention period\" to your preferred cleanup period, eg. 7 days\r\n2. Wait a few days and observe logs / media storage size\r\n\r\n\r\n### Expected behaviour\r\n\r\nMedia is cleaned up daily\r\n\r\n### Actual behaviour\r\n\r\nMedia cleanup job fails each day with a timeout error\r\n\r\n### Detailed description\r\n\r\nSince upgrading to v4.2.1 the test server I have this setting enabled on has failed to clean up every day with timeout errors:\r\n\r\n```\r\nOct 21 03:12:07 rabbit bundle[821007]: E, [2023-10-21T03:12:07.202325 #821007] ERROR -- : Error while running Vacuum::MediaAttachmentsVacuum: Net::ReadTimeout with #<TCPSocket:(closed)>\r\nOct 22 03:12:07 rabbit bundle[821007]: E, [2023-10-22T03:12:07.450756 #821007] ERROR -- : Error while running Vacuum::MediaAttachmentsVacuum: Net::ReadTimeout with #<TCPSocket:(closed)>\r\n\r\n[repeats daily]\r\n\r\nNov 05 03:12:08 rabbit bundle[821007]: E, [2023-11-05T03:12:08.555438 #821007] ERROR -- : Error while running Vacuum::MediaAttachmentsVacuum: Net::ReadTimeout with #<TCPSocket:(closed)>\r\nNov 06 03:12:07 rabbit bundle[821007]: E, [2023-11-06T03:12:07.930777 #821007] ERROR -- : Error while running Vacuum::MediaAttachmentsVacuum: Net::ReadTimeout with #<TCPSocket:(closed)>\r\n```\r\n\r\nOn my test server there isn't enough media for this to really matter, but other admins have also reported seeing these timeouts and noted that media is no longer being cleaned up by this setting as it was before upgrading to 4.2 (@rrgeorge , @vmstan )\r\n\r\n### Mastodon instance\r\n\r\nvarious\r\n\r\n### Mastodon version\r\n\r\nv4.2.1\r\n\r\n### Technical details\r\n\r\n- Ruby version: 3.2.2p53\r\n- Node.js version: v16.20.1\r\n\r\nMedia storage on S3, in my case OVH.\n\n---\n\nChoice A:\napp/services/backup_service.rb\n@@ -19,8 +19,8 @@ def call(backup)\n \n   def build_outbox_json!(file)\n     skeleton = serialize(collection_presenter, ActivityPub::CollectionSerializer)\n-    skeleton[:@context] = full_context\n-    skeleton[:orderedItems] = ['!PLACEHOLDER!']\n+    skeleton['@context'] = full_context\n+    skeleton['orderedItems'] = ['!PLACEHOLDER!']\n     skeleton = Oj.dump(skeleton)\n     prepend, append = skeleton.split('\"!PLACEHOLDER!\"')\n     add_comma = false\n---\nspec/services/backup_service_spec.rb\n@@ -55,9 +55,11 @@ def process_backup\n   end\n \n   def expect_outbox_export\n-    json = export_json(:outbox)\n+    body = export_json_raw(:outbox)\n+    json = Oj.load(body)\n \n     aggregate_failures do\n+      expect(body.scan('@context').count).to eq 1\n       expect(json['@context']).to_not be_nil\n       expect(json['type']).to eq 'OrderedCollection'\n       expect(json['totalItems']).to eq 2\n@@ -85,8 +87,12 @@ def expect_bookmarks_export\n     end\n   end\n \n+  def export_json_raw(type)\n+    read_zip_file(backup, \"#{type}.json\")\n+  end\n+\n   def export_json(type)\n-    Oj.load(read_zip_file(backup, \"#{type}.json\"))\n+    Oj.load(export_json_raw(type))\n   end\n \n   def include_create_item(status)\n---\n\n\n---\n\nChoice B:\nconfig/initializers/paperclip.rb\n@@ -64,7 +64,7 @@\n       http_open_timeout: ENV.fetch('S3_OPEN_TIMEOUT') { '5' }.to_i,\n       http_read_timeout: ENV.fetch('S3_READ_TIMEOUT') { '5' }.to_i,\n       http_idle_timeout: 5,\n-      retry_limit: 0,\n+      retry_limit: ENV.fetch('S3_RETRY_LIMIT') { '0' }.to_i,\n     }\n   )\n \n---\nconfig/initializers/paperclip.rb\n@@ -64,7 +64,7 @@\n       http_open_timeout: ENV.fetch('S3_OPEN_TIMEOUT'){ '5' }.to_i,\n       http_read_timeout: ENV.fetch('S3_READ_TIMEOUT'){ '5' }.to_i,\n       http_idle_timeout: 5,\n-      retry_limit: 0,\n+      retry_limit: ENV.fetch('S3_RETRY_LIMIT'){ '0' }.to_i,\n     }\n   )\n   \n---\napp/lib/attachment_batch.rb\n@@ -4,7 +4,8 @@ class AttachmentBatch\n   # Maximum amount of objects you can delete in an S3 API call. It's\n   # important to remember that this does not correspond to the number\n   # of records in the batch, since records can have multiple attachments\n-  LIMIT = 1_000\n+  LIMIT = ENV.fetch('S3_BATCH_DELETE_LIMIT', 1000).to_i\n+  MAX_RETRY = ENV.fetch('S3_BATCH_DELETE_RETRY', 3).to_i\n \n   # Attributes generated and maintained by Paperclip (not all of them\n   # are always used on every class, however)\n@@ -95,13 +96,25 @@ def remove_files\n     # objects can be processed at once, so we have to potentially\n     # separate them into multiple calls.\n \n+    retries = 0\n     keys.each_slice(LIMIT) do |keys_slice|\n       logger.debug { \"Deleting #{keys_slice.size} objects\" }\n \n       bucket.delete_objects(delete: {\n         objects: keys_slice.map { |key| { key: key } },\n         quiet: true,\n       })\n+    rescue => e\n+      retries += 1\n+\n+      if retries < MAX_RETRY\n+        logger.debug \"Retry #{retries}/#{MAX_RETRY} after #{e.message}\"\n+        sleep 2**retries\n+        retry\n+      else\n+        logger.error \"Batch deletion from S3 failed after #{e.message}\"\n+        raise e\n+      end\n     end\n   end\n \n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/account/components/header.jsx\n@@ -265,9 +265,9 @@ class Header extends ImmutablePureComponent {\n       if (signedIn && !account.get('relationship')) { // Wait until the relationship is loaded\n         actionBtn = '';\n       } else if (account.getIn(['relationship', 'requested'])) {\n-        actionBtn = <Button className={classNames({ 'button--with-bell': bellBtn !== '' })} text={intl.formatMessage(messages.cancel_follow_request)} title={intl.formatMessage(messages.requested)} onClick={this.props.onFollow} />;\n+        actionBtn = <Button text={intl.formatMessage(messages.cancel_follow_request)} title={intl.formatMessage(messages.requested)} onClick={this.props.onFollow} />;\n       } else if (!account.getIn(['relationship', 'blocking'])) {\n-        actionBtn = <Button disabled={account.getIn(['relationship', 'blocked_by'])} className={classNames({ 'button--destructive': account.getIn(['relationship', 'following']), 'button--with-bell': bellBtn !== '' })} text={intl.formatMessage(account.getIn(['relationship', 'following']) ? messages.unfollow : messages.follow)} onClick={signedIn ? this.props.onFollow : this.props.onInteractionModal} />;\n+        actionBtn = <Button disabled={account.getIn(['relationship', 'blocked_by'])} className={classNames({ 'button--destructive': account.getIn(['relationship', 'following']) })} text={intl.formatMessage(account.getIn(['relationship', 'following']) ? messages.unfollow : messages.follow)} onClick={signedIn ? this.props.onFollow : this.props.onInteractionModal} />;\n       } else if (account.getIn(['relationship', 'blocking'])) {\n         actionBtn = <Button text={intl.formatMessage(messages.unblock, { name: account.get('username') })} onClick={this.props.onBlock} />;\n       }\n---\napp/javascript/styles/mastodon/components.scss\n@@ -170,11 +170,6 @@\n     display: block;\n     width: 100%;\n   }\n-\n-  .layout-multiple-columns &.button--with-bell {\n-    font-size: 12px;\n-    padding: 0 8px;\n-  }\n }\n \n .column__wrapper {\n---\n\n\n---\n\nChoice D:\nconfig/initializers/cors.rb\n@@ -22,6 +22,7 @@\n                expose: %w(Link X-RateLimit-Reset X-RateLimit-Limit X-RateLimit-Remaining X-Request-Id),\n                methods: %i(post put delete get patch options)\n       resource '/oauth/token', methods: [:post]\n+      resource '/oauth/revoke', methods: [:post]\n     end\n   end\n end\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1.Load [http://localhost:3000/rails/mailers/user_mailer/welcome](url) in development environment\r\n2.\r\n3.\r\n...\r\n\n\n### Expected behaviour\n\nShould be able to see the handle\n\n### Actual behaviour\n\nThe dark text isnt legible\n\n### Detailed description\n\n<img width=\"694\" alt=\"Screenshot 2023-11-05 at 11 22 19 AM\" src=\"https://github.com/mastodon/mastodon/assets/104158369/8f08f3bd-3112-42b6-9c98-f7a012c70b46\">\r\n\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.1.2\n\n### Browser name and version\n\nFirefox 105.0.3\n\n### Operating system\n\nmacOS 13.4.1\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/workers/web/push_notification_worker.rb\n@@ -55,12 +55,8 @@ def web_push_request\n   end\n \n   def push_notification_json\n-    Oj.dump(serialized_notification_in_subscription_locale.as_json)\n-  end\n-\n-  def serialized_notification_in_subscription_locale\n     I18n.with_locale(@subscription.locale.presence || I18n.default_locale) do\n-      serialized_notification\n+      Oj.dump(serialized_notification.as_json)\n     end\n   end\n \n---\n\n\n---\n\nChoice B:\napp/models/custom_emoji.rb\n@@ -39,7 +39,7 @@ class CustomEmoji < ApplicationRecord\n \n   has_one :local_counterpart, -> { where(domain: nil) }, class_name: 'CustomEmoji', primary_key: :shortcode, foreign_key: :shortcode, inverse_of: false, dependent: nil\n \n-  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' } }, validate_media_type: false\n+  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp', file_geometry_parser: FastGeometryParser } }, validate_media_type: false, processors: [:lazy_thumbnail]\n \n   normalizes :domain, with: ->(domain) { domain.downcase }\n \n---\nspec/models/custom_emoji_spec.rb\n@@ -2,7 +2,7 @@\n \n require 'rails_helper'\n \n-RSpec.describe CustomEmoji do\n+RSpec.describe CustomEmoji, :paperclip_processing do\n   describe '#search' do\n     subject { described_class.search(search_term) }\n \n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/emoji/unicode_to_filename.js\n@@ -1,29 +0,0 @@\n-/* eslint-disable import/no-commonjs --\n-   We need to use CommonJS here as its imported into a preval file (`emoji_compressed.js`) */\n-\n-// taken from:\n-// https://github.com/twitter/twemoji/blob/47732c7/twemoji-generator.js#L848-L866\n-exports.unicodeToFilename = (str) => {\n-  let result = '';\n-  let charCode = 0;\n-  let p = 0;\n-  let i = 0;\n-  while (i < str.length) {\n-    charCode = str.charCodeAt(i++);\n-    if (p) {\n-      if (result.length > 0) {\n-        result += '-';\n-      }\n-      result += (0x10000 + ((p - 0xD800) << 10) + (charCode - 0xDC00)).toString(16);\n-      p = 0;\n-    } else if (0xD800 <= charCode && charCode <= 0xDBFF) {\n-      p = charCode;\n-    } else {\n-      if (result.length > 0) {\n-        result += '-';\n-      }\n-      result += charCode.toString(16);\n-    }\n-  }\n-  return result;\n-};\n---\napp/javascript/mastodon/features/emoji/unicode_to_unified_name.js\n@@ -1,24 +0,0 @@\n-/* eslint-disable import/no-commonjs --\n-   We need to use CommonJS here as its imported into a preval file (`emoji_compressed.js`) */\n-\n-function padLeft(str, num) {\n-  while (str.length < num) {\n-    str = '0' + str;\n-  }\n-\n-  return str;\n-}\n-\n-exports.unicodeToUnifiedName = (str) => {\n-  let output = '';\n-\n-  for (let i = 0; i < str.length; i += 2) {\n-    if (i > 0) {\n-      output += '-';\n-    }\n-\n-    output += padLeft(str.codePointAt(i).toString(16).toUpperCase(), 4);\n-  }\n-\n-  return output;\n-};\n---\napp/javascript/styles/mailer.scss\n@@ -253,7 +253,7 @@ h5 {\n \n .input {\n   td {\n-    background: darken($ui-base-color, 8%);\n+    background: #ffffff;\n     border-radius: 4px;\n     padding: 16px;\n     line-height: 20px;\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -2732,22 +2732,16 @@ $ui-header-height: 55px;\n     &__description {\n       flex: 1 1 auto;\n       line-height: 20px;\n-      white-space: nowrap;\n-      text-overflow: ellipsis;\n-      overflow: hidden;\n \n       h6 {\n         color: $highlight-text-color;\n         font-weight: 500;\n         font-size: 14px;\n-        overflow: hidden;\n-        text-overflow: ellipsis;\n       }\n \n       p {\n         color: $darker-text-color;\n         overflow: hidden;\n-        text-overflow: ellipsis;\n       }\n     }\n   }\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\ntry any page on my instance, like : \r\n[https://lepoulsdumonde.com/@nico](nico) or [https://lepoulsdumonde.com/](home)\r\nOnly a grey window is displayed.\r\nthe console logs : \r\n```Uncaught Error: No current user (me) defined when calling `accountsReducer`\r\n    at accounts (accounts.ts:51:11)```\r\nBut when you already have an existing connection to the server (I guess when you have an existing cookie), everything works fine.\r\nFor example, on my main browser, firefox 119 on win 11, I can log in and out, get any url because I've been using it with an account for a long time.\r\nBut if I go to chrome which I never used to access my instance, or on my phone, or if a friend tries to connect to my instance, I get this error, and only a grey empty window is displayed.\r\nI don't get any error logs in journalctl.\r\nI tried pulling main again, and deleting the packs and cache and recompiling, restarting all services with no success.\r\nI'm using the latest nightly main branch from source pull.\r\nI don't know when the problem appeared exactly.\r\n\r\n### Expected behaviour\r\n\r\ndisplay the web page\r\n\r\n### Actual behaviour\r\n\r\nempty window\r\n\r\n### Detailed description\r\n\r\n_No response_\r\n\r\n### Mastodon instance\r\n\r\nlepoulsdumonde.com\r\n\r\n### Mastodon version\r\n\r\nv4.3.0alpha nightly from source\r\n\r\n### Browser name and version\r\n\r\nfirefox 119, chrome 119\r\n\r\n### Operating system\r\n\r\nwin 11, ios, win10\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\ndb/seeds/04_admin.rb\n@@ -7,5 +7,7 @@\n   admin = Account.where(username: 'admin').first_or_initialize(username: 'admin')\n   admin.save(validate: false)\n \n-  User.where(email: \"admin@#{domain}\").first_or_initialize(email: \"admin@#{domain}\", password: 'mastodonadmin', password_confirmation: 'mastodonadmin', confirmed_at: Time.now.utc, role: UserRole.find_by(name: 'Owner'), account: admin, agreement: true, approved: true).save!\n+  user = User.where(email: \"admin@#{domain}\").first_or_initialize(email: \"admin@#{domain}\", password: 'mastodonadmin', password_confirmation: 'mastodonadmin', confirmed_at: Time.now.utc, role: UserRole.find_by(name: 'Owner'), account: admin, agreement: true, approved: true)\n+  user.save!\n+  user.approve!\n end\n---\n\n\n---\n\nChoice B:\nstreaming/redis.js\n@@ -50,9 +50,9 @@ function getSentinelConfiguration(env, commonOptions) {\n   return {\n     db: redisDatabase,\n     name: env.REDIS_SENTINEL_MASTER,\n-    username: env.REDIS_USERNAME,\n+    username: env.REDIS_USER,\n     password: env.REDIS_PASSWORD,\n-    sentinelUsername: env.REDIS_SENTINEL_USERNAME ?? env.REDIS_USERNAME,\n+    sentinelUsername: env.REDIS_SENTINEL_USERNAME ?? env.REDIS_USER,\n     sentinelPassword: env.REDIS_SENTINEL_PASSWORD ?? env.REDIS_PASSWORD,\n     sentinels,\n     ...commonOptions,\n@@ -104,7 +104,7 @@ export function configFromEnv(env) {\n     host: env.REDIS_HOST ?? '127.0.0.1',\n     port: redisPort,\n     db: redisDatabase,\n-    username: env.REDIS_USERNAME,\n+    username: env.REDIS_USER,\n     password: env.REDIS_PASSWORD,\n     ...commonOptions,\n   };\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/reducers/accounts.ts\n@@ -41,40 +41,42 @@ const normalizeAccounts = (\n   return state;\n };\n \n-export const accountsReducer: Reducer<typeof initialState> = (\n-  state = initialState,\n-  action,\n-) => {\n-  const currentUserId = me;\n-\n-  if (!currentUserId)\n+function getCurrentUser() {\n+  if (!me)\n     throw new Error(\n       'No current user (me) defined when calling `accountsReducer`',\n     );\n \n+  return me;\n+}\n+\n+export const accountsReducer: Reducer<typeof initialState> = (\n+  state = initialState,\n+  action,\n+) => {\n   if (revealAccount.match(action))\n     return state.setIn([action.payload.id, 'hidden'], false);\n   else if (importAccounts.match(action))\n     return normalizeAccounts(state, action.payload.accounts);\n-  else if (followAccountSuccess.match(action))\n+  else if (followAccountSuccess.match(action)) {\n     return state\n       .update(\n         action.payload.relationship.id,\n         (account) => account?.update('followers_count', (n) => n + 1),\n       )\n       .update(\n-        currentUserId,\n+        getCurrentUser(),\n         (account) => account?.update('following_count', (n) => n + 1),\n       );\n-  else if (unfollowAccountSuccess.match(action))\n+  } else if (unfollowAccountSuccess.match(action))\n     return state\n       .update(\n         action.payload.relationship.id,\n         (account) =>\n           account?.update('followers_count', (n) => Math.max(0, n - 1)),\n       )\n       .update(\n-        currentUserId,\n+        getCurrentUser(),\n         (account) =>\n           account?.update('following_count', (n) => Math.max(0, n - 1)),\n       );\n---\nspec/system/unlogged_spec.rb\n@@ -0,0 +1,17 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+describe 'UnloggedBrowsing' do\n+  subject { page }\n+\n+  before do\n+    visit root_path\n+  end\n+\n+  it 'loads the home page' do\n+    expect(subject).to have_css('div.app-holder')\n+\n+    expect(subject).to have_css('div.columns-area__panels__main')\n+  end\n+end\n---\n\n\n---\n\nChoice D:\napp/services/resolve_account_service.rb\n@@ -100,7 +100,9 @@ def process_webfinger!(uri)\n   end\n \n   def split_acct(acct)\n-    acct.delete_prefix('acct:').split('@')\n+    acct.delete_prefix('acct:').split('@').tap do |parts|\n+      raise Webfinger::Error, 'Webfinger response is missing user or host value' unless parts.size == 2\n+    end\n   end\n \n   def fetch_account!\n---\nspec/services/resolve_account_service_spec.rb\n@@ -144,6 +144,19 @@\n     end\n   end\n \n+  context 'with webfinger response subject missing a host value' do\n+    let(:body) { Oj.dump({ subject: 'user@' }) }\n+    let(:url) { 'https://host.example/.well-known/webfinger?resource=acct:user@host.example' }\n+\n+    before do\n+      stub_request(:get, url).to_return(status: 200, body: body)\n+    end\n+\n+    it 'returns nil with incomplete subject in response' do\n+      expect(subject.call('user@host.example')).to be_nil\n+    end\n+  end\n+\n   context 'with an ActivityPub account' do\n     it 'returns new remote account' do\n       account = subject.call('foo@ap.example.com')\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. `git clone https://github.com/mastodon/mastodon.git`\r\n2. `bundle install`\r\n3. `yarn install`\r\n4. `foreman start`\r\n5. Visit 'localhost:3000' in browser\r\n\n\n### Expected behaviour\n\nPage renders successfully\n\n### Actual behaviour\n\nGet \"Failed to compile\" error message\n\n### Detailed description\n\nThe full message is:\r\n\r\n> Failed to compile.\r\n> \r\n> ./app/javascript/mastodon/features/emoji/emoji_unicode_mapping_light.ts 18:15-32\r\n> \"export 'unicodeToFilename' was not found in './unicode_to_filename'\r\n\r\n- 0e3401bc1c24fc1f6d7e04e9d2 appears to be the commit when the issue was introduced.\r\n- JS tests (`yarn run test`) are passing.\r\n- If I manually set `NODE_ENV=production` then the site _does_ render successfully.\r\n  ```shell\r\n  RAILS_ENV=development ./bin/rails tmp:clear assets:clean\r\n  NODE_ENV=production foreman start\r\n  ```\n\n### Mastodon instance\n\nlocalhost\n\n### Mastodon version\n\n3bf2a7296e6d80d5cd9d5d3cba1507af6ba83dfd\n\n### Technical details\n\nOS: Ubuntu 23.10\r\n\r\n`ruby --version`\r\n\r\n> ruby 3.2.2 (2023-03-30 revision e51014f9c0) [x86_64-linux]\r\n\r\n`node --version`\r\n\r\n> v20.9.0\n\n---\n\nChoice A:\nconfig/routes.rb\n@@ -3,6 +3,18 @@\n require 'sidekiq_unique_jobs/web'\n require 'sidekiq-scheduler/web'\n \n+class RedirectWithVary < ActionDispatch::Routing::PathRedirect\n+  def serve(...)\n+    super.tap do |_, headers, _|\n+      headers['Vary'] = 'Origin, Accept'\n+    end\n+  end\n+end\n+\n+def redirect_with_vary(path)\n+  RedirectWithVary.new(301, path)\n+end\n+\n Rails.application.routes.draw do\n   # Paths of routes on the web app that to not require to be indexed or\n   # have alternative format representations requiring separate controllers\n@@ -90,10 +102,13 @@\n     confirmations:      'auth/confirmations',\n   }\n \n-  get '/users/:username', to: redirect('/@%{username}'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n-  get '/users/:username/following', to: redirect('/@%{username}/following'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n-  get '/users/:username/followers', to: redirect('/@%{username}/followers'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n-  get '/users/:username/statuses/:id', to: redirect('/@%{username}/%{id}'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  # rubocop:disable Style/FormatStringToken - those do not go through the usual formatting functions and are not safe to correct\n+  get '/users/:username', to: redirect_with_vary('/@%{username}'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  get '/users/:username/following', to: redirect_with_vary('/@%{username}/following'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  get '/users/:username/followers', to: redirect_with_vary('/@%{username}/followers'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  get '/users/:username/statuses/:id', to: redirect_with_vary('/@%{username}/%{id}'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  # rubocop:enable Style/FormatStringToken\n+\n   get '/authorize_follow', to: redirect { |_, request| \"/authorize_interaction?#{request.params.to_query}\" }\n \n   resources :accounts, path: 'users', only: [:show], param: :username do\n---\nspec/requests/cache_spec.rb\n@@ -124,7 +124,7 @@ module DisabledAnonymousAPI\n       expect(response.cookies).to be_empty\n     end\n \n-    it 'sets public cache control' do\n+    it 'sets public cache control', :aggregate_failures do\n       # expect(response.cache_control[:max_age]&.to_i).to be_positive\n       expect(response.cache_control[:public]).to be_truthy\n       expect(response.cache_control[:private]).to be_falsy\n@@ -141,11 +141,8 @@ module DisabledAnonymousAPI\n   end\n \n   shared_examples 'non-cacheable error' do\n-    it 'does not return HTTP success' do\n+    it 'does not return HTTP success and does not have cache headers', :aggregate_failures do\n       expect(response).to_not have_http_status(200)\n-    end\n-\n-    it 'does not have cache headers' do\n       expect(response.cache_control[:public]).to be_falsy\n     end\n   end\n@@ -182,6 +179,15 @@ module DisabledAnonymousAPI\n   end\n \n   context 'when anonymously accessed' do\n+    describe '/users/alice' do\n+      it 'redirects with proper cache header', :aggregate_failures do\n+        get '/users/alice'\n+\n+        expect(response).to redirect_to('/@alice')\n+        expect(response.headers['Vary']&.split(',')&.map { |x| x.strip.downcase }).to include('accept')\n+      end\n+    end\n+\n     TestEndpoints::ALWAYS_CACHED.each do |endpoint|\n       describe endpoint do\n         before { get endpoint }\n---\n\n\n---\n\nChoice B:\nbabel.config.js\n@@ -52,6 +52,10 @@ module.exports = (api) => {\n   case 'development':\n     reactOptions.development = true;\n     envOptions.debug = true;\n+\n+    // We need Babel to not inject polyfills in dev, as this breaks `preval` files\n+    envOptions.useBuiltIns = false;\n+    envOptions.corejs = undefined;\n     break;\n   }\n \n---\n\n\n---\n\nChoice C:\nCHANGELOG.md\n@@ -2,6 +2,29 @@\n \n All notable changes to this project will be documented in this file.\n \n+## [4.3.7] - 2025-04-02\n+\n+### Add\n+\n+- Add delay to profile updates to debounce them (#34137 by @ClearlyClaire)\n+- Add support for paginating partial collections in `SynchronizeFollowersService` (#34272 and #34277 by @ClearlyClaire)\n+\n+### Changed\n+\n+- Change account suspensions to be federated to recently-followed accounts as well (#34294 by @ClearlyClaire)\n+- Change `AccountReachFinder` to consider statuses based on suspension date (#32805 and #34291 by @ClearlyClaire and @mjankowski)\n+- Change user archive signed URL TTL from 10 seconds to 1 hour (#34254 by @ClearlyClaire)\n+\n+### Fixed\n+\n+- Fix static version of animated PNG emojis not being properly extracted (#34337 by @ClearlyClaire)\n+- Fix filters not applying in detailed view, favourites and bookmarks (#34259 and #34260 by @ClearlyClaire)\n+- Fix handling of malformed/unusual HTML (#34201 by @ClearlyClaire)\n+- Fix `CacheBuster` being queued for missing media attachments (#34253 by @ClearlyClaire)\n+- Fix incorrect URL being used when cache busting (#34189 by @ClearlyClaire)\n+- Fix streaming server refusing unix socket path in `DATABASE_URL` (#34091 by @ClearlyClaire)\n+- Fix \u201cx\u201d hotkey not working on boosted filtered posts (#33758 by @ClearlyClaire)\n+\n ## [4.3.6] - 2025-03-13\n \n ### Security\n---\ndocker-compose.yml\n@@ -59,7 +59,7 @@ services:\n   web:\n     # You can uncomment the following line if you want to not use the prebuilt image, for example if you have local code changes\n     # build: .\n-    image: ghcr.io/mastodon/mastodon:v4.3.6\n+    image: ghcr.io/mastodon/mastodon:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -83,7 +83,7 @@ services:\n     # build:\n     #   dockerfile: ./streaming/Dockerfile\n     #   context: .\n-    image: ghcr.io/mastodon/mastodon-streaming:v4.3.6\n+    image: ghcr.io/mastodon/mastodon-streaming:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: node ./streaming/index.js\n@@ -102,7 +102,7 @@ services:\n   sidekiq:\n     # You can uncomment the following line if you want to not use the prebuilt image, for example if you have local code changes\n     # build: .\n-    image: ghcr.io/mastodon/mastodon:v4.3.6\n+    image: ghcr.io/mastodon/mastodon:v4.3.7\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\nlib/mastodon/version.rb\n@@ -13,7 +13,7 @@ def minor\n     end\n \n     def patch\n-      6\n+      7\n     end\n \n     def default_prerelease\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/components/alt_text_badge.tsx\n@@ -0,0 +1,67 @@\n+import { useState, useCallback, useRef } from 'react';\n+\n+import { FormattedMessage } from 'react-intl';\n+\n+import Overlay from 'react-overlays/Overlay';\n+import type {\n+  OffsetValue,\n+  UsePopperOptions,\n+} from 'react-overlays/esm/usePopper';\n+\n+const offset = [0, 4] as OffsetValue;\n+const popperConfig = { strategy: 'fixed' } as UsePopperOptions;\n+\n+export const AltTextBadge: React.FC<{\n+  description: string;\n+}> = ({ description }) => {\n+  const anchorRef = useRef<HTMLButtonElement>(null);\n+  const [open, setOpen] = useState(false);\n+\n+  const handleClick = useCallback(() => {\n+    setOpen((v) => !v);\n+  }, [setOpen]);\n+\n+  const handleClose = useCallback(() => {\n+    setOpen(false);\n+  }, [setOpen]);\n+\n+  return (\n+    <>\n+      <button\n+        ref={anchorRef}\n+        className='media-gallery__alt__label'\n+        onClick={handleClick}\n+      >\n+        ALT\n+      </button>\n+\n+      <Overlay\n+        rootClose\n+        onHide={handleClose}\n+        show={open}\n+        target={anchorRef.current}\n+        placement='top-end'\n+        flip\n+        offset={offset}\n+        popperConfig={popperConfig}\n+      >\n+        {({ props }) => (\n+          <div {...props} className='hover-card-controller'>\n+            <div\n+              className='media-gallery__alt__popover dropdown-animation'\n+              role='tooltip'\n+            >\n+              <h4>\n+                <FormattedMessage\n+                  id='alt_text_badge.title'\n+                  defaultMessage='Alt text'\n+                />\n+              </h4>\n+              <p>{description}</p>\n+            </div>\n+          </div>\n+        )}\n+      </Overlay>\n+    </>\n+  );\n+};\n---\napp/javascript/mastodon/components/media_gallery.jsx\n@@ -10,6 +10,7 @@ import ImmutablePropTypes from 'react-immutable-proptypes';\n \n import { debounce } from 'lodash';\n \n+import { AltTextBadge } from 'mastodon/components/alt_text_badge';\n import { Blurhash } from 'mastodon/components/blurhash';\n import { formatTime } from 'mastodon/features/video';\n \n@@ -97,7 +98,7 @@ class Item extends PureComponent {\n     }\n \n     if (attachment.get('description')?.length > 0) {\n-      badges.push(<span key='alt' className='media-gallery__alt__label'>ALT</span>);\n+      badges.push(<AltTextBadge key='alt' description={attachment.get('description')} />);\n     }\n \n     const description = attachment.getIn(['translation', 'description']) || attachment.get('description');\n@@ -156,9 +157,9 @@ class Item extends PureComponent {\n       const duration = attachment.getIn(['meta', 'original', 'duration']);\n \n       if (attachment.get('type') === 'gifv') {\n-        badges.push(<span key='gif' className='media-gallery__gifv__label'>GIF</span>);\n+        badges.push(<span key='gif' className='media-gallery__alt__label media-gallery__alt__label--non-interactive'>GIF</span>);\n       } else {\n-        badges.push(<span key='video' className='media-gallery__gifv__label'>{formatTime(Math.floor(duration))}</span>);\n+        badges.push(<span key='video' className='media-gallery__alt__label media-gallery__alt__label--non-interactive'>{formatTime(Math.floor(duration))}</span>);\n       }\n \n       thumbnail = (\n---\napp/javascript/mastodon/features/account_gallery/components/media_item.tsx\n@@ -5,6 +5,7 @@ import classNames from 'classnames';\n import HeadphonesIcon from '@/material-icons/400-24px/headphones-fill.svg?react';\n import MovieIcon from '@/material-icons/400-24px/movie-fill.svg?react';\n import VisibilityOffIcon from '@/material-icons/400-24px/visibility_off.svg?react';\n+import { AltTextBadge } from 'mastodon/components/alt_text_badge';\n import { Blurhash } from 'mastodon/components/blurhash';\n import { Icon } from 'mastodon/components/icon';\n import { formatTime } from 'mastodon/features/video';\n@@ -77,11 +78,7 @@ export const MediaItem: React.FC<{\n   const badges = [];\n \n   if (description && description.length > 0) {\n-    badges.push(\n-      <span key='alt' className='media-gallery__alt__label'>\n-        ALT\n-      </span>,\n-    );\n+    badges.push(<AltTextBadge key='alt' description={description} />);\n   }\n \n   if (!visible) {\n@@ -156,13 +153,19 @@ export const MediaItem: React.FC<{\n \n     if (type === 'gifv') {\n       badges.push(\n-        <span key='gif' className='media-gallery__gifv__label'>\n+        <span\n+          key='gif'\n+          className='media-gallery__alt__label media-gallery__alt__label--non-interactive'\n+        >\n           GIF\n         </span>,\n       );\n     } else {\n       badges.push(\n-        <span key='video' className='media-gallery__gifv__label'>\n+        <span\n+          key='video'\n+          className='media-gallery__alt__label media-gallery__alt__label--non-interactive'\n+        >\n           {formatTime(Math.floor(duration))}\n         </span>,\n       );\n---\napp/javascript/mastodon/locales/en.json\n@@ -85,6 +85,7 @@\n   \"alert.rate_limited.title\": \"Rate limited\",\n   \"alert.unexpected.message\": \"An unexpected error occurred.\",\n   \"alert.unexpected.title\": \"Oops!\",\n+  \"alt_text_badge.title\": \"Alt text\",\n   \"announcement.announcement\": \"Announcement\",\n   \"attachments_list.unprocessed\": \"(unprocessed)\",\n   \"audio.hide\": \"Hide audio\",\n---\napp/javascript/styles/mastodon/components.scss\n@@ -6971,23 +6971,56 @@ a.status-card {\n   inset-inline-end: 8px;\n   display: flex;\n   gap: 2px;\n+  pointer-events: none;\n }\n \n-.media-gallery__alt__label,\n-.media-gallery__gifv__label {\n-  display: flex;\n-  align-items: center;\n-  justify-content: center;\n+.media-gallery__alt__label {\n+  display: block;\n+  text-align: center;\n   color: $white;\n+  border: 0;\n   background: rgba($black, 0.65);\n   backdrop-filter: blur(10px) saturate(180%) contrast(75%) brightness(70%);\n   padding: 3px 8px;\n   border-radius: 4px;\n   font-size: 12px;\n   font-weight: 700;\n   z-index: 1;\n-  pointer-events: none;\n   line-height: 20px;\n+  cursor: pointer;\n+  pointer-events: auto;\n+\n+  &--non-interactive {\n+    pointer-events: none;\n+  }\n+}\n+\n+.media-gallery__alt__popover {\n+  background: rgba($black, 0.65);\n+  backdrop-filter: blur(10px) saturate(180%) contrast(75%) brightness(70%);\n+  border-radius: 4px;\n+  box-shadow: var(--dropdown-shadow);\n+  padding: 16px;\n+  min-width: 16em;\n+  min-height: 2em;\n+  max-width: 22em;\n+  max-height: 30em;\n+  overflow-y: auto;\n+\n+  h4 {\n+    font-size: 15px;\n+    line-height: 20px;\n+    font-weight: 500;\n+    color: $white;\n+    margin-bottom: 8px;\n+  }\n+\n+  p {\n+    font-size: 15px;\n+    line-height: 20px;\n+    color: rgba($white, 0.85);\n+    white-space: pre-line;\n+  }\n }\n \n .attachment-list {\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Publish a post\r\n2. Edit it\r\n3. Click the edited timestamp\n\n### Expected behaviour\n\nI see edit history\n\n### Actual behaviour\n\nNothing appears and a next click-event is spoiled\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\n-\n\n### Mastodon version\n\nv4.3.0-alpha.0\n\n### Browser name and version\n\nFirefox 119.0\n\n### Operating system\n\n-\n\n### Technical details\n\nI see that browser's dev-tool shows the container of edit history on the DOM when clicked the timestamps, that has `opacity: 0` and `pointer-events: none` CSS properties. I removed both via dev-tool and it works normally for once (but placed on top-left edge)\r\n\r\nThis seems introduced by #27385\r\n\r\n![](https://github.com/mastodon/mastodon/assets/5103195/af17c5c8-d870-4284-9dc6-a1f08df0b9bd)\r\n![](https://github.com/mastodon/mastodon/assets/5103195/2854b3ef-bf84-46cb-b9e6-9ce541a8d5de)\n\n---\n\nChoice A:\ndb/migrate/20180812173710_copy_status_stats.rb\n@@ -45,7 +45,7 @@ def up_slow\n     # We cannot use bulk INSERT or overarching transactions here because of possible\n     # uniqueness violations that we need to skip over\n     Status.unscoped.select('id, reblogs_count, favourites_count, created_at, updated_at').find_each do |status|\n-      params = [[nil, status.id], [nil, status.reblogs_count], [nil, status.favourites_count], [nil, status.created_at], [nil, status.updated_at]]\n+      params = [status.id, status.reblogs_count, status.favourites_count, status.created_at, status.updated_at]\n       exec_insert('INSERT INTO status_stats (status_id, reblogs_count, favourites_count, created_at, updated_at) VALUES ($1, $2, $3, $4, $5)', nil, params)\n     rescue ActiveRecord::RecordNotUnique\n       next\n---\ndb/migrate/20181116173541_copy_account_stats.rb\n@@ -45,7 +45,7 @@ def up_slow\n     # We cannot use bulk INSERT or overarching transactions here because of possible\n     # uniqueness violations that we need to skip over\n     Account.unscoped.select('id, statuses_count, following_count, followers_count, created_at, updated_at').find_each do |account|\n-      params = [[nil, account.id], [nil, account[:statuses_count]], [nil, account[:following_count]], [nil, account[:followers_count]], [nil, account.created_at], [nil, account.updated_at]]\n+      params = [account.id, account[:statuses_count], account[:following_count], account[:followers_count], account.created_at, account.updated_at]\n       exec_insert('INSERT INTO account_stats (account_id, statuses_count, following_count, followers_count, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6)', nil, params)\n     rescue ActiveRecord::RecordNotUnique\n       next\n---\nlib/mastodon/cli/statuses.rb\n@@ -61,7 +61,7 @@ def remove_statuses\n         # Skip accounts followed by local accounts\n         clean_followed_sql = 'AND NOT EXISTS (SELECT 1 FROM follows WHERE statuses.account_id = follows.target_account_id)' unless options[:clean_followed]\n \n-        ActiveRecord::Base.connection.exec_insert(<<-SQL.squish, 'SQL', [[nil, max_id]])\n+        ActiveRecord::Base.connection.exec_insert(<<-SQL.squish, 'SQL', [max_id])\n           INSERT INTO statuses_to_be_deleted (id)\n           SELECT statuses.id FROM statuses WHERE deleted_at IS NULL AND NOT local AND uri IS NOT NULL AND (id < $1)\n           AND NOT EXISTS (SELECT 1 FROM statuses AS statuses1 WHERE statuses.id = statuses1.in_reply_to_id)\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/components/dropdown_menu.jsx\n@@ -257,7 +257,7 @@ class Dropdown extends PureComponent {\n   };\n \n   findTarget = () => {\n-    return this.target?.buttonRef?.current;\n+    return this.target?.buttonRef?.current ?? this.target;\n   };\n \n   componentWillUnmount = () => {\n---\n\n\n---\n\nChoice C:\napp/models/account.rb\n@@ -68,7 +68,7 @@ class Account < ApplicationRecord\n   INSTANCE_ACTOR_ID = -99\n \n   USERNAME_RE   = /[a-z0-9_]+([a-z0-9_.-]+[a-z0-9_]+)?/i\n-  MENTION_RE    = %r{(?<![=/[:word:]])@((#{USERNAME_RE})(?:@[[:word:].-]+[[:word:]]+)?)}i\n+  MENTION_RE    = %r{(?<![=/[:word:]])@((#{USERNAME_RE})(?:@[[:word:].-]+[[:word:]]+)?)}\n   URL_PREFIX_RE = %r{\\Ahttp(s?)://[^/]+}\n   USERNAME_ONLY_RE = /\\A#{USERNAME_RE}\\z/i\n   USERNAME_LENGTH_LIMIT = 30\n---\napp/models/tag.rb\n@@ -37,7 +37,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]\\u0E47-\\u0E4E#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/account_spec.rb\n@@ -711,6 +711,14 @@\n     it 'does not match URL query string' do\n       expect(subject.match('https://example.com/?x=@alice')).to be_nil\n     end\n+\n+    it 'matches usernames immediately following the letter \u00df' do\n+      expect(subject.match('Hello to\u00df @alice from me')[1]).to eq 'alice'\n+    end\n+\n+    it 'matches usernames containing uppercase characters' do\n+      expect(subject.match('Hello to @aLice@Example.com from me')[1]).to eq 'aLice@Example.com'\n+    end\n   end\n \n   describe 'validations' do\n---\nspec/models/tag_spec.rb\n@@ -95,6 +95,14 @@\n     it 'does not match purely-numeric hashtags' do\n       expect(subject.match('hello #0123456')).to be_nil\n     end\n+\n+    it 'matches hashtags immediately following the letter \u00df' do\n+      expect(subject.match('Hello to\u00df #ruby').to_s).to eq '#ruby'\n+    end\n+\n+    it 'matches hashtags containing uppercase characters' do\n+      expect(subject.match('Hello #rubyOnRails').to_s).to eq '#rubyOnRails'\n+    end\n   end\n \n   describe '#to_param' do\n---\n\n\n---\n\nChoice D:\napp/services/resolve_account_service.rb\n@@ -100,7 +100,9 @@ def process_webfinger!(uri)\n   end\n \n   def split_acct(acct)\n-    acct.delete_prefix('acct:').split('@')\n+    acct.delete_prefix('acct:').split('@').tap do |parts|\n+      raise Webfinger::Error, 'Webfinger response is missing user or host value' unless parts.size == 2\n+    end\n   end\n \n   def fetch_account!\n---\nspec/services/resolve_account_service_spec.rb\n@@ -144,6 +144,19 @@\n     end\n   end\n \n+  context 'with webfinger response subject missing a host value' do\n+    let(:body) { Oj.dump({ subject: 'user@' }) }\n+    let(:url) { 'https://host.example/.well-known/webfinger?resource=acct:user@host.example' }\n+\n+    before do\n+      stub_request(:get, url).to_return(status: 200, body: body)\n+    end\n+\n+    it 'returns nil with incomplete subject in response' do\n+      expect(subject.call('user@host.example')).to be_nil\n+    end\n+  end\n+\n   context 'with an ActivityPub account' do\n     it 'returns new remote account' do\n       account = subject.call('foo@ap.example.com')\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Build container in github codespace\r\n\r\n### Expected behaviour\r\n\r\nSuccessful build\r\n\r\n### Actual behaviour\r\n\r\nGot an error\r\n\r\n### Detailed description\r\n\r\nError message: webpack config /workspaces/mastodon/config/webpack/tests.js not found, please run 'bundle exec rails webpacker:install' to install Webpacker with default configs or add the missing config file for your custom environment.\r\n\r\nThe file was deleted in #27333\r\n\r\n### Mastodon instance\r\n\r\n_No response_\r\n\r\n### Mastodon version\r\n\r\n_No response_\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\n.devcontainer/post-create.sh\n@@ -24,4 +24,4 @@ RAILS_ENV=development ./bin/rails db:setup\n RAILS_ENV=development ./bin/rails assets:precompile\n \n # Precompile assets for test\n-RAILS_ENV=test NODE_ENV=tests ./bin/rails assets:precompile\n+RAILS_ENV=test ./bin/rails assets:precompile\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -2836,7 +2836,7 @@ $ui-header-logo-wordmark-width: 99px;\n   overflow: hidden;\n }\n \n-@media screen and (width >= 631px) {\n+@media screen and (width > $mobile-breakpoint) {\n   .columns-area {\n     padding: 0;\n   }\n@@ -5731,7 +5731,7 @@ a.status-card {\n   user-select: text;\n   display: flex;\n \n-  @media screen and (width <= 630px) {\n+  @media screen and (width <= $mobile-breakpoint) {\n     margin-top: auto;\n   }\n }\n@@ -6090,7 +6090,7 @@ a.status-card {\n     border-radius: 0 0 16px 16px;\n     border-top: 0;\n \n-    @media screen and (max-width: $no-gap-breakpoint) {\n+    @media screen and (max-width: $mobile-breakpoint) {\n       border-radius: 0;\n       border-bottom: 0;\n       padding-bottom: 32px;\n@@ -9092,8 +9092,9 @@ noscript {\n   backdrop-filter: var(--background-filter);\n   border: 1px solid var(--modal-border-color);\n   padding: 24px;\n+  box-sizing: border-box;\n \n-  @media screen and (max-width: $no-gap-breakpoint) {\n+  @media screen and (max-width: $mobile-breakpoint) {\n     border-radius: 16px 16px 0 0;\n     border-bottom: 0;\n     padding-bottom: 32px;\n---\napp/javascript/styles/mastodon/variables.scss\n@@ -88,6 +88,7 @@ $media-modal-media-max-width: 100%;\n $media-modal-media-max-height: 80%;\n \n $no-gap-breakpoint: 1175px;\n+$mobile-breakpoint: 630px;\n \n $font-sans-serif: 'mastodon-font-sans-serif' !default;\n $font-display: 'mastodon-font-display' !default;\n---\n\n\n---\n\nChoice C:\napp/views/application/mailer/_hashtag.html.haml\n@@ -17,4 +17,5 @@\n                           %span.email-mini-hashtag-img-span\n                             = image_tag full_asset_url(account.avatar.url), alt: '', width: 16, height: 16\n                       %td\n-                        %p= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(hashtag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts))\n+                        - people = hashtag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts\n+                        %p= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(people), count: people)\n---\n\n\n---\n\nChoice D:\napp/controllers/api/v1/suggestions_controller.rb\n@@ -4,7 +4,7 @@ class Api::V1::SuggestionsController < Api::BaseController\n   include Authorization\n   include DeprecationConcern\n \n-  deprecate_api '2021-05-16'\n+  deprecate_api '2021-05-16', only: [:index]\n \n   before_action -> { doorkeeper_authorize! :read, :'read:accounts' }, only: :index\n   before_action -> { doorkeeper_authorize! :write, :'write:accounts' }, except: :index\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Pull latest main to 277e696\r\n2. Rebuild and restart\r\n3. See emoji not outputting to textarea after selecting an emoji\r\n...\r\n\n\n### Expected behaviour\n\nEmoji code should appear to textarea\n\n### Actual behaviour\n\nNothing happens\n\n### Detailed description\n\nI may have been too hasty since this was introduced [8 hours ago](https://github.com/mastodon/mastodon/commit/9c8891b39a2d04898880f4bd0754a52739ada30a#diff-b407b14e1a5570dfc879754f8669660ee64065027c51912f5061726fe1679b4f)... sorry for that, if it should be this way and is acknowledged. Maybe @ClearlyClaire has a clue?\n\n### Mastodon instance\n\nmementomori.social\n\n### Mastodon version\n\nv4.3.0-alpha.0-2023-10-31\n\n### Browser name and version\n\nGoogle Chrome 118.0.5993.70 (Official Build) (64-bit)\n\n### Operating system\n\nPop!_OS 22.04 LTS\n\n### Technical details\n\nDevTools Console:\r\n\r\n```\r\nUncaught TypeError: Cannot read properties of undefined (reading 'selectionStart')\r\n    at compose_form.jsx:219:40\r\n    at Object.onPickEmoji [as onPick] (emoji_picker_dropdown_container.js:80:7)\r\n    at Object.onClick (emoji_picker_dropdown.jsx:236:16)\r\n    at a.value (nimble-picker.js:315:18)\r\n    at nimble-emoji.js:46:23\r\n    at onClick (nimble-emoji.js:220:16)\r\n    at Object.Ae (react-dom.production.min.js:54:317)\r\n    at ze (react-dom.production.min.js:54:471)\r\n    at react-dom.production.min.js:55:35\r\n    at Rr (react-dom.production.min.js:105:68)\r\n```\n\n---\n\nChoice A:\napp/javascript/mastodon/features/status/components/card.jsx\n@@ -141,7 +141,7 @@ export default class Card extends PureComponent {\n     const showAuthor  = !!card.getIn(['authors', 0, 'accountId']);\n \n     const description = (\n-      <div className='status-card__content'>\n+      <div className='status-card__content' dir='auto'>\n         <span className='status-card__host'>\n           <span lang={language}>{provider}</span>\n           {card.get('published_at') && <> \u00b7 <RelativeTimestamp timestamp={card.get('published_at')} /></>}\n---\n\n\n---\n\nChoice B:\nlib/mastodon/version.rb\n@@ -17,7 +17,7 @@ def patch\n     end\n \n     def flags\n-      ENV.fetch('MASTODON_VERSION_FLAGS', '-beta2')\n+      ENV['MASTODON_VERSION_FLAGS'].presence || '-beta2'\n     end\n \n     def suffix\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/compose/components/compose_form.jsx\n@@ -216,7 +216,7 @@ class ComposeForm extends ImmutablePureComponent {\n \n   handleEmojiPick = (data) => {\n     const { text }     = this.props;\n-    const position     = this.textarea.selectionStart;\n+    const position     = this.textareaRef.current.selectionStart;\n     const needsSpace   = data.custom && position > 0 && !allowedAroundShortCode.includes(text[position - 1]);\n \n     this.props.onPickEmoji(position, data, needsSpace);\n---\n\n\n---\n\nChoice D:\napp/helpers/application_helper.rb\n@@ -240,11 +240,16 @@ def prerender_custom_emojis(html, custom_emojis, other_options = {})\n     EmojiFormatter.new(html, custom_emojis, other_options.merge(animate: prefers_autoplay?)).to_s\n   end\n \n-  def site_icon_path(type, size = '48')\n-    icon = SiteUpload.find_by(var: type)\n-    return nil unless icon\n+  def instance_presenter\n+    @instance_presenter ||= InstancePresenter.new\n+  end\n+\n+  def favicon_path(size = '48')\n+    instance_presenter.favicon&.file&.url(size)\n+  end\n \n-    icon.file.url(size)\n+  def app_icon_path(size = '48')\n+    instance_presenter.app_icon&.file&.url(size)\n   end\n \n   private\n---\napp/presenters/instance_presenter.rb\n@@ -81,4 +81,16 @@ def thumbnail\n   def mascot\n     @mascot ||= Rails.cache.fetch('site_uploads/mascot') { SiteUpload.find_by(var: 'mascot') }\n   end\n+\n+  def favicon\n+    return @favicon if defined?(@favicon)\n+\n+    @favicon ||= Rails.cache.fetch('site_uploads/favicon') { SiteUpload.find_by(var: 'favicon') }\n+  end\n+\n+  def app_icon\n+    return @app_icon if defined?(@app_icon)\n+\n+    @app_icon ||= Rails.cache.fetch('site_uploads/app_icon') { SiteUpload.find_by(var: 'app_icon') }\n+  end\n end\n---\napp/serializers/manifest_serializer.rb\n@@ -27,7 +27,7 @@ def short_name\n \n   def icons\n     SiteUpload::ANDROID_ICON_SIZES.map do |size|\n-      src = site_icon_path('app_icon', size.to_i)\n+      src = app_icon_path(size.to_i)\n       src = URI.join(root_url, src).to_s if src.present?\n \n       {\n---\napp/views/layouts/application.html.haml\n@@ -11,13 +11,13 @@\n     - if storage_host?\n       %link{ rel: 'dns-prefetch', href: storage_host }/\n \n-    %link{ rel: 'icon', href: site_icon_path('favicon', 'ico') || '/favicon.ico', type: 'image/x-icon' }/\n+    %link{ rel: 'icon', href: favicon_path('ico') || '/favicon.ico', type: 'image/x-icon' }/\n \n     - SiteUpload::FAVICON_SIZES.each do |size|\n-      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: site_icon_path('favicon', size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n+      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: favicon_path(size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n \n     - SiteUpload::APPLE_ICON_SIZES.each do |size|\n-      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: site_icon_path('app_icon', size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n+      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: app_icon_path(size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n \n     %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n     %link{ rel: 'manifest', href: manifest_path(format: :json) }/\n---\nspec/helpers/application_helper_spec.rb\n@@ -286,26 +286,31 @@ def current_theme = 'default'\n     end\n   end\n \n-  describe '#site_icon_path' do\n+  describe 'favicon' do\n     context 'when an icon exists' do\n       let!(:favicon) { Fabricate(:site_upload, var: 'favicon') }\n+      let!(:app_icon) { Fabricate(:site_upload, var: 'app_icon') }\n \n       it 'returns the URL of the icon' do\n-        expect(helper.site_icon_path('favicon')).to eq(favicon.file.url('48'))\n+        expect(helper.favicon_path).to eq(favicon.file.url('48'))\n+        expect(helper.app_icon_path).to eq(app_icon.file.url('48'))\n       end\n \n       it 'returns the URL of the icon with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to eq(favicon.file.url('16'))\n+        expect(helper.favicon_path(16)).to eq(favicon.file.url('16'))\n+        expect(helper.app_icon_path(16)).to eq(app_icon.file.url('16'))\n       end\n     end\n \n     context 'when an icon does not exist' do\n       it 'returns nil' do\n-        expect(helper.site_icon_path('favicon')).to be_nil\n+        expect(helper.favicon_path).to be_nil\n+        expect(helper.app_icon_path).to be_nil\n       end\n \n       it 'returns nil with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to be_nil\n+        expect(helper.favicon_path(16)).to be_nil\n+        expect(helper.app_icon_path(16)).to be_nil\n       end\n     end\n   end\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Unclear how we acquired this status, but [this post](https://mk.itzti.li/notes/9la79fmeadxw63t4) arrived in our instance with an invalid timestamp:\r\n\r\n```\r\ncreated_at: Thu, 07 Nov 11968 17:22:13.599000000 UTC +00:00,\r\nupdated_at: Sat, 28 Oct 2023 15:09:01.341614000 UTC +00:00,\r\n```\r\n\r\n2. since then, a sidekiq job fails once per minute trying to deal with this status:\r\n\r\n```\r\nOct 31 15:05:09 - bundle[3249279]:       `{\"type\"=>\"document_parsing_exception\", \"reason\"=>\"[1:62] failed to parse field [last_status_at] of type [date] in document with id '47476'. Preview of field's value: '11968-11-07T17:22:13.599Z'\", \"caused_by\"=>{\"type\"=>\"illegal_argument_exception\", \"reason\"=>\"failed to parse date field [11968-11-07T17:22:13.599Z] with format [strict_date_optional_time||epoch_millis]\", \"caused_by\"=>{\"type\"=>\"date_time_parse_exception\", \"reason\"=>\"Failed to parse with all enclosed parsers\"}}}`\r\n```\n\n### Expected behaviour\n\nSidekiq should be able to deal with whatever statuses it might encounter\n\n### Actual behaviour\n\nSidekiq dies dealing with this status once per minute\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\ncosocial.ca\n\n### Mastodon version\n\nv4.2.0\n\n### Technical details\n\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: ruby 3.2.2 (2023-03-30 revision e51014f9c0) [x86_64-linux]\r\n- Node.js version: v16.20.2\r\n\n\n---\n\nChoice A:\napp/lib/activitypub/parser/status_parser.rb\n@@ -53,7 +53,8 @@ def title\n   end\n \n   def created_at\n-    @object['published']&.to_datetime\n+    datetime = @object['published']&.to_datetime\n+    datetime if datetime.present? && (0..9999).cover?(datetime.year)\n   rescue ArgumentError\n     nil\n   end\n---\nspec/lib/activitypub/activity/create_spec.rb\n@@ -134,29 +134,67 @@ def activity_for_object(json)\n         subject.perform\n       end\n \n-      context 'when object has been edited' do\n+      context 'when object publication date is below ISO8601 range' do\n         let(:object_json) do\n           {\n             id: [ActivityPub::TagManager.instance.uri_for(sender), '#bar'].join,\n             type: 'Note',\n             content: 'Lorem ipsum',\n-            published: '2022-01-22T15:00:00Z',\n-            updated: '2022-01-22T16:00:00Z',\n+            published: '-0977-11-03T08:31:22Z',\n           }\n         end\n \n-        it 'creates status' do\n+        it 'creates status with a valid creation date', :aggregate_failures do\n+          status = sender.statuses.first\n+\n+          expect(status).to_not be_nil\n+          expect(status.text).to eq 'Lorem ipsum'\n+\n+          expect(status.created_at).to be_within(30).of(Time.now.utc)\n+        end\n+      end\n+\n+      context 'when object publication date is above ISO8601 range' do\n+        let(:object_json) do\n+          {\n+            id: [ActivityPub::TagManager.instance.uri_for(sender), '#bar'].join,\n+            type: 'Note',\n+            content: 'Lorem ipsum',\n+            published: '10000-11-03T08:31:22Z',\n+          }\n+        end\n+\n+        it 'creates status with a valid creation date', :aggregate_failures do\n           status = sender.statuses.first\n \n           expect(status).to_not be_nil\n           expect(status.text).to eq 'Lorem ipsum'\n+\n+          expect(status.created_at).to be_within(30).of(Time.now.utc)\n+        end\n+      end\n+\n+      context 'when object has been edited' do\n+        let(:object_json) do\n+          {\n+            id: [ActivityPub::TagManager.instance.uri_for(sender), '#bar'].join,\n+            type: 'Note',\n+            content: 'Lorem ipsum',\n+            published: '2022-01-22T15:00:00Z',\n+            updated: '2022-01-22T16:00:00Z',\n+          }\n         end\n \n-        it 'marks status as edited' do\n+        it 'creates status with appropriate creation and edition dates', :aggregate_failures do\n           status = sender.statuses.first\n \n           expect(status).to_not be_nil\n+          expect(status.text).to eq 'Lorem ipsum'\n+\n+          expect(status.created_at).to eq '2022-01-22T15:00:00Z'.to_datetime\n+\n           expect(status.edited?).to be true\n+          expect(status.edited_at).to eq '2022-01-22T16:00:00Z'.to_datetime\n         end\n       end\n \n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/components/admin/Retention.jsx\n@@ -9,11 +9,12 @@ import api from 'mastodon/api';\n import { roundTo10 } from 'mastodon/utils/numbers';\n \n const dateForCohort = cohort => {\n+  const timeZone = 'UTC';\n   switch(cohort.frequency) {\n   case 'day':\n-    return <FormattedDate value={cohort.period} month='long' day='2-digit' />;\n+    return <FormattedDate value={cohort.period} month='long' day='2-digit' timeZone={timeZone} />;\n   default:\n-    return <FormattedDate value={cohort.period} month='long' year='numeric' />;\n+    return <FormattedDate value={cohort.period} month='long' year='numeric' timeZone={timeZone} />;\n   }\n };\n \n---\n\n\n---\n\nChoice C:\nconfig/routes.rb\n@@ -142,7 +142,11 @@ def redirect_with_vary(path)\n \n   resource :inbox, only: [:create], module: :activitypub\n \n-  get '/:encoded_at(*path)', to: redirect('/@%{path}'), constraints: { encoded_at: /%40/ }\n+  constraints(encoded_path: /%40.*/) do\n+    get '/:encoded_path', to: redirect { |params|\n+      \"/#{params[:encoded_path].gsub('%40', '@')}\"\n+    }\n+  end\n \n   constraints(username: %r{[^@/.]+}) do\n     with_options to: 'accounts#show' do\n---\nspec/routing/accounts_routing_spec.rb\n@@ -47,6 +47,61 @@\n     end\n   end\n \n+  context 'with local username encoded at' do\n+    include RSpec::Rails::RequestExampleGroup\n+    let(:username) { 'alice' }\n+\n+    it 'routes /%40:username' do\n+      get \"/%40#{username}\"\n+      expect(response).to redirect_to(\"/@#{username}\")\n+    end\n+\n+    it 'routes /%40:username.json' do\n+      get(\"/%40#{username}.json\")\n+      expect(response).to redirect_to(\"/@#{username}.json\")\n+    end\n+\n+    it 'routes /%40:username.rss' do\n+      get(\"/%40#{username}.rss\")\n+      expect(response).to redirect_to(\"/@#{username}.rss\")\n+    end\n+\n+    it 'routes /%40:username/:id' do\n+      get(\"/%40#{username}/123\")\n+      expect(response).to redirect_to(\"/@#{username}/123\")\n+    end\n+\n+    it 'routes /%40:username/:id/embed' do\n+      get(\"/%40#{username}/123/embed\")\n+      expect(response).to redirect_to(\"/@#{username}/123/embed\")\n+    end\n+\n+    it 'routes /%40:username/following' do\n+      get(\"/%40#{username}/following\")\n+      expect(response).to redirect_to(\"/@#{username}/following\")\n+    end\n+\n+    it 'routes /%40:username/followers' do\n+      get(\"/%40#{username}/followers\")\n+      expect(response).to redirect_to(\"/@#{username}/followers\")\n+    end\n+\n+    it 'routes /%40:username/with_replies' do\n+      get(\"/%40#{username}/with_replies\")\n+      expect(response).to redirect_to(\"/@#{username}/with_replies\")\n+    end\n+\n+    it 'routes /%40:username/media' do\n+      get(\"/%40#{username}/media\")\n+      expect(response).to redirect_to(\"/@#{username}/media\")\n+    end\n+\n+    it 'routes /%40:username/tagged/:tag' do\n+      get(\"/%40#{username}/tagged/foo\")\n+      expect(response).to redirect_to(\"/@#{username}/tagged/foo\")\n+    end\n+  end\n+\n   context 'with remote username' do\n     let(:username) { 'alice@example.com' }\n \n@@ -82,4 +137,50 @@\n       expect(get(\"/@#{username}/tagged/foo\")).to route_to('home#index', username_with_domain: username, any: 'tagged/foo')\n     end\n   end\n+\n+  context 'with remote username encoded at' do\n+    include RSpec::Rails::RequestExampleGroup\n+    let(:username) { 'alice%40example.com' }\n+    let(:username_decoded) { 'alice@example.com' }\n+\n+    it 'routes /%40:username' do\n+      get(\"/%40#{username}\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}\")\n+    end\n+\n+    it 'routes /%40:username/:id' do\n+      get(\"/%40#{username}/123\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/123\")\n+    end\n+\n+    it 'routes /%40:username/:id/embed' do\n+      get(\"/%40#{username}/123/embed\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/123/embed\")\n+    end\n+\n+    it 'routes /%40:username/following' do\n+      get(\"/%40#{username}/following\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/following\")\n+    end\n+\n+    it 'routes /%40:username/followers' do\n+      get(\"/%40#{username}/followers\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/followers\")\n+    end\n+\n+    it 'routes /%40:username/with_replies' do\n+      get(\"/%40#{username}/with_replies\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/with_replies\")\n+    end\n+\n+    it 'routes /%40:username/media' do\n+      get(\"/%40#{username}/media\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/media\")\n+    end\n+\n+    it 'routes /%40:username/tagged/:tag' do\n+      get(\"/%40#{username}/tagged/foo\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/tagged/foo\")\n+    end\n+  end\n end\n---\n\n\n---\n\nChoice D:\nlib/mastodon/cli/feeds.rb\n@@ -5,6 +5,7 @@\n module Mastodon::CLI\n   class Feeds < Base\n     include Redisable\n+    include DatabaseHelper\n \n     option :all, type: :boolean, default: false\n     option :concurrency, type: :numeric, default: 5, aliases: [:c]\n@@ -44,6 +45,38 @@ def clear\n       say('OK', :green)\n     end\n \n+    desc 'vacuum', 'Remove home feeds of inactive users from Redis'\n+    long_desc <<-LONG_DESC\n+      Running this task should not be needed in most cases, as Mastodon will\n+      automatically clean up feeds from inactive accounts every day.\n+\n+      However, this task is more aggressive in order to clean up feeds that\n+      may have been missed because of bugs or database mishaps.\n+    LONG_DESC\n+    def vacuum\n+      with_read_replica do\n+        say('Deleting orphaned home feeds\u2026')\n+        redis.scan_each(match: 'feed:home:*').each_slice(1000) do |keys|\n+          ids = keys.map { |key| key.split(':')[2] }.compact_blank\n+\n+          known_ids = User.confirmed.signed_in_recently.where(account_id: ids).pluck(:account_id)\n+\n+          keys_to_delete = keys.filter { |key| known_ids.exclude?(key.split(':')[2]&.to_i) }\n+          redis.del(keys_to_delete)\n+        end\n+\n+        say('Deleting orphaned list feeds\u2026')\n+        redis.scan_each(match: 'feed:list:*').each_slice(1000) do |keys|\n+          ids = keys.map { |key| key.split(':')[2] }.compact_blank\n+\n+          known_ids = List.where(account_id: User.confirmed.signed_in_recently.select(:account_id)).where(id: ids).pluck(:id)\n+\n+          keys_to_delete = keys.filter { |key| known_ids.exclude?(key.split(':')[2]&.to_i) }\n+          redis.del(keys_to_delete)\n+        end\n+      end\n+    end\n+\n     private\n \n     def active_user_accounts\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nWhen requesting e.g. `https://mastodon.social/users/Gargron` without explicitly requesting a JSON document, a 301 redirect to `https://mastodon.social/@Gargron` is returned.\r\n\r\nDespite the `cache-control: no-cache`, this may be cached because of the 301 status, and then returned from cache even when explicitly requesting the JSON version.\r\n\r\nThis PR adds `Accept` to the `Vary` to avoid this issue. Unfortunately, this doesn't seem to be doable out of the box, hence the `RedirectWithVary` class.\n\n---\n\nChoice A:\napp/controllers/api/v1/suggestions_controller.rb\n@@ -4,7 +4,7 @@ class Api::V1::SuggestionsController < Api::BaseController\n   include Authorization\n   include DeprecationConcern\n \n-  deprecate_api '2021-05-16'\n+  deprecate_api '2021-05-16', only: [:index]\n \n   before_action -> { doorkeeper_authorize! :read, :'read:accounts' }, only: :index\n   before_action -> { doorkeeper_authorize! :write, :'write:accounts' }, except: :index\n---\n\n\n---\n\nChoice B:\napp/models/tag.rb\n@@ -35,7 +35,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?:^|[^/)\\w])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)[:word]])#(#{HASHTAG_NAME_PAT})}i\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/tag_spec.rb\n@@ -32,52 +32,56 @@\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)#Lawsuit')).to be_nil\n     end\n \n+    it 'does not match URLs with hashtag-like anchors after an empty query parameter' do\n+      expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)?foo=#Lawsuit')).to be_nil\n+    end\n+\n     it 'matches \ufeff#\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43' do\n-      expect(subject.match('\ufeffthis is #\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43').to_s).to eq ' #\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43'\n+      expect(subject.match('\ufeffthis is #\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43').to_s).to eq '#\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43'\n     end\n \n     it 'matches digits at the start' do\n-      expect(subject.match('hello #3d').to_s).to eq ' #3d'\n+      expect(subject.match('hello #3d').to_s).to eq '#3d'\n     end\n \n     it 'matches digits in the middle' do\n-      expect(subject.match('hello #l33ts35k').to_s).to eq ' #l33ts35k'\n+      expect(subject.match('hello #l33ts35k').to_s).to eq '#l33ts35k'\n     end\n \n     it 'matches digits at the end' do\n-      expect(subject.match('hello #world2016').to_s).to eq ' #world2016'\n+      expect(subject.match('hello #world2016').to_s).to eq '#world2016'\n     end\n \n     it 'matches underscores at the beginning' do\n-      expect(subject.match('hello #_test').to_s).to eq ' #_test'\n+      expect(subject.match('hello #_test').to_s).to eq '#_test'\n     end\n \n     it 'matches underscores at the end' do\n-      expect(subject.match('hello #test_').to_s).to eq ' #test_'\n+      expect(subject.match('hello #test_').to_s).to eq '#test_'\n     end\n \n     it 'matches underscores in the middle' do\n-      expect(subject.match('hello #one_two_three').to_s).to eq ' #one_two_three'\n+      expect(subject.match('hello #one_two_three').to_s).to eq '#one_two_three'\n     end\n \n     it 'matches middle dots' do\n-      expect(subject.match('hello #one\u00b7two\u00b7three').to_s).to eq ' #one\u00b7two\u00b7three'\n+      expect(subject.match('hello #one\u00b7two\u00b7three').to_s).to eq '#one\u00b7two\u00b7three'\n     end\n \n     it 'matches \u30fbunicode in \u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f correctly' do\n-      expect(subject.match('testing #\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f').to_s).to eq ' #\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f'\n+      expect(subject.match('testing #\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f').to_s).to eq '#\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f'\n     end\n \n     it 'matches ZWNJ' do\n-      expect(subject.match('just add #\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631 and').to_s).to eq ' #\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631'\n+      expect(subject.match('just add #\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631 and').to_s).to eq '#\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631'\n     end\n \n     it 'does not match middle dots at the start' do\n       expect(subject.match('hello #\u00b7one\u00b7two\u00b7three')).to be_nil\n     end\n \n     it 'does not match middle dots at the end' do\n-      expect(subject.match('hello #one\u00b7two\u00b7three\u00b7').to_s).to eq ' #one\u00b7two\u00b7three'\n+      expect(subject.match('hello #one\u00b7two\u00b7three\u00b7').to_s).to eq '#one\u00b7two\u00b7three'\n     end\n \n     it 'does not match purely-numeric hashtags' do\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -9288,6 +9288,7 @@ noscript {\n   border: 1px solid $highlight-text-color;\n   background: rgba($highlight-text-color, 0.15);\n   overflow: hidden;\n+  flex-shrink: 0;\n \n   &__background-image {\n     width: 125%;\n---\n\n\n---\n\nChoice D:\nconfig/routes.rb\n@@ -3,6 +3,18 @@\n require 'sidekiq_unique_jobs/web'\n require 'sidekiq-scheduler/web'\n \n+class RedirectWithVary < ActionDispatch::Routing::PathRedirect\n+  def serve(...)\n+    super.tap do |_, headers, _|\n+      headers['Vary'] = 'Origin, Accept'\n+    end\n+  end\n+end\n+\n+def redirect_with_vary(path)\n+  RedirectWithVary.new(301, path)\n+end\n+\n Rails.application.routes.draw do\n   # Paths of routes on the web app that to not require to be indexed or\n   # have alternative format representations requiring separate controllers\n@@ -90,10 +102,13 @@\n     confirmations:      'auth/confirmations',\n   }\n \n-  get '/users/:username', to: redirect('/@%{username}'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n-  get '/users/:username/following', to: redirect('/@%{username}/following'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n-  get '/users/:username/followers', to: redirect('/@%{username}/followers'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n-  get '/users/:username/statuses/:id', to: redirect('/@%{username}/%{id}'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  # rubocop:disable Style/FormatStringToken - those do not go through the usual formatting functions and are not safe to correct\n+  get '/users/:username', to: redirect_with_vary('/@%{username}'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  get '/users/:username/following', to: redirect_with_vary('/@%{username}/following'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  get '/users/:username/followers', to: redirect_with_vary('/@%{username}/followers'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  get '/users/:username/statuses/:id', to: redirect_with_vary('/@%{username}/%{id}'), constraints: lambda { |req| req.format.nil? || req.format.html? }\n+  # rubocop:enable Style/FormatStringToken\n+\n   get '/authorize_follow', to: redirect { |_, request| \"/authorize_interaction?#{request.params.to_query}\" }\n \n   resources :accounts, path: 'users', only: [:show], param: :username do\n---\nspec/requests/cache_spec.rb\n@@ -124,7 +124,7 @@ module DisabledAnonymousAPI\n       expect(response.cookies).to be_empty\n     end\n \n-    it 'sets public cache control' do\n+    it 'sets public cache control', :aggregate_failures do\n       # expect(response.cache_control[:max_age]&.to_i).to be_positive\n       expect(response.cache_control[:public]).to be_truthy\n       expect(response.cache_control[:private]).to be_falsy\n@@ -141,11 +141,8 @@ module DisabledAnonymousAPI\n   end\n \n   shared_examples 'non-cacheable error' do\n-    it 'does not return HTTP success' do\n+    it 'does not return HTTP success and does not have cache headers', :aggregate_failures do\n       expect(response).to_not have_http_status(200)\n-    end\n-\n-    it 'does not have cache headers' do\n       expect(response.cache_control[:public]).to be_falsy\n     end\n   end\n@@ -182,6 +179,15 @@ module DisabledAnonymousAPI\n   end\n \n   context 'when anonymously accessed' do\n+    describe '/users/alice' do\n+      it 'redirects with proper cache header', :aggregate_failures do\n+        get '/users/alice'\n+\n+        expect(response).to redirect_to('/@alice')\n+        expect(response.headers['Vary']&.split(',')&.map { |x| x.strip.downcase }).to include('accept')\n+      end\n+    end\n+\n     TestEndpoints::ALWAYS_CACHED.each do |endpoint|\n       describe endpoint do\n         before { get endpoint }\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Manually delete a media file/directory from the OpenStack Swift object storage (to simulate a missing file)\r\n2. Run AttachmentBatch deletion that would attempt to delete that file\n\n### Expected behaviour\n\nLog error and continue\n\n### Actual behaviour\n\nStops AttachmentBatch deletion\n\n### Detailed description\n\nWith the fix introduced in #27554 AttachmentBatch deletion is working but it introduces a couple of problems.\r\n\r\nIf OpenStack Swift object storage stops fails to respond either due to a server error (500 or similar) or in my case because it hit the maximum requests per minute (429 Too Many Requests), the object may be deleted in the object storage but the database not updated to reflect that.\r\n\r\nThe next time you attempt to run AttachmentBatch deletion where that media is again marked for deletion, the process exits because the file is missing \"Expected(204) <=> Actual(404 Not Found)\".\r\n\r\nNote that a file may also be missing for other reasons, like failing to properly upload or some other error. So, it would be good to just ignore files that were missing but continue to fail if other errors from the object storage (500, 429, etc). Possibly something similar to what we see on the filesystem storage https://github.com/mastodon/mastodon/blob/863ba46b00ea8b736e7473264e54b73029cafb60/app/lib/attachment_batch.rb#L72-L74\n\n### Mastodon instance\n\nSeveral\n\n### Mastodon version\n\nv4.2.1 + #27554\n\n### Technical details\n\nOpenStack Swift Object Storage with #27554 \r\n\n\n---\n\nChoice A:\napp/models/account_suggestions/friends_of_friends_source.rb\n@@ -2,15 +2,19 @@\n \n class AccountSuggestions::FriendsOfFriendsSource < AccountSuggestions::Source\n   def get(account, limit: DEFAULT_LIMIT)\n+    source_query(account, limit: limit)\n+      .map { |id, _frequency, _followers_count| [id, key] }\n+  end\n+\n+  def source_query(account, limit: DEFAULT_LIMIT)\n     first_degree = account.following.where.not(hide_collections: true).select(:id).reorder(nil)\n     base_account_scope(account)\n       .joins(:account_stat)\n-      .where(id: Follow.where(account_id: first_degree).select(:target_account_id))\n+      .joins(:passive_relationships).where(passive_relationships: { account_id: first_degree })\n       .group('accounts.id, account_stats.id')\n-      .reorder('frequency DESC, followers_count DESC')\n+      .reorder(frequency: :desc, followers_count: :desc)\n       .limit(limit)\n-      .pluck(Arel.sql('accounts.id, COUNT(*) AS frequency'))\n-      .map { |id, _frequency| [id, key] }\n+      .pluck(Arel.sql('accounts.id, COUNT(*) AS frequency, followers_count'))\n   end\n \n   private\n---\nspec/models/account_suggestions/friends_of_friends_source_spec.rb\n@@ -11,9 +11,9 @@\n     let!(:eve) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:mallory) { Fabricate(:account, discoverable: false, hide_collections: false) }\n     let!(:eugen) { Fabricate(:account, discoverable: true, hide_collections: false) }\n+    let!(:neil) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:john) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:jerk) { Fabricate(:account, discoverable: true, hide_collections: false) }\n-    let!(:neil) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:larry) { Fabricate(:account, discoverable: true, hide_collections: false) }\n \n     context 'with follows and blocks' do\n@@ -70,13 +70,31 @@\n       end\n \n       it 'returns eligible accounts in the expected order' do\n-        expect(subject.get(bob)).to eq [\n-          [eugen.id, :friends_of_friends], # followed by 2 friends, 3 followers total\n-          [john.id, :friends_of_friends], # followed by 2 friends, 2 followers total\n-          [neil.id, :friends_of_friends], # followed by 1 friend, 2 followers total\n-          [jerk.id, :friends_of_friends], # followed by 1 friend, 1 follower total\n+        expect(subject.get(bob)).to eq expected_results\n+      end\n+\n+      it 'contains correct underlying source data' do\n+        expect(source_query_values)\n+          .to contain_exactly(\n+            [eugen.id, 2, 3], # Followed by 2 friends of bob (eve, mallory), 3 followers total (breaks tie)\n+            [john.id, 2, 2],  # Followed by 2 friends of bob (eve, mallory), 2 followers total\n+            [neil.id, 1, 2],  # Followed by 1 friends of bob (mallory), 2 followers total (breaks tie)\n+            [jerk.id, 1, 1]   # Followed by 1 friends of bob (eve), 1 followers total\n+          )\n+      end\n+\n+      def expected_results\n+        [\n+          [eugen.id, :friends_of_friends],\n+          [john.id, :friends_of_friends],\n+          [neil.id, :friends_of_friends],\n+          [jerk.id, :friends_of_friends],\n         ]\n       end\n+\n+      def source_query_values\n+        subject.source_query(bob).to_a\n+      end\n     end\n   end\n end\n---\n\n\n---\n\nChoice B:\nlib/paperclip/response_with_limit_adapter.rb\n@@ -16,7 +16,7 @@ def initialize(target, options = {})\n     private\n \n     def cache_current_values\n-      @original_filename = filename_from_content_disposition.presence || filename_from_path.presence || 'data'\n+      @original_filename = truncated_filename\n       @tempfile = copy_to_tempfile(@target)\n       @content_type = ContentTypeDetector.new(@tempfile.path).detect\n       @size = File.size(@tempfile)\n@@ -43,6 +43,13 @@ def copy_to_tempfile(source)\n       source.response.connection.close\n     end\n \n+    def truncated_filename\n+      filename = filename_from_content_disposition.presence || filename_from_path.presence || 'data'\n+      extension = File.extname(filename)\n+      basename = File.basename(filename, extension)\n+      [basename[...20], extension[..4]].compact_blank.join\n+    end\n+\n     def filename_from_content_disposition\n       disposition = @target.response.headers['content-disposition']\n       disposition&.match(/filename=\"([^\"]*)\"/)&.captures&.first\n---\n\n\n---\n\nChoice C:\napp/lib/attachment_batch.rb\n@@ -75,7 +75,12 @@ def remove_files\n             end\n           when :fog\n             logger.debug { \"Deleting #{attachment.path(style)}\" }\n-            attachment.send(:directory).files.new(key: attachment.path(style)).destroy\n+\n+            begin\n+              attachment.send(:directory).files.new(key: attachment.path(style)).destroy\n+            rescue Fog::Storage::OpenStack::NotFound\n+              # Ignore failure to delete a file that has already been deleted\n+            end\n           when :azure\n             logger.debug { \"Deleting #{attachment.path(style)}\" }\n             attachment.destroy\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/actions/interactions.js\n@@ -1,5 +1,6 @@\n-import api from '../api';\n+import api, { getLinks } from '../api';\n \n+import { fetchRelationships } from './accounts';\n import { importFetchedAccounts, importFetchedStatus } from './importer';\n \n export const REBLOG_REQUEST = 'REBLOG_REQUEST';\n@@ -26,6 +27,10 @@ export const FAVOURITES_FETCH_REQUEST = 'FAVOURITES_FETCH_REQUEST';\n export const FAVOURITES_FETCH_SUCCESS = 'FAVOURITES_FETCH_SUCCESS';\n export const FAVOURITES_FETCH_FAIL    = 'FAVOURITES_FETCH_FAIL';\n \n+export const FAVOURITES_EXPAND_REQUEST = 'FAVOURITES_EXPAND_REQUEST';\n+export const FAVOURITES_EXPAND_SUCCESS = 'FAVOURITES_EXPAND_SUCCESS';\n+export const FAVOURITES_EXPAND_FAIL = 'FAVOURITES_EXPAND_FAIL';\n+\n export const PIN_REQUEST = 'PIN_REQUEST';\n export const PIN_SUCCESS = 'PIN_SUCCESS';\n export const PIN_FAIL    = 'PIN_FAIL';\n@@ -308,8 +313,10 @@ export function fetchFavourites(id) {\n     dispatch(fetchFavouritesRequest(id));\n \n     api(getState).get(`/api/v1/statuses/${id}/favourited_by`).then(response => {\n+      const next = getLinks(response).refs.find(link => link.rel === 'next');\n       dispatch(importFetchedAccounts(response.data));\n-      dispatch(fetchFavouritesSuccess(id, response.data));\n+      dispatch(fetchFavouritesSuccess(id, response.data, next ? next.uri : null));\n+      dispatch(fetchRelationships(response.data.map(item => item.id)));\n     }).catch(error => {\n       dispatch(fetchFavouritesFail(id, error));\n     });\n@@ -323,17 +330,62 @@ export function fetchFavouritesRequest(id) {\n   };\n }\n \n-export function fetchFavouritesSuccess(id, accounts) {\n+export function fetchFavouritesSuccess(id, accounts, next) {\n   return {\n     type: FAVOURITES_FETCH_SUCCESS,\n     id,\n     accounts,\n+    next,\n   };\n }\n \n export function fetchFavouritesFail(id, error) {\n   return {\n     type: FAVOURITES_FETCH_FAIL,\n+    id,\n+    error,\n+  };\n+}\n+\n+export function expandFavourites(id) {\n+  return (dispatch, getState) => {\n+    const url = getState().getIn(['user_lists', 'favourited_by', id, 'next']);\n+    if (url === null) {\n+      return;\n+    }\n+\n+    dispatch(expandFavouritesRequest(id));\n+\n+    api(getState).get(url).then(response => {\n+      const next = getLinks(response).refs.find(link => link.rel === 'next');\n+\n+      dispatch(importFetchedAccounts(response.data));\n+      dispatch(expandFavouritesSuccess(id, response.data, next ? next.uri : null));\n+      dispatch(fetchRelationships(response.data.map(item => item.id)));\n+    }).catch(error => dispatch(expandFavouritesFail(id, error)));\n+  };\n+}\n+\n+export function expandFavouritesRequest(id) {\n+  return {\n+    type: FAVOURITES_EXPAND_REQUEST,\n+    id,\n+  };\n+}\n+\n+export function expandFavouritesSuccess(id, accounts, next) {\n+  return {\n+    type: FAVOURITES_EXPAND_SUCCESS,\n+    id,\n+    accounts,\n+    next,\n+  };\n+}\n+\n+export function expandFavouritesFail(id, error) {\n+  return {\n+    type: FAVOURITES_EXPAND_FAIL,\n+    id,\n     error,\n   };\n }\n---\napp/javascript/mastodon/features/favourites/index.jsx\n@@ -8,7 +8,9 @@ import ImmutablePropTypes from 'react-immutable-proptypes';\n import ImmutablePureComponent from 'react-immutable-pure-component';\n import { connect } from 'react-redux';\n \n-import { fetchFavourites } from 'mastodon/actions/interactions';\n+import { debounce } from 'lodash';\n+\n+import { fetchFavourites, expandFavourites } from 'mastodon/actions/interactions';\n import ColumnHeader from 'mastodon/components/column_header';\n import { Icon }  from 'mastodon/components/icon';\n import { LoadingIndicator } from 'mastodon/components/loading_indicator';\n@@ -21,7 +23,9 @@ const messages = defineMessages({\n });\n \n const mapStateToProps = (state, props) => ({\n-  accountIds: state.getIn(['user_lists', 'favourited_by', props.params.statusId]),\n+  accountIds: state.getIn(['user_lists', 'favourited_by', props.params.statusId, 'items']),\n+  hasMore: !!state.getIn(['user_lists', 'favourited_by', props.params.statusId, 'next']),\n+  isLoading: state.getIn(['user_lists', 'favourited_by', props.params.statusId, 'isLoading'], true),\n });\n \n class Favourites extends ImmutablePureComponent {\n@@ -30,6 +34,8 @@ class Favourites extends ImmutablePureComponent {\n     params: PropTypes.object.isRequired,\n     dispatch: PropTypes.func.isRequired,\n     accountIds: ImmutablePropTypes.list,\n+    hasMore: PropTypes.bool,\n+    isLoading: PropTypes.bool,\n     multiColumn: PropTypes.bool,\n     intl: PropTypes.object.isRequired,\n   };\n@@ -40,18 +46,16 @@ class Favourites extends ImmutablePureComponent {\n     }\n   }\n \n-  UNSAFE_componentWillReceiveProps (nextProps) {\n-    if (nextProps.params.statusId !== this.props.params.statusId && nextProps.params.statusId) {\n-      this.props.dispatch(fetchFavourites(nextProps.params.statusId));\n-    }\n-  }\n-\n   handleRefresh = () => {\n     this.props.dispatch(fetchFavourites(this.props.params.statusId));\n   };\n \n+  handleLoadMore = debounce(() => {\n+    this.props.dispatch(expandFavourites(this.props.params.statusId));\n+  }, 300, { leading: true });\n+\n   render () {\n-    const { intl, accountIds, multiColumn } = this.props;\n+    const { intl, accountIds, hasMore, isLoading, multiColumn } = this.props;\n \n     if (!accountIds) {\n       return (\n@@ -75,6 +79,9 @@ class Favourites extends ImmutablePureComponent {\n \n         <ScrollableList\n           scrollKey='favourites'\n+          onLoadMore={this.handleLoadMore}\n+          hasMore={hasMore}\n+          isLoading={isLoading}\n           emptyMessage={emptyMessage}\n           bindToDocument={!multiColumn}\n         >\n---\napp/javascript/mastodon/reducers/user_lists.js\n@@ -46,7 +46,12 @@ import {\n } from '../actions/blocks';\n import {\n   REBLOGS_FETCH_SUCCESS,\n+  FAVOURITES_FETCH_REQUEST,\n   FAVOURITES_FETCH_SUCCESS,\n+  FAVOURITES_FETCH_FAIL,\n+  FAVOURITES_EXPAND_REQUEST,\n+  FAVOURITES_EXPAND_SUCCESS,\n+  FAVOURITES_EXPAND_FAIL,\n } from '../actions/interactions';\n import {\n   MUTES_FETCH_REQUEST,\n@@ -136,7 +141,15 @@ export default function userLists(state = initialState, action) {\n   case REBLOGS_FETCH_SUCCESS:\n     return state.setIn(['reblogged_by', action.id], ImmutableList(action.accounts.map(item => item.id)));\n   case FAVOURITES_FETCH_SUCCESS:\n-    return state.setIn(['favourited_by', action.id], ImmutableList(action.accounts.map(item => item.id)));\n+    return normalizeList(state, ['favourited_by', action.id], action.accounts, action.next);\n+  case FAVOURITES_EXPAND_SUCCESS:\n+    return appendToList(state, ['favourited_by', action.id], action.accounts, action.next);\n+  case FAVOURITES_FETCH_REQUEST:\n+  case FAVOURITES_EXPAND_REQUEST:\n+    return state.setIn(['favourited_by', action.id, 'isLoading'], true);\n+  case FAVOURITES_FETCH_FAIL:\n+  case FAVOURITES_EXPAND_FAIL:\n+    return state.setIn(['favourited_by', action.id, 'isLoading'], false);\n   case NOTIFICATIONS_UPDATE:\n     return action.notification.type === 'follow_request' ? normalizeFollowRequest(state, action.notification) : state;\n   case FOLLOW_REQUESTS_FETCH_SUCCESS:\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. post `lets go https://gcc.gnu.org/bugzilla/show_bug.cgi?id=111895#c4`\r\n\r\n### Expected behaviour\r\n\r\nthe post contains `lets go https://gcc.gnu.org/bugzilla/show_bug.cgi?id=111895#c4`\r\n\r\n### Actual behaviour\r\n\r\nthe post contains `lets go https://gcc.gnu.org/bugzilla/show_bug.cgi?id=111895#c4`, then vertical space, then the hash-tag bar with `#c4` in it\r\n\r\n### Detailed description\r\n\r\ngithub is saying that \"Something went really wrong, and we can't process that file. Try again.\" for my screenshot, and it's refusing to accept URLs with a data scheme, so here's a data URL with a scrussy to open separately via pasting: <data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAA54AAAEqAQAAAABVMLIAAAAAAmJLR0QAAKqNIzIAAAAJcEhZcwAACxMAAAsTAQCanBgAAAfiSURBVHja7d3NTuNIAgfwsrxq94HBc0zUEB/2BYiQtkGb4HmAeQhakYbLiKaFNAoi3WUU7XIJ7StoaPIKjfrCqLMTt1jhC0uuHFZgFGl8GXUcRdo4il21VU6gE3oMgeCyNNRfAiWx5B/16Y9UCACPJ2+AaDFHPaB4rE3BAhBrrFFDxJh1/QqagrHHHMUkjOtXoCbr+u2hLn04yRhFvREbdRaGUNwbsVEHaxODqCbNd4zoa9XIXEP9yEsq6lZhGP37OxQ5+g/re9UbROemTyJHN5wJFQ2iHf8oalQqOhPzR4NolwFacybSR8NtGn314q9QH7FH573ohwy2hlEmU64XAwqwEQMKhyd8NujTOFDAUY5ydFxUFLbJ70XyM8sIRRQ9vUQ1Jqhga0AMXqHoDJuSihv6Yb257RbQ0klugVH1igs1u9XZ8RBa+m1VZYQ++en4h9nkTuloavmn1dUPjNAfjhdnp7e/MRI//u1/L1ihx98vtaZ3fGPuZesMMkOPl2and/5jrLysn8FZZujybPLn0tHi8l/3XrFC8fFSv/e2dlVW1QtLS63mjkfG6UWJ1ZDpzUYJthO++G/6bI7xUSa4qMjzg/hDX19c3dJhGHh184qHh4eHh4eHh+dannz1yjf0DDF5ABKi9ofbHwS9fnNjuo/OsUST1BIOwEyEqFpw5bql1ExDVbeNNwso6ZlqdecXN91yC0czkp14+HcznsDXnmw76nnNggSFKkp7JqzufHRzXQ/ZK1I7GQG6ul+aWp6bP/19JZfeNurpt+m35upm8mMi92zr6OXik+fJ0sOjuX2LoDOnE6BO0EOC/tN8sZk8SOQOt0yKPosAhe+9xHJiAH1B0LfJX9xPra1NgqrRoJnhklJ0N/nx1FjfMtesaEr6av5am168tVe3kx+Th6RN541o2hT+q997f4Pp8glMo08epr23U+yW0LwhtTreyemDj9MprzdOj9S0fvJmhqCQjlN/o1UqELTueif/jWCCeLoIBAP0b/vK9JHW+yHPHAAmIpn0ZQuoWv9tOIFOBfDLJqf3SgSoARTtcjkJXc6iDt2dcPmxmIeHh4eHhyfOQMwmgyc9gsWocKmBx70zTQaRbrznEFEELWZ0glmPNWJGnzJDv+MoRznKUY5ylKN/RlQtK0K3U5JrVZZotVqkaAMzRFf394vP3pWmfswxRHPvZ0SCJv78aCzVSzrSh+47v/Y7ZDtk0t1dv3asMkTp1WOwOFRkWVLCBdfNkC0qOPTBAp/wHwiVol+K+kfo+zjQgzjQShzor3Gg1VhQ7bEMGaxx9NGhggVWrp7Q/1ogGf0NxtXLKQCCgyKw6DmAQX5PkQfyCKio5aUNTzkcWKRPP3sh2NowKg+ikjaAim4PbdyCGsoVqhZdtYjU+m2oYjghqORdotIu2TBKSSm6ieCtaAqEoTK6H1pes7Vb2nQIHWpTeeGyTW9GB6p3tph/vqnn21pwOnpeq3eNdZRvN+2yI19g2W65WPcQQGoR6/DQhUJlHStmuYtINxA8bDb9RspQdRcaNVjzFNuR3dE60uZZvh2sYjk/P28RFK81OnbVUTq43G57uOZjAVeLuAZtD2uZdaza5S75hUSEax3fWgCEw4YMG5bScGVvNLSIXreRiA18fo6H0Wobe/jcxxs9tOH30WoXw8YlmiGo30fxHVAYoE2sZLoX2nota2XtirOwZlegMdU6y9pFew+0ztYaSpugZsWurNfyOCXpTSvrGAUgNLJ1QyYdQ9oryJkRqxepjkJLilKZdQOsm6rp25WVTNas4qJXP8si8fAMNNGrBkaAoNXNyroOA9T2LeAC9TNF8xTNyKkRUX3SoZ2OoHM9tObbBwQ9rOJNgmZwD11pIFq9ZtU+6KFas+Fb5FwdXqG7N6FgGBVsijqpfkmV82yvpBVJ3yUoLFLUe9UAKkV1Ur16XqYozlqiBTojlHT4AoqiImkzANyzVKb7SSPoXr9Nf32uZ0j1mrRNHW+tsWVTtEPRwktavShrmQZofkFJm+a+HQklI4/OSPgspbYODYKW/cveq3v1oPfuAc8Leq/SNTHpvXrQe5vYv2gggD9nMUUtifbetjsKWkS9CR+ilBKgst5Hy2RmqAfjlKAutFGAVsk41dU2RRsBCj9n+igdp3TM346So0ywoE3dS8n1AJV9OiM1yYy0ieo1MiPhFCjk6YwE5K5ZJjOSHsxIX1BI0Lol0hmpfTDOBdTAPEvjfJmNE+6dD+L3Q8UBVHFiQFVmqDVQUotfiXOUoxzlKEfjQ0VevRzl6P3Qx7Oa7vGskIxlAWosS21jWVTMw8PDw8PDw8PzqHPK6t8qDqN55qbkxYAK+64bB3rKHv3wbpt9m3ZF9qiYE70Y0HIM6As38ThQHh4eHh4eHh4enkeRwTfeRs6430Nzr3f4wm5TyCN++6Z0HzQ/JiqHo+HvlxfGRJXwjytPh+7CGxNVsXX5cZDrWQjbhYDGRCF2JCtskxX2h7rjou7kYsimjQdDldfWtR2EoTgMVbBzZ9QZ3kEYKuBP1h33PSoqF72wkqakkF4qYWM8VNIKoagc0kvFsA9MhaKT89bwNJgJ672hJb07+tWEnwkbp0rXjQi94bt7FN8Ja9MwtDEqmgifIe+MmuOjKGQXkhmGFkdFbzgifxeCCiG9YHLkpTDfPtxpyF/C/kweHh4eHh4eHp6Q/B8tfcJrc83nCAAAAABJRU5ErkJggg==>\r\n\r\n### Mastodon instance\r\n\r\n101010.pl\r\n\r\n### Mastodon version\r\n\r\nv4.3.0-alpha.0\r\n\r\n### Browser name and version\r\n\r\nfirefox deved 87.0b9 (64-bit)\r\n\r\n### Operating system\r\n\r\nwindows 10\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -4,8 +4,6 @@ import { Children, cloneElement, useCallback } from 'react';\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import ImmutablePureComponent from 'react-immutable-pure-component';\n \n-import { supportsPassiveEvents } from 'detect-passive-events';\n-\n import { scrollRight } from '../../../scroll';\n import BundleContainer from '../containers/bundle_container';\n import {\n@@ -71,10 +69,6 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   };\n \n   componentDidMount() {\n-    if (!this.props.singleColumn) {\n-      this.node.addEventListener('wheel', this.handleWheel, supportsPassiveEvents ? { passive: true } : false);\n-    }\n-\n     if (this.mediaQuery) {\n       if (this.mediaQuery.addEventListener) {\n         this.mediaQuery.addEventListener('change', this.handleLayoutChange);\n@@ -87,23 +81,7 @@ export default class ColumnsArea extends ImmutablePureComponent {\n     this.isRtlLayout = document.getElementsByTagName('body')[0].classList.contains('rtl');\n   }\n \n-  UNSAFE_componentWillUpdate(nextProps) {\n-    if (this.props.singleColumn !== nextProps.singleColumn && nextProps.singleColumn) {\n-      this.node.removeEventListener('wheel', this.handleWheel);\n-    }\n-  }\n-\n-  componentDidUpdate(prevProps) {\n-    if (this.props.singleColumn !== prevProps.singleColumn && !this.props.singleColumn) {\n-      this.node.addEventListener('wheel', this.handleWheel, supportsPassiveEvents ? { passive: true } : false);\n-    }\n-  }\n-\n   componentWillUnmount () {\n-    if (!this.props.singleColumn) {\n-      this.node.removeEventListener('wheel', this.handleWheel);\n-    }\n-\n     if (this.mediaQuery) {\n       if (this.mediaQuery.removeEventListener) {\n         this.mediaQuery.removeEventListener('change', this.handleLayoutChange);\n@@ -116,22 +94,14 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   handleChildrenContentChange() {\n     if (!this.props.singleColumn) {\n       const modifier = this.isRtlLayout ? -1 : 1;\n-      this._interruptScrollAnimation = scrollRight(this.node, (this.node.scrollWidth - window.innerWidth) * modifier);\n+      scrollRight(this.node, (this.node.scrollWidth - window.innerWidth) * modifier);\n     }\n   }\n \n   handleLayoutChange = (e) => {\n     this.setState({ renderComposePanel: !e.matches });\n   };\n \n-  handleWheel = () => {\n-    if (typeof this._interruptScrollAnimation !== 'function') {\n-      return;\n-    }\n-\n-    this._interruptScrollAnimation();\n-  };\n-\n   setRef = (node) => {\n     this.node = node;\n   };\n---\napp/javascript/mastodon/scroll.ts\n@@ -38,13 +38,20 @@ const scroll = (\n const isScrollBehaviorSupported =\n   'scrollBehavior' in document.documentElement.style;\n \n-export const scrollRight = (node: Element, position: number) => {\n-  if (isScrollBehaviorSupported)\n-    node.scrollTo({ left: position, behavior: 'smooth' });\n-  else scroll(node, 'scrollLeft', position);\n-};\n-\n-export const scrollTop = (node: Element) => {\n-  if (isScrollBehaviorSupported) node.scrollTo({ top: 0, behavior: 'smooth' });\n-  else scroll(node, 'scrollTop', 0);\n-};\n+export const scrollRight = (node: Element, position: number) =>\n+  requestIdleCallback(() => {\n+    if (isScrollBehaviorSupported) {\n+      node.scrollTo({ left: position, behavior: 'smooth' });\n+    } else {\n+      scroll(node, 'scrollLeft', position);\n+    }\n+  });\n+\n+export const scrollTop = (node: Element) =>\n+  requestIdleCallback(() => {\n+    if (isScrollBehaviorSupported) {\n+      node.scrollTo({ top: 0, behavior: 'smooth' });\n+    } else {\n+      scroll(node, 'scrollTop', 0);\n+    }\n+  });\n---\napp/javascript/mastodon/test_helpers.tsx\n@@ -8,6 +8,14 @@ import { render as rtlRender } from '@testing-library/react';\n \n import { IdentityContext } from './identity_context';\n \n+beforeEach(() => {\n+  global.requestIdleCallback = jest\n+    .fn()\n+    .mockImplementation((fn: () => void) => {\n+      fn();\n+    });\n+});\n+\n function render(\n   ui: React.ReactElement,\n   {\n---\n\n\n---\n\nChoice B:\napp/models/tag.rb\n@@ -35,7 +35,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?<![=/)[:word]])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)\\w])#(#{HASHTAG_NAME_PAT})}i\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/tag_spec.rb\n@@ -32,6 +32,10 @@\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)#Lawsuit')).to be_nil\n     end\n \n+    it 'does not match URLs with hashtag-like anchors after a numeral' do\n+      expect(subject.match('https://gcc.gnu.org/bugzilla/show_bug.cgi?id=111895#c4')).to be_nil\n+    end\n+\n     it 'does not match URLs with hashtag-like anchors after an empty query parameter' do\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)?foo=#Lawsuit')).to be_nil\n     end\n---\n\n\n---\n\nChoice C:\nstreaming/index.js\n@@ -109,6 +109,11 @@ const pgConfigFromEnv = (env) => {\n \n   if (env.DATABASE_URL) {\n     baseConfig = dbUrlToConfig(env.DATABASE_URL);\n+\n+    // Support overriding the database password in the connection URL\n+    if (!baseConfig.password && env.DB_PASS) {\n+      baseConfig.password = env.DB_PASS;\n+    }\n   } else {\n     baseConfig = pgConfigs[environment];\n \n---\n\n\n---\n\nChoice D:\napp/models/trends/statuses.rb\n@@ -106,7 +106,7 @@ def klass\n   private\n \n   def eligible?(status)\n-    status.public_visibility? && status.account.discoverable? && !status.account.silenced? && !status.account.sensitized? && status.spoiler_text.blank? && !status.sensitive? && !status.reply? && valid_locale?(status.language)\n+    status.created_at.past? && status.public_visibility? && status.account.discoverable? && !status.account.silenced? && !status.account.sensitized? && status.spoiler_text.blank? && !status.sensitive? && !status.reply? && valid_locale?(status.language)\n   end\n \n   def calculate_scores(statuses, at_time)\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Go to for example mastodon.art\r\n2. Search for `pfefferle@notiz.blog`\r\n3. Press \"Follow\" button\r\n\r\n\n\n### Expected behaviour\n\nMastodon user follows WordPress User\n\n### Actual behaviour\n\nProcess seem to be stuck (\"Cancel follow\")\n\n### Detailed description\n\nWe have received some reports (here is the [ticket](https://github.com/Automattic/wordpress-activitypub/issues/523) on the WordPress plugin repo) that the Follow process seems to be stuck and not accepted by the WordPress instance.\r\n\r\nDebugging on the WordPress site shows that when searching for the WordPress profile, all required endpoints (WebFinger, Followers, ...) are requested and the profile is displayed correctly in the Mastodon UI. However, after clicking the follow button, WordPress does not receive a follow request (or any other requests to the inbox), this also applies to a unfollow/re-follow. Sending an `accept` by hand, on the other hand, seems to work.\r\n\r\nAnother way to reset the follow process seems to be an @-reply. After sending an @-reply to the Mastodon profile,an unfollow/re-follow also seems to work.\r\n\r\nAn example profile: @pfefferle@notiz.blog\r\nAn example group: @notiz.blog@notiz.blog\r\n\r\nFor a few weeks now, the Mastodon UI has also been displaying a 500 error in the UI when requesting the internal featured-tags endpoint: https://mastodon.social/api/v1/accounts/[...]/featured_tags.\r\n\r\nHere is an example endpoint for the Featured Tags endpoint of WordPress: https://notiz.blog/wp-api/activitypub/1.0/users/0/collections/tags\n\n### Mastodon instance\n\nmastodon.art, mastodon.ie, twit.social\n\n### Mastodon version\n\nv4.2.1\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/views/user_mailer/confirmation_instructions.html.haml\n@@ -8,9 +8,7 @@\n           %td.email-inner-card-td.email-prose\n             %p= t @resource.approved? ? 'devise.mailer.confirmation_instructions.explanation' : 'devise.mailer.confirmation_instructions.explanation_when_pending', host: site_hostname\n             - if @resource.created_by_application\n-              = render 'application/mailer/button', text: t('settings.account_settings'), url: edit_user_registration_url\n-              = link_to confirmation_url(@resource, confirmation_token: @token, redirect_to_app: 'true') do\n-                %span= t 'devise.mailer.confirmation_instructions.action_with_app', app: @resource.created_by_application.name\n+              = render 'application/mailer/button', text: t('devise.mailer.confirmation_instructions.action_with_app', app: @resource.created_by_application.name), url: confirmation_url(@resource, confirmation_token: @token, redirect_to_app: 'true')\n             - else\n               = render 'application/mailer/button', text: t('devise.mailer.confirmation_instructions.action'), url: confirmation_url(@resource, confirmation_token: @token)\n             %p= t 'devise.mailer.confirmation_instructions.extra_html', terms_path: about_more_url, policy_path: privacy_policy_url\n---\n\n\n---\n\nChoice B:\napp/lib/link_details_extractor.rb\n@@ -36,7 +36,8 @@ def description\n     end\n \n     def language\n-      json['inLanguage']\n+      lang = json['inLanguage']\n+      lang.is_a?(Hash) ? (lang['alternateName'] || lang['name']) : lang\n     end\n \n     def type\n---\nspec/lib/link_details_extractor_spec.rb\n@@ -82,6 +82,10 @@\n           'name' => 'Pet News',\n           'url' => 'https://example.com',\n         },\n+        'inLanguage' => {\n+          name: 'English',\n+          alternateName: 'en',\n+        },\n       }.to_json\n     end\n \n@@ -115,6 +119,12 @@\n           expect(subject.provider_name).to eq 'Pet News'\n         end\n       end\n+\n+      describe '#language' do\n+        it 'returns the language from structured data' do\n+          expect(subject.language).to eq 'en'\n+        end\n+      end\n     end\n \n     context 'when is wrapped in CDATA tags' do\n---\n\n\n---\n\nChoice C:\napp/assets/javascripts/components/components/status_content.jsx\n@@ -92,7 +92,7 @@ const StatusContent = React.createClass({\n \n       return (\n         <div className='status__content' style={{ cursor: 'pointer' }} onMouseDown={this.handleMouseDown} onMouseUp={this.handleMouseUp}>\n-          <p>\n+          <p style={{ marginBottom: hidden ? '0px' : '' }} >\n             <span dangerouslySetInnerHTML={spoilerContent} /> <a onClick={this.handleSpoilerClick}>{toggleText}</a>\n           </p>\n \n---\napp/assets/stylesheets/components.scss\n@@ -679,42 +679,8 @@\n   }\n }\n \n-.spoiler-helper {\n-  margin-bottom: -20px !important;\n-}\n-\n-.spoiler {\n-  &::before {\n-    margin-top: 20px;\n-    display: block;\n-    content: '';\n-  }\n-\n-  display: inline;\n-  cursor: pointer;\n-  border-bottom: 1px dashed white;\n-  .light & {\n-    border-bottom: 1px dashed black;\n-  }\n-\n-  &.spoiler-on {\n-    &, & * {\n-      color: transparent !important;\n-    }\n-    background: white;\n-    .light & {\n-      background: black;\n-    }\n-\n-    .emojione {\n-      opacity: 0;\n-    }\n-  }\n-}\n-\n @import 'boost';\n \n-\n button i.fa-retweet {\n   height: 19px;\n   width: 22px;\n---\napp/services/follow_service.rb\n@@ -71,7 +71,7 @@ def request_follow!\n     if @target_account.local?\n       LocalNotificationWorker.perform_async(@target_account.id, follow_request.id, follow_request.class.name, 'follow_request')\n     elsif @target_account.activitypub?\n-      ActivityPub::DeliveryWorker.perform_async(build_json(follow_request), @source_account.id, @target_account.inbox_url)\n+      ActivityPub::DeliveryWorker.perform_async(build_json(follow_request), @source_account.id, @target_account.inbox_url, { 'bypass_availability' => true })\n     end\n \n     follow_request\n---\napp/workers/activitypub/delivery_worker.rb\n@@ -23,9 +23,10 @@ class ActivityPub::DeliveryWorker\n   HEADERS = { 'Content-Type' => 'application/activity+json' }.freeze\n \n   def perform(json, source_account_id, inbox_url, options = {})\n-    return unless DeliveryFailureTracker.available?(inbox_url)\n-\n     @options        = options.with_indifferent_access\n+\n+    return unless @options[:bypass_availability] || DeliveryFailureTracker.available?(inbox_url)\n+\n     @json           = json\n     @source_account = Account.find(source_account_id)\n     @inbox_url      = inbox_url\n---\n\n\n---\n\nChoice D:\napp/helpers/languages_helper.rb\n@@ -254,6 +254,7 @@ def standard_locale_name(locale)\n \n   def valid_locale_or_nil(str)\n     return if str.blank?\n+    return str if valid_locale?(str)\n \n     code, = str.to_s.split(/[_-]/) # Strip out the region from e.g. en_US or ja-JP\n \n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Go to \"Explore\": https://mastodon.social/explore\r\n2. Click some post\r\n3. Go back. (Either browser back-button, or two-finger swipe on the touchpad)\r\n\r\n\n\n### Expected behaviour\n\nI should end up at the place where I left\n\n### Actual behaviour\n\nI'm somewhere at the top of the page\n\n### Detailed description\n\nSee this video:\r\n\r\n\r\n[Screencast from 2023-10-17 19-39-39.webm](https://github.com/mastodon/mastodon/assets/63594136/c96f13d0-1aad-4d02-91a2-772bbd4b9fe5)\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.2.1\n\n### Browser name and version\n\nFirefox 118.0.2\n\n### Operating system\n\nFedora 38\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/explore/links.jsx\n@@ -3,12 +3,15 @@ import { PureComponent } from 'react';\n \n import { FormattedMessage } from 'react-intl';\n \n+import { withRouter } from 'react-router-dom';\n+\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import { connect } from 'react-redux';\n \n import { fetchTrendingLinks } from 'mastodon/actions/trends';\n import { DismissableBanner } from 'mastodon/components/dismissable_banner';\n import { LoadingIndicator } from 'mastodon/components/loading_indicator';\n+import { WithRouterPropTypes } from 'mastodon/utils/react_router';\n \n import Story from './components/story';\n \n@@ -23,10 +26,17 @@ class Links extends PureComponent {\n     links: ImmutablePropTypes.list,\n     isLoading: PropTypes.bool,\n     dispatch: PropTypes.func.isRequired,\n+    ...WithRouterPropTypes,\n   };\n \n   componentDidMount () {\n-    const { dispatch } = this.props;\n+    const { dispatch, links, history } = this.props;\n+\n+    // If we're navigating back to the screen, do not trigger a reload\n+    if (history.action === 'POP' && links.size > 0) {\n+      return;\n+    }\n+\n     dispatch(fetchTrendingLinks());\n   }\n \n@@ -77,4 +87,4 @@ class Links extends PureComponent {\n \n }\n \n-export default connect(mapStateToProps)(Links);\n+export default connect(mapStateToProps)(withRouter(Links));\n---\napp/javascript/mastodon/features/explore/statuses.jsx\n@@ -3,15 +3,19 @@ import { PureComponent } from 'react';\n \n import { FormattedMessage } from 'react-intl';\n \n+import { withRouter } from 'react-router-dom';\n+\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import { connect } from 'react-redux';\n \n import { debounce } from 'lodash';\n \n+\n import { fetchTrendingStatuses, expandTrendingStatuses } from 'mastodon/actions/trends';\n import { DismissableBanner } from 'mastodon/components/dismissable_banner';\n import StatusList from 'mastodon/components/status_list';\n import { getStatusList } from 'mastodon/selectors';\n+import { WithRouterPropTypes } from 'mastodon/utils/react_router';\n \n const mapStateToProps = state => ({\n   statusIds: getStatusList(state, 'trending'),\n@@ -27,10 +31,17 @@ class Statuses extends PureComponent {\n     hasMore: PropTypes.bool,\n     multiColumn: PropTypes.bool,\n     dispatch: PropTypes.func.isRequired,\n+    ...WithRouterPropTypes,\n   };\n \n   componentDidMount () {\n-    const { dispatch } = this.props;\n+    const { dispatch, statusIds, history } = this.props;\n+\n+    // If we're navigating back to the screen, do not trigger a reload\n+    if (history.action === 'POP' && statusIds.size > 0) {\n+      return;\n+    }\n+\n     dispatch(fetchTrendingStatuses());\n   }\n \n@@ -64,4 +75,4 @@ class Statuses extends PureComponent {\n \n }\n \n-export default connect(mapStateToProps)(Statuses);\n+export default connect(mapStateToProps)(withRouter(Statuses));\n---\napp/javascript/mastodon/features/explore/suggestions.jsx\n@@ -3,12 +3,15 @@ import { PureComponent } from 'react';\n \n import { FormattedMessage } from 'react-intl';\n \n+import { withRouter } from 'react-router-dom';\n+\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import { connect } from 'react-redux';\n \n import { fetchSuggestions } from 'mastodon/actions/suggestions';\n import { LoadingIndicator } from 'mastodon/components/loading_indicator';\n import AccountCard from 'mastodon/features/directory/components/account_card';\n+import { WithRouterPropTypes } from 'mastodon/utils/react_router';\n \n const mapStateToProps = state => ({\n   suggestions: state.getIn(['suggestions', 'items']),\n@@ -21,10 +24,17 @@ class Suggestions extends PureComponent {\n     isLoading: PropTypes.bool,\n     suggestions: ImmutablePropTypes.list,\n     dispatch: PropTypes.func.isRequired,\n+    ...WithRouterPropTypes,\n   };\n \n   componentDidMount () {\n-    const { dispatch } = this.props;\n+    const { dispatch, suggestions, history } = this.props;\n+\n+    // If we're navigating back to the screen, do not trigger a reload\n+    if (history.action === 'POP' && suggestions.size > 0) {\n+      return;\n+    }\n+\n     dispatch(fetchSuggestions(true));\n   }\n \n@@ -52,4 +62,4 @@ class Suggestions extends PureComponent {\n \n }\n \n-export default connect(mapStateToProps)(Suggestions);\n+export default connect(mapStateToProps)(withRouter(Suggestions));\n---\napp/javascript/mastodon/features/explore/tags.jsx\n@@ -3,13 +3,16 @@ import { PureComponent } from 'react';\n \n import { FormattedMessage } from 'react-intl';\n \n+import { withRouter } from 'react-router-dom';\n+\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import { connect } from 'react-redux';\n \n import { fetchTrendingHashtags } from 'mastodon/actions/trends';\n import { DismissableBanner } from 'mastodon/components/dismissable_banner';\n import { ImmutableHashtag as Hashtag } from 'mastodon/components/hashtag';\n import { LoadingIndicator } from 'mastodon/components/loading_indicator';\n+import { WithRouterPropTypes } from 'mastodon/utils/react_router';\n \n const mapStateToProps = state => ({\n   hashtags: state.getIn(['trends', 'tags', 'items']),\n@@ -22,10 +25,17 @@ class Tags extends PureComponent {\n     hashtags: ImmutablePropTypes.list,\n     isLoading: PropTypes.bool,\n     dispatch: PropTypes.func.isRequired,\n+    ...WithRouterPropTypes,\n   };\n \n   componentDidMount () {\n-    const { dispatch } = this.props;\n+    const { dispatch, history, hashtags } = this.props;\n+\n+    // If we're navigating back to the screen, do not trigger a reload\n+    if (history.action === 'POP' && hashtags.size > 0) {\n+      return;\n+    }\n+\n     dispatch(fetchTrendingHashtags());\n   }\n \n@@ -63,4 +73,4 @@ class Tags extends PureComponent {\n \n }\n \n-export default connect(mapStateToProps)(Tags);\n+export default connect(mapStateToProps)(withRouter(Tags));\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/components/hashtag_bar.jsx\n@@ -0,0 +1,50 @@\n+import PropTypes from 'prop-types';\n+import { useMemo, useState, useCallback } from 'react';\n+\n+import { FormattedMessage } from 'react-intl';\n+\n+import { Link } from 'react-router-dom';\n+\n+import ImmutablePropTypes from 'react-immutable-proptypes';\n+\n+const domParser = new DOMParser();\n+\n+// About two lines on desktop\n+const VISIBLE_HASHTAGS = 7;\n+\n+export const HashtagBar = ({ hashtags, text }) => {\n+  const renderedHashtags = useMemo(() => {\n+    const body = domParser.parseFromString(text, 'text/html').documentElement;\n+    return [].map.call(body.querySelectorAll('[rel=tag]'), node => node.textContent.toLowerCase());\n+  }, [text]);\n+\n+  const invisibleHashtags = useMemo(() => (\n+    hashtags.filter(hashtag => !renderedHashtags.some(textContent => textContent === `#${hashtag.get('name')}` || textContent === hashtag.get('name')))\n+  ), [hashtags, renderedHashtags]);\n+\n+  const [expanded, setExpanded] = useState(false);\n+  const handleClick = useCallback(() => setExpanded(true), []);\n+\n+  if (invisibleHashtags.isEmpty()) {\n+    return null;\n+  }\n+\n+  const revealedHashtags = expanded ? invisibleHashtags : invisibleHashtags.take(VISIBLE_HASHTAGS);\n+\n+  return (\n+    <div className='hashtag-bar'>\n+      {revealedHashtags.map(hashtag => (\n+        <Link key={hashtag.get('name')} to={`/tags/${hashtag.get('name')}`}>\n+          #{hashtag.get('name')}\n+        </Link>\n+      ))}\n+\n+      {!expanded && invisibleHashtags.size > VISIBLE_HASHTAGS && <button className='link-button' onClick={handleClick}><FormattedMessage id='hashtags.and_other' defaultMessage='\u2026and {count, plural, other {# more}}' values={{ count: invisibleHashtags.size - VISIBLE_HASHTAGS }} /></button>}\n+    </div>\n+  );\n+};\n+\n+HashtagBar.propTypes = {\n+  hashtags: ImmutablePropTypes.list,\n+  text: PropTypes.string,\n+};\n\\ No newline at end of file\n---\napp/javascript/mastodon/components/status.jsx\n@@ -22,6 +22,7 @@ import { displayMedia } from '../initial_state';\n import { Avatar } from './avatar';\n import { AvatarOverlay } from './avatar_overlay';\n import { DisplayName } from './display_name';\n+import { HashtagBar } from './hashtag_bar';\n import { RelativeTimestamp } from './relative_timestamp';\n import StatusActionBar from './status_action_bar';\n import StatusContent from './status_content';\n@@ -580,6 +581,8 @@ class Status extends ImmutablePureComponent {\n \n             {media}\n \n+            <HashtagBar hashtags={status.get('tags')} text={status.get('content')} />\n+\n             <StatusActionBar scrollKey={scrollKey} status={status} account={account} onFilter={matchedFilters ? this.handleFilterClick : null} {...other} />\n           </div>\n         </div>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -10,6 +10,7 @@ import ImmutablePureComponent from 'react-immutable-pure-component';\n \n import { AnimatedNumber } from 'mastodon/components/animated_number';\n import EditedTimestamp from 'mastodon/components/edited_timestamp';\n+import { HashtagBar } from 'mastodon/components/hashtag_bar';\n import { Icon }  from 'mastodon/components/icon';\n import PictureInPicturePlaceholder from 'mastodon/components/picture_in_picture_placeholder';\n \n@@ -314,6 +315,8 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           {media}\n \n+          <HashtagBar hashtags={status.get('tags')} text={status.get('content')} />\n+\n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n               <FormattedDate value={new Date(status.get('created_at'))} hour12={false} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n---\napp/javascript/mastodon/locales/en.json\n@@ -300,6 +300,7 @@\n   \"hashtag.counter_by_uses_today\": \"{count, plural, one {{counter} post} other {{counter} posts}} today\",\n   \"hashtag.follow\": \"Follow hashtag\",\n   \"hashtag.unfollow\": \"Unfollow hashtag\",\n+  \"hashtags.and_other\": \"\u2026and {count, plural, other {# more}}\",\n   \"home.actions.go_to_explore\": \"See what's trending\",\n   \"home.actions.go_to_suggestions\": \"Find people to follow\",\n   \"home.column_settings.basic\": \"Basic\",\n---\napp/javascript/styles/mastodon/components.scss\n@@ -9256,3 +9256,26 @@ noscript {\n     }\n   }\n }\n+\n+.hashtag-bar {\n+  margin-top: 16px;\n+  display: flex;\n+  flex-wrap: wrap;\n+  font-size: 14px;\n+  gap: 4px;\n+\n+  a {\n+    display: inline-flex;\n+    border-radius: 4px;\n+    background: rgba($highlight-text-color, 0.2);\n+    color: $highlight-text-color;\n+    padding: 0.4em 0.6em;\n+    text-decoration: none;\n+\n+    &:hover,\n+    &:focus,\n+    &:active {\n+      background: rgba($highlight-text-color, 0.3);\n+    }\n+  }\n+}\n---\napp/javascript/mastodon/components/status.jsx\n@@ -546,6 +546,7 @@ class Status extends ImmutablePureComponent {\n     const visibilityIcon = visibilityIconInfo[status.get('visibility')];\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n+    const expanded = !status.get('hidden')\n \n     return (\n       <HotKeys handlers={handlers}>\n@@ -574,7 +575,7 @@ class Status extends ImmutablePureComponent {\n             <StatusContent\n               status={status}\n               onClick={this.handleClick}\n-              expanded={!status.get('hidden')}\n+              expanded={expanded}\n               onExpandedToggle={this.handleExpandedToggle}\n               onTranslate={this.handleTranslate}\n               collapsible\n@@ -584,7 +585,7 @@ class Status extends ImmutablePureComponent {\n \n             {media}\n \n-            {hashtagBar}\n+            {expanded && hashtagBar}\n \n             <StatusActionBar scrollKey={scrollKey} status={status} account={account} onFilter={matchedFilters ? this.handleFilterClick : null} {...other} />\n           </div>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -293,6 +293,7 @@ class DetailedStatus extends ImmutablePureComponent {\n     }\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n+    const expanded = !status.get('hidden')\n \n     return (\n       <div style={outerStyle}>\n@@ -318,7 +319,7 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           {media}\n \n-          {hashtagBar}\n+          {expanded && hashtagBar}\n \n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n---\n\n\n---\n\nChoice C:\napp/helpers/languages_helper.rb\n@@ -254,6 +254,7 @@ def standard_locale_name(locale)\n \n   def valid_locale_or_nil(str)\n     return if str.blank?\n+    return str if valid_locale?(str)\n \n     code, = str.to_s.split(/[_-]/) # Strip out the region from e.g. en_US or ja-JP\n \n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -9284,14 +9284,17 @@ noscript {\n     0 10px 15px -3px rgba($base-shadow-color, 0.25),\n     0 4px 6px -4px rgba($base-shadow-color, 0.25);\n   cursor: default;\n-  transition: 0.5s cubic-bezier(0.89, 0.01, 0.5, 1.1);\n-  transform: translateZ(0);\n   font-size: 15px;\n   line-height: 21px;\n \n   &.notification-bar-active {\n     inset-inline-start: 1rem;\n   }\n+\n+  .no-reduce-motion & {\n+    transition: 0.5s cubic-bezier(0.89, 0.01, 0.5, 1.1);\n+    transform: translateZ(0);\n+  }\n }\n \n .notification-bar-title {\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Open a toot with an image\r\n2. Click the image\r\n\r\n\r\n### Expected behaviour\r\n\r\nThe back link of the browser should close the zoomed view\r\n\r\n### Actual behaviour\r\n\r\nthe back link navigates away.\r\n\r\n### Detailed description\r\n\r\n* opening the zoomed image should add to the browser history (closing should go back in history).\r\n\r\nThis behaviour is desired for any modal that is opened (the back button should close the modal and not navigate away.\r\n\r\n### Mastodon instance\r\n\r\nmastodon.social\r\n\r\n### Mastodon version\r\n\r\nv4.1.2\r\n\r\n### Browser name and version\r\n\r\nChrome 117.0.5938.149\r\n\r\n### Operating system\r\n\r\nUbuntu 22.04\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/polyfills/base_polyfills.ts\n@@ -1,4 +1,5 @@\n import 'core-js/features/object/assign';\n+import 'core-js/features/object/has-own';\n import 'core-js/features/object/values';\n import 'core-js/features/symbol';\n import 'core-js/features/promise/finally';\n---\n\n\n---\n\nChoice B:\napp/models/media_attachment.rb\n@@ -172,7 +172,7 @@ class MediaAttachment < ApplicationRecord\n   DEFAULT_STYLES = [:original].freeze\n \n   GLOBAL_CONVERT_OPTIONS = {\n-    all: '-quality 90 +profile \"!icc,*\" +set modify-date +set create-date',\n+    all: '-quality 90 +profile \"!icc,*\" +set modify-date -define jpeg:dct-method=float +set create-date',\n   }.freeze\n \n   belongs_to :account,          inverse_of: :media_attachments, optional: true\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/ui/components/modal_root.jsx\n@@ -61,6 +61,8 @@ export default class ModalRoot extends PureComponent {\n     props: PropTypes.object,\n     onClose: PropTypes.func.isRequired,\n     ignoreFocus: PropTypes.bool,\n+    beforeOpen: PropTypes.func,\n+    afterClose: PropTypes.func,\n   };\n \n   state = {\n@@ -81,6 +83,10 @@ export default class ModalRoot extends PureComponent {\n     }\n   }\n \n+  componentDidMount() {\n+    this.props.beforeOpen();\n+  }\n+\n   setBackgroundColor = color => {\n     this.setState({ backgroundColor: color });\n   };\n@@ -96,9 +102,10 @@ export default class ModalRoot extends PureComponent {\n   };\n \n   handleClose = (ignoreFocus = false) => {\n-    const { onClose } = this.props;\n+    const { onClose, afterClose } = this.props;\n     const message = this._modal?.getCloseConfirmationMessage?.();\n     onClose(message, ignoreFocus);\n+    afterClose();\n   };\n \n   setModalRef = (c) => {\n---\napp/javascript/mastodon/features/ui/index.jsx\n@@ -549,6 +549,18 @@ class UI extends PureComponent {\n     this.context.router.history.push('/follow_requests');\n   };\n \n+  handleModalOpened = () => {\n+    if (!this.context.router.history.location.state?.modalOpen) {\n+      this.context.router.history.push(this.context.router.history.pathname, { modalOpen: true });\n+    }\n+  };\n+\n+  handleModalClosed = () => {\n+    if (this.context.router.history.location.state?.modalOpen) {\n+      this.context.router.history.goBack();\n+    }\n+  };\n+\n   render () {\n     const { draggingOver } = this.state;\n     const { children, isComposing, location, dropdownMenuIsOpen, layout } = this.props;\n@@ -587,7 +599,7 @@ class UI extends PureComponent {\n           {layout !== 'mobile' && <PictureInPicture />}\n           <NotificationsContainer />\n           <LoadingBarContainer className='loading-bar' />\n-          <ModalContainer />\n+          <ModalContainer beforeOpen={this.handleModalOpened} afterClose={this.handleModalClosed} />\n           <UploadArea active={draggingOver} onClose={this.closeUploadModal} />\n         </div>\n       </HotKeys>\n---\n\n\n---\n\nChoice D:\nlib/http_extensions.rb\n@@ -2,9 +2,7 @@\n \n # Monkey patching until https://github.com/httprb/http/pull/757 is merged\n unless HTTP::Request::METHODS.include?(:purge)\n-  module HTTP\n-    class Request\n-      METHODS = METHODS.dup.push(:purge).freeze\n-    end\n-  end\n+  methods = HTTP::Request::METHODS.dup\n+  HTTP::Request.send(:remove_const, :METHODS)\n+  HTTP::Request.const_set(:METHODS, methods.push(:purge).freeze)\n end\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nStarting about one week ago, noticed these types of errors appearing in Sidekiq dead queue.\r\n\r\n```\r\nNoMethodError: undefined method `to_sym' for [{\"@type\"=>\"Language\", \"name\"=>\"Dutch\"}]:Array\r\nNoMethodError: undefined method `to_sym' for {\"@type\"=>\"Language\", \"name\"=>\"Indonesian\", \"alternateName\"=>\"id\"}:Hash\r\nNoMethodError: undefined method `to_sym' for {\"@type\"=>\"Language\", \"name\"=>\"Russian\", \"alternateName\"=>\"ru\"}:Hash\r\n```\r\n\r\n![image](https://github.com/mastodon/mastodon/assets/3002053/fb435620-d815-45ea-a2cd-e989a9a9af0b)\r\n\r\n![CleanShot 2023-10-13 at 11 48 45@2x](https://github.com/mastodon/mastodon/assets/3002053/3ab07212-cab8-403a-a33b-c0acb29d3c97)\r\n\r\n\n\n### Expected behaviour\n\nNo errors\n\n### Actual behaviour\n\nThese errors\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nvmst.io\n\n### Mastodon version\n\nmain\n\n### Technical details\n\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: (from `ruby --version`, eg. v3.2.2 +YJIT)\r\n- Node.js version: (from `node --version`, eg. v20)\r\n\n\n---\n\nChoice A:\napp/lib/link_details_extractor.rb\n@@ -36,7 +36,8 @@ def description\n     end\n \n     def language\n-      json['inLanguage']\n+      lang = json['inLanguage']\n+      lang.is_a?(Hash) ? (lang['alternateName'] || lang['name']) : lang\n     end\n \n     def type\n---\nspec/lib/link_details_extractor_spec.rb\n@@ -82,6 +82,10 @@\n           'name' => 'Pet News',\n           'url' => 'https://example.com',\n         },\n+        'inLanguage' => {\n+          name: 'English',\n+          alternateName: 'en',\n+        },\n       }.to_json\n     end\n \n@@ -115,6 +119,12 @@\n           expect(subject.provider_name).to eq 'Pet News'\n         end\n       end\n+\n+      describe '#language' do\n+        it 'returns the language from structured data' do\n+          expect(subject.language).to eq 'en'\n+        end\n+      end\n     end\n \n     context 'when is wrapped in CDATA tags' do\n---\n\n\n---\n\nChoice B:\napp/helpers/languages_helper.rb\n@@ -254,6 +254,7 @@ def standard_locale_name(locale)\n \n   def valid_locale_or_nil(str)\n     return if str.blank?\n+    return str if valid_locale?(str)\n \n     code, = str.to_s.split(/[_-]/) # Strip out the region from e.g. en_US or ja-JP\n \n---\n\n\n---\n\nChoice C:\nconfig/initializers/paperclip.rb\n@@ -88,6 +88,19 @@\n \n   Paperclip::Attachment.default_options[:s3_headers]['X-Amz-Storage-Class'] = ENV['S3_STORAGE_CLASS'] if ENV.has_key?('S3_STORAGE_CLASS')\n \n+  # Some S3 providers are not compatible with the checksum mode\n+  # See https://github.com/mastodon/mastodon/issues/26394\n+  if ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n+    module Aws::S3::FileDownloaderExtensions\n+      def validate!\n+        @params.delete(:checksum_mode)\n+        super\n+      end\n+    end\n+\n+    Aws::S3::FileDownloader.prepend(Aws::S3::FileDownloaderExtensions)\n+  end\n+\n   # Some S3-compatible providers might not actually be compatible with some APIs\n   # used by kt-paperclip, see https://github.com/mastodon/mastodon/issues/16822\n   if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n---\nconfig/initializers/paperclip.rb\n@@ -90,13 +90,19 @@\n \n   # Some S3-compatible providers might not actually be compatible with some APIs\n   # used by kt-paperclip, see https://github.com/mastodon/mastodon/issues/16822\n-  if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n+  # and https://github.com/mastodon/mastodon/issues/26394\n+  if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true' || ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n     module Paperclip\n       module Storage\n         module S3Extensions\n           def copy_to_local_file(style, local_dest_path)\n             log(\"copying #{path(style)} to local file #{local_dest_path}\")\n-            s3_object(style).download_file(local_dest_path, { mode: 'single_request' })\n+\n+            options = {}\n+            options[:mode] = 'single_request' if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n+            options[:checksum_mode] = 'DISABLED' if ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n+\n+            s3_object(style).download_file(local_dest_path, options)\n           rescue Aws::Errors::ServiceError => e\n             warn(\"#{e} - cannot copy #{path(style)} to local file #{local_dest_path}\")\n             false\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/video/index.jsx\n@@ -469,6 +469,10 @@ class Video extends PureComponent {\n   };\n \n   _syncVideoToVolumeState = (volume = null, muted = null) => {\n+    if (!this.video) {\n+      return;\n+    }\n+\n     this.video.volume = volume ?? this.state.volume;\n     this.video.muted = muted ?? this.state.muted;\n   };\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nSome specs for `Mastodon::CLI::Accounts` are incorrect, and due to how `parallelize_with_progress` was stubbed, this didn't get caught.\r\n\r\nThe tests for `#refresh` still use hardcoded `parallelize_with_progress` results because testing for `Account#reset_header!` and `Account#reset_avatar!` calls is much more involved when we don't have direct access to the objects those methods will be called on.\n\n---\n\nChoice A:\nconfig/initializers/paperclip.rb\n@@ -88,6 +88,19 @@\n \n   Paperclip::Attachment.default_options[:s3_headers]['X-Amz-Storage-Class'] = ENV['S3_STORAGE_CLASS'] if ENV.has_key?('S3_STORAGE_CLASS')\n \n+  # Some S3 providers are not compatible with the checksum mode\n+  # See https://github.com/mastodon/mastodon/issues/26394\n+  if ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n+    module Aws::S3::FileDownloaderExtensions\n+      def validate!\n+        @params.delete(:checksum_mode)\n+        super\n+      end\n+    end\n+\n+    Aws::S3::FileDownloader.prepend(Aws::S3::FileDownloaderExtensions)\n+  end\n+\n   # Some S3-compatible providers might not actually be compatible with some APIs\n   # used by kt-paperclip, see https://github.com/mastodon/mastodon/issues/16822\n   if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n---\nconfig/initializers/paperclip.rb\n@@ -90,13 +90,19 @@\n \n   # Some S3-compatible providers might not actually be compatible with some APIs\n   # used by kt-paperclip, see https://github.com/mastodon/mastodon/issues/16822\n-  if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n+  # and https://github.com/mastodon/mastodon/issues/26394\n+  if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true' || ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n     module Paperclip\n       module Storage\n         module S3Extensions\n           def copy_to_local_file(style, local_dest_path)\n             log(\"copying #{path(style)} to local file #{local_dest_path}\")\n-            s3_object(style).download_file(local_dest_path, { mode: 'single_request' })\n+\n+            options = {}\n+            options[:mode] = 'single_request' if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n+            options[:checksum_mode] = 'DISABLED' if ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n+\n+            s3_object(style).download_file(local_dest_path, options)\n           rescue Aws::Errors::ServiceError => e\n             warn(\"#{e} - cannot copy #{path(style)} to local file #{local_dest_path}\")\n             false\n---\n\n\n---\n\nChoice B:\nspec/lib/mastodon/cli/accounts_spec.rb\n@@ -1356,4 +1356,77 @@ def stub_parallelize_with_progress!\n       end\n     end\n   end\n+\n+  describe '#prune' do\n+    let!(:local_account)     { Fabricate(:account) }\n+    let!(:bot_account)       { Fabricate(:account, bot: true, domain: 'example.com') }\n+    let!(:group_account)     { Fabricate(:account, actor_type: 'Group', domain: 'example.com') }\n+    let!(:mentioned_account) { Fabricate(:account, domain: 'example.com') }\n+    let!(:prunable_accounts) do\n+      Fabricate.times(3, :account, domain: 'example.com', bot: false, suspended_at: nil, silenced_at: nil)\n+    end\n+\n+    before do\n+      Fabricate(:mention, account: mentioned_account, status: Fabricate(:status, account: Fabricate(:account)))\n+      stub_parallelize_with_progress!\n+    end\n+\n+    it 'prunes all remote accounts with no interactions with local users' do\n+      cli.prune\n+\n+      prunable_account_ids = prunable_accounts.pluck(:id)\n+\n+      expect(Account.where(id: prunable_account_ids).count).to eq(0)\n+    end\n+\n+    it 'displays a successful message' do\n+      expect { cli.prune }.to output(\n+        a_string_including(\"OK, pruned #{prunable_accounts.size} accounts\")\n+      ).to_stdout\n+    end\n+\n+    it 'does not prune local accounts' do\n+      cli.prune\n+\n+      expect(Account.exists?(id: local_account.id)).to be(true)\n+    end\n+\n+    it 'does not prune bot accounts' do\n+      cli.prune\n+\n+      expect(Account.exists?(id: bot_account.id)).to be(true)\n+    end\n+\n+    it 'does not prune group accounts' do\n+      cli.prune\n+\n+      expect(Account.exists?(id: group_account.id)).to be(true)\n+    end\n+\n+    it 'does not prune accounts that have been mentioned' do\n+      cli.prune\n+\n+      expect(Account.exists?(id: mentioned_account.id)).to be true\n+    end\n+\n+    context 'with --dry-run option' do\n+      before do\n+        cli.options = { dry_run: true }\n+      end\n+\n+      it 'does not prune any account' do\n+        cli.prune\n+\n+        prunable_account_ids = prunable_accounts.pluck(:id)\n+\n+        expect(Account.where(id: prunable_account_ids).count).to eq(prunable_accounts.size)\n+      end\n+\n+      it 'displays a successful message with (DRY RUN)' do\n+        expect { cli.prune }.to output(\n+          a_string_including(\"OK, pruned #{prunable_accounts.size} accounts (DRY RUN)\")\n+        ).to_stdout\n+      end\n+    end\n+  end\n end\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -3611,6 +3611,7 @@ $ui-header-logo-wordmark-width: 99px;\n   overflow-y: auto;\n   width: 100%;\n   height: 100%;\n+  z-index: 0;\n }\n \n .drawer__inner__mastodon {\n---\n\n\n---\n\nChoice D:\napp/lib/link_details_extractor.rb\n@@ -36,7 +36,8 @@ def description\n     end\n \n     def language\n-      json['inLanguage']\n+      lang = json['inLanguage']\n+      lang.is_a?(Hash) ? (lang['alternateName'] || lang['name']) : lang\n     end\n \n     def type\n---\nspec/lib/link_details_extractor_spec.rb\n@@ -82,6 +82,10 @@\n           'name' => 'Pet News',\n           'url' => 'https://example.com',\n         },\n+        'inLanguage' => {\n+          name: 'English',\n+          alternateName: 'en',\n+        },\n       }.to_json\n     end\n \n@@ -115,6 +119,12 @@\n           expect(subject.provider_name).to eq 'Pet News'\n         end\n       end\n+\n+      describe '#language' do\n+        it 'returns the language from structured data' do\n+          expect(subject.language).to eq 'en'\n+        end\n+      end\n     end\n \n     context 'when is wrapped in CDATA tags' do\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n(This is about the prompt introduced in #25267)\r\n\r\nThe prompt pops up when the home feed is not going fast enough. Problem is, I'm subscribed to English speakers - geographically mostly American and European. There is a clear lull hour, about 1pm GMT, when Americans are still sleepy and Europeans just don't post much, so the home feed is stalling.\r\n\r\n### Expected behaviour\r\n\r\ndo not show this text for people who already know how to subscribe\r\n\r\n### Actual behaviour\r\n\r\ni see the toast\r\n\r\n### Detailed description\r\n\r\nMy account is 6 years old, I'm subscribed to 900+ accounts, I'm perfectly fine catching up with the old posts. And every day, about the same time, I see this piece of condescending foolishness.\r\n\r\n![1](https://github.com/mastodon/mastodon/assets/308627/79ced1fd-6301-45a2-9d5b-a5996a6bd019)\r\n\r\n### Mastodon instance\r\n\r\nicosahedron.website\r\n\r\n### Mastodon version\r\n\r\nv4.2.0\r\n\r\n### Browser name and version\r\n\r\nLibrewolf 118\r\n\r\n### Operating system\r\n\r\nArch Linux\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/home_timeline/index.jsx\n@@ -37,7 +37,7 @@ const getHomeFeedSpeed = createSelector([\n   state => state.getIn(['timelines', 'home', 'pendingItems'], ImmutableList()),\n   state => state.get('statuses'),\n ], (statusIds, pendingStatusIds, statusMap) => {\n-  const recentStatusIds = pendingStatusIds.size > 0 ? pendingStatusIds : statusIds;\n+  const recentStatusIds = pendingStatusIds.concat(statusIds);\n   const statuses = recentStatusIds.filter(id => id !== null).map(id => statusMap.get(id)).filter(status => status?.get('account') !== me).take(20);\n \n   if (statuses.isEmpty()) {\n---\n\n\n---\n\nChoice B:\ndocker-compose.yml\n@@ -2,7 +2,7 @@ version: '3'\n services:\n   db:\n     restart: always\n-    image: postgres:14-alpine\n+    image: postgres:15-alpine\n     shm_size: 256mb\n     networks:\n       - internal_network\n@@ -25,7 +25,7 @@ services:\n \n   # es:\n   #   restart: always\n-  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.4\n+  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9\n   #   environment:\n   #     - \"ES_JAVA_OPTS=-Xms512m -Xmx512m -Des.enforce.bootstrap.checks=true\"\n   #     - \"xpack.license.self_generated.type=basic\"\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/reducers/relationships.js\n@@ -73,6 +73,7 @@ export default function relationships(state = initialState, action) {\n   case ACCOUNT_UNMUTE_SUCCESS:\n   case ACCOUNT_PIN_SUCCESS:\n   case ACCOUNT_UNPIN_SUCCESS:\n+    return normalizeRelationship(state, action.relationship);\n   case RELATIONSHIPS_FETCH_SUCCESS:\n     return normalizeRelationships(state, action.relationships);\n   case submitAccountNote.fulfilled:\n---\n\n\n---\n\nChoice D:\nspec/lib/mastodon/cli/accounts_spec.rb\n@@ -1356,4 +1356,77 @@ def stub_parallelize_with_progress!\n       end\n     end\n   end\n+\n+  describe '#prune' do\n+    let!(:local_account)     { Fabricate(:account) }\n+    let!(:bot_account)       { Fabricate(:account, bot: true, domain: 'example.com') }\n+    let!(:group_account)     { Fabricate(:account, actor_type: 'Group', domain: 'example.com') }\n+    let!(:mentioned_account) { Fabricate(:account, domain: 'example.com') }\n+    let!(:prunable_accounts) do\n+      Fabricate.times(3, :account, domain: 'example.com', bot: false, suspended_at: nil, silenced_at: nil)\n+    end\n+\n+    before do\n+      Fabricate(:mention, account: mentioned_account, status: Fabricate(:status, account: Fabricate(:account)))\n+      stub_parallelize_with_progress!\n+    end\n+\n+    it 'prunes all remote accounts with no interactions with local users' do\n+      cli.prune\n+\n+      prunable_account_ids = prunable_accounts.pluck(:id)\n+\n+      expect(Account.where(id: prunable_account_ids).count).to eq(0)\n+    end\n+\n+    it 'displays a successful message' do\n+      expect { cli.prune }.to output(\n+        a_string_including(\"OK, pruned #{prunable_accounts.size} accounts\")\n+      ).to_stdout\n+    end\n+\n+    it 'does not prune local accounts' do\n+      cli.prune\n+\n+      expect(Account.exists?(id: local_account.id)).to be(true)\n+    end\n+\n+    it 'does not prune bot accounts' do\n+      cli.prune\n+\n+      expect(Account.exists?(id: bot_account.id)).to be(true)\n+    end\n+\n+    it 'does not prune group accounts' do\n+      cli.prune\n+\n+      expect(Account.exists?(id: group_account.id)).to be(true)\n+    end\n+\n+    it 'does not prune accounts that have been mentioned' do\n+      cli.prune\n+\n+      expect(Account.exists?(id: mentioned_account.id)).to be true\n+    end\n+\n+    context 'with --dry-run option' do\n+      before do\n+        cli.options = { dry_run: true }\n+      end\n+\n+      it 'does not prune any account' do\n+        cli.prune\n+\n+        prunable_account_ids = prunable_accounts.pluck(:id)\n+\n+        expect(Account.where(id: prunable_account_ids).count).to eq(prunable_accounts.size)\n+      end\n+\n+      it 'displays a successful message with (DRY RUN)' do\n+        expect { cli.prune }.to output(\n+          a_string_including(\"OK, pruned #{prunable_accounts.size} accounts (DRY RUN)\")\n+        ).to_stdout\n+      end\n+    end\n+  end\n end\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. On your timeline, click on a post deep in a thread (or a reply deep enough)\r\n2. See that it loads the thread, scrolled to the reply\r\n3. Press \"back\"\r\n4. Click again on the same post\r\n\r\n\n\n### Expected behaviour\n\nI see the post I clicked in the thread\n\n### Actual behaviour\n\nThe thread load, but scrolled to top\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\noisaur.com\n\n### Mastodon version\n\nv4.2.0\n\n### Browser name and version\n\nSafari\n\n### Operating system\n\nmacOS\n\n### Technical details\n\nThis probably happens when the thread is already loaded in Redux, and `scrollIntoView` is not called somehow.\n\n---\n\nChoice A:\nbabel.config.js\n@@ -52,6 +52,10 @@ module.exports = (api) => {\n   case 'development':\n     reactOptions.development = true;\n     envOptions.debug = true;\n+\n+    // We need Babel to not inject polyfills in dev, as this breaks `preval` files\n+    envOptions.useBuiltIns = false;\n+    envOptions.corejs = undefined;\n     break;\n   }\n \n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/status/index.jsx\n@@ -607,6 +607,22 @@ class Status extends ImmutablePureComponent {\n     this.setState({ fullscreen: isFullscreen() });\n   };\n \n+  shouldUpdateScroll = (prevRouterProps, { location }) => {\n+    // Do not change scroll when opening a modal\n+    if (location.state?.mastodonModalKey && location.state?.mastodonModalKey !== prevRouterProps?.location?.state?.mastodonModalKey) {\n+      return false;\n+    }\n+\n+    // Scroll to focused post if it is loaded\n+    const child = this.node?.querySelector('.detailed-status__wrapper');\n+    if (child) {\n+      return [0, child.offsetTop];\n+    }\n+\n+    // Do not scroll otherwise, `componentDidUpdate` will take care of that\n+    return false;\n+  };\n+\n   render () {\n     let ancestors, descendants;\n     const { isLoading, status, ancestorsIds, descendantsIds, intl, domain, multiColumn, pictureInPicture } = this.props;\n@@ -660,7 +676,7 @@ class Status extends ImmutablePureComponent {\n           )}\n         />\n \n-        <ScrollContainer scrollKey='thread'>\n+        <ScrollContainer scrollKey='thread' shouldUpdateScroll={this.shouldUpdateScroll}>\n           <div className={classNames('scrollable', { fullscreen })} ref={this.setRef}>\n             {ancestors}\n \n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/dashboard.scss\n@@ -86,9 +86,7 @@\n     color: $primary-text-color;\n     transition: all 100ms ease-in;\n     font-size: 14px;\n-    padding: 0 16px;\n-    line-height: 36px;\n-    height: 36px;\n+    padding: 8px 16px;\n     text-decoration: none;\n     margin-bottom: 4px;\n \n---\napp/javascript/styles/mastodon/dashboard.scss\n@@ -91,6 +91,7 @@\n     height: 36px;\n     text-decoration: none;\n     margin-bottom: 4px;\n+    white-space: nowrap;\n \n     &:active,\n     &:focus,\n@@ -111,6 +112,8 @@\n \n     span {\n       flex: 1 1 auto;\n+      overflow: hidden;\n+      text-overflow: ellipsis;\n     }\n \n     strong {\n---\n\n\n---\n\nChoice D:\napp/lib/link_details_extractor.rb\n@@ -269,16 +269,21 @@ def structured_data\n   end\n \n   def document\n-    @document ||= Nokogiri::HTML(@html, nil, encoding)\n+    @document ||= detect_encoding_and_parse_document\n   end\n \n-  def encoding\n-    @encoding ||= begin\n-      guess = detector.detect(@html, @html_charset)\n-      guess&.fetch(:confidence, 0).to_i > 60 ? guess&.fetch(:encoding, nil) : nil\n+  def detect_encoding_and_parse_document\n+    [detect_encoding, nil, @html_charset, 'UTF-8'].uniq.each do |encoding|\n+      document = Nokogiri::HTML(@html, nil, encoding)\n+      return document if document.to_s.valid_encoding?\n     end\n   end\n \n+  def detect_encoding\n+    guess = detector.detect(@html, @html_charset)\n+    guess&.fetch(:confidence, 0).to_i > 60 ? guess&.fetch(:encoding, nil) : nil\n+  end\n+\n   def detector\n     @detector ||= CharlockHolmes::EncodingDetector.new.tap do |detector|\n       detector.strip_tags = true\n---\nspec/fixtures/requests/low_confidence_latin1.txt\n@@ -0,0 +1,17 @@\n+HTTP/1.1 200 OK\n+server: nginx\n+date: Thu, 13 Jun 2024 14:33:13 GMT\n+content-type: text/html; charset=ISO-8859-1\n+content-length: 158\n+accept-ranges: bytes\n+\n+<!doctype html>\n+<html lang=\"en\">\n+<head>\n+  <meta charset=\"UTF-8\">\n+  <title>Tofu \ufffd l'orange</title>\n+</head>\n+<body>\n+  <h2>Tofu \ufffd l'orange</h2>\n+</body>\n+</html>\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -26,6 +26,7 @@\n     stub_request(:get, 'http://example.com/sjis_with_wrong_charset').to_return(request_fixture('sjis_with_wrong_charset.txt'))\n     stub_request(:get, 'http://example.com/koi8-r').to_return(request_fixture('koi8-r.txt'))\n     stub_request(:get, 'http://example.com/windows-1251').to_return(request_fixture('windows-1251.txt'))\n+    stub_request(:get, 'http://example.com/low_confidence_latin1').to_return(request_fixture('low_confidence_latin1.txt'))\n \n     Rails.cache.write('oembed_endpoint:example.com', oembed_cache) if oembed_cache\n \n@@ -148,6 +149,14 @@\n       end\n     end\n \n+    context 'with a URL of a page in ISO-8859-1 encoding, that charlock_holmes cannot detect' do\n+      let(:status) { Fabricate(:status, text: 'Check out http://example.com/low_confidence_latin1') }\n+\n+      it 'decodes the HTML' do\n+        expect(status.preview_card.title).to eq(\"Tofu \u00e1 l'orange\")\n+      end\n+    end\n+\n     context 'with a Japanese path URL' do\n       let(:status) { Fabricate(:status, text: '\u30c6\u30b9\u30c8http://example.com/\u65e5\u672c\u8a9e') }\n \n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. just call the endpoint /api/v1/announcements without any parameter\r\n\n\n### Expected behaviour\n\nthe announcements object with \"read\" attribute with value \"true\" should be removed from the results\n\n### Actual behaviour\n\nobject are returned even if \"read\" attribute value is \"true\"\n\n### Detailed description\n\nHi!\r\n\r\nI already submitted this question to glitch but seems to me that mastodon could be also affected.\r\n\r\nI do not know if I am doing it wrong (if yes, sorry!) but seems to me that the parameter \"with_dismissed\" is just ignored.\r\n\r\nI was not able to find any reference to this issue in the bug report system here.\r\n\r\nBye!\r\nC.\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\n_No response_\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/controllers/api/v1/timelines/tag_controller.rb\n@@ -1,6 +1,7 @@\n # frozen_string_literal: true\n \n class Api::V1::Timelines::TagController < Api::BaseController\n+  before_action -> { doorkeeper_authorize! :read, :'read:statuses' }, only: :show, if: :require_auth?\n   before_action :load_tag\n   after_action :insert_pagination_headers, unless: -> { @statuses.empty? }\n \n@@ -12,6 +13,10 @@ def show\n \n   private\n \n+  def require_auth?\n+    !Setting.timeline_preview\n+  end\n+\n   def load_tag\n     @tag = Tag.find_normalized(params[:id])\n   end\n---\nspec/controllers/api/v1/timelines/tag_controller_spec.rb\n@@ -5,36 +5,66 @@\n describe Api::V1::Timelines::TagController do\n   render_views\n \n-  let(:user) { Fabricate(:user) }\n+  let(:user)   { Fabricate(:user) }\n+  let(:token)  { Fabricate(:accessible_access_token, resource_owner_id: user.id, scopes: 'read:statuses') }\n \n   before do\n     allow(controller).to receive(:doorkeeper_token) { token }\n   end\n \n-  context 'with a user context' do\n-    let(:token) { Fabricate(:accessible_access_token, resource_owner_id: user.id) }\n+  describe 'GET #show' do\n+    subject do\n+      get :show, params: { id: 'test' }\n+    end\n \n-    describe 'GET #show' do\n-      before do\n-        PostStatusService.new.call(user.account, text: 'It is a #test')\n+    before do\n+      PostStatusService.new.call(user.account, text: 'It is a #test')\n+    end\n+\n+    context 'when the instance allows public preview' do\n+      context 'when the user is not authenticated' do\n+        let(:token) { nil }\n+\n+        it 'returns http success', :aggregate_failures do\n+          subject\n+\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n \n-      it 'returns http success' do\n-        get :show, params: { id: 'test' }\n-        expect(response).to have_http_status(200)\n-        expect(response.headers['Link'].links.size).to eq(2)\n+      context 'when the user is authenticated' do\n+        it 'returns http success', :aggregate_failures do\n+          subject\n+\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n     end\n-  end\n \n-  context 'without a user context' do\n-    let(:token) { Fabricate(:accessible_access_token, resource_owner_id: nil) }\n+    context 'when the instance does not allow public preview' do\n+      before do\n+        Form::AdminSettings.new(timeline_preview: false).save\n+      end\n+\n+      context 'when the user is not authenticated' do\n+        let(:token) { nil }\n+\n+        it 'returns http unauthorized' do\n+          subject\n+\n+          expect(response).to have_http_status(401)\n+        end\n+      end\n+\n+      context 'when the user is authenticated' do\n+        it 'returns http success', :aggregate_failures do\n+          subject\n \n-    describe 'GET #show' do\n-      it 'returns http success' do\n-        get :show, params: { id: 'test' }\n-        expect(response).to have_http_status(200)\n-        expect(response.headers['Link']).to be_nil\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n     end\n   end\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/reducers/notification_groups.ts\n@@ -559,7 +559,10 @@ export const notificationGroupsReducer = createReducer<NotificationGroupsState>(\n           compareId(state.lastReadId, mostRecentGroup.page_max_id) < 0\n         )\n           state.lastReadId = mostRecentGroup.page_max_id;\n-        commitLastReadId(state);\n+\n+        // We don't call `commitLastReadId`, because that is conditional\n+        // and we want to unconditionally update the state instead.\n+        state.readMarkerId = state.lastReadId;\n       })\n       .addCase(fetchMarkers.fulfilled, (state, action) => {\n         if (\n---\n\n\n---\n\nChoice C:\ndocs/Using-Mastodon/List-of-Mastodon-instances.md\n@@ -65,7 +65,7 @@ There is also a list at [instances.mastodon.xyz](https://instances.mastodon.xyz)\n | [off-the-clock.us](https://off-the-clock.us/)|The work day is over.|Yes|No|\n | [infinimatix.net](https://infinimatix.net)|Informatics|Yes|Yes|\n | [social.0day.agency](https://social.0day.agency)|Infosec, Hacking, Fun (only protonmail)|Yes|Yes|\n-| [kagrumez.lerk.io](https://kagrumez.lerk.io)|Open registration. German end english.|Yes|No|\n+| [social.k40s.net](https://social.k40s.net)|Open registration. German end english.|Yes|No|\n | [meow.social](https://meow.social)|A furry fandom focused instance|Yes|No|\n | [neumastodon.com](https://neumastodon.com/)|Northeastern University Mastodon |Yes|No|\n | [dancingbanana.party](https://dancingbanana.party)|La banane qui danse.|Yes|No|\n---\napp/lib/status_finder.rb\n@@ -10,6 +10,8 @@ def initialize(url)\n   def status\n     verify_action!\n \n+    raise ActiveRecord::RecordNotFound unless TagManager.instance.local_url?(url)\n+\n     case recognized_params[:controller]\n     when 'stream_entries'\n       StreamEntry.find(recognized_params[:id]).status\n---\nspec/controllers/api/oembed_controller_spec.rb\n@@ -8,6 +8,7 @@\n \n   describe 'GET #show' do\n     before do\n+      request.host = Rails.configuration.x.local_domain\n       get :show, params: { url: account_stream_entry_url(alice, status.stream_entry) }, format: :json\n     end\n \n---\nspec/lib/status_finder_spec.rb\n@@ -34,6 +34,16 @@\n       end\n     end\n \n+    context 'with a remote url even if id exists on local' do\n+      let(:status) { Fabricate(:status) }\n+      let(:url) { \"https://example.com/users/test/statuses/#{status.id}\" }\n+      subject { described_class.new(url) }\n+\n+      it 'raises an error' do\n+        expect { subject.status }.to raise_error(ActiveRecord::RecordNotFound)\n+      end\n+    end\n+\n     context 'with a plausible url' do\n       let(:url) { 'https://example.com/users/test/updates/123/embed' }\n       subject { described_class.new(url) }\n---\n\n\n---\n\nChoice D:\nlib/sanitize_ext/sanitize_config.rb\n@@ -65,7 +65,7 @@ module Config\n     end\n \n     MASTODON_STRICT = freeze_config(\n-      elements: %w(p br span a del pre blockquote code b strong u i em ul ol li ruby rt rp),\n+      elements: %w(p br span a del s pre blockquote code b strong u i em ul ol li ruby rt rp),\n \n       attributes: {\n         'a' => %w(href rel class translate),\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Have a Hubzilla channel with PubCrawl on and connections on mastodon.social as an example of an instance that runs at least Mastodon 4.2.0.\r\n2. Create a post on Hubzilla, preferably one that's significantly longer than 500 characters. Add at least one not-too-common hashtag so it can be found more easily.\r\n3. Go to `https://mastodon.social/tags/<the hashtag used in the post>` in the Web browser of your choice (tested with the original Mozilla build of Firefox on Debian GNU/Linux).\r\n4. Scroll down until you find your post.\r\n5. Compare how mastodon.social renders your post with what your original Hubzilla post looks like.\r\n\r\n\r\n### Expected behaviour\r\n\r\nThe full post text is always shown on Mastodon.\r\n\r\n### Actual behaviour\r\n\r\nChances are the post is truncated and incomplete.\r\n\r\n### Detailed description\r\n\r\nSince Mastodon 4.2.0 was released, it seems to randomly truncate posts from at least Hubzilla. It does so both to posts that came in after the upgrade of an instance to 4.2.x and to posts that have been on an instance before the 4.2.x upgrade.\r\n\r\nIt doesn't happen to each post. It happens both to Hubzilla posts (first posts in a thread) and to Hubzilla comments (replies to posts which are something different on Hubzilla), and it happens to comments on both Mastodon and Hubzilla posts.\r\n\r\nAlso, even truncated posts can still be over 500 characters long on instances that only allow for 500 characters. And posts that are well under 500 characters are truncated, too.\r\n\r\nThere seems to be no pattern. There is nothing that indicates when and why a post is truncated, other than all truncated posts I know about have hashtags in the text rather than all hashtags at the end or no hashtags at all. Also, Hubzilla posts with summaries that became/become Mastodon posts with content warnings seem to never be truncated.\r\n\r\nThat said, posts are never truncated in the middle of a word.\r\n\r\nThe issue clearly lies on Mastodon's side. It started happening with the release of Mastodon 4.2.0 while Hubzilla did not have a new release at that time. Also, Mastodon 4.1.9 shows posts perfectly fine which Mastodon 4.2.0 truncates.\r\n\r\nHere is a proof, although it's a minor example.\r\n\r\nOriginal Hubzilla comment:\r\nhttps://hub.netzgemeinde.eu/display/b64.aHR0cHM6Ly9odWIubmV0emdlbWVpbmRlLmV1L2l0ZW0vMzU0NTJkMmQtNDI0OC00NjI5LTg3MjgtZWE0YTlhOWIyNDBk\r\nMastodon 4.1.9 (noc.social) showing the whole post:\r\nhttps://noc.social/@MarvinTheMartian/111115829359100943 (scroll down to my post)\r\nMastodon 4.2.0 (tooters.org), full stop at the end of the last sentence is missing:\r\nhttps://tooters.org/@victor/111115391740487664 (scroll down to my post)\r\n\r\nMore examples can be found by [searching mastodon.social for the hashtag #ImageDescription](https://mastodon.social/tags/imagedescription) and finding at my posts. For example:\r\n\r\nOriginal Hubzilla comment, very short even:\r\nhttps://hub.netzgemeinde.eu/display/b64.aHR0cHM6Ly9odWIubmV0emdlbWVpbmRlLmV1L2l0ZW0vYWFjOWE2YTUtZTc1Zi00Njc5LWFiNjgtNGYyYzI5ZDJmMjI5\r\nMastodon 4.2.0 (mastodon.hardcoredevs.com), truncated mid-paragraph after the hashtag `#ImageDescription`:\r\nhttps://mastodon.hardcoredevs.com/@Andres/110894302610589500 (my comment is right below)\r\nThis is a special case because the whole thread was written before Mastodon 4.2.0.\r\n\r\nOriginal Hubzilla comment:\r\nhttps://hub.netzgemeinde.eu/display/b64.aHR0cHM6Ly9odWIubmV0emdlbWVpbmRlLmV1L2l0ZW0vOGYxYTQwMTUtNTc0Zi00YzEzLThkZTMtNDdhN2ViNGVjYjc1\r\nMastodon 4.2.1-rc1+pr-27261-37da69c (mastodon.social), entire second paragraph is missing:\r\nhttps://mastodon.social/@hikingdude/111091316259559387 (my comment is right below)\r\n\r\nOriginal Hubzilla comment:\r\nhttps://hub.netzgemeinde.eu/display/b64.aHR0cHM6Ly9odWIubmV0emdlbWVpbmRlLmV1L2l0ZW0vMDAyMDk4MjgtM2VjOC00MDUwLTlhN2QtMmIzM2M2Njk3OWVj\r\nMastodon 4.2.1-rc1+pr-27261-37da69c (mastodon.social), truncated mid-paragraph after the hashtag `#Friendica`:\r\nhttps://mastodon.social/@urlyman/111028486166963680 (my comment is right below)\r\n\r\nOriginal Hubzilla comment:\r\nhttps://hub.netzgemeinde.eu/channel/jupiter_rowland?mid=b64.aHR0cHM6Ly9odWIubmV0emdlbWVpbmRlLmV1L2l0ZW0vZDIzY2NkMjItMzUzNy00ODI4LWEzMDgtYjQ5YjY0MGU5MTQx\r\nMastodon 4.2.0 (ieji.de), truncated mid-paragraph after the hashtag `#AltText`:\r\nhttps://ieji.de/@soonix/111008439620893974 (my comment is right below)\r\n\r\nIt also happens to Hubzilla posts. I don't have an example of a Hubzilla post truncated on Mastodon that can be seen by scrolling up from a Mastodon reply, but here is an example with a raw Mastodon link (which will open Hubzilla in a Web browser, though):\r\n\r\nOriginal Hubzilla post:\r\nhttps://hub.netzgemeinde.eu/channel/jupiter_rowland?mid=b64.aHR0cHM6Ly9odWIubmV0emdlbWVpbmRlLmV1L2l0ZW0vMTM2MmE1NmUtYzU0Ny00MDU4LTgxZGMtNTRiZmMzMzgxNDVh\r\nMastodon 4.2.1-rc1+pr-27261-37da69c (mastodon.social), the last paragraph is missing:\r\nhttps://mastodon.social/@jupiter_rowland@hub.netzgemeinde.eu/111158674653031871\r\n\r\nThe same may happen to posts from other projects, especially Friendica and (streams). I don't have any evidence of this happening or not happening yet.\r\n\r\nAlso, I can't test this on mobile apps, so I can't say if this is a Web interface or backend issue.\r\n\r\n### Mastodon instance\r\n\r\nmastodon.social, fosstodon.org, norden.social, tooters.org, ieji.de, mastodon.hardcoredevs.com\r\n\r\n### Mastodon version\r\n\r\nv4.2.0, v4.2.1-rc1+pr-27261-37da69c\r\n\r\n### Browser name and version\r\n\r\nFirefox 118.0.1, original Mozilla build\r\n\r\n### Operating system\r\n\r\nDebian 13 \"trixie\" (testing)\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\nlib/mastodon/cli/search.rb\n@@ -100,6 +100,14 @@ def deploy\n       progress.finish\n \n       say(\"Indexed #{added} records, de-indexed #{removed}\", :green, true)\n+    rescue Elasticsearch::Transport::Transport::ServerError => e\n+      fail_with_message <<~ERROR\n+        There was an issue connecting to the search server. Make sure the\n+        server is configured and running correctly, and that the environment\n+        variable settings match what the server is expecting.\n+\n+        #{e.message}\n+      ERROR\n     end\n \n     private\n---\nspec/lib/mastodon/cli/search_spec.rb\n@@ -33,6 +33,17 @@\n       end\n     end\n \n+    context 'when server communication raises an error' do\n+      let(:options) { { reset_chewy: true } }\n+\n+      before { allow(Chewy::Stash::Specification).to receive(:reset!).and_raise(Elasticsearch::Transport::Transport::Errors::InternalServerError) }\n+\n+      it 'Exits with error message' do\n+        expect { subject }\n+          .to raise_error(Thor::Error, /issue connecting to the search/)\n+      end\n+    end\n+\n     context 'without options' do\n       before { stub_search_indexes }\n \n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/components/__tests__/hashtag_bar.tsx\n@@ -45,6 +45,21 @@ describe('computeHashtagBarForStatus', () => {\n     );\n   });\n \n+  it('does not truncate the contents when the last child is a text node', () => {\n+    const status = createStatus(\n+      'this is a #<a class=\"zrl\" href=\"https://example.com/search?tag=test\">test</a>. Some more text',\n+      ['test'],\n+    );\n+\n+    const { hashtagsInBar, statusContentProps } =\n+      computeHashtagBarForStatus(status);\n+\n+    expect(hashtagsInBar).toEqual([]);\n+    expect(statusContentProps.statusContent).toMatchInlineSnapshot(\n+      `\"this is a #<a class=\"zrl\" href=\"https://example.com/search?tag=test\">test</a>. Some more text\"`,\n+    );\n+  });\n+\n   it('extract tags from the last line', () => {\n     const status = createStatus(\n       '<p>Simple text</p><p><a href=\"test\">#hashtag</a></p>',\n---\napp/javascript/mastodon/components/hashtag_bar.tsx\n@@ -109,7 +109,7 @@ export function computeHashtagBarForStatus(status: StatusLike): {\n \n   const lastChild = template.content.lastChild;\n \n-  if (!lastChild) return defaultResult;\n+  if (!lastChild || lastChild.nodeType === Node.TEXT_NODE) return defaultResult;\n \n   template.content.removeChild(lastChild);\n   const contentWithoutLastLine = template;\n---\n\n\n---\n\nChoice C:\napp/models/status.rb\n@@ -162,7 +162,7 @@ class Status < ApplicationRecord\n   REAL_TIME_WINDOW = 6.hours\n \n   def cache_key\n-    \"v2:#{super}\"\n+    \"v3:#{super}\"\n   end\n \n   def searchable_by(preloaded = nil)\n---\n\n\n---\n\nChoice D:\ndocker-compose.yml\n@@ -2,7 +2,7 @@ version: '3'\n services:\n   db:\n     restart: always\n-    image: postgres:14-alpine\n+    image: postgres:15-alpine\n     shm_size: 256mb\n     networks:\n       - internal_network\n@@ -25,7 +25,7 @@ services:\n \n   # es:\n   #   restart: always\n-  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.4\n+  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9\n   #   environment:\n   #     - \"ES_JAVA_OPTS=-Xms512m -Xmx512m -Des.enforce.bootstrap.checks=true\"\n   #     - \"xpack.license.self_generated.type=basic\"\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Navigate to https://mastodon.social/relationships?activity=dormant I usually do it via Preferences - Follows and followers - Dormant\r\n2. See the \"We're sorry, but something went wrong on our end.\" error page\n\n### Expected behaviour\n\nA list of dormant people that I'm following\n\n### Actual behaviour\n\nAn error page\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.2.1-rc1+pr-27261-37da69c\n\n### Browser name and version\n\nGoogle Chrome Version 117.0.5938.132 (Official Build) (64-bit)\n\n### Operating system\n\nDebian\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/lib/request.rb\n@@ -284,11 +284,11 @@ def open(host, *args)\n         end\n \n         until socks.empty?\n-          _, available_socks, = IO.select(nil, socks, nil, Request::TIMEOUT[:connect])\n+          _, available_socks, = IO.select(nil, socks, nil, Request::TIMEOUT[:connect_timeout])\n \n           if available_socks.nil?\n             socks.each(&:close)\n-            raise HTTP::TimeoutError, \"Connect timed out after #{Request::TIMEOUT[:connect]} seconds\"\n+            raise HTTP::TimeoutError, \"Connect timed out after #{Request::TIMEOUT[:connect_timeout]} seconds\"\n           end\n \n           available_socks.each do |sock|\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/polls.scss\n@@ -128,6 +128,11 @@\n       border-width: 4px;\n     }\n \n+    &.active {\n+      background-color: $ui-button-focus-background-color;\n+      border-color: $ui-button-focus-background-color;\n+    }\n+\n     &::-moz-focus-inner {\n       outline: 0 !important;\n       border: 0;\n---\n\n\n---\n\nChoice C:\nconfig/initializers/vips.rb\n@@ -25,3 +25,11 @@\n \n   Vips.block_untrusted(true)\n end\n+\n+# In some places of the code, we rescue this exception, but we don't always\n+# load libvips, so it may be an undefined constant:\n+unless defined?(Vips)\n+  module Vips\n+    class Error < StandardError; end\n+  end\n+end\n---\n\n\n---\n\nChoice D:\napp/models/account.rb\n@@ -127,7 +127,7 @@ class Account < ApplicationRecord\n   scope :searchable, -> { without_unapproved.without_suspended.where(moved_to_account_id: nil) }\n   scope :discoverable, -> { searchable.without_silenced.where(discoverable: true).joins(:account_stat) }\n   scope :followable_by, ->(account) { joins(arel_table.join(Follow.arel_table, Arel::Nodes::OuterJoin).on(arel_table[:id].eq(Follow.arel_table[:target_account_id]).and(Follow.arel_table[:account_id].eq(account.id))).join_sources).where(Follow.arel_table[:id].eq(nil)).joins(arel_table.join(FollowRequest.arel_table, Arel::Nodes::OuterJoin).on(arel_table[:id].eq(FollowRequest.arel_table[:target_account_id]).and(FollowRequest.arel_table[:account_id].eq(account.id))).join_sources).where(FollowRequest.arel_table[:id].eq(nil)) }\n-  scope :by_recent_status, -> { order(Arel.sql('account_stats.last_status_at DESC NULLS LAST')) }\n+  scope :by_recent_status, -> { includes(:account_stat).merge(AccountStat.order('last_status_at DESC NULLS LAST')).references(:account_stat) }\n   scope :by_recent_sign_in, -> { order(Arel.sql('users.current_sign_in_at DESC NULLS LAST')) }\n   scope :popular, -> { order('account_stats.followers_count desc') }\n   scope :by_domain_and_subdomains, ->(domain) { where(domain: Instance.by_domain_and_subdomains(domain).select(:domain)) }\n---\napp/models/relationship_filter.rb\n@@ -114,7 +114,7 @@ def order_scope(value)\n   def activity_scope(value)\n     case value\n     when 'dormant'\n-      AccountStat.where(last_status_at: nil).or(AccountStat.where(AccountStat.arel_table[:last_status_at].lt(1.month.ago)))\n+      Account.joins(:account_stat).where(account_stat: { last_status_at: [nil, ...1.month.ago] })\n     else\n       raise Mastodon::InvalidParameterError, \"Unknown activity: #{value}\"\n     end\n---\nspec/models/relationship_filter_spec.rb\n@@ -6,32 +6,60 @@\n   let(:account) { Fabricate(:account) }\n \n   describe '#results' do\n-    context 'when default params are used' do\n-      subject do\n-        described_class.new(account, 'order' => 'active').results\n-      end\n+    let(:account_of_7_months) { Fabricate(:account_stat, statuses_count: 1, last_status_at: 7.months.ago).account }\n+    let(:account_of_1_day)    { Fabricate(:account_stat, statuses_count: 1, last_status_at: 1.day.ago).account }\n+    let(:account_of_3_days)   { Fabricate(:account_stat, statuses_count: 1, last_status_at: 3.days.ago).account }\n+    let(:silent_account)      { Fabricate(:account_stat, statuses_count: 0, last_status_at: nil).account }\n+\n+    before do\n+      account.follow!(account_of_7_months)\n+      account.follow!(account_of_1_day)\n+      account.follow!(account_of_3_days)\n+      account.follow!(silent_account)\n+    end\n \n-      before do\n-        add_following_account_with(last_status_at: 7.days.ago)\n-        add_following_account_with(last_status_at: 1.day.ago)\n-        add_following_account_with(last_status_at: 3.days.ago)\n+    context 'when ordering by last activity' do\n+      context 'when not filtering' do\n+        subject do\n+          described_class.new(account, 'order' => 'active').results\n+        end\n+\n+        it 'returns followings ordered by last activity' do\n+          expect(subject).to eq [account_of_1_day, account_of_3_days, account_of_7_months, silent_account]\n+        end\n       end\n \n-      it 'returns followings ordered by last activity' do\n-        expected_result = account.following.eager_load(:account_stat).reorder(nil).by_recent_status\n+      context 'when filtering for dormant accounts' do\n+        subject do\n+          described_class.new(account, 'order' => 'active', 'activity' => 'dormant').results\n+        end\n \n-        expect(subject).to eq expected_result\n+        it 'returns dormant followings ordered by last activity' do\n+          expect(subject).to eq [account_of_7_months, silent_account]\n+        end\n       end\n     end\n-  end\n \n-  def add_following_account_with(last_status_at:)\n-    following_account = Fabricate(:account)\n-    Fabricate(:account_stat, account: following_account,\n-                             last_status_at: last_status_at,\n-                             statuses_count: 1,\n-                             following_count: 0,\n-                             followers_count: 0)\n-    Fabricate(:follow, account: account, target_account: following_account).account\n+    context 'when ordering by account creation' do\n+      context 'when not filtering' do\n+        subject do\n+          described_class.new(account, 'order' => 'recent').results\n+        end\n+\n+        it 'returns followings ordered by last account creation' do\n+          expect(subject).to eq [silent_account, account_of_3_days, account_of_1_day, account_of_7_months]\n+        end\n+      end\n+\n+      context 'when filtering for dormant accounts' do\n+        subject do\n+          described_class.new(account, 'order' => 'recent', 'activity' => 'dormant').results\n+        end\n+\n+        it 'returns dormant followings ordered by last activity' do\n+          expect(subject).to eq [silent_account, account_of_7_months]\n+        end\n+      end\n+    end\n   end\n end\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Go to a server running Mastodon 4.2 without logging in (https://mastodon.social/search)\r\n2. Enter a search term. For instance, I used \"Gaetz\" since he's in the news today.\r\n3. View the search results. There will be no posts listed under the \"all\" tab, and the 'posts' tab will provide the misleading message \"Could not find anything for these search terms\"\r\n...\r\n\n\n### Expected behaviour\n\nEither show search results the same as for logged-in users, or clarify the response to say that search is turned off for anonymous users\n\n### Actual behaviour\n\n\"post\" search results are not shown. Instead shows misleading message \"Could not find anything for these search terms\"\n\n### Detailed description\n\nNote, this is not a problem with search itself. When logged in, I see plenty of search results (mstdn.science). It also is not a problem with displaying posts to anonymous users - the hashtag search works as expected and displays the posts properly (https://mastodon.social/tags/gaetz)\r\n\r\nIf this behavior is intentional, then the website should be clear about why it is not returning any results. The current response could give the wrong impression to someone who is curious about Mastodon and uses the search function to see what sort of activity is on Mastodon (concluding either that there is no activity, or that search is broken).\r\n\r\nI tested on both mastodon.social (v4.2.1-rc1+pr-27261-dd5f312) and mstdn.sciesce (4.2.0)\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.2.1-rc1+pr-27261-dd5f312\n\n### Browser name and version\n\nFirefox 118.0.1 (64-bit)\n\n### Operating system\n\nWindows 11\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/compose/components/search.jsx\n@@ -275,6 +275,7 @@ class Search extends PureComponent {\n   }\n \n   _calculateOptions (value) {\n+    const { signedIn } = this.context.identity;\n     const trimmedValue = value.trim();\n     const options = [];\n \n@@ -299,7 +300,7 @@ class Search extends PureComponent {\n \n       const couldBeStatusSearch = searchEnabled;\n \n-      if (couldBeStatusSearch) {\n+      if (couldBeStatusSearch && signedIn) {\n         options.push({ key: 'status-search', label: <FormattedMessage id='search.quick_action.status_search' defaultMessage='Posts matching {x}' values={{ x: <mark>{trimmedValue}</mark> }} />, action: this.handleStatusSearch });\n       }\n \n@@ -376,7 +377,7 @@ class Search extends PureComponent {\n \n           <h4><FormattedMessage id='search_popout.options' defaultMessage='Search options' /></h4>\n \n-          {searchEnabled ? (\n+          {searchEnabled && signedIn ? (\n             <div className='search__popout__menu'>\n               {this.defaultOptions.map(({ key, label, action }, i) => (\n                 <button key={key} onMouseDown={action} className={classNames('search__popout__menu__item', { selected: selectedOption === ((options.length || recent.size) + i) })}>\n@@ -386,7 +387,11 @@ class Search extends PureComponent {\n             </div>\n           ) : (\n             <div className='search__popout__menu__message'>\n-              <FormattedMessage id='search_popout.full_text_search_disabled_message' defaultMessage='Not available on {domain}.' values={{ domain }} />\n+              {searchEnabled ? (\n+                <FormattedMessage id='search_popout.full_text_search_logged_out_message' defaultMessage='Only available when logged in.' />\n+              ) : (\n+                <FormattedMessage id='search_popout.full_text_search_disabled_message' defaultMessage='Not available on {domain}.' values={{ domain }} />\n+              )}\n             </div>\n           )}\n         </div>\n---\napp/javascript/mastodon/locales/en.json\n@@ -606,6 +606,7 @@\n   \"search.quick_action.status_search\": \"Posts matching {x}\",\n   \"search.search_or_paste\": \"Search or paste URL\",\n   \"search_popout.full_text_search_disabled_message\": \"Not available on {domain}.\",\n+  \"search_popout.full_text_search_logged_out_message\": \"Only available when logged in.\",\n   \"search_popout.language_code\": \"ISO language code\",\n   \"search_popout.options\": \"Search options\",\n   \"search_popout.quick_actions\": \"Quick actions\",\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -424,6 +424,10 @@ html {\n   border-bottom: 0;\n }\n \n+.column-settings__hashtags .column-select__option {\n+  color: $white;\n+}\n+\n .dashboard__quick-access,\n .focal-point__preview strong,\n .admin-wrapper .content__heading__tabs a.selected {\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/components/__tests__/hashtag_bar.tsx\n@@ -45,6 +45,21 @@ describe('computeHashtagBarForStatus', () => {\n     );\n   });\n \n+  it('does not truncate the contents when the last child is a text node', () => {\n+    const status = createStatus(\n+      'this is a #<a class=\"zrl\" href=\"https://example.com/search?tag=test\">test</a>. Some more text',\n+      ['test'],\n+    );\n+\n+    const { hashtagsInBar, statusContentProps } =\n+      computeHashtagBarForStatus(status);\n+\n+    expect(hashtagsInBar).toEqual([]);\n+    expect(statusContentProps.statusContent).toMatchInlineSnapshot(\n+      `\"this is a #<a class=\"zrl\" href=\"https://example.com/search?tag=test\">test</a>. Some more text\"`,\n+    );\n+  });\n+\n   it('extract tags from the last line', () => {\n     const status = createStatus(\n       '<p>Simple text</p><p><a href=\"test\">#hashtag</a></p>',\n---\napp/javascript/mastodon/components/hashtag_bar.tsx\n@@ -109,7 +109,7 @@ export function computeHashtagBarForStatus(status: StatusLike): {\n \n   const lastChild = template.content.lastChild;\n \n-  if (!lastChild) return defaultResult;\n+  if (!lastChild || lastChild.nodeType === Node.TEXT_NODE) return defaultResult;\n \n   template.content.removeChild(lastChild);\n   const contentWithoutLastLine = template;\n---\n\n\n---\n\nChoice D:\napp/lib/activitypub/parser/status_parser.rb\n@@ -3,6 +3,8 @@\n class ActivityPub::Parser::StatusParser\n   include JsonLdHelper\n \n+  NORMALIZED_LOCALE_NAMES = LanguagesHelper::SUPPORTED_LOCALES.keys.index_by(&:downcase).freeze\n+\n   # @param [Hash] json\n   # @param [Hash] options\n   # @option options [String] :followers_collection\n@@ -87,6 +89,13 @@ def visibility\n   end\n \n   def language\n+    lang = raw_language_code\n+    lang.presence && NORMALIZED_LOCALE_NAMES.fetch(lang.downcase.to_sym, lang)\n+  end\n+\n+  private\n+\n+  def raw_language_code\n     if content_language_map?\n       @object['contentMap'].keys.first\n     elsif name_language_map?\n@@ -96,8 +105,6 @@ def language\n     end\n   end\n \n-  private\n-\n   def audience_to\n     as_array(@object['to'] || @json['to']).map { |x| value_or_id(x) }\n   end\n---\nspec/lib/activitypub/parser/status_parser_spec.rb\n@@ -0,0 +1,50 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+RSpec.describe ActivityPub::Parser::StatusParser do\n+  subject { described_class.new(json) }\n+\n+  let(:sender) { Fabricate(:account, followers_url: 'http://example.com/followers', domain: 'example.com', uri: 'https://example.com/actor') }\n+  let(:follower) { Fabricate(:account, username: 'bob') }\n+\n+  let(:json) do\n+    {\n+      '@context': 'https://www.w3.org/ns/activitystreams',\n+      id: [ActivityPub::TagManager.instance.uri_for(sender), '#foo'].join,\n+      type: 'Create',\n+      actor: ActivityPub::TagManager.instance.uri_for(sender),\n+      object: object_json,\n+    }.with_indifferent_access\n+  end\n+\n+  let(:object_json) do\n+    {\n+      id: [ActivityPub::TagManager.instance.uri_for(sender), 'post1'].join('/'),\n+      type: 'Note',\n+      to: [\n+        'https://www.w3.org/ns/activitystreams#Public',\n+        ActivityPub::TagManager.instance.uri_for(follower),\n+      ],\n+      content: '@bob lorem ipsum',\n+      contentMap: {\n+        EN: '@bob lorem ipsum',\n+      },\n+      published: 1.hour.ago.utc.iso8601,\n+      updated: 1.hour.ago.utc.iso8601,\n+      tag: {\n+        type: 'Mention',\n+        href: ActivityPub::TagManager.instance.uri_for(follower),\n+      },\n+    }\n+  end\n+\n+  it 'correctly parses status' do\n+    expect(subject).to have_attributes(\n+      text: '@bob lorem ipsum',\n+      uri: [ActivityPub::TagManager.instance.uri_for(sender), 'post1'].join('/'),\n+      reply: false,\n+      language: :en\n+    )\n+  end\n+end\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Open https://mastodon.social/settings/imports\r\n2. Select following list\r\n3. Choose file of followers exported from previous instance\r\n4. Select Merge\r\n5. Upload\n\n### Expected behaviour\n\nFinished with downloadable list of failures\n\n### Actual behaviour\n\nIn progress with no list of failures\n\n### Detailed description\n\nI migrated Mastodon instances yesterday and then imported my following list from the previous instance. After more than 24 hours, the import is still \"In progress\", with 202 / 204 imported, with 1 failure. So it appears to be stuck on 1 imported follower.\r\n\r\nAlso, the Failures list is not clickable, because it's still in progress, unlike with finished imports.\r\n![Screenshot 2023-10-01 at 10 39 35 AM](https://github.com/mastodon/mastodon/assets/56086/23f57008-7974-4ff9-b5f0-f3db18660db9)\r\n\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.2.0+pr-27116-50e1f46\n\n### Browser name and version\n\nSafari 17\n\n### Operating system\n\nmacOS 13.6\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/workers/import/row_worker.rb\n@@ -8,7 +8,7 @@ class Import::RowWorker\n   sidekiq_retries_exhausted do |msg, _exception|\n     ActiveRecord::Base.connection_pool.with_connection do\n       # Increment the total number of processed items, and bump the state of the import if needed\n-      bulk_import_id = BulkImportRow.where(id: msg['args'][0]).pick(:id)\n+      bulk_import_id = BulkImportRow.where(id: msg['args'][0]).pick(:bulk_import_id)\n       BulkImport.progress!(bulk_import_id) unless bulk_import_id.nil?\n     end\n   end\n---\n\n\n---\n\nChoice B:\napp/models/concerns/attachmentable.rb\n@@ -52,9 +52,13 @@ def check_image_dimension(attachment)\n     return if attachment.blank? || !/image.*/.match?(attachment.content_type) || attachment.queued_for_write[:original].blank?\n \n     width, height = FastImage.size(attachment.queued_for_write[:original].path)\n-    matrix_limit  = attachment.content_type == 'image/gif' ? GIF_MATRIX_LIMIT : MAX_MATRIX_LIMIT\n+    return unless width.present? && height.present?\n \n-    raise Mastodon::DimensionsValidationError, \"#{width}x#{height} images are not supported\" if width.present? && height.present? && (width * height > matrix_limit)\n+    if attachment.content_type == 'image/gif' && width * height > GIF_MATRIX_LIMIT\n+      raise Mastodon::DimensionsValidationError, \"#{width}x#{height} GIF files are not supported\"\n+    elsif width * height > MAX_MATRIX_LIMIT\n+      raise Mastodon::DimensionsValidationError, \"#{width}x#{height} images are not supported\"\n+    end\n   end\n \n   def appropriate_extension(attachment)\n---\n\n\n---\n\nChoice C:\nDockerfile\n@@ -247,7 +247,9 @@ RUN \\\n RUN \\\n # Pre-create and chown system volume to Mastodon user\n   mkdir -p /opt/mastodon/public/system; \\\n-  chown mastodon:mastodon /opt/mastodon/public/system;\n+  chown mastodon:mastodon /opt/mastodon/public/system; \\\n+# Set Mastodon user as owner of tmp folder\n+  chown -R mastodon:mastodon /opt/mastodon/tmp;\n \n # Set the running user for resulting container\n USER mastodon\n---\ndocker-compose.yml\n@@ -59,7 +59,7 @@ services:\n     image: ghcr.io/mastodon/mastodon:v4.2.0\n     restart: always\n     env_file: .env.production\n-    command: bash -c \"rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000\"\n+    command: bundle exec puma -C config/puma.rb\n     networks:\n       - external_network\n       - internal_network\n---\n\n\n---\n\nChoice D:\nconfig/initializers/cors.rb\n@@ -22,6 +22,7 @@\n                expose: %w(Link X-RateLimit-Reset X-RateLimit-Limit X-RateLimit-Remaining X-Request-Id),\n                methods: %i(post put delete get patch options)\n       resource '/oauth/token', methods: [:post]\n+      resource '/oauth/revoke', methods: [:post]\n     end\n   end\n end\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Post or receive a status with https://www.worldconcerthall.com/en/schedule/herrmann_korngold_with_lamsma_wagner_and_kodaly_from_rotterdam/77834/ in it\r\n\n\n### Expected behaviour\n\nThe `LinkCrawlWorker` will fetch the URL properly\n\n### Actual behaviour\n\nThe `LinkCrawlWorker` crashes with \"ArgumentError: invalid byte sequence in UTF-8\"\n\n### Detailed description\n\nWhen looking at the above URL, the headers indicate `content-type: text/html; charset=ISO-8859-1`, a non-UTF8 charset.\r\n\r\nWe have around hundreds of these dead workers littering the dead worker queue, and nearly every one of them failed in this similar fashion. I think it's a fixable problem, so i'm reporting it here.\n\n### Mastodon instance\n\ntech.lgbt\n\n### Mastodon version\n\nv4.2.0-rc2+glitch\n\n### Technical details\n\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x86_64-linux-gnu]\r\n- Node.js version: v18.12.1\r\n\n\n---\n\nChoice A:\napp/lib/link_details_extractor.rb\n@@ -282,6 +282,6 @@ def detector\n   end\n \n   def html_entities\n-    @html_entities ||= HTMLEntities.new\n+    @html_entities ||= HTMLEntities.new(:expanded)\n   end\n end\n---\n\n\n---\n\nChoice B:\napp/lib/link_details_extractor.rb\n@@ -269,16 +269,21 @@ def structured_data\n   end\n \n   def document\n-    @document ||= Nokogiri::HTML(@html, nil, encoding)\n+    @document ||= detect_encoding_and_parse_document\n   end\n \n-  def encoding\n-    @encoding ||= begin\n-      guess = detector.detect(@html, @html_charset)\n-      guess&.fetch(:confidence, 0).to_i > 60 ? guess&.fetch(:encoding, nil) : nil\n+  def detect_encoding_and_parse_document\n+    [detect_encoding, nil, @html_charset, 'UTF-8'].uniq.each do |encoding|\n+      document = Nokogiri::HTML(@html, nil, encoding)\n+      return document if document.to_s.valid_encoding?\n     end\n   end\n \n+  def detect_encoding\n+    guess = detector.detect(@html, @html_charset)\n+    guess&.fetch(:confidence, 0).to_i > 60 ? guess&.fetch(:encoding, nil) : nil\n+  end\n+\n   def detector\n     @detector ||= CharlockHolmes::EncodingDetector.new.tap do |detector|\n       detector.strip_tags = true\n---\nspec/fixtures/requests/low_confidence_latin1.txt\n@@ -0,0 +1,17 @@\n+HTTP/1.1 200 OK\n+server: nginx\n+date: Thu, 13 Jun 2024 14:33:13 GMT\n+content-type: text/html; charset=ISO-8859-1\n+content-length: 158\n+accept-ranges: bytes\n+\n+<!doctype html>\n+<html lang=\"en\">\n+<head>\n+  <meta charset=\"UTF-8\">\n+  <title>Tofu \ufffd l'orange</title>\n+</head>\n+<body>\n+  <h2>Tofu \ufffd l'orange</h2>\n+</body>\n+</html>\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -26,6 +26,7 @@\n     stub_request(:get, 'http://example.com/sjis_with_wrong_charset').to_return(request_fixture('sjis_with_wrong_charset.txt'))\n     stub_request(:get, 'http://example.com/koi8-r').to_return(request_fixture('koi8-r.txt'))\n     stub_request(:get, 'http://example.com/windows-1251').to_return(request_fixture('windows-1251.txt'))\n+    stub_request(:get, 'http://example.com/low_confidence_latin1').to_return(request_fixture('low_confidence_latin1.txt'))\n \n     Rails.cache.write('oembed_endpoint:example.com', oembed_cache) if oembed_cache\n \n@@ -148,6 +149,14 @@\n       end\n     end\n \n+    context 'with a URL of a page in ISO-8859-1 encoding, that charlock_holmes cannot detect' do\n+      let(:status) { Fabricate(:status, text: 'Check out http://example.com/low_confidence_latin1') }\n+\n+      it 'decodes the HTML' do\n+        expect(status.preview_card.title).to eq(\"Tofu \u00e1 l'orange\")\n+      end\n+    end\n+\n     context 'with a Japanese path URL' do\n       let(:status) { Fabricate(:status, text: '\u30c6\u30b9\u30c8http://example.com/\u65e5\u672c\u8a9e') }\n \n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/home_timeline/index.jsx\n@@ -37,7 +37,7 @@ const getHomeFeedSpeed = createSelector([\n   state => state.getIn(['timelines', 'home', 'pendingItems'], ImmutableList()),\n   state => state.get('statuses'),\n ], (statusIds, pendingStatusIds, statusMap) => {\n-  const recentStatusIds = pendingStatusIds.size > 0 ? pendingStatusIds : statusIds;\n+  const recentStatusIds = pendingStatusIds.concat(statusIds);\n   const statuses = recentStatusIds.filter(id => id !== null).map(id => statusMap.get(id)).filter(status => status?.get('account') !== me).take(20);\n \n   if (statuses.isEmpty()) {\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/dashboard.scss\n@@ -86,9 +86,7 @@\n     color: $primary-text-color;\n     transition: all 100ms ease-in;\n     font-size: 14px;\n-    padding: 0 16px;\n-    line-height: 36px;\n-    height: 36px;\n+    padding: 8px 16px;\n     text-decoration: none;\n     margin-bottom: 4px;\n \n---\napp/javascript/styles/mastodon/dashboard.scss\n@@ -91,6 +91,7 @@\n     height: 36px;\n     text-decoration: none;\n     margin-bottom: 4px;\n+    white-space: nowrap;\n \n     &:active,\n     &:focus,\n@@ -111,6 +112,8 @@\n \n     span {\n       flex: 1 1 auto;\n+      overflow: hidden;\n+      text-overflow: ellipsis;\n     }\n \n     strong {\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Before ver 4.2.0 notifications and mentions automatically refreshed in Safari.\r\n2. I would see the count of notifications I'd not checked.\r\n3. When I clicked on Notifications tab/link I would see the new notifications.4. \r\n...\r\nNow none of this happens unless I manually refresh the page.\r\n\r\nNote: Posts/Home timeline continues to automatically refresh (only Notifications is affected.)\r\n\r\n\r\n### Expected behaviour\r\n\r\nNotifications automatically pushed to Safari\r\n\r\n### Actual behaviour\r\n\r\nI have to manually click the reload icon to see notifications.\r\n\r\n### Detailed description\r\n\r\n1. Before ver 4.2.0 notifications and mentions automatically refreshed in Safari.\r\n2. I would see the count of notifications I'd not checked next to the Notifications link.\r\n3. When I clicked on Notifications tab/link I would see the new notifications.\r\n...\r\nNow none of this happens unless I manually click the reload icon to refresh the page. \r\nHome and Live Feeds update automatically, just not Notifications.\r\n\r\n### Mastodon instance\r\n\r\ntechhub.social\r\n\r\n### Mastodon version\r\n\r\nv 4.2.0\r\n\r\n### Browser name and version\r\n\r\nSafari Version 14.1.2 (14611.3.10.1.7)\r\n\r\n### Operating system\r\n\r\nmacOS 10.14.6\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -2612,6 +2612,7 @@ a.account__display-name {\n }\n \n $ui-header-height: 55px;\n+$ui-header-logo-wordmark-width: 99px;\n \n .ui__header {\n   display: none;\n@@ -2627,6 +2628,10 @@ $ui-header-height: 55px;\n   &__logo {\n     display: inline-flex;\n     padding: 15px;\n+    flex-grow: 1;\n+    flex-shrink: 1;\n+    overflow: hidden;\n+    container: header-logo / inline-size;\n \n     .logo {\n       height: $ui-header-height - 30px;\n@@ -2637,7 +2642,7 @@ $ui-header-height: 55px;\n       display: none;\n     }\n \n-    @media screen and (width >= 320px) {\n+    @container header-logo (min-width: #{$ui-header-logo-wordmark-width}) {\n       .logo--wordmark {\n         display: block;\n       }\n@@ -2654,6 +2659,7 @@ $ui-header-height: 55px;\n     gap: 10px;\n     padding: 0 10px;\n     overflow: hidden;\n+    flex-shrink: 0;\n \n     .button {\n       flex: 0 0 auto;\n---\n\n\n---\n\nChoice B:\napp/views/admin/rules/_rule.html.haml\n@@ -5,7 +5,7 @@\n \n   .announcements-list__item__action-bar\n     .announcements-list__item__meta\n-      = rule.text\n+      = rule.hint\n \n     %div\n       = table_link_to 'trash', t('admin.rules.delete'), admin_rule_path(rule), method: :delete, data: { confirm: t('admin.accounts.are_you_sure') } if can?(:destroy, rule)\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/polyfills/base_polyfills.ts\n@@ -1,4 +1,5 @@\n import 'core-js/features/object/assign';\n+import 'core-js/features/object/has-own';\n import 'core-js/features/object/values';\n import 'core-js/features/symbol';\n import 'core-js/features/promise/finally';\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/components/hashtag_bar.jsx\n@@ -0,0 +1,50 @@\n+import PropTypes from 'prop-types';\n+import { useMemo, useState, useCallback } from 'react';\n+\n+import { FormattedMessage } from 'react-intl';\n+\n+import { Link } from 'react-router-dom';\n+\n+import ImmutablePropTypes from 'react-immutable-proptypes';\n+\n+const domParser = new DOMParser();\n+\n+// About two lines on desktop\n+const VISIBLE_HASHTAGS = 7;\n+\n+export const HashtagBar = ({ hashtags, text }) => {\n+  const renderedHashtags = useMemo(() => {\n+    const body = domParser.parseFromString(text, 'text/html').documentElement;\n+    return [].map.call(body.querySelectorAll('[rel=tag]'), node => node.textContent.toLowerCase());\n+  }, [text]);\n+\n+  const invisibleHashtags = useMemo(() => (\n+    hashtags.filter(hashtag => !renderedHashtags.some(textContent => textContent === `#${hashtag.get('name')}` || textContent === hashtag.get('name')))\n+  ), [hashtags, renderedHashtags]);\n+\n+  const [expanded, setExpanded] = useState(false);\n+  const handleClick = useCallback(() => setExpanded(true), []);\n+\n+  if (invisibleHashtags.isEmpty()) {\n+    return null;\n+  }\n+\n+  const revealedHashtags = expanded ? invisibleHashtags : invisibleHashtags.take(VISIBLE_HASHTAGS);\n+\n+  return (\n+    <div className='hashtag-bar'>\n+      {revealedHashtags.map(hashtag => (\n+        <Link key={hashtag.get('name')} to={`/tags/${hashtag.get('name')}`}>\n+          #{hashtag.get('name')}\n+        </Link>\n+      ))}\n+\n+      {!expanded && invisibleHashtags.size > VISIBLE_HASHTAGS && <button className='link-button' onClick={handleClick}><FormattedMessage id='hashtags.and_other' defaultMessage='\u2026and {count, plural, other {# more}}' values={{ count: invisibleHashtags.size - VISIBLE_HASHTAGS }} /></button>}\n+    </div>\n+  );\n+};\n+\n+HashtagBar.propTypes = {\n+  hashtags: ImmutablePropTypes.list,\n+  text: PropTypes.string,\n+};\n\\ No newline at end of file\n---\napp/javascript/mastodon/components/status.jsx\n@@ -22,6 +22,7 @@ import { displayMedia } from '../initial_state';\n import { Avatar } from './avatar';\n import { AvatarOverlay } from './avatar_overlay';\n import { DisplayName } from './display_name';\n+import { HashtagBar } from './hashtag_bar';\n import { RelativeTimestamp } from './relative_timestamp';\n import StatusActionBar from './status_action_bar';\n import StatusContent from './status_content';\n@@ -580,6 +581,8 @@ class Status extends ImmutablePureComponent {\n \n             {media}\n \n+            <HashtagBar hashtags={status.get('tags')} text={status.get('content')} />\n+\n             <StatusActionBar scrollKey={scrollKey} status={status} account={account} onFilter={matchedFilters ? this.handleFilterClick : null} {...other} />\n           </div>\n         </div>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -10,6 +10,7 @@ import ImmutablePureComponent from 'react-immutable-pure-component';\n \n import { AnimatedNumber } from 'mastodon/components/animated_number';\n import EditedTimestamp from 'mastodon/components/edited_timestamp';\n+import { HashtagBar } from 'mastodon/components/hashtag_bar';\n import { Icon }  from 'mastodon/components/icon';\n import PictureInPicturePlaceholder from 'mastodon/components/picture_in_picture_placeholder';\n \n@@ -314,6 +315,8 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           {media}\n \n+          <HashtagBar hashtags={status.get('tags')} text={status.get('content')} />\n+\n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n               <FormattedDate value={new Date(status.get('created_at'))} hour12={false} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n---\napp/javascript/mastodon/locales/en.json\n@@ -300,6 +300,7 @@\n   \"hashtag.counter_by_uses_today\": \"{count, plural, one {{counter} post} other {{counter} posts}} today\",\n   \"hashtag.follow\": \"Follow hashtag\",\n   \"hashtag.unfollow\": \"Unfollow hashtag\",\n+  \"hashtags.and_other\": \"\u2026and {count, plural, other {# more}}\",\n   \"home.actions.go_to_explore\": \"See what's trending\",\n   \"home.actions.go_to_suggestions\": \"Find people to follow\",\n   \"home.column_settings.basic\": \"Basic\",\n---\napp/javascript/styles/mastodon/components.scss\n@@ -9256,3 +9256,26 @@ noscript {\n     }\n   }\n }\n+\n+.hashtag-bar {\n+  margin-top: 16px;\n+  display: flex;\n+  flex-wrap: wrap;\n+  font-size: 14px;\n+  gap: 4px;\n+\n+  a {\n+    display: inline-flex;\n+    border-radius: 4px;\n+    background: rgba($highlight-text-color, 0.2);\n+    color: $highlight-text-color;\n+    padding: 0.4em 0.6em;\n+    text-decoration: none;\n+\n+    &:hover,\n+    &:focus,\n+    &:active {\n+      background: rgba($highlight-text-color, 0.3);\n+    }\n+  }\n+}\n---\napp/javascript/mastodon/components/status.jsx\n@@ -546,6 +546,7 @@ class Status extends ImmutablePureComponent {\n     const visibilityIcon = visibilityIconInfo[status.get('visibility')];\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n+    const expanded = !status.get('hidden')\n \n     return (\n       <HotKeys handlers={handlers}>\n@@ -574,7 +575,7 @@ class Status extends ImmutablePureComponent {\n             <StatusContent\n               status={status}\n               onClick={this.handleClick}\n-              expanded={!status.get('hidden')}\n+              expanded={expanded}\n               onExpandedToggle={this.handleExpandedToggle}\n               onTranslate={this.handleTranslate}\n               collapsible\n@@ -584,7 +585,7 @@ class Status extends ImmutablePureComponent {\n \n             {media}\n \n-            {hashtagBar}\n+            {expanded && hashtagBar}\n \n             <StatusActionBar scrollKey={scrollKey} status={status} account={account} onFilter={matchedFilters ? this.handleFilterClick : null} {...other} />\n           </div>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -293,6 +293,7 @@ class DetailedStatus extends ImmutablePureComponent {\n     }\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n+    const expanded = !status.get('hidden')\n \n     return (\n       <div style={outerStyle}>\n@@ -318,7 +319,7 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           {media}\n \n-          {hashtagBar}\n+          {expanded && hashtagBar}\n \n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nI am logged into mastodon.social. At this exact moment, if I open https://mastodon.social/@graydon@types.pl , I see this\r\n\r\n![image](https://github.com/mastodon/mastodon/assets/277318/dadcb6dd-c0d2-41ad-92f2-a4cd2a0271a7)\r\n\r\nNotice the reference to a \"last boost\".\r\n\r\nIf I go directly to graydon's feed on types.pl https://types.pl/@graydon , I see this:\r\n\r\n![image](https://github.com/mastodon/mastodon/assets/277318/d3d307d7-9130-4bd2-94fd-70fd75dff8ed)\r\n\r\nBeneath the crawfordsm post, I see the microplastics post. There is a post missing from this feed, but *only* when I view from mastodon.social.\r\n\r\n@crawfordsm@mastodon.social is on mastodon.social, so I assume that there is not a federation issue preventing me from seeing the post. I do not have crawfordsm blocked or muted. I have no filters which hide posts completly (only hide with warning) and none of my filters would apply to this post. It is possible crawfordsm has me blocked, but I assume not because I can see the original post on mastodon.social https://mastodon.social/@crawfordsm/110700335570308419 , I can see crawfordsm's profile, and the UI does not stop me from trying to @-mention Dr. Crawford.\n\n### Expected behaviour\n\nI expect that boosts and regular statuses should be shown to me in chronological order if the account is on a peer server in good standing.\n\n### Actual behaviour\n\nPost from my instance boosted on other instance missing from user feed\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.2.0+pr-27116-50e1f46\n\n### Browser name and version\n\nChrome 117.0.5938.92 (Official Build) (64-bit)\n\n### Operating system\n\nWindows 10\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/lib/account_statuses_filter.rb\n@@ -60,8 +60,12 @@ def filtered_reblogs_scope\n       .where(reblog_of_id: nil)\n       .or(\n         scope\n+          # This is basically `Status.not_domain_blocked_by_account(current_account)`\n+          # and `Status.not_excluded_by_account(current_account)` but on the\n+          # `reblog` association. Unfortunately, there seem to be no clean way\n+          # to re-use those scopes in our case.\n+          .where(reblog: { accounts: { domain: nil } }).or(scope.where.not(reblog: { accounts: { domain: current_account.excluded_from_timeline_domains } }))\n           .where.not(reblog: { account_id: current_account.excluded_from_timeline_account_ids })\n-          .where.not(reblog: { accounts: { domain: current_account.excluded_from_timeline_domains } })\n       )\n   end\n \n---\nspec/lib/account_statuses_filter_spec.rb\n@@ -202,7 +202,7 @@ def status_with_media_attachment!(visibility)\n       context 'when blocking a reblogged domain' do\n         let(:other_account) { Fabricate(:account, domain: 'example.com') }\n         let(:reblogging_status) { Fabricate(:status, account: other_account) }\n-        let(:reblog) { Fabricate(:status, account: account, visibility: 'public', reblog: reblogging_status) }\n+        let!(:reblog) { Fabricate(:status, account: account, visibility: 'public', reblog: reblogging_status) }\n \n         before do\n           current_account.block_domain!(other_account.domain)\n@@ -213,6 +213,20 @@ def status_with_media_attachment!(visibility)\n         end\n       end\n \n+      context 'when blocking an unrelated domain' do\n+        let(:other_account) { Fabricate(:account, domain: nil) }\n+        let(:reblogging_status) { Fabricate(:status, account: other_account, visibility: 'public') }\n+        let!(:reblog) { Fabricate(:status, account: account, visibility: 'public', reblog: reblogging_status) }\n+\n+        before do\n+          current_account.block_domain!('example.com')\n+        end\n+\n+        it 'returns the reblog from the non-blocked domain' do\n+          expect(subject.results.pluck(:id)).to include(reblog.id)\n+        end\n+      end\n+\n       context 'when muting a reblogged account' do\n         let(:reblog) { status_with_reblog!('public') }\n \n---\n\n\n---\n\nChoice B:\napp/models/tag.rb\n@@ -37,7 +37,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?<![=/)\\w])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}i\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]\\u0E47-\\u0E4E#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/tag_spec.rb\n@@ -36,6 +36,10 @@\n       expect(subject.match('https://gcc.gnu.org/bugzilla/show_bug.cgi?id=111895#c4')).to be_nil\n     end\n \n+    it 'does not match URLs with hashtag-like anchors after a non-ascii character' do\n+      expect(subject.match('https://example.org/test\u00e9#foo')).to be_nil\n+    end\n+\n     it 'does not match URLs with hashtag-like anchors after an empty query parameter' do\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)?foo=#Lawsuit')).to be_nil\n     end\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/api_types/accounts.ts\n@@ -13,7 +13,7 @@ export interface ApiAccountRoleJSON {\n }\n \n // See app/serializers/rest/account_serializer.rb\n-export interface ApiAccountJSON {\n+export interface BaseApiAccountJSON {\n   acct: string;\n   avatar: string;\n   avatar_static: string;\n@@ -45,3 +45,12 @@ export interface ApiAccountJSON {\n   memorial?: boolean;\n   hide_collections: boolean;\n }\n+\n+// See app/serializers/rest/muted_account_serializer.rb\n+export interface ApiMutedAccountJSON extends BaseApiAccountJSON {\n+  mute_expires_at?: string | null;\n+}\n+\n+// For now, we have the same type representing both `Account` and `MutedAccount`\n+// objects, but we should refactor this in the future.\n+export type ApiAccountJSON = ApiMutedAccountJSON;\n---\napp/javascript/mastodon/models/account.ts\n@@ -95,6 +95,9 @@ export const accountDefaultValues: AccountShape = {\n   limited: false,\n   moved: null,\n   hide_collections: false,\n+  // This comes from `ApiMutedAccountJSON`, but we should eventually\n+  // store that in a different object.\n+  mute_expires_at: null,\n };\n \n const AccountFactory = ImmutableRecord<AccountShape>(accountDefaultValues);\n---\n\n\n---\n\nChoice D:\napp/models/account.rb\n@@ -144,6 +144,7 @@ class Account < ApplicationRecord\n   scope :dormant, -> { joins(:account_stat).merge(AccountStat.without_recent_activity) }\n   scope :with_username, ->(value) { where arel_table[:username].lower.eq(value.to_s.downcase) }\n   scope :with_domain, ->(value) { where arel_table[:domain].lower.eq(value&.to_s&.downcase) }\n+  scope :without_memorial, -> { where(memorial: false) }\n \n   after_update_commit :trigger_update_webhooks\n \n---\napp/models/account_suggestions/friends_of_friends_source.rb\n@@ -31,6 +31,7 @@ def source_query(account, limit: DEFAULT_LIMIT)\n         AND accounts.suspended_at IS NULL\n         AND accounts.silenced_at IS NULL\n         AND accounts.moved_to_account_id IS NULL\n+        AND accounts.memorial = FALSE\n         AND follow_recommendation_mutes.target_account_id IS NULL\n       GROUP BY accounts.id, account_stats.id\n       ORDER BY frequency DESC, account_stats.followers_count ASC\n---\napp/models/account_suggestions/source.rb\n@@ -14,6 +14,7 @@ def base_account_scope(account)\n       .searchable\n       .where(discoverable: true)\n       .without_silenced\n+      .without_memorial\n       .where.not(follows_sql, id: account.id)\n       .where.not(follow_requests_sql, id: account.id)\n       .not_excluded_by_account(account)\n---\nspec/models/account_suggestions/friends_of_friends_source_spec.rb\n@@ -15,6 +15,7 @@\n     let!(:john) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:jerk) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:larry) { Fabricate(:account, discoverable: true, hide_collections: false) }\n+    let!(:morty) { Fabricate(:account, discoverable: true, hide_collections: false, memorial: true) }\n \n     context 'with follows and blocks' do\n       before do\n@@ -27,8 +28,8 @@\n         # alice follows eve and mallory\n         [john, mallory].each { |account| alice.follow!(account) }\n \n-        # eugen follows eve, john, jerk, larry and neil\n-        [eve, mallory, jerk, larry, neil].each { |account| eugen.follow!(account) }\n+        # eugen follows eve, john, jerk, larry, neil and morty\n+        [eve, mallory, jerk, larry, neil, morty].each { |account| eugen.follow!(account) }\n       end\n \n       it 'returns eligible accounts', :aggregate_failures do\n@@ -51,6 +52,9 @@\n \n         # the suggestion for neil has already been rejected\n         expect(results).to_not include([neil.id, :friends_of_friends])\n+\n+        # morty is not included because his account is in memoriam\n+        expect(results).to_not include([morty.id, :friends_of_friends])\n       end\n     end\n \n---\nspec/models/account_suggestions/source_spec.rb\n@@ -21,6 +21,7 @@\n       let!(:moved_account) { Fabricate(:account, moved_to_account: Fabricate(:account), discoverable: true) }\n       let!(:silenced_account) { Fabricate(:account, silenced: true, discoverable: true) }\n       let!(:undiscoverable_account) { Fabricate(:account, discoverable: false) }\n+      let!(:memorial_account) { Fabricate(:account, memorial: true, discoverable: true) }\n \n       before do\n         Fabricate :account_domain_block, account: account, domain: account_domain_blocked_account.domain\n@@ -44,6 +45,7 @@\n           .and not_include(moved_account)\n           .and not_include(silenced_account)\n           .and not_include(undiscoverable_account)\n+          .and not_include(memorial_account)\n       end\n     end\n   end\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Create a post with the language set to a locale with a country code (e.g. zh-HK)\r\n2. Obtain the JSON-LD of the post (e.g. using `curl -H \"Accept: application/json\"`)\r\n3. Note the keys of the `contentMap` object\r\n\n\n### Expected behaviour\n\nThe first key of the object should be a valid locale string in accordance with BCP47 (e.g. zh-HK)\n\n### Actual behaviour\n\nThe first key is in camel-case without a hyphen (e.g. zhHk)\n\n### Detailed description\n\nIntroduced by #27099. It seems like this is how languages are currently stored in the database, so some conversion is likely needed before sending a post to inboxes.\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\n_No response_\n\n### Technical details\n\n- Ruby version: 3.2.2\r\n- Node.js version: 18.17.1\r\n\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/dashboard.scss\n@@ -86,9 +86,7 @@\n     color: $primary-text-color;\n     transition: all 100ms ease-in;\n     font-size: 14px;\n-    padding: 0 16px;\n-    line-height: 36px;\n-    height: 36px;\n+    padding: 8px 16px;\n     text-decoration: none;\n     margin-bottom: 4px;\n \n---\napp/javascript/styles/mastodon/dashboard.scss\n@@ -91,6 +91,7 @@\n     height: 36px;\n     text-decoration: none;\n     margin-bottom: 4px;\n+    white-space: nowrap;\n \n     &:active,\n     &:focus,\n@@ -111,6 +112,8 @@\n \n     span {\n       flex: 1 1 auto;\n+      overflow: hidden;\n+      text-overflow: ellipsis;\n     }\n \n     strong {\n---\n\n\n---\n\nChoice B:\napp/lib/admin/system_check/elasticsearch_check.rb\n@@ -41,7 +41,7 @@ def message\n       Admin::SystemCheck::Message.new(:elasticsearch_health_red)\n     elsif cluster_health['number_of_nodes'] < 2 && es_preset != 'single_node_cluster'\n       Admin::SystemCheck::Message.new(:elasticsearch_preset_single_node, nil, 'https://docs.joinmastodon.org/admin/optional/elasticsearch/#scaling')\n-    elsif Chewy.client.indices.get_settings['chewy_specifications'].dig('settings', 'index', 'number_of_replicas')&.to_i&.positive? && es_preset == 'single_node_cluster'\n+    elsif Chewy.client.indices.get_settings[Chewy::Stash::Specification.index_name]&.dig('settings', 'index', 'number_of_replicas')&.to_i&.positive? && es_preset == 'single_node_cluster'\n       Admin::SystemCheck::Message.new(:elasticsearch_reset_chewy)\n     elsif cluster_health['status'] == 'yellow'\n       Admin::SystemCheck::Message.new(:elasticsearch_health_yellow)\n---\napp/lib/admin/system_check/elasticsearch_check.rb\n@@ -41,7 +41,7 @@ def message\n       Admin::SystemCheck::Message.new(:elasticsearch_health_red)\n     elsif cluster_health['number_of_nodes'] < 2 && es_preset != 'single_node_cluster'\n       Admin::SystemCheck::Message.new(:elasticsearch_preset_single_node, nil, 'https://docs.joinmastodon.org/admin/optional/elasticsearch/#scaling')\n-    elsif Chewy.client.indices.get_settings['chewy_specifications'].dig('settings', 'index', 'number_of_replicas')&.to_i&.positive? && es_preset == 'single_node_cluster'\n+    elsif Chewy.client.indices.get_settings[Chewy::Stash::Specification.index_name]&.dig('settings', 'index', 'number_of_replicas')&.to_i&.positive? && es_preset == 'single_node_cluster'\n       Admin::SystemCheck::Message.new(:elasticsearch_reset_chewy)\n     elsif cluster_health['status'] == 'yellow'\n       Admin::SystemCheck::Message.new(:elasticsearch_health_yellow)\n---\n\n\n---\n\nChoice C:\napp/lib/activitypub/case_transform.rb\n@@ -14,6 +14,8 @@ def camel_lower(value)\n       when String\n         camel_lower_cache[value] ||= if value.start_with?('_:')\n                                        \"_:#{value.delete_prefix('_:').underscore.camelize(:lower)}\"\n+                                     elsif LanguagesHelper::ISO_639_1_REGIONAL.key?(value.to_sym)\n+                                       value\n                                      else\n                                        value.underscore.camelize(:lower)\n                                      end\n---\nspec/serializers/activitypub/note_serializer_spec.rb\n@@ -7,7 +7,7 @@\n \n   let!(:account) { Fabricate(:account) }\n   let!(:other) { Fabricate(:account) }\n-  let!(:parent) { Fabricate(:status, account: account, visibility: :public) }\n+  let!(:parent) { Fabricate(:status, account: account, visibility: :public, language: 'zh-TW') }\n   let!(:reply_by_account_first) { Fabricate(:status, account: account, thread: parent, visibility: :public) }\n   let!(:reply_by_account_next) { Fabricate(:status, account: account, thread: parent, visibility: :public) }\n   let!(:reply_by_other_first) { Fabricate(:status, account: other, thread: parent, visibility: :public) }\n@@ -18,8 +18,15 @@\n     @serialization = ActiveModelSerializers::SerializableResource.new(parent, serializer: described_class, adapter: ActivityPub::Adapter)\n   end\n \n-  it 'has a Note type' do\n-    expect(subject['type']).to eql('Note')\n+  it 'has the expected shape' do\n+    expect(subject).to include({\n+      '@context' => include('https://www.w3.org/ns/activitystreams'),\n+      'type' => 'Note',\n+      'attributedTo' => ActivityPub::TagManager.instance.uri_for(account),\n+      'contentMap' => include({\n+        'zh-TW' => a_kind_of(String),\n+      }),\n+    })\n   end\n \n   it 'has a replies collection' do\n---\n\n\n---\n\nChoice D:\napp/lib/link_details_extractor.rb\n@@ -156,11 +156,11 @@ def height\n   end\n \n   def title\n-    html_entities.decode(structured_data&.headline || opengraph_tag('og:title') || document.xpath('//title').map(&:content).first).strip\n+    html_entities_decode(structured_data&.headline || opengraph_tag('og:title') || document.xpath('//title').map(&:content).first).strip\n   end\n \n   def description\n-    html_entities.decode(structured_data&.description || opengraph_tag('og:description') || meta_tag('description'))\n+    html_entities_decode(structured_data&.description || opengraph_tag('og:description') || meta_tag('description'))\n   end\n \n   def published_at\n@@ -180,15 +180,15 @@ def canonical_url\n   end\n \n   def provider_name\n-    html_entities.decode(structured_data&.publisher_name || opengraph_tag('og:site_name'))\n+    html_entities_decode(structured_data&.publisher_name || opengraph_tag('og:site_name'))\n   end\n \n   def provider_url\n     valid_url_or_nil(host_to_url(opengraph_tag('og:site')))\n   end\n \n   def author_name\n-    html_entities.decode(structured_data&.author_name || opengraph_tag('og:author') || opengraph_tag('og:author:username'))\n+    html_entities_decode(structured_data&.author_name || opengraph_tag('og:author') || opengraph_tag('og:author:username'))\n   end\n \n   def author_url\n@@ -257,7 +257,7 @@ def structured_data\n \n       next if json_ld.blank?\n \n-      structured_data = StructuredData.new(html_entities.decode(json_ld))\n+      structured_data = StructuredData.new(html_entities_decode(json_ld))\n \n       next unless structured_data.valid?\n \n@@ -273,10 +273,11 @@ def document\n   end\n \n   def detect_encoding_and_parse_document\n-    [detect_encoding, nil, @html_charset, 'UTF-8'].uniq.each do |encoding|\n+    [detect_encoding, nil, @html_charset].uniq.each do |encoding|\n       document = Nokogiri::HTML(@html, nil, encoding)\n       return document if document.to_s.valid_encoding?\n     end\n+    Nokogiri::HTML(@html, nil, 'UTF-8')\n   end\n \n   def detect_encoding\n@@ -290,6 +291,15 @@ def detector\n     end\n   end\n \n+  def html_entities_decode(string)\n+    return if string.nil?\n+\n+    unicode_string = string.encode('UTF-8')\n+    raise EncodingError, 'cannot convert string to valid UTF-8' unless unicode_string.valid_encoding?\n+\n+    html_entities.decode(unicode_string)\n+  end\n+\n   def html_entities\n     @html_entities ||= HTMLEntities.new(:expanded)\n   end\n---\napp/services/fetch_link_card_service.rb\n@@ -32,7 +32,7 @@ def call(status)\n     end\n \n     attach_card if @card&.persisted?\n-  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError, Encoding::UndefinedConversionError => e\n+  rescue HTTP::Error, OpenSSL::SSL::SSLError, Addressable::URI::InvalidURIError, Mastodon::HostValidationError, Mastodon::LengthValidationError, EncodingError => e\n     Rails.logger.debug { \"Error fetching link #{@original_url}: #{e}\" }\n     nil\n   end\n---\nspec/fixtures/requests/latin1_posing_as_utf8_broken.txt\n@@ -0,0 +1,17 @@\n+HTTP/1.1 200 OK\n+server: nginx\n+date: Thu, 13 Jun 2024 14:33:13 GMT\n+content-type: text/html; charset=utf-8\n+content-length: 158\n+accept-ranges: bytes\n+\n+<!doctype html>\n+<html lang=\"en\">\n+<head>\n+  <meta charset=\"UTF-8\">\n+  <title>Tofu \ufffd l'orange</title>\n+</head>\n+<body>\n+  <h2>Tofu \ufffd l'orange</h2>\n+</body>\n+</html>\n---\nspec/fixtures/requests/latin1_posing_as_utf8_recoverable.txt\n@@ -0,0 +1,17 @@\n+HTTP/1.1 200 OK\n+server: nginx\n+date: Thu, 13 Jun 2024 14:33:13 GMT\n+content-type: text/html; charset=utf-8\n+content-length: 158\n+accept-ranges: bytes\n+\n+<!doctype html>\n+<html lang=\"en\">\n+<head>\n+  <meta charset=\"UTF-8\">\n+  <title>Tofu with orange sauce</title>\n+</head>\n+<body>\n+  <h2>Tofu \ufffd l'orange</h2>\n+</body>\n+</html>\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -27,6 +27,8 @@\n     stub_request(:get, 'http://example.com/koi8-r').to_return(request_fixture('koi8-r.txt'))\n     stub_request(:get, 'http://example.com/windows-1251').to_return(request_fixture('windows-1251.txt'))\n     stub_request(:get, 'http://example.com/low_confidence_latin1').to_return(request_fixture('low_confidence_latin1.txt'))\n+    stub_request(:get, 'http://example.com/latin1_posing_as_utf8_broken').to_return(request_fixture('latin1_posing_as_utf8_broken.txt'))\n+    stub_request(:get, 'http://example.com/latin1_posing_as_utf8_recoverable').to_return(request_fixture('latin1_posing_as_utf8_recoverable.txt'))\n     stub_request(:get, 'http://example.com/aergerliche-umlaute').to_return(request_fixture('redirect_with_utf8_url.txt'))\n \n     Rails.cache.write('oembed_endpoint:example.com', oembed_cache) if oembed_cache\n@@ -159,10 +161,30 @@\n     end\n \n     context 'with a URL of a page in ISO-8859-1 encoding, that charlock_holmes cannot detect' do\n-      let(:status) { Fabricate(:status, text: 'Check out http://example.com/low_confidence_latin1') }\n+      context 'when encoding in http header is correct' do\n+        let(:status) { Fabricate(:status, text: 'Check out http://example.com/low_confidence_latin1') }\n \n-      it 'decodes the HTML' do\n-        expect(status.preview_card.title).to eq(\"Tofu \u00e1 l'orange\")\n+        it 'decodes the HTML' do\n+          expect(status.preview_card.title).to eq(\"Tofu \u00e1 l'orange\")\n+        end\n+      end\n+\n+      context 'when encoding in http header is incorrect' do\n+        context 'when encoding problems appear in unrelated tags' do\n+          let(:status) { Fabricate(:status, text: 'Check out http://example.com/latin1_posing_as_utf8_recoverable') }\n+\n+          it 'decodes the HTML' do\n+            expect(status.preview_card.title).to eq('Tofu with orange sauce')\n+          end\n+        end\n+\n+        context 'when encoding problems appear in title tag' do\n+          let(:status) { Fabricate(:status, text: 'Check out http://example.com/latin1_posing_as_utf8_broken') }\n+\n+          it 'does not create a preview card' do\n+            expect(status.preview_card).to be_nil\n+          end\n+        end\n       end\n     end\n \n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nPost this:\r\n\r\n> 21:45 Edinburgh to Perth due 23:06\r\n> Facilities on the 21:45 Edinburgh to Perth due 23:06.\r\n> http://www.journeycheck.com/scotrail/route?id=16801062571L71Y30051270923&action=search&from=&to=&savedRoute=&formTubeUpdateType=&formTubeUpdateLocation=Service+Updates&formTubeUpdatePeriod=#16801062571L71Y30051270923\n\n### Expected behaviour\n\nPost has no hashtags\n\n### Actual behaviour\n\nPost shows hashtag #16801062571L71Y30051270923 on the bottom\n\n### Detailed description\n\nWrote an RSS bot that is pulling links with hashtags in them. The end of the link is parsed as a hashtag\r\n\r\n![image](https://github.com/mastodon/mastodon/assets/4095570/22494cbe-375b-4c53-8f31-f7575c43fd66)\r\n\n\n### Mastodon instance\n\nmastodon.scot\n\n### Mastodon version\n\nv4.2.0\n\n### Browser name and version\n\nFirefox 118.0\n\n### Operating system\n\nLinux Mint\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/home_timeline/components/inline_follow_suggestions.jsx\n@@ -129,8 +129,13 @@ export const InlineFollowSuggestions = ({ hidden }) => {\n       return;\n     }\n \n-    setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n-    setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    if (getComputedStyle(bodyRef.current).direction === 'rtl') {\n+      setCanScrollLeft((bodyRef.current.clientWidth - bodyRef.current.scrollLeft) < bodyRef.current.scrollWidth);\n+      setCanScrollRight(bodyRef.current.scrollLeft < 0);\n+    } else {\n+      setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n+      setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    }\n   }, [setCanScrollRight, setCanScrollLeft, bodyRef, suggestions]);\n \n   const handleLeftNav = useCallback(() => {\n---\n\n\n---\n\nChoice B:\nGemfile.lock\n@@ -382,15 +382,15 @@ GEM\n       reline (>= 0.3.8)\n     jmespath (1.6.2)\n     json (2.7.0)\n-    json-canonicalization (0.3.2)\n+    json-canonicalization (1.0.0)\n     json-jwt (1.15.3)\n       activesupport (>= 4.2)\n       aes_key_wrap\n       bindata\n       httpclient\n-    json-ld (3.3.0)\n+    json-ld (3.3.1)\n       htmlentities (~> 4.3)\n-      json-canonicalization (~> 0.3, >= 0.3.2)\n+      json-canonicalization (~> 1.0)\n       link_header (~> 0.0, >= 0.0.8)\n       multi_json (~> 1.15)\n       rack (>= 2.2, < 4)\n---\n\n\n---\n\nChoice C:\nspec/rails_helper.rb\n@@ -37,11 +37,14 @@\n \n require 'spec_helper'\n require 'rspec/rails'\n+require 'rspec-sidekiq'\n require 'webmock/rspec'\n require 'paperclip/matchers'\n require 'capybara/rspec'\n require 'chewy/rspec'\n+require 'email_spec'\n require 'email_spec/rspec'\n+require 'database_cleaner/active_record'\n require 'test_prof/recipes/rspec/before_all'\n \n Dir[Rails.root.join('spec', 'support', '**', '*.rb')].each { |f| require f }\n---\n\n\n---\n\nChoice D:\napp/models/tag.rb\n@@ -35,7 +35,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?:^|[^/)\\w])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)[:word]])#(#{HASHTAG_NAME_PAT})}i\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/tag_spec.rb\n@@ -32,52 +32,56 @@\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)#Lawsuit')).to be_nil\n     end\n \n+    it 'does not match URLs with hashtag-like anchors after an empty query parameter' do\n+      expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)?foo=#Lawsuit')).to be_nil\n+    end\n+\n     it 'matches \ufeff#\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43' do\n-      expect(subject.match('\ufeffthis is #\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43').to_s).to eq ' #\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43'\n+      expect(subject.match('\ufeffthis is #\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43').to_s).to eq '#\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43'\n     end\n \n     it 'matches digits at the start' do\n-      expect(subject.match('hello #3d').to_s).to eq ' #3d'\n+      expect(subject.match('hello #3d').to_s).to eq '#3d'\n     end\n \n     it 'matches digits in the middle' do\n-      expect(subject.match('hello #l33ts35k').to_s).to eq ' #l33ts35k'\n+      expect(subject.match('hello #l33ts35k').to_s).to eq '#l33ts35k'\n     end\n \n     it 'matches digits at the end' do\n-      expect(subject.match('hello #world2016').to_s).to eq ' #world2016'\n+      expect(subject.match('hello #world2016').to_s).to eq '#world2016'\n     end\n \n     it 'matches underscores at the beginning' do\n-      expect(subject.match('hello #_test').to_s).to eq ' #_test'\n+      expect(subject.match('hello #_test').to_s).to eq '#_test'\n     end\n \n     it 'matches underscores at the end' do\n-      expect(subject.match('hello #test_').to_s).to eq ' #test_'\n+      expect(subject.match('hello #test_').to_s).to eq '#test_'\n     end\n \n     it 'matches underscores in the middle' do\n-      expect(subject.match('hello #one_two_three').to_s).to eq ' #one_two_three'\n+      expect(subject.match('hello #one_two_three').to_s).to eq '#one_two_three'\n     end\n \n     it 'matches middle dots' do\n-      expect(subject.match('hello #one\u00b7two\u00b7three').to_s).to eq ' #one\u00b7two\u00b7three'\n+      expect(subject.match('hello #one\u00b7two\u00b7three').to_s).to eq '#one\u00b7two\u00b7three'\n     end\n \n     it 'matches \u30fbunicode in \u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f correctly' do\n-      expect(subject.match('testing #\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f').to_s).to eq ' #\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f'\n+      expect(subject.match('testing #\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f').to_s).to eq '#\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f'\n     end\n \n     it 'matches ZWNJ' do\n-      expect(subject.match('just add #\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631 and').to_s).to eq ' #\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631'\n+      expect(subject.match('just add #\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631 and').to_s).to eq '#\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631'\n     end\n \n     it 'does not match middle dots at the start' do\n       expect(subject.match('hello #\u00b7one\u00b7two\u00b7three')).to be_nil\n     end\n \n     it 'does not match middle dots at the end' do\n-      expect(subject.match('hello #one\u00b7two\u00b7three\u00b7').to_s).to eq ' #one\u00b7two\u00b7three'\n+      expect(subject.match('hello #one\u00b7two\u00b7three\u00b7').to_s).to eq '#one\u00b7two\u00b7three'\n     end\n \n     it 'does not match purely-numeric hashtags' do\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Open `/admin/dashboard`\r\n2. View retention chart\r\n3. Notice August is missing (it\u2019s September currently)\r\n\r\n![IMG_0792](https://github.com/mastodon/mastodon/assets/3002053/055f91c9-6b98-4288-8510-7b913d6e0159)\r\n\r\nBut after changing device timezone to UTC (server is also UTC) \r\n\r\n![IMG_0793](https://github.com/mastodon/mastodon/assets/3002053/d74cfec1-8a3f-4e15-a6fb-958e144101ce)\r\n\r\nAugust appears!\n\n### Expected behaviour\n\nAll months appear\n\n### Actual behaviour\n\nNo latest month\n\n### Detailed description\n\nReproduced by multiple folks in UTC -x time zones, in #server-admin Discord.\n\n### Mastodon instance\n\nvmst.io\n\n### Mastodon version\n\nv4.2.0\n\n### Browser name and version\n\nAny\n\n### Operating system\n\nAny\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/components/admin/Retention.jsx\n@@ -9,11 +9,12 @@ import api from 'mastodon/api';\n import { roundTo10 } from 'mastodon/utils/numbers';\n \n const dateForCohort = cohort => {\n+  const timeZone = 'UTC';\n   switch(cohort.frequency) {\n   case 'day':\n-    return <FormattedDate value={cohort.period} month='long' day='2-digit' />;\n+    return <FormattedDate value={cohort.period} month='long' day='2-digit' timeZone={timeZone} />;\n   default:\n-    return <FormattedDate value={cohort.period} month='long' year='numeric' />;\n+    return <FormattedDate value={cohort.period} month='long' year='numeric' timeZone={timeZone} />;\n   }\n };\n \n---\n\n\n---\n\nChoice B:\napp/mailers/application_mailer.rb\n@@ -12,7 +12,7 @@ class ApplicationMailer < ActionMailer::Base\n   protected\n \n   def locale_for_account(account, &block)\n-    I18n.with_locale(account.user_locale || I18n.locale || I18n.default_locale, &block)\n+    I18n.with_locale(account.user_locale || I18n.default_locale, &block)\n   end\n \n   def set_autoreply_headers!\n---\napp/mailers/user_mailer.rb\n@@ -33,7 +33,7 @@ def reset_password_instructions(user, token, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -43,7 +43,7 @@ def password_change(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -53,7 +53,7 @@ def email_changed(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -63,7 +63,7 @@ def two_factor_enabled(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -73,7 +73,7 @@ def two_factor_disabled(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -83,7 +83,7 @@ def two_factor_recovery_codes_changed(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -93,7 +93,7 @@ def webauthn_enabled(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -103,7 +103,7 @@ def webauthn_disabled(user, *, **)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: default_devise_subject\n     end\n   end\n@@ -114,7 +114,7 @@ def webauthn_credential_added(user, webauthn_credential)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: I18n.t('devise.mailer.webauthn_credential.added.subject')\n     end\n   end\n@@ -125,7 +125,7 @@ def webauthn_credential_deleted(user, webauthn_credential)\n \n     return unless @resource.active_for_authentication?\n \n-    I18n.with_locale(locale) do\n+    I18n.with_locale(locale(use_current_locale: true)) do\n       mail subject: I18n.t('devise.mailer.webauthn_credential.deleted.subject')\n     end\n   end\n@@ -219,7 +219,7 @@ def set_instance\n     @instance = Rails.configuration.x.local_domain\n   end\n \n-  def locale\n-    @resource.locale.presence || I18n.locale || I18n.default_locale\n+  def locale(use_current_locale: false)\n+    @resource.locale.presence || (use_current_locale && I18n.locale) || I18n.default_locale\n   end\n end\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/compose/components/compose_form.jsx\n@@ -216,7 +216,7 @@ class ComposeForm extends ImmutablePureComponent {\n \n   handleEmojiPick = (data) => {\n     const { text }     = this.props;\n-    const position     = this.textarea.selectionStart;\n+    const position     = this.textareaRef.current.selectionStart;\n     const needsSpace   = data.custom && position > 0 && !allowedAroundShortCode.includes(text[position - 1]);\n \n     this.props.onPickEmoji(position, data, needsSpace);\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -159,8 +159,8 @@\n .error-modal,\n .onboarding-modal,\n .compare-history-modal,\n-.report-modal__comment .setting-text__wrapper,\n-.report-modal__comment .setting-text,\n+.report-modal__comment,\n+.report-modal__comment,\n .announcements,\n .picture-in-picture__header,\n .picture-in-picture__footer,\n@@ -169,6 +169,11 @@\n   border: 1px solid var(--background-border-color);\n }\n \n+.setting-text__wrapper,\n+.setting-text {\n+  border: 1px solid var(--background-border-color);\n+}\n+\n .reactions-bar__item:hover,\n .reactions-bar__item:focus,\n .reactions-bar__item:active {\n@@ -198,14 +203,6 @@\n   color: $white;\n }\n \n-.report-modal__comment {\n-  border-right-color: lighten($ui-base-color, 8%);\n-}\n-\n-.report-modal__container {\n-  border-top-color: lighten($ui-base-color, 8%);\n-}\n-\n .column-settings__hashtags .column-select__option {\n   color: $white;\n }\n---\napp/javascript/styles/mastodon/components.scss\n@@ -3911,7 +3911,7 @@ $ui-header-logo-wordmark-width: 99px;\n \n   &__wrapper {\n     background: $white;\n-    border: 1px solid $ui-secondary-color;\n+    border: 1px solid var(--background-border-color);\n     margin-bottom: 10px;\n     border-radius: 4px;\n \n@@ -6298,9 +6298,10 @@ a.status-card {\n .report-modal,\n .actions-modal,\n .compare-history-modal {\n-  background: lighten($ui-secondary-color, 8%);\n-  color: $inverted-text-color;\n-  border-radius: 8px;\n+  background: var(--background-color);\n+  color: $primary-text-color;\n+  border-radius: 4px;\n+  border: 1px solid var(--background-border-color);\n   overflow: hidden;\n   max-width: 90vw;\n   width: 480px;\n@@ -6344,6 +6345,7 @@ a.status-card {\n .report-modal {\n   width: 90vw;\n   max-width: 700px;\n+  border: 1px solid var(--background-border-color);\n }\n \n .report-dialog-modal {\n@@ -6567,7 +6569,7 @@ a.status-card {\n \n .report-modal__container {\n   display: flex;\n-  border-top: 1px solid $ui-secondary-color;\n+  border-top: 1px solid var(--background-border-color);\n \n   @media screen and (width <= 480px) {\n     flex-wrap: wrap;\n@@ -6625,7 +6627,7 @@ a.status-card {\n \n .report-modal__comment {\n   padding: 20px;\n-  border-inline-end: 1px solid $ui-secondary-color;\n+  border-inline-end: 1px solid var(--background-border-color);\n   max-width: 320px;\n \n   p {\n@@ -6636,7 +6638,7 @@ a.status-card {\n \n   .setting-text-label {\n     display: block;\n-    color: $inverted-text-color;\n+    color: $secondary-text-color;\n     font-size: 14px;\n     font-weight: 500;\n     margin-bottom: 10px;\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Via the admin account moderation tools, disable a users' 2FA (you can test this on an account by setting `otp_required_for_login` to true without actually setting up 2FA)\r\n2. Go to the audit log, observe that an entry was created \"ACTOR disabled two factor requirement for user USER\"\r\n3. From the \"filter by action\" drop down, select \"disable 2fa\"\r\n\r\n\n\n### Expected behaviour\n\nThe audit log entry for disabling 2fa should be show\n\n### Actual behaviour\n\nThe audit log entry for disabling 2fa is not shown\n\n### Detailed description\n\nI saw this via a subtle change in #24103, which was closed, but the bug that was fixed was never fixed in main.\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\nmain\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\ndb/migrate/20180812173710_copy_status_stats.rb\n@@ -45,7 +45,7 @@ def up_slow\n     # We cannot use bulk INSERT or overarching transactions here because of possible\n     # uniqueness violations that we need to skip over\n     Status.unscoped.select('id, reblogs_count, favourites_count, created_at, updated_at').find_each do |status|\n-      params = [[nil, status.id], [nil, status.reblogs_count], [nil, status.favourites_count], [nil, status.created_at], [nil, status.updated_at]]\n+      params = [status.id, status.reblogs_count, status.favourites_count, status.created_at, status.updated_at]\n       exec_insert('INSERT INTO status_stats (status_id, reblogs_count, favourites_count, created_at, updated_at) VALUES ($1, $2, $3, $4, $5)', nil, params)\n     rescue ActiveRecord::RecordNotUnique\n       next\n---\ndb/migrate/20181116173541_copy_account_stats.rb\n@@ -45,7 +45,7 @@ def up_slow\n     # We cannot use bulk INSERT or overarching transactions here because of possible\n     # uniqueness violations that we need to skip over\n     Account.unscoped.select('id, statuses_count, following_count, followers_count, created_at, updated_at').find_each do |account|\n-      params = [[nil, account.id], [nil, account[:statuses_count]], [nil, account[:following_count]], [nil, account[:followers_count]], [nil, account.created_at], [nil, account.updated_at]]\n+      params = [account.id, account[:statuses_count], account[:following_count], account[:followers_count], account.created_at, account.updated_at]\n       exec_insert('INSERT INTO account_stats (account_id, statuses_count, following_count, followers_count, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6)', nil, params)\n     rescue ActiveRecord::RecordNotUnique\n       next\n---\nlib/mastodon/cli/statuses.rb\n@@ -61,7 +61,7 @@ def remove_statuses\n         # Skip accounts followed by local accounts\n         clean_followed_sql = 'AND NOT EXISTS (SELECT 1 FROM follows WHERE statuses.account_id = follows.target_account_id)' unless options[:clean_followed]\n \n-        ActiveRecord::Base.connection.exec_insert(<<-SQL.squish, 'SQL', [[nil, max_id]])\n+        ActiveRecord::Base.connection.exec_insert(<<-SQL.squish, 'SQL', [max_id])\n           INSERT INTO statuses_to_be_deleted (id)\n           SELECT statuses.id FROM statuses WHERE deleted_at IS NULL AND NOT local AND uri IS NOT NULL AND (id < $1)\n           AND NOT EXISTS (SELECT 1 FROM statuses AS statuses1 WHERE statuses.id = statuses1.in_reply_to_id)\n---\n\n\n---\n\nChoice B:\nbabel.config.js\n@@ -52,6 +52,10 @@ module.exports = (api) => {\n   case 'development':\n     reactOptions.development = true;\n     envOptions.debug = true;\n+\n+    // We need Babel to not inject polyfills in dev, as this breaks `preval` files\n+    envOptions.useBuiltIns = false;\n+    envOptions.corejs = undefined;\n     break;\n   }\n \n---\n\n\n---\n\nChoice C:\napp/models/follow_recommendation.rb\n@@ -18,5 +18,6 @@ class FollowRecommendation < ApplicationRecord\n   belongs_to :account_summary, foreign_key: :account_id, inverse_of: false\n   belongs_to :account\n \n-  scope :localized, ->(locale) { joins(:account_summary).merge(AccountSummary.localized(locale)) }\n+  scope :unsupressed, -> { where.not(FollowRecommendationSuppression.where(FollowRecommendationSuppression.arel_table[:account_id].eq(arel_table[:account_id])).select(1).arel.exists) }\n+  scope :localized, ->(locale) { unsupressed.joins(:account_summary).merge(AccountSummary.localized(locale)) }\n end\n---\n\n\n---\n\nChoice D:\napp/models/admin/action_log_filter.rb\n@@ -38,7 +38,7 @@ class Admin::ActionLogFilter\n     destroy_status: { target_type: 'Status', action: 'destroy' }.freeze,\n     destroy_user_role: { target_type: 'UserRole', action: 'destroy' }.freeze,\n     destroy_canonical_email_block: { target_type: 'CanonicalEmailBlock', action: 'destroy' }.freeze,\n-    disable_2fa_user: { target_type: 'User', action: 'disable' }.freeze,\n+    disable_2fa_user: { target_type: 'User', action: 'disable_2fa' }.freeze,\n     disable_custom_emoji: { target_type: 'CustomEmoji', action: 'disable' }.freeze,\n     disable_user: { target_type: 'User', action: 'disable' }.freeze,\n     enable_custom_emoji: { target_type: 'CustomEmoji', action: 'enable' }.freeze,\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Open https://mastodon.social/@marcoarment in a web browser.\r\n2. Click on the [@atpfm](https://mastodon.social/@atpfm) link or the [@overcastfm](https://mastodon.social/@overcastfm) link.\n\n### Expected behaviour\n\nThe link is opened\n\n### Actual behaviour\n\nNothing\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.2.0\n\n### Browser name and version\n\nGoogle Chrome 117\n\n### Operating system\n\nmacOS 13.6\n\n### Technical details\n\nThe links have a `click` handler `handleMentionClick`.\r\n\r\nhttps://github.com/mastodon/mastodon/blob/57f592fed50747f3c97718a2761e17bafe6c8698/app/javascript/mastodon/features/account/components/header.jsx#L185\n\n---\n\nChoice A:\napp/controllers/concerns/web_app_controller_concern.rb\n@@ -11,7 +11,7 @@ module WebAppControllerConcern\n   end\n \n   def skip_csrf_meta_tags?\n-    !(ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1) && current_user.nil?\n+    !(ENV['ONE_CLICK_SSO_LOGIN'] == 'true' && ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1) && current_user.nil?\n   end\n \n   def set_app_body_class\n---\napp/serializers/initial_state_serializer.rb\n@@ -113,6 +113,6 @@ def instance_presenter\n   end\n \n   def sso_redirect\n-    \"/auth/auth/#{Devise.omniauth_providers[0]}\" if ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1\n+    \"/auth/auth/#{Devise.omniauth_providers[0]}\" if ENV['ONE_CLICK_SSO_LOGIN'] == 'true' && ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1\n   end\n end\n---\nconfig/initializers/content_security_policy.rb\n@@ -19,6 +19,22 @@ def host_to_url(str)\n media_host ||= host_to_url(ENV['S3_HOSTNAME']) if ENV['S3_ENABLED'] == 'true'\n media_host ||= assets_host\n \n+def sso_host\n+  return unless ENV['ONE_CLICK_SSO_LOGIN'] == 'true'\n+  return unless ENV['OMNIAUTH_ONLY'] == 'true'\n+  return unless Devise.omniauth_providers.length == 1\n+\n+  provider = Devise.omniauth_configs[Devise.omniauth_providers[0]]\n+  @sso_host ||= begin\n+    # using CAS\n+    provider.cas_url if ENV['CAS_ENABLED'] == 'true'\n+    # using SAML\n+    provider.options[:idp_sso_target_url] if ENV['SAML_ENABLED'] == 'true'\n+    # or using OIDC\n+    ENV['OIDC_AUTH_ENDPOINT'] || (OpenIDConnect::Discovery::Provider::Config.discover!(ENV['OIDC_ISSUER']).authorization_endpoint if ENV['OIDC_ENABLED'] == 'true')\n+  end\n+end\n+\n Rails.application.config.content_security_policy do |p|\n   p.base_uri        :none\n   p.default_src     :none\n@@ -29,7 +45,13 @@ def host_to_url(str)\n   p.media_src       :self, :https, :data, assets_host\n   p.frame_src       :self, :https\n   p.manifest_src    :self, assets_host\n-  p.form_action     :self\n+\n+  if sso_host.present?\n+    p.form_action     :self, sso_host\n+  else\n+    p.form_action     :self\n+  end\n+\n   p.child_src       :self, :blob, assets_host\n   p.worker_src      :self, :blob, assets_host\n \n---\n\n\n---\n\nChoice B:\napp/lib/feed_manager.rb\n@@ -558,7 +558,7 @@ def build_crutches(receiver_id, statuses)\n       arr = crutches[:active_mentions][s.id] || []\n       arr.push(s.account_id)\n \n-      if s.reblog?\n+      if s.reblog? && s.reblog.present?\n         arr.push(s.reblog.account_id)\n         arr.concat(crutches[:active_mentions][s.reblog_of_id] || [])\n       end\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/actions/search.js\n@@ -147,6 +147,10 @@ export const openURL = (value, history, onFailure) => (dispatch, getState) => {\n   const signedIn = !!getState().getIn(['meta', 'me']);\n \n   if (!signedIn) {\n+    if (onFailure) {\n+      onFailure();\n+    }\n+\n     return;\n   }\n \n---\n\n\n---\n\nChoice D:\napp/lib/translation_service/deepl.rb\n@@ -46,7 +46,7 @@ def transform_response(str)\n \n     raise UnexpectedResponseError unless json.is_a?(Hash)\n \n-    Translation.new(text: json.dig('translations', 0, 'text'), detected_source_language: json.dig('translations', 0, 'detected_source_language')&.downcase, provider: 'DeepL.com')\n+    Translation.new(text: Sanitize.fragment(json.dig('translations', 0, 'text'), Sanitize::Config::MASTODON_STRICT), detected_source_language: json.dig('translations', 0, 'detected_source_language')&.downcase, provider: 'DeepL.com')\n   rescue Oj::ParseError\n     raise UnexpectedResponseError\n   end\n---\napp/lib/translation_service/libre_translate.rb\n@@ -37,7 +37,7 @@ def transform_response(str, source_language)\n \n     raise UnexpectedResponseError unless json.is_a?(Hash)\n \n-    Translation.new(text: json['translatedText'], detected_source_language: source_language, provider: 'LibreTranslate')\n+    Translation.new(text: Sanitize.fragment(json['translatedText'], Sanitize::Config::MASTODON_STRICT), detected_source_language: source_language, provider: 'LibreTranslate')\n   rescue Oj::ParseError\n     raise UnexpectedResponseError\n   end\n---\napp/services/translate_status_service.rb\n@@ -12,8 +12,8 @@ def call(status, target_language)\n     @content = status_content_format(@status)\n     @target_language = target_language\n \n-    Rails.cache.fetch(\"translations/#{@status.language}/#{@target_language}/#{content_hash}\", expires_in: CACHE_TTL) do\n-      Sanitize.fragment(translation_backend.translate(@content, @status.language, @target_language), Sanitize::Config::MASTODON_STRICT)\n+    Rails.cache.fetch(\"translations:v2/#{@status.language}/#{@target_language}/#{content_hash}\", expires_in: CACHE_TTL) do\n+      translation_backend.translate(@content, @status.language, @target_language)\n     end\n   end\n \n---\napp/lib/translation_service/deepl.rb\n@@ -46,7 +46,7 @@ def transform_response(str)\n \n     raise UnexpectedResponseError unless json.is_a?(Hash)\n \n-    Translation.new(text: json.dig('translations', 0, 'text'), detected_source_language: json.dig('translations', 0, 'detected_source_language')&.downcase, provider: 'DeepL.com')\n+    Translation.new(text: Sanitize.fragment(json.dig('translations', 0, 'text'), Sanitize::Config::MASTODON_STRICT), detected_source_language: json.dig('translations', 0, 'detected_source_language')&.downcase, provider: 'DeepL.com')\n   rescue Oj::ParseError\n     raise UnexpectedResponseError\n   end\n---\napp/lib/translation_service/libre_translate.rb\n@@ -37,7 +37,7 @@ def transform_response(str, source_language)\n \n     raise UnexpectedResponseError unless json.is_a?(Hash)\n \n-    Translation.new(text: json['translatedText'], detected_source_language: source_language, provider: 'LibreTranslate')\n+    Translation.new(text: Sanitize.fragment(json['translatedText'], Sanitize::Config::MASTODON_STRICT), detected_source_language: source_language, provider: 'LibreTranslate')\n   rescue Oj::ParseError\n     raise UnexpectedResponseError\n   end\n---\napp/services/translate_status_service.rb\n@@ -12,8 +12,8 @@ def call(status, target_language)\n     @content = status_content_format(@status)\n     @target_language = target_language\n \n-    Rails.cache.fetch(\"translations/#{@status.language}/#{@target_language}/#{content_hash}\", expires_in: CACHE_TTL) do\n-      Sanitize.fragment(translation_backend.translate(@content, @status.language, @target_language), Sanitize::Config::MASTODON_STRICT)\n+    Rails.cache.fetch(\"translations:v2/#{@status.language}/#{@target_language}/#{content_hash}\", expires_in: CACHE_TTL) do\n+      translation_backend.translate(@content, @status.language, @target_language)\n     end\n   end\n \n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Upload a GIF\n\n### Expected behaviour\n\nSee a GIF \n\n### Actual behaviour\n\nGet a 500 error\n\n### Detailed description\n\nWhen I upload a GIF I get a 500er error without any Information at the Frontend\r\n\r\n\n\n### Mastodon instance\n\nelbmatsch.de\n\n### Mastodon version\n\nv4.2.0\n\n### Browser name and version\n\nChrome\n\n### Operating system\n\nosx 14\n\n### Technical details\n\njournalctl -u mastodon-web:\r\n```\r\nINFO -- : method=POST path=/api/v2/media format=html controller=Api::V2::MediaController action=create status=500 allocations=4162 duration=120.28 view=0.00 db=1.05\r\nFATAL -- :\r\n FloatDomainError (Infinity): \r\n\r\n lib/paperclip/transcoder.rb:46:in 'floor'\r\n lib/paperclip/transcoder.rb:46:in 'make'\r\n lib/paperclip/gif_transcoder.rb:109:in 'make'\r\n lib/paperclip/attachment_extensions.rb:21:in 'block in post_process_style'\r\n lib/paperclip/attachment_extensions.rb:20:in 'each'\r\n lib/paperclip/attachment_extensions.rb:20:in 'inject'\r\n lib/paperclip/attachment_extensions.rb:20:in 'post_process_style'\r\n app/controllers/api/v2/media_controller.rb:5:in 'create'\r\n app/controllers/concerns/localized.rb:11:in 'set_locale'\r\n lib/mastodon/rack_middleware.rb:9:in 'call'\r\n```\r\n\r\nAll versions are the required according to the changelog\n\n---\n\nChoice A:\napp/models/tag.rb\n@@ -37,7 +37,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?<![=/)\\w])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}i\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]\\u0E47-\\u0E4E#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/tag_spec.rb\n@@ -36,6 +36,10 @@\n       expect(subject.match('https://gcc.gnu.org/bugzilla/show_bug.cgi?id=111895#c4')).to be_nil\n     end\n \n+    it 'does not match URLs with hashtag-like anchors after a non-ascii character' do\n+      expect(subject.match('https://example.org/test\u00e9#foo')).to be_nil\n+    end\n+\n     it 'does not match URLs with hashtag-like anchors after an empty query parameter' do\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)?foo=#Lawsuit')).to be_nil\n     end\n---\n\n\n---\n\nChoice B:\napp/services/fetch_oembed_service.rb\n@@ -100,7 +100,7 @@ def parse_for_format(body)\n   end\n \n   def validate(oembed)\n-    oembed if oembed[:version].to_s == '1.0' && oembed[:type].present?\n+    oembed if oembed.present? && oembed[:version].to_s == '1.0' && oembed[:type].present?\n   end\n \n   def html\n---\n\n\n---\n\nChoice C:\nlib/paperclip/transcoder.rb\n@@ -43,7 +43,8 @@ def make\n         unless eligible_to_passthrough?(metadata)\n           size_limit_in_bits = MediaAttachment::VIDEO_LIMIT * 8\n           desired_bitrate = (metadata.width * metadata.height * 30 * BITS_PER_PIXEL).floor\n-          maximum_bitrate = (size_limit_in_bits / metadata.duration).floor - 192_000 # Leave some space for the audio stream\n+          duration = [metadata.duration, 1].max\n+          maximum_bitrate = (size_limit_in_bits / duration).floor - 192_000 # Leave some space for the audio stream\n           bitrate = [desired_bitrate, maximum_bitrate].min\n \n           @output_options['b:v']     = bitrate\n---\n\n\n---\n\nChoice D:\napp/controllers/api/v1/suggestions_controller.rb\n@@ -4,7 +4,7 @@ class Api::V1::SuggestionsController < Api::BaseController\n   include Authorization\n   include DeprecationConcern\n \n-  deprecate_api '2021-05-16'\n+  deprecate_api '2021-05-16', only: [:index]\n \n   before_action -> { doorkeeper_authorize! :read, :'read:accounts' }, only: :index\n   before_action -> { doorkeeper_authorize! :write, :'write:accounts' }, except: :index\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Upload an image.\n\n### Expected behaviour\n\nThere should not be a modification time encoded into the file.\n\n### Actual behaviour\n\nThere is a modification time encoded into the file.\n\n### Detailed description\n\n![image](https://github.com/mastodon/mastodon/assets/4257305/60bd4925-424c-4b27-a671-a0c32dd59df5)\r\n\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\n_No response_\n\n### Technical details\n\nThis should be a simple find-and-replace to fix.\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/polls.scss\n@@ -128,6 +128,11 @@\n       border-width: 4px;\n     }\n \n+    &.active {\n+      background-color: $ui-button-focus-background-color;\n+      border-color: $ui-button-focus-background-color;\n+    }\n+\n     &::-moz-focus-inner {\n       outline: 0 !important;\n       border: 0;\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -10453,7 +10453,7 @@ noscript {\n       gap: 4px;\n \n       dt {\n-        flex: 0 0 auto;\n+        flex: 0 1 auto;\n         color: $dark-text-color;\n         min-width: 0;\n         overflow: hidden;\n---\n\n\n---\n\nChoice C:\napp/models/concerns/account_avatar.rb\n@@ -18,7 +18,7 @@ def avatar_styles(file)\n \n   included do\n     # Avatar upload\n-    has_attached_file :avatar, styles: ->(f) { avatar_styles(f) }, convert_options: { all: '+profile \"!icc,*\" +set modify-date +set create-date' }, processors: [:lazy_thumbnail]\n+    has_attached_file :avatar, styles: ->(f) { avatar_styles(f) }, convert_options: { all: '+profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' }, processors: [:lazy_thumbnail]\n     validates_attachment_content_type :avatar, content_type: IMAGE_MIME_TYPES\n     validates_attachment_size :avatar, less_than: LIMIT\n     remotable_attachment :avatar, LIMIT, suppress_errors: false\n---\napp/models/concerns/account_header.rb\n@@ -19,7 +19,7 @@ def header_styles(file)\n \n   included do\n     # Header upload\n-    has_attached_file :header, styles: ->(f) { header_styles(f) }, convert_options: { all: '+profile \"!icc,*\" +set modify-date +set create-date' }, processors: [:lazy_thumbnail]\n+    has_attached_file :header, styles: ->(f) { header_styles(f) }, convert_options: { all: '+profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' }, processors: [:lazy_thumbnail]\n     validates_attachment_content_type :header, content_type: IMAGE_MIME_TYPES\n     validates_attachment_size :header, less_than: LIMIT\n     remotable_attachment :header, LIMIT, suppress_errors: false\n---\napp/models/custom_emoji.rb\n@@ -39,7 +39,7 @@ class CustomEmoji < ApplicationRecord\n \n   has_one :local_counterpart, -> { where(domain: nil) }, class_name: 'CustomEmoji', primary_key: :shortcode, foreign_key: :shortcode, inverse_of: false\n \n-  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set modify-date +set create-date' } }, validate_media_type: false\n+  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' } }, validate_media_type: false\n \n   before_validation :downcase_domain\n \n---\napp/models/media_attachment.rb\n@@ -171,7 +171,7 @@ class MediaAttachment < ApplicationRecord\n   DEFAULT_STYLES = [:original].freeze\n \n   GLOBAL_CONVERT_OPTIONS = {\n-    all: '-quality 90 +profile \"!icc,*\" +set modify-date -define jpeg:dct-method=float +set create-date',\n+    all: '-quality 90 +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp -define jpeg:dct-method=float',\n   }.freeze\n \n   belongs_to :account,          inverse_of: :media_attachments, optional: true\n---\napp/models/preview_card.rb\n@@ -53,7 +53,7 @@ class PreviewCard < ApplicationRecord\n   has_and_belongs_to_many :statuses\n   has_one :trend, class_name: 'PreviewCardTrend', inverse_of: :preview_card, dependent: :destroy\n \n-  has_attached_file :image, processors: [:thumbnail, :blurhash_transcoder], styles: ->(f) { image_styles(f) }, convert_options: { all: '-quality 90 +profile \"!icc,*\" +set modify-date +set create-date' }, validate_media_type: false\n+  has_attached_file :image, processors: [:thumbnail, :blurhash_transcoder], styles: ->(f) { image_styles(f) }, convert_options: { all: '-quality 90 +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' }, validate_media_type: false\n \n   validates :url, presence: true, uniqueness: true\n   validates_attachment_content_type :image, content_type: IMAGE_MIME_TYPES\n---\napp/models/preview_card_provider.rb\n@@ -27,7 +27,7 @@ class PreviewCardProvider < ApplicationRecord\n \n   validates :domain, presence: true, uniqueness: true, domain: true\n \n-  has_attached_file :icon, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set modify-date +set create-date' } }, validate_media_type: false\n+  has_attached_file :icon, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' } }, validate_media_type: false\n   validates_attachment :icon, content_type: { content_type: ICON_MIME_TYPES }, size: { less_than: LIMIT }\n   remotable_attachment :icon, LIMIT\n \n---\napp/models/site_upload.rb\n@@ -41,7 +41,7 @@ class SiteUpload < ApplicationRecord\n     mascot: {}.freeze,\n   }.freeze\n \n-  has_attached_file :file, styles: ->(file) { STYLES[file.instance.var.to_sym] }, convert_options: { all: '-coalesce +profile \"!icc,*\" +set modify-date +set create-date' }, processors: [:lazy_thumbnail, :blurhash_transcoder, :type_corrector]\n+  has_attached_file :file, styles: ->(file) { STYLES[file.instance.var.to_sym] }, convert_options: { all: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' }, processors: [:lazy_thumbnail, :blurhash_transcoder, :type_corrector]\n \n   validates_attachment_content_type :file, content_type: %r{\\Aimage/.*\\z}\n   validates :file, presence: true\n---\n\n\n---\n\nChoice D:\napp/lib/video_metadata_extractor.rb\n@@ -22,7 +22,7 @@ def valid?\n   private\n \n   def ffmpeg_command_output\n-    command = Terrapin::CommandLine.new('ffprobe', '-i :path -print_format :format -show_format -show_streams -show_error -loglevel :loglevel')\n+    command = Terrapin::CommandLine.new(Rails.configuration.x.ffprobe_binary, '-i :path -print_format :format -show_format -show_streams -show_error -loglevel :loglevel')\n     command.run(path: @path, format: 'json', loglevel: 'fatal')\n   end\n \n---\nconfig/initializers/ffmpeg.rb\n@@ -1,5 +1,6 @@\n # frozen_string_literal: true\n \n-if ENV['FFMPEG_BINARY'].present?\n-  FFMPEG.ffmpeg_binary = ENV['FFMPEG_BINARY']\n+Rails.application.configure do\n+  config.x.ffmpeg_binary = ENV['FFMPEG_BINARY'] || 'ffmpeg'\n+  config.x.ffprobe_binary = ENV['FFPROBE_BINARY'] || 'ffprobe'\n end\n---\nlib/paperclip/image_extractor.rb\n@@ -35,7 +35,7 @@ def extract_image_from_file!\n       dst.binmode\n \n       begin\n-        command = Terrapin::CommandLine.new('ffmpeg', '-i :source -loglevel :loglevel -y :destination', logger: Paperclip.logger)\n+        command = Terrapin::CommandLine.new(Rails.configuration.x.ffmpeg_binary, '-i :source -loglevel :loglevel -y :destination', logger: Paperclip.logger)\n         command.run(source: @file.path, destination: dst.path, loglevel: 'fatal')\n       rescue Terrapin::ExitStatusError\n         dst.close(true)\n---\nlib/paperclip/transcoder.rb\n@@ -61,7 +61,7 @@ def make\n       command_arguments, interpolations = prepare_command(destination)\n \n       begin\n-        command = Terrapin::CommandLine.new('ffmpeg', command_arguments.join(' '), logger: Paperclip.logger)\n+        command = Terrapin::CommandLine.new(Rails.configuration.x.ffmpeg_binary, command_arguments.join(' '), logger: Paperclip.logger)\n         command.run(interpolations)\n       rescue Terrapin::ExitStatusError => e\n         raise Paperclip::Error, \"Error while transcoding #{@basename}: #{e}\"\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Click on a post in the web interface.\r\n2. Copy the URL to the clipboard.\r\n3. Paste the URL into a Slack message, text message, etc.\r\n4. The instance logo is displayed, with no hint as to the post content\r\n5. Previously, an abbreviated version of the message would be displayed\n\n### Expected behaviour\n\nThe pasted URL should display as an abbreviated version of the post at the link\n\n### Actual behaviour\n\nThe pasted URL displays the instance logo.\n\n### Detailed description\n\nBefore the upgrade, pasting the URL of a mstdn.ca post into a message (text, Slack, etc.) would display the post \u2014 an abbreviated version for a long post, the full post for a brief post. \r\n\r\nNow, after the upgrade, the pasted URL always has the same display \u2014 the instance's logo \u2014 with no information about the linked post.\r\n\r\nTwo files are attached. The first shows how pasted URLs are currently displayed (instance logo); the other shows how pasted URLs previously displayed (abbreviated message)\r\n------------\r\n<img width=\"674\" alt=\"Screenshot 2023-09-24 at 7 39 41 AM\" src=\"https://github.com/mastodon/mastodon/assets/117941733/67780791-1924-4f4b-a054-9a17bc1d41f0\">\r\n<img width=\"674\" alt=\"Screenshot 2023-09-24 at 3 00 28 AM\" src=\"https://github.com/mastodon/mastodon/assets/117941733/fb9c2bdb-16fa-4b3b-bfab-49c4e4c0c4ce\">\n\n### Mastodon instance\n\nmstdn.ca\n\n### Mastodon version\n\nv4.2.0+glitch\n\n### Browser name and version\n\nVivaldi 6.2.3105.51 (Stable channel) (arm64)  Revision\t76144063ae8137b05a189fe91dfaf1ac12ce492d\n\n### Operating system\n\nmacOS Version 13.6 (Build 22G120)\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -2612,6 +2612,7 @@ a.account__display-name {\n }\n \n $ui-header-height: 55px;\n+$ui-header-logo-wordmark-width: 99px;\n \n .ui__header {\n   display: none;\n@@ -2627,6 +2628,10 @@ $ui-header-height: 55px;\n   &__logo {\n     display: inline-flex;\n     padding: 15px;\n+    flex-grow: 1;\n+    flex-shrink: 1;\n+    overflow: hidden;\n+    container: header-logo / inline-size;\n \n     .logo {\n       height: $ui-header-height - 30px;\n@@ -2637,7 +2642,7 @@ $ui-header-height: 55px;\n       display: none;\n     }\n \n-    @media screen and (width >= 320px) {\n+    @container header-logo (min-width: #{$ui-header-logo-wordmark-width}) {\n       .logo--wordmark {\n         display: block;\n       }\n@@ -2654,6 +2659,7 @@ $ui-header-height: 55px;\n     gap: 10px;\n     padding: 0 10px;\n     overflow: hidden;\n+    flex-shrink: 0;\n \n     .button {\n       flex: 0 0 auto;\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -4398,11 +4398,6 @@ a.status-card {\n   align-items: center;\n   justify-content: center;\n \n-  @supports (display: grid) {\n-    // hack to fix Chrome <57\n-    contain: strict;\n-  }\n-\n   & > span {\n     max-width: 500px;\n   }\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/components/edited_timestamp/index.jsx\n@@ -67,7 +67,7 @@ class EditedTimestamp extends PureComponent {\n     return (\n       <DropdownMenu statusId={statusId} renderItem={this.renderItem} scrollable renderHeader={this.renderHeader} onItemClick={this.handleItemClick}>\n         <button className='dropdown-menu__text-button'>\n-          <FormattedMessage id='status.edited' defaultMessage='Edited {date}' values={{ date: intl.formatDate(timestamp, { hour12: false, month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) }} /> <Icon id='caret-down' icon={ArrowDropDownIcon} />\n+          <FormattedMessage id='status.edited' defaultMessage='Edited {date}' values={{ date: intl.formatDate(timestamp, { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) }} /> <Icon id='caret-down' icon={ArrowDropDownIcon} />\n         </button>\n       </DropdownMenu>\n     );\n---\napp/javascript/mastodon/components/relative_timestamp.tsx\n@@ -53,7 +53,6 @@ const messages = defineMessages({\n });\n \n const dateFormatOptions = {\n-  hour12: false,\n   year: 'numeric',\n   month: 'short',\n   day: '2-digit',\n---\napp/javascript/mastodon/components/status.jsx\n@@ -554,7 +554,7 @@ class Status extends ImmutablePureComponent {\n             <div onClick={this.handleClick} className='status__info'>\n               <a href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} className='status__relative-time' target='_blank' rel='noopener noreferrer'>\n                 <span className='status__visibility-icon'><VisibilityIcon visibility={status.get('visibility')} /></span>\n-                <RelativeTimestamp timestamp={status.get('created_at')} />{status.get('edited_at') && <abbr title={intl.formatMessage(messages.edited, { date: intl.formatDate(status.get('edited_at'), { hour12: false, year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) })}> *</abbr>}\n+                <RelativeTimestamp timestamp={status.get('created_at')} />{status.get('edited_at') && <abbr title={intl.formatMessage(messages.edited, { date: intl.formatDate(status.get('edited_at'), { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit' }) })}> *</abbr>}\n               </a>\n \n               <a onClick={this.handleAccountClick} href={`/@${status.getIn(['account', 'acct'])}`} title={status.getIn(['account', 'acct'])} className='status__display-name' target='_blank' rel='noopener noreferrer'>\n---\napp/javascript/mastodon/features/account/components/header.jsx\n@@ -101,7 +101,6 @@ const dateFormatOptions = {\n   month: 'short',\n   day: 'numeric',\n   year: 'numeric',\n-  hour12: false,\n   hour: '2-digit',\n   minute: '2-digit',\n };\n---\napp/javascript/mastodon/features/getting_started/components/announcements.jsx\n@@ -343,7 +343,7 @@ class Announcement extends ImmutablePureComponent {\n       <div className='announcements__item'>\n         <strong className='announcements__item__range'>\n           <FormattedMessage id='announcement.announcement' defaultMessage='Announcement' />\n-          {hasTimeRange && <span> \u00b7 <FormattedDate value={startsAt} hour12={false} year={(skipYear || startsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month='short' day='2-digit' hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /> - <FormattedDate value={endsAt} hour12={false} year={(skipYear || endsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month={skipEndDate ? undefined : 'short'} day={skipEndDate ? undefined : '2-digit'} hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /></span>}\n+          {hasTimeRange && <span> \u00b7 <FormattedDate value={startsAt} year={(skipYear || startsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month='short' day='2-digit' hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /> - <FormattedDate value={endsAt} year={(skipYear || endsAt.getFullYear() === now.getFullYear()) ? undefined : 'numeric'} month={skipEndDate ? undefined : 'short'} day={skipEndDate ? undefined : '2-digit'} hour={skipTime ? undefined : '2-digit'} minute={skipTime ? undefined : '2-digit'} /></span>}\n         </strong>\n \n         <Content announcement={announcement} />\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -311,7 +311,7 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n-              <FormattedDate value={new Date(status.get('created_at'))} hour12={false} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n+              <FormattedDate value={new Date(status.get('created_at'))} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n             </a>{edited}{visibilityLink}{applicationLink}{reblogLink} \u00b7 {favouriteLink}\n           </div>\n         </div>\n---\napp/javascript/packs/public.jsx\n@@ -65,7 +65,6 @@ function loaded() {\n \n   const timeFormat = new Intl.DateTimeFormat(locale, {\n     timeStyle: 'short',\n-    hour12: false,\n   });\n \n   const formatMessage = ({ id, defaultMessage }, values) => {\n---\n\n\n---\n\nChoice D:\napp/lib/permalink_redirector.rb\n@@ -14,6 +14,8 @@ def redirect_path\n       find_account_url_by_name(first_segment)\n     elsif accounts_request? && record_integer_id_request?\n       find_account_url_by_id(second_segment)\n+    elsif @path.start_with?('/deck')\n+      @path.delete_prefix('/deck')\n     end\n   end\n \n@@ -52,7 +54,7 @@ def second_segment\n   end\n \n   def path_segments\n-    @path_segments ||= @path.delete_prefix('/').split('/')\n+    @path_segments ||= @path.delete_prefix('/deck').delete_prefix('/').split('/')\n   end\n \n   def find_status_url_by_id(id)\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Create more than one List\r\n2. Enable \"Hide these posts from home\" on one list, and disable it on another.\r\n3. Open one of the lists and open the Settings panel at the top of the page.\r\n4. Leaving the Settings panel open, click on the second list.\r\n\n\n### Expected behaviour\n\nThe \"Hide these posts from home\" should change to reflect the currently selected list.\n\n### Actual behaviour\n\n\"Hide these posts from home\" does not change to reflect the state of the currently selected list.\n\n### Detailed description\n\nWhen selecting a different list to view, the list title, contents, and other settings such as \"Show replies to:\" are updated to show the settings for the newly selected list, but \"Hide these posts from home\" does not update when switching lists.\r\n\r\nClosing and re-opening the Settings panel will refresh the display, and the \"Hide these posts from home\" setting will correctly reflect the setting for the current list.\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.2.0\n\n### Browser name and version\n\nFirefox 117.0.1\n\n### Operating system\n\nWindows 10\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/helpers/application_helper.rb\n@@ -240,11 +240,16 @@ def prerender_custom_emojis(html, custom_emojis, other_options = {})\n     EmojiFormatter.new(html, custom_emojis, other_options.merge(animate: prefers_autoplay?)).to_s\n   end\n \n-  def site_icon_path(type, size = '48')\n-    icon = SiteUpload.find_by(var: type)\n-    return nil unless icon\n+  def instance_presenter\n+    @instance_presenter ||= InstancePresenter.new\n+  end\n+\n+  def favicon_path(size = '48')\n+    instance_presenter.favicon&.file&.url(size)\n+  end\n \n-    icon.file.url(size)\n+  def app_icon_path(size = '48')\n+    instance_presenter.app_icon&.file&.url(size)\n   end\n \n   private\n---\napp/presenters/instance_presenter.rb\n@@ -81,4 +81,16 @@ def thumbnail\n   def mascot\n     @mascot ||= Rails.cache.fetch('site_uploads/mascot') { SiteUpload.find_by(var: 'mascot') }\n   end\n+\n+  def favicon\n+    return @favicon if defined?(@favicon)\n+\n+    @favicon ||= Rails.cache.fetch('site_uploads/favicon') { SiteUpload.find_by(var: 'favicon') }\n+  end\n+\n+  def app_icon\n+    return @app_icon if defined?(@app_icon)\n+\n+    @app_icon ||= Rails.cache.fetch('site_uploads/app_icon') { SiteUpload.find_by(var: 'app_icon') }\n+  end\n end\n---\napp/serializers/manifest_serializer.rb\n@@ -27,7 +27,7 @@ def short_name\n \n   def icons\n     SiteUpload::ANDROID_ICON_SIZES.map do |size|\n-      src = site_icon_path('app_icon', size.to_i)\n+      src = app_icon_path(size.to_i)\n       src = URI.join(root_url, src).to_s if src.present?\n \n       {\n---\napp/views/layouts/application.html.haml\n@@ -11,13 +11,13 @@\n     - if storage_host?\n       %link{ rel: 'dns-prefetch', href: storage_host }/\n \n-    %link{ rel: 'icon', href: site_icon_path('favicon', 'ico') || '/favicon.ico', type: 'image/x-icon' }/\n+    %link{ rel: 'icon', href: favicon_path('ico') || '/favicon.ico', type: 'image/x-icon' }/\n \n     - SiteUpload::FAVICON_SIZES.each do |size|\n-      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: site_icon_path('favicon', size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n+      %link{ rel: 'icon', sizes: \"#{size}x#{size}\", href: favicon_path(size.to_i) || frontend_asset_path(\"icons/favicon-#{size}x#{size}.png\"), type: 'image/png' }/\n \n     - SiteUpload::APPLE_ICON_SIZES.each do |size|\n-      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: site_icon_path('app_icon', size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n+      %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: app_icon_path(size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n \n     %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n     %link{ rel: 'manifest', href: manifest_path(format: :json) }/\n---\nspec/helpers/application_helper_spec.rb\n@@ -286,26 +286,31 @@ def current_theme = 'default'\n     end\n   end\n \n-  describe '#site_icon_path' do\n+  describe 'favicon' do\n     context 'when an icon exists' do\n       let!(:favicon) { Fabricate(:site_upload, var: 'favicon') }\n+      let!(:app_icon) { Fabricate(:site_upload, var: 'app_icon') }\n \n       it 'returns the URL of the icon' do\n-        expect(helper.site_icon_path('favicon')).to eq(favicon.file.url('48'))\n+        expect(helper.favicon_path).to eq(favicon.file.url('48'))\n+        expect(helper.app_icon_path).to eq(app_icon.file.url('48'))\n       end\n \n       it 'returns the URL of the icon with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to eq(favicon.file.url('16'))\n+        expect(helper.favicon_path(16)).to eq(favicon.file.url('16'))\n+        expect(helper.app_icon_path(16)).to eq(app_icon.file.url('16'))\n       end\n     end\n \n     context 'when an icon does not exist' do\n       it 'returns nil' do\n-        expect(helper.site_icon_path('favicon')).to be_nil\n+        expect(helper.favicon_path).to be_nil\n+        expect(helper.app_icon_path).to be_nil\n       end\n \n       it 'returns nil with size parameter' do\n-        expect(helper.site_icon_path('favicon', 16)).to be_nil\n+        expect(helper.favicon_path(16)).to be_nil\n+        expect(helper.app_icon_path(16)).to be_nil\n       end\n     end\n   end\n---\n\n\n---\n\nChoice B:\napp/helpers/languages_helper.rb\n@@ -194,7 +194,10 @@ module LanguagesHelper\n     jbo: ['Lojban', 'la .lojban.'].freeze,\n     kab: ['Kabyle', 'Taqbaylit'].freeze,\n     ldn: ['L\u00e1adan', 'L\u00e1adan'].freeze,\n+    ltg: ['Latgalian', 'latgal\u012b\u0161u'].freeze,\n     lfn: ['Lingua Franca Nova', 'lingua franca nova'].freeze,\n+    prg: ['Prussian', 'pr\u016bsiskai'].freeze,\n+    sgs: ['Samogitian', '\u017eemaitiu'].freeze,\n     sco: ['Scots', 'Scots'].freeze,\n     sma: ['Southern Sami', '\u00c5arjelsaemien G\u00efele'].freeze,\n     smj: ['Lule Sami', 'Julevs\u00e1megiella'].freeze,\n---\n\n\n---\n\nChoice C:\ndocker-compose.yml\n@@ -2,7 +2,7 @@ version: '3'\n services:\n   db:\n     restart: always\n-    image: postgres:14-alpine\n+    image: postgres:15-alpine\n     shm_size: 256mb\n     networks:\n       - internal_network\n@@ -25,7 +25,7 @@ services:\n \n   # es:\n   #   restart: always\n-  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.4\n+  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9\n   #   environment:\n   #     - \"ES_JAVA_OPTS=-Xms512m -Xmx512m -Des.enforce.bootstrap.checks=true\"\n   #     - \"xpack.license.self_generated.type=basic\"\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/list_timeline/index.jsx\n@@ -204,7 +204,7 @@ class ListTimeline extends PureComponent {\n           </div>\n \n           <div className='setting-toggle'>\n-            <Toggle id={`list-${id}-exclusive`} defaultChecked={isExclusive} onChange={this.onExclusiveToggle} />\n+            <Toggle id={`list-${id}-exclusive`} checked={isExclusive} onChange={this.onExclusiveToggle} />\n             <label htmlFor={`list-${id}-exclusive`} className='setting-toggle__label'>\n               <FormattedMessage id='lists.exclusive' defaultMessage='Hide these posts from home' />\n             </label>\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. In `Preferences` -> `Others` -> `Posting Language` drop down, set it to `\u7e41\u9ad4\u4e2d\u6587\uff08\u53f0\u7063\uff09`(`ZH-tw`)\r\n2. Go back to `Home`\r\n3. The default posting language in the compose form becomes `ZH` instead of `ZH-tw`\r\n\r\n\n\n### Expected behaviour\n\nThe default posting language should become `ZH-TW`\n\n### Actual behaviour\n\nDefault changed to `ZH`\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\ng0v.social\n\n### Mastodon version\n\nv4.2.0\n\n### Browser name and version\n\nBrave v1.58.131 Chromium: 117.0.5938.92 (arm64)\n\n### Operating system\n\nMacOS 13.5.2\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\nlib/paperclip/response_with_limit_adapter.rb\n@@ -16,7 +16,7 @@ def initialize(target, options = {})\n     private\n \n     def cache_current_values\n-      @original_filename = filename_from_content_disposition.presence || filename_from_path.presence || 'data'\n+      @original_filename = truncated_filename\n       @tempfile = copy_to_tempfile(@target)\n       @content_type = ContentTypeDetector.new(@tempfile.path).detect\n       @size = File.size(@tempfile)\n@@ -43,6 +43,13 @@ def copy_to_tempfile(source)\n       source.response.connection.close\n     end\n \n+    def truncated_filename\n+      filename = filename_from_content_disposition.presence || filename_from_path.presence || 'data'\n+      extension = File.extname(filename)\n+      basename = File.basename(filename, extension)\n+      [basename[...20], extension[..4]].compact_blank.join\n+    end\n+\n     def filename_from_content_disposition\n       disposition = @target.response.headers['content-disposition']\n       disposition&.match(/filename=\"([^\"]*)\"/)&.captures&.first\n---\n\n\n---\n\nChoice B:\napp/models/custom_emoji.rb\n@@ -39,7 +39,7 @@ class CustomEmoji < ApplicationRecord\n \n   has_one :local_counterpart, -> { where(domain: nil) }, class_name: 'CustomEmoji', primary_key: :shortcode, foreign_key: :shortcode, inverse_of: false, dependent: nil\n \n-  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp' } }, validate_media_type: false\n+  has_attached_file :image, styles: { static: { format: 'png', convert_options: '-coalesce +profile \"!icc,*\" +set date:modify +set date:create +set date:timestamp', file_geometry_parser: FastGeometryParser } }, validate_media_type: false, processors: [:lazy_thumbnail]\n \n   normalizes :domain, with: ->(domain) { domain.downcase }\n \n---\nspec/models/custom_emoji_spec.rb\n@@ -2,7 +2,7 @@\n \n require 'rails_helper'\n \n-RSpec.describe CustomEmoji do\n+RSpec.describe CustomEmoji, :paperclip_processing do\n   describe '#search' do\n     subject { described_class.search(search_term) }\n \n---\n\n\n---\n\nChoice C:\napp/helpers/languages_helper.rb\n@@ -254,6 +254,7 @@ def standard_locale_name(locale)\n \n   def valid_locale_or_nil(str)\n     return if str.blank?\n+    return str if valid_locale?(str)\n \n     code, = str.to_s.split(/[_-]/) # Strip out the region from e.g. en_US or ja-JP\n \n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -10453,7 +10453,7 @@ noscript {\n       gap: 4px;\n \n       dt {\n-        flex: 0 0 auto;\n+        flex: 0 1 auto;\n         color: $dark-text-color;\n         min-width: 0;\n         overflow: hidden;\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Post a toot with language set to a specific zh locale code, e.g. `zh-tw`.\r\n2. Observe the post on Web.\r\n\r\n### Expected behaviour\r\n\r\nThe post is rendered in a font for `zh-tw`\r\n\r\n### Actual behaviour\r\n\r\nThe post is rendered in a font for `zh`\r\n\r\n### Detailed description\r\n\r\n(See technical details below)\r\n\r\n### Mastodon instance\r\n\r\nmastodon.social\r\n\r\n### Mastodon version\r\n\r\nv4.1.2\r\n\r\n### Browser name and version\r\n\r\nSafari Version 16.6 (18615.3.12.11.2)\r\n\r\n### Operating system\r\n\r\nmacOS 13.5.2 (22G91)\r\n\r\n### Technical details\r\n\r\nInspecting the generated HTML I can see\r\n\r\n```html\r\n<div class=\"status__content__text status__content__text--visible translate\" lang=\"zh\"><p>\u6587\u5b57</p></div>\r\n```\r\n\r\nwith `lang=\"zh\"` being the problem there. The `lang` attribute should be marked with `zh-tw` to allow browsers to pick the right font.\r\n\r\n## Background\r\n\r\nAs part of [Han Unification](https://en.wikipedia.org/wiki/Han_unification), Unicode assigns one code point for all regional variants of the same character. Browsers and other text rendering technologies therefore rely on the context (user-specified toot locale, in this example) to pick the right font.\r\n\r\nThe same Wikipedia article illustrates this:\r\n\r\n![](https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Source_Han_Sans_Version_Difference.svg/2560px-Source_Han_Sans_Version_Difference.svg.png)\r\n\r\nThe resulting text rendering is not unreadable, but it would feel foreign and unprofessional to readers. That being said, I suspect the fix is also relatively trivial (don't even require a new UI) so overall ROI for fixing this issue should pass the bar.\r\n\n\n---\n\nChoice A:\napp/javascript/mastodon/reducers/relationships.js\n@@ -73,6 +73,7 @@ export default function relationships(state = initialState, action) {\n   case ACCOUNT_UNMUTE_SUCCESS:\n   case ACCOUNT_PIN_SUCCESS:\n   case ACCOUNT_UNPIN_SUCCESS:\n+    return normalizeRelationship(state, action.relationship);\n   case RELATIONSHIPS_FETCH_SUCCESS:\n     return normalizeRelationships(state, action.relationships);\n   case submitAccountNote.fulfilled:\n---\n\n\n---\n\nChoice B:\napp/helpers/application_helper.rb\n@@ -256,6 +256,10 @@ def app_icon_path(size = '48')\n     instance_presenter.app_icon&.file&.url(size)\n   end\n \n+  def use_mask_icon?\n+    instance_presenter.app_icon.blank?\n+  end\n+\n   private\n \n   def storage_host_var\n---\napp/views/layouts/application.html.haml\n@@ -19,7 +19,8 @@\n     - SiteUpload::APPLE_ICON_SIZES.each do |size|\n       %link{ rel: 'apple-touch-icon', sizes: \"#{size}x#{size}\", href: app_icon_path(size.to_i) || frontend_asset_path(\"icons/apple-touch-icon-#{size}x#{size}.png\") }/\n \n-    %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n+    - if use_mask_icon?\n+      %link{ rel: 'mask-icon', href: frontend_asset_path('images/logo-symbol-icon.svg'), color: '#6364FF' }/\n     %link{ rel: 'manifest', href: manifest_path(format: :json) }/\n     = theme_color_tags current_theme\n     %meta{ name: 'apple-mobile-web-app-capable', content: 'yes' }/\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -9284,14 +9284,17 @@ noscript {\n     0 10px 15px -3px rgba($base-shadow-color, 0.25),\n     0 4px 6px -4px rgba($base-shadow-color, 0.25);\n   cursor: default;\n-  transition: 0.5s cubic-bezier(0.89, 0.01, 0.5, 1.1);\n-  transform: translateZ(0);\n   font-size: 15px;\n   line-height: 21px;\n \n   &.notification-bar-active {\n     inset-inline-start: 1rem;\n   }\n+\n+  .no-reduce-motion & {\n+    transition: 0.5s cubic-bezier(0.89, 0.01, 0.5, 1.1);\n+    transform: translateZ(0);\n+  }\n }\n \n .notification-bar-title {\n---\n\n\n---\n\nChoice D:\napp/helpers/languages_helper.rb\n@@ -254,6 +254,7 @@ def standard_locale_name(locale)\n \n   def valid_locale_or_nil(str)\n     return if str.blank?\n+    return str if valid_locale?(str)\n \n     code, = str.to_s.split(/[_-]/) # Strip out the region from e.g. en_US or ja-JP\n \n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Turn on Reduce motion in animations\r\n2. Post a toot\r\n3. Notice how the pop over notifying you of the post being published still slides in and out with as much motion as before\r\n\n\n### Expected behaviour\n\nThe pop over should just appear and dissapper, possibly with slight fading?\n\n### Actual behaviour\n\nIt does the exact same thing as before turning on the option\n\n### Detailed description\n\nThank you for your fantastic work!\n\n### Mastodon instance\n\ntutoteket.no\n\n### Mastodon version\n\n4.2\n\n### Browser name and version\n\nFirefox 114\n\n### Operating system\n\nNobara Linux 38\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/emoji/unicode_to_filename.js\n@@ -1,29 +0,0 @@\n-/* eslint-disable import/no-commonjs --\n-   We need to use CommonJS here as its imported into a preval file (`emoji_compressed.js`) */\n-\n-// taken from:\n-// https://github.com/twitter/twemoji/blob/47732c7/twemoji-generator.js#L848-L866\n-exports.unicodeToFilename = (str) => {\n-  let result = '';\n-  let charCode = 0;\n-  let p = 0;\n-  let i = 0;\n-  while (i < str.length) {\n-    charCode = str.charCodeAt(i++);\n-    if (p) {\n-      if (result.length > 0) {\n-        result += '-';\n-      }\n-      result += (0x10000 + ((p - 0xD800) << 10) + (charCode - 0xDC00)).toString(16);\n-      p = 0;\n-    } else if (0xD800 <= charCode && charCode <= 0xDBFF) {\n-      p = charCode;\n-    } else {\n-      if (result.length > 0) {\n-        result += '-';\n-      }\n-      result += charCode.toString(16);\n-    }\n-  }\n-  return result;\n-};\n---\napp/javascript/mastodon/features/emoji/unicode_to_unified_name.js\n@@ -1,24 +0,0 @@\n-/* eslint-disable import/no-commonjs --\n-   We need to use CommonJS here as its imported into a preval file (`emoji_compressed.js`) */\n-\n-function padLeft(str, num) {\n-  while (str.length < num) {\n-    str = '0' + str;\n-  }\n-\n-  return str;\n-}\n-\n-exports.unicodeToUnifiedName = (str) => {\n-  let output = '';\n-\n-  for (let i = 0; i < str.length; i += 2) {\n-    if (i > 0) {\n-      output += '-';\n-    }\n-\n-    output += padLeft(str.codePointAt(i).toString(16).toUpperCase(), 4);\n-  }\n-\n-  return output;\n-};\n---\napp/javascript/styles/mailer.scss\n@@ -253,7 +253,7 @@ h5 {\n \n .input {\n   td {\n-    background: darken($ui-base-color, 8%);\n+    background: #ffffff;\n     border-radius: 4px;\n     padding: 16px;\n     line-height: 20px;\n---\n\n\n---\n\nChoice B:\napp/services/fetch_link_card_service.rb\n@@ -106,12 +106,11 @@ def skip_link?(anchor)\n   end\n \n   def attempt_oembed\n-    service         = FetchOEmbedService.new\n-    url_domain      = Addressable::URI.parse(@url).normalized_host\n-    cached_endpoint = Rails.cache.read(\"oembed_endpoint:#{url_domain}\")\n+    service = FetchOEmbedService.new\n \n-    embed   = service.call(@url, cached_endpoint: cached_endpoint) unless cached_endpoint.nil?\n+    embed   = service.call(@url, use_cached_endpoint: true)\n     embed ||= service.call(@url, html: html) unless html.nil?\n+    embed ||= service.call(@url, use_cached_endpoint: true) if @url != @original_url.to_s\n \n     return false if embed.nil?\n \n---\napp/services/fetch_oembed_service.rb\n@@ -10,7 +10,7 @@ def call(url, options = {})\n     @url     = url\n     @options = options\n \n-    if @options[:cached_endpoint]\n+    if @options[:use_cached_endpoint]\n       parse_cached_endpoint!\n     else\n       discover_endpoint!\n@@ -57,9 +57,9 @@ def discover_endpoint!\n   end\n \n   def parse_cached_endpoint!\n-    cached = @options[:cached_endpoint]\n+    cached = Rails.cache.read(cache_key)\n \n-    return if cached[:endpoint].nil? || cached[:format].nil?\n+    return if cached.nil? || cached[:endpoint].nil? || cached[:format].nil?\n \n     @endpoint_url = Addressable::Template.new(cached[:endpoint]).expand(url: @url).to_s\n     @format       = cached[:format]\n@@ -68,14 +68,16 @@ def parse_cached_endpoint!\n   def cache_endpoint!\n     return unless URL_REGEX.match?(@endpoint_url)\n \n-    url_domain = Addressable::URI.parse(@url).normalized_host\n-\n     endpoint_hash = {\n       endpoint: @endpoint_url.gsub(URL_REGEX, '={url}'),\n       format: @format,\n     }\n \n-    Rails.cache.write(\"oembed_endpoint:#{url_domain}\", endpoint_hash, expires_in: ENDPOINT_CACHE_EXPIRES_IN)\n+    Rails.cache.write(cache_key, endpoint_hash, expires_in: ENDPOINT_CACHE_EXPIRES_IN)\n+  end\n+\n+  def cache_key\n+    \"oembed_endpoint:#{Addressable::URI.parse(@url).normalized_host}\"\n   end\n \n   def fetch!\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -13,6 +13,7 @@\n     stub_request(:get, 'http://example.com/not-found').to_return(status: 404, headers: { 'Content-Type' => 'text/html' }, body: html)\n     stub_request(:get, 'http://example.com/text').to_return(status: 404, headers: { 'Content-Type' => 'text/plain' }, body: 'Hello')\n     stub_request(:get, 'http://example.com/redirect').to_return(status: 302, headers: { 'Location' => 'http://example.com/html' })\n+    stub_request(:get, 'http://example.net/redirect-to-other-domain').to_return(status: 302, headers: { 'Location' => 'http://example.com/html' })\n     stub_request(:get, 'http://example.com/redirect-to-404').to_return(status: 302, headers: { 'Location' => 'http://example.com/not-found' })\n     stub_request(:get, 'http://example.com/oembed?url=http://example.com/html').to_return(headers: { 'Content-Type' => 'application/json' }, body: '{ \"version\": \"1.0\", \"type\": \"link\", \"title\": \"oEmbed title\" }')\n     stub_request(:get, 'http://example.com/oembed?format=json&url=http://example.com/html').to_return(headers: { 'Content-Type' => 'application/json' }, body: '{ \"version\": \"1.0\", \"type\": \"link\", \"title\": \"oEmbed title\" }')\n@@ -264,6 +265,39 @@\n         end\n       end\n \n+      context 'when oEmbed endpoint cache populated with redirect target' do\n+        let(:status) { Fabricate(:status, text: 'http://example.net/redirect-to-other-domain') }\n+        let(:oembed_cache) { { endpoint: 'http://example.com/oembed?format=json&url={url}', format: :json } }\n+\n+        it 'uses the cached oEmbed response' do\n+          expect(a_request(:get, 'http://example.net/redirect-to-other-domain')).to have_been_made\n+          expect(a_request(:get, 'http://example.com/oembed?url=http://example.com/html')).to have_been_made\n+        end\n+\n+        it 'creates preview card' do\n+          expect(status.preview_card).to_not be_nil\n+          expect(status.preview_card.url).to eq 'http://example.com/html'\n+          expect(status.preview_card.title).to eq 'oEmbed title'\n+        end\n+      end\n+\n+      context 'when oEmbed endpoint cache populated with redirect target but page contains no oEmbed tags' do\n+        let(:status) { Fabricate(:status, text: 'http://example.net/redirect-to-other-domain') }\n+        let(:html) { 'Please fill out CAPTCHA' }\n+        let(:oembed_cache) { { endpoint: 'http://example.com/oembed?format=json&url={url}', format: :json } }\n+\n+        it 'uses the cached oEmbed response' do\n+          expect(a_request(:get, 'http://example.net/redirect-to-other-domain')).to have_been_made\n+          expect(a_request(:get, 'http://example.com/oembed?format=json&url=http://example.com/html')).to have_been_made\n+        end\n+\n+        it 'creates preview card' do\n+          expect(status.preview_card).to_not be_nil\n+          expect(status.preview_card.url).to eq 'http://example.com/html'\n+          expect(status.preview_card.title).to eq 'oEmbed title'\n+        end\n+      end\n+\n       # If the original HTML URL for whatever reason (e.g. DOS protection) redirects to\n       # an error page, we can still use the cached oEmbed but should not use the\n       # redirect URL on the card.\n---\nspec/services/fetch_oembed_service_spec.rb\n@@ -160,10 +160,12 @@\n           headers: { 'Content-Type': 'text/html' },\n           body: request_fixture('oembed_json_empty.html')\n         )\n+\n+        Rails.cache.write('oembed_endpoint:www.youtube.com', { endpoint: 'http://www.youtube.com/oembed?format=json&url={url}', format: :json })\n       end\n \n       it 'returns new provider without fetching original URL first' do\n-        subject.call('https://www.youtube.com/watch?v=dqwpQarrDwk', cached_endpoint: { endpoint: 'http://www.youtube.com/oembed?format=json&url={url}', format: :json })\n+        subject.call('https://www.youtube.com/watch?v=dqwpQarrDwk', use_cached_endpoint: true)\n         expect(a_request(:get, 'https://www.youtube.com/watch?v=dqwpQarrDwk')).to_not have_been_made\n         expect(subject.endpoint_url).to eq 'http://www.youtube.com/oembed?format=json&url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DdqwpQarrDwk'\n         expect(subject.format).to eq :json\n---\napp/lib/link_details_extractor.rb\n@@ -225,7 +225,7 @@ def host_to_url(str)\n   end\n \n   def valid_url_or_nil(str, same_origin_only: false)\n-    return if str.blank? || str == 'null'\n+    return if str.blank? || str == 'null' || str == 'undefined'\n \n     url = @original_url + Addressable::URI.parse(str)\n \n---\nspec/lib/link_details_extractor_spec.rb\n@@ -33,6 +33,14 @@\n         expect(subject.canonical_url).to eq original_url\n       end\n     end\n+\n+    context 'when canonical URL is set to \"undefined\"' do\n+      let(:url) { 'undefined' }\n+\n+      it 'ignores the canonical URLs' do\n+        expect(subject.canonical_url).to eq original_url\n+      end\n+    end\n   end\n \n   context 'when only basic metadata is present' do\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/home_timeline/components/inline_follow_suggestions.jsx\n@@ -129,8 +129,13 @@ export const InlineFollowSuggestions = ({ hidden }) => {\n       return;\n     }\n \n-    setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n-    setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    if (getComputedStyle(bodyRef.current).direction === 'rtl') {\n+      setCanScrollLeft((bodyRef.current.clientWidth - bodyRef.current.scrollLeft) < bodyRef.current.scrollWidth);\n+      setCanScrollRight(bodyRef.current.scrollLeft < 0);\n+    } else {\n+      setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n+      setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    }\n   }, [setCanScrollRight, setCanScrollLeft, bodyRef, suggestions]);\n \n   const handleLeftNav = useCallback(() => {\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -9284,14 +9284,17 @@ noscript {\n     0 10px 15px -3px rgba($base-shadow-color, 0.25),\n     0 4px 6px -4px rgba($base-shadow-color, 0.25);\n   cursor: default;\n-  transition: 0.5s cubic-bezier(0.89, 0.01, 0.5, 1.1);\n-  transform: translateZ(0);\n   font-size: 15px;\n   line-height: 21px;\n \n   &.notification-bar-active {\n     inset-inline-start: 1rem;\n   }\n+\n+  .no-reduce-motion & {\n+    transition: 0.5s cubic-bezier(0.89, 0.01, 0.5, 1.1);\n+    transform: translateZ(0);\n+  }\n }\n \n .notification-bar-title {\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Go to: https://mastodon.social/search\r\n2. Enter Search Term e.g. \"Petition\"\r\n3. Search for Posts\r\n4. scroll down the results\r\n5. At some point the UI will just reload and push you back to the top of the results\r\n...\r\n\r\n\r\n### Expected behaviour\r\n\r\nMore results should be shown without any reloading and scrolling \r\n\r\n### Actual behaviour\r\n\r\nUI reloads \r\n\r\n### Detailed description\r\n\r\nCould be related to #26959\r\nIt seems that fetching more posts causes the UI to rerender the entire search results page.\r\n\r\n### Mastodon instance\r\n\r\nmastodon.social\r\n\r\n### Mastodon version\r\n\r\nv4.2.0-nightly.2023-09-21\r\n\r\n### Browser name and version\r\n\r\nSafari@16.6\r\n\r\n### Operating system\r\n\r\nmacOS@13.5.2\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/explore/results.jsx\n@@ -156,45 +156,43 @@ class Results extends PureComponent {\n \n     let filteredResults;\n \n-    if (!isLoading) {\n-      const accounts = results.get('accounts', ImmutableList());\n-      const hashtags = results.get('hashtags', ImmutableList());\n-      const statuses = results.get('statuses', ImmutableList());\n-\n-      switch(type) {\n-      case 'all':\n-        filteredResults = (accounts.size + hashtags.size + statuses.size) > 0 ? (\n-          <>\n-            {accounts.size > 0 && (\n-              <SearchSection key='accounts' title={<><Icon id='users' fixedWidth /><FormattedMessage id='search_results.accounts' defaultMessage='Profiles' /></>} onClickMore={this.handleLoadMoreAccounts}>\n-                {accounts.take(INITIAL_DISPLAY).map(id => <Account key={id} id={id} />)}\n-              </SearchSection>\n-            )}\n-\n-            {hashtags.size > 0 && (\n-              <SearchSection key='hashtags' title={<><Icon id='hashtag' fixedWidth /><FormattedMessage id='search_results.hashtags' defaultMessage='Hashtags' /></>} onClickMore={this.handleLoadMoreHashtags}>\n-                {hashtags.take(INITIAL_DISPLAY).map(hashtag => <Hashtag key={hashtag.get('name')} hashtag={hashtag} />)}\n-              </SearchSection>\n-            )}\n-\n-            {statuses.size > 0 && (\n-              <SearchSection key='statuses' title={<><Icon id='quote-right' fixedWidth /><FormattedMessage id='search_results.statuses' defaultMessage='Posts' /></>} onClickMore={this.handleLoadMoreStatuses}>\n-                {statuses.take(INITIAL_DISPLAY).map(id => <Status key={id} id={id} />)}\n-              </SearchSection>\n-            )}\n-          </>\n-        ) : [];\n-        break;\n-      case 'accounts':\n-        filteredResults = renderAccounts(accounts);\n-        break;\n-      case 'hashtags':\n-        filteredResults = renderHashtags(hashtags);\n-        break;\n-      case 'statuses':\n-        filteredResults = renderStatuses(statuses);\n-        break;\n-      }\n+    const accounts = results.get('accounts', ImmutableList());\n+    const hashtags = results.get('hashtags', ImmutableList());\n+    const statuses = results.get('statuses', ImmutableList());\n+\n+    switch(type) {\n+    case 'all':\n+      filteredResults = (accounts.size + hashtags.size + statuses.size) > 0 ? (\n+        <>\n+          {accounts.size > 0 && (\n+            <SearchSection key='accounts' title={<><Icon id='users' fixedWidth /><FormattedMessage id='search_results.accounts' defaultMessage='Profiles' /></>} onClickMore={this.handleLoadMoreAccounts}>\n+              {accounts.take(INITIAL_DISPLAY).map(id => <Account key={id} id={id} />)}\n+            </SearchSection>\n+          )}\n+\n+          {hashtags.size > 0 && (\n+            <SearchSection key='hashtags' title={<><Icon id='hashtag' fixedWidth /><FormattedMessage id='search_results.hashtags' defaultMessage='Hashtags' /></>} onClickMore={this.handleLoadMoreHashtags}>\n+              {hashtags.take(INITIAL_DISPLAY).map(hashtag => <Hashtag key={hashtag.get('name')} hashtag={hashtag} />)}\n+            </SearchSection>\n+          )}\n+\n+          {statuses.size > 0 && (\n+            <SearchSection key='statuses' title={<><Icon id='quote-right' fixedWidth /><FormattedMessage id='search_results.statuses' defaultMessage='Posts' /></>} onClickMore={this.handleLoadMoreStatuses}>\n+              {statuses.take(INITIAL_DISPLAY).map(id => <Status key={id} id={id} />)}\n+            </SearchSection>\n+          )}\n+        </>\n+      ) : [];\n+      break;\n+    case 'accounts':\n+      filteredResults = renderAccounts(accounts);\n+      break;\n+    case 'hashtags':\n+      filteredResults = renderHashtags(hashtags);\n+      break;\n+    case 'statuses':\n+      filteredResults = renderStatuses(statuses);\n+      break;\n     }\n \n     return (\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/status/index.jsx\n@@ -607,6 +607,22 @@ class Status extends ImmutablePureComponent {\n     this.setState({ fullscreen: isFullscreen() });\n   };\n \n+  shouldUpdateScroll = (prevRouterProps, { location }) => {\n+    // Do not change scroll when opening a modal\n+    if (location.state?.mastodonModalKey && location.state?.mastodonModalKey !== prevRouterProps?.location?.state?.mastodonModalKey) {\n+      return false;\n+    }\n+\n+    // Scroll to focused post if it is loaded\n+    const child = this.node?.querySelector('.detailed-status__wrapper');\n+    if (child) {\n+      return [0, child.offsetTop];\n+    }\n+\n+    // Do not scroll otherwise, `componentDidUpdate` will take care of that\n+    return false;\n+  };\n+\n   render () {\n     let ancestors, descendants;\n     const { isLoading, status, ancestorsIds, descendantsIds, intl, domain, multiColumn, pictureInPicture } = this.props;\n@@ -660,7 +676,7 @@ class Status extends ImmutablePureComponent {\n           )}\n         />\n \n-        <ScrollContainer scrollKey='thread'>\n+        <ScrollContainer scrollKey='thread' shouldUpdateScroll={this.shouldUpdateScroll}>\n           <div className={classNames('scrollable', { fullscreen })} ref={this.setRef}>\n             {ancestors}\n \n---\n\n\n---\n\nChoice C:\nlib/mastodon/cli/search.rb\n@@ -100,6 +100,14 @@ def deploy\n       progress.finish\n \n       say(\"Indexed #{added} records, de-indexed #{removed}\", :green, true)\n+    rescue Elasticsearch::Transport::Transport::ServerError => e\n+      fail_with_message <<~ERROR\n+        There was an issue connecting to the search server. Make sure the\n+        server is configured and running correctly, and that the environment\n+        variable settings match what the server is expecting.\n+\n+        #{e.message}\n+      ERROR\n     end\n \n     private\n---\nspec/lib/mastodon/cli/search_spec.rb\n@@ -33,6 +33,17 @@\n       end\n     end\n \n+    context 'when server communication raises an error' do\n+      let(:options) { { reset_chewy: true } }\n+\n+      before { allow(Chewy::Stash::Specification).to receive(:reset!).and_raise(Elasticsearch::Transport::Transport::Errors::InternalServerError) }\n+\n+      it 'Exits with error message' do\n+        expect { subject }\n+          .to raise_error(Thor::Error, /issue connecting to the search/)\n+      end\n+    end\n+\n     context 'without options' do\n       before { stub_search_indexes }\n \n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/components/status.jsx\n@@ -397,6 +397,7 @@ class Status extends ImmutablePureComponent {\n     const connectUp = previousId && previousId === status.get('in_reply_to_id');\n     const connectToRoot = rootId && rootId === status.get('in_reply_to_id');\n     const connectReply = nextInReplyToId && nextInReplyToId === status.get('id');\n+    const matchedFilters = status.get('matched_filters');\n \n     if (featured) {\n       prepend = (\n@@ -432,7 +433,6 @@ class Status extends ImmutablePureComponent {\n       );\n     }\n \n-    const matchedFilters = status.get('matched_filters');\n     const expanded = (!matchedFilters || this.state.showDespiteFilter) && (!status.get('hidden') || status.get('spoiler_text').length === 0);\n \n     if (hidden) {\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\nFixes #26983\n\n---\n\nChoice A:\nCHANGELOG.md\n@@ -8,6 +8,12 @@ All notable changes to this project will be documented in this file.\n **The 4.0.x branch will not receive any update after 2023-10-31.**\n This means that no security fix will be made available for this branch after this date, and you will need to update to a more recent version (such as the 4.1.x branch) to receive security fixes.\n \n+## [4.0.11] - 2023-09-20\n+\n+### Fixed\n+\n+- Fix post translation erroring out ([ClearlyClaire](https://github.com/mastodon/mastodon/pull/26990))\n+\n ## [4.0.10] - 2023-09-19\n \n ### Fixed\n---\ndocker-compose.yml\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.0.10\n+    image: ghcr.io/mastodon/mastodon:v4.0.11\n     restart: always\n     env_file: .env.production\n     command: bash -c \"rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000\"\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.0.10\n+    image: ghcr.io/mastodon/mastodon:v4.0.11\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.0.10\n+    image: ghcr.io/mastodon/mastodon:v4.0.11\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\nlib/mastodon/version.rb\n@@ -13,7 +13,7 @@ def minor\n     end\n \n     def patch\n-      10\n+      11\n     end\n \n     def flags\n---\nCHANGELOG.md\n@@ -3,6 +3,12 @@ Changelog\n \n All notable changes to this project will be documented in this file.\n \n+## [4.1.9] - 2023-09-20\n+\n+### Fixed\n+\n+- Fix post translation erroring out ([ClearlyClaire](https://github.com/mastodon/mastodon/pull/26990))\n+\n ## [4.1.8] - 2023-09-19\n \n ### Fixed\n---\ndocker-compose.yml\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.1.8\n+    image: ghcr.io/mastodon/mastodon:v4.1.9\n     restart: always\n     env_file: .env.production\n     command: bash -c \"rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000\"\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.1.8\n+    image: ghcr.io/mastodon/mastodon:v4.1.9\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.1.8\n+    image: ghcr.io/mastodon/mastodon:v4.1.9\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\nlib/mastodon/version.rb\n@@ -13,7 +13,7 @@ def minor\n     end\n \n     def patch\n-      8\n+      9\n     end\n \n     def flags\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/notifications/requests.jsx\n@@ -217,7 +217,9 @@ export const NotificationRequests = ({ multiColumn }) => {\n         multiColumn={multiColumn}\n         showBackButton\n         appendContent={\n-          <SelectRow selectionMode={selectionMode} setSelectionMode={setSelectionMode} selectAllChecked={selectAllChecked} toggleSelectAll={toggleSelectAll} selectedItems={checkedRequestIds} />}\n+          notificationRequests.size > 0 && (\n+            <SelectRow selectionMode={selectionMode} setSelectionMode={setSelectionMode} selectAllChecked={selectAllChecked} toggleSelectAll={toggleSelectAll} selectedItems={checkedRequestIds} />\n+          )}\n       >\n         <ColumnSettings />\n       </ColumnHeader>\n---\n\n\n---\n\nChoice C:\nstreaming/redis.js\n@@ -50,9 +50,9 @@ function getSentinelConfiguration(env, commonOptions) {\n   return {\n     db: redisDatabase,\n     name: env.REDIS_SENTINEL_MASTER,\n-    username: env.REDIS_USERNAME,\n+    username: env.REDIS_USER,\n     password: env.REDIS_PASSWORD,\n-    sentinelUsername: env.REDIS_SENTINEL_USERNAME ?? env.REDIS_USERNAME,\n+    sentinelUsername: env.REDIS_SENTINEL_USERNAME ?? env.REDIS_USER,\n     sentinelPassword: env.REDIS_SENTINEL_PASSWORD ?? env.REDIS_PASSWORD,\n     sentinels,\n     ...commonOptions,\n@@ -104,7 +104,7 @@ export function configFromEnv(env) {\n     host: env.REDIS_HOST ?? '127.0.0.1',\n     port: redisPort,\n     db: redisDatabase,\n-    username: env.REDIS_USERNAME,\n+    username: env.REDIS_USER,\n     password: env.REDIS_PASSWORD,\n     ...commonOptions,\n   };\n---\n\n\n---\n\nChoice D:\nconfig/routes.rb\n@@ -142,7 +142,11 @@ def redirect_with_vary(path)\n \n   resource :inbox, only: [:create], module: :activitypub\n \n-  get '/:encoded_at(*path)', to: redirect('/@%{path}'), constraints: { encoded_at: /%40/ }\n+  constraints(encoded_path: /%40.*/) do\n+    get '/:encoded_path', to: redirect { |params|\n+      \"/#{params[:encoded_path].gsub('%40', '@')}\"\n+    }\n+  end\n \n   constraints(username: %r{[^@/.]+}) do\n     with_options to: 'accounts#show' do\n---\nspec/routing/accounts_routing_spec.rb\n@@ -47,6 +47,61 @@\n     end\n   end\n \n+  context 'with local username encoded at' do\n+    include RSpec::Rails::RequestExampleGroup\n+    let(:username) { 'alice' }\n+\n+    it 'routes /%40:username' do\n+      get \"/%40#{username}\"\n+      expect(response).to redirect_to(\"/@#{username}\")\n+    end\n+\n+    it 'routes /%40:username.json' do\n+      get(\"/%40#{username}.json\")\n+      expect(response).to redirect_to(\"/@#{username}.json\")\n+    end\n+\n+    it 'routes /%40:username.rss' do\n+      get(\"/%40#{username}.rss\")\n+      expect(response).to redirect_to(\"/@#{username}.rss\")\n+    end\n+\n+    it 'routes /%40:username/:id' do\n+      get(\"/%40#{username}/123\")\n+      expect(response).to redirect_to(\"/@#{username}/123\")\n+    end\n+\n+    it 'routes /%40:username/:id/embed' do\n+      get(\"/%40#{username}/123/embed\")\n+      expect(response).to redirect_to(\"/@#{username}/123/embed\")\n+    end\n+\n+    it 'routes /%40:username/following' do\n+      get(\"/%40#{username}/following\")\n+      expect(response).to redirect_to(\"/@#{username}/following\")\n+    end\n+\n+    it 'routes /%40:username/followers' do\n+      get(\"/%40#{username}/followers\")\n+      expect(response).to redirect_to(\"/@#{username}/followers\")\n+    end\n+\n+    it 'routes /%40:username/with_replies' do\n+      get(\"/%40#{username}/with_replies\")\n+      expect(response).to redirect_to(\"/@#{username}/with_replies\")\n+    end\n+\n+    it 'routes /%40:username/media' do\n+      get(\"/%40#{username}/media\")\n+      expect(response).to redirect_to(\"/@#{username}/media\")\n+    end\n+\n+    it 'routes /%40:username/tagged/:tag' do\n+      get(\"/%40#{username}/tagged/foo\")\n+      expect(response).to redirect_to(\"/@#{username}/tagged/foo\")\n+    end\n+  end\n+\n   context 'with remote username' do\n     let(:username) { 'alice@example.com' }\n \n@@ -82,4 +137,50 @@\n       expect(get(\"/@#{username}/tagged/foo\")).to route_to('home#index', username_with_domain: username, any: 'tagged/foo')\n     end\n   end\n+\n+  context 'with remote username encoded at' do\n+    include RSpec::Rails::RequestExampleGroup\n+    let(:username) { 'alice%40example.com' }\n+    let(:username_decoded) { 'alice@example.com' }\n+\n+    it 'routes /%40:username' do\n+      get(\"/%40#{username}\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}\")\n+    end\n+\n+    it 'routes /%40:username/:id' do\n+      get(\"/%40#{username}/123\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/123\")\n+    end\n+\n+    it 'routes /%40:username/:id/embed' do\n+      get(\"/%40#{username}/123/embed\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/123/embed\")\n+    end\n+\n+    it 'routes /%40:username/following' do\n+      get(\"/%40#{username}/following\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/following\")\n+    end\n+\n+    it 'routes /%40:username/followers' do\n+      get(\"/%40#{username}/followers\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/followers\")\n+    end\n+\n+    it 'routes /%40:username/with_replies' do\n+      get(\"/%40#{username}/with_replies\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/with_replies\")\n+    end\n+\n+    it 'routes /%40:username/media' do\n+      get(\"/%40#{username}/media\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/media\")\n+    end\n+\n+    it 'routes /%40:username/tagged/:tag' do\n+      get(\"/%40#{username}/tagged/foo\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/tagged/foo\")\n+    end\n+  end\n end\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nOn v4.1.8 click to translate content using DeepL.\n\n### Expected behaviour\n\nTranslated content\n\n### Actual behaviour\n\nError: 500 internal server error\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\ntest instance\n\n### Mastodon version\n\nv4.1.8\n\n### Browser name and version\n\nAll\n\n### Operating system\n\nAll\n\n### Technical details\n\nLog shows:\r\n````\r\n...translate format=html controller=Api::V1::Statuses::TranslationsController action=create status=500 error='NoMethodError: undefined method `model_name' for String:Class\r\n\r\nNoMethodError (undefined method `model_name' for String:Class\r\nDid you mean?  module_parent):\r\n\r\napp/controllers/api/v1/statuses/translations_controller.rb:14:in `create'\r\napp/controllers/concerns/localized.rb:11:in `set_locale'\r\nlib/mastodon/rack_middleware.rb:9:in `call'\r\nlib/public_file_server_middleware.rb:18:in `call'\r\n\r\n````\n\n---\n\nChoice A:\nlib/mastodon/cli/media.rb\n@@ -128,7 +128,7 @@ def remove_orphans\n \n             model_name      = path_segments.first.classify\n             attachment_name = path_segments[1].singularize\n-            record_id       = path_segments[2..-2].join.to_i\n+            record_id       = path_segments[2...-2].join.to_i\n             file_name       = path_segments.last\n             record          = record_map.dig(model_name, record_id)\n             attachment      = record&.public_send(attachment_name)\n@@ -172,7 +172,7 @@ def remove_orphans\n           end\n \n           model_name      = path_segments.first.classify\n-          record_id       = path_segments[2..-2].join.to_i\n+          record_id       = path_segments[2...-2].join.to_i\n           attachment_name = path_segments[1].singularize\n           file_name       = path_segments.last\n \n@@ -297,7 +297,7 @@ def lookup(url)\n       fail_with_message 'Not a media URL' unless VALID_PATH_SEGMENTS_SIZE.include?(path_segments.size)\n \n       model_name = path_segments.first.classify\n-      record_id  = path_segments[2..-2].join.to_i\n+      record_id  = path_segments[2...-2].join.to_i\n \n       fail_with_message \"Cannot find corresponding model: #{model_name}\" unless PRELOAD_MODEL_WHITELIST.include?(model_name)\n \n@@ -353,7 +353,7 @@ def preload_records_from_mixed_objects(objects)\n         next unless VALID_PATH_SEGMENTS_SIZE.include?(segments.size)\n \n         model_name = segments.first.classify\n-        record_id  = segments[2..-2].join.to_i\n+        record_id  = segments[2...-2].join.to_i\n \n         next unless PRELOAD_MODEL_WHITELIST.include?(model_name)\n \n---\n\n\n---\n\nChoice B:\nCHANGELOG.md\n@@ -8,6 +8,12 @@ All notable changes to this project will be documented in this file.\n **The 4.0.x branch will not receive any update after 2023-10-31.**\n This means that no security fix will be made available for this branch after this date, and you will need to update to a more recent version (such as the 4.1.x branch) to receive security fixes.\n \n+## [4.0.11] - 2023-09-20\n+\n+### Fixed\n+\n+- Fix post translation erroring out ([ClearlyClaire](https://github.com/mastodon/mastodon/pull/26990))\n+\n ## [4.0.10] - 2023-09-19\n \n ### Fixed\n---\ndocker-compose.yml\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.0.10\n+    image: ghcr.io/mastodon/mastodon:v4.0.11\n     restart: always\n     env_file: .env.production\n     command: bash -c \"rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000\"\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.0.10\n+    image: ghcr.io/mastodon/mastodon:v4.0.11\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.0.10\n+    image: ghcr.io/mastodon/mastodon:v4.0.11\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\nlib/mastodon/version.rb\n@@ -13,7 +13,7 @@ def minor\n     end\n \n     def patch\n-      10\n+      11\n     end\n \n     def flags\n---\nCHANGELOG.md\n@@ -3,6 +3,12 @@ Changelog\n \n All notable changes to this project will be documented in this file.\n \n+## [4.1.9] - 2023-09-20\n+\n+### Fixed\n+\n+- Fix post translation erroring out ([ClearlyClaire](https://github.com/mastodon/mastodon/pull/26990))\n+\n ## [4.1.8] - 2023-09-19\n \n ### Fixed\n---\ndocker-compose.yml\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.1.8\n+    image: ghcr.io/mastodon/mastodon:v4.1.9\n     restart: always\n     env_file: .env.production\n     command: bash -c \"rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000\"\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.1.8\n+    image: ghcr.io/mastodon/mastodon:v4.1.9\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.1.8\n+    image: ghcr.io/mastodon/mastodon:v4.1.9\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\nlib/mastodon/version.rb\n@@ -13,7 +13,7 @@ def minor\n     end\n \n     def patch\n-      8\n+      9\n     end\n \n     def flags\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -10453,7 +10453,7 @@ noscript {\n       gap: 4px;\n \n       dt {\n-        flex: 0 0 auto;\n+        flex: 0 1 auto;\n         color: $dark-text-color;\n         min-width: 0;\n         overflow: hidden;\n---\n\n\n---\n\nChoice D:\napp/lib/translation_service/deepl.rb\n@@ -46,7 +46,7 @@ def transform_response(str)\n \n     raise UnexpectedResponseError unless json.is_a?(Hash)\n \n-    Translation.new(text: json.dig('translations', 0, 'text'), detected_source_language: json.dig('translations', 0, 'detected_source_language')&.downcase, provider: 'DeepL.com')\n+    Translation.new(text: Sanitize.fragment(json.dig('translations', 0, 'text'), Sanitize::Config::MASTODON_STRICT), detected_source_language: json.dig('translations', 0, 'detected_source_language')&.downcase, provider: 'DeepL.com')\n   rescue Oj::ParseError\n     raise UnexpectedResponseError\n   end\n---\napp/lib/translation_service/libre_translate.rb\n@@ -37,7 +37,7 @@ def transform_response(str, source_language)\n \n     raise UnexpectedResponseError unless json.is_a?(Hash)\n \n-    Translation.new(text: json['translatedText'], detected_source_language: source_language, provider: 'LibreTranslate')\n+    Translation.new(text: Sanitize.fragment(json['translatedText'], Sanitize::Config::MASTODON_STRICT), detected_source_language: source_language, provider: 'LibreTranslate')\n   rescue Oj::ParseError\n     raise UnexpectedResponseError\n   end\n---\napp/services/translate_status_service.rb\n@@ -12,8 +12,8 @@ def call(status, target_language)\n     @content = status_content_format(@status)\n     @target_language = target_language\n \n-    Rails.cache.fetch(\"translations/#{@status.language}/#{@target_language}/#{content_hash}\", expires_in: CACHE_TTL) do\n-      Sanitize.fragment(translation_backend.translate(@content, @status.language, @target_language), Sanitize::Config::MASTODON_STRICT)\n+    Rails.cache.fetch(\"translations:v2/#{@status.language}/#{@target_language}/#{content_hash}\", expires_in: CACHE_TTL) do\n+      translation_backend.translate(@content, @status.language, @target_language)\n     end\n   end\n \n---\napp/lib/translation_service/deepl.rb\n@@ -46,7 +46,7 @@ def transform_response(str)\n \n     raise UnexpectedResponseError unless json.is_a?(Hash)\n \n-    Translation.new(text: json.dig('translations', 0, 'text'), detected_source_language: json.dig('translations', 0, 'detected_source_language')&.downcase, provider: 'DeepL.com')\n+    Translation.new(text: Sanitize.fragment(json.dig('translations', 0, 'text'), Sanitize::Config::MASTODON_STRICT), detected_source_language: json.dig('translations', 0, 'detected_source_language')&.downcase, provider: 'DeepL.com')\n   rescue Oj::ParseError\n     raise UnexpectedResponseError\n   end\n---\napp/lib/translation_service/libre_translate.rb\n@@ -37,7 +37,7 @@ def transform_response(str, source_language)\n \n     raise UnexpectedResponseError unless json.is_a?(Hash)\n \n-    Translation.new(text: json['translatedText'], detected_source_language: source_language, provider: 'LibreTranslate')\n+    Translation.new(text: Sanitize.fragment(json['translatedText'], Sanitize::Config::MASTODON_STRICT), detected_source_language: source_language, provider: 'LibreTranslate')\n   rescue Oj::ParseError\n     raise UnexpectedResponseError\n   end\n---\napp/services/translate_status_service.rb\n@@ -12,8 +12,8 @@ def call(status, target_language)\n     @content = status_content_format(@status)\n     @target_language = target_language\n \n-    Rails.cache.fetch(\"translations/#{@status.language}/#{@target_language}/#{content_hash}\", expires_in: CACHE_TTL) do\n-      Sanitize.fragment(translation_backend.translate(@content, @status.language, @target_language), Sanitize::Config::MASTODON_STRICT)\n+    Rails.cache.fetch(\"translations:v2/#{@status.language}/#{@target_language}/#{content_hash}\", expires_in: CACHE_TTL) do\n+      translation_backend.translate(@content, @status.language, @target_language)\n     end\n   end\n \n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Select one regional Chinese, e.g. Chinese (China), on the language drop-down menu.\r\n\n\n### Expected behaviour\n\n\"ZH-CN\" displayed as a whole like surrounding buttons.\n\n### Actual behaviour\n\nThe button was splitted into \"ZH-\" and \"CN\" on two lines.\n\n### Detailed description\n\n![Screenshot 2023-09-19 131033](https://github.com/mastodon/mastodon/assets/535565/4c4c446c-4b93-49ec-ab11-74b65efbf4c0)\r\n\r\nRegional Chinese options was added on #26066.\n\n### Mastodon instance\n\nself-host instance\n\n### Mastodon version\n\nv4.2.0-rc\n\n### Browser name and version\n\nFirefox 118.0b9\n\n### Operating system\n\nv4.2.0-rc1\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -284,6 +284,7 @@\n   font-size: 11px;\n   padding: 0 3px;\n   line-height: 27px;\n+  white-space: nowrap;\n \n   &:hover,\n   &:active,\n---\n\n\n---\n\nChoice B:\nlib/mastodon/version.rb\n@@ -17,7 +17,7 @@ def patch\n     end\n \n     def flags\n-      ENV.fetch('MASTODON_VERSION_FLAGS', '-beta2')\n+      ENV['MASTODON_VERSION_FLAGS'].presence || '-beta2'\n     end\n \n     def suffix\n---\n\n\n---\n\nChoice C:\nstreaming/index.js\n@@ -1351,15 +1351,23 @@ const startServer = async () => {\n  * @param {function(string): void} [onSuccess]\n  */\n const attachServerWithConfig = (server, onSuccess) => {\n-  if (process.env.SOCKET || process.env.PORT && isNaN(+process.env.PORT)) {\n-    server.listen(process.env.SOCKET || process.env.PORT, () => {\n+  if (process.env.SOCKET) {\n+    server.listen(process.env.SOCKET, () => {\n       if (onSuccess) {\n         fs.chmodSync(server.address(), 0o666);\n         onSuccess(server.address());\n       }\n     });\n   } else {\n-    server.listen(+(process.env.PORT || 4000), process.env.BIND || '127.0.0.1', () => {\n+    const port = +(process.env.PORT || 4000);\n+    let bind = process.env.BIND ?? '127.0.0.1';\n+    // Web uses the URI syntax for BIND, which means IPv6 addresses may\n+    // be wrapped in square brackets:\n+    if (bind.startsWith('[') && bind.endsWith(']')) {\n+      bind = bind.slice(1, -1);\n+    }\n+\n+    server.listen(port, bind, () => {\n       if (onSuccess) {\n         onSuccess(`${server.address().address}:${server.address().port}`);\n       }\n---\n\n\n---\n\nChoice D:\napp/services/statuses_search_service.rb\n@@ -39,12 +39,12 @@ def convert_deprecated_options!\n     end\n \n     if @options[:min_id]\n-      timestamp = Mastodon::Snowflake.to_time(@options[:min_id])\n+      timestamp = Mastodon::Snowflake.to_time(@options[:min_id].to_i)\n       syntax_options << \"after:\\\"#{timestamp.iso8601}\\\"\"\n     end\n \n     if @options[:max_id]\n-      timestamp = Mastodon::Snowflake.to_time(@options[:max_id])\n+      timestamp = Mastodon::Snowflake.to_time(@options[:max_id].to_i)\n       syntax_options << \"before:\\\"#{timestamp.iso8601}\\\"\"\n     end\n \n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. I upgraded the instance to the version 4.2.0-rc1\r\n2. The main site loads but shows a 501 error \"isEmpty is not a function\" in the web console\n\n### Expected behaviour\n\nopen the home site\n\n### Actual behaviour\n\nserver error\n\n### Detailed description\n\nI upgraded the instance to the rc-1 and got a error that prevented the services to load (mastodon-streaming) the error was that ioredis was missing, that error was fixed by reinstalling nodeJS, deleting node_modules and re running \"yarn install\"  when I finally get it to work the site loads but shows this error message:\r\n\r\n```\r\nTypeError: i.get(...).isEmpty is not a function\r\nisEmpty (webpack:///app/javascript/mastodon/features/about/index.jsx:164:52)\r\nwi (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:3592:9)\r\ndi (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:3577:10)\r\nBc (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:1068:2)\r\nbd (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:5339:57)\r\nbd (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:5336:6)\r\nError(p (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:5325:19)\r\nXj (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:5115:84)\r\nlc.onCommitFiberUnmount (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:5136:31)\r\nfa (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:1927:89)\r\nd.hasOwnProperty (webpack:///node_modules/react-dom/cjs/react-dom.production.min.js:4519:386)\r\n```\r\n\r\nthe same message as [this other issue]( https://github.com/mastodon/mastodon/issues/28068) from today\r\n\r\nReinstalling yarn, ruby, node, npm and all packages doesn't change the problem, the error is the same after\n\n### Mastodon instance\n\nlaburo.social\n\n### Mastodon version\n\nv4.2.0-rc1\n\n### Browser name and version\n\nfirefox and chromium \n\n### Operating system\n\ndebian 9\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/reducers/accounts.ts\n@@ -41,40 +41,42 @@ const normalizeAccounts = (\n   return state;\n };\n \n-export const accountsReducer: Reducer<typeof initialState> = (\n-  state = initialState,\n-  action,\n-) => {\n-  const currentUserId = me;\n-\n-  if (!currentUserId)\n+function getCurrentUser() {\n+  if (!me)\n     throw new Error(\n       'No current user (me) defined when calling `accountsReducer`',\n     );\n \n+  return me;\n+}\n+\n+export const accountsReducer: Reducer<typeof initialState> = (\n+  state = initialState,\n+  action,\n+) => {\n   if (revealAccount.match(action))\n     return state.setIn([action.payload.id, 'hidden'], false);\n   else if (importAccounts.match(action))\n     return normalizeAccounts(state, action.payload.accounts);\n-  else if (followAccountSuccess.match(action))\n+  else if (followAccountSuccess.match(action)) {\n     return state\n       .update(\n         action.payload.relationship.id,\n         (account) => account?.update('followers_count', (n) => n + 1),\n       )\n       .update(\n-        currentUserId,\n+        getCurrentUser(),\n         (account) => account?.update('following_count', (n) => n + 1),\n       );\n-  else if (unfollowAccountSuccess.match(action))\n+  } else if (unfollowAccountSuccess.match(action))\n     return state\n       .update(\n         action.payload.relationship.id,\n         (account) =>\n           account?.update('followers_count', (n) => Math.max(0, n - 1)),\n       )\n       .update(\n-        currentUserId,\n+        getCurrentUser(),\n         (account) =>\n           account?.update('following_count', (n) => Math.max(0, n - 1)),\n       );\n---\nspec/system/unlogged_spec.rb\n@@ -0,0 +1,17 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+describe 'UnloggedBrowsing' do\n+  subject { page }\n+\n+  before do\n+    visit root_path\n+  end\n+\n+  it 'loads the home page' do\n+    expect(subject).to have_css('div.app-holder')\n+\n+    expect(subject).to have_css('div.columns-area__panels__main')\n+  end\n+end\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -9284,14 +9284,17 @@ noscript {\n     0 10px 15px -3px rgba($base-shadow-color, 0.25),\n     0 4px 6px -4px rgba($base-shadow-color, 0.25);\n   cursor: default;\n-  transition: 0.5s cubic-bezier(0.89, 0.01, 0.5, 1.1);\n-  transform: translateZ(0);\n   font-size: 15px;\n   line-height: 21px;\n \n   &.notification-bar-active {\n     inset-inline-start: 1rem;\n   }\n+\n+  .no-reduce-motion & {\n+    transition: 0.5s cubic-bezier(0.89, 0.01, 0.5, 1.1);\n+    transform: translateZ(0);\n+  }\n }\n \n .notification-bar-title {\n---\n\n\n---\n\nChoice C:\napp/models/status.rb\n@@ -162,7 +162,7 @@ class Status < ApplicationRecord\n   REAL_TIME_WINDOW = 6.hours\n \n   def cache_key\n-    \"v2:#{super}\"\n+    \"v3:#{super}\"\n   end\n \n   def searchable_by(preloaded = nil)\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/about/index.jsx\n@@ -6,6 +6,7 @@ import { defineMessages, injectIntl, FormattedMessage } from 'react-intl';\n import classNames from 'classnames';\n import { Helmet } from 'react-helmet';\n \n+import { List as ImmutableList } from 'immutable';\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import { connect } from 'react-redux';\n \n@@ -161,7 +162,7 @@ class About extends PureComponent {\n           </Section>\n \n           <Section title={intl.formatMessage(messages.rules)}>\n-            {!isLoading && (server.get('rules', []).isEmpty() ? (\n+            {!isLoading && (server.get('rules', ImmutableList()).isEmpty() ? (\n               <p><FormattedMessage id='about.not_available' defaultMessage='This information has not been made available on this server.' /></p>\n             ) : (\n               <ol className='rules-list'>\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Sign in to your mastodon.social account on the website, then open this link:\r\nhttps://mastodon.social/api/v2/search?q=apple&type=statuses&max_id=111065964141901733\r\n\r\n2. Without signing in to your account first, open the same link in a private browsing window.\r\n\r\n### Expected behaviour\r\n\r\n1. Get status code 200, and posts (search results) earlier than the max_id\r\n2. Get status code 401, unauthorized. (optional, 200 is fine imo)\r\n\r\n### Actual behaviour\r\n\r\n1. Get status code 500: internal server error. No search results.\r\n2. Get status code 200 with no search results.\r\n\r\n### Detailed description\r\n\r\nAPI doc: https://docs.joinmastodon.org/methods/search/#v2\r\n\r\nThis is reproducible on mastodon.social (v4.2.0-nightly.2023-09-13)\r\n\r\nWorks as expected (status code 200 with search results) when searching a hashtag. e.g. \"#apple\"\r\n\r\n### Mastodon instance\r\n\r\nmastodon.social\r\n\r\n### Mastodon version\r\n\r\nv4.2.0-nightly.2023-09-13\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/about/index.jsx\n@@ -6,6 +6,7 @@ import { defineMessages, injectIntl, FormattedMessage } from 'react-intl';\n import classNames from 'classnames';\n import { Helmet } from 'react-helmet';\n \n+import { List as ImmutableList } from 'immutable';\n import ImmutablePropTypes from 'react-immutable-proptypes';\n import { connect } from 'react-redux';\n \n@@ -161,7 +162,7 @@ class About extends PureComponent {\n           </Section>\n \n           <Section title={intl.formatMessage(messages.rules)}>\n-            {!isLoading && (server.get('rules', []).isEmpty() ? (\n+            {!isLoading && (server.get('rules', ImmutableList()).isEmpty() ? (\n               <p><FormattedMessage id='about.not_available' defaultMessage='This information has not been made available on this server.' /></p>\n             ) : (\n               <ol className='rules-list'>\n---\n\n\n---\n\nChoice B:\napp/services/statuses_search_service.rb\n@@ -39,12 +39,12 @@ def convert_deprecated_options!\n     end\n \n     if @options[:min_id]\n-      timestamp = Mastodon::Snowflake.to_time(@options[:min_id])\n+      timestamp = Mastodon::Snowflake.to_time(@options[:min_id].to_i)\n       syntax_options << \"after:\\\"#{timestamp.iso8601}\\\"\"\n     end\n \n     if @options[:max_id]\n-      timestamp = Mastodon::Snowflake.to_time(@options[:max_id])\n+      timestamp = Mastodon::Snowflake.to_time(@options[:max_id].to_i)\n       syntax_options << \"before:\\\"#{timestamp.iso8601}\\\"\"\n     end\n \n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/dashboard.scss\n@@ -86,9 +86,7 @@\n     color: $primary-text-color;\n     transition: all 100ms ease-in;\n     font-size: 14px;\n-    padding: 0 16px;\n-    line-height: 36px;\n-    height: 36px;\n+    padding: 8px 16px;\n     text-decoration: none;\n     margin-bottom: 4px;\n \n---\napp/javascript/styles/mastodon/dashboard.scss\n@@ -91,6 +91,7 @@\n     height: 36px;\n     text-decoration: none;\n     margin-bottom: 4px;\n+    white-space: nowrap;\n \n     &:active,\n     &:focus,\n@@ -111,6 +112,8 @@\n \n     span {\n       flex: 1 1 auto;\n+      overflow: hidden;\n+      text-overflow: ellipsis;\n     }\n \n     strong {\n---\n\n\n---\n\nChoice D:\napp/models/account_suggestions/friends_of_friends_source.rb\n@@ -2,15 +2,19 @@\n \n class AccountSuggestions::FriendsOfFriendsSource < AccountSuggestions::Source\n   def get(account, limit: DEFAULT_LIMIT)\n+    source_query(account, limit: limit)\n+      .map { |id, _frequency, _followers_count| [id, key] }\n+  end\n+\n+  def source_query(account, limit: DEFAULT_LIMIT)\n     first_degree = account.following.where.not(hide_collections: true).select(:id).reorder(nil)\n     base_account_scope(account)\n       .joins(:account_stat)\n-      .where(id: Follow.where(account_id: first_degree).select(:target_account_id))\n+      .joins(:passive_relationships).where(passive_relationships: { account_id: first_degree })\n       .group('accounts.id, account_stats.id')\n-      .reorder('frequency DESC, followers_count DESC')\n+      .reorder(frequency: :desc, followers_count: :desc)\n       .limit(limit)\n-      .pluck(Arel.sql('accounts.id, COUNT(*) AS frequency'))\n-      .map { |id, _frequency| [id, key] }\n+      .pluck(Arel.sql('accounts.id, COUNT(*) AS frequency, followers_count'))\n   end\n \n   private\n---\nspec/models/account_suggestions/friends_of_friends_source_spec.rb\n@@ -11,9 +11,9 @@\n     let!(:eve) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:mallory) { Fabricate(:account, discoverable: false, hide_collections: false) }\n     let!(:eugen) { Fabricate(:account, discoverable: true, hide_collections: false) }\n+    let!(:neil) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:john) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:jerk) { Fabricate(:account, discoverable: true, hide_collections: false) }\n-    let!(:neil) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:larry) { Fabricate(:account, discoverable: true, hide_collections: false) }\n \n     context 'with follows and blocks' do\n@@ -70,13 +70,31 @@\n       end\n \n       it 'returns eligible accounts in the expected order' do\n-        expect(subject.get(bob)).to eq [\n-          [eugen.id, :friends_of_friends], # followed by 2 friends, 3 followers total\n-          [john.id, :friends_of_friends], # followed by 2 friends, 2 followers total\n-          [neil.id, :friends_of_friends], # followed by 1 friend, 2 followers total\n-          [jerk.id, :friends_of_friends], # followed by 1 friend, 1 follower total\n+        expect(subject.get(bob)).to eq expected_results\n+      end\n+\n+      it 'contains correct underlying source data' do\n+        expect(source_query_values)\n+          .to contain_exactly(\n+            [eugen.id, 2, 3], # Followed by 2 friends of bob (eve, mallory), 3 followers total (breaks tie)\n+            [john.id, 2, 2],  # Followed by 2 friends of bob (eve, mallory), 2 followers total\n+            [neil.id, 1, 2],  # Followed by 1 friends of bob (mallory), 2 followers total (breaks tie)\n+            [jerk.id, 1, 1]   # Followed by 1 friends of bob (eve), 1 followers total\n+          )\n+      end\n+\n+      def expected_results\n+        [\n+          [eugen.id, :friends_of_friends],\n+          [john.id, :friends_of_friends],\n+          [neil.id, :friends_of_friends],\n+          [jerk.id, :friends_of_friends],\n         ]\n       end\n+\n+      def source_query_values\n+        subject.source_query(bob).to_a\n+      end\n     end\n   end\n end\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Open a users profile\r\n2. Send a follow request\r\n\r\n...\r\n\r\n\r\n### Expected behaviour\r\n\r\nFollowing users without any error message\r\n\r\n### Actual behaviour\r\n\r\nSuccessfully followed the user but displayed an error message saying \"Unexpected error occurred\". Also after clicking on the bell icon, notifications turns on without changing the status of the icon.\r\n\r\n### Detailed description\r\n\r\nWhen I follow someone or turn on notifications on my instance I get following error: \r\n![Screenshot_20230912-063102_Vivaldi Browser](https://github.com/mastodon/mastodon/assets/114842102/5de7355d-2764-4076-87ee-ceff195d3891)\r\n\r\nThis is what I'm seeing in browser console (tried only on mobile at this moment: \r\n![SmartSelect_20230912-064148_Kiwi Browser](https://github.com/mastodon/mastodon/assets/114842102/79c09449-cbab-41d0-8915-8419065ae71d)\r\n\r\n\r\n\r\n### Mastodon instance\r\n\r\nbuddyverse.xyz\r\n\r\n### Mastodon version\r\n\r\nv4.2.0-beta3\r\n\r\n### Browser name and version\r\n\r\nVivaldi Browser 6.2.3110.52, Brave 1.57.62, Chromium 116.0.5845.180, Firefox Mobile 117.0.1 (Build #2015971659)\r\n\r\n### Operating system\r\n\r\nAndroid 11; Build/RP1A.200720.012\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/lib/activitypub/activity/create.rb\n@@ -336,13 +336,15 @@ def resolve_thread(status)\n \n   def fetch_replies(status)\n     collection = @object['replies']\n-    return if collection.nil?\n+    return if collection.blank?\n \n     replies = ActivityPub::FetchRepliesService.new.call(status, collection, allow_synchronous_requests: false, request_id: @options[:request_id])\n     return unless replies.nil?\n \n     uri = value_or_id(collection)\n     ActivityPub::FetchRepliesWorker.perform_async(status.id, uri, { 'request_id' => @options[:request_id] }) unless uri.nil?\n+  rescue => e\n+    Rails.logger.warn \"Error fetching replies: #{e}\"\n   end\n \n   def conversation_from_uri(uri)\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -80,6 +80,7 @@ html {\n }\n \n .search__input,\n+.search__popout,\n .setting-text,\n .report-dialog-modal__textarea,\n .audio-player {\n@@ -439,7 +440,8 @@ html {\n .directory__tag > div,\n .card > a,\n .page-header,\n-.compose-form .compose-form__warning {\n+.compose-form,\n+.compose-form__warning {\n   box-shadow: none;\n }\n \n@@ -475,12 +477,17 @@ html {\n   color: $white;\n }\n \n-.compose-form .spoiler-input__input {\n+.compose-form,\n+.spoiler-input__input,\n+.search__input,\n+.search__popout {\n   color: lighten($ui-highlight-color, 8%);\n }\n \n .compose-form .autosuggest-textarea__textarea,\n .compose-form__highlightable,\n+.search__input,\n+.search__popout,\n .poll__option input[type='text'] {\n   background: darken($ui-base-color, 10%);\n }\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/reducers/relationships.js\n@@ -73,6 +73,7 @@ export default function relationships(state = initialState, action) {\n   case ACCOUNT_UNMUTE_SUCCESS:\n   case ACCOUNT_PIN_SUCCESS:\n   case ACCOUNT_UNPIN_SUCCESS:\n+    return normalizeRelationship(state, action.relationship);\n   case RELATIONSHIPS_FETCH_SUCCESS:\n     return normalizeRelationships(state, action.relationships);\n   case submitAccountNote.fulfilled:\n---\n\n\n---\n\nChoice D:\nlib/mastodon/cli/search.rb\n@@ -100,6 +100,14 @@ def deploy\n       progress.finish\n \n       say(\"Indexed #{added} records, de-indexed #{removed}\", :green, true)\n+    rescue Elasticsearch::Transport::Transport::ServerError => e\n+      fail_with_message <<~ERROR\n+        There was an issue connecting to the search server. Make sure the\n+        server is configured and running correctly, and that the environment\n+        variable settings match what the server is expecting.\n+\n+        #{e.message}\n+      ERROR\n     end\n \n     private\n---\nspec/lib/mastodon/cli/search_spec.rb\n@@ -33,6 +33,17 @@\n       end\n     end\n \n+    context 'when server communication raises an error' do\n+      let(:options) { { reset_chewy: true } }\n+\n+      before { allow(Chewy::Stash::Specification).to receive(:reset!).and_raise(Elasticsearch::Transport::Transport::Errors::InternalServerError) }\n+\n+      it 'Exits with error message' do\n+        expect { subject }\n+          .to raise_error(Thor::Error, /issue connecting to the search/)\n+      end\n+    end\n+\n     context 'without options' do\n       before { stub_search_indexes }\n \n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Use the latest nightly docker image\r\n2. In the env, set `OMNIAUTH_ONLY=true` because I am using OIDC login and it works well\r\n3. Run `docker compose up -d` and you will see that you stuck on the page you are in\r\n4. The problem never happens on 4.1.7 or earlier version\n\n### Expected behaviour\n\nIt should not be stuck and when you click log in you will be able to see the login page with a single button log in with the OAuth\n\n### Actual behaviour\n\nIt will stuck on the page\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nmfy.social\n\n### Mastodon version\n\nv4.2.0 Nightly\n\n### Browser name and version\n\nEdge Latest\n\n### Operating system\n\nmacOS 13.5.1\n\n### Technical details\n\nhttps://github.com/mastodon/mastodon/blob/81caafbe84240bfb730f5001b33add97ebcbe9dc/spec/requests/content_security_policy_spec.rb#L20\r\n\r\nI checked the detailed log and browser's console log, seems like this line is causing the problem? I am just guessing\n\n---\n\nChoice A:\napp/lib/request.rb\n@@ -284,11 +284,11 @@ def open(host, *args)\n         end\n \n         until socks.empty?\n-          _, available_socks, = IO.select(nil, socks, nil, Request::TIMEOUT[:connect])\n+          _, available_socks, = IO.select(nil, socks, nil, Request::TIMEOUT[:connect_timeout])\n \n           if available_socks.nil?\n             socks.each(&:close)\n-            raise HTTP::TimeoutError, \"Connect timed out after #{Request::TIMEOUT[:connect]} seconds\"\n+            raise HTTP::TimeoutError, \"Connect timed out after #{Request::TIMEOUT[:connect_timeout]} seconds\"\n           end\n \n           available_socks.each do |sock|\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -80,6 +80,7 @@ html {\n }\n \n .search__input,\n+.search__popout,\n .setting-text,\n .report-dialog-modal__textarea,\n .audio-player {\n@@ -439,7 +440,8 @@ html {\n .directory__tag > div,\n .card > a,\n .page-header,\n-.compose-form .compose-form__warning {\n+.compose-form,\n+.compose-form__warning {\n   box-shadow: none;\n }\n \n@@ -475,12 +477,17 @@ html {\n   color: $white;\n }\n \n-.compose-form .spoiler-input__input {\n+.compose-form,\n+.spoiler-input__input,\n+.search__input,\n+.search__popout {\n   color: lighten($ui-highlight-color, 8%);\n }\n \n .compose-form .autosuggest-textarea__textarea,\n .compose-form__highlightable,\n+.search__input,\n+.search__popout,\n .poll__option input[type='text'] {\n   background: darken($ui-base-color, 10%);\n }\n---\n\n\n---\n\nChoice C:\napp/controllers/concerns/web_app_controller_concern.rb\n@@ -11,7 +11,7 @@ module WebAppControllerConcern\n   end\n \n   def skip_csrf_meta_tags?\n-    !(ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1) && current_user.nil?\n+    !(ENV['ONE_CLICK_SSO_LOGIN'] == 'true' && ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1) && current_user.nil?\n   end\n \n   def set_app_body_class\n---\napp/serializers/initial_state_serializer.rb\n@@ -113,6 +113,6 @@ def instance_presenter\n   end\n \n   def sso_redirect\n-    \"/auth/auth/#{Devise.omniauth_providers[0]}\" if ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1\n+    \"/auth/auth/#{Devise.omniauth_providers[0]}\" if ENV['ONE_CLICK_SSO_LOGIN'] == 'true' && ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1\n   end\n end\n---\nconfig/initializers/content_security_policy.rb\n@@ -19,6 +19,22 @@ def host_to_url(str)\n media_host ||= host_to_url(ENV['S3_HOSTNAME']) if ENV['S3_ENABLED'] == 'true'\n media_host ||= assets_host\n \n+def sso_host\n+  return unless ENV['ONE_CLICK_SSO_LOGIN'] == 'true'\n+  return unless ENV['OMNIAUTH_ONLY'] == 'true'\n+  return unless Devise.omniauth_providers.length == 1\n+\n+  provider = Devise.omniauth_configs[Devise.omniauth_providers[0]]\n+  @sso_host ||= begin\n+    # using CAS\n+    provider.cas_url if ENV['CAS_ENABLED'] == 'true'\n+    # using SAML\n+    provider.options[:idp_sso_target_url] if ENV['SAML_ENABLED'] == 'true'\n+    # or using OIDC\n+    ENV['OIDC_AUTH_ENDPOINT'] || (OpenIDConnect::Discovery::Provider::Config.discover!(ENV['OIDC_ISSUER']).authorization_endpoint if ENV['OIDC_ENABLED'] == 'true')\n+  end\n+end\n+\n Rails.application.config.content_security_policy do |p|\n   p.base_uri        :none\n   p.default_src     :none\n@@ -29,7 +45,13 @@ def host_to_url(str)\n   p.media_src       :self, :https, :data, assets_host\n   p.frame_src       :self, :https\n   p.manifest_src    :self, assets_host\n-  p.form_action     :self\n+\n+  if sso_host.present?\n+    p.form_action     :self, sso_host\n+  else\n+    p.form_action     :self\n+  end\n+\n   p.child_src       :self, :blob, assets_host\n   p.worker_src      :self, :blob, assets_host\n \n---\n\n\n---\n\nChoice D:\napp/controllers/concerns/web_app_controller_concern.rb\n@@ -13,7 +13,7 @@ module WebAppControllerConcern\n       policy = ContentSecurityPolicy.new\n \n       if policy.sso_host.present?\n-        p.form_action policy.sso_host\n+        p.form_action policy.sso_host, -> { \"https://#{request.host}/auth/auth/\" }\n       else\n         p.form_action :none\n       end\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nCall the search API with an account_id parameter.\n\n### Expected behaviour\n\n`/api/v2/search` supports `account_id` parameter\n\n### Actual behaviour\n\nIt seems that the `/api/v2/search` `account_id` parameter is no longer supported since v4.2 beta 3.\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.2.0-nightly.2023-09-06\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/models/web/push_subscription.rb\n@@ -21,7 +21,7 @@ class Web::PushSubscription < ApplicationRecord\n \n   has_one :session_activation, foreign_key: 'web_push_subscription_id', inverse_of: :web_push_subscription, dependent: nil\n \n-  validates :endpoint, presence: true\n+  validates :endpoint, presence: true, url: true\n   validates :key_p256dh, presence: true\n   validates :key_auth, presence: true\n \n---\nspec/requests/api/v1/push/subscriptions_spec.rb\n@@ -4,10 +4,11 @@\n \n describe 'API V1 Push Subscriptions' do\n   let(:user) { Fabricate(:user) }\n+  let(:endpoint) { 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX' }\n   let(:create_payload) do\n     {\n       subscription: {\n-        endpoint: 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX',\n+        endpoint: endpoint,\n         keys: {\n           p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n           auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n@@ -63,6 +64,18 @@\n       expect(endpoint_push_subscriptions.count)\n         .to eq(1)\n     end\n+\n+    context 'with invalid endpoint URL' do\n+      let(:endpoint) { 'app://example.foo' }\n+\n+      it 'returns a validation error' do\n+        subject\n+\n+        expect(response).to have_http_status(422)\n+        expect(endpoint_push_subscriptions.count).to eq(0)\n+        expect(endpoint_push_subscription).to be_nil\n+      end\n+    end\n   end\n \n   describe 'PUT /api/v1/push/subscription' do\n---\napp/models/web/push_subscription.rb\n@@ -25,6 +25,8 @@ class Web::PushSubscription < ApplicationRecord\n   validates :key_p256dh, presence: true\n   validates :key_auth, presence: true\n \n+  validates_with WebPushKeyValidator\n+\n   delegate :locale, to: :associated_user\n \n   def encrypt(payload)\n---\napp/validators/web_push_key_validator.rb\n@@ -0,0 +1,11 @@\n+# frozen_string_literal: true\n+\n+class WebPushKeyValidator < ActiveModel::Validator\n+  def validate(subscription)\n+    begin\n+      Webpush::Encryption.encrypt('validation_test', subscription.key_p256dh, subscription.key_auth)\n+    rescue ArgumentError, OpenSSL::PKey::EC::Point::Error\n+      subscription.errors.add(:base, I18n.t('crypto.errors.invalid_key'))\n+    end\n+  end\n+end\n---\nspec/fabricators/web_push_subscription_fabricator.rb\n@@ -2,6 +2,10 @@\n \n Fabricator(:web_push_subscription, from: Web::PushSubscription) do\n   endpoint   Faker::Internet.url\n-  key_p256dh Faker::Internet.password\n-  key_auth   Faker::Internet.password\n+  key_p256dh do\n+    curve = OpenSSL::PKey::EC.generate('prime256v1')\n+    ecdh_key = curve.public_key.to_bn.to_s(2)\n+    Base64.urlsafe_encode64(ecdh_key)\n+  end\n+  key_auth { Base64.urlsafe_encode64(Random.new.bytes(16)) }\n end\n---\nspec/requests/api/v1/push/subscriptions_spec.rb\n@@ -5,14 +5,17 @@\n describe 'API V1 Push Subscriptions' do\n   let(:user) { Fabricate(:user) }\n   let(:endpoint) { 'https://fcm.googleapis.com/fcm/send/fiuH06a27qE:APA91bHnSiGcLwdaxdyqVXNDR9w1NlztsHb6lyt5WDKOC_Z_Q8BlFxQoR8tWFSXUIDdkyw0EdvxTu63iqamSaqVSevW5LfoFwojws8XYDXv_NRRLH6vo2CdgiN4jgHv5VLt2A8ah6lUX' }\n+  let(:keys) do\n+    {\n+      p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n+      auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+    }\n+  end\n   let(:create_payload) do\n     {\n       subscription: {\n         endpoint: endpoint,\n-        keys: {\n-          p256dh: 'BEm_a0bdPDhf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n-          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n-        },\n+        keys: keys,\n       },\n     }.with_indifferent_access\n   end\n@@ -37,6 +40,16 @@\n   let(:token) { Fabricate(:accessible_access_token, resource_owner_id: user.id, scopes: scopes) }\n   let(:headers) { { 'Authorization' => \"Bearer #{token.token}\" } }\n \n+  shared_examples 'validation error' do\n+    it 'returns a validation error' do\n+      subject\n+\n+      expect(response).to have_http_status(422)\n+      expect(endpoint_push_subscriptions.count).to eq(0)\n+      expect(endpoint_push_subscription).to be_nil\n+    end\n+  end\n+\n   describe 'POST /api/v1/push/subscription' do\n     subject { post '/api/v1/push/subscription', params: create_payload, headers: headers }\n \n@@ -68,13 +81,29 @@\n     context 'with invalid endpoint URL' do\n       let(:endpoint) { 'app://example.foo' }\n \n-      it 'returns a validation error' do\n-        subject\n+      it_behaves_like 'validation error'\n+    end\n+\n+    context 'with invalid p256dh key' do\n+      let(:keys) do\n+        {\n+          p256dh: 'BEm_invalidf0SOsrnB2-ategf1hHoCnpXgQsFj5JCkcoMrMt2WHoPfEYOYPzOIs9mZE8ZUaD7VA5vouy0kEkr8=',\n+          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+        }\n+      end\n \n-        expect(response).to have_http_status(422)\n-        expect(endpoint_push_subscriptions.count).to eq(0)\n-        expect(endpoint_push_subscription).to be_nil\n+      it_behaves_like 'validation error'\n+    end\n+\n+    context 'with invalid base64 p256dh key' do\n+      let(:keys) do\n+        {\n+          p256dh: 'not base64',\n+          auth: 'eH_C8rq2raXqlcBVDa1gLg==',\n+        }\n       end\n+\n+      it_behaves_like 'validation error'\n     end\n   end\n \n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/reducers/notification_groups.ts\n@@ -559,7 +559,10 @@ export const notificationGroupsReducer = createReducer<NotificationGroupsState>(\n           compareId(state.lastReadId, mostRecentGroup.page_max_id) < 0\n         )\n           state.lastReadId = mostRecentGroup.page_max_id;\n-        commitLastReadId(state);\n+\n+        // We don't call `commitLastReadId`, because that is conditional\n+        // and we want to unconditionally update the state instead.\n+        state.readMarkerId = state.lastReadId;\n       })\n       .addCase(fetchMarkers.fulfilled, (state, action) => {\n         if (\n---\n\n\n---\n\nChoice C:\napp/controllers/api/v1/timelines/tag_controller.rb\n@@ -1,6 +1,7 @@\n # frozen_string_literal: true\n \n class Api::V1::Timelines::TagController < Api::BaseController\n+  before_action -> { doorkeeper_authorize! :read, :'read:statuses' }, only: :show, if: :require_auth?\n   before_action :load_tag\n   after_action :insert_pagination_headers, unless: -> { @statuses.empty? }\n \n@@ -12,6 +13,10 @@ def show\n \n   private\n \n+  def require_auth?\n+    !Setting.timeline_preview\n+  end\n+\n   def load_tag\n     @tag = Tag.find_normalized(params[:id])\n   end\n---\nspec/controllers/api/v1/timelines/tag_controller_spec.rb\n@@ -5,36 +5,66 @@\n describe Api::V1::Timelines::TagController do\n   render_views\n \n-  let(:user) { Fabricate(:user) }\n+  let(:user)   { Fabricate(:user) }\n+  let(:token)  { Fabricate(:accessible_access_token, resource_owner_id: user.id, scopes: 'read:statuses') }\n \n   before do\n     allow(controller).to receive(:doorkeeper_token) { token }\n   end\n \n-  context 'with a user context' do\n-    let(:token) { Fabricate(:accessible_access_token, resource_owner_id: user.id) }\n+  describe 'GET #show' do\n+    subject do\n+      get :show, params: { id: 'test' }\n+    end\n \n-    describe 'GET #show' do\n-      before do\n-        PostStatusService.new.call(user.account, text: 'It is a #test')\n+    before do\n+      PostStatusService.new.call(user.account, text: 'It is a #test')\n+    end\n+\n+    context 'when the instance allows public preview' do\n+      context 'when the user is not authenticated' do\n+        let(:token) { nil }\n+\n+        it 'returns http success', :aggregate_failures do\n+          subject\n+\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n \n-      it 'returns http success' do\n-        get :show, params: { id: 'test' }\n-        expect(response).to have_http_status(200)\n-        expect(response.headers['Link'].links.size).to eq(2)\n+      context 'when the user is authenticated' do\n+        it 'returns http success', :aggregate_failures do\n+          subject\n+\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n     end\n-  end\n \n-  context 'without a user context' do\n-    let(:token) { Fabricate(:accessible_access_token, resource_owner_id: nil) }\n+    context 'when the instance does not allow public preview' do\n+      before do\n+        Form::AdminSettings.new(timeline_preview: false).save\n+      end\n+\n+      context 'when the user is not authenticated' do\n+        let(:token) { nil }\n+\n+        it 'returns http unauthorized' do\n+          subject\n+\n+          expect(response).to have_http_status(401)\n+        end\n+      end\n+\n+      context 'when the user is authenticated' do\n+        it 'returns http success', :aggregate_failures do\n+          subject\n \n-    describe 'GET #show' do\n-      it 'returns http success' do\n-        get :show, params: { id: 'test' }\n-        expect(response).to have_http_status(200)\n-        expect(response.headers['Link']).to be_nil\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n     end\n   end\n---\n\n\n---\n\nChoice D:\napp/lib/search_query_parser.rb\n@@ -8,7 +8,7 @@ class SearchQueryParser < Parslet::Parser\n   rule(:operator)  { (str('+') | str('-')).as(:operator) }\n   rule(:prefix)    { term >> colon }\n   rule(:shortcode) { (colon >> term >> colon.maybe).as(:shortcode) }\n-  rule(:phrase)    { (quote >> (term >> space.maybe).repeat >> quote).as(:phrase) }\n+  rule(:phrase)    { (quote >> (match('[^\\s\"]').repeat(1).as(:term) >> space.maybe).repeat >> quote).as(:phrase) }\n   rule(:clause)    { (operator.maybe >> prefix.maybe.as(:prefix) >> (phrase | term | shortcode)).as(:clause) | prefix.as(:clause) | quote.as(:junk) }\n   rule(:query)     { (clause >> space.maybe).repeat.as(:query) }\n   root(:query)\n---\napp/lib/search_query_transformer.rb\n@@ -225,17 +225,16 @@ def language_code_from_term(term)\n   rule(clause: subtree(:clause)) do\n     prefix   = clause[:prefix][:term].to_s if clause[:prefix]\n     operator = clause[:operator]&.to_s\n+    term     = clause[:phrase] ? clause[:phrase].map { |term| term[:term].to_s }.join(' ') : clause[:term].to_s\n \n     if clause[:prefix] && SUPPORTED_PREFIXES.include?(prefix)\n-      PrefixClause.new(prefix, operator, clause[:term].to_s, current_account: current_account)\n+      PrefixClause.new(prefix, operator, term, current_account: current_account)\n     elsif clause[:prefix]\n-      TermClause.new(operator, \"#{prefix} #{clause[:term]}\")\n+      TermClause.new(operator, \"#{prefix} #{term}\")\n     elsif clause[:term]\n-      TermClause.new(operator, clause[:term].to_s)\n-    elsif clause[:shortcode]\n-      TermClause.new(operator, \":#{clause[:term]}:\")\n+      TermClause.new(operator, term)\n     elsif clause[:phrase]\n-      PhraseClause.new(operator, clause[:phrase].is_a?(Array) ? clause[:phrase].map { |p| p[:term].to_s }.join(' ') : clause[:phrase].to_s)\n+      PhraseClause.new(operator, term)\n     else\n       raise \"Unexpected clause type: #{clause}\"\n     end\n---\napp/services/statuses_search_service.rb\n@@ -8,6 +8,7 @@ def call(query, account = nil, options = {})\n     @limit   = options[:limit].to_i\n     @offset  = options[:offset].to_i\n \n+    convert_deprecated_options!\n     status_search_results\n   end\n \n@@ -28,4 +29,25 @@ def status_search_results\n   def parsed_query\n     SearchQueryTransformer.new.apply(SearchQueryParser.new.parse(@query), current_account: @account)\n   end\n+\n+  def convert_deprecated_options!\n+    syntax_options = []\n+\n+    if @options[:account_id]\n+      username = Account.select(:username, :domain).find(@options[:account_id]).acct\n+      syntax_options << \"from:@#{username}\"\n+    end\n+\n+    if @options[:min_id]\n+      timestamp = Mastodon::Snowflake.to_time(@options[:min_id])\n+      syntax_options << \"after:\\\"#{timestamp.iso8601}\\\"\"\n+    end\n+\n+    if @options[:max_id]\n+      timestamp = Mastodon::Snowflake.to_time(@options[:max_id])\n+      syntax_options << \"before:\\\"#{timestamp.iso8601}\\\"\"\n+    end\n+\n+    @query = \"#{@query} #{syntax_options.join(' ')}\".strip if syntax_options.any?\n+  end\n end\n---\nlib/mastodon/snowflake.rb\n@@ -104,6 +104,10 @@ def id_at(timestamp, with_random: true)\n       id\n     end\n \n+    def to_time(id)\n+      Time.at((id >> 16) / 1000).utc\n+    end\n+\n     private\n \n     def already_defined?\n---\nspec/lib/search_query_transformer_spec.rb\n@@ -57,4 +57,24 @@\n       expect(subject.send(:filter_clauses)).to be_empty\n     end\n   end\n+\n+  context 'with \\'\"hello world\"\\'' do\n+    let(:query) { '\"hello world\"' }\n+\n+    it 'transforms clauses' do\n+      expect(subject.send(:must_clauses).map(&:phrase)).to contain_exactly('hello world')\n+      expect(subject.send(:must_not_clauses)).to be_empty\n+      expect(subject.send(:filter_clauses)).to be_empty\n+    end\n+  end\n+\n+  context 'with \\'before:\"2022-01-01 23:00\"\\'' do\n+    let(:query) { 'before:\"2022-01-01 23:00\"' }\n+\n+    it 'transforms clauses' do\n+      expect(subject.send(:must_clauses)).to be_empty\n+      expect(subject.send(:must_not_clauses)).to be_empty\n+      expect(subject.send(:filter_clauses).map(&:term)).to contain_exactly(lt: '2022-01-01 23:00', time_zone: 'UTC')\n+    end\n+  end\n end\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n  I don't know how to reproduce it. Write the address of the post where the issue is occurring instead.\r\n1. original (v4.1.6) - https://duk.space/@Karin_Official/111012571140369639\r\n![image](https://github.com/mastodon/mastodon/assets/205521/0512e9de-4247-46b0-8366-760d7dd55612)\r\n2. issue posts\r\n- v4.2.0-nightly.2023-09-04 - https://mastodon.social/@Karin_Official@duk.space/111012571713629170\r\n![image](https://github.com/mastodon/mastodon/assets/205521/4fb46d1b-733d-435f-9398-b38efe9e8860)\r\n- v4.2.0-beta3 - https://netsphere.one/@Karin_Official@duk.space/111012571171699796\r\n![image](https://github.com/mastodon/mastodon/assets/205521/f1931975-ce06-4551-8748-7b521a128c34)\r\n- v4.2.0-beta3 - https://muri.network/@Karin_Official@duk.space/111012571141664014\r\n![image](https://github.com/mastodon/mastodon/assets/205521/bd6b97ef-e94f-4949-8dbe-55f05c07f58e)\r\n\r\n\r\n\r\n### Expected behaviour\r\n\r\nhashtag exposed.\r\n\r\n### Actual behaviour\r\n\r\nhashtag not exposed.\r\n\r\n### Detailed description\r\n\r\n  The hashtag is used at the very bottom of the original post and is delivered correctly to other servers. It is delivered to the subscriber's home timeline.\r\n  However, when users on other servers view the post, the hashtag is not exposed.\r\n\r\n\r\n\r\n### Mastodon instance\r\n\r\nmastodon.social\r\nnetsphere.one\r\nmuri.network\r\n\r\n### Mastodon version\r\n\r\nv4.2.0-nightly.2023-09-04\r\nv4.2.0-beta3\r\n\r\n### Browser name and version\r\n\r\nGoogle Chrome 116.0.5845.141 & Microsoft Edge 116.0.1938.69\r\n\r\n### Operating system\r\n\r\nMicrosoft Windows 22H2 22621.2215\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/components/column.jsx\n@@ -16,7 +16,19 @@ export default class Column extends PureComponent {\n   };\n \n   scrollTop () {\n-    const scrollable = this.props.bindToDocument ? document.scrollingElement : this.node.querySelector('.scrollable');\n+    let scrollable = null;\n+\n+    if (this.props.bindToDocument) {\n+      scrollable = document.scrollingElement;\n+    } else {\n+      scrollable = this.node.querySelector('.scrollable');\n+\n+      // Some columns have nested `.scrollable` containers, with the outer one\n+      // being a wrapper while the actual scrollable content is deeper.\n+      if (scrollable.classList.contains('scrollable--flex')) {\n+        scrollable = scrollable?.querySelector('.scrollable') || scrollable;\n+      }\n+   }\n \n     if (!scrollable) {\n       return;\n---\n\n\n---\n\nChoice B:\napp/lib/link_details_extractor.rb\n@@ -36,7 +36,8 @@ def description\n     end\n \n     def language\n-      json['inLanguage']\n+      lang = json['inLanguage']\n+      lang.is_a?(Hash) ? (lang['alternateName'] || lang['name']) : lang\n     end\n \n     def type\n---\nspec/lib/link_details_extractor_spec.rb\n@@ -82,6 +82,10 @@\n           'name' => 'Pet News',\n           'url' => 'https://example.com',\n         },\n+        'inLanguage' => {\n+          name: 'English',\n+          alternateName: 'en',\n+        },\n       }.to_json\n     end\n \n@@ -115,6 +119,12 @@\n           expect(subject.provider_name).to eq 'Pet News'\n         end\n       end\n+\n+      describe '#language' do\n+        it 'returns the language from structured data' do\n+          expect(subject.language).to eq 'en'\n+        end\n+      end\n     end\n \n     context 'when is wrapped in CDATA tags' do\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/components/status.jsx\n@@ -546,7 +546,7 @@ class Status extends ImmutablePureComponent {\n     const visibilityIcon = visibilityIconInfo[status.get('visibility')];\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n-    const expanded = !status.get('hidden')\n+    const expanded = !status.get('hidden') || status.get('spoiler_text').length === 0;\n \n     return (\n       <HotKeys handlers={handlers}>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -293,7 +293,7 @@ class DetailedStatus extends ImmutablePureComponent {\n     }\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n-    const expanded = !status.get('hidden')\n+    const expanded = !status.get('hidden') || status.get('spoiler_text').length === 0;\n \n     return (\n       <div style={outerStyle}>\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/reducers/accounts.ts\n@@ -41,40 +41,42 @@ const normalizeAccounts = (\n   return state;\n };\n \n-export const accountsReducer: Reducer<typeof initialState> = (\n-  state = initialState,\n-  action,\n-) => {\n-  const currentUserId = me;\n-\n-  if (!currentUserId)\n+function getCurrentUser() {\n+  if (!me)\n     throw new Error(\n       'No current user (me) defined when calling `accountsReducer`',\n     );\n \n+  return me;\n+}\n+\n+export const accountsReducer: Reducer<typeof initialState> = (\n+  state = initialState,\n+  action,\n+) => {\n   if (revealAccount.match(action))\n     return state.setIn([action.payload.id, 'hidden'], false);\n   else if (importAccounts.match(action))\n     return normalizeAccounts(state, action.payload.accounts);\n-  else if (followAccountSuccess.match(action))\n+  else if (followAccountSuccess.match(action)) {\n     return state\n       .update(\n         action.payload.relationship.id,\n         (account) => account?.update('followers_count', (n) => n + 1),\n       )\n       .update(\n-        currentUserId,\n+        getCurrentUser(),\n         (account) => account?.update('following_count', (n) => n + 1),\n       );\n-  else if (unfollowAccountSuccess.match(action))\n+  } else if (unfollowAccountSuccess.match(action))\n     return state\n       .update(\n         action.payload.relationship.id,\n         (account) =>\n           account?.update('followers_count', (n) => Math.max(0, n - 1)),\n       )\n       .update(\n-        currentUserId,\n+        getCurrentUser(),\n         (account) =>\n           account?.update('following_count', (n) => Math.max(0, n - 1)),\n       );\n---\nspec/system/unlogged_spec.rb\n@@ -0,0 +1,17 @@\n+# frozen_string_literal: true\n+\n+require 'rails_helper'\n+\n+describe 'UnloggedBrowsing' do\n+  subject { page }\n+\n+  before do\n+    visit root_path\n+  end\n+\n+  it 'loads the home page' do\n+    expect(subject).to have_css('div.app-holder')\n+\n+    expect(subject).to have_css('div.columns-area__panels__main')\n+  end\n+end\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n```\r\nxtex@xtex ~> curl https://mastodon.social/.well-known/host-meta.json\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<XRD xmlns=\"http://docs.oasis-open.org/ns/xri/xrd-1.0\">\r\n  <Link rel=\"lrdd\" template=\"https://mastodon.social/.well-known/webfinger?resource={uri}\"/>\r\n</XRD>\r\n```\n\n### Expected behaviour\n\nA JRD document with Content-Type `application/json`\n\n### Actual behaviour\n\nA XRD document with Content-Type `application/xrd+xml`\n\n### Detailed description\n\nref: <https://datatracker.ietf.org/doc/html/rfc6415#appendix-A>\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\n_No response_\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\nlib/mastodon/version.rb\n@@ -17,7 +17,7 @@ def patch\n     end\n \n     def flags\n-      ENV.fetch('MASTODON_VERSION_FLAGS', '-beta2')\n+      ENV['MASTODON_VERSION_FLAGS'].presence || '-beta2'\n     end\n \n     def suffix\n---\n\n\n---\n\nChoice B:\napp/controllers/admin/domain_blocks_controller.rb\n@@ -37,7 +37,7 @@ def create\n         @domain_block.errors.delete(:domain)\n         render :new\n       else\n-        if existing_domain_block.present?\n+        if existing_domain_block.present? && existing_domain_block.domain == resource_params[:domain]\n           @domain_block = existing_domain_block\n           @domain_block.update(resource_params)\n         end\n---\nspec/controllers/admin/domain_blocks_controller_spec.rb\n@@ -68,6 +68,26 @@\n       expect(flash[:notice]).to eq I18n.t('admin.domain_blocks.created_msg')\n       expect(response).to redirect_to(admin_instances_path(limited: '1'))\n     end\n+\n+    context 'when a block for a parent domain already exists' do\n+      subject { post :create, params: { domain_block: { domain: 'subdomain.example.com', severity: child_severity } } }\n+\n+      let(:parent_severity) { 'silence' }\n+      let(:child_severity)  { 'suspend' }\n+\n+      before do\n+        Fabricate(:domain_block, domain: 'example.com', severity: parent_severity)\n+      end\n+\n+      it 'does not change the existing block' do\n+        expect { subject }.to_not change { DomainBlock.find_by(domain: 'example.com') }\n+      end\n+\n+      it 'creates a domain block with expected severity' do\n+        subject\n+        expect(DomainBlock.where(domain: 'subdomain.example.com', severity: child_severity)).to exist\n+      end\n+    end\n   end\n \n   describe 'PUT #update' do\n---\napp/controllers/admin/domain_blocks_controller.rb\n@@ -40,7 +40,7 @@ def create\n       end\n \n       # Allow transparently upgrading a domain block\n-      if existing_domain_block.present?\n+      if existing_domain_block.present? && existing_domain_block.domain == TagManager.instance.normalize_domain(@domain_block.domain.strip)\n         @domain_block = existing_domain_block\n         @domain_block.assign_attributes(resource_params)\n       end\n---\nspec/features/admin/domain_blocks_spec.rb\n@@ -57,6 +57,30 @@\n     end\n   end\n \n+  context 'when suspending a subdomain of an already-silenced domain' do\n+    it 'presents a confirmation screen before suspending the domain' do\n+      domain_block = Fabricate(:domain_block, domain: 'example.com', severity: 'silence')\n+\n+      visit new_admin_domain_block_path\n+\n+      fill_in 'domain_block_domain', with: 'subdomain.example.com'\n+      select I18n.t('admin.domain_blocks.new.severity.suspend'), from: 'domain_block_severity'\n+      click_on I18n.t('admin.domain_blocks.new.create')\n+\n+      # It presents a confirmation screen\n+      expect(page).to have_title(I18n.t('admin.domain_blocks.confirm_suspension.title', domain: 'subdomain.example.com'))\n+\n+      # Confirming creates the block\n+      click_on I18n.t('admin.domain_blocks.confirm_suspension.confirm')\n+\n+      expect(DomainBlock.where(domain: 'subdomain.example.com', severity: 'suspend')).to exist\n+\n+      # And leaves the previous block alone\n+      expect(domain_block.reload.severity).to eq 'silence'\n+      expect(domain_block.reload.domain).to eq 'example.com'\n+    end\n+  end\n+\n   context 'when editing a domain block' do\n     it 'presents a confirmation screen before suspending the domain' do\n       domain_block = Fabricate(:domain_block, domain: 'example.com', severity: 'silence')\n---\n\n\n---\n\nChoice C:\napp/controllers/well_known/host_meta_controller.rb\n@@ -7,7 +7,23 @@ class HostMetaController < ActionController::Base # rubocop:disable Rails/Applic\n     def show\n       @webfinger_template = \"#{webfinger_url}?resource={uri}\"\n       expires_in 3.days, public: true\n-      render content_type: 'application/xrd+xml', formats: [:xml]\n+\n+      respond_to do |format|\n+        format.any do\n+          render content_type: 'application/xrd+xml', formats: [:xml]\n+        end\n+\n+        format.json do\n+          render json: {\n+            links: [\n+              {\n+                rel: 'lrdd',\n+                template: @webfinger_template,\n+              },\n+            ],\n+          }\n+        end\n+      end\n     end\n   end\n end\n---\nconfig/routes.rb\n@@ -67,7 +67,7 @@ def redirect_with_vary(path)\n   scope path: '.well-known' do\n     scope module: :well_known do\n       get 'oauth-authorization-server', to: 'oauth_metadata#show', as: :oauth_metadata, defaults: { format: 'json' }\n-      get 'host-meta', to: 'host_meta#show', as: :host_meta, defaults: { format: 'xml' }\n+      get 'host-meta', to: 'host_meta#show', as: :host_meta\n       get 'nodeinfo', to: 'node_info#index', as: :nodeinfo, defaults: { format: 'json' }\n       get 'webfinger', to: 'webfinger#show', as: :webfinger\n     end\n---\nspec/requests/well_known/host_meta_spec.rb\n@@ -9,19 +9,39 @@\n     expect(response)\n       .to have_http_status(200)\n       .and have_attributes(\n-        media_type: 'application/xrd+xml',\n-        body: host_meta_xml_template\n+        media_type: 'application/xrd+xml'\n+      )\n+\n+    doc = Nokogiri::XML(response.parsed_body)\n+    expect(doc.at_xpath('/xrd:XRD/xrd:Link[@rel=\"lrdd\"]/@template', 'xrd' => 'http://docs.oasis-open.org/ns/xri/xrd-1.0').value)\n+      .to eq 'https://cb6e6126.ngrok.io/.well-known/webfinger?resource={uri}'\n+  end\n+\n+  it 'returns http success with valid JSON response with .json extension' do\n+    get '/.well-known/host-meta.json'\n+\n+    expect(response)\n+      .to have_http_status(200)\n+      .and have_attributes(\n+        media_type: 'application/json'\n+      )\n+\n+    expect(response.parsed_body)\n+      .to include(\n+        links: [\n+          'rel' => 'lrdd',\n+          'template' => 'https://cb6e6126.ngrok.io/.well-known/webfinger?resource={uri}',\n+        ]\n       )\n   end\n \n-  private\n+  it 'returns http success with valid JSON response with Accept header' do\n+    get '/.well-known/host-meta', headers: { 'Accept' => 'application/json' }\n \n-  def host_meta_xml_template\n-    <<~XML\n-      <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-      <XRD xmlns=\"http://docs.oasis-open.org/ns/xri/xrd-1.0\">\n-        <Link rel=\"lrdd\" template=\"https://cb6e6126.ngrok.io/.well-known/webfinger?resource={uri}\"/>\n-      </XRD>\n-    XML\n+    expect(response)\n+      .to have_http_status(200)\n+      .and have_attributes(\n+        media_type: 'application/json'\n+      )\n   end\n end\n---\nspec/routing/well_known_routes_spec.rb\n@@ -4,9 +4,14 @@\n \n RSpec.describe 'Well Known routes' do\n   describe 'the host-meta route' do\n-    it 'routes to correct place with xml format' do\n+    it 'routes to correct place' do\n       expect(get('/.well-known/host-meta'))\n-        .to route_to('well_known/host_meta#show', format: 'xml')\n+        .to route_to('well_known/host_meta#show')\n+    end\n+\n+    it 'routes to correct place with json format' do\n+      expect(get('/.well-known/host-meta.json'))\n+        .to route_to('well_known/host_meta#show', format: 'json')\n     end\n   end\n \n---\n\n\n---\n\nChoice D:\nstreaming/redis.js\n@@ -50,9 +50,9 @@ function getSentinelConfiguration(env, commonOptions) {\n   return {\n     db: redisDatabase,\n     name: env.REDIS_SENTINEL_MASTER,\n-    username: env.REDIS_USERNAME,\n+    username: env.REDIS_USER,\n     password: env.REDIS_PASSWORD,\n-    sentinelUsername: env.REDIS_SENTINEL_USERNAME ?? env.REDIS_USERNAME,\n+    sentinelUsername: env.REDIS_SENTINEL_USERNAME ?? env.REDIS_USER,\n     sentinelPassword: env.REDIS_SENTINEL_PASSWORD ?? env.REDIS_PASSWORD,\n     sentinels,\n     ...commonOptions,\n@@ -104,7 +104,7 @@ export function configFromEnv(env) {\n     host: env.REDIS_HOST ?? '127.0.0.1',\n     port: redisPort,\n     db: redisDatabase,\n-    username: env.REDIS_USERNAME,\n+    username: env.REDIS_USER,\n     password: env.REDIS_PASSWORD,\n     ...commonOptions,\n   };\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nImagine three users on three instances: User A on Instance A, who is mutually following User B from Instance B, and User C from Instance C who is mutually following with User B.  User A and User C are not following each other at all, nor is anyone from instance C following user A.\r\n\r\nSo the connection looks like...\r\nA <-> B <-> C\r\n...and there is no connection to User A from Instance C, thus making User A invisible to User C outside of the following interaction...\r\n\r\n1. User B makes a post on Instance B.\r\n2. User A responds to post from Instance A, then edits their own comment.\r\n3. User C, from Instance C, from which no one follows user A, looks at post by user A, and sees comment by user B.\r\n\n\n### Expected behaviour\n\nEdit from User A should proliferate to instant C, and be visible to user C\n\n### Actual behaviour\n\nEdit from User A does not proliferate to Instance C, so only the original post shows for User C\n\n### Detailed description\n\nAs described above, the edit to a comment should be proliferating, but is not.\n\n### Mastodon instance\n\nhttps://writing.exchange/@raccoon/110976535994429708\n\n### Mastodon version\n\nv4.1.6--ff3\n\n### Browser name and version\n\nChrome\n\n### Operating system\n\nAndroid\n\n### Technical details\n\nI think the operative part of this bug is that the post itself is being proliferated to a server which isn't following me, but the edit isn't similarly proliferated, so they see the version with the major typo, without the immediate edit.\n\n---\n\nChoice A:\napp/models/status.rb\n@@ -162,7 +162,7 @@ class Status < ApplicationRecord\n   REAL_TIME_WINDOW = 6.hours\n \n   def cache_key\n-    \"v2:#{super}\"\n+    \"v3:#{super}\"\n   end\n \n   def searchable_by(preloaded = nil)\n---\n\n\n---\n\nChoice B:\napp/lib/activitypub/activity/update.rb\n@@ -30,6 +30,6 @@ def update_status\n \n     return if @status.nil?\n \n-    ActivityPub::ProcessStatusUpdateService.new.call(@status, @object, request_id: @options[:request_id])\n+    ActivityPub::ProcessStatusUpdateService.new.call(@status, @json, @object, request_id: @options[:request_id])\n   end\n end\n---\napp/services/activitypub/fetch_remote_poll_service.rb\n@@ -8,6 +8,6 @@ def call(poll, on_behalf_of = nil)\n \n     return unless supported_context?(json)\n \n-    ActivityPub::ProcessStatusUpdateService.new.call(poll.status, json)\n+    ActivityPub::ProcessStatusUpdateService.new.call(poll.status, json, json)\n   end\n end\n---\napp/services/activitypub/process_status_update_service.rb\n@@ -5,10 +5,11 @@ class ActivityPub::ProcessStatusUpdateService < BaseService\n   include Redisable\n   include Lockable\n \n-  def call(status, json, request_id: nil)\n+  def call(status, activity_json, object_json, request_id: nil)\n     raise ArgumentError, 'Status has unsaved changes' if status.changed?\n \n-    @json                      = json\n+    @activity_json             = activity_json\n+    @json                      = object_json\n     @status_parser             = ActivityPub::Parser::StatusParser.new(@json)\n     @uri                       = @status_parser.uri\n     @status                    = status\n@@ -306,6 +307,6 @@ def forward_activity!\n   end\n \n   def forwarder\n-    @forwarder ||= ActivityPub::Forwarder.new(@account, @json, @status)\n+    @forwarder ||= ActivityPub::Forwarder.new(@account, @activity_json, @status)\n   end\n end\n---\nspec/services/activitypub/process_status_update_service_spec.rb\n@@ -41,12 +41,12 @@ def poll_option_json(name, votes)\n \n   describe '#call' do\n     it 'updates text' do\n-      subject.call(status, json)\n+      subject.call(status, json, json)\n       expect(status.reload.text).to eq 'Hello universe'\n     end\n \n     it 'updates content warning' do\n-      subject.call(status, json)\n+      subject.call(status, json, json)\n       expect(status.reload.spoiler_text).to eq 'Show more'\n     end\n \n@@ -64,7 +64,7 @@ def poll_option_json(name, votes)\n       end\n \n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'does not create any edits' do\n@@ -87,7 +87,7 @@ def poll_option_json(name, votes)\n       end\n \n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'does not create any edits' do\n@@ -134,7 +134,7 @@ def poll_option_json(name, votes)\n       end\n \n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'does not create any edits' do\n@@ -186,7 +186,7 @@ def poll_option_json(name, votes)\n       end\n \n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'does not create any edits' do\n@@ -214,11 +214,11 @@ def poll_option_json(name, votes)\n       end\n \n       it 'does not create any edits' do\n-        expect { subject.call(status, json) }.to_not(change { status.reload.edits.pluck(&:id) })\n+        expect { subject.call(status, json, json) }.to_not(change { status.reload.edits.pluck(&:id) })\n       end\n \n       it 'does not update the text, spoiler_text or edited_at' do\n-        expect { subject.call(status, json) }.to_not(change { s = status.reload; [s.text, s.spoiler_text, s.edited_at] })\n+        expect { subject.call(status, json, json) }.to_not(change { s = status.reload; [s.text, s.spoiler_text, s.edited_at] })\n       end\n     end\n \n@@ -233,7 +233,7 @@ def poll_option_json(name, votes)\n       end\n \n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'does not create any edits' do\n@@ -257,7 +257,7 @@ def poll_option_json(name, votes)\n \n       before do\n         status.update(ordered_media_attachment_ids: nil)\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'does not create any edits' do\n@@ -271,7 +271,7 @@ def poll_option_json(name, votes)\n \n     context 'when originally without tags' do\n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'updates tags' do\n@@ -297,7 +297,7 @@ def poll_option_json(name, votes)\n       end\n \n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'updates tags' do\n@@ -307,7 +307,7 @@ def poll_option_json(name, votes)\n \n     context 'when originally without mentions' do\n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'updates mentions' do\n@@ -319,7 +319,7 @@ def poll_option_json(name, votes)\n       let(:mentions) { [alice, bob] }\n \n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'updates mentions' do\n@@ -330,7 +330,7 @@ def poll_option_json(name, votes)\n     context 'when originally without media attachments' do\n       before do\n         stub_request(:get, 'https://example.com/foo.png').to_return(body: attachment_fixture('emojo.png'))\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       let(:payload) do\n@@ -380,7 +380,7 @@ def poll_option_json(name, votes)\n \n       before do\n         allow(RedownloadMediaWorker).to receive(:perform_async)\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'updates the existing media attachment in-place' do\n@@ -408,7 +408,7 @@ def poll_option_json(name, votes)\n       before do\n         poll = Fabricate(:poll, status: status)\n         status.update(preloadable_poll: poll)\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'removes poll' do\n@@ -438,7 +438,7 @@ def poll_option_json(name, votes)\n       end\n \n       before do\n-        subject.call(status, json)\n+        subject.call(status, json, json)\n       end\n \n       it 'creates a poll' do\n@@ -454,12 +454,12 @@ def poll_option_json(name, votes)\n     end\n \n     it 'creates edit history' do\n-      subject.call(status, json)\n+      subject.call(status, json, json)\n       expect(status.edits.reload.map(&:text)).to eq ['Hello world', 'Hello universe']\n     end\n \n     it 'sets edited timestamp' do\n-      subject.call(status, json)\n+      subject.call(status, json, json)\n       expect(status.reload.edited_at.to_s).to eq '2021-09-08 22:39:25 UTC'\n     end\n   end\n---\n\n\n---\n\nChoice C:\nconfig/routes.rb\n@@ -142,7 +142,11 @@ def redirect_with_vary(path)\n \n   resource :inbox, only: [:create], module: :activitypub\n \n-  get '/:encoded_at(*path)', to: redirect('/@%{path}'), constraints: { encoded_at: /%40/ }\n+  constraints(encoded_path: /%40.*/) do\n+    get '/:encoded_path', to: redirect { |params|\n+      \"/#{params[:encoded_path].gsub('%40', '@')}\"\n+    }\n+  end\n \n   constraints(username: %r{[^@/.]+}) do\n     with_options to: 'accounts#show' do\n---\nspec/routing/accounts_routing_spec.rb\n@@ -47,6 +47,61 @@\n     end\n   end\n \n+  context 'with local username encoded at' do\n+    include RSpec::Rails::RequestExampleGroup\n+    let(:username) { 'alice' }\n+\n+    it 'routes /%40:username' do\n+      get \"/%40#{username}\"\n+      expect(response).to redirect_to(\"/@#{username}\")\n+    end\n+\n+    it 'routes /%40:username.json' do\n+      get(\"/%40#{username}.json\")\n+      expect(response).to redirect_to(\"/@#{username}.json\")\n+    end\n+\n+    it 'routes /%40:username.rss' do\n+      get(\"/%40#{username}.rss\")\n+      expect(response).to redirect_to(\"/@#{username}.rss\")\n+    end\n+\n+    it 'routes /%40:username/:id' do\n+      get(\"/%40#{username}/123\")\n+      expect(response).to redirect_to(\"/@#{username}/123\")\n+    end\n+\n+    it 'routes /%40:username/:id/embed' do\n+      get(\"/%40#{username}/123/embed\")\n+      expect(response).to redirect_to(\"/@#{username}/123/embed\")\n+    end\n+\n+    it 'routes /%40:username/following' do\n+      get(\"/%40#{username}/following\")\n+      expect(response).to redirect_to(\"/@#{username}/following\")\n+    end\n+\n+    it 'routes /%40:username/followers' do\n+      get(\"/%40#{username}/followers\")\n+      expect(response).to redirect_to(\"/@#{username}/followers\")\n+    end\n+\n+    it 'routes /%40:username/with_replies' do\n+      get(\"/%40#{username}/with_replies\")\n+      expect(response).to redirect_to(\"/@#{username}/with_replies\")\n+    end\n+\n+    it 'routes /%40:username/media' do\n+      get(\"/%40#{username}/media\")\n+      expect(response).to redirect_to(\"/@#{username}/media\")\n+    end\n+\n+    it 'routes /%40:username/tagged/:tag' do\n+      get(\"/%40#{username}/tagged/foo\")\n+      expect(response).to redirect_to(\"/@#{username}/tagged/foo\")\n+    end\n+  end\n+\n   context 'with remote username' do\n     let(:username) { 'alice@example.com' }\n \n@@ -82,4 +137,50 @@\n       expect(get(\"/@#{username}/tagged/foo\")).to route_to('home#index', username_with_domain: username, any: 'tagged/foo')\n     end\n   end\n+\n+  context 'with remote username encoded at' do\n+    include RSpec::Rails::RequestExampleGroup\n+    let(:username) { 'alice%40example.com' }\n+    let(:username_decoded) { 'alice@example.com' }\n+\n+    it 'routes /%40:username' do\n+      get(\"/%40#{username}\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}\")\n+    end\n+\n+    it 'routes /%40:username/:id' do\n+      get(\"/%40#{username}/123\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/123\")\n+    end\n+\n+    it 'routes /%40:username/:id/embed' do\n+      get(\"/%40#{username}/123/embed\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/123/embed\")\n+    end\n+\n+    it 'routes /%40:username/following' do\n+      get(\"/%40#{username}/following\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/following\")\n+    end\n+\n+    it 'routes /%40:username/followers' do\n+      get(\"/%40#{username}/followers\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/followers\")\n+    end\n+\n+    it 'routes /%40:username/with_replies' do\n+      get(\"/%40#{username}/with_replies\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/with_replies\")\n+    end\n+\n+    it 'routes /%40:username/media' do\n+      get(\"/%40#{username}/media\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/media\")\n+    end\n+\n+    it 'routes /%40:username/tagged/:tag' do\n+      get(\"/%40#{username}/tagged/foo\")\n+      expect(response).to redirect_to(\"/@#{username_decoded}/tagged/foo\")\n+    end\n+  end\n end\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -159,8 +159,8 @@\n .error-modal,\n .onboarding-modal,\n .compare-history-modal,\n-.report-modal__comment .setting-text__wrapper,\n-.report-modal__comment .setting-text,\n+.report-modal__comment,\n+.report-modal__comment,\n .announcements,\n .picture-in-picture__header,\n .picture-in-picture__footer,\n@@ -169,6 +169,11 @@\n   border: 1px solid var(--background-border-color);\n }\n \n+.setting-text__wrapper,\n+.setting-text {\n+  border: 1px solid var(--background-border-color);\n+}\n+\n .reactions-bar__item:hover,\n .reactions-bar__item:focus,\n .reactions-bar__item:active {\n@@ -198,14 +203,6 @@\n   color: $white;\n }\n \n-.report-modal__comment {\n-  border-right-color: lighten($ui-base-color, 8%);\n-}\n-\n-.report-modal__container {\n-  border-top-color: lighten($ui-base-color, 8%);\n-}\n-\n .column-settings__hashtags .column-select__option {\n   color: $white;\n }\n---\napp/javascript/styles/mastodon/components.scss\n@@ -3911,7 +3911,7 @@ $ui-header-logo-wordmark-width: 99px;\n \n   &__wrapper {\n     background: $white;\n-    border: 1px solid $ui-secondary-color;\n+    border: 1px solid var(--background-border-color);\n     margin-bottom: 10px;\n     border-radius: 4px;\n \n@@ -6298,9 +6298,10 @@ a.status-card {\n .report-modal,\n .actions-modal,\n .compare-history-modal {\n-  background: lighten($ui-secondary-color, 8%);\n-  color: $inverted-text-color;\n-  border-radius: 8px;\n+  background: var(--background-color);\n+  color: $primary-text-color;\n+  border-radius: 4px;\n+  border: 1px solid var(--background-border-color);\n   overflow: hidden;\n   max-width: 90vw;\n   width: 480px;\n@@ -6344,6 +6345,7 @@ a.status-card {\n .report-modal {\n   width: 90vw;\n   max-width: 700px;\n+  border: 1px solid var(--background-border-color);\n }\n \n .report-dialog-modal {\n@@ -6567,7 +6569,7 @@ a.status-card {\n \n .report-modal__container {\n   display: flex;\n-  border-top: 1px solid $ui-secondary-color;\n+  border-top: 1px solid var(--background-border-color);\n \n   @media screen and (width <= 480px) {\n     flex-wrap: wrap;\n@@ -6625,7 +6627,7 @@ a.status-card {\n \n .report-modal__comment {\n   padding: 20px;\n-  border-inline-end: 1px solid $ui-secondary-color;\n+  border-inline-end: 1px solid var(--background-border-color);\n   max-width: 320px;\n \n   p {\n@@ -6636,7 +6638,7 @@ a.status-card {\n \n   .setting-text-label {\n     display: block;\n-    color: $inverted-text-color;\n+    color: $secondary-text-color;\n     font-size: 14px;\n     font-weight: 500;\n     margin-bottom: 10px;\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. I moved Redis to another host, and edited my config in .env.production to point to the new host's IP.\r\n2. I created a weekly cron job to run _/home/mastodon/live/bin/tootctl media remove_\n\n### Expected behaviour\n\nI should get a weekly email from cron reporting how many media attachments were removed.\n\n### Actual behaviour\n\nMultiple errors in the report: Error connecting to Redis on localhost:6379\n\n### Detailed description\n\nAll other operations seem to run successfully. I have been successfully using this instance via the web interface and via Tusky, for several months.\r\n\r\nIf I sign in as my mastodon user (with _su - mastodon_), and run the _/home/mastodon/live/bin/tootctl media remove_ command manually, it works as expected and does not report any errors.\r\n\r\nIf cron runs that command (set up with _crontab -e_ while signed in as the mastodon user), I get the following output:\r\n`Progress: |Connection reset by peer\r\nError connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nError connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nSwitching object-storage-safely from green to red because Redis::CannotConnectError Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n==RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n=====RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n==RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n=====RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n=RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n====RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n===RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n=RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n==RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n==RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n====RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n===RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n====RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n==RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n=RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n===RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n====RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n=RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n==RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n==RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n===RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n=RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n==RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n==RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\nRedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n====RedisCacheStore: delete_entry failed, returned false: Redis::CannotConnectError: Error connecting to Redis on localhost:6379 (Errno::ECONNREFUSED)\r\n===|\r\nRemoved 42 media attachments (approx. 18.8 MB)`\r\n\r\nIf I run a simple _su mastodon_, and run _tootctl media remove_, then I get the same output as the cron job. \r\n\r\nFinally, if I set REDIS_HOST on the command line in cron, then it runs without error. Example entry:\r\n`$ crontab -l`\r\n`@weekly RAILS_ENV=production REDIS_HOST=172.31.5.239 /home/mastodon/live/bin/tootctl media remove`\n\n### Mastodon instance\n\nmastodon.monoceros.co.za\n\n### Mastodon version\n\nv4.1.6\n\n### Technical details\n\nOperating system: FreeBSD 13.2-RELEASE-p2\r\nRuby version: v3.0.6p216\r\nNode.js version: v16.20.1\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -2836,7 +2836,7 @@ $ui-header-logo-wordmark-width: 99px;\n   overflow: hidden;\n }\n \n-@media screen and (width >= 631px) {\n+@media screen and (width > $mobile-breakpoint) {\n   .columns-area {\n     padding: 0;\n   }\n@@ -5731,7 +5731,7 @@ a.status-card {\n   user-select: text;\n   display: flex;\n \n-  @media screen and (width <= 630px) {\n+  @media screen and (width <= $mobile-breakpoint) {\n     margin-top: auto;\n   }\n }\n@@ -6090,7 +6090,7 @@ a.status-card {\n     border-radius: 0 0 16px 16px;\n     border-top: 0;\n \n-    @media screen and (max-width: $no-gap-breakpoint) {\n+    @media screen and (max-width: $mobile-breakpoint) {\n       border-radius: 0;\n       border-bottom: 0;\n       padding-bottom: 32px;\n@@ -9092,8 +9092,9 @@ noscript {\n   backdrop-filter: var(--background-filter);\n   border: 1px solid var(--modal-border-color);\n   padding: 24px;\n+  box-sizing: border-box;\n \n-  @media screen and (max-width: $no-gap-breakpoint) {\n+  @media screen and (max-width: $mobile-breakpoint) {\n     border-radius: 16px 16px 0 0;\n     border-bottom: 0;\n     padding-bottom: 32px;\n---\napp/javascript/styles/mastodon/variables.scss\n@@ -88,6 +88,7 @@ $media-modal-media-max-width: 100%;\n $media-modal-media-max-height: 80%;\n \n $no-gap-breakpoint: 1175px;\n+$mobile-breakpoint: 630px;\n \n $font-sans-serif: 'mastodon-font-sans-serif' !default;\n $font-display: 'mastodon-font-display' !default;\n---\n\n\n---\n\nChoice B:\nlib/mastodon/redis_config.rb\n@@ -4,12 +4,23 @@ def setup_redis_env_url(prefix = nil, defaults = true)\n   prefix = \"#{prefix.to_s.upcase}_\" unless prefix.nil?\n   prefix = '' if prefix.nil?\n \n-  return if ENV[\"#{prefix}REDIS_URL\"].present?\n+  if ENV[\"#{prefix}REDIS_URL\"].present?\n+    address = Addressable::URI.parse(ENV[\"#{prefix}REDIS_URL\"])\n+    password = address.password\n+    host = address.host\n+    port = address.port\n+    db = address.path.delete_prefix('/')\n+  else\n+    password = ''\n+    host = 'localhost'\n+    port = 6379\n+    db = 0\n+  end\n \n-  password = ENV.fetch(\"#{prefix}REDIS_PASSWORD\") { '' if defaults }\n-  host     = ENV.fetch(\"#{prefix}REDIS_HOST\") { 'localhost' if defaults }\n-  port     = ENV.fetch(\"#{prefix}REDIS_PORT\") { 6379 if defaults }\n-  db       = ENV.fetch(\"#{prefix}REDIS_DB\") { 0 if defaults }\n+  password = ENV.fetch(\"#{prefix}REDIS_PASSWORD\") { password if defaults }\n+  host     = ENV.fetch(\"#{prefix}REDIS_HOST\") { host if defaults }\n+  port     = ENV.fetch(\"#{prefix}REDIS_PORT\") { port if defaults }\n+  db       = ENV.fetch(\"#{prefix}REDIS_DB\") { db if defaults }\n \n   ENV[\"#{prefix}REDIS_URL\"] = begin\n     if [password, host, port, db].all?(&:nil?)\n---\n\n\n---\n\nChoice C:\ndb/seeds/04_admin.rb\n@@ -7,5 +7,7 @@\n   admin = Account.where(username: 'admin').first_or_initialize(username: 'admin')\n   admin.save(validate: false)\n \n-  User.where(email: \"admin@#{domain}\").first_or_initialize(email: \"admin@#{domain}\", password: 'mastodonadmin', password_confirmation: 'mastodonadmin', confirmed_at: Time.now.utc, role: UserRole.find_by(name: 'Owner'), account: admin, agreement: true, approved: true).save!\n+  user = User.where(email: \"admin@#{domain}\").first_or_initialize(email: \"admin@#{domain}\", password: 'mastodonadmin', password_confirmation: 'mastodonadmin', confirmed_at: Time.now.utc, role: UserRole.find_by(name: 'Owner'), account: admin, agreement: true, approved: true)\n+  user.save!\n+  user.approve!\n end\n---\n\n\n---\n\nChoice D:\n.browserslistrc\n@@ -1,6 +1,7 @@\n [production]\n defaults\n > 0.2%\n+firefox >= 78\n ios >= 15.6\n not dead\n not OperaMini all\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. A post with trailing punctuation on a word (e.g. \"indexed publicly.\")\r\n2. Phrase search for the phrase _without_ the trailing punctuation (e.g. search for \"indexed publicly\")\r\n\n\n### Expected behaviour\n\nPost is found\n\n### Actual behaviour\n\nPost is not found unless you include the trailing punctuation in the search\n\n### Detailed description\n\nIt looks like when doing phrase search trailing punctuation on the words is required to match. This is very counterintuitive. If the search phrase includes trailing punctuation then it should be required, but if the search phrase doesn't have trailing punctuation it should still match posts that do have trailing punctuation.\r\n\r\nIn general, someone searching for a phrase has no idea if it appears at the end of a sentence or not.\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.2.0-beta2+pr-26657-fdd14a0\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/chewy/accounts_index.rb\n@@ -21,19 +21,20 @@ class AccountsIndex < Chewy::Index\n \n     analyzer: {\n       natural: {\n-        tokenizer: 'uax_url_email',\n+        tokenizer: 'standard',\n         filter: %w(\n-          english_possessive_stemmer\n           lowercase\n           asciifolding\n           cjk_width\n+          elision\n+          english_possessive_stemmer\n           english_stop\n           english_stemmer\n         ),\n       },\n \n       verbatim: {\n-        tokenizer: 'standard',\n+        tokenizer: 'uax_url_email',\n         filter: %w(lowercase asciifolding cjk_width),\n       },\n \n@@ -62,6 +63,6 @@ class AccountsIndex < Chewy::Index\n     field(:last_status_at, type: 'date', value: ->(account) { account.last_status_at || account.created_at })\n     field(:display_name, type: 'text', analyzer: 'verbatim') { field :edge_ngram, type: 'text', analyzer: 'edge_ngram', search_analyzer: 'verbatim' }\n     field(:username, type: 'text', analyzer: 'verbatim', value: ->(account) { [account.username, account.domain].compact.join('@') }) { field :edge_ngram, type: 'text', analyzer: 'edge_ngram', search_analyzer: 'verbatim' }\n-    field(:text, type: 'text', analyzer: 'whitespace', value: ->(account) { account.searchable_text }) { field :stemmed, type: 'text', analyzer: 'natural' }\n+    field(:text, type: 'text', analyzer: 'verbatim', value: ->(account) { account.searchable_text }) { field :stemmed, type: 'text', analyzer: 'natural' }\n   end\n end\n---\napp/chewy/public_statuses_index.rb\n@@ -20,13 +20,19 @@ class PublicStatusesIndex < Chewy::Index\n     },\n \n     analyzer: {\n-      content: {\n+      verbatim: {\n         tokenizer: 'uax_url_email',\n+        filter: %w(lowercase),\n+      },\n+\n+      content: {\n+        tokenizer: 'standard',\n         filter: %w(\n-          english_possessive_stemmer\n           lowercase\n           asciifolding\n           cjk_width\n+          elision\n+          english_possessive_stemmer\n           english_stop\n           english_stemmer\n         ),\n@@ -40,9 +46,9 @@ class PublicStatusesIndex < Chewy::Index\n                       .includes(:media_attachments, :preloadable_poll, :preview_cards)\n \n   root date_detection: false do\n-    field(:id, type: 'keyword')\n+    field(:id, type: 'long')\n     field(:account_id, type: 'long')\n-    field(:text, type: 'text', analyzer: 'whitespace', value: ->(status) { status.searchable_text }) { field(:stemmed, type: 'text', analyzer: 'content') }\n+    field(:text, type: 'text', analyzer: 'verbatim', value: ->(status) { status.searchable_text }) { field(:stemmed, type: 'text', analyzer: 'content') }\n     field(:language, type: 'keyword')\n     field(:properties, type: 'keyword', value: ->(status) { status.searchable_properties })\n     field(:created_at, type: 'date')\n---\napp/chewy/statuses_index.rb\n@@ -20,13 +20,19 @@ class StatusesIndex < Chewy::Index\n     },\n \n     analyzer: {\n-      content: {\n+      verbatim: {\n         tokenizer: 'uax_url_email',\n+        filter: %w(lowercase),\n+      },\n+\n+      content: {\n+        tokenizer: 'standard',\n         filter: %w(\n-          english_possessive_stemmer\n           lowercase\n           asciifolding\n           cjk_width\n+          elision\n+          english_possessive_stemmer\n           english_stop\n           english_stemmer\n         ),\n@@ -64,9 +70,9 @@ class StatusesIndex < Chewy::Index\n   end\n \n   root date_detection: false do\n-    field(:id, type: 'keyword')\n+    field(:id, type: 'long')\n     field(:account_id, type: 'long')\n-    field(:text, type: 'text', analyzer: 'whitespace', value: ->(status) { status.searchable_text }) { field(:stemmed, type: 'text', analyzer: 'content') }\n+    field(:text, type: 'text', analyzer: 'verbatim', value: ->(status) { status.searchable_text }) { field(:stemmed, type: 'text', analyzer: 'content') }\n     field(:searchable_by, type: 'long', value: ->(status, crutches) { status.searchable_by(crutches) })\n     field(:language, type: 'keyword')\n     field(:properties, type: 'keyword', value: ->(status) { status.searchable_properties })\n---\n\n\n---\n\nChoice B:\napp/models/media_attachment.rb\n@@ -172,7 +172,7 @@ class MediaAttachment < ApplicationRecord\n   DEFAULT_STYLES = [:original].freeze\n \n   GLOBAL_CONVERT_OPTIONS = {\n-    all: '-quality 90 +profile \"!icc,*\" +set modify-date +set create-date',\n+    all: '-quality 90 +profile \"!icc,*\" +set modify-date -define jpeg:dct-method=float +set create-date',\n   }.freeze\n \n   belongs_to :account,          inverse_of: :media_attachments, optional: true\n---\n\n\n---\n\nChoice C:\nlib/mastodon/redis_config.rb\n@@ -4,12 +4,23 @@ def setup_redis_env_url(prefix = nil, defaults = true)\n   prefix = \"#{prefix.to_s.upcase}_\" unless prefix.nil?\n   prefix = '' if prefix.nil?\n \n-  return if ENV[\"#{prefix}REDIS_URL\"].present?\n+  if ENV[\"#{prefix}REDIS_URL\"].present?\n+    address = Addressable::URI.parse(ENV[\"#{prefix}REDIS_URL\"])\n+    password = address.password\n+    host = address.host\n+    port = address.port\n+    db = address.path.delete_prefix('/')\n+  else\n+    password = ''\n+    host = 'localhost'\n+    port = 6379\n+    db = 0\n+  end\n \n-  password = ENV.fetch(\"#{prefix}REDIS_PASSWORD\") { '' if defaults }\n-  host     = ENV.fetch(\"#{prefix}REDIS_HOST\") { 'localhost' if defaults }\n-  port     = ENV.fetch(\"#{prefix}REDIS_PORT\") { 6379 if defaults }\n-  db       = ENV.fetch(\"#{prefix}REDIS_DB\") { 0 if defaults }\n+  password = ENV.fetch(\"#{prefix}REDIS_PASSWORD\") { password if defaults }\n+  host     = ENV.fetch(\"#{prefix}REDIS_HOST\") { host if defaults }\n+  port     = ENV.fetch(\"#{prefix}REDIS_PORT\") { port if defaults }\n+  db       = ENV.fetch(\"#{prefix}REDIS_DB\") { db if defaults }\n \n   ENV[\"#{prefix}REDIS_URL\"] = begin\n     if [password, host, port, db].all?(&:nil?)\n---\n\n\n---\n\nChoice D:\napp/lib/link_details_extractor.rb\n@@ -282,6 +282,6 @@ def detector\n   end\n \n   def html_entities\n-    @html_entities ||= HTMLEntities.new\n+    @html_entities ||= HTMLEntities.new(:expanded)\n   end\n end\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. upload a photograph with some ISO noise and large smooth areas\r\n2. observe vertical banding in the resulting image, frequently made worse when re-processed by a second server\r\n\r\n\r\n### Expected behaviour\r\n\r\nImage should not have vertical banding\r\n\r\n### Actual behaviour\r\n\r\nVisible degredation of image quality\r\n\r\n### Detailed description\r\n\r\nThere is an 8 pixel wide vertical striping effect on all images that are re-compressed on mastodon. In some images it is particularly visible, namely photographs with large smooth areas with a medium to large amount of ISO noise\r\n\r\n### Mastodon instance\r\n\r\nall\r\n\r\n### Mastodon version\r\n\r\nall that I've seen including latest\r\n\r\n### Technical details\r\n\r\nThis isn't something everyone can see easily without some prompting, so to verify the phenomena and eliminate my bias I performed quantitative analysis with an FFT using [this little program](https://github.com/electroCutie/vertical_banding) I put together\r\n\r\nIt takes the FFT in either the horizontal (default) or vertical (--transpose) axis for every line (or column) and then sums the complex output of the FFT (so not just magnitude but also phase).\r\nThis cancels out any non-correlated signal because the phases line to line will be largely uncorrelated and so will tend towards the noise floor. Any remaining value above the noise floor will be a feature of the image along the axis orthogonal to the axis of the FFT.\r\n\r\nThe program spits a few thousands lines with the wavelength and the normalized magnitude of the FFT sum at that wavelength. This can be plotted with GNU Plot or any office software.\r\nMy gnu plot command is `plot \"fft.xy\" with lines`\r\n\r\nTo save you the trouble of running it here are the results from a random image (first example below) taken from the hashtag photography timeline, zoomed in to the area of the plot which shows the banding signal\r\n![image](https://github.com/mastodon/mastodon/assets/26614496/651d398a-ab3f-41dd-8b78-46c7481dba93)\r\n> Note the extremely large spike at the 8 pixel wavelength, that is the vertical banding\r\n\r\nMost images show something similar. A prominent spike at the 8 pixel wavelength. For me this is a frequently visible visual defect and it gets worse when the image is transferred to a new server and re-encoded. There is no such spike in the other axis.\r\n\r\nSome examples from the photography hashtag\r\nhttps://sfba.social/@pinskal/110955776597892946\r\nhttps://mstdn.social/@bryanhansel/110953023808476859\r\nhttps://chaos.social/@kernpanik/110952673882054199\r\n\r\n(please do not contact these users, I merely grabbed a few examples from the photography hashtag)\r\n\r\nI've tracked down the bug to an image-magick behavior and reproduced this error with the image-magick command line tool and even in the GnuIMP program. The error is caused by a slight bias in the DCT method called \"Fast Integer\" in GnuIMP or just \"fastest\" in image-magick\r\n\r\nConfusingly in image-magick the default is \"fastest\" and **not** the so-called \"default\" DCT method (in GnuIMP called the Integer method)\r\n\r\nWe can ask image-magick to use the integer (or even better the floating point) method by adding a command line option \r\n`-define jpeg:dct-method=default`\r\nor\r\n`-define jpeg:dct-method=`\r\n\r\nI've identified a location in the mastodon source code where this fix may be applied but I am not well versed in the mastodon codebase and so I'll make a pull request attached to this bug report and ask someone that both knows the codebase and can test it check it for me.\n\n---\n\nChoice A:\napp/models/media_attachment.rb\n@@ -172,7 +172,7 @@ class MediaAttachment < ApplicationRecord\n   DEFAULT_STYLES = [:original].freeze\n \n   GLOBAL_CONVERT_OPTIONS = {\n-    all: '-quality 90 +profile \"!icc,*\" +set modify-date +set create-date',\n+    all: '-quality 90 +profile \"!icc,*\" +set modify-date -define jpeg:dct-method=float +set create-date',\n   }.freeze\n \n   belongs_to :account,          inverse_of: :media_attachments, optional: true\n---\n\n\n---\n\nChoice B:\napp/lib/video_metadata_extractor.rb\n@@ -22,7 +22,7 @@ def valid?\n   private\n \n   def ffmpeg_command_output\n-    command = Terrapin::CommandLine.new('ffprobe', '-i :path -print_format :format -show_format -show_streams -show_error -loglevel :loglevel')\n+    command = Terrapin::CommandLine.new(Rails.configuration.x.ffprobe_binary, '-i :path -print_format :format -show_format -show_streams -show_error -loglevel :loglevel')\n     command.run(path: @path, format: 'json', loglevel: 'fatal')\n   end\n \n---\nconfig/initializers/ffmpeg.rb\n@@ -1,5 +1,6 @@\n # frozen_string_literal: true\n \n-if ENV['FFMPEG_BINARY'].present?\n-  FFMPEG.ffmpeg_binary = ENV['FFMPEG_BINARY']\n+Rails.application.configure do\n+  config.x.ffmpeg_binary = ENV['FFMPEG_BINARY'] || 'ffmpeg'\n+  config.x.ffprobe_binary = ENV['FFPROBE_BINARY'] || 'ffprobe'\n end\n---\nlib/paperclip/image_extractor.rb\n@@ -35,7 +35,7 @@ def extract_image_from_file!\n       dst.binmode\n \n       begin\n-        command = Terrapin::CommandLine.new('ffmpeg', '-i :source -loglevel :loglevel -y :destination', logger: Paperclip.logger)\n+        command = Terrapin::CommandLine.new(Rails.configuration.x.ffmpeg_binary, '-i :source -loglevel :loglevel -y :destination', logger: Paperclip.logger)\n         command.run(source: @file.path, destination: dst.path, loglevel: 'fatal')\n       rescue Terrapin::ExitStatusError\n         dst.close(true)\n---\nlib/paperclip/transcoder.rb\n@@ -61,7 +61,7 @@ def make\n       command_arguments, interpolations = prepare_command(destination)\n \n       begin\n-        command = Terrapin::CommandLine.new('ffmpeg', command_arguments.join(' '), logger: Paperclip.logger)\n+        command = Terrapin::CommandLine.new(Rails.configuration.x.ffmpeg_binary, command_arguments.join(' '), logger: Paperclip.logger)\n         command.run(interpolations)\n       rescue Terrapin::ExitStatusError => e\n         raise Paperclip::Error, \"Error while transcoding #{@basename}: #{e}\"\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/reducers/compose.js\n@@ -402,7 +402,7 @@ export default function compose(state = initialState, action) {\n       .set('isUploadingThumbnail', false)\n       .update('media_attachments', list => list.map(item => {\n         if (item.get('id') === action.media.id) {\n-          return fromJS(action.media);\n+          return fromJS(action.media).set('unattached', item.get('unattached'));\n         }\n \n         return item;\n---\n\n\n---\n\nChoice D:\napp/controllers/well_known/host_meta_controller.rb\n@@ -7,7 +7,23 @@ class HostMetaController < ActionController::Base # rubocop:disable Rails/Applic\n     def show\n       @webfinger_template = \"#{webfinger_url}?resource={uri}\"\n       expires_in 3.days, public: true\n-      render content_type: 'application/xrd+xml', formats: [:xml]\n+\n+      respond_to do |format|\n+        format.any do\n+          render content_type: 'application/xrd+xml', formats: [:xml]\n+        end\n+\n+        format.json do\n+          render json: {\n+            links: [\n+              {\n+                rel: 'lrdd',\n+                template: @webfinger_template,\n+              },\n+            ],\n+          }\n+        end\n+      end\n     end\n   end\n end\n---\nconfig/routes.rb\n@@ -67,7 +67,7 @@ def redirect_with_vary(path)\n   scope path: '.well-known' do\n     scope module: :well_known do\n       get 'oauth-authorization-server', to: 'oauth_metadata#show', as: :oauth_metadata, defaults: { format: 'json' }\n-      get 'host-meta', to: 'host_meta#show', as: :host_meta, defaults: { format: 'xml' }\n+      get 'host-meta', to: 'host_meta#show', as: :host_meta\n       get 'nodeinfo', to: 'node_info#index', as: :nodeinfo, defaults: { format: 'json' }\n       get 'webfinger', to: 'webfinger#show', as: :webfinger\n     end\n---\nspec/requests/well_known/host_meta_spec.rb\n@@ -9,19 +9,39 @@\n     expect(response)\n       .to have_http_status(200)\n       .and have_attributes(\n-        media_type: 'application/xrd+xml',\n-        body: host_meta_xml_template\n+        media_type: 'application/xrd+xml'\n+      )\n+\n+    doc = Nokogiri::XML(response.parsed_body)\n+    expect(doc.at_xpath('/xrd:XRD/xrd:Link[@rel=\"lrdd\"]/@template', 'xrd' => 'http://docs.oasis-open.org/ns/xri/xrd-1.0').value)\n+      .to eq 'https://cb6e6126.ngrok.io/.well-known/webfinger?resource={uri}'\n+  end\n+\n+  it 'returns http success with valid JSON response with .json extension' do\n+    get '/.well-known/host-meta.json'\n+\n+    expect(response)\n+      .to have_http_status(200)\n+      .and have_attributes(\n+        media_type: 'application/json'\n+      )\n+\n+    expect(response.parsed_body)\n+      .to include(\n+        links: [\n+          'rel' => 'lrdd',\n+          'template' => 'https://cb6e6126.ngrok.io/.well-known/webfinger?resource={uri}',\n+        ]\n       )\n   end\n \n-  private\n+  it 'returns http success with valid JSON response with Accept header' do\n+    get '/.well-known/host-meta', headers: { 'Accept' => 'application/json' }\n \n-  def host_meta_xml_template\n-    <<~XML\n-      <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n-      <XRD xmlns=\"http://docs.oasis-open.org/ns/xri/xrd-1.0\">\n-        <Link rel=\"lrdd\" template=\"https://cb6e6126.ngrok.io/.well-known/webfinger?resource={uri}\"/>\n-      </XRD>\n-    XML\n+    expect(response)\n+      .to have_http_status(200)\n+      .and have_attributes(\n+        media_type: 'application/json'\n+      )\n   end\n end\n---\nspec/routing/well_known_routes_spec.rb\n@@ -4,9 +4,14 @@\n \n RSpec.describe 'Well Known routes' do\n   describe 'the host-meta route' do\n-    it 'routes to correct place with xml format' do\n+    it 'routes to correct place' do\n       expect(get('/.well-known/host-meta'))\n-        .to route_to('well_known/host_meta#show', format: 'xml')\n+        .to route_to('well_known/host_meta#show')\n+    end\n+\n+    it 'routes to correct place with json format' do\n+      expect(get('/.well-known/host-meta.json'))\n+        .to route_to('well_known/host_meta#show', format: 'json')\n     end\n   end\n \n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Compose a new post with a content warning and a hashtag on the last line\r\n2. Publish the post\r\n3. When you view the post collapsed (default when viewing posts with content warnings) the regular content is hidden, but the hashtag is not.\r\n\r\n![afbeelding](https://github.com/mastodon/mastodon/assets/41594439/f4de532f-0025-4612-a3f2-3df7c85a1c22)\r\n\r\n### Expected behaviour\r\n\r\nHashtags in a post with content warnings should be part of the hidden post content, because hashtags mostly have the same issues as the text or media content (think especially about NSFW content here). _Edit: I think the easiest way to fix this is is to disable out-of-band hashtags for CW posts all together._\r\n\r\n### Actual behaviour\r\n\r\nHashtag is shown as out-of-band, like regular posts\r\n\r\n### Mastodon instance\r\n\r\nmastodon.social\r\n\r\n### Mastodon version\r\n\r\nv4.2.0+nightly-2023-08-22\r\n\r\n### Browser name and version\r\n\r\nFirefox 116.0.3\r\n\r\n### Operating system\r\n\r\nUbuntu 23.04\r\n\r\n\n\n---\n\nChoice A:\napp/javascript/mastodon/components/hashtag_bar.jsx\n@@ -0,0 +1,50 @@\n+import PropTypes from 'prop-types';\n+import { useMemo, useState, useCallback } from 'react';\n+\n+import { FormattedMessage } from 'react-intl';\n+\n+import { Link } from 'react-router-dom';\n+\n+import ImmutablePropTypes from 'react-immutable-proptypes';\n+\n+const domParser = new DOMParser();\n+\n+// About two lines on desktop\n+const VISIBLE_HASHTAGS = 7;\n+\n+export const HashtagBar = ({ hashtags, text }) => {\n+  const renderedHashtags = useMemo(() => {\n+    const body = domParser.parseFromString(text, 'text/html').documentElement;\n+    return [].map.call(body.querySelectorAll('[rel=tag]'), node => node.textContent.toLowerCase());\n+  }, [text]);\n+\n+  const invisibleHashtags = useMemo(() => (\n+    hashtags.filter(hashtag => !renderedHashtags.some(textContent => textContent === `#${hashtag.get('name')}` || textContent === hashtag.get('name')))\n+  ), [hashtags, renderedHashtags]);\n+\n+  const [expanded, setExpanded] = useState(false);\n+  const handleClick = useCallback(() => setExpanded(true), []);\n+\n+  if (invisibleHashtags.isEmpty()) {\n+    return null;\n+  }\n+\n+  const revealedHashtags = expanded ? invisibleHashtags : invisibleHashtags.take(VISIBLE_HASHTAGS);\n+\n+  return (\n+    <div className='hashtag-bar'>\n+      {revealedHashtags.map(hashtag => (\n+        <Link key={hashtag.get('name')} to={`/tags/${hashtag.get('name')}`}>\n+          #{hashtag.get('name')}\n+        </Link>\n+      ))}\n+\n+      {!expanded && invisibleHashtags.size > VISIBLE_HASHTAGS && <button className='link-button' onClick={handleClick}><FormattedMessage id='hashtags.and_other' defaultMessage='\u2026and {count, plural, other {# more}}' values={{ count: invisibleHashtags.size - VISIBLE_HASHTAGS }} /></button>}\n+    </div>\n+  );\n+};\n+\n+HashtagBar.propTypes = {\n+  hashtags: ImmutablePropTypes.list,\n+  text: PropTypes.string,\n+};\n\\ No newline at end of file\n---\napp/javascript/mastodon/components/status.jsx\n@@ -22,6 +22,7 @@ import { displayMedia } from '../initial_state';\n import { Avatar } from './avatar';\n import { AvatarOverlay } from './avatar_overlay';\n import { DisplayName } from './display_name';\n+import { HashtagBar } from './hashtag_bar';\n import { RelativeTimestamp } from './relative_timestamp';\n import StatusActionBar from './status_action_bar';\n import StatusContent from './status_content';\n@@ -580,6 +581,8 @@ class Status extends ImmutablePureComponent {\n \n             {media}\n \n+            <HashtagBar hashtags={status.get('tags')} text={status.get('content')} />\n+\n             <StatusActionBar scrollKey={scrollKey} status={status} account={account} onFilter={matchedFilters ? this.handleFilterClick : null} {...other} />\n           </div>\n         </div>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -10,6 +10,7 @@ import ImmutablePureComponent from 'react-immutable-pure-component';\n \n import { AnimatedNumber } from 'mastodon/components/animated_number';\n import EditedTimestamp from 'mastodon/components/edited_timestamp';\n+import { HashtagBar } from 'mastodon/components/hashtag_bar';\n import { Icon }  from 'mastodon/components/icon';\n import PictureInPicturePlaceholder from 'mastodon/components/picture_in_picture_placeholder';\n \n@@ -314,6 +315,8 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           {media}\n \n+          <HashtagBar hashtags={status.get('tags')} text={status.get('content')} />\n+\n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n               <FormattedDate value={new Date(status.get('created_at'))} hour12={false} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n---\napp/javascript/mastodon/locales/en.json\n@@ -300,6 +300,7 @@\n   \"hashtag.counter_by_uses_today\": \"{count, plural, one {{counter} post} other {{counter} posts}} today\",\n   \"hashtag.follow\": \"Follow hashtag\",\n   \"hashtag.unfollow\": \"Unfollow hashtag\",\n+  \"hashtags.and_other\": \"\u2026and {count, plural, other {# more}}\",\n   \"home.actions.go_to_explore\": \"See what's trending\",\n   \"home.actions.go_to_suggestions\": \"Find people to follow\",\n   \"home.column_settings.basic\": \"Basic\",\n---\napp/javascript/styles/mastodon/components.scss\n@@ -9256,3 +9256,26 @@ noscript {\n     }\n   }\n }\n+\n+.hashtag-bar {\n+  margin-top: 16px;\n+  display: flex;\n+  flex-wrap: wrap;\n+  font-size: 14px;\n+  gap: 4px;\n+\n+  a {\n+    display: inline-flex;\n+    border-radius: 4px;\n+    background: rgba($highlight-text-color, 0.2);\n+    color: $highlight-text-color;\n+    padding: 0.4em 0.6em;\n+    text-decoration: none;\n+\n+    &:hover,\n+    &:focus,\n+    &:active {\n+      background: rgba($highlight-text-color, 0.3);\n+    }\n+  }\n+}\n---\napp/javascript/mastodon/components/status.jsx\n@@ -546,6 +546,7 @@ class Status extends ImmutablePureComponent {\n     const visibilityIcon = visibilityIconInfo[status.get('visibility')];\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n+    const expanded = !status.get('hidden')\n \n     return (\n       <HotKeys handlers={handlers}>\n@@ -574,7 +575,7 @@ class Status extends ImmutablePureComponent {\n             <StatusContent\n               status={status}\n               onClick={this.handleClick}\n-              expanded={!status.get('hidden')}\n+              expanded={expanded}\n               onExpandedToggle={this.handleExpandedToggle}\n               onTranslate={this.handleTranslate}\n               collapsible\n@@ -584,7 +585,7 @@ class Status extends ImmutablePureComponent {\n \n             {media}\n \n-            {hashtagBar}\n+            {expanded && hashtagBar}\n \n             <StatusActionBar scrollKey={scrollKey} status={status} account={account} onFilter={matchedFilters ? this.handleFilterClick : null} {...other} />\n           </div>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -293,6 +293,7 @@ class DetailedStatus extends ImmutablePureComponent {\n     }\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n+    const expanded = !status.get('hidden')\n \n     return (\n       <div style={outerStyle}>\n@@ -318,7 +319,7 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           {media}\n \n-          {hashtagBar}\n+          {expanded && hashtagBar}\n \n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n---\n\n\n---\n\nChoice B:\nlib/mastodon/cli/search.rb\n@@ -100,6 +100,14 @@ def deploy\n       progress.finish\n \n       say(\"Indexed #{added} records, de-indexed #{removed}\", :green, true)\n+    rescue Elasticsearch::Transport::Transport::ServerError => e\n+      fail_with_message <<~ERROR\n+        There was an issue connecting to the search server. Make sure the\n+        server is configured and running correctly, and that the environment\n+        variable settings match what the server is expecting.\n+\n+        #{e.message}\n+      ERROR\n     end\n \n     private\n---\nspec/lib/mastodon/cli/search_spec.rb\n@@ -33,6 +33,17 @@\n       end\n     end\n \n+    context 'when server communication raises an error' do\n+      let(:options) { { reset_chewy: true } }\n+\n+      before { allow(Chewy::Stash::Specification).to receive(:reset!).and_raise(Elasticsearch::Transport::Transport::Errors::InternalServerError) }\n+\n+      it 'Exits with error message' do\n+        expect { subject }\n+          .to raise_error(Thor::Error, /issue connecting to the search/)\n+      end\n+    end\n+\n     context 'without options' do\n       before { stub_search_indexes }\n \n---\n\n\n---\n\nChoice C:\napp/lib/feed_manager.rb\n@@ -558,7 +558,7 @@ def build_crutches(receiver_id, statuses)\n       arr = crutches[:active_mentions][s.id] || []\n       arr.push(s.account_id)\n \n-      if s.reblog?\n+      if s.reblog? && s.reblog.present?\n         arr.push(s.reblog.account_id)\n         arr.concat(crutches[:active_mentions][s.reblog_of_id] || [])\n       end\n---\n\n\n---\n\nChoice D:\napp/models/tag.rb\n@@ -35,7 +35,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?:^|[^/)\\w])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)[:word]])#(#{HASHTAG_NAME_PAT})}i\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/tag_spec.rb\n@@ -32,52 +32,56 @@\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)#Lawsuit')).to be_nil\n     end\n \n+    it 'does not match URLs with hashtag-like anchors after an empty query parameter' do\n+      expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)?foo=#Lawsuit')).to be_nil\n+    end\n+\n     it 'matches \ufeff#\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43' do\n-      expect(subject.match('\ufeffthis is #\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43').to_s).to eq ' #\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43'\n+      expect(subject.match('\ufeffthis is #\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43').to_s).to eq '#\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43'\n     end\n \n     it 'matches digits at the start' do\n-      expect(subject.match('hello #3d').to_s).to eq ' #3d'\n+      expect(subject.match('hello #3d').to_s).to eq '#3d'\n     end\n \n     it 'matches digits in the middle' do\n-      expect(subject.match('hello #l33ts35k').to_s).to eq ' #l33ts35k'\n+      expect(subject.match('hello #l33ts35k').to_s).to eq '#l33ts35k'\n     end\n \n     it 'matches digits at the end' do\n-      expect(subject.match('hello #world2016').to_s).to eq ' #world2016'\n+      expect(subject.match('hello #world2016').to_s).to eq '#world2016'\n     end\n \n     it 'matches underscores at the beginning' do\n-      expect(subject.match('hello #_test').to_s).to eq ' #_test'\n+      expect(subject.match('hello #_test').to_s).to eq '#_test'\n     end\n \n     it 'matches underscores at the end' do\n-      expect(subject.match('hello #test_').to_s).to eq ' #test_'\n+      expect(subject.match('hello #test_').to_s).to eq '#test_'\n     end\n \n     it 'matches underscores in the middle' do\n-      expect(subject.match('hello #one_two_three').to_s).to eq ' #one_two_three'\n+      expect(subject.match('hello #one_two_three').to_s).to eq '#one_two_three'\n     end\n \n     it 'matches middle dots' do\n-      expect(subject.match('hello #one\u00b7two\u00b7three').to_s).to eq ' #one\u00b7two\u00b7three'\n+      expect(subject.match('hello #one\u00b7two\u00b7three').to_s).to eq '#one\u00b7two\u00b7three'\n     end\n \n     it 'matches \u30fbunicode in \u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f correctly' do\n-      expect(subject.match('testing #\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f').to_s).to eq ' #\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f'\n+      expect(subject.match('testing #\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f').to_s).to eq '#\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f'\n     end\n \n     it 'matches ZWNJ' do\n-      expect(subject.match('just add #\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631 and').to_s).to eq ' #\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631'\n+      expect(subject.match('just add #\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631 and').to_s).to eq '#\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631'\n     end\n \n     it 'does not match middle dots at the start' do\n       expect(subject.match('hello #\u00b7one\u00b7two\u00b7three')).to be_nil\n     end\n \n     it 'does not match middle dots at the end' do\n-      expect(subject.match('hello #one\u00b7two\u00b7three\u00b7').to_s).to eq ' #one\u00b7two\u00b7three'\n+      expect(subject.match('hello #one\u00b7two\u00b7three\u00b7').to_s).to eq '#one\u00b7two\u00b7three'\n     end\n \n     it 'does not match purely-numeric hashtags' do\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Upgrade mastodon from v4.2.0-beta1 to v4.2.0-beta2\r\n2. Login and open Admin-Dashboard -> Something went wrong\r\n\r\n\r\n\r\n\n\n### Expected behaviour\n\nAdmin-Dashboard should open\n\n### Actual behaviour\n\nSomething went wrong\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nmastodontech.de\n\n### Mastodon version\n\nv4.2.0-beta2\n\n### Browser name and version\n\nFirefox 116.0.3 (64-Bit\n\n### Operating system\n\nWindows 11\n\n### Technical details\n\nsyslog:\r\n\r\n```\r\nAug 22 10:52:28 web247 bundle[1029719]: I, [2023-08-22T10:52:28.997116 #1029719]  INFO -- : [7a6a2fbd-983b-4c06-8341-55cccb0c0576] method=GET path=/admin/dashboard format=html controller=Admin::DashboardController action=index status=500 allocations=40429 duration=77.51 view=0.00 db=15.66\r\nAug 22 10:52:28 web247 bundle[1029719]: F, [2023-08-22T10:52:28.997778 #1029719] FATAL -- : [7a6a2fbd-983b-4c06-8341-55cccb0c0576]\r\nAug 22 10:52:28 web247 bundle[1029719]: [7a6a2fbd-983b-4c06-8341-55cccb0c0576] NoMethodError (undefined method `dig' for nil:NilClass):\r\nAug 22 10:52:28 web247 bundle[1029719]: [7a6a2fbd-983b-4c06-8341-55cccb0c0576]\r\nAug 22 10:52:28 web247 bundle[1029719]: [7a6a2fbd-983b-4c06-8341-55cccb0c0576] app/lib/admin/system_check/elasticsearch_check.rb:44:in `message'\r\nAug 22 10:52:28 web247 bundle[1029719]: [7a6a2fbd-983b-4c06-8341-55cccb0c0576] app/lib/admin/system_check.rb:19:in `block in perform'\r\nAug 22 10:52:28 web247 bundle[1029719]: [7a6a2fbd-983b-4c06-8341-55cccb0c0576] app/lib/admin/system_check.rb:13:in `each'\r\nAug 22 10:52:28 web247 bundle[1029719]: [7a6a2fbd-983b-4c06-8341-55cccb0c0576] app/lib/admin/system_check.rb:13:in `each_with_object'\r\nAug 22 10:52:28 web247 bundle[1029719]: [7a6a2fbd-983b-4c06-8341-55cccb0c0576] app/lib/admin/system_check.rb:13:in `perform'\r\nAug 22 10:52:28 web247 bundle[1029719]: [7a6a2fbd-983b-4c06-8341-55cccb0c0576] app/controllers/admin/dashboard_controller.rb:10:in `index'\r\nAug 22 10:52:28 web247 bundle[1029719]: [7a6a2fbd-983b-4c06-8341-55cccb0c0576] app/controllers/concerns/localized.rb:11:in `set_locale'\r\nAug 22 10:52:28 web247 bundle[1029719]: [7a6a2fbd-983b-4c06-8341-55cccb0c0576] lib/mastodon/rack_middleware.rb:9:in `call'\r\n```\n\n---\n\nChoice A:\nlib/mastodon/cli/search.rb\n@@ -100,6 +100,14 @@ def deploy\n       progress.finish\n \n       say(\"Indexed #{added} records, de-indexed #{removed}\", :green, true)\n+    rescue Elasticsearch::Transport::Transport::ServerError => e\n+      fail_with_message <<~ERROR\n+        There was an issue connecting to the search server. Make sure the\n+        server is configured and running correctly, and that the environment\n+        variable settings match what the server is expecting.\n+\n+        #{e.message}\n+      ERROR\n     end\n \n     private\n---\nspec/lib/mastodon/cli/search_spec.rb\n@@ -33,6 +33,17 @@\n       end\n     end\n \n+    context 'when server communication raises an error' do\n+      let(:options) { { reset_chewy: true } }\n+\n+      before { allow(Chewy::Stash::Specification).to receive(:reset!).and_raise(Elasticsearch::Transport::Transport::Errors::InternalServerError) }\n+\n+      it 'Exits with error message' do\n+        expect { subject }\n+          .to raise_error(Thor::Error, /issue connecting to the search/)\n+      end\n+    end\n+\n     context 'without options' do\n       before { stub_search_indexes }\n \n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/components/status.jsx\n@@ -546,7 +546,7 @@ class Status extends ImmutablePureComponent {\n     const visibilityIcon = visibilityIconInfo[status.get('visibility')];\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n-    const expanded = !status.get('hidden')\n+    const expanded = !status.get('hidden') || status.get('spoiler_text').length === 0;\n \n     return (\n       <HotKeys handlers={handlers}>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -293,7 +293,7 @@ class DetailedStatus extends ImmutablePureComponent {\n     }\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n-    const expanded = !status.get('hidden')\n+    const expanded = !status.get('hidden') || status.get('spoiler_text').length === 0;\n \n     return (\n       <div style={outerStyle}>\n---\n\n\n---\n\nChoice C:\napp/lib/admin/system_check/elasticsearch_check.rb\n@@ -41,7 +41,7 @@ def message\n       Admin::SystemCheck::Message.new(:elasticsearch_health_red)\n     elsif cluster_health['number_of_nodes'] < 2 && es_preset != 'single_node_cluster'\n       Admin::SystemCheck::Message.new(:elasticsearch_preset_single_node, nil, 'https://docs.joinmastodon.org/admin/optional/elasticsearch/#scaling')\n-    elsif Chewy.client.indices.get_settings['chewy_specifications'].dig('settings', 'index', 'number_of_replicas')&.to_i&.positive? && es_preset == 'single_node_cluster'\n+    elsif Chewy.client.indices.get_settings[Chewy::Stash::Specification.index_name]&.dig('settings', 'index', 'number_of_replicas')&.to_i&.positive? && es_preset == 'single_node_cluster'\n       Admin::SystemCheck::Message.new(:elasticsearch_reset_chewy)\n     elsif cluster_health['status'] == 'yellow'\n       Admin::SystemCheck::Message.new(:elasticsearch_health_yellow)\n---\napp/lib/admin/system_check/elasticsearch_check.rb\n@@ -41,7 +41,7 @@ def message\n       Admin::SystemCheck::Message.new(:elasticsearch_health_red)\n     elsif cluster_health['number_of_nodes'] < 2 && es_preset != 'single_node_cluster'\n       Admin::SystemCheck::Message.new(:elasticsearch_preset_single_node, nil, 'https://docs.joinmastodon.org/admin/optional/elasticsearch/#scaling')\n-    elsif Chewy.client.indices.get_settings['chewy_specifications'].dig('settings', 'index', 'number_of_replicas')&.to_i&.positive? && es_preset == 'single_node_cluster'\n+    elsif Chewy.client.indices.get_settings[Chewy::Stash::Specification.index_name]&.dig('settings', 'index', 'number_of_replicas')&.to_i&.positive? && es_preset == 'single_node_cluster'\n       Admin::SystemCheck::Message.new(:elasticsearch_reset_chewy)\n     elsif cluster_health['status'] == 'yellow'\n       Admin::SystemCheck::Message.new(:elasticsearch_health_yellow)\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/components/dropdown_menu.jsx\n@@ -257,7 +257,7 @@ class Dropdown extends PureComponent {\n   };\n \n   findTarget = () => {\n-    return this.target?.buttonRef?.current;\n+    return this.target?.buttonRef?.current ?? this.target;\n   };\n \n   componentWillUnmount = () => {\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Run v4.2.0-beta2 in Docker\r\n\n\n### Expected behaviour\n\nShows version as v4.2.0-beta2\n\n### Actual behaviour\n\nShows version as v4.2.0\n\n### Detailed description\n\nIt seems Dockerfile's default MASTODON_VERSION_FLAGS=\"\" override default value.\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\nv4.2.0-beta2\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/lib/activitypub/activity/create.rb\n@@ -336,13 +336,15 @@ def resolve_thread(status)\n \n   def fetch_replies(status)\n     collection = @object['replies']\n-    return if collection.nil?\n+    return if collection.blank?\n \n     replies = ActivityPub::FetchRepliesService.new.call(status, collection, allow_synchronous_requests: false, request_id: @options[:request_id])\n     return unless replies.nil?\n \n     uri = value_or_id(collection)\n     ActivityPub::FetchRepliesWorker.perform_async(status.id, uri, { 'request_id' => @options[:request_id] }) unless uri.nil?\n+  rescue => e\n+    Rails.logger.warn \"Error fetching replies: #{e}\"\n   end\n \n   def conversation_from_uri(uri)\n---\n\n\n---\n\nChoice B:\nlib/mastodon/version.rb\n@@ -17,7 +17,7 @@ def patch\n     end\n \n     def flags\n-      ENV.fetch('MASTODON_VERSION_FLAGS', '-beta2')\n+      ENV['MASTODON_VERSION_FLAGS'].presence || '-beta2'\n     end\n \n     def suffix\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -6437,7 +6437,7 @@ a.status-card {\n   }\n \n   .dialog-option .poll__input {\n-    border-color: $inverted-text-color;\n+    border-color: $darker-text-color;\n     color: $ui-secondary-color;\n     display: inline-flex;\n     align-items: center;\n@@ -6451,13 +6451,13 @@ a.status-card {\n     &:active,\n     &:focus,\n     &:hover {\n-      border-color: lighten($inverted-text-color, 15%);\n+      border-color: $valid-value-color;\n       border-width: 4px;\n     }\n \n     &.active {\n-      border-color: $inverted-text-color;\n-      background: $inverted-text-color;\n+      border-color: $valid-value-color;\n+      background: $valid-value-color;\n     }\n   }\n \n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/reducers/notifications.js\n@@ -281,7 +281,7 @@ export default function notifications(state = initialState, action) {\n   case blockAccountSuccess.type:\n     return filterNotifications(state, [action.payload.relationship.id]);\n   case muteAccountSuccess.type:\n-    return action.relationship.muting_notifications ? filterNotifications(state, [action.payload.relationship.id]) : state;\n+    return action.payload.relationship.muting_notifications ? filterNotifications(state, [action.payload.relationship.id]) : state;\n   case blockDomainSuccess.type:\n     return filterNotifications(state, action.payload.accounts);\n   case authorizeFollowRequestSuccess.type:\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Upgrade to v4.2.0-beta2\r\n2. Restart Mastodon services\r\n3. Access any page via web interface\r\n4. \"Something went wrong\" error\r\n\r\n\r\n### Expected behaviour\r\n\r\nPages loading just fine\r\n\r\n### Actual behaviour\r\n\r\n\"Something went wrong\" error\r\n\r\n### Detailed description\r\n\r\nAfter upgrading from `v4.2.0-beta1` to `4.2.0-beta2`, the web interface broke. Any page the users try to load in the frontend results in errors and the browser even freezes quickly. The backend, like `/settings/*`, is fine.\r\n\r\nLooking at the browser console, there are errors like these:\r\n\r\n- [1. chrome-console-explore-logged-in.txt](https://github.com/mastodon/mastodon/files/12403152/1.chrome-console-explore-logged-in.txt)\r\n- [2. chrome-console-live-feeds-incognito.log](https://github.com/mastodon/mastodon/files/12403154/2.chrome-console-live-feeds-incognito.log)\r\n- [1. firefox-console-live-feeds-incognito.txt](https://github.com/mastodon/mastodon/files/12403153/1.firefox-console-live-feeds-incognito.txt)\r\n- [2. firefox-console-explore-logged-in.txt](https://github.com/mastodon/mastodon/files/12403155/2.firefox-console-explore-logged-in.txt)\r\n\r\nThis happens with or without `CDN_HOST` being set. Setting the default Mastodon theme doesn't help, and even accessing the server without being logged (like via incognito tab) also results in error when trying to access links like Explore or Live Feeds.\r\n\r\nAlready tried using commands like `bundle exec rake tmp:cache:clear assets:clean assets:clobber assets:precompile` and deleting or renaming `/home/mastodon/live/public/assets`. Also tried `bundle pristine` and didn't help either.\r\n\r\nThere's nothing relevant in the output of `journalctl -xf -u mastodon-*`.\r\n\r\n### Mastodon instance\r\n\r\nbolha.one\r\n\r\n### Mastodon version\r\n\r\nv4.2.0-beta2\r\n\r\n### Browser name and version\r\n\r\nFirefox 116.0.3, Chromium 117.0.5924.0\r\n\r\n### Operating system\r\n\r\nWindows 11\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/helpers/email_helper.rb\n@@ -6,13 +6,17 @@ def self.included(base)\n   end\n \n   def email_to_canonical_email(str)\n+    return nil if str.nil?\n+\n     username, domain = str.downcase.split('@', 2)\n     username, = username.delete('.').split('+', 2)\n \n     \"#{username}@#{domain}\"\n   end\n \n   def email_to_canonical_email_hash(str)\n+    return nil if str.nil?\n+\n     Digest::SHA2.new(256).hexdigest(email_to_canonical_email(str))\n   end\n end\n---\n\n\n---\n\nChoice B:\napp/views/application/mailer/_hashtag.html.haml\n@@ -17,4 +17,5 @@\n                           %span.email-mini-hashtag-img-span\n                             = image_tag full_asset_url(account.avatar.url), alt: '', width: 16, height: 16\n                       %td\n-                        %p= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(hashtag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts))\n+                        - people = hashtag.history.aggregate(2.days.ago.to_date..Time.zone.today).accounts\n+                        %p= t('user_mailer.welcome.hashtags_recent_count', people: number_with_delimiter(people), count: people)\n---\n\n\n---\n\nChoice C:\nconfig/webpack/shared.js\n@@ -2,6 +2,7 @@\n \n const { basename, dirname, join, relative, resolve } = require('path');\n \n+const CircularDependencyPlugin = require('circular-dependency-plugin');\n const { sync } = require('glob');\n const MiniCssExtractPlugin = require('mini-css-extract-plugin');\n const extname = require('path-complete-extname');\n@@ -84,6 +85,9 @@ module.exports = {\n       writeToDisk: true,\n       publicPath: true,\n     }),\n+    new CircularDependencyPlugin({\n+      failOnError: true,\n+    })\n   ],\n \n   resolve: {\n---\npackage.json\n@@ -59,6 +59,7 @@\n     \"babel-plugin-preval\": \"^5.1.0\",\n     \"babel-plugin-transform-react-remove-prop-types\": \"^0.4.24\",\n     \"blurhash\": \"^2.0.5\",\n+    \"circular-dependency-plugin\": \"^5.2.2\",\n     \"classnames\": \"^2.3.2\",\n     \"cocoon-js-vanilla\": \"^1.3.0\",\n     \"color-blend\": \"^4.0.0\",\n---\nyarn.lock\n@@ -3998,6 +3998,11 @@ cipher-base@^1.0.0, cipher-base@^1.0.1, cipher-base@^1.0.3:\n     inherits \"^2.0.1\"\n     safe-buffer \"^5.0.1\"\n \n+circular-dependency-plugin@^5.2.2:\n+  version \"5.2.2\"\n+  resolved \"https://registry.yarnpkg.com/circular-dependency-plugin/-/circular-dependency-plugin-5.2.2.tgz#39e836079db1d3cf2f988dc48c5188a44058b600\"\n+  integrity sha512-g38K9Cm5WRwlaH6g03B9OEz/0qRizI+2I7n+Gz+L5DxXJAPAiWQvwlYNm1V1jkdpUv95bOe/ASm2vfi/G560jQ==\n+\n cjs-module-lexer@^1.0.0:\n   version \"1.2.3\"\n   resolved \"https://registry.yarnpkg.com/cjs-module-lexer/-/cjs-module-lexer-1.2.3.tgz#6c370ab19f8a3394e318fe682686ec0ac684d107\"\n@@ -11281,6 +11286,7 @@ stringz@^2.1.0:\n     char-regex \"^1.0.2\"\n \n \"strip-ansi-cjs@npm:strip-ansi@^6.0.1\", strip-ansi@^6.0.0, strip-ansi@^6.0.1:\n+  name strip-ansi-cjs\n   version \"6.0.1\"\n   resolved \"https://registry.yarnpkg.com/strip-ansi/-/strip-ansi-6.0.1.tgz#9e26c63d30f53443e9489495b2105d37b67a85d9\"\n   integrity sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -424,6 +424,10 @@ html {\n   border-bottom: 0;\n }\n \n+.column-settings__hashtags .column-select__option {\n+  color: $white;\n+}\n+\n .dashboard__quick-access,\n .focal-point__preview strong,\n .admin-wrapper .content__heading__tabs a.selected {\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. [This toot](https://social.coop/@smallcircles/110755972839994395) is now favorited 259 times\r\n2. Whenever clicking on favorites icon below the toot to /favorites only last 40 items are shown, no option to load more.\r\n...\r\n\r\n\r\n### Expected behaviour\r\n\r\nFull list of favoriters should be displayed, or a load more button to fetch the next page of favoriters.\r\n\r\n### Actual behaviour\r\n\r\nOnly the lastest 40 favoriters are displayed and no option to load more.\r\n\r\n### Detailed description\r\n\r\nDiscovered while addressing similar issue, https://github.com/mastodon/mastodon/issues/26121. The frontend code that displays the favorites only ever calls the favorites API once, regardless of whether or not a paginated link is returned.\r\n\r\n### Mastodon instance\r\n\r\nsocial.coop\r\n\r\n### Mastodon version\r\n\r\nv4.1.4\r\n\r\n### Browser name and version\r\n\r\nFirefox 115.0, Chrome 115.0.5790.173\r\n\r\n### Operating system\r\n\r\nWindows 10 (user), Ubuntu 23.04 (server)\r\n\r\n### Technical details\r\n\r\nDetails in the similar issue https://github.com/mastodon/mastodon/issues/26121 apply here as well, the code for these two views is nearly identical.\n\n---\n\nChoice A:\napp/models/status.rb\n@@ -162,7 +162,7 @@ class Status < ApplicationRecord\n   REAL_TIME_WINDOW = 6.hours\n \n   def cache_key\n-    \"v2:#{super}\"\n+    \"v3:#{super}\"\n   end\n \n   def searchable_by(preloaded = nil)\n---\n\n\n---\n\nChoice B:\napp/helpers/languages_helper.rb\n@@ -254,6 +254,7 @@ def standard_locale_name(locale)\n \n   def valid_locale_or_nil(str)\n     return if str.blank?\n+    return str if valid_locale?(str)\n \n     code, = str.to_s.split(/[_-]/) # Strip out the region from e.g. en_US or ja-JP\n \n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/actions/interactions.js\n@@ -1,5 +1,6 @@\n-import api from '../api';\n+import api, { getLinks } from '../api';\n \n+import { fetchRelationships } from './accounts';\n import { importFetchedAccounts, importFetchedStatus } from './importer';\n \n export const REBLOG_REQUEST = 'REBLOG_REQUEST';\n@@ -26,6 +27,10 @@ export const FAVOURITES_FETCH_REQUEST = 'FAVOURITES_FETCH_REQUEST';\n export const FAVOURITES_FETCH_SUCCESS = 'FAVOURITES_FETCH_SUCCESS';\n export const FAVOURITES_FETCH_FAIL    = 'FAVOURITES_FETCH_FAIL';\n \n+export const FAVOURITES_EXPAND_REQUEST = 'FAVOURITES_EXPAND_REQUEST';\n+export const FAVOURITES_EXPAND_SUCCESS = 'FAVOURITES_EXPAND_SUCCESS';\n+export const FAVOURITES_EXPAND_FAIL = 'FAVOURITES_EXPAND_FAIL';\n+\n export const PIN_REQUEST = 'PIN_REQUEST';\n export const PIN_SUCCESS = 'PIN_SUCCESS';\n export const PIN_FAIL    = 'PIN_FAIL';\n@@ -308,8 +313,10 @@ export function fetchFavourites(id) {\n     dispatch(fetchFavouritesRequest(id));\n \n     api(getState).get(`/api/v1/statuses/${id}/favourited_by`).then(response => {\n+      const next = getLinks(response).refs.find(link => link.rel === 'next');\n       dispatch(importFetchedAccounts(response.data));\n-      dispatch(fetchFavouritesSuccess(id, response.data));\n+      dispatch(fetchFavouritesSuccess(id, response.data, next ? next.uri : null));\n+      dispatch(fetchRelationships(response.data.map(item => item.id)));\n     }).catch(error => {\n       dispatch(fetchFavouritesFail(id, error));\n     });\n@@ -323,17 +330,62 @@ export function fetchFavouritesRequest(id) {\n   };\n }\n \n-export function fetchFavouritesSuccess(id, accounts) {\n+export function fetchFavouritesSuccess(id, accounts, next) {\n   return {\n     type: FAVOURITES_FETCH_SUCCESS,\n     id,\n     accounts,\n+    next,\n   };\n }\n \n export function fetchFavouritesFail(id, error) {\n   return {\n     type: FAVOURITES_FETCH_FAIL,\n+    id,\n+    error,\n+  };\n+}\n+\n+export function expandFavourites(id) {\n+  return (dispatch, getState) => {\n+    const url = getState().getIn(['user_lists', 'favourited_by', id, 'next']);\n+    if (url === null) {\n+      return;\n+    }\n+\n+    dispatch(expandFavouritesRequest(id));\n+\n+    api(getState).get(url).then(response => {\n+      const next = getLinks(response).refs.find(link => link.rel === 'next');\n+\n+      dispatch(importFetchedAccounts(response.data));\n+      dispatch(expandFavouritesSuccess(id, response.data, next ? next.uri : null));\n+      dispatch(fetchRelationships(response.data.map(item => item.id)));\n+    }).catch(error => dispatch(expandFavouritesFail(id, error)));\n+  };\n+}\n+\n+export function expandFavouritesRequest(id) {\n+  return {\n+    type: FAVOURITES_EXPAND_REQUEST,\n+    id,\n+  };\n+}\n+\n+export function expandFavouritesSuccess(id, accounts, next) {\n+  return {\n+    type: FAVOURITES_EXPAND_SUCCESS,\n+    id,\n+    accounts,\n+    next,\n+  };\n+}\n+\n+export function expandFavouritesFail(id, error) {\n+  return {\n+    type: FAVOURITES_EXPAND_FAIL,\n+    id,\n     error,\n   };\n }\n---\napp/javascript/mastodon/features/favourites/index.jsx\n@@ -8,7 +8,9 @@ import ImmutablePropTypes from 'react-immutable-proptypes';\n import ImmutablePureComponent from 'react-immutable-pure-component';\n import { connect } from 'react-redux';\n \n-import { fetchFavourites } from 'mastodon/actions/interactions';\n+import { debounce } from 'lodash';\n+\n+import { fetchFavourites, expandFavourites } from 'mastodon/actions/interactions';\n import ColumnHeader from 'mastodon/components/column_header';\n import { Icon }  from 'mastodon/components/icon';\n import { LoadingIndicator } from 'mastodon/components/loading_indicator';\n@@ -21,7 +23,9 @@ const messages = defineMessages({\n });\n \n const mapStateToProps = (state, props) => ({\n-  accountIds: state.getIn(['user_lists', 'favourited_by', props.params.statusId]),\n+  accountIds: state.getIn(['user_lists', 'favourited_by', props.params.statusId, 'items']),\n+  hasMore: !!state.getIn(['user_lists', 'favourited_by', props.params.statusId, 'next']),\n+  isLoading: state.getIn(['user_lists', 'favourited_by', props.params.statusId, 'isLoading'], true),\n });\n \n class Favourites extends ImmutablePureComponent {\n@@ -30,6 +34,8 @@ class Favourites extends ImmutablePureComponent {\n     params: PropTypes.object.isRequired,\n     dispatch: PropTypes.func.isRequired,\n     accountIds: ImmutablePropTypes.list,\n+    hasMore: PropTypes.bool,\n+    isLoading: PropTypes.bool,\n     multiColumn: PropTypes.bool,\n     intl: PropTypes.object.isRequired,\n   };\n@@ -40,18 +46,16 @@ class Favourites extends ImmutablePureComponent {\n     }\n   }\n \n-  UNSAFE_componentWillReceiveProps (nextProps) {\n-    if (nextProps.params.statusId !== this.props.params.statusId && nextProps.params.statusId) {\n-      this.props.dispatch(fetchFavourites(nextProps.params.statusId));\n-    }\n-  }\n-\n   handleRefresh = () => {\n     this.props.dispatch(fetchFavourites(this.props.params.statusId));\n   };\n \n+  handleLoadMore = debounce(() => {\n+    this.props.dispatch(expandFavourites(this.props.params.statusId));\n+  }, 300, { leading: true });\n+\n   render () {\n-    const { intl, accountIds, multiColumn } = this.props;\n+    const { intl, accountIds, hasMore, isLoading, multiColumn } = this.props;\n \n     if (!accountIds) {\n       return (\n@@ -75,6 +79,9 @@ class Favourites extends ImmutablePureComponent {\n \n         <ScrollableList\n           scrollKey='favourites'\n+          onLoadMore={this.handleLoadMore}\n+          hasMore={hasMore}\n+          isLoading={isLoading}\n           emptyMessage={emptyMessage}\n           bindToDocument={!multiColumn}\n         >\n---\napp/javascript/mastodon/reducers/user_lists.js\n@@ -46,7 +46,12 @@ import {\n } from '../actions/blocks';\n import {\n   REBLOGS_FETCH_SUCCESS,\n+  FAVOURITES_FETCH_REQUEST,\n   FAVOURITES_FETCH_SUCCESS,\n+  FAVOURITES_FETCH_FAIL,\n+  FAVOURITES_EXPAND_REQUEST,\n+  FAVOURITES_EXPAND_SUCCESS,\n+  FAVOURITES_EXPAND_FAIL,\n } from '../actions/interactions';\n import {\n   MUTES_FETCH_REQUEST,\n@@ -136,7 +141,15 @@ export default function userLists(state = initialState, action) {\n   case REBLOGS_FETCH_SUCCESS:\n     return state.setIn(['reblogged_by', action.id], ImmutableList(action.accounts.map(item => item.id)));\n   case FAVOURITES_FETCH_SUCCESS:\n-    return state.setIn(['favourited_by', action.id], ImmutableList(action.accounts.map(item => item.id)));\n+    return normalizeList(state, ['favourited_by', action.id], action.accounts, action.next);\n+  case FAVOURITES_EXPAND_SUCCESS:\n+    return appendToList(state, ['favourited_by', action.id], action.accounts, action.next);\n+  case FAVOURITES_FETCH_REQUEST:\n+  case FAVOURITES_EXPAND_REQUEST:\n+    return state.setIn(['favourited_by', action.id, 'isLoading'], true);\n+  case FAVOURITES_FETCH_FAIL:\n+  case FAVOURITES_EXPAND_FAIL:\n+    return state.setIn(['favourited_by', action.id, 'isLoading'], false);\n   case NOTIFICATIONS_UPDATE:\n     return action.notification.type === 'follow_request' ? normalizeFollowRequest(state, action.notification) : state;\n   case FOLLOW_REQUESTS_FETCH_SUCCESS:\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -63,8 +63,8 @@ export default class ColumnsArea extends ImmutablePureComponent {\n     children: PropTypes.node,\n   };\n \n-  // Corresponds to (max-width: $no-gap-breakpoint + 285px - 1px) in SCSS\n-  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1174px)');\n+  // Corresponds to (max-width: $no-gap-breakpoint - 1px) in SCSS\n+  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1206px)');\n \n   state = {\n     renderComposePanel: !(this.mediaQuery && this.mediaQuery.matches),\n---\napp/javascript/styles/mastodon/variables.scss\n@@ -87,7 +87,7 @@ $media-modal-media-max-width: 100%;\n // put margins on top and bottom of image to avoid the screen covered by image.\n $media-modal-media-max-height: 80%;\n \n-$no-gap-breakpoint: 1175px;\n+$no-gap-breakpoint: 1207px;\n $mobile-breakpoint: 630px;\n \n $font-sans-serif: 'mastodon-font-sans-serif' !default;\n---\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -62,7 +62,7 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   };\n \n   // Corresponds to (max-width: $no-gap-breakpoint - 1px) in SCSS\n-  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1206px)');\n+  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1174px)');\n \n   state = {\n     renderComposePanel: !(this.mediaQuery && this.mediaQuery.matches),\n---\napp/javascript/styles/mastodon/components.scss\n@@ -2708,7 +2708,7 @@ a.account__display-name {\n     &__main {\n       box-sizing: border-box;\n       width: 100%;\n-      flex: 0 0 auto;\n+      flex: 0 1 auto;\n       display: flex;\n       flex-direction: column;\n \n---\napp/javascript/styles/mastodon/variables.scss\n@@ -87,7 +87,7 @@ $media-modal-media-max-width: 100%;\n // put margins on top and bottom of image to avoid the screen covered by image.\n $media-modal-media-max-height: 80%;\n \n-$no-gap-breakpoint: 1207px;\n+$no-gap-breakpoint: 1175px;\n $mobile-breakpoint: 630px;\n \n $font-sans-serif: 'mastodon-font-sans-serif' !default;\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Make a query to the relationships endpoint, with 10 times the same ID. For example `http://localhost:3000/api/v1/accounts/relationships?id[]=110321186862529332&id[]=110321186862529332&id[]=110321186862529332&id[]=110321186862529332&id[]=110321186862529332&id[]=110321186862529332&id[]=110321186862529332&id[]=110321186862529332&id[]=110321186862529332&id[]=110321186862529332&id[]=110321186862529332&id[]=110321186862529332&id[]=110321186862529332&id[]=110321186862529332&id[]=110321186862529332&id[]=110321186862529332&id[]=110321186862529332`\r\n2. Look at the response\r\n\n\n### Expected behaviour\n\nI would expect account 110321186862529332 to only appear once\n\n### Actual behaviour\n\nIt appears once for every ID specified in the request\n\n### Detailed description\n\nWe probably need to patch the controller to add `uniq` to the list of inbound IDs\r\n\r\n```ruby\r\n  def account_ids\r\n    Array(params[:id]).map(&:to_i).uniq\r\n  end\r\n```\r\n\r\nI wonder if this could be done in other places as well\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\n`main`\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/notifications/components/column_settings.jsx\n@@ -45,14 +45,18 @@ class ColumnSettings extends PureComponent {\n \n     return (\n       <div className='column-settings'>\n-        {alertsEnabled && browserSupport && browserPermission === 'denied' && (\n-          <span className='warning-hint'><FormattedMessage id='notifications.permission_denied' defaultMessage='Desktop notifications are unavailable due to previously denied browser permissions request' /></span>\n-        )}\n-\n         <section>\n           <ClearColumnButton onClick={onClear} />\n         </section>\n \n+        {alertsEnabled && browserSupport && browserPermission === 'denied' && (\n+          <section>\n+            <span className='warning-hint'>\n+              <FormattedMessage id='notifications.permission_denied' defaultMessage='Desktop notifications are unavailable due to previously denied browser permissions request' />\n+            </span>\n+          </section>\n+        )}\n+\n         {alertsEnabled && browserSupport && browserPermission === 'default' && (\n           <section>\n             <span className='warning-hint'>\n---\n\n\n---\n\nChoice B:\napp/lib/video_metadata_extractor.rb\n@@ -22,7 +22,7 @@ def valid?\n   private\n \n   def ffmpeg_command_output\n-    command = Terrapin::CommandLine.new('ffprobe', '-i :path -print_format :format -show_format -show_streams -show_error -loglevel :loglevel')\n+    command = Terrapin::CommandLine.new(Rails.configuration.x.ffprobe_binary, '-i :path -print_format :format -show_format -show_streams -show_error -loglevel :loglevel')\n     command.run(path: @path, format: 'json', loglevel: 'fatal')\n   end\n \n---\nconfig/initializers/ffmpeg.rb\n@@ -1,5 +1,6 @@\n # frozen_string_literal: true\n \n-if ENV['FFMPEG_BINARY'].present?\n-  FFMPEG.ffmpeg_binary = ENV['FFMPEG_BINARY']\n+Rails.application.configure do\n+  config.x.ffmpeg_binary = ENV['FFMPEG_BINARY'] || 'ffmpeg'\n+  config.x.ffprobe_binary = ENV['FFPROBE_BINARY'] || 'ffprobe'\n end\n---\nlib/paperclip/image_extractor.rb\n@@ -35,7 +35,7 @@ def extract_image_from_file!\n       dst.binmode\n \n       begin\n-        command = Terrapin::CommandLine.new('ffmpeg', '-i :source -loglevel :loglevel -y :destination', logger: Paperclip.logger)\n+        command = Terrapin::CommandLine.new(Rails.configuration.x.ffmpeg_binary, '-i :source -loglevel :loglevel -y :destination', logger: Paperclip.logger)\n         command.run(source: @file.path, destination: dst.path, loglevel: 'fatal')\n       rescue Terrapin::ExitStatusError\n         dst.close(true)\n---\nlib/paperclip/transcoder.rb\n@@ -61,7 +61,7 @@ def make\n       command_arguments, interpolations = prepare_command(destination)\n \n       begin\n-        command = Terrapin::CommandLine.new('ffmpeg', command_arguments.join(' '), logger: Paperclip.logger)\n+        command = Terrapin::CommandLine.new(Rails.configuration.x.ffmpeg_binary, command_arguments.join(' '), logger: Paperclip.logger)\n         command.run(interpolations)\n       rescue Terrapin::ExitStatusError => e\n         raise Paperclip::Error, \"Error while transcoding #{@basename}: #{e}\"\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -5616,7 +5616,7 @@ a.status-card {\n   user-select: text;\n   display: flex;\n \n-  @media screen and (max-width: $no-gap-breakpoint) {\n+  @media screen and (width <= 630px) {\n     margin-top: auto;\n   }\n }\n---\n\n\n---\n\nChoice D:\napp/controllers/api/v1/accounts/familiar_followers_controller.rb\n@@ -12,7 +12,7 @@ def index\n   private\n \n   def set_accounts\n-    @accounts = Account.without_suspended.where(id: account_ids).select('id, hide_collections').index_by(&:id).values_at(*account_ids).compact\n+    @accounts = Account.without_suspended.where(id: account_ids).select('id, hide_collections')\n   end\n \n   def familiar_followers\n---\napp/controllers/api/v1/accounts/relationships_controller.rb\n@@ -5,11 +5,8 @@ class Api::V1::Accounts::RelationshipsController < Api::BaseController\n   before_action :require_user!\n \n   def index\n-    scope = Account.where(id: account_ids).select('id')\n-    scope.merge!(Account.without_suspended) unless truthy_param?(:with_suspended)\n-    # .where doesn't guarantee that our results are in the same order\n-    # we requested them, so return the \"right\" order to the requestor.\n-    @accounts = scope.index_by(&:id).values_at(*account_ids).compact\n+    @accounts = Account.where(id: account_ids).select('id')\n+    @accounts.merge!(Account.without_suspended) unless truthy_param?(:with_suspended)\n     render json: @accounts, each_serializer: REST::RelationshipSerializer, relationships: relationships\n   end\n \n---\nspec/controllers/api/v1/accounts/familiar_followers_controller_spec.rb\n@@ -19,5 +19,17 @@\n \n       expect(response).to have_http_status(200)\n     end\n+\n+    context 'when there are duplicate account IDs in the params' do\n+      let(:account_a) { Fabricate(:account) }\n+      let(:account_b) { Fabricate(:account) }\n+\n+      it 'removes duplicate account IDs from params' do\n+        account_ids = [account_a, account_b, account_b, account_a, account_a].map { |a| a.id.to_s }\n+        get :index, params: { id: account_ids }\n+\n+        expect(body_as_json.pluck(:id)).to eq [account_a.id.to_s, account_b.id.to_s]\n+      end\n+    end\n   end\n end\n---\nspec/requests/api/v1/accounts/relationships_spec.rb\n@@ -79,6 +79,22 @@\n         end\n       end\n \n+      context 'when there are duplicate IDs in the params' do\n+        let(:params) { { id: [simon.id, lewis.id, lewis.id, lewis.id, simon.id] } }\n+\n+        it 'removes duplicate account IDs from params' do\n+          subject\n+\n+          expect(body_as_json)\n+            .to be_an(Enumerable)\n+            .and have_attributes(\n+              size: 2,\n+              first: include(simon_item),\n+              second: include(lewis_item)\n+            )\n+        end\n+      end\n+\n       def simon_item\n         {\n           id: simon.id.to_s,\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n- Running `main` at commit b5acf13\r\n- Running `tootctl` or starting Mastodon services\r\n- Observed warning message:\r\n\r\n```\r\n/opt/mastodon/lib/http_extensions.rb:7: warning: already initialized constant HTTP::Request::METHODS\r\n/usr/local/bundle/gems/http-5.1.1/lib/http/request.rb:29: warning: previous definition of METHODS was here\r\n```\r\n\r\n<img width=\"915\" alt=\"CleanShot 2023-08-18 at 08 11 20@2x\" src=\"https://github.com/mastodon/mastodon/assets/3002053/61668d08-30c2-4a8d-af3e-c3b332381d2f\">\r\n\n\n### Expected behaviour\n\nNo error message\n\n### Actual behaviour\n\nError message\n\n### Detailed description\n\n_No response_\n\n### Mastodon instance\n\nvmst.io\n\n### Mastodon version\n\nv4.2.0-bb51c06+io\n\n### Technical details\n\nRuby 3.2.2\n\n---\n\nChoice A:\ndocker-compose.yml\n@@ -2,7 +2,7 @@ version: '3'\n services:\n   db:\n     restart: always\n-    image: postgres:14-alpine\n+    image: postgres:15-alpine\n     shm_size: 256mb\n     networks:\n       - internal_network\n@@ -25,7 +25,7 @@ services:\n \n   # es:\n   #   restart: always\n-  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.4\n+  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9\n   #   environment:\n   #     - \"ES_JAVA_OPTS=-Xms512m -Xmx512m -Des.enforce.bootstrap.checks=true\"\n   #     - \"xpack.license.self_generated.type=basic\"\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\n\n\n---\n\nChoice B:\napp/presenters/language_presenter.rb\n@@ -1,7 +1,7 @@\n # frozen_string_literal: true\n \n class LanguagePresenter < ActiveModelSerializers::Model\n-  attributes :code, :name, :native_name\n+  attributes :code, :name\n \n   def initialize(code)\n     super()\n@@ -13,8 +13,4 @@ def initialize(code)\n   def name\n     @item[0]\n   end\n-\n-  def native_name\n-    @item[1]\n-  end\n end\n---\nspec/requests/api/v1/instances/languages_spec.rb\n@@ -9,10 +9,21 @@\n     end\n \n     it 'returns http success and includes supported languages' do\n-      expect(response).to have_http_status(200)\n+      expect(response)\n+        .to have_http_status(200)\n       expect(response.content_type)\n         .to start_with('application/json')\n-      expect(response.parsed_body.pluck(:code)).to match_array LanguagesHelper::SUPPORTED_LOCALES.keys.map(&:to_s)\n+      expect(response.parsed_body)\n+        .to match_array(supported_locale_expectations)\n+    end\n+\n+    def supported_locale_expectations\n+      LanguagesHelper::SUPPORTED_LOCALES.map do |key, values|\n+        include(\n+          code: key.to_s,\n+          name: values.first\n+        )\n+      end\n     end\n   end\n end\n---\n\n\n---\n\nChoice C:\napp/services/fetch_link_card_service.rb\n@@ -106,12 +106,11 @@ def skip_link?(anchor)\n   end\n \n   def attempt_oembed\n-    service         = FetchOEmbedService.new\n-    url_domain      = Addressable::URI.parse(@url).normalized_host\n-    cached_endpoint = Rails.cache.read(\"oembed_endpoint:#{url_domain}\")\n+    service = FetchOEmbedService.new\n \n-    embed   = service.call(@url, cached_endpoint: cached_endpoint) unless cached_endpoint.nil?\n+    embed   = service.call(@url, use_cached_endpoint: true)\n     embed ||= service.call(@url, html: html) unless html.nil?\n+    embed ||= service.call(@url, use_cached_endpoint: true) if @url != @original_url.to_s\n \n     return false if embed.nil?\n \n---\napp/services/fetch_oembed_service.rb\n@@ -10,7 +10,7 @@ def call(url, options = {})\n     @url     = url\n     @options = options\n \n-    if @options[:cached_endpoint]\n+    if @options[:use_cached_endpoint]\n       parse_cached_endpoint!\n     else\n       discover_endpoint!\n@@ -57,9 +57,9 @@ def discover_endpoint!\n   end\n \n   def parse_cached_endpoint!\n-    cached = @options[:cached_endpoint]\n+    cached = Rails.cache.read(cache_key)\n \n-    return if cached[:endpoint].nil? || cached[:format].nil?\n+    return if cached.nil? || cached[:endpoint].nil? || cached[:format].nil?\n \n     @endpoint_url = Addressable::Template.new(cached[:endpoint]).expand(url: @url).to_s\n     @format       = cached[:format]\n@@ -68,14 +68,16 @@ def parse_cached_endpoint!\n   def cache_endpoint!\n     return unless URL_REGEX.match?(@endpoint_url)\n \n-    url_domain = Addressable::URI.parse(@url).normalized_host\n-\n     endpoint_hash = {\n       endpoint: @endpoint_url.gsub(URL_REGEX, '={url}'),\n       format: @format,\n     }\n \n-    Rails.cache.write(\"oembed_endpoint:#{url_domain}\", endpoint_hash, expires_in: ENDPOINT_CACHE_EXPIRES_IN)\n+    Rails.cache.write(cache_key, endpoint_hash, expires_in: ENDPOINT_CACHE_EXPIRES_IN)\n+  end\n+\n+  def cache_key\n+    \"oembed_endpoint:#{Addressable::URI.parse(@url).normalized_host}\"\n   end\n \n   def fetch!\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -13,6 +13,7 @@\n     stub_request(:get, 'http://example.com/not-found').to_return(status: 404, headers: { 'Content-Type' => 'text/html' }, body: html)\n     stub_request(:get, 'http://example.com/text').to_return(status: 404, headers: { 'Content-Type' => 'text/plain' }, body: 'Hello')\n     stub_request(:get, 'http://example.com/redirect').to_return(status: 302, headers: { 'Location' => 'http://example.com/html' })\n+    stub_request(:get, 'http://example.net/redirect-to-other-domain').to_return(status: 302, headers: { 'Location' => 'http://example.com/html' })\n     stub_request(:get, 'http://example.com/redirect-to-404').to_return(status: 302, headers: { 'Location' => 'http://example.com/not-found' })\n     stub_request(:get, 'http://example.com/oembed?url=http://example.com/html').to_return(headers: { 'Content-Type' => 'application/json' }, body: '{ \"version\": \"1.0\", \"type\": \"link\", \"title\": \"oEmbed title\" }')\n     stub_request(:get, 'http://example.com/oembed?format=json&url=http://example.com/html').to_return(headers: { 'Content-Type' => 'application/json' }, body: '{ \"version\": \"1.0\", \"type\": \"link\", \"title\": \"oEmbed title\" }')\n@@ -264,6 +265,39 @@\n         end\n       end\n \n+      context 'when oEmbed endpoint cache populated with redirect target' do\n+        let(:status) { Fabricate(:status, text: 'http://example.net/redirect-to-other-domain') }\n+        let(:oembed_cache) { { endpoint: 'http://example.com/oembed?format=json&url={url}', format: :json } }\n+\n+        it 'uses the cached oEmbed response' do\n+          expect(a_request(:get, 'http://example.net/redirect-to-other-domain')).to have_been_made\n+          expect(a_request(:get, 'http://example.com/oembed?url=http://example.com/html')).to have_been_made\n+        end\n+\n+        it 'creates preview card' do\n+          expect(status.preview_card).to_not be_nil\n+          expect(status.preview_card.url).to eq 'http://example.com/html'\n+          expect(status.preview_card.title).to eq 'oEmbed title'\n+        end\n+      end\n+\n+      context 'when oEmbed endpoint cache populated with redirect target but page contains no oEmbed tags' do\n+        let(:status) { Fabricate(:status, text: 'http://example.net/redirect-to-other-domain') }\n+        let(:html) { 'Please fill out CAPTCHA' }\n+        let(:oembed_cache) { { endpoint: 'http://example.com/oembed?format=json&url={url}', format: :json } }\n+\n+        it 'uses the cached oEmbed response' do\n+          expect(a_request(:get, 'http://example.net/redirect-to-other-domain')).to have_been_made\n+          expect(a_request(:get, 'http://example.com/oembed?format=json&url=http://example.com/html')).to have_been_made\n+        end\n+\n+        it 'creates preview card' do\n+          expect(status.preview_card).to_not be_nil\n+          expect(status.preview_card.url).to eq 'http://example.com/html'\n+          expect(status.preview_card.title).to eq 'oEmbed title'\n+        end\n+      end\n+\n       # If the original HTML URL for whatever reason (e.g. DOS protection) redirects to\n       # an error page, we can still use the cached oEmbed but should not use the\n       # redirect URL on the card.\n---\nspec/services/fetch_oembed_service_spec.rb\n@@ -160,10 +160,12 @@\n           headers: { 'Content-Type': 'text/html' },\n           body: request_fixture('oembed_json_empty.html')\n         )\n+\n+        Rails.cache.write('oembed_endpoint:www.youtube.com', { endpoint: 'http://www.youtube.com/oembed?format=json&url={url}', format: :json })\n       end\n \n       it 'returns new provider without fetching original URL first' do\n-        subject.call('https://www.youtube.com/watch?v=dqwpQarrDwk', cached_endpoint: { endpoint: 'http://www.youtube.com/oembed?format=json&url={url}', format: :json })\n+        subject.call('https://www.youtube.com/watch?v=dqwpQarrDwk', use_cached_endpoint: true)\n         expect(a_request(:get, 'https://www.youtube.com/watch?v=dqwpQarrDwk')).to_not have_been_made\n         expect(subject.endpoint_url).to eq 'http://www.youtube.com/oembed?format=json&url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DdqwpQarrDwk'\n         expect(subject.format).to eq :json\n---\napp/lib/link_details_extractor.rb\n@@ -225,7 +225,7 @@ def host_to_url(str)\n   end\n \n   def valid_url_or_nil(str, same_origin_only: false)\n-    return if str.blank? || str == 'null'\n+    return if str.blank? || str == 'null' || str == 'undefined'\n \n     url = @original_url + Addressable::URI.parse(str)\n \n---\nspec/lib/link_details_extractor_spec.rb\n@@ -33,6 +33,14 @@\n         expect(subject.canonical_url).to eq original_url\n       end\n     end\n+\n+    context 'when canonical URL is set to \"undefined\"' do\n+      let(:url) { 'undefined' }\n+\n+      it 'ignores the canonical URLs' do\n+        expect(subject.canonical_url).to eq original_url\n+      end\n+    end\n   end\n \n   context 'when only basic metadata is present' do\n---\n\n\n---\n\nChoice D:\nlib/http_extensions.rb\n@@ -2,9 +2,7 @@\n \n # Monkey patching until https://github.com/httprb/http/pull/757 is merged\n unless HTTP::Request::METHODS.include?(:purge)\n-  module HTTP\n-    class Request\n-      METHODS = METHODS.dup.push(:purge).freeze\n-    end\n-  end\n+  methods = HTTP::Request::METHODS.dup\n+  HTTP::Request.send(:remove_const, :METHODS)\n+  HTTP::Request.const_set(:METHODS, methods.push(:purge).freeze)\n end\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Click on an image\r\n2. The image opens in an overlay\r\n3. The overlay does not show an option to view the Alt text\r\nThe alt text is visible if you hover over it for a while but if you move a little bit it disappears and you have to move off the image which is a major pain when the Alt description is long, then back over it to see it again. An alternative version is to press and hold but this has the same result.\n\n### Expected behaviour\n\nIt would be nice to have a button for the Alt text to let it stay put and have the time to read it.\n\n### Actual behaviour\n\nAlt text is not visible unless you sit very still, or press and hold.\n\n### Detailed description\n\nI think the above is clear enough, let me know.\n\n### Mastodon instance\n\nmastodon.nl\n\n### Mastodon version\n\nv4.1.4\n\n### Browser name and version\n\nFirefox, two most recent versions, and the latest Brave version.\n\n### Operating system\n\nW10\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/components/status.jsx\n@@ -397,6 +397,7 @@ class Status extends ImmutablePureComponent {\n     const connectUp = previousId && previousId === status.get('in_reply_to_id');\n     const connectToRoot = rootId && rootId === status.get('in_reply_to_id');\n     const connectReply = nextInReplyToId && nextInReplyToId === status.get('id');\n+    const matchedFilters = status.get('matched_filters');\n \n     if (featured) {\n       prepend = (\n@@ -432,7 +433,6 @@ class Status extends ImmutablePureComponent {\n       );\n     }\n \n-    const matchedFilters = status.get('matched_filters');\n     const expanded = (!matchedFilters || this.state.showDespiteFilter) && (!status.get('hidden') || status.get('spoiler_text').length === 0);\n \n     if (hidden) {\n---\n\n\n---\n\nChoice B:\napp/controllers/api/v1/accounts/familiar_followers_controller.rb\n@@ -12,7 +12,7 @@ def index\n   private\n \n   def set_accounts\n-    @accounts = Account.without_suspended.where(id: account_ids).select('id, hide_collections').index_by(&:id).values_at(*account_ids).compact\n+    @accounts = Account.without_suspended.where(id: account_ids).select('id, hide_collections')\n   end\n \n   def familiar_followers\n---\napp/controllers/api/v1/accounts/relationships_controller.rb\n@@ -5,11 +5,8 @@ class Api::V1::Accounts::RelationshipsController < Api::BaseController\n   before_action :require_user!\n \n   def index\n-    scope = Account.where(id: account_ids).select('id')\n-    scope.merge!(Account.without_suspended) unless truthy_param?(:with_suspended)\n-    # .where doesn't guarantee that our results are in the same order\n-    # we requested them, so return the \"right\" order to the requestor.\n-    @accounts = scope.index_by(&:id).values_at(*account_ids).compact\n+    @accounts = Account.where(id: account_ids).select('id')\n+    @accounts.merge!(Account.without_suspended) unless truthy_param?(:with_suspended)\n     render json: @accounts, each_serializer: REST::RelationshipSerializer, relationships: relationships\n   end\n \n---\nspec/controllers/api/v1/accounts/familiar_followers_controller_spec.rb\n@@ -19,5 +19,17 @@\n \n       expect(response).to have_http_status(200)\n     end\n+\n+    context 'when there are duplicate account IDs in the params' do\n+      let(:account_a) { Fabricate(:account) }\n+      let(:account_b) { Fabricate(:account) }\n+\n+      it 'removes duplicate account IDs from params' do\n+        account_ids = [account_a, account_b, account_b, account_a, account_a].map { |a| a.id.to_s }\n+        get :index, params: { id: account_ids }\n+\n+        expect(body_as_json.pluck(:id)).to eq [account_a.id.to_s, account_b.id.to_s]\n+      end\n+    end\n   end\n end\n---\nspec/requests/api/v1/accounts/relationships_spec.rb\n@@ -79,6 +79,22 @@\n         end\n       end\n \n+      context 'when there are duplicate IDs in the params' do\n+        let(:params) { { id: [simon.id, lewis.id, lewis.id, lewis.id, simon.id] } }\n+\n+        it 'removes duplicate account IDs from params' do\n+          subject\n+\n+          expect(body_as_json)\n+            .to be_an(Enumerable)\n+            .and have_attributes(\n+              size: 2,\n+              first: include(simon_item),\n+              second: include(lewis_item)\n+            )\n+        end\n+      end\n+\n       def simon_item\n         {\n           id: simon.id.to_s,\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -2612,6 +2612,7 @@ a.account__display-name {\n }\n \n $ui-header-height: 55px;\n+$ui-header-logo-wordmark-width: 99px;\n \n .ui__header {\n   display: none;\n@@ -2627,6 +2628,10 @@ $ui-header-height: 55px;\n   &__logo {\n     display: inline-flex;\n     padding: 15px;\n+    flex-grow: 1;\n+    flex-shrink: 1;\n+    overflow: hidden;\n+    container: header-logo / inline-size;\n \n     .logo {\n       height: $ui-header-height - 30px;\n@@ -2637,7 +2642,7 @@ $ui-header-height: 55px;\n       display: none;\n     }\n \n-    @media screen and (width >= 320px) {\n+    @container header-logo (min-width: #{$ui-header-logo-wordmark-width}) {\n       .logo--wordmark {\n         display: block;\n       }\n@@ -2654,6 +2659,7 @@ $ui-header-height: 55px;\n     gap: 10px;\n     padding: 0 10px;\n     overflow: hidden;\n+    flex-shrink: 0;\n \n     .button {\n       flex: 0 0 auto;\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/components/alt_text_badge.tsx\n@@ -0,0 +1,67 @@\n+import { useState, useCallback, useRef } from 'react';\n+\n+import { FormattedMessage } from 'react-intl';\n+\n+import Overlay from 'react-overlays/Overlay';\n+import type {\n+  OffsetValue,\n+  UsePopperOptions,\n+} from 'react-overlays/esm/usePopper';\n+\n+const offset = [0, 4] as OffsetValue;\n+const popperConfig = { strategy: 'fixed' } as UsePopperOptions;\n+\n+export const AltTextBadge: React.FC<{\n+  description: string;\n+}> = ({ description }) => {\n+  const anchorRef = useRef<HTMLButtonElement>(null);\n+  const [open, setOpen] = useState(false);\n+\n+  const handleClick = useCallback(() => {\n+    setOpen((v) => !v);\n+  }, [setOpen]);\n+\n+  const handleClose = useCallback(() => {\n+    setOpen(false);\n+  }, [setOpen]);\n+\n+  return (\n+    <>\n+      <button\n+        ref={anchorRef}\n+        className='media-gallery__alt__label'\n+        onClick={handleClick}\n+      >\n+        ALT\n+      </button>\n+\n+      <Overlay\n+        rootClose\n+        onHide={handleClose}\n+        show={open}\n+        target={anchorRef.current}\n+        placement='top-end'\n+        flip\n+        offset={offset}\n+        popperConfig={popperConfig}\n+      >\n+        {({ props }) => (\n+          <div {...props} className='hover-card-controller'>\n+            <div\n+              className='media-gallery__alt__popover dropdown-animation'\n+              role='tooltip'\n+            >\n+              <h4>\n+                <FormattedMessage\n+                  id='alt_text_badge.title'\n+                  defaultMessage='Alt text'\n+                />\n+              </h4>\n+              <p>{description}</p>\n+            </div>\n+          </div>\n+        )}\n+      </Overlay>\n+    </>\n+  );\n+};\n---\napp/javascript/mastodon/components/media_gallery.jsx\n@@ -10,6 +10,7 @@ import ImmutablePropTypes from 'react-immutable-proptypes';\n \n import { debounce } from 'lodash';\n \n+import { AltTextBadge } from 'mastodon/components/alt_text_badge';\n import { Blurhash } from 'mastodon/components/blurhash';\n import { formatTime } from 'mastodon/features/video';\n \n@@ -97,7 +98,7 @@ class Item extends PureComponent {\n     }\n \n     if (attachment.get('description')?.length > 0) {\n-      badges.push(<span key='alt' className='media-gallery__alt__label'>ALT</span>);\n+      badges.push(<AltTextBadge key='alt' description={attachment.get('description')} />);\n     }\n \n     const description = attachment.getIn(['translation', 'description']) || attachment.get('description');\n@@ -156,9 +157,9 @@ class Item extends PureComponent {\n       const duration = attachment.getIn(['meta', 'original', 'duration']);\n \n       if (attachment.get('type') === 'gifv') {\n-        badges.push(<span key='gif' className='media-gallery__gifv__label'>GIF</span>);\n+        badges.push(<span key='gif' className='media-gallery__alt__label media-gallery__alt__label--non-interactive'>GIF</span>);\n       } else {\n-        badges.push(<span key='video' className='media-gallery__gifv__label'>{formatTime(Math.floor(duration))}</span>);\n+        badges.push(<span key='video' className='media-gallery__alt__label media-gallery__alt__label--non-interactive'>{formatTime(Math.floor(duration))}</span>);\n       }\n \n       thumbnail = (\n---\napp/javascript/mastodon/features/account_gallery/components/media_item.tsx\n@@ -5,6 +5,7 @@ import classNames from 'classnames';\n import HeadphonesIcon from '@/material-icons/400-24px/headphones-fill.svg?react';\n import MovieIcon from '@/material-icons/400-24px/movie-fill.svg?react';\n import VisibilityOffIcon from '@/material-icons/400-24px/visibility_off.svg?react';\n+import { AltTextBadge } from 'mastodon/components/alt_text_badge';\n import { Blurhash } from 'mastodon/components/blurhash';\n import { Icon } from 'mastodon/components/icon';\n import { formatTime } from 'mastodon/features/video';\n@@ -77,11 +78,7 @@ export const MediaItem: React.FC<{\n   const badges = [];\n \n   if (description && description.length > 0) {\n-    badges.push(\n-      <span key='alt' className='media-gallery__alt__label'>\n-        ALT\n-      </span>,\n-    );\n+    badges.push(<AltTextBadge key='alt' description={description} />);\n   }\n \n   if (!visible) {\n@@ -156,13 +153,19 @@ export const MediaItem: React.FC<{\n \n     if (type === 'gifv') {\n       badges.push(\n-        <span key='gif' className='media-gallery__gifv__label'>\n+        <span\n+          key='gif'\n+          className='media-gallery__alt__label media-gallery__alt__label--non-interactive'\n+        >\n           GIF\n         </span>,\n       );\n     } else {\n       badges.push(\n-        <span key='video' className='media-gallery__gifv__label'>\n+        <span\n+          key='video'\n+          className='media-gallery__alt__label media-gallery__alt__label--non-interactive'\n+        >\n           {formatTime(Math.floor(duration))}\n         </span>,\n       );\n---\napp/javascript/mastodon/locales/en.json\n@@ -85,6 +85,7 @@\n   \"alert.rate_limited.title\": \"Rate limited\",\n   \"alert.unexpected.message\": \"An unexpected error occurred.\",\n   \"alert.unexpected.title\": \"Oops!\",\n+  \"alt_text_badge.title\": \"Alt text\",\n   \"announcement.announcement\": \"Announcement\",\n   \"attachments_list.unprocessed\": \"(unprocessed)\",\n   \"audio.hide\": \"Hide audio\",\n---\napp/javascript/styles/mastodon/components.scss\n@@ -6971,23 +6971,56 @@ a.status-card {\n   inset-inline-end: 8px;\n   display: flex;\n   gap: 2px;\n+  pointer-events: none;\n }\n \n-.media-gallery__alt__label,\n-.media-gallery__gifv__label {\n-  display: flex;\n-  align-items: center;\n-  justify-content: center;\n+.media-gallery__alt__label {\n+  display: block;\n+  text-align: center;\n   color: $white;\n+  border: 0;\n   background: rgba($black, 0.65);\n   backdrop-filter: blur(10px) saturate(180%) contrast(75%) brightness(70%);\n   padding: 3px 8px;\n   border-radius: 4px;\n   font-size: 12px;\n   font-weight: 700;\n   z-index: 1;\n-  pointer-events: none;\n   line-height: 20px;\n+  cursor: pointer;\n+  pointer-events: auto;\n+\n+  &--non-interactive {\n+    pointer-events: none;\n+  }\n+}\n+\n+.media-gallery__alt__popover {\n+  background: rgba($black, 0.65);\n+  backdrop-filter: blur(10px) saturate(180%) contrast(75%) brightness(70%);\n+  border-radius: 4px;\n+  box-shadow: var(--dropdown-shadow);\n+  padding: 16px;\n+  min-width: 16em;\n+  min-height: 2em;\n+  max-width: 22em;\n+  max-height: 30em;\n+  overflow-y: auto;\n+\n+  h4 {\n+    font-size: 15px;\n+    line-height: 20px;\n+    font-weight: 500;\n+    color: $white;\n+    margin-bottom: 8px;\n+  }\n+\n+  p {\n+    font-size: 15px;\n+    line-height: 20px;\n+    color: rgba($white, 0.85);\n+    white-space: pre-line;\n+  }\n }\n \n .attachment-list {\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Turn on the advanced web interface in settings\r\n2. Open a profile who following\n\n### Expected behaviour\n\nUnfollow button have same height with the bell button or the three dot button on the right.\n\n### Actual behaviour\n\nUnfollow button seems not the correct height.\n\n### Detailed description\n\n![Screenshot 2023-08-13 at 18-12-07 Mastodon](https://github.com/mastodon/mastodon/assets/5103195/fead2199-2f68-4a33-8d03-b867b8b73933)\r\n\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.2.0+nightly-2023-08-09\n\n### Browser name and version\n\nFirefox 116.0.2\n\n### Operating system\n\nWindows 10 22H2 19045.3208\n\n### Technical details\n\nI added the user CSS following as a workaround for this:\r\n\r\n```css\r\n.layout-multiple-columns .button.button--with-bell{ padding: 7px 8px; }\r\n```\r\n\r\nIt looks working fine.\r\n\r\n![Screenshot 2023-08-13 at 18-26-23 Mastodon](https://github.com/mastodon/mastodon/assets/5103195/f4047e2b-de9f-43b5-a633-4342735ffd4f)\r\n\r\n\n\n---\n\nChoice A:\napp/javascript/mastodon/polyfills/base_polyfills.ts\n@@ -1,4 +1,5 @@\n import 'core-js/features/object/assign';\n+import 'core-js/features/object/has-own';\n import 'core-js/features/object/values';\n import 'core-js/features/symbol';\n import 'core-js/features/promise/finally';\n---\n\n\n---\n\nChoice B:\napp/lib/link_details_extractor.rb\n@@ -269,16 +269,21 @@ def structured_data\n   end\n \n   def document\n-    @document ||= Nokogiri::HTML(@html, nil, encoding)\n+    @document ||= detect_encoding_and_parse_document\n   end\n \n-  def encoding\n-    @encoding ||= begin\n-      guess = detector.detect(@html, @html_charset)\n-      guess&.fetch(:confidence, 0).to_i > 60 ? guess&.fetch(:encoding, nil) : nil\n+  def detect_encoding_and_parse_document\n+    [detect_encoding, nil, @html_charset, 'UTF-8'].uniq.each do |encoding|\n+      document = Nokogiri::HTML(@html, nil, encoding)\n+      return document if document.to_s.valid_encoding?\n     end\n   end\n \n+  def detect_encoding\n+    guess = detector.detect(@html, @html_charset)\n+    guess&.fetch(:confidence, 0).to_i > 60 ? guess&.fetch(:encoding, nil) : nil\n+  end\n+\n   def detector\n     @detector ||= CharlockHolmes::EncodingDetector.new.tap do |detector|\n       detector.strip_tags = true\n---\nspec/fixtures/requests/low_confidence_latin1.txt\n@@ -0,0 +1,17 @@\n+HTTP/1.1 200 OK\n+server: nginx\n+date: Thu, 13 Jun 2024 14:33:13 GMT\n+content-type: text/html; charset=ISO-8859-1\n+content-length: 158\n+accept-ranges: bytes\n+\n+<!doctype html>\n+<html lang=\"en\">\n+<head>\n+  <meta charset=\"UTF-8\">\n+  <title>Tofu \ufffd l'orange</title>\n+</head>\n+<body>\n+  <h2>Tofu \ufffd l'orange</h2>\n+</body>\n+</html>\n---\nspec/services/fetch_link_card_service_spec.rb\n@@ -26,6 +26,7 @@\n     stub_request(:get, 'http://example.com/sjis_with_wrong_charset').to_return(request_fixture('sjis_with_wrong_charset.txt'))\n     stub_request(:get, 'http://example.com/koi8-r').to_return(request_fixture('koi8-r.txt'))\n     stub_request(:get, 'http://example.com/windows-1251').to_return(request_fixture('windows-1251.txt'))\n+    stub_request(:get, 'http://example.com/low_confidence_latin1').to_return(request_fixture('low_confidence_latin1.txt'))\n \n     Rails.cache.write('oembed_endpoint:example.com', oembed_cache) if oembed_cache\n \n@@ -148,6 +149,14 @@\n       end\n     end\n \n+    context 'with a URL of a page in ISO-8859-1 encoding, that charlock_holmes cannot detect' do\n+      let(:status) { Fabricate(:status, text: 'Check out http://example.com/low_confidence_latin1') }\n+\n+      it 'decodes the HTML' do\n+        expect(status.preview_card.title).to eq(\"Tofu \u00e1 l'orange\")\n+      end\n+    end\n+\n     context 'with a Japanese path URL' do\n       let(:status) { Fabricate(:status, text: '\u30c6\u30b9\u30c8http://example.com/\u65e5\u672c\u8a9e') }\n \n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/account/components/header.jsx\n@@ -265,9 +265,9 @@ class Header extends ImmutablePureComponent {\n       if (signedIn && !account.get('relationship')) { // Wait until the relationship is loaded\n         actionBtn = '';\n       } else if (account.getIn(['relationship', 'requested'])) {\n-        actionBtn = <Button className={classNames({ 'button--with-bell': bellBtn !== '' })} text={intl.formatMessage(messages.cancel_follow_request)} title={intl.formatMessage(messages.requested)} onClick={this.props.onFollow} />;\n+        actionBtn = <Button text={intl.formatMessage(messages.cancel_follow_request)} title={intl.formatMessage(messages.requested)} onClick={this.props.onFollow} />;\n       } else if (!account.getIn(['relationship', 'blocking'])) {\n-        actionBtn = <Button disabled={account.getIn(['relationship', 'blocked_by'])} className={classNames({ 'button--destructive': account.getIn(['relationship', 'following']), 'button--with-bell': bellBtn !== '' })} text={intl.formatMessage(account.getIn(['relationship', 'following']) ? messages.unfollow : messages.follow)} onClick={signedIn ? this.props.onFollow : this.props.onInteractionModal} />;\n+        actionBtn = <Button disabled={account.getIn(['relationship', 'blocked_by'])} className={classNames({ 'button--destructive': account.getIn(['relationship', 'following']) })} text={intl.formatMessage(account.getIn(['relationship', 'following']) ? messages.unfollow : messages.follow)} onClick={signedIn ? this.props.onFollow : this.props.onInteractionModal} />;\n       } else if (account.getIn(['relationship', 'blocking'])) {\n         actionBtn = <Button text={intl.formatMessage(messages.unblock, { name: account.get('username') })} onClick={this.props.onBlock} />;\n       }\n---\napp/javascript/styles/mastodon/components.scss\n@@ -170,11 +170,6 @@\n     display: block;\n     width: 100%;\n   }\n-\n-  .layout-multiple-columns &.button--with-bell {\n-    font-size: 12px;\n-    padding: 0 8px;\n-  }\n }\n \n .column__wrapper {\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -9288,6 +9288,7 @@ noscript {\n   border: 1px solid $highlight-text-color;\n   background: rgba($highlight-text-color, 0.15);\n   overflow: hidden;\n+  flex-shrink: 0;\n \n   &__background-image {\n     width: 125%;\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Upgrade from Mastodon v4.1.6 to v4.2.0-beta1\r\n2. Check PgHero\r\n\r\n...\r\n\r\nDuplicate Indexes\r\n   \r\nThese indexes exist, but aren\u2019t needed. Remove them for faster writes.\r\n\r\nDetails\r\n\r\nOn preview_cards_statuses               index_preview_cards_statuses_on_status_id_and_preview_card_id (status_id, preview_card_id)               is covered by               preview_cards_statuses_pkey (status_id, preview_card_id)\r\n\r\n\n\n### Expected behaviour\n\nThere should be no duplicate indexes\n\n### Actual behaviour\n\nDuplicate index is created.\n\n### Detailed description\n\nThere isn't much else to expand on...\n\n### Mastodon instance\n\nmast.solarisfire.com\n\n### Mastodon version\n\nv4.2.0-beta1\n\n### Technical details\n\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: ruby 3.2.2 (2023-03-30 revision e51014f9c0) [x86_64-linux]\r\n- Node.js version: v16.19.0\r\n\n\n---\n\nChoice A:\napp/javascript/mastodon/actions/notifications_typed.ts\n@@ -18,6 +18,6 @@ export const notificationsUpdate = createAction(\n     playSound: boolean;\n   }) => ({\n     payload: args,\n-    meta: { playSound: playSound ? { sound: 'boop' } : undefined },\n+    meta: { sound: playSound ? 'boop' : undefined },\n   }),\n );\n---\n\n\n---\n\nChoice B:\nGemfile\n@@ -6,7 +6,7 @@ ruby '>= 3.2.0'\n gem 'propshaft'\n gem 'puma', '~> 6.3'\n gem 'rack', '~> 2.2.7'\n-gem 'rails', '~> 7.2.0'\n+gem 'rails', '~> 8.0'\n gem 'thor', '~> 1.2'\n \n gem 'dotenv'\n@@ -73,7 +73,7 @@ gem 'public_suffix', '~> 6.0'\n gem 'pundit', '~> 2.3'\n gem 'rack-attack', '~> 6.6'\n gem 'rack-cors', '~> 2.0', require: 'rack/cors'\n-gem 'rails-i18n', '~> 7.0'\n+gem 'rails-i18n', '~> 8.0'\n gem 'redcarpet', '~> 3.6'\n gem 'redis', '~> 4.5', require: ['redis', 'redis/connection/hiredis']\n gem 'redis-namespace', '~> 1.10'\n---\nGemfile.lock\n@@ -10,46 +10,45 @@ GIT\n GEM\n   remote: https://rubygems.org/\n   specs:\n-    actioncable (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actioncable (8.0.1)\n+      actionpack (= 8.0.1)\n+      activesupport (= 8.0.1)\n       nio4r (~> 2.0)\n       websocket-driver (>= 0.6.1)\n       zeitwerk (~> 2.6)\n-    actionmailbox (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activestorage (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionmailbox (8.0.1)\n+      actionpack (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activestorage (= 8.0.1)\n+      activesupport (= 8.0.1)\n       mail (>= 2.8.0)\n-    actionmailer (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      actionview (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionmailer (8.0.1)\n+      actionpack (= 8.0.1)\n+      actionview (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activesupport (= 8.0.1)\n       mail (>= 2.8.0)\n       rails-dom-testing (~> 2.2)\n-    actionpack (7.2.2.1)\n-      actionview (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionpack (8.0.1)\n+      actionview (= 8.0.1)\n+      activesupport (= 8.0.1)\n       nokogiri (>= 1.8.5)\n-      racc\n-      rack (>= 2.2.4, < 3.2)\n+      rack (>= 2.2.4)\n       rack-session (>= 1.0.1)\n       rack-test (>= 0.6.3)\n       rails-dom-testing (~> 2.2)\n       rails-html-sanitizer (~> 1.6)\n       useragent (~> 0.16)\n-    actiontext (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activestorage (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actiontext (8.0.1)\n+      actionpack (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activestorage (= 8.0.1)\n+      activesupport (= 8.0.1)\n       globalid (>= 0.6.0)\n       nokogiri (>= 1.8.5)\n-    actionview (7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    actionview (8.0.1)\n+      activesupport (= 8.0.1)\n       builder (~> 3.1)\n       erubi (~> 1.11)\n       rails-dom-testing (~> 2.2)\n@@ -59,22 +58,22 @@ GEM\n       activemodel (>= 4.1)\n       case_transform (>= 0.2)\n       jsonapi-renderer (>= 0.1.1.beta1, < 0.3)\n-    activejob (7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    activejob (8.0.1)\n+      activesupport (= 8.0.1)\n       globalid (>= 0.3.6)\n-    activemodel (7.2.2.1)\n-      activesupport (= 7.2.2.1)\n-    activerecord (7.2.2.1)\n-      activemodel (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    activemodel (8.0.1)\n+      activesupport (= 8.0.1)\n+    activerecord (8.0.1)\n+      activemodel (= 8.0.1)\n+      activesupport (= 8.0.1)\n       timeout (>= 0.4.0)\n-    activestorage (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    activestorage (8.0.1)\n+      actionpack (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activesupport (= 8.0.1)\n       marcel (~> 1.0)\n-    activesupport (7.2.2.1)\n+    activesupport (8.0.1)\n       base64\n       benchmark (>= 0.3)\n       bigdecimal\n@@ -86,6 +85,7 @@ GEM\n       minitest (>= 5.1)\n       securerandom (>= 0.3)\n       tzinfo (~> 2.0, >= 2.0.5)\n+      uri (>= 0.13.1)\n     addressable (2.8.7)\n       public_suffix (>= 2.0.2, < 7.0)\n     aes_key_wrap (1.1.0)\n@@ -613,20 +613,20 @@ GEM\n     rackup (1.0.1)\n       rack (< 3)\n       webrick\n-    rails (7.2.2.1)\n-      actioncable (= 7.2.2.1)\n-      actionmailbox (= 7.2.2.1)\n-      actionmailer (= 7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      actiontext (= 7.2.2.1)\n-      actionview (= 7.2.2.1)\n-      activejob (= 7.2.2.1)\n-      activemodel (= 7.2.2.1)\n-      activerecord (= 7.2.2.1)\n-      activestorage (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+    rails (8.0.1)\n+      actioncable (= 8.0.1)\n+      actionmailbox (= 8.0.1)\n+      actionmailer (= 8.0.1)\n+      actionpack (= 8.0.1)\n+      actiontext (= 8.0.1)\n+      actionview (= 8.0.1)\n+      activejob (= 8.0.1)\n+      activemodel (= 8.0.1)\n+      activerecord (= 8.0.1)\n+      activestorage (= 8.0.1)\n+      activesupport (= 8.0.1)\n       bundler (>= 1.15.0)\n-      railties (= 7.2.2.1)\n+      railties (= 8.0.1)\n     rails-controller-testing (1.0.5)\n       actionpack (>= 5.0.1.rc1)\n       actionview (>= 5.0.1.rc1)\n@@ -638,12 +638,12 @@ GEM\n     rails-html-sanitizer (1.6.2)\n       loofah (~> 2.21)\n       nokogiri (>= 1.15.7, != 1.16.7, != 1.16.6, != 1.16.5, != 1.16.4, != 1.16.3, != 1.16.2, != 1.16.1, != 1.16.0.rc1, != 1.16.0)\n-    rails-i18n (7.0.10)\n+    rails-i18n (8.0.1)\n       i18n (>= 0.7, < 2)\n-      railties (>= 6.0.0, < 8)\n-    railties (7.2.2.1)\n-      actionpack (= 7.2.2.1)\n-      activesupport (= 7.2.2.1)\n+      railties (>= 8.0.0, < 9)\n+    railties (8.0.1)\n+      actionpack (= 8.0.1)\n+      activesupport (= 8.0.1)\n       irb (~> 1.13)\n       rackup (>= 1.0.0)\n       rake (>= 12.2)\n@@ -986,9 +986,9 @@ DEPENDENCIES\n   rack-attack (~> 6.6)\n   rack-cors (~> 2.0)\n   rack-test (~> 2.1)\n-  rails (~> 7.2.0)\n+  rails (~> 8.0)\n   rails-controller-testing (~> 1.0)\n-  rails-i18n (~> 7.0)\n+  rails-i18n (~> 8.0)\n   rdf-normalize (~> 0.5)\n   redcarpet (~> 3.6)\n   redis (~> 4.5)\n---\nconfig/application.rb\n@@ -59,7 +59,7 @@\n module Mastodon\n   class Application < Rails::Application\n     # Initialize configuration defaults for originally generated Rails version.\n-    config.load_defaults 7.2\n+    config.load_defaults 8.0\n \n     # Please, add to the `ignore` list any other `lib` subdirectories that do\n     # not contain `.rb` files, or that should not be reloaded or eager loaded.\n---\nconfig/initializers/filter_parameter_logging.rb\n@@ -6,5 +6,5 @@\n # Use this to limit dissemination of sensitive information.\n # See the ActiveSupport::ParameterFilter documentation for supported notations and behaviors.\n Rails.application.config.filter_parameters += [\n-  :passw, :email, :secret, :token, :_key, :crypt, :salt, :certificate, :otp, :ssn\n+  :passw, :email, :secret, :token, :_key, :crypt, :salt, :certificate, :otp, :ssn, :cvv, :cvc\n ]\n---\nlib/active_record/batches.rb\n@@ -13,7 +13,9 @@ def pluck_each(*column_names)\n \n       column_names.unshift(primary_key)\n \n-      relation = relation.reorder(build_batch_orders(order).to_h).limit(batch_limit)\n+      cursor = Array(primary_key)\n+\n+      relation = relation.reorder(build_batch_orders(cursor, order).to_h).limit(batch_limit)\n       relation.skip_query_cache!\n \n       batch_relation = relation\n---\nspec/rails_helper.rb\n@@ -119,6 +119,11 @@ def sign_in(resource, _deprecated = nil, scope: nil)\n   config.include CommandLineHelpers, type: :cli\n   config.include SystemHelpers, type: :system\n \n+  # TODO: Remove when Devise fixes https://github.com/heartcombo/devise/issues/5705\n+  config.before do\n+    Rails.application.reload_routes_unless_loaded\n+  end\n+\n   config.around(:each, use_transactional_tests: false) do |example|\n     self.use_transactional_tests = false\n     example.run\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/components/hashtag_bar.jsx\n@@ -0,0 +1,50 @@\n+import PropTypes from 'prop-types';\n+import { useMemo, useState, useCallback } from 'react';\n+\n+import { FormattedMessage } from 'react-intl';\n+\n+import { Link } from 'react-router-dom';\n+\n+import ImmutablePropTypes from 'react-immutable-proptypes';\n+\n+const domParser = new DOMParser();\n+\n+// About two lines on desktop\n+const VISIBLE_HASHTAGS = 7;\n+\n+export const HashtagBar = ({ hashtags, text }) => {\n+  const renderedHashtags = useMemo(() => {\n+    const body = domParser.parseFromString(text, 'text/html').documentElement;\n+    return [].map.call(body.querySelectorAll('[rel=tag]'), node => node.textContent.toLowerCase());\n+  }, [text]);\n+\n+  const invisibleHashtags = useMemo(() => (\n+    hashtags.filter(hashtag => !renderedHashtags.some(textContent => textContent === `#${hashtag.get('name')}` || textContent === hashtag.get('name')))\n+  ), [hashtags, renderedHashtags]);\n+\n+  const [expanded, setExpanded] = useState(false);\n+  const handleClick = useCallback(() => setExpanded(true), []);\n+\n+  if (invisibleHashtags.isEmpty()) {\n+    return null;\n+  }\n+\n+  const revealedHashtags = expanded ? invisibleHashtags : invisibleHashtags.take(VISIBLE_HASHTAGS);\n+\n+  return (\n+    <div className='hashtag-bar'>\n+      {revealedHashtags.map(hashtag => (\n+        <Link key={hashtag.get('name')} to={`/tags/${hashtag.get('name')}`}>\n+          #{hashtag.get('name')}\n+        </Link>\n+      ))}\n+\n+      {!expanded && invisibleHashtags.size > VISIBLE_HASHTAGS && <button className='link-button' onClick={handleClick}><FormattedMessage id='hashtags.and_other' defaultMessage='\u2026and {count, plural, other {# more}}' values={{ count: invisibleHashtags.size - VISIBLE_HASHTAGS }} /></button>}\n+    </div>\n+  );\n+};\n+\n+HashtagBar.propTypes = {\n+  hashtags: ImmutablePropTypes.list,\n+  text: PropTypes.string,\n+};\n\\ No newline at end of file\n---\napp/javascript/mastodon/components/status.jsx\n@@ -22,6 +22,7 @@ import { displayMedia } from '../initial_state';\n import { Avatar } from './avatar';\n import { AvatarOverlay } from './avatar_overlay';\n import { DisplayName } from './display_name';\n+import { HashtagBar } from './hashtag_bar';\n import { RelativeTimestamp } from './relative_timestamp';\n import StatusActionBar from './status_action_bar';\n import StatusContent from './status_content';\n@@ -580,6 +581,8 @@ class Status extends ImmutablePureComponent {\n \n             {media}\n \n+            <HashtagBar hashtags={status.get('tags')} text={status.get('content')} />\n+\n             <StatusActionBar scrollKey={scrollKey} status={status} account={account} onFilter={matchedFilters ? this.handleFilterClick : null} {...other} />\n           </div>\n         </div>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -10,6 +10,7 @@ import ImmutablePureComponent from 'react-immutable-pure-component';\n \n import { AnimatedNumber } from 'mastodon/components/animated_number';\n import EditedTimestamp from 'mastodon/components/edited_timestamp';\n+import { HashtagBar } from 'mastodon/components/hashtag_bar';\n import { Icon }  from 'mastodon/components/icon';\n import PictureInPicturePlaceholder from 'mastodon/components/picture_in_picture_placeholder';\n \n@@ -314,6 +315,8 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           {media}\n \n+          <HashtagBar hashtags={status.get('tags')} text={status.get('content')} />\n+\n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n               <FormattedDate value={new Date(status.get('created_at'))} hour12={false} year='numeric' month='short' day='2-digit' hour='2-digit' minute='2-digit' />\n---\napp/javascript/mastodon/locales/en.json\n@@ -300,6 +300,7 @@\n   \"hashtag.counter_by_uses_today\": \"{count, plural, one {{counter} post} other {{counter} posts}} today\",\n   \"hashtag.follow\": \"Follow hashtag\",\n   \"hashtag.unfollow\": \"Unfollow hashtag\",\n+  \"hashtags.and_other\": \"\u2026and {count, plural, other {# more}}\",\n   \"home.actions.go_to_explore\": \"See what's trending\",\n   \"home.actions.go_to_suggestions\": \"Find people to follow\",\n   \"home.column_settings.basic\": \"Basic\",\n---\napp/javascript/styles/mastodon/components.scss\n@@ -9256,3 +9256,26 @@ noscript {\n     }\n   }\n }\n+\n+.hashtag-bar {\n+  margin-top: 16px;\n+  display: flex;\n+  flex-wrap: wrap;\n+  font-size: 14px;\n+  gap: 4px;\n+\n+  a {\n+    display: inline-flex;\n+    border-radius: 4px;\n+    background: rgba($highlight-text-color, 0.2);\n+    color: $highlight-text-color;\n+    padding: 0.4em 0.6em;\n+    text-decoration: none;\n+\n+    &:hover,\n+    &:focus,\n+    &:active {\n+      background: rgba($highlight-text-color, 0.3);\n+    }\n+  }\n+}\n---\napp/javascript/mastodon/components/status.jsx\n@@ -546,6 +546,7 @@ class Status extends ImmutablePureComponent {\n     const visibilityIcon = visibilityIconInfo[status.get('visibility')];\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n+    const expanded = !status.get('hidden')\n \n     return (\n       <HotKeys handlers={handlers}>\n@@ -574,7 +575,7 @@ class Status extends ImmutablePureComponent {\n             <StatusContent\n               status={status}\n               onClick={this.handleClick}\n-              expanded={!status.get('hidden')}\n+              expanded={expanded}\n               onExpandedToggle={this.handleExpandedToggle}\n               onTranslate={this.handleTranslate}\n               collapsible\n@@ -584,7 +585,7 @@ class Status extends ImmutablePureComponent {\n \n             {media}\n \n-            {hashtagBar}\n+            {expanded && hashtagBar}\n \n             <StatusActionBar scrollKey={scrollKey} status={status} account={account} onFilter={matchedFilters ? this.handleFilterClick : null} {...other} />\n           </div>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -293,6 +293,7 @@ class DetailedStatus extends ImmutablePureComponent {\n     }\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n+    const expanded = !status.get('hidden')\n \n     return (\n       <div style={outerStyle}>\n@@ -318,7 +319,7 @@ class DetailedStatus extends ImmutablePureComponent {\n \n           {media}\n \n-          {hashtagBar}\n+          {expanded && hashtagBar}\n \n           <div className='detailed-status__meta'>\n             <a className='detailed-status__datetime' href={`/@${status.getIn(['account', 'acct'])}/${status.get('id')}`} target='_blank' rel='noopener noreferrer'>\n---\n\n\n---\n\nChoice D:\ndb/post_migrate/20230811103651_remove_index_preview_cards_statuses_on_status_id_and_preview_card_id.rb\n@@ -0,0 +1,9 @@\n+# frozen_string_literal: true\n+\n+class RemoveIndexPreviewCardsStatusesOnStatusIdAndPreviewCardId < ActiveRecord::Migration[7.0]\n+  disable_ddl_transaction!\n+\n+  def change\n+    remove_index :preview_cards_statuses, column: [:status_id, :preview_card_id], name: :index_preview_cards_statuses_on_status_id_and_preview_card_id\n+  end\n+end\n---\ndb/schema.rb\n@@ -10,7 +10,7 @@\n #\n # It's strongly recommended that you check this file into your version control system.\n \n-ActiveRecord::Schema[7.0].define(version: 2023_08_03_112520) do\n+ActiveRecord::Schema[7.0].define(version: 2023_08_11_103651) do\n   # These are extensions that must be enabled in order to support this database\n   enable_extension \"plpgsql\"\n \n@@ -809,7 +809,6 @@\n   create_table \"preview_cards_statuses\", primary_key: [\"status_id\", \"preview_card_id\"], force: :cascade do |t|\n     t.bigint \"preview_card_id\", null: false\n     t.bigint \"status_id\", null: false\n-    t.index [\"status_id\", \"preview_card_id\"], name: \"index_preview_cards_statuses_on_status_id_and_preview_card_id\"\n   end\n \n   create_table \"relays\", force: :cascade do |t|\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Open live feed on deck mode (Not pinned)\r\n2. Click header \"Live feed\"\r\n3.\r\n...\r\n\n\n### Expected behaviour\n\nScroll up to top\n\n### Actual behaviour\n\nNot scroll up to top\n\n### Detailed description\n\n![image](https://github.com/mastodon/mastodon/assets/5047683/a693a2e9-48ff-428f-a972-9c7d99356896)\r\nClicking red area is not working (Even the mouse cursor is changed into hand icon. which means clickable)\r\nClicking blue area is working but Unnecessarily `history.pushstate`\r\n\r\nOn single column layout. It works as intended\n\n### Mastodon instance\n\nqdon.space, mastodon.social\n\n### Mastodon version\n\nv4.1.5, v4.2.0+nightly-2023-08-09\n\n### Browser name and version\n\nFirefox 115.0.1\n\n### Operating system\n\nUbuntu 22.04\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/components/column.jsx\n@@ -16,7 +16,19 @@ export default class Column extends PureComponent {\n   };\n \n   scrollTop () {\n-    const scrollable = this.props.bindToDocument ? document.scrollingElement : this.node.querySelector('.scrollable');\n+    let scrollable = null;\n+\n+    if (this.props.bindToDocument) {\n+      scrollable = document.scrollingElement;\n+    } else {\n+      scrollable = this.node.querySelector('.scrollable');\n+\n+      // Some columns have nested `.scrollable` containers, with the outer one\n+      // being a wrapper while the actual scrollable content is deeper.\n+      if (scrollable.classList.contains('scrollable--flex')) {\n+        scrollable = scrollable?.querySelector('.scrollable') || scrollable;\n+      }\n+   }\n \n     if (!scrollable) {\n       return;\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -1996,6 +1996,7 @@ body > [data-popper-placement] {\n \n         &__handle {\n           user-select: all;\n+          overflow-wrap: anywhere;\n         }\n       }\n \n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -284,6 +284,7 @@\n   font-size: 11px;\n   padding: 0 3px;\n   line-height: 27px;\n+  white-space: nowrap;\n \n   &:hover,\n   &:active,\n---\n\n\n---\n\nChoice D:\nlib/mastodon/cli/media.rb\n@@ -128,7 +128,7 @@ def remove_orphans\n \n             model_name      = path_segments.first.classify\n             attachment_name = path_segments[1].singularize\n-            record_id       = path_segments[2..-2].join.to_i\n+            record_id       = path_segments[2...-2].join.to_i\n             file_name       = path_segments.last\n             record          = record_map.dig(model_name, record_id)\n             attachment      = record&.public_send(attachment_name)\n@@ -172,7 +172,7 @@ def remove_orphans\n           end\n \n           model_name      = path_segments.first.classify\n-          record_id       = path_segments[2..-2].join.to_i\n+          record_id       = path_segments[2...-2].join.to_i\n           attachment_name = path_segments[1].singularize\n           file_name       = path_segments.last\n \n@@ -297,7 +297,7 @@ def lookup(url)\n       fail_with_message 'Not a media URL' unless VALID_PATH_SEGMENTS_SIZE.include?(path_segments.size)\n \n       model_name = path_segments.first.classify\n-      record_id  = path_segments[2..-2].join.to_i\n+      record_id  = path_segments[2...-2].join.to_i\n \n       fail_with_message \"Cannot find corresponding model: #{model_name}\" unless PRELOAD_MODEL_WHITELIST.include?(model_name)\n \n@@ -353,7 +353,7 @@ def preload_records_from_mixed_objects(objects)\n         next unless VALID_PATH_SEGMENTS_SIZE.include?(segments.size)\n \n         model_name = segments.first.classify\n-        record_id  = segments[2..-2].join.to_i\n+        record_id  = segments[2...-2].join.to_i\n \n         next unless PRELOAD_MODEL_WHITELIST.include?(model_name)\n \n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Upload a video file\r\n\r\n### Expected behaviour\r\n\r\nVideo upload works\r\n\r\n### Actual behaviour\r\n\r\nVideo upload doesn't work\r\n\r\n### Detailed description\r\n\r\nSidekiq fails to fetch the original file uploaded to s3 : \r\n```\r\nI, [2023-08-08T16:34:56.401628 #7]  INFO -- : [paperclip] copying media_attachments/files/110/854/961/122/467/275/original/9546231f02c0d6d5.mp4 to local file /tmp/eccccece145f3f7b1fe05ca4a9a938fe20230808-7-30jgaa.mp4\r\nD, [2023-08-08T16:34:56.564749 #7] DEBUG -- : [httplog] HEAD http://x.r2.cloudflarestorage.com:443/rivals-space-media/media_attachments/files/110/854/961/122/467/275/original/9546231f02c0d6d5.mp4?partNumber=1 completed with status code 501 in 0.031263 seconds\r\nAws::S3::Errors::Http501Error - cannot copy media_attachments/files/110/854/961/122/467/275/original/9546231f02c0d6d5.mp4 to local file /tmp/eccccece145f3f7b1fe05ca4a9a938fe20230808-7-30jgaa.mp4\r\nD, [2023-08-08T16:34:56.723062 #7] DEBUG -- : [httplog] HEAD http://x.r2.cloudflarestorage.com:443/rivals-space-media/media_attachments/files/110/854/961/122/467/275/original/9546231f02c0d6d5.mp4 completed with status code 200 in 0.156776 seconds\r\n2023-08-08T16:34:56.794Z pid=7 tid=3jur class=PostProcessMediaWorker jid=6fc9822e2d8c700282b9f76c ERROR: Processing media attachment 110854961122467275 failed with Error while transcoding /tmp/eccccece145f3f7b1fe05ca4a9a938fe20230808-7-30jgaa.mp4: unsupported file\r\n```\r\n\r\nenv vars are \r\n```\r\nS3_REGION=auto\r\nS3_ENDPOINT=https://redacted.r2.cloudflarestorage.com\r\nS3_ENABLED=true\r\nS3_HOSTNAME=cdn.rivals.space\r\nS3_PROTOCOL=https\r\nS3_PERMISSION=\r\nS3_ALIAS_HOST=cdn.rivals.space\r\nS3_BUCKET=redacted\r\nAWS_SECRET_ACCESS_KEY=redacted\r\nAWS_ACCESS_KEY_ID=redacted\r\n```\r\n\r\n### Mastodon instance\r\n\r\nrivals.space\r\n\r\n### Mastodon version\r\n\r\nv4.1.6+nightly-2023-08-08\r\n\r\n### Technical details\r\n\r\nUsing 2023-08-08 nightly docker image\n\n---\n\nChoice A:\nconfig/initializers/paperclip.rb\n@@ -88,6 +88,19 @@\n \n   Paperclip::Attachment.default_options[:s3_headers]['X-Amz-Storage-Class'] = ENV['S3_STORAGE_CLASS'] if ENV.has_key?('S3_STORAGE_CLASS')\n \n+  # Some S3 providers are not compatible with the checksum mode\n+  # See https://github.com/mastodon/mastodon/issues/26394\n+  if ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n+    module Aws::S3::FileDownloaderExtensions\n+      def validate!\n+        @params.delete(:checksum_mode)\n+        super\n+      end\n+    end\n+\n+    Aws::S3::FileDownloader.prepend(Aws::S3::FileDownloaderExtensions)\n+  end\n+\n   # Some S3-compatible providers might not actually be compatible with some APIs\n   # used by kt-paperclip, see https://github.com/mastodon/mastodon/issues/16822\n   if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n---\nconfig/initializers/paperclip.rb\n@@ -90,13 +90,19 @@\n \n   # Some S3-compatible providers might not actually be compatible with some APIs\n   # used by kt-paperclip, see https://github.com/mastodon/mastodon/issues/16822\n-  if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n+  # and https://github.com/mastodon/mastodon/issues/26394\n+  if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true' || ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n     module Paperclip\n       module Storage\n         module S3Extensions\n           def copy_to_local_file(style, local_dest_path)\n             log(\"copying #{path(style)} to local file #{local_dest_path}\")\n-            s3_object(style).download_file(local_dest_path, { mode: 'single_request' })\n+\n+            options = {}\n+            options[:mode] = 'single_request' if ENV['S3_FORCE_SINGLE_REQUEST'] == 'true'\n+            options[:checksum_mode] = 'DISABLED' if ENV['S3_DISABLE_CHECKSUM_MODE'] == 'true'\n+\n+            s3_object(style).download_file(local_dest_path, options)\n           rescue Aws::Errors::ServiceError => e\n             warn(\"#{e} - cannot copy #{path(style)} to local file #{local_dest_path}\")\n             false\n---\n\n\n---\n\nChoice B:\ndocs/Using-Mastodon/List-of-Mastodon-instances.md\n@@ -65,7 +65,7 @@ There is also a list at [instances.mastodon.xyz](https://instances.mastodon.xyz)\n | [off-the-clock.us](https://off-the-clock.us/)|The work day is over.|Yes|No|\n | [infinimatix.net](https://infinimatix.net)|Informatics|Yes|Yes|\n | [social.0day.agency](https://social.0day.agency)|Infosec, Hacking, Fun (only protonmail)|Yes|Yes|\n-| [kagrumez.lerk.io](https://kagrumez.lerk.io)|Open registration. German end english.|Yes|No|\n+| [social.k40s.net](https://social.k40s.net)|Open registration. German end english.|Yes|No|\n | [meow.social](https://meow.social)|A furry fandom focused instance|Yes|No|\n | [neumastodon.com](https://neumastodon.com/)|Northeastern University Mastodon |Yes|No|\n | [dancingbanana.party](https://dancingbanana.party)|La banane qui danse.|Yes|No|\n---\napp/lib/status_finder.rb\n@@ -10,6 +10,8 @@ def initialize(url)\n   def status\n     verify_action!\n \n+    raise ActiveRecord::RecordNotFound unless TagManager.instance.local_url?(url)\n+\n     case recognized_params[:controller]\n     when 'stream_entries'\n       StreamEntry.find(recognized_params[:id]).status\n---\nspec/controllers/api/oembed_controller_spec.rb\n@@ -8,6 +8,7 @@\n \n   describe 'GET #show' do\n     before do\n+      request.host = Rails.configuration.x.local_domain\n       get :show, params: { url: account_stream_entry_url(alice, status.stream_entry) }, format: :json\n     end\n \n---\nspec/lib/status_finder_spec.rb\n@@ -34,6 +34,16 @@\n       end\n     end\n \n+    context 'with a remote url even if id exists on local' do\n+      let(:status) { Fabricate(:status) }\n+      let(:url) { \"https://example.com/users/test/statuses/#{status.id}\" }\n+      subject { described_class.new(url) }\n+\n+      it 'raises an error' do\n+        expect { subject.status }.to raise_error(ActiveRecord::RecordNotFound)\n+      end\n+    end\n+\n     context 'with a plausible url' do\n       let(:url) { 'https://example.com/users/test/updates/123/embed' }\n       subject { described_class.new(url) }\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/components/dismissable_banner.tsx\n@@ -1,11 +1,18 @@\n+/* eslint-disable @typescript-eslint/no-unsafe-call,\n+                  @typescript-eslint/no-unsafe-return,\n+                  @typescript-eslint/no-unsafe-assignment,\n+                  @typescript-eslint/no-unsafe-member-access\n+                  -- the settings store is not yet typed */\n import type { PropsWithChildren } from 'react';\n-import { useCallback, useState } from 'react';\n+import { useCallback, useState, useEffect } from 'react';\n \n import { defineMessages, useIntl } from 'react-intl';\n \n import { ReactComponent as CloseIcon } from '@material-symbols/svg-600/outlined/close.svg';\n \n+import { changeSetting } from 'mastodon/actions/settings';\n import { bannerSettings } from 'mastodon/settings';\n+import { useAppSelector, useAppDispatch } from 'mastodon/store';\n \n import { IconButton } from './icon_button';\n \n@@ -21,13 +28,25 @@ export const DismissableBanner: React.FC<PropsWithChildren<Props>> = ({\n   id,\n   children,\n }) => {\n-  const [visible, setVisible] = useState(!bannerSettings.get(id));\n+  const dismissed = useAppSelector((state) =>\n+    state.settings.getIn(['dismissed_banners', id], false),\n+  );\n+  const dispatch = useAppDispatch();\n+\n+  const [visible, setVisible] = useState(!bannerSettings.get(id) && !dismissed);\n   const intl = useIntl();\n \n   const handleDismiss = useCallback(() => {\n     setVisible(false);\n     bannerSettings.set(id, true);\n-  }, [id]);\n+    dispatch(changeSetting(['dismissed_banners', id], true));\n+  }, [id, dispatch]);\n+\n+  useEffect(() => {\n+    if (!visible && !dismissed) {\n+      dispatch(changeSetting(['dismissed_banners', id], true));\n+    }\n+  }, [id, dispatch, visible, dismissed]);\n \n   if (!visible) {\n     return null;\n---\napp/javascript/mastodon/reducers/settings.js\n@@ -100,6 +100,15 @@ const initialState = ImmutableMap({\n       body: '',\n     }),\n   }),\n+\n+  dismissed_banners: ImmutableMap({\n+    'public_timeline': false,\n+    'community_timeline': false,\n+    'home.explore_prompt': false,\n+    'explore/links': false,\n+    'explore/statuses': false,\n+    'explore/tags': false,\n+  }),\n });\n \n const defaultColumns = fromJS([\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/home_timeline/components/inline_follow_suggestions.jsx\n@@ -129,8 +129,13 @@ export const InlineFollowSuggestions = ({ hidden }) => {\n       return;\n     }\n \n-    setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n-    setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    if (getComputedStyle(bodyRef.current).direction === 'rtl') {\n+      setCanScrollLeft((bodyRef.current.clientWidth - bodyRef.current.scrollLeft) < bodyRef.current.scrollWidth);\n+      setCanScrollRight(bodyRef.current.scrollLeft < 0);\n+    } else {\n+      setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n+      setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    }\n   }, [setCanScrollRight, setCanScrollLeft, bodyRef, suggestions]);\n \n   const handleLeftNav = useCallback(() => {\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. add a domain block for `test.example`\r\n2. add a domain block for `subdomain.test.example`\n\n### Expected behaviour\n\nAt least one of the domain blocks should have remained in place, probably the base domain.\n\n### Actual behaviour\n\nThe base domain block was mysteriously removed, and the subdomain block does not appear to have been added either, although it is logged as being added in the audit log.\n\n### Detailed description\n\nAt a minimum, the base domain probably should be left in place.\r\n\r\nIdeally, an information warning or error message should be generated to inform the user of whatever actual actions were taken, such as indicating failure and instructing them to remove the base domain first.\r\n\r\nAudit log should accurately reflect whatever actions were actually taken.\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\nv4.1.5\n\n### Technical details\n\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: ruby 3.0.6p216 (2023-03-30 revision 23a532679b) [x86_64-linux]\r\n- Node.js version: v16.20.1\r\n\r\n\n\n---\n\nChoice A:\napp/helpers/languages_helper.rb\n@@ -254,6 +254,7 @@ def standard_locale_name(locale)\n \n   def valid_locale_or_nil(str)\n     return if str.blank?\n+    return str if valid_locale?(str)\n \n     code, = str.to_s.split(/[_-]/) # Strip out the region from e.g. en_US or ja-JP\n \n---\n\n\n---\n\nChoice B:\napp/controllers/admin/domain_blocks_controller.rb\n@@ -37,7 +37,7 @@ def create\n         @domain_block.errors.delete(:domain)\n         render :new\n       else\n-        if existing_domain_block.present?\n+        if existing_domain_block.present? && existing_domain_block.domain == resource_params[:domain]\n           @domain_block = existing_domain_block\n           @domain_block.update(resource_params)\n         end\n---\nspec/controllers/admin/domain_blocks_controller_spec.rb\n@@ -68,6 +68,26 @@\n       expect(flash[:notice]).to eq I18n.t('admin.domain_blocks.created_msg')\n       expect(response).to redirect_to(admin_instances_path(limited: '1'))\n     end\n+\n+    context 'when a block for a parent domain already exists' do\n+      subject { post :create, params: { domain_block: { domain: 'subdomain.example.com', severity: child_severity } } }\n+\n+      let(:parent_severity) { 'silence' }\n+      let(:child_severity)  { 'suspend' }\n+\n+      before do\n+        Fabricate(:domain_block, domain: 'example.com', severity: parent_severity)\n+      end\n+\n+      it 'does not change the existing block' do\n+        expect { subject }.to_not change { DomainBlock.find_by(domain: 'example.com') }\n+      end\n+\n+      it 'creates a domain block with expected severity' do\n+        subject\n+        expect(DomainBlock.where(domain: 'subdomain.example.com', severity: child_severity)).to exist\n+      end\n+    end\n   end\n \n   describe 'PUT #update' do\n---\napp/controllers/admin/domain_blocks_controller.rb\n@@ -40,7 +40,7 @@ def create\n       end\n \n       # Allow transparently upgrading a domain block\n-      if existing_domain_block.present?\n+      if existing_domain_block.present? && existing_domain_block.domain == TagManager.instance.normalize_domain(@domain_block.domain.strip)\n         @domain_block = existing_domain_block\n         @domain_block.assign_attributes(resource_params)\n       end\n---\nspec/features/admin/domain_blocks_spec.rb\n@@ -57,6 +57,30 @@\n     end\n   end\n \n+  context 'when suspending a subdomain of an already-silenced domain' do\n+    it 'presents a confirmation screen before suspending the domain' do\n+      domain_block = Fabricate(:domain_block, domain: 'example.com', severity: 'silence')\n+\n+      visit new_admin_domain_block_path\n+\n+      fill_in 'domain_block_domain', with: 'subdomain.example.com'\n+      select I18n.t('admin.domain_blocks.new.severity.suspend'), from: 'domain_block_severity'\n+      click_on I18n.t('admin.domain_blocks.new.create')\n+\n+      # It presents a confirmation screen\n+      expect(page).to have_title(I18n.t('admin.domain_blocks.confirm_suspension.title', domain: 'subdomain.example.com'))\n+\n+      # Confirming creates the block\n+      click_on I18n.t('admin.domain_blocks.confirm_suspension.confirm')\n+\n+      expect(DomainBlock.where(domain: 'subdomain.example.com', severity: 'suspend')).to exist\n+\n+      # And leaves the previous block alone\n+      expect(domain_block.reload.severity).to eq 'silence'\n+      expect(domain_block.reload.domain).to eq 'example.com'\n+    end\n+  end\n+\n   context 'when editing a domain block' do\n     it 'presents a confirmation screen before suspending the domain' do\n       domain_block = Fabricate(:domain_block, domain: 'example.com', severity: 'silence')\n---\n\n\n---\n\nChoice C:\ndb/migrate/20240304090449_migrate_interaction_settings_to_policy.rb\n@@ -20,6 +20,9 @@ class NotificationPolicy < ApplicationRecord\n   def up\n     User.includes(account: :notification_policy).find_each do |user|\n       deserialized_settings = Oj.load(user.attributes_before_type_cast['settings'])\n+\n+      next if deserialized_settings.nil?\n+\n       policy = user.account.notification_policy || user.account.build_notification_policy\n       requires_new_policy = false\n \n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/reducers/compose.js\n@@ -402,7 +402,7 @@ export default function compose(state = initialState, action) {\n       .set('isUploadingThumbnail', false)\n       .update('media_attachments', list => list.map(item => {\n         if (item.get('id') === action.media.id) {\n-          return fromJS(action.media);\n+          return fromJS(action.media).set('unattached', item.get('unattached'));\n         }\n \n         return item;\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Run Mastodon from main branch (commit 04e7efac3f2ebb4336c48335720611120eae19ba)\r\n2. Open local/federated timeline and scroll down to load new posts\n\n### Expected behaviour\n\nNew posts get loaded\n\n### Actual behaviour\n\nInternal Server Error\n\n### Detailed description\n\nTraceback:\r\n\r\n```\r\nFATAL -- : [86768a25-be09-4501-9f7a-6180adfff631]\r\nActiveModel::MissingAttributeError (missing attribute: image_description):\r\n\r\napp/controllers/api/v1/timelines/home_controller.rb:14:in `show'\r\napp/controllers/concerns/localized.rb:11:in `set_locale'\r\nlib/mastodon/rack_middleware.rb:9:in `call'\r\n```\r\n\r\nReverting to a commit before 8da99ffb0dcf5012179e4142799ff473910f5a66 (and rolling back associated migrations) fixes the issue.\n\n### Mastodon instance\n\nohai.social\n\n### Mastodon version\n\nmain (04e7efac3f2ebb4336c48335720611120eae19ba)\n\n### Technical details\n\n- Ruby version: 3.2.2\r\n- Node.js version: 16.20.1\n\n---\n\nChoice A:\napp/javascript/mastodon/features/home_timeline/components/inline_follow_suggestions.jsx\n@@ -129,8 +129,13 @@ export const InlineFollowSuggestions = ({ hidden }) => {\n       return;\n     }\n \n-    setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n-    setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    if (getComputedStyle(bodyRef.current).direction === 'rtl') {\n+      setCanScrollLeft((bodyRef.current.clientWidth - bodyRef.current.scrollLeft) < bodyRef.current.scrollWidth);\n+      setCanScrollRight(bodyRef.current.scrollLeft < 0);\n+    } else {\n+      setCanScrollLeft(bodyRef.current.scrollLeft > 0);\n+      setCanScrollRight((bodyRef.current.scrollLeft + bodyRef.current.clientWidth) < bodyRef.current.scrollWidth);\n+    }\n   }, [setCanScrollRight, setCanScrollLeft, bodyRef, suggestions]);\n \n   const handleLeftNav = useCallback(() => {\n---\n\n\n---\n\nChoice B:\napp/models/status.rb\n@@ -162,7 +162,7 @@ class Status < ApplicationRecord\n   REAL_TIME_WINDOW = 6.hours\n \n   def cache_key\n-    \"v2:#{super}\"\n+    \"v3:#{super}\"\n   end\n \n   def searchable_by(preloaded = nil)\n---\n\n\n---\n\nChoice C:\napp/models/tag.rb\n@@ -37,7 +37,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?<![=/)\\w])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}i\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]\\u0E47-\\u0E4E#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/tag_spec.rb\n@@ -36,6 +36,10 @@\n       expect(subject.match('https://gcc.gnu.org/bugzilla/show_bug.cgi?id=111895#c4')).to be_nil\n     end\n \n+    it 'does not match URLs with hashtag-like anchors after a non-ascii character' do\n+      expect(subject.match('https://example.org/test\u00e9#foo')).to be_nil\n+    end\n+\n     it 'does not match URLs with hashtag-like anchors after an empty query parameter' do\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)?foo=#Lawsuit')).to be_nil\n     end\n---\n\n\n---\n\nChoice D:\napp/controllers/concerns/web_app_controller_concern.rb\n@@ -11,7 +11,7 @@ module WebAppControllerConcern\n   end\n \n   def skip_csrf_meta_tags?\n-    !(ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1) && current_user.nil?\n+    !(ENV['ONE_CLICK_SSO_LOGIN'] == 'true' && ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1) && current_user.nil?\n   end\n \n   def set_app_body_class\n---\napp/serializers/initial_state_serializer.rb\n@@ -113,6 +113,6 @@ def instance_presenter\n   end\n \n   def sso_redirect\n-    \"/auth/auth/#{Devise.omniauth_providers[0]}\" if ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1\n+    \"/auth/auth/#{Devise.omniauth_providers[0]}\" if ENV['ONE_CLICK_SSO_LOGIN'] == 'true' && ENV['OMNIAUTH_ONLY'] == 'true' && Devise.omniauth_providers.length == 1\n   end\n end\n---\nconfig/initializers/content_security_policy.rb\n@@ -19,6 +19,22 @@ def host_to_url(str)\n media_host ||= host_to_url(ENV['S3_HOSTNAME']) if ENV['S3_ENABLED'] == 'true'\n media_host ||= assets_host\n \n+def sso_host\n+  return unless ENV['ONE_CLICK_SSO_LOGIN'] == 'true'\n+  return unless ENV['OMNIAUTH_ONLY'] == 'true'\n+  return unless Devise.omniauth_providers.length == 1\n+\n+  provider = Devise.omniauth_configs[Devise.omniauth_providers[0]]\n+  @sso_host ||= begin\n+    # using CAS\n+    provider.cas_url if ENV['CAS_ENABLED'] == 'true'\n+    # using SAML\n+    provider.options[:idp_sso_target_url] if ENV['SAML_ENABLED'] == 'true'\n+    # or using OIDC\n+    ENV['OIDC_AUTH_ENDPOINT'] || (OpenIDConnect::Discovery::Provider::Config.discover!(ENV['OIDC_ISSUER']).authorization_endpoint if ENV['OIDC_ENABLED'] == 'true')\n+  end\n+end\n+\n Rails.application.config.content_security_policy do |p|\n   p.base_uri        :none\n   p.default_src     :none\n@@ -29,7 +45,13 @@ def host_to_url(str)\n   p.media_src       :self, :https, :data, assets_host\n   p.frame_src       :self, :https\n   p.manifest_src    :self, assets_host\n-  p.form_action     :self\n+\n+  if sso_host.present?\n+    p.form_action     :self, sso_host\n+  else\n+    p.form_action     :self\n+  end\n+\n   p.child_src       :self, :blob, assets_host\n   p.worker_src      :self, :blob, assets_host\n \n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Use the advanced interface and light mode\r\n2. Pin a hashtag\r\n3. Open the column settings\r\n4. Click \"include additional hashtags for this column\"\r\n5. Start typing a hashtag\r\n\n\n### Expected behaviour\n\nThe menu colors are correct\n\n### Actual behaviour\n\nThe text is not readable. I am not sure if this the menu background or the text color that is wrong.\n\n### Detailed description\n\n<img width=\"386\" alt=\"image\" src=\"https://github.com/mastodon/mastodon/assets/42070/e29fd37d-f9f0-4700-82f6-d5cead59ecea\">\r\n\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.1.5+nightly-2023-07-31\n\n### Browser name and version\n\nSafari 16\n\n### Operating system\n\nmacOS 13.5\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\ndb/post_migrate/20230811103651_remove_index_preview_cards_statuses_on_status_id_and_preview_card_id.rb\n@@ -0,0 +1,9 @@\n+# frozen_string_literal: true\n+\n+class RemoveIndexPreviewCardsStatusesOnStatusIdAndPreviewCardId < ActiveRecord::Migration[7.0]\n+  disable_ddl_transaction!\n+\n+  def change\n+    remove_index :preview_cards_statuses, column: [:status_id, :preview_card_id], name: :index_preview_cards_statuses_on_status_id_and_preview_card_id\n+  end\n+end\n---\ndb/schema.rb\n@@ -10,7 +10,7 @@\n #\n # It's strongly recommended that you check this file into your version control system.\n \n-ActiveRecord::Schema[7.0].define(version: 2023_08_03_112520) do\n+ActiveRecord::Schema[7.0].define(version: 2023_08_11_103651) do\n   # These are extensions that must be enabled in order to support this database\n   enable_extension \"plpgsql\"\n \n@@ -809,7 +809,6 @@\n   create_table \"preview_cards_statuses\", primary_key: [\"status_id\", \"preview_card_id\"], force: :cascade do |t|\n     t.bigint \"preview_card_id\", null: false\n     t.bigint \"status_id\", null: false\n-    t.index [\"status_id\", \"preview_card_id\"], name: \"index_preview_cards_statuses_on_status_id_and_preview_card_id\"\n   end\n \n   create_table \"relays\", force: :cascade do |t|\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/actions/timelines.js\n@@ -63,10 +63,10 @@ export function updateTimeline(timeline, status, accept) {\n export function deleteFromTimelines(id) {\n   return (dispatch, getState) => {\n     const accountId  = getState().getIn(['statuses', id, 'account']);\n-    const references = getState().get('statuses').filter(status => status.get('reblog') === id).map(status => status.get('id')).toJSON();\n+    const references = getState().get('statuses').filter(status => status.get('reblog') === id).map(status => status.get('id')).valueSeq().toJSON();\n     const reblogOf   = getState().getIn(['statuses', id, 'reblog'], null);\n \n-    dispatch(timelineDelete(id, accountId, references, reblogOf));\n+    dispatch(timelineDelete({ statusId: id, accountId, references, reblogOf }));\n   };\n }\n \n---\napp/javascript/mastodon/reducers/timelines.js\n@@ -159,7 +159,7 @@ const filterTimelines = (state, relationship, statuses) => {\n       return;\n     }\n \n-    references = statuses.filter(item => item.get('reblog') === status.get('id')).map(item => item.get('id'));\n+    references = statuses.filter(item => item.get('reblog') === status.get('id')).map(item => item.get('id')).valueSeq().toJSON();\n     state      = deleteStatus(state, status.get('id'), references, relationship.id);\n   });\n \n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/actions/search.js\n@@ -147,6 +147,10 @@ export const openURL = (value, history, onFailure) => (dispatch, getState) => {\n   const signedIn = !!getState().getIn(['meta', 'me']);\n \n   if (!signedIn) {\n+    if (onFailure) {\n+      onFailure();\n+    }\n+\n     return;\n   }\n \n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -424,6 +424,10 @@ html {\n   border-bottom: 0;\n }\n \n+.column-settings__hashtags .column-select__option {\n+  color: $white;\n+}\n+\n .dashboard__quick-access,\n .focal-point__preview strong,\n .admin-wrapper .content__heading__tabs a.selected {\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nSet `DATABASE_URL` without DB password, and provide DB password through `DB_PASS`.\n\n### Expected behaviour\n\nWeb and streaming servers could connect to database.\n\n### Actual behaviour\n\nStreaming server could not connect to database.\n\n### Detailed description\n\nLet the values of ENV vars be\r\n```\r\nDATABASE_URL=postgresql://user@dbhost.example.com:5432/mastodon_production\r\nDB_PASS=mypassword\r\n```\r\n\r\nand `Rails.application.config.database_configuration[Rails.env]` in rails console looks like\r\n```\r\n   \"database\"=>\"mastodon_production\",\r\n   \"username\"=>\"user\",\r\n   \"password\"=>\"mypassword\",\r\n   \"host\"=>\"dbhost.example.com\",\r\n   \"port\"=>5432,\r\n```\r\n\r\nwhile `pgConfigFromEnv(process.env)` in Node is\r\n```\r\n> pgConfigFromEnv(process.env)\r\n{\r\n  user: 'user',\r\n  password: '',\r\n  port: '5432',\r\n  host: 'dbhost.example.com',\r\n  database: 'mastodon_production',\r\n  max: 10,\r\n  connectionTimeoutMillis: 15000,\r\n  application_name: ''\r\n}\r\n```\r\n\r\nI have tried this setup because this is a k8s deployment and `DATABASE_URL` is provided through configmap while `DB_PASS` is from secret.\n\n### Mastodon instance\n\nt.kaikoga.net\n\n### Mastodon version\n\nv4.1.5+nightly-2023-07-30\n\n### Technical details\n\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: ruby 3.2.2 (2023-03-30 revision e51014f9c0) [x86_64-linux]\r\n- Node.js version: v16.20.1\r\n\r\n\r\n\n\n---\n\nChoice A:\nconfig/initializers/paperclip.rb\n@@ -64,7 +64,7 @@\n       http_open_timeout: ENV.fetch('S3_OPEN_TIMEOUT') { '5' }.to_i,\n       http_read_timeout: ENV.fetch('S3_READ_TIMEOUT') { '5' }.to_i,\n       http_idle_timeout: 5,\n-      retry_limit: 0,\n+      retry_limit: ENV.fetch('S3_RETRY_LIMIT') { '0' }.to_i,\n     }\n   )\n \n---\nconfig/initializers/paperclip.rb\n@@ -64,7 +64,7 @@\n       http_open_timeout: ENV.fetch('S3_OPEN_TIMEOUT'){ '5' }.to_i,\n       http_read_timeout: ENV.fetch('S3_READ_TIMEOUT'){ '5' }.to_i,\n       http_idle_timeout: 5,\n-      retry_limit: 0,\n+      retry_limit: ENV.fetch('S3_RETRY_LIMIT'){ '0' }.to_i,\n     }\n   )\n   \n---\napp/lib/attachment_batch.rb\n@@ -4,7 +4,8 @@ class AttachmentBatch\n   # Maximum amount of objects you can delete in an S3 API call. It's\n   # important to remember that this does not correspond to the number\n   # of records in the batch, since records can have multiple attachments\n-  LIMIT = 1_000\n+  LIMIT = ENV.fetch('S3_BATCH_DELETE_LIMIT', 1000).to_i\n+  MAX_RETRY = ENV.fetch('S3_BATCH_DELETE_RETRY', 3).to_i\n \n   # Attributes generated and maintained by Paperclip (not all of them\n   # are always used on every class, however)\n@@ -95,13 +96,25 @@ def remove_files\n     # objects can be processed at once, so we have to potentially\n     # separate them into multiple calls.\n \n+    retries = 0\n     keys.each_slice(LIMIT) do |keys_slice|\n       logger.debug { \"Deleting #{keys_slice.size} objects\" }\n \n       bucket.delete_objects(delete: {\n         objects: keys_slice.map { |key| { key: key } },\n         quiet: true,\n       })\n+    rescue => e\n+      retries += 1\n+\n+      if retries < MAX_RETRY\n+        logger.debug \"Retry #{retries}/#{MAX_RETRY} after #{e.message}\"\n+        sleep 2**retries\n+        retry\n+      else\n+        logger.error \"Batch deletion from S3 failed after #{e.message}\"\n+        raise e\n+      end\n     end\n   end\n \n---\n\n\n---\n\nChoice B:\nstreaming/index.js\n@@ -109,6 +109,11 @@ const pgConfigFromEnv = (env) => {\n \n   if (env.DATABASE_URL) {\n     baseConfig = dbUrlToConfig(env.DATABASE_URL);\n+\n+    // Support overriding the database password in the connection URL\n+    if (!baseConfig.password && env.DB_PASS) {\n+      baseConfig.password = env.DB_PASS;\n+    }\n   } else {\n     baseConfig = pgConfigs[environment];\n \n---\n\n\n---\n\nChoice C:\ndocs/Using-Mastodon/List-of-Mastodon-instances.md\n@@ -65,7 +65,7 @@ There is also a list at [instances.mastodon.xyz](https://instances.mastodon.xyz)\n | [off-the-clock.us](https://off-the-clock.us/)|The work day is over.|Yes|No|\n | [infinimatix.net](https://infinimatix.net)|Informatics|Yes|Yes|\n | [social.0day.agency](https://social.0day.agency)|Infosec, Hacking, Fun (only protonmail)|Yes|Yes|\n-| [kagrumez.lerk.io](https://kagrumez.lerk.io)|Open registration. German end english.|Yes|No|\n+| [social.k40s.net](https://social.k40s.net)|Open registration. German end english.|Yes|No|\n | [meow.social](https://meow.social)|A furry fandom focused instance|Yes|No|\n | [neumastodon.com](https://neumastodon.com/)|Northeastern University Mastodon |Yes|No|\n | [dancingbanana.party](https://dancingbanana.party)|La banane qui danse.|Yes|No|\n---\napp/lib/status_finder.rb\n@@ -10,6 +10,8 @@ def initialize(url)\n   def status\n     verify_action!\n \n+    raise ActiveRecord::RecordNotFound unless TagManager.instance.local_url?(url)\n+\n     case recognized_params[:controller]\n     when 'stream_entries'\n       StreamEntry.find(recognized_params[:id]).status\n---\nspec/controllers/api/oembed_controller_spec.rb\n@@ -8,6 +8,7 @@\n \n   describe 'GET #show' do\n     before do\n+      request.host = Rails.configuration.x.local_domain\n       get :show, params: { url: account_stream_entry_url(alice, status.stream_entry) }, format: :json\n     end\n \n---\nspec/lib/status_finder_spec.rb\n@@ -34,6 +34,16 @@\n       end\n     end\n \n+    context 'with a remote url even if id exists on local' do\n+      let(:status) { Fabricate(:status) }\n+      let(:url) { \"https://example.com/users/test/statuses/#{status.id}\" }\n+      subject { described_class.new(url) }\n+\n+      it 'raises an error' do\n+        expect { subject.status }.to raise_error(ActiveRecord::RecordNotFound)\n+      end\n+    end\n+\n     context 'with a plausible url' do\n       let(:url) { 'https://example.com/users/test/updates/123/embed' }\n       subject { described_class.new(url) }\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/list_timeline/index.jsx\n@@ -204,7 +204,7 @@ class ListTimeline extends PureComponent {\n           </div>\n \n           <div className='setting-toggle'>\n-            <Toggle id={`list-${id}-exclusive`} defaultChecked={isExclusive} onChange={this.onExclusiveToggle} />\n+            <Toggle id={`list-${id}-exclusive`} checked={isExclusive} onChange={this.onExclusiveToggle} />\n             <label htmlFor={`list-${id}-exclusive`} className='setting-toggle__label'>\n               <FormattedMessage id='lists.exclusive' defaultMessage='Hide these posts from home' />\n             </label>\n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\nWhen importing a blocklist with booleans defined as 'False', the import routine in the web interface fails to recognise these as properly set to 'false', resulting in an assumption that they should be 'true' instead.\r\n\r\n### Expected behaviour\r\n\r\nBooleans should be recognised regardless of case used\r\n\r\n### Actual behaviour\r\n\r\nOnly lowercase imports properly, capitalised fails\r\n\r\n### Detailed description\r\n\r\nWhen importing a blocklist file with the following contents;\r\n```\r\n#domain,#severity,#reject_media,#reject_reports,#public_comment,#obfuscate\r\ndomain.example,silence,False,False,,False\r\n```\r\nMastodon will assume it needs to limit the domain, and reject both media and reports, even though both are set to 'False'. If a lowercase version is used instead, like;\r\n```\r\n#domain,#severity,#reject_media,#reject_reports,#public_comment,#obfuscate\r\ndomain.example,silence,false,false,,false\r\n```\r\nit imports as expected, only limiting the domain, and not rejecting either media or reports. This suggests that there is some form of case sensitivity at play for the booleans in these import files, even though 'False' is a valid expression of that boolean.\r\n\r\nIf this is not intended, it should be considered a bug.\r\n\r\n### Mastodon instance\r\n\r\nngmx.com\r\n\r\n### Mastodon version\r\n\r\nv4.1.5\r\n\r\n### Browser name and version\r\n\r\nFirefox 115.0.2 (64-bit)\r\n\r\n### Operating system\r\n\r\nmacOS 13.5\r\n\r\n### Technical details\r\n\r\nAll details should be in the detailed description field, let me know if you need anything else beyond that. Also, if this is a known issue, please flag it as such. I searched existing tickets and couldn't find anything that covered this particular problem, hence the new ticket.\n\n---\n\nChoice A:\ndocker-compose.yml\n@@ -2,7 +2,7 @@ version: '3'\n services:\n   db:\n     restart: always\n-    image: postgres:14-alpine\n+    image: postgres:15-alpine\n     shm_size: 256mb\n     networks:\n       - internal_network\n@@ -25,7 +25,7 @@ services:\n \n   # es:\n   #   restart: always\n-  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.4\n+  #   image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9\n   #   environment:\n   #     - \"ES_JAVA_OPTS=-Xms512m -Xmx512m -Des.enforce.bootstrap.checks=true\"\n   #     - \"xpack.license.self_generated.type=basic\"\n@@ -56,7 +56,7 @@ services:\n \n   web:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec puma -C config/puma.rb\n@@ -77,7 +77,7 @@ services:\n \n   streaming:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: node ./streaming\n@@ -95,7 +95,7 @@ services:\n \n   sidekiq:\n     build: .\n-    image: ghcr.io/mastodon/mastodon:v4.2.7\n+    image: ghcr.io/mastodon/mastodon:v4.2.8\n     restart: always\n     env_file: .env.production\n     command: bundle exec sidekiq\n---\n\n\n---\n\nChoice B:\nconfig/webpack/shared.js\n@@ -2,6 +2,7 @@\n \n const { basename, dirname, join, relative, resolve } = require('path');\n \n+const CircularDependencyPlugin = require('circular-dependency-plugin');\n const { sync } = require('glob');\n const MiniCssExtractPlugin = require('mini-css-extract-plugin');\n const extname = require('path-complete-extname');\n@@ -84,6 +85,9 @@ module.exports = {\n       writeToDisk: true,\n       publicPath: true,\n     }),\n+    new CircularDependencyPlugin({\n+      failOnError: true,\n+    })\n   ],\n \n   resolve: {\n---\npackage.json\n@@ -59,6 +59,7 @@\n     \"babel-plugin-preval\": \"^5.1.0\",\n     \"babel-plugin-transform-react-remove-prop-types\": \"^0.4.24\",\n     \"blurhash\": \"^2.0.5\",\n+    \"circular-dependency-plugin\": \"^5.2.2\",\n     \"classnames\": \"^2.3.2\",\n     \"cocoon-js-vanilla\": \"^1.3.0\",\n     \"color-blend\": \"^4.0.0\",\n---\nyarn.lock\n@@ -3998,6 +3998,11 @@ cipher-base@^1.0.0, cipher-base@^1.0.1, cipher-base@^1.0.3:\n     inherits \"^2.0.1\"\n     safe-buffer \"^5.0.1\"\n \n+circular-dependency-plugin@^5.2.2:\n+  version \"5.2.2\"\n+  resolved \"https://registry.yarnpkg.com/circular-dependency-plugin/-/circular-dependency-plugin-5.2.2.tgz#39e836079db1d3cf2f988dc48c5188a44058b600\"\n+  integrity sha512-g38K9Cm5WRwlaH6g03B9OEz/0qRizI+2I7n+Gz+L5DxXJAPAiWQvwlYNm1V1jkdpUv95bOe/ASm2vfi/G560jQ==\n+\n cjs-module-lexer@^1.0.0:\n   version \"1.2.3\"\n   resolved \"https://registry.yarnpkg.com/cjs-module-lexer/-/cjs-module-lexer-1.2.3.tgz#6c370ab19f8a3394e318fe682686ec0ac684d107\"\n@@ -11281,6 +11286,7 @@ stringz@^2.1.0:\n     char-regex \"^1.0.2\"\n \n \"strip-ansi-cjs@npm:strip-ansi@^6.0.1\", strip-ansi@^6.0.0, strip-ansi@^6.0.1:\n+  name strip-ansi-cjs\n   version \"6.0.1\"\n   resolved \"https://registry.yarnpkg.com/strip-ansi/-/strip-ansi-6.0.1.tgz#9e26c63d30f53443e9489495b2105d37b67a85d9\"\n   integrity sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/components/status_action_bar.jsx\n@@ -375,20 +375,29 @@ class StatusActionBar extends ImmutablePureComponent {\n \n     return (\n       <div className='status__action-bar'>\n-        <IconButton className='status__action-bar__button' title={replyTitle} icon={isReply ? 'reply' : replyIcon} iconComponent={isReply ? ReplyIcon : replyIconComponent} onClick={this.handleReplyClick} counter={status.get('replies_count')} />\n-        <IconButton className={classNames('status__action-bar__button', { reblogPrivate })} disabled={!publicStatus && !reblogPrivate} active={status.get('reblogged')} title={reblogTitle} icon='retweet' iconComponent={reblogIconComponent} onClick={this.handleReblogClick} counter={withCounters ? status.get('reblogs_count') : undefined} />\n-        <IconButton className='status__action-bar__button star-icon' animate active={status.get('favourited')} title={intl.formatMessage(messages.favourite)} icon='star' iconComponent={status.get('favourited') ? StarIcon : StarBorderIcon} onClick={this.handleFavouriteClick} counter={withCounters ? status.get('favourites_count') : undefined} />\n-        <IconButton className='status__action-bar__button bookmark-icon' disabled={!signedIn} active={status.get('bookmarked')} title={intl.formatMessage(messages.bookmark)} icon='bookmark' iconComponent={status.get('bookmarked') ? BookmarkIcon : BookmarkBorderIcon} onClick={this.handleBookmarkClick} />\n-\n-        <DropdownMenuContainer\n-          scrollKey={scrollKey}\n-          status={status}\n-          items={menu}\n-          icon='ellipsis-h'\n-          iconComponent={MoreHorizIcon}\n-          direction='right'\n-          title={intl.formatMessage(messages.more)}\n-        />\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className='status__action-bar__button' title={replyTitle} icon={isReply ? 'reply' : replyIcon} iconComponent={isReply ? ReplyIcon : replyIconComponent} onClick={this.handleReplyClick} counter={status.get('replies_count')} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className={classNames('status__action-bar__button', { reblogPrivate })} disabled={!publicStatus && !reblogPrivate} active={status.get('reblogged')} title={reblogTitle} icon='retweet' iconComponent={reblogIconComponent} onClick={this.handleReblogClick} counter={withCounters ? status.get('reblogs_count') : undefined} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className='status__action-bar__button star-icon' animate active={status.get('favourited')} title={intl.formatMessage(messages.favourite)} icon='star' iconComponent={status.get('favourited') ? StarIcon : StarBorderIcon} onClick={this.handleFavouriteClick} counter={withCounters ? status.get('favourites_count') : undefined} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className='status__action-bar__button bookmark-icon' disabled={!signedIn} active={status.get('bookmarked')} title={intl.formatMessage(messages.bookmark)} icon='bookmark' iconComponent={status.get('bookmarked') ? BookmarkIcon : BookmarkBorderIcon} onClick={this.handleBookmarkClick} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <DropdownMenuContainer\n+            scrollKey={scrollKey}\n+            status={status}\n+            items={menu}\n+            icon='ellipsis-h'\n+            iconComponent={MoreHorizIcon}\n+            direction='right'\n+            title={intl.formatMessage(messages.more)}\n+          />\n+        </div>\n       </div>\n     );\n   }\n---\napp/javascript/styles/mastodon/components.scss\n@@ -299,6 +299,10 @@\n     }\n   }\n \n+  &--with-counter {\n+    padding-inline-end: 4px;\n+  }\n+\n   &__counter {\n     display: block;\n     width: auto;\n@@ -1465,6 +1469,15 @@ body > [data-popper-placement] {\n     }\n   }\n \n+  &__action-bar__button-wrapper {\n+    flex-basis: 0;\n+    flex-grow: 1;\n+\n+    &:last-child {\n+      flex-grow: 0;\n+    }\n+  }\n+\n   &--first-in-thread {\n     border-top: 1px solid var(--background-border-color);\n   }\n---\n\n\n---\n\nChoice D:\napp/models/admin/import.rb\n@@ -30,12 +30,14 @@ def csv_data\n \n     csv_converter = lambda do |field, field_info|\n       case field_info.header\n-      when '#domain', '#public_comment'\n+      when '#domain'\n+        field&.downcase&.strip\n+      when '#public_comment'\n         field&.strip\n       when '#severity'\n-        field&.strip&.to_sym\n+        field&.downcase&.strip&.to_sym\n       when '#reject_media', '#reject_reports', '#obfuscate'\n-        ActiveModel::Type::Boolean.new.cast(field)\n+        ActiveModel::Type::Boolean.new.cast(field&.downcase)\n       else\n         field\n       end\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Change instance settings and disable public preview of timelines\r\n2. Make an unauthenticated request to the `/api/v1/timelines/tag/:hashtag` endpoint\r\n\n\n### Expected behaviour\n\nHTTP 401 Unauthorized\n\n### Actual behaviour\n\nHTTP 200\n\n### Detailed description\n\nAccording to the documentation (see [here](https://docs.joinmastodon.org/methods/timelines/#tag)), this endpoint should require a token if the instance has the public preview of timelines disabled. However, it allows for unauthenticated requests.\n\n### Mastodon instance\n\n_No response_\n\n### Mastodon version\n\n_No response_\n\n### Technical details\n\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: ruby 3.2.2 (2023-03-30 revision e51014f9c0) [x86_64-linux]\r\n- Node.js version: v16.20.1\r\n\n\n---\n\nChoice A:\napp/controllers/api/v1/timelines/tag_controller.rb\n@@ -1,6 +1,7 @@\n # frozen_string_literal: true\n \n class Api::V1::Timelines::TagController < Api::BaseController\n+  before_action -> { doorkeeper_authorize! :read, :'read:statuses' }, only: :show, if: :require_auth?\n   before_action :load_tag\n   after_action :insert_pagination_headers, unless: -> { @statuses.empty? }\n \n@@ -12,6 +13,10 @@ def show\n \n   private\n \n+  def require_auth?\n+    !Setting.timeline_preview\n+  end\n+\n   def load_tag\n     @tag = Tag.find_normalized(params[:id])\n   end\n---\nspec/controllers/api/v1/timelines/tag_controller_spec.rb\n@@ -5,36 +5,66 @@\n describe Api::V1::Timelines::TagController do\n   render_views\n \n-  let(:user) { Fabricate(:user) }\n+  let(:user)   { Fabricate(:user) }\n+  let(:token)  { Fabricate(:accessible_access_token, resource_owner_id: user.id, scopes: 'read:statuses') }\n \n   before do\n     allow(controller).to receive(:doorkeeper_token) { token }\n   end\n \n-  context 'with a user context' do\n-    let(:token) { Fabricate(:accessible_access_token, resource_owner_id: user.id) }\n+  describe 'GET #show' do\n+    subject do\n+      get :show, params: { id: 'test' }\n+    end\n \n-    describe 'GET #show' do\n-      before do\n-        PostStatusService.new.call(user.account, text: 'It is a #test')\n+    before do\n+      PostStatusService.new.call(user.account, text: 'It is a #test')\n+    end\n+\n+    context 'when the instance allows public preview' do\n+      context 'when the user is not authenticated' do\n+        let(:token) { nil }\n+\n+        it 'returns http success', :aggregate_failures do\n+          subject\n+\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n \n-      it 'returns http success' do\n-        get :show, params: { id: 'test' }\n-        expect(response).to have_http_status(200)\n-        expect(response.headers['Link'].links.size).to eq(2)\n+      context 'when the user is authenticated' do\n+        it 'returns http success', :aggregate_failures do\n+          subject\n+\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n     end\n-  end\n \n-  context 'without a user context' do\n-    let(:token) { Fabricate(:accessible_access_token, resource_owner_id: nil) }\n+    context 'when the instance does not allow public preview' do\n+      before do\n+        Form::AdminSettings.new(timeline_preview: false).save\n+      end\n+\n+      context 'when the user is not authenticated' do\n+        let(:token) { nil }\n+\n+        it 'returns http unauthorized' do\n+          subject\n+\n+          expect(response).to have_http_status(401)\n+        end\n+      end\n+\n+      context 'when the user is authenticated' do\n+        it 'returns http success', :aggregate_failures do\n+          subject\n \n-    describe 'GET #show' do\n-      it 'returns http success' do\n-        get :show, params: { id: 'test' }\n-        expect(response).to have_http_status(200)\n-        expect(response.headers['Link']).to be_nil\n+          expect(response).to have_http_status(200)\n+          expect(response.headers['Link'].links.size).to eq(2)\n+        end\n       end\n     end\n   end\n---\n\n\n---\n\nChoice B:\napp/lib/attachment_batch.rb\n@@ -75,7 +75,12 @@ def remove_files\n             end\n           when :fog\n             logger.debug { \"Deleting #{attachment.path(style)}\" }\n-            attachment.send(:directory).files.new(key: attachment.path(style)).destroy\n+\n+            begin\n+              attachment.send(:directory).files.new(key: attachment.path(style)).destroy\n+            rescue Fog::Storage::OpenStack::NotFound\n+              # Ignore failure to delete a file that has already been deleted\n+            end\n           when :azure\n             logger.debug { \"Deleting #{attachment.path(style)}\" }\n             attachment.destroy\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/components/status.jsx\n@@ -546,7 +546,7 @@ class Status extends ImmutablePureComponent {\n     const visibilityIcon = visibilityIconInfo[status.get('visibility')];\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n-    const expanded = !status.get('hidden')\n+    const expanded = !status.get('hidden') || status.get('spoiler_text').length === 0;\n \n     return (\n       <HotKeys handlers={handlers}>\n---\napp/javascript/mastodon/features/status/components/detailed_status.jsx\n@@ -293,7 +293,7 @@ class DetailedStatus extends ImmutablePureComponent {\n     }\n \n     const {statusContentProps, hashtagBar} = getHashtagBarForStatus(status);\n-    const expanded = !status.get('hidden')\n+    const expanded = !status.get('hidden') || status.get('spoiler_text').length === 0;\n \n     return (\n       <div style={outerStyle}>\n---\n\n\n---\n\nChoice D:\ndb/migrate/20180812173710_copy_status_stats.rb\n@@ -45,7 +45,7 @@ def up_slow\n     # We cannot use bulk INSERT or overarching transactions here because of possible\n     # uniqueness violations that we need to skip over\n     Status.unscoped.select('id, reblogs_count, favourites_count, created_at, updated_at').find_each do |status|\n-      params = [[nil, status.id], [nil, status.reblogs_count], [nil, status.favourites_count], [nil, status.created_at], [nil, status.updated_at]]\n+      params = [status.id, status.reblogs_count, status.favourites_count, status.created_at, status.updated_at]\n       exec_insert('INSERT INTO status_stats (status_id, reblogs_count, favourites_count, created_at, updated_at) VALUES ($1, $2, $3, $4, $5)', nil, params)\n     rescue ActiveRecord::RecordNotUnique\n       next\n---\ndb/migrate/20181116173541_copy_account_stats.rb\n@@ -45,7 +45,7 @@ def up_slow\n     # We cannot use bulk INSERT or overarching transactions here because of possible\n     # uniqueness violations that we need to skip over\n     Account.unscoped.select('id, statuses_count, following_count, followers_count, created_at, updated_at').find_each do |account|\n-      params = [[nil, account.id], [nil, account[:statuses_count]], [nil, account[:following_count]], [nil, account[:followers_count]], [nil, account.created_at], [nil, account.updated_at]]\n+      params = [account.id, account[:statuses_count], account[:following_count], account[:followers_count], account.created_at, account.updated_at]\n       exec_insert('INSERT INTO account_stats (account_id, statuses_count, following_count, followers_count, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6)', nil, params)\n     rescue ActiveRecord::RecordNotUnique\n       next\n---\nlib/mastodon/cli/statuses.rb\n@@ -61,7 +61,7 @@ def remove_statuses\n         # Skip accounts followed by local accounts\n         clean_followed_sql = 'AND NOT EXISTS (SELECT 1 FROM follows WHERE statuses.account_id = follows.target_account_id)' unless options[:clean_followed]\n \n-        ActiveRecord::Base.connection.exec_insert(<<-SQL.squish, 'SQL', [[nil, max_id]])\n+        ActiveRecord::Base.connection.exec_insert(<<-SQL.squish, 'SQL', [max_id])\n           INSERT INTO statuses_to_be_deleted (id)\n           SELECT statuses.id FROM statuses WHERE deleted_at IS NULL AND NOT local AND uri IS NOT NULL AND (id < $1)\n           AND NOT EXISTS (SELECT 1 FROM statuses AS statuses1 WHERE statuses.id = statuses1.in_reply_to_id)\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\nWhen a nightly/`main` update containing https://github.com/mastodon/mastodon/pull/26153, timeline request result in 500 errors:\r\n\r\n```\r\nActiveModel::MissingAttributeError (missing attribute: published_at):\r\napp/controllers/api/v1/favourites_controller.rb:10:in `index'\r\napp/controllers/concerns/localized.rb:11:in `set_locale'\r\nlib/mastodon/rack_middleware.rb:9:in `call'\r\nlib/public_file_server_middleware.rb:18:in `call'\r\n\r\nActiveModel::MissingAttributeError (missing attribute: published_at):\r\napp/controllers/api/v1/notifications_controller.rb:17:in `index'\r\napp/controllers/concerns/localized.rb:11:in `set_locale'\r\nlib/mastodon/rack_middleware.rb:9:in `call'\r\n\r\nActiveModel::MissingAttributeError (missing attribute: published_at):\r\napp/controllers/api/v1/trends/statuses_controller.rb:12:in `index'\r\napp/controllers/concerns/localized.rb:11:in `set_locale'\r\nlib/mastodon/rack_middleware.rb:9:in `call'\r\n```\r\n\r\n### Expected behaviour\r\n\r\nThe update does not cause errors\r\n\r\n### Actual behaviour\r\n\r\nWe get 500 errors on timelines\r\n\r\n### Detailed description\r\n\r\nPurging the Rails cache fixes the issues, there are most probably items in cache without this new `published_at` attribute, and rendering those fail until the cache expires.\r\n\r\n### Mastodon instance\r\n\r\n_No response_\r\n\r\n### Mastodon version\r\n\r\n`nightly`\r\n\r\n### Technical details\r\n\r\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/features/ui/components/block_modal.jsx\n@@ -99,7 +99,7 @@ export const BlockModal = ({ accountId, acct }) => {\n             <FormattedMessage id='confirmation_modal.cancel' defaultMessage='Cancel' />\n           </button>\n \n-          <Button onClick={handleClick}>\n+          <Button onClick={handleClick} autoFocus>\n             <FormattedMessage id='confirmations.block.confirm' defaultMessage='Block' />\n           </Button>\n         </div>\n---\napp/javascript/mastodon/features/ui/components/confirmation_modals/confirmation_modal.tsx\n@@ -71,7 +71,10 @@ export const ConfirmationModal: React.FC<\n             />\n           </button>\n \n-          <Button onClick={handleClick}>{confirm}</Button>\n+          {/* eslint-disable-next-line jsx-a11y/no-autofocus -- we are in a modal and thus autofocusing is justified */}\n+          <Button onClick={handleClick} autoFocus>\n+            {confirm}\n+          </Button>\n         </div>\n       </div>\n     </div>\n---\napp/javascript/mastodon/features/ui/components/domain_block_modal.jsx\n@@ -88,7 +88,7 @@ export const DomainBlockModal = ({ domain, accountId, acct }) => {\n             <FormattedMessage id='confirmation_modal.cancel' defaultMessage='Cancel' />\n           </button>\n \n-          <Button onClick={handleClick}>\n+          <Button onClick={handleClick} autoFocus>\n             <FormattedMessage id='domain_block_modal.block' defaultMessage='Block server' />\n           </Button>\n         </div>\n---\napp/javascript/mastodon/features/ui/components/mute_modal.jsx\n@@ -137,7 +137,7 @@ export const MuteModal = ({ accountId, acct }) => {\n             <FormattedMessage id='confirmation_modal.cancel' defaultMessage='Cancel' />\n           </button>\n \n-          <Button onClick={handleClick}>\n+          <Button onClick={handleClick} autoFocus>\n             <FormattedMessage id='confirmations.mute.confirm' defaultMessage='Mute' />\n           </Button>\n         </div>\n---\napp/javascript/mastodon/features/ui/components/boost_modal.tsx\n@@ -128,6 +128,8 @@ export const BoostModal: React.FC<{\n                 ? messages.cancel_reblog\n                 : messages.reblog,\n             )}\n+            /* eslint-disable-next-line jsx-a11y/no-autofocus -- We are in the modal */\n+            autoFocus\n           />\n         </div>\n       </div>\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -7580,7 +7580,7 @@ a.status-card {\n   }\n }\n \n-.radio-button.checked::before {\n+.radio-button__input.checked::before {\n   position: absolute;\n   left: 2px;\n   top: 2px;\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/dashboard.scss\n@@ -86,9 +86,7 @@\n     color: $primary-text-color;\n     transition: all 100ms ease-in;\n     font-size: 14px;\n-    padding: 0 16px;\n-    line-height: 36px;\n-    height: 36px;\n+    padding: 8px 16px;\n     text-decoration: none;\n     margin-bottom: 4px;\n \n---\napp/javascript/styles/mastodon/dashboard.scss\n@@ -91,6 +91,7 @@\n     height: 36px;\n     text-decoration: none;\n     margin-bottom: 4px;\n+    white-space: nowrap;\n \n     &:active,\n     &:focus,\n@@ -111,6 +112,8 @@\n \n     span {\n       flex: 1 1 auto;\n+      overflow: hidden;\n+      text-overflow: ellipsis;\n     }\n \n     strong {\n---\n\n\n---\n\nChoice D:\napp/models/status.rb\n@@ -162,7 +162,7 @@ class Status < ApplicationRecord\n   REAL_TIME_WINDOW = 6.hours\n \n   def cache_key\n-    \"v2:#{super}\"\n+    \"v3:#{super}\"\n   end\n \n   def searchable_by(preloaded = nil)\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Get `flag` activity from activitypub\r\n\r\n### Expected behaviour\r\n\r\nExit silently if target_statuses is nil\r\n\r\n### Actual behaviour\r\n\r\nRaises an error\r\n\r\n### Detailed description\r\n\r\n![image](https://github.com/mastodon/mastodon/assets/5047683/3a8eef65-fef2-4df2-bbec-9044fa37267b)\r\n\r\n```\r\nNoMethodError\r\n\r\nundefined method `filter_map' for nil:NilClass (NoMethodError)\r\n\r\n      replied_to_accounts = Account.local.where(id: target_statuses.filter_map(&:in_reply_to_account_id))\r\n                                                                   ^^^^^^^^^^^\r\n\r\n    app/lib/activitypub/activity/flag.rb in block in perform at line 12\r\n    In App\r\n\r\n\r\n    target_accounts.each do |target_account|\r\n      target_statuses     = target_statuses_by_account[target_account.id]\r\n      replied_to_accounts = Account.local.where(id: target_statuses.filter_map(&:in_reply_to_account_id))\r\n[Open this line in GitHub](https://github.com/tribela/mastodon/blob/24e83246f9efaa57ff025a606795ab8bc21a42df/app/lib/activitypub/activity/flag.rb#L12)\r\n\r\n      next if target_account.suspended? || (!target_account.local? && replied_to_accounts.none?)\r\n\r\n\r\napp/lib/activitypub/activity/flag.rb in each at line 10\r\n\r\napp/lib/activitypub/activity/flag.rb in perform at line 10\r\n```\r\n\r\n### Mastodon instance\r\n\r\nqdon.space\r\n\r\n### Mastodon version\r\n\r\nv4.1.4+glitch 52500965cc\r\n\r\n### Technical details\r\n\r\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: v3.2.2\r\n- Node.js version: 16.20\r\n\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -9284,14 +9284,17 @@ noscript {\n     0 10px 15px -3px rgba($base-shadow-color, 0.25),\n     0 4px 6px -4px rgba($base-shadow-color, 0.25);\n   cursor: default;\n-  transition: 0.5s cubic-bezier(0.89, 0.01, 0.5, 1.1);\n-  transform: translateZ(0);\n   font-size: 15px;\n   line-height: 21px;\n \n   &.notification-bar-active {\n     inset-inline-start: 1rem;\n   }\n+\n+  .no-reduce-motion & {\n+    transition: 0.5s cubic-bezier(0.89, 0.01, 0.5, 1.1);\n+    transform: translateZ(0);\n+  }\n }\n \n .notification-bar-title {\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon-light/diff.scss\n@@ -159,8 +159,8 @@\n .error-modal,\n .onboarding-modal,\n .compare-history-modal,\n-.report-modal__comment .setting-text__wrapper,\n-.report-modal__comment .setting-text,\n+.report-modal__comment,\n+.report-modal__comment,\n .announcements,\n .picture-in-picture__header,\n .picture-in-picture__footer,\n@@ -169,6 +169,11 @@\n   border: 1px solid var(--background-border-color);\n }\n \n+.setting-text__wrapper,\n+.setting-text {\n+  border: 1px solid var(--background-border-color);\n+}\n+\n .reactions-bar__item:hover,\n .reactions-bar__item:focus,\n .reactions-bar__item:active {\n@@ -198,14 +203,6 @@\n   color: $white;\n }\n \n-.report-modal__comment {\n-  border-right-color: lighten($ui-base-color, 8%);\n-}\n-\n-.report-modal__container {\n-  border-top-color: lighten($ui-base-color, 8%);\n-}\n-\n .column-settings__hashtags .column-select__option {\n   color: $white;\n }\n---\napp/javascript/styles/mastodon/components.scss\n@@ -3911,7 +3911,7 @@ $ui-header-logo-wordmark-width: 99px;\n \n   &__wrapper {\n     background: $white;\n-    border: 1px solid $ui-secondary-color;\n+    border: 1px solid var(--background-border-color);\n     margin-bottom: 10px;\n     border-radius: 4px;\n \n@@ -6298,9 +6298,10 @@ a.status-card {\n .report-modal,\n .actions-modal,\n .compare-history-modal {\n-  background: lighten($ui-secondary-color, 8%);\n-  color: $inverted-text-color;\n-  border-radius: 8px;\n+  background: var(--background-color);\n+  color: $primary-text-color;\n+  border-radius: 4px;\n+  border: 1px solid var(--background-border-color);\n   overflow: hidden;\n   max-width: 90vw;\n   width: 480px;\n@@ -6344,6 +6345,7 @@ a.status-card {\n .report-modal {\n   width: 90vw;\n   max-width: 700px;\n+  border: 1px solid var(--background-border-color);\n }\n \n .report-dialog-modal {\n@@ -6567,7 +6569,7 @@ a.status-card {\n \n .report-modal__container {\n   display: flex;\n-  border-top: 1px solid $ui-secondary-color;\n+  border-top: 1px solid var(--background-border-color);\n \n   @media screen and (width <= 480px) {\n     flex-wrap: wrap;\n@@ -6625,7 +6627,7 @@ a.status-card {\n \n .report-modal__comment {\n   padding: 20px;\n-  border-inline-end: 1px solid $ui-secondary-color;\n+  border-inline-end: 1px solid var(--background-border-color);\n   max-width: 320px;\n \n   p {\n@@ -6636,7 +6638,7 @@ a.status-card {\n \n   .setting-text-label {\n     display: block;\n-    color: $inverted-text-color;\n+    color: $secondary-text-color;\n     font-size: 14px;\n     font-weight: 500;\n     margin-bottom: 10px;\n---\n\n\n---\n\nChoice C:\napp/lib/activitypub/activity/flag.rb\n@@ -9,7 +9,7 @@ def perform\n \n     target_accounts.each do |target_account|\n       target_statuses     = target_statuses_by_account[target_account.id]\n-      replied_to_accounts = Account.local.where(id: target_statuses.filter_map(&:in_reply_to_account_id))\n+      replied_to_accounts = target_statuses.nil? ? [] : Account.local.where(id: target_statuses.filter_map(&:in_reply_to_account_id))\n \n       next if target_account.suspended? || (!target_account.local? && replied_to_accounts.none?)\n \n---\nspec/lib/activitypub/activity/flag_spec.rb\n@@ -139,6 +139,35 @@\n         expect(report.status_ids).to eq []\n       end\n     end\n+\n+    context 'when an account is passed but no status' do\n+      let(:mentioned) { Fabricate(:account) }\n+\n+      let(:json) do\n+        {\n+          '@context': 'https://www.w3.org/ns/activitystreams',\n+          id: flag_id,\n+          type: 'Flag',\n+          content: 'Boo!!',\n+          actor: ActivityPub::TagManager.instance.uri_for(sender),\n+          object: [\n+            ActivityPub::TagManager.instance.uri_for(flagged),\n+          ],\n+        }.with_indifferent_access\n+      end\n+\n+      before do\n+        subject.perform\n+      end\n+\n+      it 'creates a report with no attached status' do\n+        report = Report.find_by(account: sender, target_account: flagged)\n+\n+        expect(report).to_not be_nil\n+        expect(report.comment).to eq 'Boo!!'\n+        expect(report.status_ids).to eq []\n+      end\n+    end\n   end\n \n   describe '#perform with a defined uri' do\n---\n\n\n---\n\nChoice D:\napp/models/media_attachment.rb\n@@ -172,7 +172,7 @@ class MediaAttachment < ApplicationRecord\n   DEFAULT_STYLES = [:original].freeze\n \n   GLOBAL_CONVERT_OPTIONS = {\n-    all: '-quality 90 +profile \"!icc,*\" +set modify-date +set create-date',\n+    all: '-quality 90 +profile \"!icc,*\" +set modify-date -define jpeg:dct-method=float +set create-date',\n   }.freeze\n \n   belongs_to :account,          inverse_of: :media_attachments, optional: true\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\n1. Run `tootctl statuses remove --days=5`\r\n2. Observe immediate failure\r\n\r\n\r\n### Expected behaviour\r\n\r\nOld statuses removed\r\n\r\n### Actual behaviour\r\n\r\nImmediate crash\r\n\r\n### Detailed description\r\n\r\nCommand executed and output:\r\n```\r\n~$ RAILS_ENV=production nice /home/mastodon/live/bin/tootctl statuses remove --days=5\r\nCreating temporary database indices...\r\nExtract the deletion target from statuses... This might take a while...\r\nRemoving temporary database indices to restore write performance...\r\n/home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.0.6/lib/active_record/connection_adapters/abstract/quoting.rb:43:in `type_cast': can't cast Array (TypeError)\r\n\r\n        else raise TypeError, \"can't cast #{value.class.name}\"\r\n                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.0.6/lib/active_record/connection_adapters/postgresql/quoting.rb:142:in `type_cast'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.0.6/lib/active_record/connection_adapters/abstract/quoting.rb:220:in `block in type_casted_binds'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.0.6/lib/active_record/connection_adapters/abstract/quoting.rb:216:in `map'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.0.6/lib/active_record/connection_adapters/abstract/quoting.rb:216:in `type_casted_binds'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.0.6/lib/active_record/connection_adapters/postgresql_adapter.rb:765:in `exec_no_cache'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.0.6/lib/active_record/connection_adapters/postgresql_adapter.rb:745:in `execute_and_clear'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.0.6/lib/active_record/connection_adapters/postgresql/database_statements.rb:54:in `exec_query'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.0.6/lib/active_record/connection_adapters/abstract/database_statements.rb:132:in `exec_insert'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/activerecord-7.0.6/lib/active_record/connection_adapters/postgresql/database_statements.rb:88:in `exec_insert'\r\n\tfrom /home/mastodon/live/lib/mastodon/cli/statuses.rb:64:in `remove_statuses'\r\n\tfrom /home/mastodon/live/lib/mastodon/cli/statuses.rb:34:in `remove'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor/command.rb:27:in `run'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor/invocation.rb:127:in `invoke_command'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor.rb:392:in `dispatch'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor/invocation.rb:116:in `invoke'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor.rb:243:in `block in subcommand'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor/command.rb:27:in `run'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor/invocation.rb:127:in `invoke_command'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor.rb:392:in `dispatch'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/thor-1.2.2/lib/thor/base.rb:485:in `start'\r\n\tfrom /home/mastodon/live/bin/tootctl:9:in `block in <main>'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.3.3/lib/chewy/strategy.rb:60:in `wrap'\r\n\tfrom /home/mastodon/live/vendor/bundle/ruby/3.2.0/gems/chewy-7.3.3/lib/chewy.rb:154:in `strategy'\r\n\tfrom /home/mastodon/live/bin/tootctl:8:in `<main>'\r\n```\r\n\r\n### Mastodon instance\r\n\r\nmastodon.sharpletters.net\r\n\r\n### Mastodon version\r\n\r\nv4.1.5+nightly-2023-07-25\r\nv4.1.5+nightly-2023-07-26\r\n\r\n### Technical details\r\n\r\nIf this is happening on your own Mastodon server, please fill out those:\r\n- Ruby version: ruby 3.2.2 (2023-03-30 revision e51014f9c0) [aarch64-linux]\r\n- Node.js version: v16.20.1\r\n\n\n---\n\nChoice A:\nconfig/application.rb\n@@ -64,13 +64,6 @@ class Application < Rails::Application\n     # Initialize configuration defaults for originally generated Rails version.\n     config.load_defaults 7.0\n \n-    # TODO: Release a version which uses the 7.0 defaults as specified above,\n-    # but preserves the 6.1 cache format as set below. In a subsequent change,\n-    # remove this line setting to 6.1 cache format, and then release another version.\n-    # https://guides.rubyonrails.org/upgrading_ruby_on_rails.html#new-activesupport-cache-serialization-format\n-    # https://github.com/mastodon/mastodon/pull/24241#discussion_r1162890242\n-    config.active_support.cache_format_version = 6.1\n-\n     # Please, add to the `ignore` list any other `lib` subdirectories that do\n     # not contain `.rb` files, or that should not be reloaded or eager loaded.\n     # Common ones are `templates`, `generators`, or `middleware`, for example.\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -63,8 +63,8 @@ export default class ColumnsArea extends ImmutablePureComponent {\n     children: PropTypes.node,\n   };\n \n-  // Corresponds to (max-width: $no-gap-breakpoint + 285px - 1px) in SCSS\n-  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1174px)');\n+  // Corresponds to (max-width: $no-gap-breakpoint - 1px) in SCSS\n+  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1206px)');\n \n   state = {\n     renderComposePanel: !(this.mediaQuery && this.mediaQuery.matches),\n---\napp/javascript/styles/mastodon/variables.scss\n@@ -87,7 +87,7 @@ $media-modal-media-max-width: 100%;\n // put margins on top and bottom of image to avoid the screen covered by image.\n $media-modal-media-max-height: 80%;\n \n-$no-gap-breakpoint: 1175px;\n+$no-gap-breakpoint: 1207px;\n $mobile-breakpoint: 630px;\n \n $font-sans-serif: 'mastodon-font-sans-serif' !default;\n---\napp/javascript/mastodon/features/ui/components/columns_area.jsx\n@@ -62,7 +62,7 @@ export default class ColumnsArea extends ImmutablePureComponent {\n   };\n \n   // Corresponds to (max-width: $no-gap-breakpoint - 1px) in SCSS\n-  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1206px)');\n+  mediaQuery = 'matchMedia' in window && window.matchMedia('(max-width: 1174px)');\n \n   state = {\n     renderComposePanel: !(this.mediaQuery && this.mediaQuery.matches),\n---\napp/javascript/styles/mastodon/components.scss\n@@ -2708,7 +2708,7 @@ a.account__display-name {\n     &__main {\n       box-sizing: border-box;\n       width: 100%;\n-      flex: 0 0 auto;\n+      flex: 0 1 auto;\n       display: flex;\n       flex-direction: column;\n \n---\napp/javascript/styles/mastodon/variables.scss\n@@ -87,7 +87,7 @@ $media-modal-media-max-width: 100%;\n // put margins on top and bottom of image to avoid the screen covered by image.\n $media-modal-media-max-height: 80%;\n \n-$no-gap-breakpoint: 1207px;\n+$no-gap-breakpoint: 1175px;\n $mobile-breakpoint: 630px;\n \n $font-sans-serif: 'mastodon-font-sans-serif' !default;\n---\n\n\n---\n\nChoice C:\ndb/migrate/20180812173710_copy_status_stats.rb\n@@ -45,7 +45,7 @@ def up_slow\n     # We cannot use bulk INSERT or overarching transactions here because of possible\n     # uniqueness violations that we need to skip over\n     Status.unscoped.select('id, reblogs_count, favourites_count, created_at, updated_at').find_each do |status|\n-      params = [[nil, status.id], [nil, status.reblogs_count], [nil, status.favourites_count], [nil, status.created_at], [nil, status.updated_at]]\n+      params = [status.id, status.reblogs_count, status.favourites_count, status.created_at, status.updated_at]\n       exec_insert('INSERT INTO status_stats (status_id, reblogs_count, favourites_count, created_at, updated_at) VALUES ($1, $2, $3, $4, $5)', nil, params)\n     rescue ActiveRecord::RecordNotUnique\n       next\n---\ndb/migrate/20181116173541_copy_account_stats.rb\n@@ -45,7 +45,7 @@ def up_slow\n     # We cannot use bulk INSERT or overarching transactions here because of possible\n     # uniqueness violations that we need to skip over\n     Account.unscoped.select('id, statuses_count, following_count, followers_count, created_at, updated_at').find_each do |account|\n-      params = [[nil, account.id], [nil, account[:statuses_count]], [nil, account[:following_count]], [nil, account[:followers_count]], [nil, account.created_at], [nil, account.updated_at]]\n+      params = [account.id, account[:statuses_count], account[:following_count], account[:followers_count], account.created_at, account.updated_at]\n       exec_insert('INSERT INTO account_stats (account_id, statuses_count, following_count, followers_count, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6)', nil, params)\n     rescue ActiveRecord::RecordNotUnique\n       next\n---\nlib/mastodon/cli/statuses.rb\n@@ -61,7 +61,7 @@ def remove_statuses\n         # Skip accounts followed by local accounts\n         clean_followed_sql = 'AND NOT EXISTS (SELECT 1 FROM follows WHERE statuses.account_id = follows.target_account_id)' unless options[:clean_followed]\n \n-        ActiveRecord::Base.connection.exec_insert(<<-SQL.squish, 'SQL', [[nil, max_id]])\n+        ActiveRecord::Base.connection.exec_insert(<<-SQL.squish, 'SQL', [max_id])\n           INSERT INTO statuses_to_be_deleted (id)\n           SELECT statuses.id FROM statuses WHERE deleted_at IS NULL AND NOT local AND uri IS NOT NULL AND (id < $1)\n           AND NOT EXISTS (SELECT 1 FROM statuses AS statuses1 WHERE statuses.id = statuses1.in_reply_to_id)\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/components/__tests__/hashtag_bar.tsx\n@@ -45,6 +45,21 @@ describe('computeHashtagBarForStatus', () => {\n     );\n   });\n \n+  it('does not truncate the contents when the last child is a text node', () => {\n+    const status = createStatus(\n+      'this is a #<a class=\"zrl\" href=\"https://example.com/search?tag=test\">test</a>. Some more text',\n+      ['test'],\n+    );\n+\n+    const { hashtagsInBar, statusContentProps } =\n+      computeHashtagBarForStatus(status);\n+\n+    expect(hashtagsInBar).toEqual([]);\n+    expect(statusContentProps.statusContent).toMatchInlineSnapshot(\n+      `\"this is a #<a class=\"zrl\" href=\"https://example.com/search?tag=test\">test</a>. Some more text\"`,\n+    );\n+  });\n+\n   it('extract tags from the last line', () => {\n     const status = createStatus(\n       '<p>Simple text</p><p><a href=\"test\">#hashtag</a></p>',\n---\napp/javascript/mastodon/components/hashtag_bar.tsx\n@@ -109,7 +109,7 @@ export function computeHashtagBarForStatus(status: StatusLike): {\n \n   const lastChild = template.content.lastChild;\n \n-  if (!lastChild) return defaultResult;\n+  if (!lastChild || lastChild.nodeType === Node.TEXT_NODE) return defaultResult;\n \n   template.content.removeChild(lastChild);\n   const contentWithoutLastLine = template;\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Select an option on a poll in the advanced web interface with nightly\r\n2.\r\n3.\r\n...\r\n\n\n### Expected behaviour\n\nUnambiguous selection visible between non-selected options\n\n### Actual behaviour\n\nThe selected option is barely distinguishable from the non-selected option.\n\n### Detailed description\n\nThe advanced web UI currently on mastodon.social has a UI styling for polls' radio buttons that is:\r\n\r\n- different from the single column standard view\r\n- barely distinguishable from the non-selected options\r\n\r\nThis leads to a bad UI and subsequently UX. You want to have the selected option.\r\n\r\nMastodon nightly (both standard and advanced view):\r\n![image](https://github.com/mastodon/mastodon/assets/610865/c369d738-d852-44c3-89df-1ce4f8b2660c)\r\n![image](https://github.com/mastodon/mastodon/assets/610865/75c7343f-dac4-4de7-a0ea-53124a4996d4)\r\n\r\n4.1.5's UI:\r\n![image](https://github.com/mastodon/mastodon/assets/610865/35a716b8-c5ee-4e62-9bae-0e2e72e19f77)\r\n![image](https://github.com/mastodon/mastodon/assets/610865/79c26679-d551-4188-b874-2a74048c11e5)\r\n\n\n### Mastodon instance\n\nmastodon.social\n\n### Mastodon version\n\nv4.1.5+nightly-2023-07-25\n\n### Browser name and version\n\nFirefox 105.0.3\n\n### Operating system\n\nWindows 10\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/controllers/api/v1/admin/domain_blocks_controller.rb\n@@ -29,10 +29,11 @@ def show\n   def create\n     authorize :domain_block, :create?\n \n+    @domain_block = DomainBlock.new(resource_params)\n     existing_domain_block = resource_params[:domain].present? ? DomainBlock.rule_for(resource_params[:domain]) : nil\n-    return render json: existing_domain_block, serializer: REST::Admin::ExistingDomainBlockErrorSerializer, status: 422 if existing_domain_block.present?\n+    return render json: existing_domain_block, serializer: REST::Admin::ExistingDomainBlockErrorSerializer, status: 422 if conflicts_with_existing_block?(@domain_block, existing_domain_block)\n \n-    @domain_block = DomainBlock.create!(resource_params)\n+    @domain_block.save!\n     DomainBlockWorker.perform_async(@domain_block.id)\n     log_action :create, @domain_block\n     render json: @domain_block, serializer: REST::Admin::DomainBlockSerializer\n@@ -55,6 +56,10 @@ def destroy\n \n   private\n \n+  def conflicts_with_existing_block?(domain_block, existing_domain_block)\n+    existing_domain_block.present? && (existing_domain_block.domain == TagManager.instance.normalize_domain(domain_block.domain) || !domain_block.stricter_than?(existing_domain_block))\n+  end\n+\n   def set_domain_blocks\n     @domain_blocks = filtered_domain_blocks.order(id: :desc).to_a_paginated_by_id(limit_param(LIMIT), params_slice(:max_id, :since_id, :min_id))\n   end\n---\nspec/requests/api/v1/admin/domain_blocks_spec.rb\n@@ -130,7 +130,7 @@\n     it_behaves_like 'forbidden for wrong role', ''\n     it_behaves_like 'forbidden for wrong role', 'Moderator'\n \n-    it 'returns expected domain name and severity', :aggregate_failures do\n+    it 'creates a domain block with the expected domain name and severity', :aggregate_failures do\n       subject\n \n       body = body_as_json\n@@ -146,7 +146,44 @@\n       expect(DomainBlock.find_by(domain: 'foo.bar.com')).to be_present\n     end\n \n-    context 'when a stricter domain block already exists' do\n+    context 'when a looser domain block already exists on a higher level domain' do\n+      let(:params) { { domain: 'foo.bar.com', severity: :suspend } }\n+\n+      before do\n+        Fabricate(:domain_block, domain: 'bar.com', severity: :silence)\n+      end\n+\n+      it 'creates a domain block with the expected domain name and severity', :aggregate_failures do\n+        subject\n+\n+        body = body_as_json\n+\n+        expect(response).to have_http_status(200)\n+        expect(body).to match a_hash_including(\n+          {\n+            domain: 'foo.bar.com',\n+            severity: 'suspend',\n+          }\n+        )\n+\n+        expect(DomainBlock.find_by(domain: 'foo.bar.com')).to be_present\n+      end\n+    end\n+\n+    context 'when a domain block already exists on the same domain' do\n+      before do\n+        Fabricate(:domain_block, domain: 'foo.bar.com', severity: :silence)\n+      end\n+\n+      it 'returns existing domain block in error', :aggregate_failures do\n+        subject\n+\n+        expect(response).to have_http_status(422)\n+        expect(body_as_json[:existing_domain_block][:domain]).to eq('foo.bar.com')\n+      end\n+    end\n+\n+    context 'when a stricter domain block already exists on a higher level domain' do\n       before do\n         Fabricate(:domain_block, domain: 'bar.com', severity: :suspend)\n       end\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/polls.scss\n@@ -128,6 +128,11 @@\n       border-width: 4px;\n     }\n \n+    &.active {\n+      background-color: $ui-button-focus-background-color;\n+      border-color: $ui-button-focus-background-color;\n+    }\n+\n     &::-moz-focus-inner {\n       outline: 0 !important;\n       border: 0;\n---\n\n\n---\n\nChoice C:\nconfig/initializers/cors.rb\n@@ -22,6 +22,7 @@\n                expose: %w(Link X-RateLimit-Reset X-RateLimit-Limit X-RateLimit-Remaining X-Request-Id),\n                methods: %i(post put delete get patch options)\n       resource '/oauth/token', methods: [:post]\n+      resource '/oauth/revoke', methods: [:post]\n     end\n   end\n end\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -1996,6 +1996,7 @@ body > [data-popper-placement] {\n \n         &__handle {\n           user-select: all;\n+          overflow-wrap: anywhere;\n         }\n       }\n \n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. [This toot](https://social.coop/@smallcircles/110755972839994395) is now boosted 206 times\r\n2. Whenever clicking on boost icon below the toot to `/reblogs` only last 40 items are shown.\r\n3. And there's no UI chrome to show more than the 40-item page.\r\n...\r\n\n\n### Expected behaviour\n\nEither the full list of 'boosters' is shown, or UI to navigate between pages.\n\n### Actual behaviour\n\nOnly the most recent 40 accounts are shown that boosted the toot\n\n### Detailed description\n\nJust extra FYI. Helge in [fediverse devs](https://matrix.to/#/!uHqAjmOtrLtidOiczC:matrix.org/$i4Us6bxM1ucWrWJpNBvxMpWx50CIqWbvUv20_xxhm-s?via=matrix.org&via=mozilla.org&via=matrix.bottomservices.club) chat made aware that the API call is paged:\r\n\r\n> https://social.coop/api/v1/statuses/110755972839994395/reblogged_by\r\n> Then if you look at the headers you see\r\n> Link: https://social.coop/api/v1/statuses/110755972839994395/reblogged_by?max_id=110757548633191096; rel=\"next\", https://social.coop/api/v1/statuses/110755972839994395/reblogged_by?since_id=110758036549519882; rel=\"prev\"\r\n> I think you need to select next to get the next 40 entries.\r\n> Then if you do it 4 times, you get everybody who reblogged.\n\n### Mastodon instance\n\nsocial.coop\n\n### Mastodon version\n\nv4.1.4\n\n### Browser name and version\n\nFirefox 115.0\n\n### Operating system\n\nUbuntu 23.04\n\n### Technical details\n\n_No response_\n\n---\n\nChoice A:\napp/javascript/mastodon/actions/interactions.js\n@@ -7,6 +7,10 @@ export const REBLOG_REQUEST = 'REBLOG_REQUEST';\n export const REBLOG_SUCCESS = 'REBLOG_SUCCESS';\n export const REBLOG_FAIL    = 'REBLOG_FAIL';\n \n+export const REBLOGS_EXPAND_REQUEST = 'REBLOGS_EXPAND_REQUEST';\n+export const REBLOGS_EXPAND_SUCCESS = 'REBLOGS_EXPAND_SUCCESS';\n+export const REBLOGS_EXPAND_FAIL = 'REBLOGS_EXPAND_FAIL';\n+\n export const FAVOURITE_REQUEST = 'FAVOURITE_REQUEST';\n export const FAVOURITE_SUCCESS = 'FAVOURITE_SUCCESS';\n export const FAVOURITE_FAIL    = 'FAVOURITE_FAIL';\n@@ -278,8 +282,10 @@ export function fetchReblogs(id) {\n     dispatch(fetchReblogsRequest(id));\n \n     api(getState).get(`/api/v1/statuses/${id}/reblogged_by`).then(response => {\n+      const next = getLinks(response).refs.find(link => link.rel === 'next');\n       dispatch(importFetchedAccounts(response.data));\n-      dispatch(fetchReblogsSuccess(id, response.data));\n+      dispatch(fetchReblogsSuccess(id, response.data, next ? next.uri : null));\n+      dispatch(fetchRelationships(response.data.map(item => item.id)));\n     }).catch(error => {\n       dispatch(fetchReblogsFail(id, error));\n     });\n@@ -293,17 +299,62 @@ export function fetchReblogsRequest(id) {\n   };\n }\n \n-export function fetchReblogsSuccess(id, accounts) {\n+export function fetchReblogsSuccess(id, accounts, next) {\n   return {\n     type: REBLOGS_FETCH_SUCCESS,\n     id,\n     accounts,\n+    next,\n   };\n }\n \n export function fetchReblogsFail(id, error) {\n   return {\n     type: REBLOGS_FETCH_FAIL,\n+    id,\n+    error,\n+  };\n+}\n+\n+export function expandReblogs(id) {\n+  return (dispatch, getState) => {\n+    const url = getState().getIn(['user_lists', 'reblogged_by', id, 'next']);\n+    if (url === null) {\n+      return;\n+    }\n+\n+    dispatch(expandReblogsRequest(id));\n+\n+    api(getState).get(url).then(response => {\n+      const next = getLinks(response).refs.find(link => link.rel === 'next');\n+\n+      dispatch(importFetchedAccounts(response.data));\n+      dispatch(expandReblogsSuccess(id, response.data, next ? next.uri : null));\n+      dispatch(fetchRelationships(response.data.map(item => item.id)));\n+    }).catch(error => dispatch(expandReblogsFail(id, error)));\n+  };\n+}\n+\n+export function expandReblogsRequest(id) {\n+  return {\n+    type: REBLOGS_EXPAND_REQUEST,\n+    id,\n+  };\n+}\n+\n+export function expandReblogsSuccess(id, accounts, next) {\n+  return {\n+    type: REBLOGS_EXPAND_SUCCESS,\n+    id,\n+    accounts,\n+    next,\n+  };\n+}\n+\n+export function expandReblogsFail(id, error) {\n+  return {\n+    type: REBLOGS_EXPAND_FAIL,\n+    id,\n     error,\n   };\n }\n---\napp/javascript/mastodon/features/reblogs/index.jsx\n@@ -8,9 +8,11 @@ import ImmutablePropTypes from 'react-immutable-proptypes';\n import ImmutablePureComponent from 'react-immutable-pure-component';\n import { connect } from 'react-redux';\n \n+import { debounce } from 'lodash';\n+\n import { Icon }  from 'mastodon/components/icon';\n \n-import { fetchReblogs } from '../../actions/interactions';\n+import { fetchReblogs, expandReblogs } from '../../actions/interactions';\n import ColumnHeader from '../../components/column_header';\n import { LoadingIndicator } from '../../components/loading_indicator';\n import ScrollableList from '../../components/scrollable_list';\n@@ -22,7 +24,9 @@ const messages = defineMessages({\n });\n \n const mapStateToProps = (state, props) => ({\n-  accountIds: state.getIn(['user_lists', 'reblogged_by', props.params.statusId]),\n+  accountIds: state.getIn(['user_lists', 'reblogged_by', props.params.statusId, 'items']),\n+  hasMore: !!state.getIn(['user_lists', 'reblogged_by', props.params.statusId, 'next']),\n+  isLoading: state.getIn(['user_lists', 'reblogged_by', props.params.statusId, 'isLoading'], true),\n });\n \n class Reblogs extends ImmutablePureComponent {\n@@ -31,6 +35,8 @@ class Reblogs extends ImmutablePureComponent {\n     params: PropTypes.object.isRequired,\n     dispatch: PropTypes.func.isRequired,\n     accountIds: ImmutablePropTypes.list,\n+    hasMore: PropTypes.bool,\n+    isLoading: PropTypes.bool,\n     multiColumn: PropTypes.bool,\n     intl: PropTypes.object.isRequired,\n   };\n@@ -39,20 +45,18 @@ class Reblogs extends ImmutablePureComponent {\n     if (!this.props.accountIds) {\n       this.props.dispatch(fetchReblogs(this.props.params.statusId));\n     }\n-  }\n-\n-  UNSAFE_componentWillReceiveProps(nextProps) {\n-    if (nextProps.params.statusId !== this.props.params.statusId && nextProps.params.statusId) {\n-      this.props.dispatch(fetchReblogs(nextProps.params.statusId));\n-    }\n-  }\n+  };\n \n   handleRefresh = () => {\n     this.props.dispatch(fetchReblogs(this.props.params.statusId));\n   };\n \n+  handleLoadMore = debounce(() => {\n+    this.props.dispatch(expandReblogs(this.props.params.statusId));\n+  }, 300, { leading: true });\n+\n   render () {\n-    const { intl, accountIds, multiColumn } = this.props;\n+    const { intl, accountIds, hasMore, isLoading, multiColumn } = this.props;\n \n     if (!accountIds) {\n       return (\n@@ -76,6 +80,9 @@ class Reblogs extends ImmutablePureComponent {\n \n         <ScrollableList\n           scrollKey='reblogs'\n+          onLoadMore={this.handleLoadMore}\n+          hasMore={hasMore}\n+          isLoading={isLoading}\n           emptyMessage={emptyMessage}\n           bindToDocument={!multiColumn}\n         >\n---\napp/javascript/mastodon/reducers/user_lists.js\n@@ -45,7 +45,12 @@ import {\n   BLOCKS_EXPAND_FAIL,\n } from '../actions/blocks';\n import {\n+  REBLOGS_FETCH_REQUEST,\n   REBLOGS_FETCH_SUCCESS,\n+  REBLOGS_FETCH_FAIL,\n+  REBLOGS_EXPAND_REQUEST,\n+  REBLOGS_EXPAND_SUCCESS,\n+  REBLOGS_EXPAND_FAIL,\n   FAVOURITES_FETCH_REQUEST,\n   FAVOURITES_FETCH_SUCCESS,\n   FAVOURITES_FETCH_FAIL,\n@@ -139,7 +144,15 @@ export default function userLists(state = initialState, action) {\n   case FOLLOWING_EXPAND_FAIL:\n     return state.setIn(['following', action.id, 'isLoading'], false);\n   case REBLOGS_FETCH_SUCCESS:\n-    return state.setIn(['reblogged_by', action.id], ImmutableList(action.accounts.map(item => item.id)));\n+    return normalizeList(state, ['reblogged_by', action.id], action.accounts, action.next);\n+  case REBLOGS_EXPAND_SUCCESS:\n+    return appendToList(state, ['reblogged_by', action.id], action.accounts, action.next);\n+  case REBLOGS_FETCH_REQUEST:\n+  case REBLOGS_EXPAND_REQUEST:\n+    return state.setIn(['reblogged_by', action.id, 'isLoading'], true);\n+  case REBLOGS_FETCH_FAIL:\n+  case REBLOGS_EXPAND_FAIL:\n+    return state.setIn(['reblogged_by', action.id, 'isLoading'], false);\n   case FAVOURITES_FETCH_SUCCESS:\n     return normalizeList(state, ['favourited_by', action.id], action.accounts, action.next);\n   case FAVOURITES_EXPAND_SUCCESS:\n---\n\n\n---\n\nChoice B:\napp/models/tag.rb\n@@ -35,7 +35,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?:^|[^/)\\w])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)[:word]])#(#{HASHTAG_NAME_PAT})}i\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/tag_spec.rb\n@@ -32,52 +32,56 @@\n       expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)#Lawsuit')).to be_nil\n     end\n \n+    it 'does not match URLs with hashtag-like anchors after an empty query parameter' do\n+      expect(subject.match('https://en.wikipedia.org/wiki/Ghostbusters_(song)?foo=#Lawsuit')).to be_nil\n+    end\n+\n     it 'matches \ufeff#\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43' do\n-      expect(subject.match('\ufeffthis is #\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43').to_s).to eq ' #\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43'\n+      expect(subject.match('\ufeffthis is #\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43').to_s).to eq '#\uff41\uff45\uff53\uff54\uff48\uff45\uff54\uff49\uff43'\n     end\n \n     it 'matches digits at the start' do\n-      expect(subject.match('hello #3d').to_s).to eq ' #3d'\n+      expect(subject.match('hello #3d').to_s).to eq '#3d'\n     end\n \n     it 'matches digits in the middle' do\n-      expect(subject.match('hello #l33ts35k').to_s).to eq ' #l33ts35k'\n+      expect(subject.match('hello #l33ts35k').to_s).to eq '#l33ts35k'\n     end\n \n     it 'matches digits at the end' do\n-      expect(subject.match('hello #world2016').to_s).to eq ' #world2016'\n+      expect(subject.match('hello #world2016').to_s).to eq '#world2016'\n     end\n \n     it 'matches underscores at the beginning' do\n-      expect(subject.match('hello #_test').to_s).to eq ' #_test'\n+      expect(subject.match('hello #_test').to_s).to eq '#_test'\n     end\n \n     it 'matches underscores at the end' do\n-      expect(subject.match('hello #test_').to_s).to eq ' #test_'\n+      expect(subject.match('hello #test_').to_s).to eq '#test_'\n     end\n \n     it 'matches underscores in the middle' do\n-      expect(subject.match('hello #one_two_three').to_s).to eq ' #one_two_three'\n+      expect(subject.match('hello #one_two_three').to_s).to eq '#one_two_three'\n     end\n \n     it 'matches middle dots' do\n-      expect(subject.match('hello #one\u00b7two\u00b7three').to_s).to eq ' #one\u00b7two\u00b7three'\n+      expect(subject.match('hello #one\u00b7two\u00b7three').to_s).to eq '#one\u00b7two\u00b7three'\n     end\n \n     it 'matches \u30fbunicode in \u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f correctly' do\n-      expect(subject.match('testing #\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f').to_s).to eq ' #\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f'\n+      expect(subject.match('testing #\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f').to_s).to eq '#\u307c\u3063\u3061\u30fb\u3056\u30fb\u308d\u3063\u304f'\n     end\n \n     it 'matches ZWNJ' do\n-      expect(subject.match('just add #\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631 and').to_s).to eq ' #\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631'\n+      expect(subject.match('just add #\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631 and').to_s).to eq '#\u0646\u0631\u0645\u200c\u0627\u0641\u0632\u0627\u0631'\n     end\n \n     it 'does not match middle dots at the start' do\n       expect(subject.match('hello #\u00b7one\u00b7two\u00b7three')).to be_nil\n     end\n \n     it 'does not match middle dots at the end' do\n-      expect(subject.match('hello #one\u00b7two\u00b7three\u00b7').to_s).to eq ' #one\u00b7two\u00b7three'\n+      expect(subject.match('hello #one\u00b7two\u00b7three\u00b7').to_s).to eq '#one\u00b7two\u00b7three'\n     end\n \n     it 'does not match purely-numeric hashtags' do\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -2677,7 +2677,7 @@ $ui-header-logo-wordmark-width: 99px;\n }\n \n .tabs-bar__wrapper {\n-  background: var(--background-color-tint);\n+  background: var(--background-color);\n   backdrop-filter: var(--background-filter);\n   position: sticky;\n   top: $ui-header-height;\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/components/status_action_bar.jsx\n@@ -375,20 +375,29 @@ class StatusActionBar extends ImmutablePureComponent {\n \n     return (\n       <div className='status__action-bar'>\n-        <IconButton className='status__action-bar__button' title={replyTitle} icon={isReply ? 'reply' : replyIcon} iconComponent={isReply ? ReplyIcon : replyIconComponent} onClick={this.handleReplyClick} counter={status.get('replies_count')} />\n-        <IconButton className={classNames('status__action-bar__button', { reblogPrivate })} disabled={!publicStatus && !reblogPrivate} active={status.get('reblogged')} title={reblogTitle} icon='retweet' iconComponent={reblogIconComponent} onClick={this.handleReblogClick} counter={withCounters ? status.get('reblogs_count') : undefined} />\n-        <IconButton className='status__action-bar__button star-icon' animate active={status.get('favourited')} title={intl.formatMessage(messages.favourite)} icon='star' iconComponent={status.get('favourited') ? StarIcon : StarBorderIcon} onClick={this.handleFavouriteClick} counter={withCounters ? status.get('favourites_count') : undefined} />\n-        <IconButton className='status__action-bar__button bookmark-icon' disabled={!signedIn} active={status.get('bookmarked')} title={intl.formatMessage(messages.bookmark)} icon='bookmark' iconComponent={status.get('bookmarked') ? BookmarkIcon : BookmarkBorderIcon} onClick={this.handleBookmarkClick} />\n-\n-        <DropdownMenuContainer\n-          scrollKey={scrollKey}\n-          status={status}\n-          items={menu}\n-          icon='ellipsis-h'\n-          iconComponent={MoreHorizIcon}\n-          direction='right'\n-          title={intl.formatMessage(messages.more)}\n-        />\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className='status__action-bar__button' title={replyTitle} icon={isReply ? 'reply' : replyIcon} iconComponent={isReply ? ReplyIcon : replyIconComponent} onClick={this.handleReplyClick} counter={status.get('replies_count')} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className={classNames('status__action-bar__button', { reblogPrivate })} disabled={!publicStatus && !reblogPrivate} active={status.get('reblogged')} title={reblogTitle} icon='retweet' iconComponent={reblogIconComponent} onClick={this.handleReblogClick} counter={withCounters ? status.get('reblogs_count') : undefined} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className='status__action-bar__button star-icon' animate active={status.get('favourited')} title={intl.formatMessage(messages.favourite)} icon='star' iconComponent={status.get('favourited') ? StarIcon : StarBorderIcon} onClick={this.handleFavouriteClick} counter={withCounters ? status.get('favourites_count') : undefined} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <IconButton className='status__action-bar__button bookmark-icon' disabled={!signedIn} active={status.get('bookmarked')} title={intl.formatMessage(messages.bookmark)} icon='bookmark' iconComponent={status.get('bookmarked') ? BookmarkIcon : BookmarkBorderIcon} onClick={this.handleBookmarkClick} />\n+        </div>\n+        <div className='status__action-bar__button-wrapper'>\n+          <DropdownMenuContainer\n+            scrollKey={scrollKey}\n+            status={status}\n+            items={menu}\n+            icon='ellipsis-h'\n+            iconComponent={MoreHorizIcon}\n+            direction='right'\n+            title={intl.formatMessage(messages.more)}\n+          />\n+        </div>\n       </div>\n     );\n   }\n---\napp/javascript/styles/mastodon/components.scss\n@@ -299,6 +299,10 @@\n     }\n   }\n \n+  &--with-counter {\n+    padding-inline-end: 4px;\n+  }\n+\n   &__counter {\n     display: block;\n     width: auto;\n@@ -1465,6 +1469,15 @@ body > [data-popper-placement] {\n     }\n   }\n \n+  &__action-bar__button-wrapper {\n+    flex-basis: 0;\n+    flex-grow: 1;\n+\n+    &:last-child {\n+      flex-grow: 0;\n+    }\n+  }\n+\n   &--first-in-thread {\n     border-top: 1px solid var(--background-border-color);\n   }\n---\n\n\n---\n\n"}], "ideal": "A"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\r\n\r\nUse ntfy.sh for push notifications causes Sidekiq to freeze before failing and continuing.\r\n\r\n### Expected behaviour\r\n\r\nfast or non blocking time out\r\n\r\n### Actual behaviour\r\n\r\ntime out taking too long\r\n\r\n### Detailed description\r\n\r\nI have seen on multiple Mastodon installations that Sidekiq freezes while processing `PushNotificationWorker`. \r\n\r\nOn all cases that I have seen this happening there are timeouts on requests to ntfy.sh.\r\n\r\nExample:\r\n````\r\n2023-07-22T09:03:40.102Z pid=7 tid=2hmv class=Web::PushNotificationWorker jid=60b27c61419b1a71ff0787f1 elapsed=129.454 INFO: fail\r\n2023-07-22T09:03:40.102Z pid=7 tid=2hmv WARN: {\"context\":\"Job raised exception\",\"job\":{\"retry\":5,\"queue\":\"push\",\"class\":\"Web::PushNotificationWorker\",\"args\":[68395,1147646],\"jid\":\"60b27c61419b1a71ff0787f1\",\"created_at\":1690012751.5607605,\"enqueued_at\":1690015901.6819582,\"error_message\":\"failed to connect: Connection timed out - connect(2) for 159.203.148.75:443 on https://ntfy.sh/_ONE_HASH_EXAMPLE_?up=1\",\"error_class\":\"HTTP::ConnectionError\",\"failed_at\":1690013410.8812373,\"retry_count\":2,\"retried_at\":1690015845.9492471}}\r\n2023-07-22T09:03:40.102Z pid=7 tid=2hmv WARN: HTTP::ConnectionError: failed to connect: Connection timed out - connect(2) for 159.203.148.75:443 on https://ntfy.sh/_ONE_HASH_EXAMPLE_?up=1\r\n2023-07-22T09:03:40.102Z pid=7 tid=2hmv WARN: /opt/ruby/lib/ruby/3.0.0/socket.rb:1214:in `__connect_nonblock'\r\n2023-07-22T09:03:40.103Z pid=7 tid=2hbr class=Web::PushNotificationWorker jid=3684ce8ee1f12b85b2116b52 elapsed=130.103 INFO: fail\r\n2023-07-22T09:03:40.103Z pid=7 tid=2hbr WARN: {\"context\":\"Job raised exception\",\"job\":{\"retry\":5,\"queue\":\"push\",\"class\":\"Web::PushNotificationWorker\",\"args\":[68825,1147652],\"jid\":\"3684ce8ee1f12b85b2116b52\",\"created_at\":1690012800.725376,\"enqueued_at\":1690015753.0426877,\"error_message\":\"failed to connect: Connection timed out - connect(2) for 159.203.148.75:443 on https://ntfy.sh/_ONE_HASH_EXAMPLE_?up=1\",\"error_class\":\"HTTP::ConnectionError\",\"failed_at\":1690013486.65336,\"retry_count\":2,\"retried_at\":1690015696.449503}}\r\n2023-07-22T09:03:40.107Z pid=7 tid=2hbr WARN: HTTP::ConnectionError: failed to connect: Connection timed out - connect(2) for 159.203.148.75:443 on https://ntfy.sh/_ONE_HASH_EXAMPLE_?up=1\r\n2023-07-22T09:03:40.108Z pid=7 tid=2hbr WARN: /opt/ruby/lib/ruby/3.0.0/socket.rb:1214:in `__connect_nonblock'\r\n2023-07-22T09:03:40.095Z pid=7 tid=2heb class=Web::PushNotificationWorker jid=26d65f50ad26f5937a1928e6 INFO: Adding dead Web::PushNotificationWorker job 26d65f50ad26f5937a1928e6\r\n2023-07-22T09:03:40.105Z pid=7 tid=2hhn class=Web::PushNotificationWorker jid=d378fd3313d12ac62d651220 elapsed=129.618 INFO: fail\r\n2023-07-22T09:03:40.109Z pid=7 tid=2hhn WARN: {\"context\":\"Job raised exception\",\"job\":{\"retry\":5,\"queue\":\"push\",\"class\":\"Web::PushNotificationWorker\",\"args\":[68035,1147646],\"jid\":\"d378fd3313d12ac62d651220\",\"created_at\":1690012751.5607605,\"enqueued_at\":1690015864.5601733,\"error_message\":\"failed to connect: Connection timed out - connect(2) for 159.203.148.75:443 on https://ntfy.sh/_ONE_HASH_EXAMPLE_?up=1\",\"error_class\":\"HTTP::ConnectionError\",\"failed_at\":1690013347.3894298,\"retry_count\":2,\"retried_at\":1690015811.1333215}}\r\n2023-07-22T09:03:40.109Z pid=7 tid=2heb class=Web::PushNotificationWorker jid=26d65f50ad26f5937a1928e6 elapsed=129.636 INFO: fail\r\n2023-07-22T09:03:40.109Z pid=7 tid=2heb WARN: {\"context\":\"Job raised exception\",\"job\":{\"retry\":5,\"queue\":\"push\",\"class\":\"Web::PushNotificationWorker\",\"args\":[56687,1147628],\"jid\":\"26d65f50ad26f5937a1928e6\",\"created_at\":1690011829.8810835,\"enqueued_at\":1690015847.922677,\"error_message\":\"failed to connect: Connection timed out - connect(2) for 159.203.148.75:443 on https://ntfy.sh/_DIFFERENT_HASH_EXAMPLE_?up=1\",\"error_class\":\"HTTP::ConnectionError\",\"failed_at\":1690012098.1093197,\"retry_count\":4,\"retried_at\":1690015548.9941778}}\r\n2023-07-22T09:03:40.109Z pid=7 tid=2heb WARN: HTTP::ConnectionError: failed to connect: Connection timed out - connect(2) for 159.203.148.75:443 on https://ntfy.sh/_DIFFERENT_HASH_EXAMPLE_?up=1\r\n2023-07-22T09:03:40.109Z pid=7 tid=2heb WARN: /opt/ruby/lib/ruby/3.0.0/socket.rb:1214:in `__connect_nonblock'\r\n2023-07-22T09:03:40.105Z pid=7 tid=2hhb class=Web::PushNotificationWorker jid=ce33d8556b563cacfd24e8f2 elapsed=129.628 INFO: fail\r\n2023-07-22T09:03:40.110Z pid=7 tid=2hhb WARN: {\"context\":\"Job raised exception\",\"job\":{\"retry\":5,\"queue\":\"push\",\"class\":\"Web::PushNotificationWorker\",\"args\":[68825,1147632],\"jid\":\"ce33d8556b563cacfd24e8f2\",\"created_at\":1690011841.54834,\"enqueued_at\":1690015864.5594342,\"error_message\":\"failed to connect: Connection timed out - connect(2) for 159.203.148.75:443 on https://ntfy.sh/_ONE_HASH_EXAMPLE_?up=1\",\"error_class\":\"HTTP::ConnectionError\",\"failed_at\":1690012104.2540042,\"retry_count\":4,\"retried_at\":1690015583.805272}}\r\n````\r\n\r\nNot sure if the freezes really block all other processing or if there are simply multiple requests waiting for the timeout but reverting #26055 solves the problem.\r\n\r\n### Mastodon version\r\n\r\nv4.1.5\r\n\n\n---\n\nChoice A:\napp/services/post_status_service.rb\n@@ -134,7 +134,7 @@ def validate_media!\n \n     @media = @account.media_attachments.where(status_id: nil).where(id: @options[:media_ids].take(Status::MEDIA_ATTACHMENTS_LIMIT).map(&:to_i))\n \n-    not_found_ids = @options[:media_ids] - @media.map(&:id)\n+    not_found_ids = @options[:media_ids].map(&:to_i) - @media.map(&:id)\n     raise Mastodon::ValidationError, I18n.t('media_attachments.validations.not_found', ids: not_found_ids.join(', ')) if not_found_ids.any?\n \n     raise Mastodon::ValidationError, I18n.t('media_attachments.validations.images_and_video') if @media.size > 1 && @media.find(&:audio_or_video?)\n---\napp/services/update_status_service.rb\n@@ -73,7 +73,7 @@ def validate_media!\n \n     media_attachments = @status.account.media_attachments.where(status_id: [nil, @status.id]).where(scheduled_status_id: nil).where(id: @options[:media_ids].take(Status::MEDIA_ATTACHMENTS_LIMIT).map(&:to_i)).to_a\n \n-    not_found_ids = @options[:media_ids] - media_attachments.map(&:id)\n+    not_found_ids = @options[:media_ids].map(&:to_i) - media_attachments.map(&:id)\n     raise Mastodon::ValidationError, I18n.t('media_attachments.validations.not_found', ids: not_found_ids.join(', ')) if not_found_ids.any?\n \n     raise Mastodon::ValidationError, I18n.t('media_attachments.validations.images_and_video') if media_attachments.size > 1 && media_attachments.find(&:audio_or_video?)\n---\nspec/services/post_status_service_spec.rb\n@@ -34,15 +34,15 @@\n \n     it 'schedules a status for future creation and does not create one immediately' do\n       media = Fabricate(:media_attachment, account: account)\n-      status = subject.call(account, text: 'Hi future!', media_ids: [media.id], scheduled_at: future)\n+      status = subject.call(account, text: 'Hi future!', media_ids: [media.id.to_s], scheduled_at: future)\n \n       expect(status)\n         .to be_a(ScheduledStatus)\n         .and have_attributes(\n           scheduled_at: eq(future),\n           params: include(\n             'text' => eq('Hi future!'),\n-            'media_ids' => contain_exactly(media.id)\n+            'media_ids' => contain_exactly(media.id.to_s)\n           )\n         )\n       expect(media.reload.status).to be_nil\n@@ -219,7 +219,7 @@\n     status = subject.call(\n       account,\n       text: 'test status update',\n-      media_ids: [media.id]\n+      media_ids: [media.id.to_s]\n     )\n \n     expect(media.reload.status).to eq status\n@@ -233,7 +233,7 @@\n       subject.call(\n         account,\n         text: 'test status update',\n-        media_ids: [media.id]\n+        media_ids: [media.id.to_s]\n       )\n     end.to raise_error(\n       Mastodon::ValidationError,\n@@ -249,7 +249,7 @@\n       subject.call(\n         account,\n         text: 'test status update',\n-        media_ids: Array.new(2) { Fabricate(:media_attachment, account: account) }.map(&:id)\n+        media_ids: Array.new(2) { Fabricate(:media_attachment, account: account) }.map { |m| m.id.to_s }\n       )\n     end.to raise_error(\n       Mastodon::ValidationError,\n@@ -271,7 +271,7 @@\n         media_ids: [\n           video,\n           image,\n-        ].map(&:id)\n+        ].map { |m| m.id.to_s }\n       )\n     end.to raise_error(\n       Mastodon::ValidationError,\n---\nspec/services/update_status_service_spec.rb\n@@ -69,7 +69,7 @@\n \n     before do\n       status.media_attachments << detached_media_attachment\n-      subject.call(status, status.account_id, text: 'Foo', media_ids: [attached_media_attachment.id])\n+      subject.call(status, status.account_id, text: 'Foo', media_ids: [attached_media_attachment.id.to_s])\n     end\n \n     it 'updates media attachments' do\n@@ -95,7 +95,7 @@\n \n     before do\n       status.media_attachments << media_attachment\n-      subject.call(status, status.account_id, text: 'Foo', media_ids: [media_attachment.id], media_attributes: [{ id: media_attachment.id, description: 'New description' }])\n+      subject.call(status, status.account_id, text: 'Foo', media_ids: [media_attachment.id.to_s], media_attributes: [{ id: media_attachment.id, description: 'New description' }])\n     end\n \n     it 'does not detach media attachment' do\n---\n\n\n---\n\nChoice B:\napp/javascript/styles/mastodon/components.scss\n@@ -2836,7 +2836,7 @@ $ui-header-logo-wordmark-width: 99px;\n   overflow: hidden;\n }\n \n-@media screen and (width >= 631px) {\n+@media screen and (width > $mobile-breakpoint) {\n   .columns-area {\n     padding: 0;\n   }\n@@ -5731,7 +5731,7 @@ a.status-card {\n   user-select: text;\n   display: flex;\n \n-  @media screen and (width <= 630px) {\n+  @media screen and (width <= $mobile-breakpoint) {\n     margin-top: auto;\n   }\n }\n@@ -6090,7 +6090,7 @@ a.status-card {\n     border-radius: 0 0 16px 16px;\n     border-top: 0;\n \n-    @media screen and (max-width: $no-gap-breakpoint) {\n+    @media screen and (max-width: $mobile-breakpoint) {\n       border-radius: 0;\n       border-bottom: 0;\n       padding-bottom: 32px;\n@@ -9092,8 +9092,9 @@ noscript {\n   backdrop-filter: var(--background-filter);\n   border: 1px solid var(--modal-border-color);\n   padding: 24px;\n+  box-sizing: border-box;\n \n-  @media screen and (max-width: $no-gap-breakpoint) {\n+  @media screen and (max-width: $mobile-breakpoint) {\n     border-radius: 16px 16px 0 0;\n     border-bottom: 0;\n     padding-bottom: 32px;\n---\napp/javascript/styles/mastodon/variables.scss\n@@ -88,6 +88,7 @@ $media-modal-media-max-width: 100%;\n $media-modal-media-max-height: 80%;\n \n $no-gap-breakpoint: 1175px;\n+$mobile-breakpoint: 630px;\n \n $font-sans-serif: 'mastodon-font-sans-serif' !default;\n $font-display: 'mastodon-font-display' !default;\n---\n\n\n---\n\nChoice C:\napp/lib/request.rb\n@@ -284,11 +284,11 @@ def open(host, *args)\n         end\n \n         until socks.empty?\n-          _, available_socks, = IO.select(nil, socks, nil, Request::TIMEOUT[:connect])\n+          _, available_socks, = IO.select(nil, socks, nil, Request::TIMEOUT[:connect_timeout])\n \n           if available_socks.nil?\n             socks.each(&:close)\n-            raise HTTP::TimeoutError, \"Connect timed out after #{Request::TIMEOUT[:connect]} seconds\"\n+            raise HTTP::TimeoutError, \"Connect timed out after #{Request::TIMEOUT[:connect_timeout]} seconds\"\n           end\n \n           available_socks.each do |sock|\n---\n\n\n---\n\nChoice D:\napp/models/media_attachment.rb\n@@ -172,7 +172,7 @@ class MediaAttachment < ApplicationRecord\n   DEFAULT_STYLES = [:original].freeze\n \n   GLOBAL_CONVERT_OPTIONS = {\n-    all: '-quality 90 +profile \"!icc,*\" +set modify-date +set create-date',\n+    all: '-quality 90 +profile \"!icc,*\" +set modify-date -define jpeg:dct-method=float +set create-date',\n   }.freeze\n \n   belongs_to :account,          inverse_of: :media_attachments, optional: true\n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Upload the attached GIF with a new post\r\n![blurX_v1_vs_v2](https://github.com/mastodon/mastodon/assets/3390/219534ec-eec7-40fe-8eda-3ffcbdff2845)\r\n\n\n### Expected behaviour\n\nThis should work as an image attachment.\n\n### Actual behaviour\n\nIt doesn't work, there's an error about that the thumbnail can't be created.\n\n### Detailed description\n\nSome GIFs aren't processed correctly for generating the media thumbnail. I've just created this GIF today in Photoshop.\r\n\r\nI have no problem uploading other GIFs, even those that have large filesizes or dimensions.\r\nThe GIF also works fine on other social media platforms such as Threads.\n\n### Specifications\n\nThis was on hachyderm.io, which currently runs Mastodon v4.1.4.\n\n---\n\nChoice A:\napp/javascript/styles/mastodon/components.scss\n@@ -3611,6 +3611,7 @@ $ui-header-logo-wordmark-width: 99px;\n   overflow-y: auto;\n   width: 100%;\n   height: 100%;\n+  z-index: 0;\n }\n \n .drawer__inner__mastodon {\n---\n\n\n---\n\nChoice B:\napp/models/admin/import.rb\n@@ -30,12 +30,14 @@ def csv_data\n \n     csv_converter = lambda do |field, field_info|\n       case field_info.header\n-      when '#domain', '#public_comment'\n+      when '#domain'\n+        field&.downcase&.strip\n+      when '#public_comment'\n         field&.strip\n       when '#severity'\n-        field&.strip&.to_sym\n+        field&.downcase&.strip&.to_sym\n       when '#reject_media', '#reject_reports', '#obfuscate'\n-        ActiveModel::Type::Boolean.new.cast(field)\n+        ActiveModel::Type::Boolean.new.cast(field&.downcase)\n       else\n         field\n       end\n---\n\n\n---\n\nChoice C:\napp/lib/activitypub/adapter.rb\n@@ -20,6 +20,6 @@ def serializable_hash(options = nil)\n     serialized_hash = serialized_hash.select { |k, _| options[:fields].include?(k) } if options[:fields]\n     serialized_hash = self.class.transform_key_casing!(serialized_hash, instance_options)\n \n-    { '@context' => serialized_context(named_contexts, context_extensions) }.merge(serialized_hash)\n+    { '@context': serialized_context(named_contexts, context_extensions) }.merge(serialized_hash)\n   end\n end\n---\napp/services/backup_service.rb\n@@ -19,8 +19,8 @@ def call(backup)\n \n   def build_outbox_json!(file)\n     skeleton = serialize(collection_presenter, ActivityPub::CollectionSerializer)\n-    skeleton['@context'] = full_context\n-    skeleton['orderedItems'] = ['!PLACEHOLDER!']\n+    skeleton[:@context] = full_context\n+    skeleton[:orderedItems] = ['!PLACEHOLDER!']\n     skeleton = Oj.dump(skeleton)\n     prepend, append = skeleton.split('\"!PLACEHOLDER!\"')\n     add_comma = false\n@@ -33,7 +33,7 @@ def build_outbox_json!(file)\n \n       file.write(statuses.map do |status|\n         item = serialize_payload(ActivityPub::ActivityPresenter.from_status(status), ActivityPub::ActivitySerializer)\n-        item.delete('@context')\n+        item.delete(:@context)\n \n         unless item[:type] == 'Announce' || item[:object][:attachment].blank?\n           item[:object][:attachment].each do |attachment|\n---\nspec/lib/activitypub/adapter_spec.rb\n@@ -59,39 +59,39 @@ def virtual_object\n       let(:serializer_class) { TestWithBasicContextSerializer }\n \n       it 'renders a basic @context' do\n-        expect(subject).to include({ '@context' => 'https://www.w3.org/ns/activitystreams' })\n+        expect(subject).to include({ '@context': 'https://www.w3.org/ns/activitystreams' })\n       end\n     end\n \n     context 'when serializer defines a named context' do\n       let(:serializer_class) { TestWithNamedContextSerializer }\n \n       it 'renders a @context with both items' do\n-        expect(subject).to include({ '@context' => ['https://www.w3.org/ns/activitystreams', 'https://w3id.org/security/v1'] })\n+        expect(subject).to include({ '@context': ['https://www.w3.org/ns/activitystreams', 'https://w3id.org/security/v1'] })\n       end\n     end\n \n     context 'when serializer has children that define a named context' do\n       let(:serializer_class) { TestWithNestedNamedContextSerializer }\n \n       it 'renders a @context with both items' do\n-        expect(subject).to include({ '@context' => ['https://www.w3.org/ns/activitystreams', 'https://w3id.org/security/v1'] })\n+        expect(subject).to include({ '@context': ['https://www.w3.org/ns/activitystreams', 'https://w3id.org/security/v1'] })\n       end\n     end\n \n     context 'when serializer defines context extensions' do\n       let(:serializer_class) { TestWithContextExtensionSerializer }\n \n       it 'renders a @context with the extension' do\n-        expect(subject).to include({ '@context' => ['https://www.w3.org/ns/activitystreams', { 'sensitive' => 'as:sensitive' }] })\n+        expect(subject).to include({ '@context': ['https://www.w3.org/ns/activitystreams', { 'sensitive' => 'as:sensitive' }] })\n       end\n     end\n \n     context 'when serializer has children that define context extensions' do\n       let(:serializer_class) { TestWithNestedContextExtensionSerializer }\n \n       it 'renders a @context with both extensions' do\n-        expect(subject).to include({ '@context' => ['https://www.w3.org/ns/activitystreams', { 'manuallyApprovesFollowers' => 'as:manuallyApprovesFollowers', 'sensitive' => 'as:sensitive' }] })\n+        expect(subject).to include({ '@context': ['https://www.w3.org/ns/activitystreams', { 'manuallyApprovesFollowers' => 'as:manuallyApprovesFollowers', 'sensitive' => 'as:sensitive' }] })\n       end\n     end\n   end\n---\nspec/services/backup_service_spec.rb\n@@ -60,6 +60,7 @@ def expect_outbox_export\n \n     aggregate_failures do\n       expect(body.scan('@context').count).to eq 1\n+      expect(body.scan('orderedItems').count).to eq 1\n       expect(json['@context']).to_not be_nil\n       expect(json['type']).to eq 'OrderedCollection'\n       expect(json['totalItems']).to eq 2\n---\n\n\n---\n\nChoice D:\napp/models/concerns/attachmentable.rb\n@@ -52,9 +52,13 @@ def check_image_dimension(attachment)\n     return if attachment.blank? || !/image.*/.match?(attachment.content_type) || attachment.queued_for_write[:original].blank?\n \n     width, height = FastImage.size(attachment.queued_for_write[:original].path)\n-    matrix_limit  = attachment.content_type == 'image/gif' ? GIF_MATRIX_LIMIT : MAX_MATRIX_LIMIT\n+    return unless width.present? && height.present?\n \n-    raise Mastodon::DimensionsValidationError, \"#{width}x#{height} images are not supported\" if width.present? && height.present? && (width * height > matrix_limit)\n+    if attachment.content_type == 'image/gif' && width * height > GIF_MATRIX_LIMIT\n+      raise Mastodon::DimensionsValidationError, \"#{width}x#{height} GIF files are not supported\"\n+    elsif width * height > MAX_MATRIX_LIMIT\n+      raise Mastodon::DimensionsValidationError, \"#{width}x#{height} images are not supported\"\n+    end\n   end\n \n   def appropriate_extension(attachment)\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nI got this error from last month, after #25342\r\n\r\nWe need fallback behaviour if user's timezone setting is nil\n\n### Expected behaviour\n\nEmail sent normally\n\n### Actual behaviour\n\nEmail not sent\n\n### Detailed description\n\n![image](https://github.com/mastodon/mastodon/assets/5047683/456e0919-4aae-4fb3-a84e-ac902f3275e9)\r\n\r\n<details>\r\n<summary>Stack trace</summary>\r\n```\r\nArgumentError: Invalid Timezone:  (ArgumentError)\r\n\r\n      ActiveSupport::TimeZone[time_zone] || raise(ArgumentError, \"Invalid Timezone: #{time_zone}\")\r\n                                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  from activesupport (7.0.6) lib/active_support/core_ext/time/zones.rb:84:in `find_zone!'\r\n  from activesupport (7.0.6) lib/active_support/core_ext/date_and_time/zones.rb:21:in `in_time_zone'\r\n  from app/views/user_mailer/suspicious_sign_in.html.haml:50\r\n  from actionview (7.0.6) lib/action_view/base.rb:244:in `public_send'\r\n  from actionview (7.0.6) lib/action_view/base.rb:244:in `_run'\r\n  from actionview (7.0.6) lib/action_view/template.rb:157:in `block in render'\r\n  from activesupport (7.0.6) lib/active_support/notifications.rb:206:in `block in instrument'\r\n  from activesupport (7.0.6) lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\n  from sentry-rails (5.9.0) lib/sentry/rails/tracing.rb:54:in `instrument'\r\n  from activesupport (7.0.6) lib/active_support/notifications.rb:206:in `instrument'\r\n  from actionview (7.0.6) lib/action_view/template.rb:361:in `instrument_render_template'\r\n  from actionview (7.0.6) lib/action_view/template.rb:155:in `render'\r\n  from actionview (7.0.6) lib/action_view/renderer/template_renderer.rb:65:in `block (2 levels) in render_template'\r\n  from activesupport (7.0.6) lib/active_support/notifications.rb:206:in `block in instrument'\r\n  from activesupport (7.0.6) lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\n  from sentry-rails (5.9.0) lib/sentry/rails/tracing.rb:54:in `instrument'\r\n  from activesupport (7.0.6) lib/active_support/notifications.rb:206:in `instrument'\r\n  from actionview (7.0.6) lib/action_view/renderer/template_renderer.rb:60:in `block in render_template'\r\n  from actionview (7.0.6) lib/action_view/renderer/template_renderer.rb:75:in `block in render_with_layout'\r\n  from activesupport (7.0.6) lib/active_support/notifications.rb:206:in `block in instrument'\r\n  from activesupport (7.0.6) lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\n  from sentry-rails (5.9.0) lib/sentry/rails/tracing.rb:54:in `instrument'\r\n  from activesupport (7.0.6) lib/active_support/notifications.rb:206:in `instrument'\r\n  from actionview (7.0.6) lib/action_view/renderer/template_renderer.rb:74:in `render_with_layout'\r\n  from actionview (7.0.6) lib/action_view/renderer/template_renderer.rb:59:in `render_template'\r\n  from actionview (7.0.6) lib/action_view/renderer/template_renderer.rb:11:in `render'\r\n  from actionview (7.0.6) lib/action_view/renderer/renderer.rb:61:in `render_template_to_object'\r\n  from actionview (7.0.6) lib/action_view/renderer/renderer.rb:29:in `render_to_object'\r\n  from actionview (7.0.6) lib/action_view/rendering.rb:117:in `block in _render_template'\r\n  from actionview (7.0.6) lib/action_view/base.rb:270:in `in_rendering_context'\r\n  from actionview (7.0.6) lib/action_view/rendering.rb:116:in `_render_template'\r\n  from actionview (7.0.6) lib/action_view/rendering.rb:103:in `render_to_body'\r\n  from actionpack (7.0.6) lib/abstract_controller/rendering.rb:27:in `render'\r\n  from actionmailer (7.0.6) lib/action_mailer/base.rb:992:in `block in collect_responses_from_templates'\r\n  from actionmailer (7.0.6) lib/action_mailer/base.rb:989:in `each'\r\n  from actionmailer (7.0.6) lib/action_mailer/base.rb:989:in `each'\r\n  from actionmailer (7.0.6) lib/action_mailer/base.rb:989:in `map'\r\n  from actionmailer (7.0.6) lib/action_mailer/base.rb:989:in `collect_responses_from_templates'\r\n  from actionmailer (7.0.6) lib/action_mailer/base.rb:967:in `collect_responses'\r\n  from actionmailer (7.0.6) lib/action_mailer/base.rb:875:in `mail'\r\n  from app/mailers/user_mailer.rb:204:in `block in suspicious_sign_in'\r\n  from i18n (1.14.1) lib/i18n.rb:322:in `with_locale'\r\n  from app/mailers/user_mailer.rb:203:in `suspicious_sign_in'\r\n  from actionpack (7.0.6) lib/abstract_controller/base.rb:215:in `process_action'\r\n  from actionpack (7.0.6) lib/abstract_controller/callbacks.rb:234:in `block in process_action'\r\n  from activesupport (7.0.6) lib/active_support/callbacks.rb:99:in `run_callbacks'\r\n  from actionpack (7.0.6) lib/abstract_controller/callbacks.rb:233:in `process_action'\r\n  from actionpack (7.0.6) lib/abstract_controller/base.rb:151:in `process'\r\n  from actionmailer (7.0.6) lib/action_mailer/rescuable.rb:27:in `block in process'\r\n  from actionmailer (7.0.6) lib/action_mailer/rescuable.rb:19:in `handle_exceptions'\r\n  from actionmailer (7.0.6) lib/action_mailer/rescuable.rb:26:in `process'\r\n  from actionview (7.0.6) lib/action_view/rendering.rb:39:in `process'\r\n  from actionmailer (7.0.6) lib/action_mailer/base.rb:646:in `block in process'\r\n  from activesupport (7.0.6) lib/active_support/notifications.rb:206:in `block in instrument'\r\n  from activesupport (7.0.6) lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\n  from sentry-rails (5.9.0) lib/sentry/rails/tracing.rb:54:in `instrument'\r\n  from activesupport (7.0.6) lib/active_support/notifications.rb:206:in `instrument'\r\n  from actionmailer (7.0.6) lib/action_mailer/base.rb:645:in `process'\r\n  from actionmailer (7.0.6) lib/action_mailer/message_delivery.rb:128:in `block in processed_mailer'\r\n  from <internal:kernel>:90:in `tap'\r\n  from actionmailer (7.0.6) lib/action_mailer/message_delivery.rb:127:in `processed_mailer'\r\n  from actionmailer (7.0.6) lib/action_mailer/message_delivery.rb:108:in `deliver_now!'\r\n  from actionmailer (7.0.6) lib/action_mailer/mail_delivery_job.rb:23:in `perform'\r\n  from activejob (7.0.6) lib/active_job/execution.rb:65:in `block in _perform_job'\r\n  from activesupport (7.0.6) lib/active_support/callbacks.rb:118:in `block in run_callbacks'\r\n  from i18n (1.14.1) lib/i18n.rb:322:in `with_locale'\r\n  from activejob (7.0.6) lib/active_job/translation.rb:9:in `block (2 levels) in <module:Translation>'\r\n  from activesupport (7.0.6) lib/active_support/callbacks.rb:127:in `instance_exec'\r\n  from activesupport (7.0.6) lib/active_support/callbacks.rb:127:in `block in run_callbacks'\r\n  from activesupport (7.0.6) lib/active_support/core_ext/time/zones.rb:65:in `use_zone'\r\n  from activejob (7.0.6) lib/active_job/timezones.rb:9:in `block (2 levels) in <module:Timezones>'\r\n  from activesupport (7.0.6) lib/active_support/callbacks.rb:127:in `instance_exec'\r\n  from activesupport (7.0.6) lib/active_support/callbacks.rb:127:in `block in run_callbacks'\r\n  from activesupport (7.0.6) lib/active_support/callbacks.rb:138:in `run_callbacks'\r\n  from activejob (7.0.6) lib/active_job/execution.rb:64:in `_perform_job'\r\n  from activejob (7.0.6) lib/active_job/instrumentation.rb:20:in `_perform_job'\r\n  from activejob (7.0.6) lib/active_job/execution.rb:52:in `perform_now'\r\n  from activejob (7.0.6) lib/active_job/instrumentation.rb:14:in `block in perform_now'\r\n  from activejob (7.0.6) lib/active_job/instrumentation.rb:25:in `block in instrument'\r\n  from activesupport (7.0.6) lib/active_support/notifications.rb:206:in `block in instrument'\r\n  from activesupport (7.0.6) lib/active_support/notifications/instrumenter.rb:24:in `instrument'\r\n  from sentry-rails (5.9.0) lib/sentry/rails/tracing.rb:54:in `instrument'\r\n  from activesupport (7.0.6) lib/active_support/notifications.rb:206:in `instrument'\r\n  from activejob (7.0.6) lib/active_job/instrumentation.rb:35:in `instrument'\r\n  from activejob (7.0.6) lib/active_job/instrumentation.rb:14:in `perform_now'\r\n  from activejob (7.0.6) lib/active_job/logging.rb:18:in `block in perform_now'\r\n  from activesupport (7.0.6) lib/active_support/tagged_logging.rb:99:in `block in tagged'\r\n  from activesupport (7.0.6) lib/active_support/tagged_logging.rb:37:in `tagged'\r\n  from activesupport (7.0.6) lib/active_support/tagged_logging.rb:99:in `tagged'\r\n  from activejob (7.0.6) lib/active_job/logging.rb:25:in `tag_logger'\r\n  from activejob (7.0.6) lib/active_job/logging.rb:18:in `perform_now'\r\n  from sentry-rails (5.9.0) lib/sentry/rails/active_job.rb:6:in `perform_now'\r\n  from activejob (7.0.6) lib/active_job/execution.rb:30:in `block in execute'\r\n  from activesupport (7.0.6) lib/active_support/callbacks.rb:118:in `block in run_callbacks'\r\n  from activejob (7.0.6) lib/active_job/railtie.rb:54:in `block (4 levels) in <class:Railtie>'\r\n  from activesupport (7.0.6) lib/active_support/execution_wrapper.rb:92:in `wrap'\r\n  from activesupport (7.0.6) lib/active_support/reloader.rb:72:in `block in wrap'\r\n  from activesupport (7.0.6) lib/active_support/execution_wrapper.rb:88:in `wrap'\r\n  from activesupport (7.0.6) lib/active_support/reloader.rb:71:in `wrap'\r\n  from activejob (7.0.6) lib/active_job/railtie.rb:53:in `block (3 levels) in <class:Railtie>'\r\n  from activesupport (7.0.6) lib/active_support/callbacks.rb:127:in `instance_exec'\r\n  from activesupport (7.0.6) lib/active_support/callbacks.rb:127:in `block in run_callbacks'\r\n  from activesupport (7.0.6) lib/active_support/callbacks.rb:138:in `run_callbacks'\r\n  from activejob (7.0.6) lib/active_job/execution.rb:28:in `execute'\r\n  from activejob (7.0.6) lib/active_job/queue_adapters/sidekiq_adapter.rb:42:in `perform'\r\n  from sidekiq (6.5.9) lib/sidekiq/processor.rb:202:in `execute_job'\r\n  from sidekiq (6.5.9) lib/sidekiq/processor.rb:170:in `block (2 levels) in process'\r\n  from sidekiq (6.5.9) lib/sidekiq/middleware/chain.rb:177:in `block in invoke'\r\n  from sidekiq-unique-jobs (7.1.29) lib/sidekiq_unique_jobs/middleware.rb:36:in `call'\r\n  from sidekiq (6.5.9) lib/sidekiq/middleware/chain.rb:179:in `block in invoke'\r\n  from chewy (7.3.3) lib/chewy/strategy.rb:60:in `wrap'\r\n  from chewy (7.3.3) lib/chewy.rb:154:in `strategy'\r\n  from lib/mastodon/sidekiq_middleware.rb:7:in `call'\r\n  from sidekiq (6.5.9) lib/sidekiq/middleware/chain.rb:179:in `block in invoke'\r\n  from sentry-sidekiq (5.9.0) lib/sentry/sidekiq/sentry_context_middleware.rb:26:in `call'\r\n  from sidekiq (6.5.9) lib/sidekiq/middleware/chain.rb:179:in `block in invoke'\r\n  from sidekiq (6.5.9) lib/sidekiq/middleware/chain.rb:182:in `invoke'\r\n  from sidekiq (6.5.9) lib/sidekiq/processor.rb:169:in `block in process'\r\n  from sidekiq (6.5.9) lib/sidekiq/processor.rb:136:in `block (6 levels) in dispatch'\r\n  from sidekiq (6.5.9) lib/sidekiq/job_retry.rb:113:in `local'\r\n  from sidekiq (6.5.9) lib/sidekiq/processor.rb:135:in `block (5 levels) in dispatch'\r\n  from sidekiq (6.5.9) lib/sidekiq/rails.rb:14:in `block in call'\r\n  from activesupport (7.0.6) lib/active_support/execution_wrapper.rb:92:in `wrap'\r\n  from activesupport (7.0.6) lib/active_support/reloader.rb:72:in `block in wrap'\r\n  from activesupport (7.0.6) lib/active_support/execution_wrapper.rb:92:in `wrap'\r\n  from activesupport (7.0.6) lib/active_support/reloader.rb:71:in `wrap'\r\n  from sidekiq (6.5.9) lib/sidekiq/rails.rb:13:in `call'\r\n  from sidekiq (6.5.9) lib/sidekiq/processor.rb:131:in `block (4 levels) in dispatch'\r\n  from sidekiq (6.5.9) lib/sidekiq/processor.rb:263:in `stats'\r\n  from sidekiq (6.5.9) lib/sidekiq/processor.rb:126:in `block (3 levels) in dispatch'\r\n  from sidekiq (6.5.9) lib/sidekiq/job_logger.rb:13:in `call'\r\n  from sidekiq (6.5.9) lib/sidekiq/processor.rb:125:in `block (2 levels) in dispatch'\r\n  from sidekiq (6.5.9) lib/sidekiq/job_retry.rb:80:in `global'\r\n  from sidekiq (6.5.9) lib/sidekiq/processor.rb:124:in `block in dispatch'\r\n  from sidekiq (6.5.9) lib/sidekiq/job_logger.rb:39:in `prepare'\r\n  from sidekiq (6.5.9) lib/sidekiq/processor.rb:123:in `dispatch'\r\n  from sidekiq (6.5.9) lib/sidekiq/processor.rb:168:in `process'\r\n  from sidekiq (6.5.9) lib/sidekiq/processor.rb:78:in `process_one'\r\n  from sidekiq (6.5.9) lib/sidekiq/processor.rb:68:in `run'\r\n  from sidekiq (6.5.9) lib/sidekiq/component.rb:8:in `watchdog'\r\n  from sidekiq (6.5.9) lib/sidekiq/component.rb:17:in `block in safe_thread'\r\n\r\nActionView::Template::Error: Invalid Timezone:  (ActionView::Template::Error)\r\n  from activesupport (7.0.6) lib/active_support/core_ext/time/zones.rb:84:in `find_zone!'\r\n  from activesupport (7.0.6) lib/active_support/core_ext/date_and_time/zones.rb:21:in `in_time_zone'\r\n  from app/views/user_mailer/suspicious_sign_in.html.haml:50\r\n```\r\n</details>\n\n### Specifications\n\nMastodon v4.1.4 (glitch)\n\n---\n\nChoice A:\napp/javascript/mastodon/api_types/accounts.ts\n@@ -13,7 +13,7 @@ export interface ApiAccountRoleJSON {\n }\n \n // See app/serializers/rest/account_serializer.rb\n-export interface ApiAccountJSON {\n+export interface BaseApiAccountJSON {\n   acct: string;\n   avatar: string;\n   avatar_static: string;\n@@ -45,3 +45,12 @@ export interface ApiAccountJSON {\n   memorial?: boolean;\n   hide_collections: boolean;\n }\n+\n+// See app/serializers/rest/muted_account_serializer.rb\n+export interface ApiMutedAccountJSON extends BaseApiAccountJSON {\n+  mute_expires_at?: string | null;\n+}\n+\n+// For now, we have the same type representing both `Account` and `MutedAccount`\n+// objects, but we should refactor this in the future.\n+export type ApiAccountJSON = ApiMutedAccountJSON;\n---\napp/javascript/mastodon/models/account.ts\n@@ -95,6 +95,9 @@ export const accountDefaultValues: AccountShape = {\n   limited: false,\n   moved: null,\n   hide_collections: false,\n+  // This comes from `ApiMutedAccountJSON`, but we should eventually\n+  // store that in a different object.\n+  mute_expires_at: null,\n };\n \n const AccountFactory = ImmutableRecord<AccountShape>(accountDefaultValues);\n---\n\n\n---\n\nChoice B:\napp/views/notification_mailer/_status.html.haml\n@@ -42,4 +42,4 @@\n                                         = link_to a.remote_url, a.remote_url\n \n                               %p.status-footer\n-                                = link_to l(status.created_at.in_time_zone(time_zone)), web_url(\"@#{status.account.pretty_acct}/#{status.id}\")\n+                                = link_to l(status.created_at.in_time_zone(time_zone.presence)), web_url(\"@#{status.account.pretty_acct}/#{status.id}\")\n---\napp/views/user_mailer/appeal_approved.html.haml\n@@ -36,7 +36,7 @@\n                         %tbody\n                           %tr\n                             %td.column-cell.text-center\n-                              %p= t 'user_mailer.appeal_approved.explanation', appeal_date: l(@appeal.created_at.in_time_zone(@resource.time_zone)), strike_date: l(@appeal.strike.created_at.in_time_zone(@resource.time_zone))\n+                              %p= t 'user_mailer.appeal_approved.explanation', appeal_date: l(@appeal.created_at.in_time_zone(@resource.time_zone.presence)), strike_date: l(@appeal.strike.created_at.in_time_zone(@resource.time_zone.presence))\n \n %table.email-table{ cellspacing: 0, cellpadding: 0 }\n   %tbody\n---\napp/views/user_mailer/appeal_approved.text.erb\n@@ -2,6 +2,6 @@\n \n ===\n \n-<%= t 'user_mailer.appeal_approved.explanation', appeal_date: l(@appeal.created_at.in_time_zone(@resource.time_zone)), strike_date: l(@appeal.strike.created_at.in_time_zone(@resource.time_zone)) %>\n+<%= t 'user_mailer.appeal_approved.explanation', appeal_date: l(@appeal.created_at.in_time_zone(@resource.time_zone.presence)), strike_date: l(@appeal.strike.created_at.in_time_zone(@resource.time_zone.presence)) %>\n \n => <%= root_url %>\n---\napp/views/user_mailer/appeal_rejected.html.haml\n@@ -36,7 +36,7 @@\n                         %tbody\n                           %tr\n                             %td.column-cell.text-center\n-                              %p= t 'user_mailer.appeal_rejected.explanation', appeal_date: l(@appeal.created_at.in_time_zone(@resource.time_zone)), strike_date: l(@appeal.strike.created_at.in_time_zone(@resource.time_zone))\n+                              %p= t 'user_mailer.appeal_rejected.explanation', appeal_date: l(@appeal.created_at.in_time_zone(@resource.time_zone.presence)), strike_date: l(@appeal.strike.created_at.in_time_zone(@resource.time_zone.presence))\n \n %table.email-table{ cellspacing: 0, cellpadding: 0 }\n   %tbody\n---\napp/views/user_mailer/appeal_rejected.text.erb\n@@ -2,6 +2,6 @@\n \n ===\n \n-<%= t 'user_mailer.appeal_rejected.explanation', appeal_date: l(@appeal.created_at.in_time_zone(@resource.time_zone)), strike_date: l(@appeal.strike.created_at.in_time_zone(@resource.time_zone)) %>\n+<%= t 'user_mailer.appeal_rejected.explanation', appeal_date: l(@appeal.created_at.in_time_zone(@resource.time_zone.presence)), strike_date: l(@appeal.strike.created_at.in_time_zone(@resource.time_zone.presence)) %>\n \n => <%= root_url %>\n---\napp/views/user_mailer/suspicious_sign_in.html.haml\n@@ -47,7 +47,7 @@\n                                 %strong= \"#{t('sessions.browser')}:\"\n                                 %span{ title: @user_agent }= t 'sessions.description', browser: t(\"sessions.browsers.#{@detection.id}\", default: @detection.id.to_s), platform: t(\"sessions.platforms.#{@detection.platform.id}\", default: @detection.platform.id.to_s)\n                                 %br/\n-                                = l(@timestamp.in_time_zone(@resource.time_zone))\n+                                = l(@timestamp.in_time_zone(@resource.time_zone.presence))\n \n %table.email-table{ cellspacing: 0, cellpadding: 0 }\n   %tbody\n---\napp/views/user_mailer/suspicious_sign_in.text.erb\n@@ -8,7 +8,7 @@\n \n <%= t('sessions.ip') %>: <%= @remote_ip %>\n <%= t('sessions.browser') %>: <%= t('sessions.description', browser: t(\"sessions.browsers.#{@detection.id}\", default: \"#{@detection.id}\"), platform: t(\"sessions.platforms.#{@detection.platform.id}\", default: \"#{@detection.platform.id}\")) %>\n-<%= l(@timestamp.in_time_zone(@resource.time_zone)) %>\n+<%= l(@timestamp.in_time_zone(@resource.time_zone.presence)) %>\n \n <%= t 'user_mailer.suspicious_sign_in.further_actions_html', action: t('user_mailer.suspicious_sign_in.change_password') %>\n \n---\napp/views/user_mailer/warning.html.haml\n@@ -58,7 +58,7 @@\n \n - unless @statuses.empty?\n   - @statuses.each_with_index do |status, i|\n-    = render 'notification_mailer/status', status: status, i: i + 1, highlighted: true, time_zone: @resource.time_zone\n+    = render 'notification_mailer/status', status: status, i: i + 1, highlighted: true, time_zone: @resource.time_zone.presence\n \n %table.email-table{ cellspacing: 0, cellpadding: 0 }\n   %tbody\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -9288,6 +9288,7 @@ noscript {\n   border: 1px solid $highlight-text-color;\n   background: rgba($highlight-text-color, 0.15);\n   overflow: hidden;\n+  flex-shrink: 0;\n \n   &__background-image {\n     width: 125%;\n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -1996,6 +1996,7 @@ body > [data-popper-placement] {\n \n         &__handle {\n           user-select: all;\n+          overflow-wrap: anywhere;\n         }\n       }\n \n---\n\n\n---\n\n"}], "ideal": "B"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Have a Pixel 6a running Android 13.\r\n2. Use the browser Firefox.\r\n3. \"Install\" a Glitch instance via \"Add to Home screen\", and log in.\r\n4. It looks like this, with the profile avatar at the top right shoved off the side of the screen, and it doesn't scroll to the side:\r\n![photo_2023-07-13_20-19-01](https://github.com/glitch-soc/mastodon/assets/6607512/d5cdf5f1-9a66-4df1-9e1c-32702bf95a6e)\n\n### Expected behaviour\n\nSpace for everything on the top bar of the UI.\n\n### Actual behaviour\n\nAvatar gets shoved off the right side of the screen.\n\n### Detailed description\n\nI initially reported this here: https://github.com/glitch-soc/mastodon/issues/2298 Because I thought it was a Glitch (fork) issue, but then was asked to put it here.\n\n### Specifications\n\nv4.1.3+glitch\r\n\r\nAndroid 13, Pixel 6a\r\n\r\nFirefox\n\n---\n\nChoice A:\nDockerfile\n@@ -103,6 +103,7 @@ RUN \\\n     procps \\\n     tini \\\n     tzdata \\\n+    wget \\\n   ; \\\n # Patch Ruby to use jemalloc\n   patchelf --add-needed libjemalloc.so.2 /usr/local/bin/ruby; \\\n---\n\n\n---\n\nChoice B:\napp/models/account.rb\n@@ -144,6 +144,7 @@ class Account < ApplicationRecord\n   scope :dormant, -> { joins(:account_stat).merge(AccountStat.without_recent_activity) }\n   scope :with_username, ->(value) { where arel_table[:username].lower.eq(value.to_s.downcase) }\n   scope :with_domain, ->(value) { where arel_table[:domain].lower.eq(value&.to_s&.downcase) }\n+  scope :without_memorial, -> { where(memorial: false) }\n \n   after_update_commit :trigger_update_webhooks\n \n---\napp/models/account_suggestions/friends_of_friends_source.rb\n@@ -31,6 +31,7 @@ def source_query(account, limit: DEFAULT_LIMIT)\n         AND accounts.suspended_at IS NULL\n         AND accounts.silenced_at IS NULL\n         AND accounts.moved_to_account_id IS NULL\n+        AND accounts.memorial = FALSE\n         AND follow_recommendation_mutes.target_account_id IS NULL\n       GROUP BY accounts.id, account_stats.id\n       ORDER BY frequency DESC, account_stats.followers_count ASC\n---\napp/models/account_suggestions/source.rb\n@@ -14,6 +14,7 @@ def base_account_scope(account)\n       .searchable\n       .where(discoverable: true)\n       .without_silenced\n+      .without_memorial\n       .where.not(follows_sql, id: account.id)\n       .where.not(follow_requests_sql, id: account.id)\n       .not_excluded_by_account(account)\n---\nspec/models/account_suggestions/friends_of_friends_source_spec.rb\n@@ -15,6 +15,7 @@\n     let!(:john) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:jerk) { Fabricate(:account, discoverable: true, hide_collections: false) }\n     let!(:larry) { Fabricate(:account, discoverable: true, hide_collections: false) }\n+    let!(:morty) { Fabricate(:account, discoverable: true, hide_collections: false, memorial: true) }\n \n     context 'with follows and blocks' do\n       before do\n@@ -27,8 +28,8 @@\n         # alice follows eve and mallory\n         [john, mallory].each { |account| alice.follow!(account) }\n \n-        # eugen follows eve, john, jerk, larry and neil\n-        [eve, mallory, jerk, larry, neil].each { |account| eugen.follow!(account) }\n+        # eugen follows eve, john, jerk, larry, neil and morty\n+        [eve, mallory, jerk, larry, neil, morty].each { |account| eugen.follow!(account) }\n       end\n \n       it 'returns eligible accounts', :aggregate_failures do\n@@ -51,6 +52,9 @@\n \n         # the suggestion for neil has already been rejected\n         expect(results).to_not include([neil.id, :friends_of_friends])\n+\n+        # morty is not included because his account is in memoriam\n+        expect(results).to_not include([morty.id, :friends_of_friends])\n       end\n     end\n \n---\nspec/models/account_suggestions/source_spec.rb\n@@ -21,6 +21,7 @@\n       let!(:moved_account) { Fabricate(:account, moved_to_account: Fabricate(:account), discoverable: true) }\n       let!(:silenced_account) { Fabricate(:account, silenced: true, discoverable: true) }\n       let!(:undiscoverable_account) { Fabricate(:account, discoverable: false) }\n+      let!(:memorial_account) { Fabricate(:account, memorial: true, discoverable: true) }\n \n       before do\n         Fabricate :account_domain_block, account: account, domain: account_domain_blocked_account.domain\n@@ -44,6 +45,7 @@\n           .and not_include(moved_account)\n           .and not_include(silenced_account)\n           .and not_include(undiscoverable_account)\n+          .and not_include(memorial_account)\n       end\n     end\n   end\n---\n\n\n---\n\nChoice C:\napp/javascript/styles/mastodon/components.scss\n@@ -2612,6 +2612,7 @@ a.account__display-name {\n }\n \n $ui-header-height: 55px;\n+$ui-header-logo-wordmark-width: 99px;\n \n .ui__header {\n   display: none;\n@@ -2627,6 +2628,10 @@ $ui-header-height: 55px;\n   &__logo {\n     display: inline-flex;\n     padding: 15px;\n+    flex-grow: 1;\n+    flex-shrink: 1;\n+    overflow: hidden;\n+    container: header-logo / inline-size;\n \n     .logo {\n       height: $ui-header-height - 30px;\n@@ -2637,7 +2642,7 @@ $ui-header-height: 55px;\n       display: none;\n     }\n \n-    @media screen and (width >= 320px) {\n+    @container header-logo (min-width: #{$ui-header-logo-wordmark-width}) {\n       .logo--wordmark {\n         display: block;\n       }\n@@ -2654,6 +2659,7 @@ $ui-header-height: 55px;\n     gap: 10px;\n     padding: 0 10px;\n     overflow: hidden;\n+    flex-shrink: 0;\n \n     .button {\n       flex: 0 0 auto;\n---\n\n\n---\n\nChoice D:\napp/helpers/languages_helper.rb\n@@ -254,6 +254,7 @@ def standard_locale_name(locale)\n \n   def valid_locale_or_nil(str)\n     return if str.blank?\n+    return str if valid_locale?(str)\n \n     code, = str.to_s.split(/[_-]/) # Strip out the region from e.g. en_US or ja-JP\n \n---\n\n\n---\n\n"}], "ideal": "C"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\nToday I am noticing the \"Follows you\" box displays in black text on a darkened background even in light mode. It looks like this.\r\n\r\n![image](https://github.com/mastodon/mastodon/assets/277318/10efc883-6526-4193-9c53-352e4a3a858a)\r\n\n\n### Expected behaviour\n\nLight text on dark background or dark text on light background\n\n### Actual behaviour\n\nHard to read\n\n### Detailed description\n\n_No response_\n\n### Specifications\n\nI am on mastodon dot social which claims to be running v4.1.4+nightly-20230713. I am on up-to-date Chrome in Windows 10. I use \"advanced mode\". \n\n---\n\nChoice A:\napp/models/account_pin.rb\n@@ -5,10 +5,10 @@\n # Table name: account_pins\n #\n #  id                :bigint(8)        not null, primary key\n-#  account_id        :bigint(8)\n-#  target_account_id :bigint(8)\n #  created_at        :datetime         not null\n #  updated_at        :datetime         not null\n+#  account_id        :bigint(8)        not null\n+#  target_account_id :bigint(8)        not null\n #\n \n class AccountPin < ApplicationRecord\n---\ndb/migrate/20241210140838_add_not_null_to_account_pin_account_columns.rb\n@@ -0,0 +1,23 @@\n+# frozen_string_literal: true\n+\n+class AddNotNullToAccountPinAccountColumns < ActiveRecord::Migration[7.2]\n+  def up\n+    connection.execute(<<~SQL.squish)\n+      DELETE FROM account_pins\n+      WHERE account_id IS NULL\n+      OR target_account_id IS NULL\n+    SQL\n+\n+    safety_assured do\n+      change_column_null :account_pins, :account_id, false\n+      change_column_null :account_pins, :target_account_id, false\n+    end\n+  end\n+\n+  def down\n+    safety_assured do\n+      change_column_null :account_pins, :account_id, true\n+      change_column_null :account_pins, :target_account_id, true\n+    end\n+  end\n+end\n---\ndb/schema.rb\n@@ -10,7 +10,7 @@\n #\n # It's strongly recommended that you check this file into your version control system.\n \n-ActiveRecord::Schema[7.2].define(version: 2024_12_05_163118) do\n+ActiveRecord::Schema[7.2].define(version: 2024_12_10_140838) do\n   # These are extensions that must be enabled in order to support this database\n   enable_extension \"plpgsql\"\n \n@@ -82,8 +82,8 @@\n   end\n \n   create_table \"account_pins\", force: :cascade do |t|\n-    t.bigint \"account_id\"\n-    t.bigint \"target_account_id\"\n+    t.bigint \"account_id\", null: false\n+    t.bigint \"target_account_id\", null: false\n     t.datetime \"created_at\", precision: nil, null: false\n     t.datetime \"updated_at\", precision: nil, null: false\n     t.index [\"account_id\", \"target_account_id\"], name: \"index_account_pins_on_account_id_and_target_account_id\", unique: true\n---\n\n\n---\n\nChoice B:\napp/models/account.rb\n@@ -68,7 +68,7 @@ class Account < ApplicationRecord\n   INSTANCE_ACTOR_ID = -99\n \n   USERNAME_RE   = /[a-z0-9_]+([a-z0-9_.-]+[a-z0-9_]+)?/i\n-  MENTION_RE    = %r{(?<![=/[:word:]])@((#{USERNAME_RE})(?:@[[:word:].-]+[[:word:]]+)?)}i\n+  MENTION_RE    = %r{(?<![=/[:word:]])@((#{USERNAME_RE})(?:@[[:word:].-]+[[:word:]]+)?)}\n   URL_PREFIX_RE = %r{\\Ahttp(s?)://[^/]+}\n   USERNAME_ONLY_RE = /\\A#{USERNAME_RE}\\z/i\n   USERNAME_LENGTH_LIMIT = 30\n---\napp/models/tag.rb\n@@ -37,7 +37,7 @@ class Tag < ApplicationRecord\n   HASHTAG_LAST_SEQUENCE = '([[:word:]_]*[[:alpha:]][[:word:]_]*)'\n   HASHTAG_NAME_PAT = \"#{HASHTAG_FIRST_SEQUENCE}|#{HASHTAG_LAST_SEQUENCE}\"\n \n-  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}i\n+  HASHTAG_RE = %r{(?<![=/)\\p{Alnum}])#(#{HASHTAG_NAME_PAT})}\n   HASHTAG_NAME_RE = /\\A(#{HASHTAG_NAME_PAT})\\z/i\n   HASHTAG_INVALID_CHARS_RE = /[^[:alnum:]\\u0E47-\\u0E4E#{HASHTAG_SEPARATORS}]/\n \n---\nspec/models/account_spec.rb\n@@ -711,6 +711,14 @@\n     it 'does not match URL query string' do\n       expect(subject.match('https://example.com/?x=@alice')).to be_nil\n     end\n+\n+    it 'matches usernames immediately following the letter \u00df' do\n+      expect(subject.match('Hello to\u00df @alice from me')[1]).to eq 'alice'\n+    end\n+\n+    it 'matches usernames containing uppercase characters' do\n+      expect(subject.match('Hello to @aLice@Example.com from me')[1]).to eq 'aLice@Example.com'\n+    end\n   end\n \n   describe 'validations' do\n---\nspec/models/tag_spec.rb\n@@ -95,6 +95,14 @@\n     it 'does not match purely-numeric hashtags' do\n       expect(subject.match('hello #0123456')).to be_nil\n     end\n+\n+    it 'matches hashtags immediately following the letter \u00df' do\n+      expect(subject.match('Hello to\u00df #ruby').to_s).to eq '#ruby'\n+    end\n+\n+    it 'matches hashtags containing uppercase characters' do\n+      expect(subject.match('Hello #rubyOnRails').to_s).to eq '#rubyOnRails'\n+    end\n   end\n \n   describe '#to_param' do\n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/features/status/index.jsx\n@@ -607,6 +607,22 @@ class Status extends ImmutablePureComponent {\n     this.setState({ fullscreen: isFullscreen() });\n   };\n \n+  shouldUpdateScroll = (prevRouterProps, { location }) => {\n+    // Do not change scroll when opening a modal\n+    if (location.state?.mastodonModalKey && location.state?.mastodonModalKey !== prevRouterProps?.location?.state?.mastodonModalKey) {\n+      return false;\n+    }\n+\n+    // Scroll to focused post if it is loaded\n+    const child = this.node?.querySelector('.detailed-status__wrapper');\n+    if (child) {\n+      return [0, child.offsetTop];\n+    }\n+\n+    // Do not scroll otherwise, `componentDidUpdate` will take care of that\n+    return false;\n+  };\n+\n   render () {\n     let ancestors, descendants;\n     const { isLoading, status, ancestorsIds, descendantsIds, intl, domain, multiColumn, pictureInPicture } = this.props;\n@@ -660,7 +676,7 @@ class Status extends ImmutablePureComponent {\n           )}\n         />\n \n-        <ScrollContainer scrollKey='thread'>\n+        <ScrollContainer scrollKey='thread' shouldUpdateScroll={this.shouldUpdateScroll}>\n           <div className={classNames('scrollable', { fullscreen })} ref={this.setRef}>\n             {ancestors}\n \n---\n\n\n---\n\nChoice D:\napp/javascript/styles/mastodon/components.scss\n@@ -4389,7 +4389,7 @@ a.status-card.compact:hover {\n }\n \n .relationship-tag {\n-  color: $primary-text-color;\n+  color: $white;\n   margin-bottom: 4px;\n   display: block;\n   background-color: rgba($black, 0.45);\n---\n\n\n---\n\n"}], "ideal": "D"}
{"input": [{"role": "system", "content": "The user will ask which of the following 4 choices (A, B, C or D) is the best solution to the following software issue. Even the correct answer may have some irrelevant code inside of it. Only respond with a single letter A, B, C or D in uppercase. "}, {"role": "user", "content": "Task Description:\n### Steps to reproduce the problem\n\n1. Visit your home timeline\r\n2. That's it, maybe you see it maybe you don't: intermittent\r\n\r\n\n\n### Expected behaviour\n\nNot having this post \n\n### Actual behaviour\n\nPost appears intermittently\n\n### Detailed description\n\nThere is a post which is not real. \r\n\r\nIt says \"This is your home base within Mastodon\". It appears at the top of your timeline. It serves no purpose whatsoever. It is extra annoying because it cannot be disabled and it appears intermittently. \r\n\r\n\n\n### Specifications\n\nBrave on Linux\r\nMastodon 4.1.4+nightly-20230711\n\n---\n\nChoice A:\ndocs/Using-Mastodon/List-of-Mastodon-instances.md\n@@ -65,7 +65,7 @@ There is also a list at [instances.mastodon.xyz](https://instances.mastodon.xyz)\n | [off-the-clock.us](https://off-the-clock.us/)|The work day is over.|Yes|No|\n | [infinimatix.net](https://infinimatix.net)|Informatics|Yes|Yes|\n | [social.0day.agency](https://social.0day.agency)|Infosec, Hacking, Fun (only protonmail)|Yes|Yes|\n-| [kagrumez.lerk.io](https://kagrumez.lerk.io)|Open registration. German end english.|Yes|No|\n+| [social.k40s.net](https://social.k40s.net)|Open registration. German end english.|Yes|No|\n | [meow.social](https://meow.social)|A furry fandom focused instance|Yes|No|\n | [neumastodon.com](https://neumastodon.com/)|Northeastern University Mastodon |Yes|No|\n | [dancingbanana.party](https://dancingbanana.party)|La banane qui danse.|Yes|No|\n---\napp/lib/status_finder.rb\n@@ -10,6 +10,8 @@ def initialize(url)\n   def status\n     verify_action!\n \n+    raise ActiveRecord::RecordNotFound unless TagManager.instance.local_url?(url)\n+\n     case recognized_params[:controller]\n     when 'stream_entries'\n       StreamEntry.find(recognized_params[:id]).status\n---\nspec/controllers/api/oembed_controller_spec.rb\n@@ -8,6 +8,7 @@\n \n   describe 'GET #show' do\n     before do\n+      request.host = Rails.configuration.x.local_domain\n       get :show, params: { url: account_stream_entry_url(alice, status.stream_entry) }, format: :json\n     end\n \n---\nspec/lib/status_finder_spec.rb\n@@ -34,6 +34,16 @@\n       end\n     end\n \n+    context 'with a remote url even if id exists on local' do\n+      let(:status) { Fabricate(:status) }\n+      let(:url) { \"https://example.com/users/test/statuses/#{status.id}\" }\n+      subject { described_class.new(url) }\n+\n+      it 'raises an error' do\n+        expect { subject.status }.to raise_error(ActiveRecord::RecordNotFound)\n+      end\n+    end\n+\n     context 'with a plausible url' do\n       let(:url) { 'https://example.com/users/test/updates/123/embed' }\n       subject { described_class.new(url) }\n---\n\n\n---\n\nChoice B:\napp/javascript/mastodon/components/admin/Retention.jsx\n@@ -9,11 +9,12 @@ import api from 'mastodon/api';\n import { roundTo10 } from 'mastodon/utils/numbers';\n \n const dateForCohort = cohort => {\n+  const timeZone = 'UTC';\n   switch(cohort.frequency) {\n   case 'day':\n-    return <FormattedDate value={cohort.period} month='long' day='2-digit' />;\n+    return <FormattedDate value={cohort.period} month='long' day='2-digit' timeZone={timeZone} />;\n   default:\n-    return <FormattedDate value={cohort.period} month='long' year='numeric' />;\n+    return <FormattedDate value={cohort.period} month='long' year='numeric' timeZone={timeZone} />;\n   }\n };\n \n---\n\n\n---\n\nChoice C:\napp/javascript/mastodon/components/dismissable_banner.tsx\n@@ -1,11 +1,18 @@\n+/* eslint-disable @typescript-eslint/no-unsafe-call,\n+                  @typescript-eslint/no-unsafe-return,\n+                  @typescript-eslint/no-unsafe-assignment,\n+                  @typescript-eslint/no-unsafe-member-access\n+                  -- the settings store is not yet typed */\n import type { PropsWithChildren } from 'react';\n-import { useCallback, useState } from 'react';\n+import { useCallback, useState, useEffect } from 'react';\n \n import { defineMessages, useIntl } from 'react-intl';\n \n import { ReactComponent as CloseIcon } from '@material-symbols/svg-600/outlined/close.svg';\n \n+import { changeSetting } from 'mastodon/actions/settings';\n import { bannerSettings } from 'mastodon/settings';\n+import { useAppSelector, useAppDispatch } from 'mastodon/store';\n \n import { IconButton } from './icon_button';\n \n@@ -21,13 +28,25 @@ export const DismissableBanner: React.FC<PropsWithChildren<Props>> = ({\n   id,\n   children,\n }) => {\n-  const [visible, setVisible] = useState(!bannerSettings.get(id));\n+  const dismissed = useAppSelector((state) =>\n+    state.settings.getIn(['dismissed_banners', id], false),\n+  );\n+  const dispatch = useAppDispatch();\n+\n+  const [visible, setVisible] = useState(!bannerSettings.get(id) && !dismissed);\n   const intl = useIntl();\n \n   const handleDismiss = useCallback(() => {\n     setVisible(false);\n     bannerSettings.set(id, true);\n-  }, [id]);\n+    dispatch(changeSetting(['dismissed_banners', id], true));\n+  }, [id, dispatch]);\n+\n+  useEffect(() => {\n+    if (!visible && !dismissed) {\n+      dispatch(changeSetting(['dismissed_banners', id], true));\n+    }\n+  }, [id, dispatch, visible, dismissed]);\n \n   if (!visible) {\n     return null;\n---\napp/javascript/mastodon/reducers/settings.js\n@@ -100,6 +100,15 @@ const initialState = ImmutableMap({\n       body: '',\n     }),\n   }),\n+\n+  dismissed_banners: ImmutableMap({\n+    'public_timeline': false,\n+    'community_timeline': false,\n+    'home.explore_prompt': false,\n+    'explore/links': false,\n+    'explore/statuses': false,\n+    'explore/tags': false,\n+  }),\n });\n \n const defaultColumns = fromJS([\n---\n\n\n---\n\nChoice D:\napp/javascript/mastodon/features/notifications_v2/components/notification_with_status.tsx\n@@ -13,6 +13,7 @@ import {\n import type { IconProp } from 'mastodon/components/icon';\n import { Icon } from 'mastodon/components/icon';\n import Status from 'mastodon/containers/status_container';\n+import { getStatusHidden } from 'mastodon/selectors/filters';\n import { useAppSelector, useAppDispatch } from 'mastodon/store';\n \n import { DisplayedName } from './displayed_name';\n@@ -48,6 +49,12 @@ export const NotificationWithStatus: React.FC<{\n     (state) => state.statuses.getIn([statusId, 'visibility']) === 'direct',\n   );\n \n+  const isFiltered = useAppSelector(\n+    (state) =>\n+      statusId &&\n+      getStatusHidden(state, { id: statusId, contextType: 'notifications' }),\n+  );\n+\n   const handlers = useMemo(\n     () => ({\n       open: () => {\n@@ -73,7 +80,7 @@ export const NotificationWithStatus: React.FC<{\n     [dispatch, statusId],\n   );\n \n-  if (!statusId) return null;\n+  if (!statusId || isFiltered) return null;\n \n   return (\n     <HotKeys handlers={handlers}>\n---\napp/javascript/mastodon/selectors/filters.ts\n@@ -0,0 +1,50 @@\n+import { createSelector } from '@reduxjs/toolkit';\n+\n+import type { RootState } from 'mastodon/store';\n+import { toServerSideType } from 'mastodon/utils/filters';\n+\n+// TODO: move to `app/javascript/mastodon/models` and use more globally\n+type Filter = Immutable.Map<string, unknown>;\n+\n+// TODO: move to `app/javascript/mastodon/models` and use more globally\n+type FilterResult = Immutable.Map<string, unknown>;\n+\n+export const getFilters = createSelector(\n+  [\n+    (state: RootState) => state.filters as Immutable.Map<string, Filter>,\n+    (_, { contextType }: { contextType: string }) => contextType,\n+  ],\n+  (filters, contextType) => {\n+    if (!contextType) {\n+      return null;\n+    }\n+\n+    const now = new Date();\n+    const serverSideType = toServerSideType(contextType);\n+\n+    return filters.filter((filter) => {\n+      const context = filter.get('context') as Immutable.List<string>;\n+      const expiration = filter.get('expires_at') as Date | null;\n+      return (\n+        context.includes(serverSideType) &&\n+        (expiration === null || expiration > now)\n+      );\n+    });\n+  },\n+);\n+\n+export const getStatusHidden = (\n+  state: RootState,\n+  { id, contextType }: { id: string; contextType: string },\n+) => {\n+  const filters = getFilters(state, { contextType });\n+  if (filters === null) return false;\n+\n+  const filtered = state.statuses.getIn([id, 'filtered']) as\n+    | Immutable.List<FilterResult>\n+    | undefined;\n+  return filtered?.some(\n+    (result) =>\n+      filters.getIn([result.get('filter'), 'filter_action']) === 'hide',\n+  );\n+};\n---\napp/javascript/mastodon/selectors/index.js\n@@ -1,22 +1,11 @@\n import { createSelector } from '@reduxjs/toolkit';\n import { List as ImmutableList, Map as ImmutableMap } from 'immutable';\n \n-import { toServerSideType } from 'mastodon/utils/filters';\n-\n import { me } from '../initial_state';\n \n-export { makeGetAccount } from \"./accounts\";\n-\n-const getFilters = createSelector([state => state.get('filters'), (_, { contextType }) => contextType], (filters, contextType) => {\n-  if (!contextType) {\n-    return null;\n-  }\n+import { getFilters } from './filters';\n \n-  const now = new Date();\n-  const serverSideType = toServerSideType(contextType);\n-\n-  return filters.filter(filter => filter.get('context').includes(serverSideType) && (filter.get('expires_at') === null || filter.get('expires_at') > now));\n-});\n+export { makeGetAccount } from \"./accounts\";\n \n export const makeGetStatus = () => {\n   return createSelector(\n---\n\n\n---\n\n"}], "ideal": "C"}
